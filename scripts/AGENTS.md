<!-- Generated by agents-reverse-engineer v0.8.2 -->

# scripts

Build automation and analytics tooling: `build-hooks.js` bundles session lifecycle hooks during npm publish, `analyze-sum-ratios.sh` validates per-file compression efficiency (`.sum` size vs source), `analyze-agents-compression.sh` measures directory-level aggregation quality (child `.sum`/`AGENTS.md` input vs `AGENTS.md` output).

## Contents

**[build-hooks.js](./build-hooks.js)** — Copies `.js` files from `hooks/` to `hooks/dist/` via `fs.copyFileSync()` during `npm run build:hooks` / `prepublishOnly`. Creates destination via `mkdirSync({recursive: true})`, excludes `dist` subdirectory, logs copied file count. Ensures `are-check-update.js`, `are-session-end.js`, `opencode-are-check-update.js`, `opencode-are-session-end.js` bundled in published package for `src/installer/operations.ts` `installSessionHooks()` consumption.

**[analyze-sum-ratios.sh](./analyze-sum-ratios.sh)** — Computes per-file compression ratios (`(sum_size / source_size) * 100`) via `find` + `stat` + `awk`. Accumulates `total_source_size`, `total_sum_size`, `ratios[]` array. Calculates mean (arithmetic average), median (sorted midpoint), min/max, overall ratio (weighted). Reports first 10 files + outliers (ratio > 50% or < 10%). Evaluates against 25% target: `< 25%` PASS, `< 30%` ACCEPTABLE, `≥ 30%` ABOVE TARGET. Output: `%-60s %8d bytes -> %8d bytes (%6.2f%%)\n` format with `numfmt --to=iec-i` sizes.

**[analyze-agents-compression.sh](./analyze-agents-compression.sh)** — Measures directory-level aggregation efficiency: finds all `AGENTS.md` via `find . -name "AGENTS.md" -type f | sort`, computes `input_size` (sum of direct `.sum` files + child `AGENTS.md` subdirectories), calculates `ratio = (output_size / input_size) * 100`, accumulates `total_input_size`, `total_output_size`, `ratios[]`. Prints per-directory stats (`%-52s %7s → %7s (%6.2f%%) [%2d .sum, %2d subdirs]\n` with IEC sizes, 50-char truncation `...${dir_display: -47}`), summary with overall ratio, compression factor (`input/output`), space saved, mean/median/min/max. Quality thresholds: `< 50%` EXCELLENT (>2×), `< 70%` GOOD (~1.5×), `< 90%` ACCEPTABLE (<1.2×), `≥ 90%` MINIMAL (~1:1).

## Workflow

**npm Publish Lifecycle**: `prepublishOnly` script invokes `build:hooks` → `node scripts/build-hooks.js` → copies `hooks/*.js` to `hooks/dist/` → `npm publish` includes `hooks/dist/` per `package.json` `files` array → runtime `src/installer/operations.ts` `installSessionHooks()` copies from `hooks/dist/` to `.claude/sessionStart.d/` / `.claude/sessionEnd.d/`.

**Post-Generation Analysis**: After `npx agents-reverse-engineer generate`, run `./scripts/analyze-sum-ratios.sh` to validate per-file `.sum` compression (target: <25% ratio = >4× compression), then `./scripts/analyze-agents-compression.sh` to measure directory aggregation quality (target: <50% ratio = >2× compression). Both emit pass/fail verdicts with statistical distributions.

## Behavioral Contracts

**Median Calculation (analyze-agents-compression.sh)**:
```bash
# Even-length array:
median = (sorted_ratios[mid-1] + sorted_ratios[mid]) / 2
# Odd-length array:
median = sorted_ratios[mid]
```

**Directory Truncation (analyze-agents-compression.sh)**:
```bash
# If directory path exceeds 50 chars:
dir_display="...${dir_display: -47}"  # Last 47 chars + ellipsis prefix
```

**Root Directory Exclusion Pattern (analyze-agents-compression.sh)**:
```bash
find "$dir" -maxdepth 1 -mindepth 1 -type d | grep -v "^\./\."
# Filters directories starting with ./.* (hides .git, .agents-reverse-engineer)
```

**Cross-Platform File Size Retrieval**:
```bash
stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null
# BSD (macOS) vs GNU (Linux) stat compatibility
```

**Compression Ratio Formula**:
```bash
ratio = (compressed_size / original_size) * 100
# Per-file (.sum vs source): target <25%
# Per-directory (AGENTS.md vs inputs): target <50%
```

**Quality Thresholds (analyze-agents-compression.sh)**:
```bash
ratio < 50:  EXCELLENT (>2× compression)
ratio < 70:  GOOD (~1.5× compression)
ratio < 90:  ACCEPTABLE (<1.2× compression)
ratio ≥ 90:  MINIMAL (~1:1 compression)
```

**Outlier Detection (analyze-sum-ratios.sh)**:
```bash
# Print file stats if:
ratio > 50  # Poorly compressed
# OR
ratio < 10  # Exceptionally compressed
```