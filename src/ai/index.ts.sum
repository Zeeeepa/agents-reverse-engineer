---
generated_at: 2026-02-09T21:28:21.340Z
content_hash: 8b123030a9ae9b650e3148fccfc8bcfe2bc0e1b2bb0bfa9db2d6a0d7901c3178
purpose: Public API barrel export consolidating type definitions, service orchestration, backend registry, retry utilities, su...
---
**Public API barrel export consolidating type definitions, service orchestration, backend registry, retry utilities, subprocess execution, and backend detection functions for the AI service layer.**

## Exported Types

- `AIBackend` — Interface defining backend implementation contract (name, model, pricing, call/health methods)
- `AIResponse` — Response envelope containing `content`, `usage` (tokens/costs), and optional `cached` flag
- `AICallOptions` — Request options with `prompt`, optional `context`, `model`, `disallowedTools`, `maxTokens`
- `SubprocessResult` — Raw subprocess output with `stdout`, `stderr`, `exitCode`, `signal`, `timedOut`, `duration`, `error`
- `RetryOptions` — Configuration for exponential backoff: `maxRetries`, `initialDelayMs`, `maxDelayMs`, `backoffMultiplier`, `retryableErrors`
- `TelemetryEntry` — Single AI call record with `callId`, `timestamp`, `backend`, `model`, `prompt`, `usage`, `duration`, `error`
- `RunLog` — Aggregated run summary with `runId`, `startedAt`, `totalInputTokens`, `totalCost`, `uniqueFilesRead`, `errorCount`
- `FileRead` — File metadata structure with `path`, `sizeBytes`, `linesRead` for telemetry tracking
- `AIServiceError` — Error class with `code` discriminator ("BACKEND_ERROR", "SUBPROCESS_ERROR", "RETRY_EXHAUSTED", etc.)

## Service Orchestration

- `AIService` — Primary orchestrator class managing backend invocation, retry logic, telemetry logging, and trace emission
- `AIServiceOptions` — Constructor config with `timeoutMs`, `maxRetries`, `telemetry` (enabled/keepRuns/costThresholdUsd), `tracer`, `debug`

## Backend Registry

- `BackendRegistry` — Class managing available backend implementations with `register()`, `get()`, `getAvailable()`, `list()` methods
- `createBackendRegistry()` — Factory function returning pre-populated registry with Claude, Gemini, OpenCode backends
- `resolveBackend()` — Async function taking registry and backend name ('auto' | 'claude' | 'gemini' | 'opencode'), returns first healthy backend or throws
- `detectBackend()` — Async function returning name of first available backend by health check order (Claude → Gemini → OpenCode)
- `getInstallInstructions()` — Returns Map of backend names to installation command strings

## Retry Utilities

- `withRetry()` — Generic async retry wrapper with exponential backoff, accepts operation function and `RetryOptions`
- `DEFAULT_RETRY_OPTIONS` — Constant defining baseline retry config: `maxRetries: 3`, `initialDelayMs: 1000`, `maxDelayMs: 32000`, `backoffMultiplier: 2`

## Subprocess Execution

- `runSubprocess()` — Low-level wrapper around `execFile` with resource limits (NODE_OPTIONS heap constraint, UV_THREADPOOL_SIZE=4, CLAUDE_CODE_DISABLE_BACKGROUND_TASKS=1), timeout enforcement (SIGTERM → SIGKILL escalation), process group killing (`kill(-pid)`), returns `SubprocessResult`

## Backend Utilities

- `isCommandOnPath()` — Async predicate checking if executable exists in PATH via `which` command, returns boolean

## Module Architecture

Enforces encapsulation boundary: no external module should import from `src/ai/backends/` or `src/ai/telemetry/` directly. All AI service layer dependencies must route through this barrel export. Telemetry implementation (`src/ai/telemetry/logger.ts`, `src/ai/telemetry/run-log.ts`, `src/ai/telemetry/cleanup.ts`) remains internal to service layer, accessed only via `AIService` constructor options.