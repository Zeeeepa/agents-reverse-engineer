<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/ai

AI service abstraction layer orchestrating backend resolution (Claude→Codex→Gemini→OpenCode priority), subprocess lifecycle management, exponential backoff retry, telemetry collection, and CLI adapter contracts for unified `AICallOptions`→`AIResponse` transformation.

## Contents

- [**index.ts**](./index.ts): Barrel-exports `AIProvider`, `AIBackend`, `AIResponse`, `AICallOptions`, `SubprocessResult`, `RetryOptions`, `TelemetryEntry`, `RunLog`, `FileRead`, `AIServiceError` (types), `AIService`, `AIServiceOptions` (orchestrator), `BackendRegistry`, `createBackendRegistry`, `resolveBackend`, `detectBackend`, `getInstallInstructions` (registry), `withRetry`, `DEFAULT_RETRY_OPTIONS` (retry), `runSubprocess` (subprocess), `SubprocessProvider`, `SubprocessProviderOptions` (providers), `isCommandOnPath` (utilities). Enforces encapsulation: external imports must use this barrel, not `ai/backends/` or `ai/telemetry/` internals.
- [**registry.ts**](./registry.ts): `BackendRegistry` stores `AIBackend` instances, exposes `register`, `get`, `getAll`. `createBackendRegistry` pre-populates `ClaudeBackend`, `CodexBackend`, `GeminiBackend`, `OpenCodeBackend` in priority order. `detectBackend` iterates `getAll`, returns first `isAvailable` backend or null. `resolveBackend` auto-detects (throws `CLI_NOT_FOUND` with aggregated install instructions if none found) or validates explicit backend (throws if missing/unavailable). Error templates: `"No AI CLI found..."` (auto), `"Unknown backend..."` (invalid name), `"Backend...not available..."` (unavailable).
- [**retry.ts**](./retry.ts): `DEFAULT_RETRY_OPTIONS` defines `maxRetries: 3`, `baseDelayMs: 1000`, `maxDelayMs: 8000`, `multiplier: 2`. `withRetry` executes async function with exponential backoff: `min(baseDelayMs * multiplier^attempt, maxDelayMs) + jitter[0-500ms]`. Throws immediately if `!isRetryable(error)` or `attempt === maxRetries`, invokes `onRetry(attempt+1, error)` before sleep.
- [**service.ts**](./service.ts): `AIService` orchestrates AI calls with retry/telemetry/tracing. Constructor wraps `AIBackend` in `SubprocessProvider` via type guard, initializes `TelemetryLogger` with ISO timestamp/backend/model/command. Methods: `setTracer` (attaches `ITraceWriter`), `setDebug` (enables subprocess logging), `setSubprocessLogDir` (configures `.log` file directory), `call` (executes with retry, records entry, throws on timeout/rate-limit/parse errors), `finalize` (writes run log, cleans old logs), `addFilesReadToLastEntry` (attaches metadata), `getSummary` (returns stats without finalizing). Retry strategy: 3 attempts for `RATE_LIMIT` only, emits `{type: 'retry', attempt, taskLabel, errorCode}` traces.
- [**subprocess.ts**](./subprocess.ts): `runSubprocess` spawns CLI subprocess via `execFile`, pipes `input` to stdin, enforces `timeoutMs` with SIGTERM, escalates to SIGKILL after 5s grace period. Returns `SubprocessResult` with stdout/stderr/exitCode/signal/durationMs/timedOut/childPid. Never rejects—resolves with error details. Invokes `onSpawn(pid)` callback after spawn. Uses 10MB `maxBuffer`, kills process group via `process.kill(-child.pid, 'SIGKILL')` on completion. Exports `getActiveSubprocessCount`, `getActiveSubprocesses` for concurrency debugging.
- [**types.ts**](./types.ts): Defines `SubprocessResult` (stdout/stderr/exitCode/signal/durationMs/timedOut/childPid), `AICallOptions` (prompt/systemPrompt/model/timeoutMs/maxTurns/taskLabel), `AIResponse` (text/model/tokens/durationMs/exitCode/raw), `AIProvider` (injectable `call` interface), `AIBackend` (CLI adapter contract: name/cliCommand/isAvailable/buildArgs/parseResponse/getInstallInstructions/optional composeStdinInput/ensureProjectConfig), `RetryOptions` (maxRetries/delays/predicates), `FileRead` (path/sizeBytes), `TelemetryEntry` (timestamp/prompt/response/tokens/latency/exitCode/retryCount/thinking/filesRead), `RunLog` (runId/startTime/endTime/backend/model/command/entries/summary), `AIServiceErrorCode` (`CLI_NOT_FOUND|TIMEOUT|PARSE_ERROR|SUBPROCESS_ERROR|RATE_LIMIT`), `AIServiceError`.

## Subdirectories

- [**backends/**](./backends/): CLI adapters translating `AICallOptions` to backend-specific invocations: `ClaudeBackend` (JSON/NDJSON with Zod validation, `--allowedTools Read Write`), `CodexBackend` (JSONL event streaming with reasoning filter, `-a never exec --ephemeral`), `GeminiBackend` (JSON with `gemini-3-flash-preview`/`gemini-3-pro-preview`/`gemini-2.5-flash` aliasing, XML system prompt wrapping), `OpenCodeBackend` (NDJSON aggregation with `.opencode/agents/are-summarizer.md` single-turn enforcement, Anthropic pricing fallback). Exports `isCommandOnPath` (cross-platform PATH lookup with Windows PATHEXT enumeration).
- [**providers/**](./providers/): `SubprocessProvider` implements `AIProvider` by spawning `runSubprocess` with `AIBackend`-constructed commands, enforcing timeout via SIGTERM/SIGKILL, detecting rate limits via stderr pattern matching (`['rate limit', '429', 'too many requests', 'overloaded']`), emitting `subprocess:spawn`/`subprocess:exit` trace events, optionally logging to `{taskLabel}_pid{childPid}.log` via queued promise chain.
- [**telemetry/**](./telemetry/): `TelemetryLogger` accumulates `TelemetryEntry` chronologically, computes `RunLog.summary` (totalCalls/totalInputTokens/totalOutputTokens/totalCacheReadTokens/totalCacheCreationTokens/totalDurationMs/errorCount/totalFilesRead/uniqueFilesRead). `writeRunLog` persists to `run-{command}-{backend}-{model}-{timestamp}.json` with sanitized filenames. `cleanupOldLogs` enforces retention via lexicographic timestamp sort.

## Architecture

**Two-Layer Abstraction**: `AIProvider` interface enables transport-agnostic calls (injectable mocks/HTTP clients), `AIBackend` defines CLI adapter contract (buildArgs/parseResponse/isAvailable/getInstallInstructions). `SubprocessProvider` bridges interfaces by wrapping `AIBackend` in subprocess executor.

**Auto-Detection**: `createBackendRegistry` registers backends in priority order: Claude (index 0) > Codex (1) > Gemini (2) > OpenCode (3). `detectBackend` iterates `getAll`, returns first `isAvailable` backend. `resolveBackend` handles `'auto'` (throws aggregated install instructions if none found) or validates explicit name.

**Retry Flow**: `AIService.call` wraps `provider.call` with `withRetry`, retries only `AIServiceError` with `code === 'RATE_LIMIT'` (timeouts NOT retried to prevent resource exhaustion). Increments `retryCount`, emits `{type: 'retry', attempt, taskLabel, errorCode}` traces, records telemetry entry with `exitCode: 1` on failure.

**Subprocess Lifecycle**: `runSubprocess` spawns via `execFile`, pipes stdin, sets timeout via `execFile` API, starts escalation timer (`timeoutMs + 5000ms`) for SIGKILL. Tracks PIDs in `activeSubprocesses` Map. Kills process group (`-child.pid`) on exit. Exit code priority: `error === null` → 0, `typeof error.code === 'number'` → `error.code`, `child.exitCode !== null` → `child.exitCode`, else 1.

**Telemetry Flow**: Constructor creates `TelemetryLogger(runId, backend, model, command)`. `call` records entry with timestamp/prompt/response/tokens/latency/exitCode/retryCount/filesRead. `finalize` invokes `logger.toRunLog`, `writeRunLog`, `cleanupOldLogs(projectRoot, telemetry.keepRuns)`.

**Subprocess Logging**: `setSubprocessLogDir` enables per-call logs: `{taskLabel}_pid{childPid}.log` with metadata header (task/pid/command/exit/signal/duration) + stdout/stderr. Serializes writes via `logWriteQueue` promise chain.

## Behavioral Contracts

**Backend Priority**: Claude → Codex → Gemini → OpenCode (enforced by `createBackendRegistry` registration order)

**Retry Options** (from `DEFAULT_RETRY_OPTIONS`):
- `maxRetries: 3`
- `baseDelayMs: 1000`
- `maxDelayMs: 8000`
- `multiplier: 2`
- Delay formula: `min(baseDelayMs * multiplier^attempt, maxDelayMs) + jitter[0-500ms]`

**Rate Limit Patterns**: `['rate limit', '429', 'too many requests', 'overloaded']` (case-insensitive stderr match in `SubprocessProvider`)

**Subprocess Timeout Escalation**: SIGTERM at `timeoutMs` → SIGKILL at `timeoutMs + 5000ms` (`SIGKILL_GRACE_MS = 5000`)

**Exit Code Extraction Priority**:
1. `error === null` → 0
2. `typeof error.code === 'number'` → `error.code`
3. `child.exitCode !== null` → `child.exitCode`
4. Fallback → 1

**Subprocess Log Filename**: `${taskLabel.replace(/\//g, '--').replace(/[^a-zA-Z0-9._-]/g, '_')}_pid${childPid}.log`

**Subprocess Log Format**:
```
task: {taskLabel}
pid: {childPid}
command: {command.join(' ')}
exit: {exitCode}
signal: {signal}
duration: {durationMs}ms
timed_out: {timedOut}

--- stdout ---
{stdout}

--- stderr ---
{stderr}
```

**Telemetry Log Path**: `.agents-reverse-engineer/logs/run-{command}-{backend}-{model}-{timestamp}.json` (filename sanitization: `[:.]/[^a-z0-9]` → `-`)

**Retention Policy**: Lexicographic descending sort by filename (ISO 8601 sortability), delete overflow beyond `keepRuns` limit

**Trace Events**:
- `{type: 'retry', attempt, taskLabel, errorCode}` (on retry)
- `{type: 'subprocess:spawn', childPid, command, taskLabel}` (on spawn)
- `{type: 'subprocess:exit', childPid, command, taskLabel, exitCode, signal, durationMs, timedOut}` (on exit)

**Error Templates**:
- `CLI_NOT_FOUND` (auto): `"No AI CLI found on your system.\n\nInstall one of the following:\n\n${instructions}\n\nThen run this command again."`
- `CLI_NOT_FOUND` (unknown): `"Unknown backend \"${requested}\". Available backends: ${known}"`
- `CLI_NOT_FOUND` (unavailable): `"Backend \"${requested}\" is not available. The \"${backend.cliCommand}\" CLI was not found on PATH.\n\n${backend.getInstallInstructions()}"`