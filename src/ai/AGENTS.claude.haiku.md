<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/ai

The ai directory provides a unified orchestration layer for AI backend selection, provider execution, retry/timeout management, and telemetry collection. It exports a public API (`AIService`, `AIProvider`, `AIBackend`, `AIResponse`) with strict encapsulation of internal backends and telemetry implementations.

## Contents

### Core Service & Registry

[index.ts](./index.ts) — Barrel export enforcing module boundaries; re-exports `AIService`, `AIProvider`, `AIBackend`, `AIResponse`, `BackendRegistry`, `SubprocessProvider`, `createBackendRegistry()`, `resolveBackend()`, `detectBackend()`, `withRetry()`, `runSubprocess()`, `isCommandOnPath()`, error type `AIServiceError`, and constants `DEFAULT_RETRY_OPTIONS`.

[service.ts](./service.ts) — `AIService` orchestrator wrapping any `AIProvider` with retry (rate-limit only), timeout enforcement, and telemetry; accepts `AIServiceOptions` (timeoutMs, maxRetries, model, command, telemetry config); methods include `call(AICallOptions): Promise<AIResponse>`, `finalize(projectRoot)`, `setTracer()`, `setDebug()`, `setSubprocessLogDir()`, `addFilesReadToLastEntry()`, `getSummary()`.

[registry.ts](./registry.ts) — `BackendRegistry` stores `AIBackend` instances with registration and lookup; `createBackendRegistry()` initializes with Claude, Codex, Gemini, OpenCode in priority order; `detectBackend()` and `resolveBackend()` with auto-detection support; `getInstallInstructions()` aggregates install guidance across all backends.

[types.ts](./types.ts) — Defines contract types: `AIProvider` (injectable interface), `AIBackend` (CLI adapter with buildArgs/parseResponse/isAvailable), `AICallOptions`, `AIResponse`, `RetryOptions`, `FileRead`, `TelemetryEntry`, `RunLog`; error type `AIServiceError` with codes `CLI_NOT_FOUND | TIMEOUT | PARSE_ERROR | SUBPROCESS_ERROR | RATE_LIMIT`.

### Retry & Subprocess

[retry.ts](./retry.ts) — `withRetry<T>()` implements exponential backoff with formula `min(baseDelayMs × multiplier^attempt, maxDelayMs) + jitter[0–500ms]`; `DEFAULT_RETRY_OPTIONS` (maxRetries: 3, baseDelayMs: 1_000, maxDelayMs: 8_000, multiplier: 2); accepts `isRetryable(error)` predicate and `onRetry(attempt, error)` callback.

[subprocess.ts](./subprocess.ts) — `runSubprocess(command, args, options)` spawns CLI processes with timeout enforcement (SIGTERM → SIGKILL after 5s grace), stdin piping, exit code extraction; `getActiveSubprocessCount()` and `getActiveSubprocesses()` for concurrency tracking; `SubprocessOptions` includes timeoutMs, input, env, onSpawn callback; 10MB maxBuffer for large outputs.

## Subdirectories

[backends/](./backends/) — Multiple `AIBackend` implementations (Claude, Codex, Gemini, OpenCode) adapting distinct CLI tools to unified response parsing and argument construction; handles polymorphic JSON/NDJSON output formats, token counting, cost calculation, and CLI argument building.

[providers/](./providers/) — `SubprocessProvider` wrapping `AIBackend` instances; implements `AIProvider` contract with subprocess lifecycle, rate-limit detection via `RATE_LIMIT_PATTERNS`, structured trace events (subprocess:spawn, subprocess:exit), debug heap snapshots, and async log file I/O.

[telemetry/](./telemetry/) — `TelemetryLogger` accumulates `TelemetryEntry` objects and computes `RunLog` summaries; `writeRunLog()` persists to `.agents-reverse-engineer/logs/run-*.json` with sanitized filenames; `cleanupOldLogs()` retains N most recent by lexicographic ordering.

## Architecture & Data Flow

**Selection & Initialization**
1. `createBackendRegistry()` populates backend map (Claude > Codex > Gemini > OpenCode priority)
2. `resolveBackend(registry, 'auto' | name)` detects available CLI or throws with install instructions
3. `SubprocessProvider` wraps selected backend
4. `AIService` wraps provider with retry/telemetry/timeout config

**Call Execution**
1. `AIService.call(AICallOptions)` → `withRetry()` wrapper
2. `SubprocessProvider.call()` → `backend.buildArgs()` + `runSubprocess()`
3. Exit code checked; rate limits detected via `isRateLimitStderr()`; response parsed via `backend.parseResponse()`
4. `TelemetryLogger.addEntry()` records call metadata, tokens, latency
5. Failed calls recorded with `exitCode: 1` and error message

**Finalization & Cleanup**
1. `AIService.finalize(projectRoot)` → `TelemetryLogger.toRunLog()` snapshots metrics
2. `writeRunLog()` persists JSON to disk with sanitized `run-{command}-{backend}-{model}-{timestamp}.json`
3. `cleanupOldLogs()` prunes retention to `keepRuns` count (most recent by timestamp)

## Behavioral Contracts

**Subprocess timeout escalation** (`subprocess.ts`): SIGTERM sent by `execFile` at `timeoutMs`; if unresponsive after `SIGKILL_GRACE_MS` (5000ms), escalates to SIGKILL via process group kill (`-child.pid`).

**Retry predicate** (`retry.ts`): Permanent errors (non-retryable per `isRetryable`) throw immediately; only transient failures proceed through backoff loop with up to 3 attempts.

**Rate-limit detection** (`providers/subprocess.ts`): Case-insensitive stderr substring matching against patterns `'rate limit'`, `'429'`, `'too many requests'`, `'overloaded'` triggers `AIServiceError('RATE_LIMIT')` for retry eligibility.

**Telemetry aggregation** (`telemetry/logger.ts`): Per-call totals summed fresh on each `getSummary()` (not cached); includes input/output/cache tokens, duration, file reads, error count.

**Log filename sanitization** (`telemetry/run-log.ts`): Pattern `run-{safeCommand}-{safeBackend}-{safeModel}-{safeTimestamp}.json`; replaces non-alphanumeric with `-`, `:/.` in timestamp with `-`.

## Error Handling & Recovery

`AIService.call()` retries only `RATE_LIMIT` errors (excludes timeout to prevent resource exhaustion). `onRetry` callback logs warn message with attempt count and emits trace event. Other `AIServiceError` codes (`TIMEOUT`, `PARSE_ERROR`, `SUBPROCESS_ERROR`, `CLI_NOT_FOUND`) throw immediately without retry. Failed calls persisted in telemetry with error message and `exitCode: 1`. `AIServiceError.code` enables pattern matching on error type for caller-specific handling.

## Configuration & Composition

**Service-level defaults** (`service.ts`): `AIServiceOptions.model` applies unless overridden per-call; `command` identifies triggering operation (generate|update|specify|rebuild) for telemetry labeling; `telemetry.keepRuns` controls log retention count.

**Subprocess options** (`subprocess.ts`): `timeoutMs` forwarded to `execFile` timeout; `input` piped to stdin; `env` overrides (merge with process.env); `onSpawn(pid)` callback for trace correlation.

**Retry options merging** (`retry.ts`): Caller spreads `DEFAULT_RETRY_OPTIONS` and augments with `isRetryable(error)` and `onRetry(attempt, error)` predicates specific to error type (rate-limit vs. timeout).

## Annex References

Full backend response parsing schemas: [backends AGENTS.md](./backends/)

Subprocess lifecycle tracing patterns: [providers AGENTS.md](./providers/)

Telemetry log formats and retention policy: [telemetry AGENTS.md](./telemetry/)