---
generated_at: 2026-02-09T14:08:36.090Z
content_hash: 232da2af981eb6c44ab5f5e8908ea14d6ee97fe4295f950b83f42ee45e40a95a
purpose: AIService orchestrates AI CLI subprocess invocations with retry logic, timeout enforcement, telemetry recording, and ...
---
**AIService orchestrates AI CLI subprocess invocations with retry logic, timeout enforcement, telemetry recording, and rate-limit detection.**

## Exported Classes

**AIService** — Main orchestrator class accepting `AIBackend` and `AIServiceOptions` in constructor, exposing methods:
- `call(options: AICallOptions): Promise<AIResponse>` — Executes AI invocation with retry wrapper via `withRetry()`, records `TelemetryEntry` via `TelemetryLogger.addEntry()`, returns normalized `AIResponse` from `backend.parseResponse()`
- `finalize(projectRoot: string): Promise<{ logPath: string; summary: RunLog['summary'] }>` — Writes run log via `writeRunLog()`, cleans old logs via `cleanupOldLogs()`, returns log path and summary statistics
- `addFilesReadToLastEntry(filesRead: FileRead[]): void` — Attaches file metadata to most recent telemetry entry via `logger.setFilesReadOnLastEntry()`
- `getSummary(): RunLog['summary']` — Returns current run statistics without finalizing
- `setTracer(tracer: ITraceWriter): void` — Configures trace event emitter for subprocess and retry events
- `setDebug(enabled: boolean): void` — Enables verbose subprocess logging to stderr with heap/RSS metrics
- `setSubprocessLogDir(dir: string): void` — Configures directory for writing per-subprocess `.log` files containing stdout/stderr/metadata

## Exported Interfaces

**AIServiceOptions** — Configuration schema containing:
- `timeoutMs: number` — Default subprocess timeout
- `maxRetries: number` — Maximum retry attempts for transient errors
- `model?: string` — Default model identifier applied to all calls unless overridden per-call
- `telemetry: { keepRuns: number }` — Run log retention count

## Call Flow

`AIService.call()` executes: build CLI args via `backend.buildArgs()` → wrap `runSubprocess()` in `withRetry()` → emit `subprocess:spawn` trace event via `onSpawn` callback → check `result.timedOut` flag → parse stderr for rate limits via `isRateLimitStderr()` → invoke `backend.parseResponse()` → emit `subprocess:exit` trace event → enqueue subprocess log write via `enqueueSubprocessLog()` → record telemetry entry with token counts/latency/exit code.

## Retry Strategy

Only `RATE_LIMIT` errors are retried (not `TIMEOUT`) via `DEFAULT_RETRY_OPTIONS` merged with `maxRetries` from `AIServiceOptions`. Retry predicate checks `error.code === 'RATE_LIMIT'` in `isRetryable()` callback. Each retry emits `retry` trace event and logs warning via `console.error()`.

## Rate Limit Detection

`isRateLimitStderr(stderr: string): boolean` performs case-insensitive substring search for patterns: `'rate limit'`, `'429'`, `'too many requests'`, `'overloaded'`. Matching stderr triggers `AIServiceError('RATE_LIMIT', ...)` throw.

## Error Handling

`AIService.call()` wraps `withRetry()` in try/catch recording failed calls to telemetry with `exitCode: 1`, `error: string`, and `retryCount` before rethrowing. Parse errors from `backend.parseResponse()` are wrapped in `AIServiceError('PARSE_ERROR', ...)`.

## Telemetry Recording

`TelemetryLogger` accumulates entries with fields: `timestamp`, `prompt`, `systemPrompt`, `response`, `model`, `inputTokens`, `outputTokens`, `cacheReadTokens`, `cacheCreationTokens`, `latencyMs`, `exitCode`, `retryCount`, `thinking`, `filesRead`. Logger exposes `toRunLog()` serializing to `RunLog` schema consumed by `writeRunLog()`.

## Subprocess Logging

When `subprocessLogDir` is set, each invocation writes `<taskLabel>_pid<childPid>.log` containing: task label, PID, command, exit code, signal, duration, timeout flag, stdout, stderr. Writes are serialized via promise chain stored in `logWriteQueue` to prevent concurrent mkdir races. Failures are silently swallowed (non-critical).

## Concurrency Monitoring

`activeSubprocesses` counter tracks in-flight subprocesses, logged in debug mode with `process.memoryUsage()` metrics formatted via `formatBytes()`. Debug logs show heap/RSS at spawn and exit time with PID/duration/exit code.

## Model Override Behavior

`call()` merges service-level `options.model` (constructor param) with per-call `options.model` via spread operator, preferring per-call value. Effective model passed to `backend.buildArgs()` and recorded in telemetry entry.

## Dependencies

Imports `runSubprocess()` from `./subprocess.js`, `withRetry()` and `DEFAULT_RETRY_OPTIONS` from `./retry.js`, `TelemetryLogger` from `./telemetry/logger.js`, `writeRunLog()` from `./telemetry/run-log.js`, `cleanupOldLogs()` from `./telemetry/cleanup.js`, `ITraceWriter` from `../orchestration/trace.js`. Consumes types: `AIBackend`, `AICallOptions`, `AIResponse`, `SubprocessResult`, `TelemetryEntry`, `RunLog`, `FileRead`, `AIServiceError`.

## Trace Events Emitted

- `subprocess:spawn` — Emitted in `runSubprocess()` callback with `childPid`, `command`, `taskLabel`
- `subprocess:exit` — Emitted after completion with `childPid`, `command`, `taskLabel`, `exitCode`, `signal`, `durationMs`, `timedOut`
- `retry` — Emitted in `withRetry()` callback with `attempt`, `taskLabel`, `errorCode`