---
generated_at: 2026-02-09T14:08:34.740Z
content_hash: f9216f3a5cd1aa82c24b828a3d65d02bfa76f54cd303d063b4573fe03be76657
purpose: types.ts defines the contract interfaces and error types for the AI service layer, including subprocess results, back...
---
**types.ts defines the contract interfaces and error types for the AI service layer, including subprocess results, backend adapters, retry configuration, telemetry logging, and normalized AI responses.**

## Exported Interfaces

**SubprocessResult** — returned by subprocess wrapper after CLI process completion:
- `stdout: string` — captured standard output
- `stderr: string` — captured standard error
- `exitCode: number` — numeric exit code (0 = success)
- `signal: string | null` — termination signal or null
- `durationMs: number` — wall-clock duration
- `timedOut: boolean` — whether process exceeded timeout
- `childPid?: number` — OS PID (undefined if spawn failed)

**AICallOptions** — input parameters for AI service calls:
- `prompt: string` — required prompt text
- `systemPrompt?: string` — optional context/behavior instructions
- `model?: string` — backend-specific model identifier ("sonnet", "opus")
- `timeoutMs?: number` — subprocess timeout override
- `maxTurns?: number` — maximum agentic turns (backend-specific)
- `taskLabel?: string` — tracing label (typically file path)

**AIResponse** — normalized response from any backend adapter:
- `text: string` — AI model's text response
- `model: string` — model identifier from backend
- `inputTokens: number` — input tokens consumed
- `outputTokens: number` — output tokens generated
- `cacheReadTokens: number` — tokens served from cache reads
- `cacheCreationTokens: number` — tokens written to cache
- `durationMs: number` — wall-clock duration
- `exitCode: number` — CLI process exit code
- `raw: unknown` — original CLI JSON for debugging

**AIBackend** — contract for CLI backend adapters (Claude, Gemini, OpenCode):
- `name: string` (readonly) — human-readable backend name
- `cliCommand: string` (readonly) — executable name on PATH
- `isAvailable(): Promise<boolean>` — checks CLI availability
- `buildArgs(options: AICallOptions): string[]` — constructs CLI argument array
- `parseResponse(stdout: string, durationMs: number, exitCode: number): AIResponse` — parses CLI output into normalized response
- `getInstallInstructions(): string` — user-facing install instructions

**RetryOptions** — exponential backoff retry configuration:
- `maxRetries: number` — maximum retry attempts (3 = 4 total attempts)
- `baseDelayMs: number` — initial delay before first retry
- `maxDelayMs: number` — delay ceiling
- `multiplier: number` — exponential backoff multiplier
- `isRetryable: (error: unknown) => boolean` — predicate for transient errors
- `onRetry?: (attempt: number, error: unknown) => void` — optional retry callback

**FileRead** — context file read record for telemetry:
- `path: string` — file path relative to project root
- `sizeBytes: number` — file size at read time

**TelemetryEntry** — per-call telemetry log entry:
- `timestamp: string` — ISO 8601 call initiation time
- `prompt: string` — sent prompt
- `systemPrompt?: string` — optional system prompt
- `response: string` — AI model's text response
- `model: string` — model identifier
- `inputTokens: number` — input token count
- `outputTokens: number` — output token count
- `cacheReadTokens: number` — cache read tokens
- `cacheCreationTokens: number` — cache write tokens
- `latencyMs: number` — wall-clock latency
- `exitCode: number` — process exit code
- `error?: string` — error message on failure
- `retryCount: number` — number of retries before result
- `thinking: string` — AI reasoning content ("not supported" for backends without)
- `filesRead: FileRead[]` — context files sent

**RunLog** — per-run aggregated log structure:
- `runId: string` — unique run identifier (ISO timestamp-based)
- `startTime: string` — ISO 8601 run start time
- `endTime: string` — ISO 8601 run end time
- `entries: TelemetryEntry[]` — all individual call entries
- `summary: object` — aggregated metrics:
  - `totalCalls: number` — total AI call count
  - `totalInputTokens: number` — sum of input tokens
  - `totalOutputTokens: number` — sum of output tokens
  - `totalDurationMs: number` — total wall-clock duration
  - `errorCount: number` — failed call count
  - `totalCacheReadTokens: number` — sum of cache reads
  - `totalCacheCreationTokens: number` — sum of cache writes
  - `totalFilesRead: number` — total file reads (with duplicates)
  - `uniqueFilesRead: number` — deduplicated file read count

## Exported Types

**AIServiceErrorCode** — discriminated union for typed error handling:
- `'CLI_NOT_FOUND'` — backend CLI not available on PATH
- `'TIMEOUT'` — subprocess exceeded timeout threshold
- `'PARSE_ERROR'` — CLI output parsing failed
- `'SUBPROCESS_ERROR'` — subprocess execution failure
- `'RATE_LIMIT'` — API rate limit exceeded

## Exported Classes

**AIServiceError** — typed error for AI service failures:
- `code: AIServiceErrorCode` (readonly) — machine-readable error code
- `constructor(code: AIServiceErrorCode, message: string)` — initializes error with code and message
- Extends standard Error with name `'AIServiceError'`
- Enables branching on error type without string parsing

## Integration Points

All AI service modules (`service.ts`, `registry.ts`, `subprocess.ts`, backend adapters in `src/ai/backends/`, telemetry modules in `src/ai/telemetry/`) import shared contracts from this file. AIBackend implementations (ClaudeBackend, GeminiBackend, OpenCodeBackend) must conform to the AIBackend interface. Retry logic in `retry.ts` consumes RetryOptions. Telemetry logger in `src/ai/telemetry/logger.ts` writes TelemetryEntry and RunLog structures to `.agents-reverse-engineer/logs/`.