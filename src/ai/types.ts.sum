---
generated_at: 2026-02-09T21:28:28.632Z
content_hash: f9216f3a5cd1aa82c24b828a3d65d02bfa76f54cd303d063b4573fe03be76657
purpose: Defines the contract for the AI service layer through interfaces for subprocess execution, AI backend adapters, retry...
---
**Defines the contract for the AI service layer through interfaces for subprocess execution, AI backend adapters, retry configuration, telemetry logging, and typed error handling.**

## Core Interfaces

### SubprocessResult
Captures the outcome of a CLI subprocess execution returned by the subprocess wrapper. Contains `stdout: string`, `stderr: string`, `exitCode: number`, `signal: string | null`, `durationMs: number`, `timedOut: boolean`, and optional `childPid?: number`. Always populated even on error or timeout.

### AICallOptions
Input specification for an AI call requiring only `prompt: string`. Optional fields: `systemPrompt?: string`, `model?: string` (backend-interpreted identifier like "sonnet" or "opus"), `timeoutMs?: number` (overrides config default), `maxTurns?: number` (agentic turn limit), `taskLabel?: string` (for tracing).

### AIResponse
Normalized response structure that all backend adapters must produce. Fields: `text: string` (model response), `model: string` (backend-reported identifier), `inputTokens: number`, `outputTokens: number`, `cacheReadTokens: number`, `cacheCreationTokens: number`, `durationMs: number`, `exitCode: number`, `raw: unknown` (original CLI JSON for debugging).

## Backend Contract

### AIBackend
Interface implemented by Claude, Gemini, and OpenCode adapters. Readonly properties: `name: string` (human-readable like "Claude"), `cliCommand: string` (executable name on PATH like "claude"). Methods: `isAvailable(): Promise<boolean>` checks PATH availability, `buildArgs(options: AICallOptions): string[]` constructs CLI argument array, `parseResponse(stdout: string, durationMs: number, exitCode: number): AIResponse` normalizes CLI output, `getInstallInstructions(): string` returns user-facing installation guidance when CLI not found.

## Retry Configuration

### RetryOptions
Controls exponential backoff behavior. Fields: `maxRetries: number` (3 means 4 total attempts), `baseDelayMs: number` (initial wait), `maxDelayMs: number` (cap on exponential growth), `multiplier: number` (exponential factor), `isRetryable: (error: unknown) => boolean` (transient error predicate), `onRetry?: (attempt: number, error: unknown) => void` (optional callback before each retry).

## Telemetry Types

### FileRead
Records a file sent as context to an AI call. Fields: `path: string` (relative to project root), `sizeBytes: number` (file size at read time).

### TelemetryEntry
Per-call log entry capturing everything needed to replay or debug a single AI invocation. Fields: `timestamp: string` (ISO 8601), `prompt: string`, `systemPrompt?: string`, `response: string`, `model: string`, `inputTokens: number`, `outputTokens: number`, `cacheReadTokens: number`, `cacheCreationTokens: number`, `latencyMs: number`, `exitCode: number`, `error?: string`, `retryCount: number`, `thinking: string` (AI reasoning content, "not supported" when backend lacks this feature), `filesRead: FileRead[]`.

### RunLog
Aggregates all TelemetryEntry instances for a single CLI run plus computed summary. Top-level fields: `runId: string` (ISO timestamp-based), `startTime: string`, `endTime: string`, `entries: TelemetryEntry[]`, `summary` object containing `totalCalls: number`, `totalInputTokens: number`, `totalOutputTokens: number`, `totalDurationMs: number`, `errorCount: number`, `totalCacheReadTokens: number`, `totalCacheCreationTokens: number`, `totalFilesRead: number` (including duplicates), `uniqueFilesRead: number` (deduped by path).

## Error Handling

### AIServiceErrorCode
Typed error codes: `'CLI_NOT_FOUND'` (executable missing from PATH), `'TIMEOUT'` (subprocess exceeded timeoutMs), `'PARSE_ERROR'` (malformed CLI output), `'SUBPROCESS_ERROR'` (process failure), `'RATE_LIMIT'` (backend rate limiting detected via stderr patterns like "rate limit", "429", "too many requests", "overloaded").

### AIServiceError
Extends Error with machine-readable error codes. Readonly property: `code: AIServiceErrorCode`. Constructor signature: `constructor(code: AIServiceErrorCode, message: string)`. Sets `name` to `'AIServiceError'`. Enables typed catch blocks branching on `error.code` without string parsing.

## Integration Notes

Every AI service module imports from this file to ensure consistent contracts across the service layer. Backend adapters in `src/ai/backends/` implement AIBackend, subprocess wrapper in `src/ai/subprocess.ts` returns SubprocessResult, retry logic in `src/ai/retry.ts` consumes RetryOptions, telemetry logger in `src/ai/telemetry/logger.ts` writes TelemetryEntry and RunLog structures, and orchestration components thread AICallOptions through worker pools.