<!-- Generated by agents-reverse-engineer v0.8.2 -->

# src/ai/providers

Single-file directory wrapping AIBackend implementations into AIProvider interface via subprocess spawning with timeout enforcement, rate-limit detection, trace emission, and optional debug logging.

## Contents

**[subprocess.ts](./subprocess.ts)** — **SubprocessProvider** class implementing AIProvider interface. Constructor accepts `AIBackend` and `SubprocessProviderOptions` (`timeoutMs`, `debug?`, `logger?`, `tracer?`). `call(options: AICallOptions)` spawns CLI subprocess via `runSubprocess()`, emits `subprocess:spawn`/`subprocess:exit` trace events, detects rate-limit errors via stderr patterns, throws `AIServiceError` on timeout/failure, delegates response parsing to backend. `setTracer(tracer)` enables late binding for trace writer. `setSubprocessLogDir(dir)` enables serialized subprocess output logging (`${sanitizedTaskLabel}_pid${childPid}.log`) via `logWriteQueue` promise chain. `activeCount` tracks concurrent subprocess count. Debug mode logs memory (`heapUsed`, `rss`) + `taskLabel` + `activeCount` pre/post spawn via `logger.debug()`.

## Rate-Limit Detection

`RATE_LIMIT_PATTERNS = ['rate limit', '429', 'too many requests', 'overloaded']` applied to lowercase stderr via `isRateLimitStderr()`. Match triggers `AIServiceError('RATE_LIMIT')` with 200-char stderr excerpt.

## Error Handling

**Timeout**: `result.timedOut` → `AIServiceError('TIMEOUT', 'Subprocess timed out')` after warning log  
**Rate-limit**: stderr pattern match → `AIServiceError('RATE_LIMIT')` with stderr excerpt  
**Exit failure**: non-zero exit → `AIServiceError('SUBPROCESS_ERROR')` with 500-char stderr excerpt (unless rate-limit detected)  
**Parse failure**: `backend.parseResponse()` exception → `AIServiceError('PARSE_ERROR')`

## Subprocess Lifecycle

1. Increment `activeCount`
2. `backend.buildArgs(options)` constructs CLI args
3. `runSubprocess(backend.cliCommand, args, { timeoutMs, input, onSpawn })` executes child
4. `onSpawn` callback emits `subprocess:spawn` trace with `childPid`, `command`, `taskLabel`
5. Decrement `activeCount` post-spawn
6. Emit `subprocess:exit` trace with `childPid`, `exitCode`, `signal`, `durationMs`, `timedOut`
7. Error checks (timeout → rate-limit → exit code)
8. `backend.parseResponse(stdout, durationMs, exitCode)` on success

## Dependencies

Imports `runSubprocess()` from `../subprocess.js`, `AIServiceError` from `../types.js`, `nullLogger` from `../../core/logger.js`. Requires `AIBackend` interface with `cliCommand`, `name`, `buildArgs(options: AICallOptions)`, `parseResponse(stdout: string, durationMs: number, exitCode: number)`.