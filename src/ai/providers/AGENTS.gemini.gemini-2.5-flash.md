<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/ai/providers
This directory contains implementations for `AIProvider`s, which are responsible for executing AI model inference. It specifically includes `SubprocessProvider` for interfacing with `AIBackend`s via CLI subprocesses, managing their execution, and parsing their responses to return an `AIResponse` or throw an `AIServiceError`.

## Contents
- [`subprocess.ts`](./subprocess.ts): Implements `SubprocessProvider`, an `AIProvider` for executing AI model inference by spawning CLI subprocesses, handling `timeoutMs`, rate limits, and parsing the `AIResponse`.

## Public Interface
- `interface SubprocessProviderOptions`: Configures `SubprocessProvider` instances, specifying `timeoutMs: number`, optional `debug?: boolean`, `logger?: Logger`, and `tracer?: ITraceWriter | null`.
- `class SubprocessProvider implements AIProvider`: Core class wrapping an `AIBackend` to execute AI calls through CLI commands.
    - `constructor(backend: AIBackend, options: SubprocessProviderOptions)`: Initializes with an `AIBackend` for command generation/response parsing and `SubprocessProviderOptions`.
    - `setTracer(tracer: ITraceWriter): void`: Allows late binding of an `ITraceWriter` for subprocess event tracing.
    - `setSubprocessLogDir(dir: string): void`: Sets a directory path (`string`) for writing detailed subprocess `stdout` and `stderr` logs.
    - `async call(options: AICallOptions): Promise<AIResponse>`: Executes an AI query, taking `AICallOptions` and returning an `AIResponse` or throwing `AIServiceError` on failure.

## Key Logic and Data Structures
- `isRateLimitStderr(stderr: string): boolean`: Determines if a given `stderr` string contains patterns indicating a rate-limit error using `RATE_LIMIT_PATTERNS`.
- `formatBytes(bytes: number): string`: Formats a `number` of `bytes` into a human-readable string (e.g., `100B`, `1.2KB`, `5.6MB`).
- `SubprocessProvider.call`: Builds CLI arguments using `this.backend.buildArgs(options)`, executes the command via `runSubprocess`, emits `subprocess:spawn` and `subprocess:exit` events to `this.tracer`, enforces `timeoutMs`, detects rate limits, and parses `stdout` into `AIResponse` using `this.backend.parseResponse`.
- `enqueueSubprocessLog(result: SubprocessResult, taskLabel: string): void`: Asynchronously writes `SubprocessResult` details (stdout, stderr, metadata) to a file within `this.subprocessLogDir`, sanitizing `taskLabel` for the filename, and serializing writes via `this.logWriteQueue` to prevent concurrent `mkdir` race conditions.

## Dependencies
- `AIProvider`, `AIBackend`, `AICallOptions`, `AIResponse`, `SubprocessResult`, `AIServiceError`: Interfaces and types imported from [`../types.js`](../types.js).
- `runSubprocess`: Utility function for spawning and managing external processes, imported from [`../subprocess.js`](../subprocess.js).
- `ITraceWriter`: Interface for emitting structured trace events related to subprocess lifecycle, imported from [`../../orchestration/trace.js`](../../orchestration/trace.js).
- `Logger`, `nullLogger`: Logging utilities for debug and warning output, imported from [`../../core/logger.js`](../../core/logger.js).

## Behavioral Contracts
- `RATE_LIMIT_PATTERNS`: Constant array `['rate limit', '429', 'too many requests', 'overloaded']` used by `isRateLimitStderr` for case-insensitive matching of rate-limit indications in `stderr`.
- `AIServiceError`: Custom error class (`../types.js`) thrown with specific types:
    - `'TIMEOUT'`: When a subprocess exceeds its allocated `timeoutMs`.
    - `'RATE_LIMIT'`: When `isRateLimitStderr` identifies a rate-limiting message in `stderr`.
    - `'SUBPROCESS_ERROR'`: For non-zero `exitCode` from the underlying CLI command.
    - `'PARSE_ERROR'`: If `this.backend.parseResponse` fails to interpret the subprocess's `stdout`.
- Subprocess log file content format: Includes `task`, `pid`, `command`, `exit`, `signal`, `duration`, `timed_out` metadata, followed by `\n--- stdout ---\n` and `\n--- stderr ---\n` sections containing the respective outputs.
- Log filename sanitization: `taskLabel` transformed by `taskLabel.replace(/\//g, '--').replace(/[^a-zA-Z0-9._-]/g, '_')`.