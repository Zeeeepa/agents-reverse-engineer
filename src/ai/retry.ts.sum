---
generated_at: 2026-02-09T16:09:23.158Z
content_hash: bb4f55c96ec0c37663c36e05b684a022be93a51f7fedfab85751ba88c5150446
purpose: retry.ts implements exponential backoff retry logic with jitter for handling transient AI service failures during sub...
---
**retry.ts implements exponential backoff retry logic with jitter for handling transient AI service failures during subprocess calls.**

## Exported Functions

**withRetry\<T>(fn: () => Promise<T>, options: RetryOptions): Promise<T>** executes async function `fn` with exponential backoff retry on transient failures. Returns result on success, throws last error after exhausting `maxRetries`, throws immediately if `options.isRetryable(error)` returns false. Delay formula: `min(baseDelayMs * multiplier^attempt, maxDelayMs) + jitter` where jitter is random [0, 500ms].

## Exported Constants

**DEFAULT_RETRY_OPTIONS** provides base configuration: `maxRetries: 3`, `baseDelayMs: 1_000`, `maxDelayMs: 8_000`, `multiplier: 2`. Typed as `Omit<RetryOptions, 'isRetryable' | 'onRetry'>` requiring callers to supply error predicate and retry callback.

## Retry Behavior

**withRetry** attempts operation up to `maxRetries + 1` total times (initial attempt + retries). On each failure checks `options.isRetryable(error)` before sleeping—permanent errors (rate limits with "retry after" headers, auth failures) throw immediately without backoff. Invokes optional `options.onRetry?.(attempt + 1, error)` callback before each delay to enable telemetry emission or logging.

## Jitter Strategy

**Delay calculation** adds random 0-500ms jitter to capped exponential delay via `Math.random() * 500` to prevent thundering herd when multiple worker pool processes hit same rate limit simultaneously. Jitter applied after computing `min(baseDelayMs * multiplier^attempt, maxDelayMs)`.

## Integration Points

**withRetry** consumed by `AIService.call()` in `src/ai/service.ts` which wraps `runSubprocess()` invocations. Caller provides `isRetryable` predicate checking stderr patterns ("rate limit", "429", "too many requests", "overloaded") and `onRetry` callback emitting trace events via `ITraceWriter.retry()`. Referenced in subprocess resource management context (CLAUDE.md §"Subprocess Resource Management").

## Type Dependencies

**RetryOptions** interface imported from `./types.js` defines configuration schema with required fields `maxRetries`, `baseDelayMs`, `maxDelayMs`, `multiplier`, `isRetryable: (error: unknown) => boolean`, optional `onRetry?: (attempt: number, error: unknown) => void`.