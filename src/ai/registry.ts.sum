---
generated_at: 2026-02-09T14:08:16.994Z
content_hash: 2d34e579c6cc1815d9b994620523f38af82f9433fe179141efd6ccd6ec98d779
purpose: Backend registry, factory, and auto-detection system that manages AIBackend instances, selects CLI backends via auto-...
---
**Backend registry, factory, and auto-detection system that manages AIBackend instances, selects CLI backends via auto-detection or explicit request, and provides actionable error messages when no CLI is found.**

## Exported Types and Classes

**BackendRegistry** class manages AIBackend instances with insertion-order preservation for auto-detection priority.

- `register(backend: AIBackend): void` — adds backend to registry keyed by `backend.name` property
- `get(name: string): AIBackend | undefined` — retrieves backend by name (e.g., "claude", "gemini", "opencode")
- `getAll(): AIBackend[]` — returns all backends in registration order (Claude > Gemini > OpenCode)

## Factory and Detection Functions

**createBackendRegistry(): BackendRegistry** instantiates pre-populated registry with ClaudeBackend, GeminiBackend, OpenCodeBackend in priority order.

**detectBackend(registry: BackendRegistry): Promise<AIBackend | null>** iterates `registry.getAll()` calling `isAvailable()` on each backend, returning first available CLI or `null` if none found.

**resolveBackend(registry: BackendRegistry, requested: string | 'auto'): Promise<AIBackend>** performs explicit selection or auto-detection:
- `'auto'` mode: calls `detectBackend()`, throws `AIServiceError` with code `CLI_NOT_FOUND` and install instructions via `getInstallInstructions()` if nothing available
- Specific name: calls `registry.get()`, checks `backend.isAvailable()`, throws `CLI_NOT_FOUND` with install instructions if unavailable or unknown

**getInstallInstructions(registry: BackendRegistry): string** concatenates `backend.getInstallInstructions()` from all registered backends, formatted for error messages.

## Integration Points

Imports AIBackend interface and AIServiceError from `./types.js`, concrete backend implementations from `./backends/claude.js`, `./backends/gemini.js`, `./backends/opencode.js`.

Used by `AIService` in `src/ai/service.ts` during initialization to resolve backend configuration.

## Error Handling

Throws AIServiceError with code `CLI_NOT_FOUND` in two scenarios:
1. Auto-detection finds no available CLI (includes multi-line install instructions for all backends)
2. Explicitly requested backend not registered or CLI not found on PATH (includes single-backend install instructions)

Error messages match template from RESEARCH.md for consistency across documentation.