---
generated_at: 2026-02-09T16:09:20.974Z
content_hash: 2d34e579c6cc1815d9b994620523f38af82f9433fe179141efd6ccd6ec98d779
purpose: registry.ts manages AI backend registration, auto-detection, and resolution with actionable error messages when CLIs ...
---
**registry.ts manages AI backend registration, auto-detection, and resolution with actionable error messages when CLIs are not found.**

## Exported Classes

**BackendRegistry** stores AI backend adapters keyed by name with insertion-order preservation for detection priority. Methods:
- `register(backend: AIBackend): void` — adds backend to internal `Map<string, AIBackend>` keyed by `backend.name`
- `get(name: string): AIBackend | undefined` — retrieves backend by name
- `getAll(): AIBackend[]` — returns all backends in registration order

## Exported Functions

**createBackendRegistry(): BackendRegistry** returns pre-populated registry with backends in priority order: ClaudeBackend, GeminiBackend, OpenCodeBackend.

**detectBackend(registry: BackendRegistry): Promise<AIBackend | null>** iterates `registry.getAll()` calling `isAvailable()` on each backend, returns first where CLI is found on PATH or `null` if none available.

**getInstallInstructions(registry: BackendRegistry): string** concatenates `backend.getInstallInstructions()` from all registered backends with `\n\n` separators for error message formatting.

**resolveBackend(registry: BackendRegistry, requested: string | 'auto'): Promise<AIBackend>** selects backend via auto-detection (when `requested === 'auto'`) or explicit lookup. Throws `AIServiceError` with code `'CLI_NOT_FOUND'` if:
- Auto-detection finds no available backend (includes full install instructions via `getInstallInstructions()`)
- Requested backend name not in registry (lists known backends)
- Requested backend CLI not on PATH (includes backend-specific install instructions)

## Dependencies

Imports `AIBackend`, `AIServiceError` from `./types.js`, `ClaudeBackend` from `./backends/claude.js`, `GeminiBackend` from `./backends/gemini.js`, `OpenCodeBackend` from `./backends/opencode.js`.

## Detection Priority

Backend registration order in `createBackendRegistry()` determines `detectBackend()` iteration sequence: Claude (recommended, fully implemented) → Gemini (experimental, stub) → OpenCode (experimental, stub).

## Error Message Templates

CLI_NOT_FOUND errors follow template: `"No AI CLI found on your system.\n\nInstall one of the following:\n\n${instructions}\n\nThen run this command again."` for auto-detection failures, `"Backend \"${requested}\" is not available. The \"${backend.cliCommand}\" CLI was not found on PATH.\n\n${backend.getInstallInstructions()}"` for explicit backend unavailability.