---
generated_at: 2026-02-09T13:18:16.195Z
content_hash: 2d34e579c6cc1815d9b994620523f38af82f9433fe179141efd6ccd6ec98d779
purpose: registry.ts manages AI backend registration, auto-detection, and resolution for selecting Claude, Gemini, or OpenCode...
---
**registry.ts manages AI backend registration, auto-detection, and resolution for selecting Claude, Gemini, or OpenCode CLI adapters at runtime.**

## Exported Classes

**BackendRegistry** stores `AIBackend` instances keyed by `backend.name` in insertion order (determines auto-detection priority). Exports three methods:
- `register(backend: AIBackend): void` - adds backend to internal `Map<string, AIBackend>`
- `get(name: string): AIBackend | undefined` - retrieves backend by name
- `getAll(): AIBackend[]` - returns all backends in registration order

## Factory Function

**createBackendRegistry(): BackendRegistry** instantiates and populates a `BackendRegistry` with `ClaudeBackend`, `GeminiBackend`, and `OpenCodeBackend` in priority order (Claude first, OpenCode last).

## Auto-Detection

**detectBackend(registry: BackendRegistry): Promise<AIBackend | null>** iterates `registry.getAll()` and calls `backend.isAvailable()` on each, returning the first available backend or `null` if none found. Priority follows registration order: Claude > Gemini > OpenCode.

## Resolution Logic

**resolveBackend(registry: BackendRegistry, requested: string | 'auto'): Promise<AIBackend>** implements two-path logic:
- If `requested === 'auto'`: calls `detectBackend()`, throws `AIServiceError` with code `CLI_NOT_FOUND` and formatted install instructions via `getInstallInstructions()` if none available
- If `requested` is a backend name: calls `registry.get(requested)`, validates with `backend.isAvailable()`, throws `AIServiceError` if not registered or CLI not on PATH

**getInstallInstructions(registry: BackendRegistry): string** concatenates `backend.getInstallInstructions()` output from all registered backends with double-newline separators for error message formatting.

## Dependencies

Imports `AIBackend` interface and `AIServiceError` from `./types.js`, concrete adapters `ClaudeBackend`, `GeminiBackend`, `OpenCodeBackend` from `./backends/` directory. Uses `execFile()` child process checks (implicitly via `backend.isAvailable()`) to detect CLI presence on PATH.

## Error Handling

Throws `AIServiceError('CLI_NOT_FOUND', message)` in two scenarios:
1. Auto-detection finds no available backend - message includes multi-line install instructions from all backends
2. Explicit backend requested but not available - message includes backend-specific `cliCommand` and install instructions