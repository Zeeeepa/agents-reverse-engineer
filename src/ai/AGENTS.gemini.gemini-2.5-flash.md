<!-- Generated by agents-reverse-engineer v1.0.1 -->

```markdown
<!-- Generated by agents-reverse-engineer -->
# src/ai
The `src/ai` directory centralizes the core AI service layer, providing abstractions for interacting with various AI backends, managing subprocess execution, applying retry logic, collecting telemetry, and defining common data structures for AI operations. It acts as the public API surface for AI-related functionalities within the application, abstracting away backend-specific implementations and low-level system interactions.

## Contents
*   [index.ts](./index.ts): Exports the public API of the AI service layer, including `AIProvider`, `AIBackend`, `AIService`, `BackendRegistry`, `createBackendRegistry()`, `resolveBackend()`, `detectBackend()`, `getInstallInstructions()`, `withRetry()`, `runSubprocess()`, `SubprocessProvider`, `isCommandOnPath()` and various related types.
*   [registry.ts](./registry.ts): Manages `AIBackend` registrations, factory functions, auto-detection logic (`detectBackend`), and provides installation instructions (`getInstallInstructions`) for available AI CLI backends.
*   [service.ts](./service.ts): Orchestrates `AIService` calls, incorporating retry logic via `withRetry`, telemetry collection through `TelemetryLogger`, and manages subprocess logging (`subprocessLogDir`).
*   [subprocess.ts](./subprocess.ts): Provides `runSubprocess()` for spawning AI CLI subprocesses, handling `timeoutMs`, `input`, `env`, exit codes, and managing active subprocesses (`getActiveSubprocessCount()`, `getActiveSubprocesses()`).
*   [types.ts](./types.ts): Defines foundational types and interfaces for the AI service layer, including `SubprocessResult`, `AICallOptions`, `AIResponse`, `AIProvider`, `AIBackend`, `RetryOptions`, `FileRead`, `TelemetryEntry`, `RunLog`, `AIServiceErrorCode`, and `AIServiceError`.

## Subdirectories
*   [backends/](./backends/): Contains `AIBackend` implementations (`ClaudeBackend`, `CodexBackend`, `GeminiBackend`, `OpenCodeBackend`) that adapt various AI command-line interfaces, managing argument construction, subprocess output parsing, and error handling for specific CLIs.
*   [providers/](./providers/): Provides `AIProvider` implementations, notably `SubprocessProvider`, which interfaces with `AIBackend`s via CLI subprocesses, handling execution, `timeoutMs`, rate limits, and parsing responses into `AIResponse` or throwing `AIServiceError`.
*   [telemetry/](./telemetry/): Manages AI telemetry, including cleaning up old `run-*.json` log files via `cleanupOldLogs` and writing new `RunLog` data to disk using `writeRunLog`.

## Architecture / Data Flow
The `src/ai` architecture establishes a layered approach for AI interactions. `registry.ts` is responsible for discovering and resolving `AIBackend` instances, which are concrete adapters for external AI CLIs (defined in `src/ai/backends`). The `AIService` (`service.ts`) orchestrates AI calls by utilizing an `AIProvider` (typically `SubprocessProvider` from `src/ai/providers/`) to interact with the chosen `AIBackend`. `SubprocessProvider` then leverages the low-level `runSubprocess()` utility (`subprocess.ts`) for executing the actual CLI commands. All AI-related data structures and error handling are uniformly defined in `types.ts`. Telemetry data is collected by `AIService` and persisted by modules within `src/ai/telemetry`.

## Behavioral Contracts
*   **Retry Logic**: `withRetry` (from `service.ts`) is configured to retry functions only for `AIServiceError` with `code === 'RATE_LIMIT'`, using `DEFAULT_RETRY_OPTIONS` for base retry configuration, and emitting `retry` trace events via `onRetry` handler.
*   **Subprocess Timeout and Termination**: `runSubprocess` (`subprocess.ts`) uses `node:child_process.execFile` with `options.timeoutMs`, `killSignal: 'SIGTERM'`, and a `SIGKILL_GRACE_MS` of `5_000` ms to ensure processes are terminated, preventing hung processes. Zombie processes are actively prevented by calling `process.kill(-child.pid, 'SIGKILL')` or `process.kill(child.pid, 'SIGKILL')`.
*   **Rate Limit Detection**: `SubprocessProvider` (`src/ai/providers/subprocess.ts`) identifies rate-limiting errors in `stderr` output by matching `RATE_LIMIT_PATTERNS` which include `['rate limit', '429', 'too many requests', 'overloaded']`.
*   **Error Handling**: The `AIServiceError` custom error class (`types.ts`) with `AIServiceErrorCode` (`'CLI_NOT_FOUND'`, `'TIMEOUT'`, `'PARSE_ERROR'`, `'SUBPROCESS_ERROR'`, `'RATE_LIMIT'`) is consistently used across the AI service layer for specific error identification.
*   **Subprocess Logging**: When `subprocessLogDir` is set (`service.ts`), `SubprocessResult` details (stdout, stderr, metadata) are asynchronously written to files within that directory. Log filenames are sanitized using `taskLabel.replace(/\//g, '--').replace(/[^a-zA-Z0-9._-]/g, '_')`.
*   **Telemetry Log Storage**: `RunLog` files are written to `.agents-reverse-engineer/logs` (defined by `LOGS_DIR` in `src/ai/telemetry/cleanup.ts`) and are named `run-<command>-<backend>-<model>-<timestamp>.json` (`src/ai/telemetry/run-log.ts`). Old logs are cleaned based on `AIServiceOptions.telemetry.keepRuns` (`service.ts`).
```