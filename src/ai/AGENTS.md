<!-- Generated by agents-reverse-engineer -->

# src/ai

Backend-agnostic AI service layer orchestrating subprocess-based CLI invocations with exponential backoff retry, rate-limit detection, telemetry logging (NDJSON run logs with token cost tracking), timeout enforcement (SIGTERM→SIGKILL escalation), and trace event emission for orchestration layer consumption.

## Contents

**[index.ts](./index.ts)** — Exports public API surface: `AIService` (main orchestrator), `BackendRegistry` (backend management), `createBackendRegistry()` (factory with claude/gemini/opencode), `resolveBackend()` (name-to-instance resolution), `detectBackend()` (availability-based auto-detection), `getInstallInstructions()` (user-facing install guides), `withRetry()` (exponential backoff wrapper), `DEFAULT_RETRY_OPTIONS`, `runSubprocess()` (child process spawner), `isCommandOnPath()` (CLI availability check), types `AIBackend`, `AIResponse`, `AICallOptions`, `SubprocessResult`, `RetryOptions`, `TelemetryEntry`, `RunLog`, `FileRead`, `AIServiceOptions`, `AIServiceError`.

**[registry.ts](./registry.ts)** — `BackendRegistry` class stores `AIBackend` instances with insertion-order preservation, `register()` adds backends keyed by name, `get()` retrieves by name, `getAll()` returns priority-ordered array; `createBackendRegistry()` pre-populates with ClaudeBackend/GeminiBackend/OpenCodeBackend; `detectBackend()` iterates backends calling `isAvailable()` returning first available; `resolveBackend()` handles 'auto' mode or explicit backend selection throwing `AIServiceError('CLI_NOT_FOUND')` with install instructions when unavailable; `getInstallInstructions()` concatenates install guides from all registered backends.

**[retry.ts](./retry.ts)** — `withRetry<T>(fn, options)` executes async function with exponential backoff retry on transient failures, computes delay via `min(baseDelayMs * multiplier^attempt, maxDelayMs) + jitter` where jitter ∈ [0, 500ms], invokes `onRetry` callback before waiting, throws immediately on non-retryable errors via `isRetryable` predicate, returns first successful result; `DEFAULT_RETRY_OPTIONS` provides timing defaults (maxRetries=3, baseDelayMs=1000, maxDelayMs=8000, multiplier=2).

**[service.ts](./service.ts)** — `AIService` class accepts `AIBackend` and `AIServiceOptions` in constructor, `call()` executes subprocess via `runSubprocess()` wrapped in `withRetry()`, detects rate limits via `isRateLimitStderr()` (case-insensitive search for 'rate limit'/'429'/'too many requests'/'overloaded'), parses response via `backend.parseResponse()`, records `TelemetryEntry` with tokens/latency/exit code, emits `subprocess:spawn/exit` and `retry` trace events; `finalize()` writes run log via `writeRunLog()` and triggers `cleanupOldLogs()`; `addFilesReadToLastEntry()` attaches file metadata to most recent entry; `setTracer()` configures trace emitter; `setDebug()` enables subprocess logging with heap/RSS metrics; `setSubprocessLogDir()` configures per-subprocess `.log` file output with serialized promise chain writes.

**[subprocess.ts](./subprocess.ts)** — `runSubprocess(command, args, options)` spawns child process via `execFile()` with `NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`, `--disallowedTools Task` resource limits; enforces timeout with SIGTERM at `timeoutMs` and SIGKILL escalation after 5s grace period; kills process groups via `kill(-pid)` to terminate subprocess trees; pipes `options.input` to stdin calling `.end()` to send EOF; invokes `onSpawn(pid)` callback for trace timing; tracks subprocesses in `activeSubprocesses` Map; returns `SubprocessResult` with stdout/stderr/exitCode/signal/durationMs/timedOut/childPid; `getActiveSubprocessCount()` and `getActiveSubprocesses()` expose concurrency monitoring.

**[types.ts](./types.ts)** — Defines contract interfaces: `SubprocessResult` (stdout/stderr/exitCode/signal/durationMs/timedOut/childPid), `AICallOptions` (prompt/systemPrompt/model/timeoutMs/maxTurns/taskLabel), `AIResponse` (text/model/inputTokens/outputTokens/cacheReadTokens/cacheCreationTokens/durationMs/exitCode/raw), `AIBackend` (name/cliCommand/isAvailable/buildArgs/parseResponse/getInstallInstructions), `RetryOptions` (maxRetries/baseDelayMs/maxDelayMs/multiplier/isRetryable/onRetry), `FileRead` (path/sizeBytes), `TelemetryEntry` (timestamp/prompt/systemPrompt/response/model/inputTokens/outputTokens/cacheReadTokens/cacheCreationTokens/latencyMs/exitCode/error/retryCount/thinking/filesRead), `RunLog` (runId/startTime/endTime/entries/summary with totalCalls/totalInputTokens/totalOutputTokens/totalDurationMs/errorCount/totalCacheReadTokens/totalCacheCreationTokens/totalFilesRead/uniqueFilesRead); `AIServiceError` class with `AIServiceErrorCode` discriminator ('CLI_NOT_FOUND'/'TIMEOUT'/'PARSE_ERROR'/'SUBPROCESS_ERROR'/'RATE_LIMIT').

## Subdirectories

**[backends/](./backends/)** — ClaudeBackend, GeminiBackend, OpenCodeBackend implement `AIBackend` interface with `isAvailable()` via `isCommandOnPath()` checking PATH environment variable with Windows PATHEXT extension handling, `buildArgs()` constructing CLI argument arrays with backend-specific flags (`-p`, `--output-format json`, `--no-session-persistence`, `--permission-mode bypassPermissions` for Claude), `parseResponse()` validating JSON schemas extracting token counts (ClaudeBackend parses `modelUsage` record with cache token fields, GeminiBackend/OpenCodeBackend throw `'SUBPROCESS_ERROR'` pending format stabilization), `getInstallInstructions()` returning user-facing install commands.

**[telemetry/](./telemetry/)** — `TelemetryLogger` accumulates `TelemetryEntry[]` with `addEntry()`, computes aggregates via `getSummary()`, mutates last entry via `setFilesReadOnLastEntry()`, serializes via `toRunLog()`; `writeRunLog()` sanitizes ISO timestamps for cross-platform filenames (`run-${timestamp}.json`), writes pretty-printed JSON to `.agents-reverse-engineer/logs/`; `cleanupOldLogs(keepCount)` deletes oldest files beyond retention threshold via lexicographic sort, returns deletion count, silently succeeds on missing directory.

## Architecture Patterns

**Subprocess Resource Management:** `runSubprocess()` enforces limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`) addressing Claude CLI thread exhaustion (GitHub #5771: 200 Node.js instances). Default concurrency reduced to 2 for WSL environments via `src/config/defaults.ts` detection. Process group killing (`kill(-pid)`) terminates subprocess trees preventing zombie processes.

**Rate Limit Handling:** `AIService.call()` wraps subprocess execution in `withRetry()`, detects rate limits via `isRateLimitStderr()` (pattern matching 'rate limit'/'429'/'too many requests'/'overloaded'), applies exponential backoff with jitter (random 0-500ms) preventing thundering herd across concurrent workers, emits `retry` trace events, only retries `'RATE_LIMIT'` errors (not `'TIMEOUT'`), throws original error after `maxRetries` exhausted.

**Trace Event Flow:** `AIService.setTracer()` configures `ITraceWriter` from `src/orchestration/trace.ts`, `runSubprocess()` emits `subprocess:spawn` via `onSpawn` callback and `subprocess:exit` in completion handler, `withRetry()` emits `retry` events, all events propagate to NDJSON trace files via promise-chain serialization preventing concurrent write corruption.

**Telemetry Accumulation:** `AIService` instantiates `TelemetryLogger` once per command run (runId from timestamp), records per-call entries with tokens/latency/optional error via `addEntry()`, attaches file metadata via `setFilesReadOnLastEntry()` when runner provides `FileRead[]`, computes aggregates (token sums, unique file count) in-memory via `getSummary()`, serializes to disk via `writeRunLog()` at CLI termination, triggers `cleanupOldLogs(keepRuns)` enforcing retention limit from `config.yaml` (default 50).

**Backend Abstraction:** `AIBackend` interface decouples subprocess invocation from CLI-specific details. Callers interact with `AIService` consuming `AICallOptions` and receiving normalized `AIResponse` (text/model/inputTokens/outputTokens/cacheReadTokens/cacheCreationTokens), backends handle argument construction and JSON parsing, registry enables auto-detection prioritizing Claude > Gemini > OpenCode via `isAvailable()` checks, throws `'CLI_NOT_FOUND'` with install instructions when no CLI available.