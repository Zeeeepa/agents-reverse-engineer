<!-- Generated by agents-reverse-engineer -->

# src/ai

AIBackend abstraction layer with retry, subprocess execution, telemetry, and backend registry for Claude CLI, Gemini CLI, and OpenCode CLI.

## Contents

### Public API

**[index.ts](./index.ts)** — Barrel export enforcing strict module boundary: exports `AIService`, `AIBackend`, `AIResponse`, `AICallOptions`, `BackendRegistry`, `createBackendRegistry()`, `resolveBackend()`, `detectBackend()`, `withRetry()`, telemetry types (`TelemetryEntry`, `RunLog`, `FileRead`), and subprocess utilities. Prohibits direct imports from `src/ai/backends/` or `src/ai/telemetry/`.

**[types.ts](./types.ts)** — Core contracts: `AIBackend` interface (`isAvailable()`, `buildArgs()`, `parseResponse()`, `getInstallInstructions()`), `SubprocessResult` (`stdout`, `stderr`, `exitCode`, `signal`, `durationMs`, `timedOut`, `childPid`), `AICallOptions` (`prompt`, optional `systemPrompt`, `model`, `timeoutMs`, `maxTurns`, `taskLabel`), `AIResponse` (normalized `text`, token counts, `durationMs`, `exitCode`), `RetryOptions` (exponential backoff configuration), telemetry types (`TelemetryEntry`, `RunLog`, `FileRead`), `AIServiceError` with typed `code` (`'CLI_NOT_FOUND' | 'TIMEOUT' | 'PARSE_ERROR' | 'SUBPROCESS_ERROR' | 'RATE_LIMIT'`).

### Backend Management

**[registry.ts](./registry.ts)** — `BackendRegistry` manages registered backends via `register()` and `get()`. `createBackendRegistry()` pre-populates with `ClaudeBackend`, `GeminiBackend`, `OpenCodeBackend` in detection priority order. `detectBackend(registry)` iterates backends, returns first where `isAvailable()` resolves true. `resolveBackend(registry, requested)` handles `'auto'` detection or explicit backend selection, throws `AIServiceError('CLI_NOT_FOUND')` with install instructions on unavailable CLI.

### Orchestration

**[service.ts](./service.ts)** — `AIService` orchestrates AI calls: wraps `runSubprocess()` with `withRetry()`, enforces timeout via `SubprocessOptions.timeoutMs`, records telemetry via `TelemetryLogger.addEntry()`, tracks active subprocess count, emits trace events (`subprocess:spawn`, `subprocess:exit`, `retry`). `call(options)` returns `AIResponse` from backend's `parseResponse()` output. `finalize(projectRoot)` writes run log and cleans old logs. `addFilesReadToLastEntry()` mutates last telemetry entry. `setSubprocessLogDir()` enables per-subprocess `.log` file writes. `isRateLimitStderr()` checks for `RATE_LIMIT_PATTERNS` in stderr.

**[retry.ts](./retry.ts)** — `withRetry(fn, options)` implements exponential backoff `min(baseDelayMs * multiplier^attempt, maxDelayMs) + jitter` where jitter is `Math.random() * 500`. Exits immediately on `!isRetryable(error)` or after `maxRetries` exhausted. Invokes `onRetry(attempt, error)` before delay. `DEFAULT_RETRY_OPTIONS` provides `maxRetries: 3`, `baseDelayMs: 1000`, `maxDelayMs: 8000`, `multiplier: 2`.

**[subprocess.ts](./subprocess.ts)** — `runSubprocess(command, args, options)` spawns CLI via `execFile()`, pipes `options.input` to stdin, enforces timeout with SIGTERM followed by SIGKILL after `SIGKILL_GRACE_MS` (5000ms). Attempts process group kill `process.kill(-pid, 'SIGKILL')` to terminate subprocess tree, falls back to single process kill. Invokes `options.onSpawn(pid)` synchronously after spawn. Tracks active subprocesses via `activeSubprocesses` Map. Returns `SubprocessResult` with `exitCode`, `signal`, `durationMs`, `timedOut`, `childPid`.

## Subdirectories

**[backends/](./backends/)** — AIBackend implementations: `ClaudeBackend` (production-ready with JSON array/NDJSON/legacy parsing, Zod validation via `ClaudeResponseSchema`), `GeminiBackend` (stub), `OpenCodeBackend` (stub). All export `isCommandOnPath()` for CLI detection via `PATH` search.

**[telemetry/](./telemetry/)** — Persistence layer: `TelemetryLogger` accumulates entries, `writeRunLog()` serializes to `.agents-reverse-engineer/logs/run-${timestamp}.json`, `cleanupOldLogs()` enforces retention. Filename format: ISO 8601 with `:` and `.` replaced by `-`.

## Behavioral Contracts

### Rate-Limit Detection Patterns
```javascript
RATE_LIMIT_PATTERNS = ['rate limit', '429', 'too many requests', 'overloaded']
```
Matched case-insensitively in stderr. Rate-limit errors retry up to `maxRetries`, timeout errors do not retry.

### Subprocess Timeout Handling
SIGTERM sent at `timeoutMs`, SIGKILL escalation after `timeoutMs + SIGKILL_GRACE_MS` (5000ms). Process group kill `kill(-pid)` attempts to terminate entire subprocess tree, falls back to single process `kill(pid)`.

### Subprocess Log Format
```
task:      ${taskLabel}
pid:       ${childPid}
command:   ${cliCommand}
exit:      ${exitCode}
signal:    ${signal ?? 'none'}
duration:  ${durationMs}ms
timed_out: ${timedOut}

--- stdout ---
${stdout}
--- stderr ---
${stderr}
```
Filename: `${sanitizedTaskLabel}_pid${childPid}.log`, sanitization replaces `/` with `--`, non-alphanumeric (except `._-`) with `_`.

## Integration Points

- **Upstream consumers**: CLI commands (`src/cli/`) invoke `AIService.call()`, `finalize()`, `addFilesReadToLastEntry()`.
- **Downstream dependencies**: `runSubprocess()` wraps Node.js `execFile()`, `TelemetryLogger` from `src/ai/telemetry/logger.js`, `ITraceWriter` from `src/orchestration/trace.js` for concurrency event tracing.
- **Configuration**: `AIServiceOptions.telemetry.keepRuns` controls log retention, passed to `cleanupOldLogs()`.