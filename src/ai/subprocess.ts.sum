---
generated_at: 2026-02-09T14:08:35.009Z
content_hash: 2d0c4834799e406b4745aa058f264e3e30d85b9f9c1d84d8d8612ad0bd169e14
purpose: Centralized subprocess spawner for AI CLI invocations with timeout enforcement, SIGKILL escalation, process group ter...
---
**Centralized subprocess spawner for AI CLI invocations with timeout enforcement, SIGKILL escalation, process group termination, and active subprocess tracking.**

## Exported Functions

### runSubprocess
```typescript
function runSubprocess(
  command: string,
  args: string[],
  options: SubprocessOptions
): Promise<SubprocessResult>
```
Spawns AI CLI subprocess via `execFile()` with timeout enforcement, stdin piping, and guaranteed resolution (never rejects). Returns `SubprocessResult` containing `stdout`, `stderr`, `exitCode`, `signal`, `durationMs`, `timedOut`, `childPid`. Implements two-stage kill sequence: SIGTERM at `timeoutMs`, escalates to SIGKILL after `SIGKILL_GRACE_MS` (5000ms). Pipes `options.input` to stdin if provided, then calls `.end()` to send EOF. Invokes `options.onSpawn(pid)` synchronously after spawn for trace event timing. Tracks subprocess in `activeSubprocesses` Map from spawn to callback, enabling concurrency monitoring. Kills process groups via `process.kill(-child.pid, 'SIGKILL')` to terminate subprocess trees, falls back to single-process kill if process group targeting fails.

### getActiveSubprocessCount
```typescript
function getActiveSubprocessCount(): number
```
Returns count of currently tracked subprocesses in `activeSubprocesses` Map. Used for debugging concurrency issues and verifying subprocess cleanup.

### getActiveSubprocesses
```typescript
function getActiveSubprocesses(): Array<{
  pid: number;
  command: string;
  spawnedAt: number;
  runningMs: number;
}>
```
Returns array of active subprocess details with PID, command string, spawn timestamp, and elapsed milliseconds. Computes `runningMs` as delta from `Date.now()` to `spawnedAt`.

## Exported Types

### SubprocessOptions
```typescript
interface SubprocessOptions {
  timeoutMs: number;
  input?: string;
  onSpawn?: (pid: number | undefined) => void;
}
```
Configuration for `runSubprocess()`: `timeoutMs` triggers SIGTERM, optional `input` string piped to stdin, optional `onSpawn` callback fired synchronously when `child.pid` becomes available (before `execFile` callback).

## Process Lifecycle Management

**Timeout Enforcement:**
- `execFile()` configured with `timeout: options.timeoutMs` and `killSignal: 'SIGTERM'`
- Unref'd timer schedules SIGKILL at `timeoutMs + SIGKILL_GRACE_MS` (5s grace period)
- Timer cleared in `execFile` callback when process exits naturally
- Exit code extraction: uses `error.code` if numeric, falls back to `child.exitCode`, defaults to 1 for errors or 0 for success
- `timedOut` flag set when `error.killed === true` from `execFile` timeout

**Process Group Termination:**
- Sends `process.kill(-child.pid, 'SIGKILL')` (negative PID targets process group)
- Prevents zombie subprocesses spawned by AI CLI (e.g., Claude Code's internal Node.js threads)
- Falls back to `process.kill(child.pid, 'SIGKILL')` if process group kill throws
- Catches and ignores kill errors (process already dead)

**Active Subprocess Tracking:**
- `activeSubprocesses` Map stores `{ command: string, spawnedAt: number }` keyed by PID
- Populated after spawn when `child.pid !== undefined`
- Removed in `execFile` callback before resolving Promise
- Enables concurrency debugging via `getActiveSubprocessCount()` and `getActiveSubprocesses()`

**Stdin Piping:**
- Writes `options.input` to `child.stdin` if provided and stream exists
- Always calls `child.stdin.end()` to send EOF (subprocess blocks indefinitely without EOF)
- Logs input size via `Buffer.byteLength(options.input, 'utf-8')`

## Configuration Constants

**SIGKILL_GRACE_MS:** 5000ms delay between SIGTERM and SIGKILL escalation. Prevents hung processes from surviving timeout.

**maxBuffer:** `execFile` configured with 10MB buffer (`10 * 1024 * 1024`) to accommodate large AI responses without `ERR_CHILD_PROCESS_STDIO_MAXBUFFER`.

## Integration Pattern

Single point of subprocess invocation for all AI backends (`claude.ts`, `gemini.ts`, `opencode.ts`). Called by `AIService.call()` via backend-specific adapters. Traces subprocess lifecycle via `onSpawn` callback consumed by `TraceWriter` in `src/orchestration/trace.ts`. Subprocess results propagate through `AIService` → retry logic (`src/ai/retry.ts`) → telemetry logger (`src/ai/telemetry/logger.ts`) → worker pool (`src/orchestration/pool.ts`).