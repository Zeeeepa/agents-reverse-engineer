---
generated_at: 2026-02-09T17:44:40.456Z
content_hash: 2d0c4834799e406b4745aa058f264e3e30d85b9f9c1d84d8d8612ad0bd169e14
purpose: subprocess.ts spawns and manages AI CLI child processes with timeout enforcement, SIGKILL escalation, stdin piping, a...
---
**subprocess.ts spawns and manages AI CLI child processes with timeout enforcement, SIGKILL escalation, stdin piping, and active subprocess tracking.**

## Exported Functions

**runSubprocess(command: string, args: string[], options: SubprocessOptions): Promise<SubprocessResult>** — Spawns AI CLI subprocess via `execFile()`, pipes optional `input` to stdin, enforces timeout via SIGTERM at `options.timeoutMs`, escalates to SIGKILL after 5s grace period if process doesn't exit, tracks active subprocesses in module-scoped Map, invokes `options.onSpawn(pid)` callback synchronously after spawn, always resolves (never rejects) with `SubprocessResult` containing `stdout`, `stderr`, `exitCode`, `signal`, `durationMs`, `timedOut` boolean, and `childPid`.

**getActiveSubprocessCount(): number** — Returns current count of active subprocesses from module-scoped `activeSubprocesses` Map.

**getActiveSubprocesses(): Array<{ pid: number; command: string; spawnedAt: number; runningMs: number }>** — Returns array of all active subprocess details with computed `runningMs` elapsed time.

## Exported Types

**SubprocessOptions** interface with required `timeoutMs: number`, optional `input?: string` for stdin piping, optional `onSpawn?: (pid: number | undefined) => void` callback fired synchronously when child process spawns.

## Process Lifecycle Management

**Timeout enforcement** sends SIGTERM at `timeoutMs` via `execFile` timeout option with `killSignal: 'SIGTERM'`, then schedules unref'd SIGKILL timer at `timeoutMs + SIGKILL_GRACE_MS` (5000ms constant) to force-kill hung processes that ignore SIGTERM.

**Process group killing** attempts `process.kill(-child.pid, 'SIGKILL')` with negative PID to target entire process tree, falls back to single-process `process.kill(child.pid, 'SIGKILL')` if process group signal fails, wraps in try-catch since process may already be dead.

**Active subprocess tracking** maintains module-scoped `activeSubprocesses` Map storing `{ command: string, spawnedAt: number }` keyed by PID, adds entry after spawn, removes in `execFile` callback, enables concurrency debugging via `getActiveSubprocessCount()` and `getActiveSubprocesses()`.

**Stdin handling** writes `options.input` to `child.stdin` via `.write()` then calls `.end()` to send EOF, preventing child process from blocking indefinitely waiting for stdin closure (see comment: "RESEARCH.md Pitfall 1").

## Exit Code Extraction

**Exit code precedence** checks `error === null` (returns 0), then `typeof error.code === 'number'` (returns `error.code`), then `child.exitCode !== null` (returns `child.exitCode`), else defaults to 1. Handles `execFile` placing numeric exit codes in `error.code` while also using string error codes like `'ERR_CHILD_PROCESS_STDIO_MAXBUFFER'`.

**Timeout detection** sets `timedOut = true` when `error !== null && 'killed' in error && error.killed === true`, which `execFile` sets when process exceeds timeout option and is terminated.

## Configuration

**maxBuffer** set to `10 * 1024 * 1024` (10MB) to accommodate large AI responses without triggering `ERR_CHILD_PROCESS_STDIO_MAXBUFFER`.

**SIGKILL_GRACE_MS** constant defines 5000ms grace period between SIGTERM and SIGKILL escalation.

## Integration Points

Imported by `src/ai/service.ts` as sole subprocess spawning mechanism for AI CLI backends (Claude Code, Gemini CLI, OpenCode). Returns `SubprocessResult` consumed by `AIService.call()` for retry logic, telemetry logging, and trace emission.