---
generated_at: 2026-02-09T15:06:38.172Z
content_hash: 2d0c4834799e406b4745aa058f264e3e30d85b9f9c1d84d8d8612ad0bd169e14
purpose: subprocess.ts provides low-level subprocess wrapper for AI CLI invocations with timeout enforcement, SIGTERM/SIGKILL ...
---
**subprocess.ts provides low-level subprocess wrapper for AI CLI invocations with timeout enforcement, SIGTERM/SIGKILL escalation, stdin piping, process group cleanup, and active subprocess tracking.**

## Exported Functions

**runSubprocess(command: string, args: string[], options: SubprocessOptions): Promise<SubprocessResult>**
Spawns AI CLI subprocess via `execFile()` with timeout enforcement, always resolves (never rejects), captures errors in `SubprocessResult` fields (`exitCode`, `timedOut`, `stderr`). Sends SIGTERM at `options.timeoutMs`, escalates to SIGKILL after `SIGKILL_GRACE_MS` (5000ms) grace period. Pipes `options.input` to stdin if provided, closes stdin stream via `.end()` to unblock child process waiting for EOF. Invokes `options.onSpawn(pid)` callback synchronously after spawn for trace event timing. Kills entire process tree via `process.kill(-child.pid, 'SIGKILL')` using negative PID for process group targeting, falls back to single-process kill if group kill fails. Sets `maxBuffer: 10MB` for large AI responses, returns `SubprocessResult` with `stdout`, `stderr`, `exitCode`, `signal`, `durationMs`, `timedOut`, `childPid`.

**getActiveSubprocessCount(): number**
Returns size of `activeSubprocesses` Map tracking concurrent AI CLI processes.

**getActiveSubprocesses(): Array<{ pid: number; command: string; spawnedAt: number; runningMs: number }>**
Returns array of active subprocess details with PID, command string, spawn timestamp, and elapsed runtime in milliseconds.

## Types

**SubprocessOptions**
Interface with `timeoutMs: number` (SIGTERM threshold), optional `input?: string` (stdin payload), optional `onSpawn?: (pid: number | undefined) => void` (spawn-time callback for trace events).

**SubprocessResult** (imported from `./types.js`)
Return type containing `stdout`, `stderr`, `exitCode`, `signal`, `durationMs`, `timedOut`, `childPid` fields.

## Constants

**SIGKILL_GRACE_MS = 5000**
Grace period in milliseconds between SIGTERM and SIGKILL escalation to prevent hung processes.

## State Management

**activeSubprocesses: Map<number, { command: string; spawnedAt: number }>**
Tracks PIDs of spawned subprocesses with command string and spawn timestamp. Populated after `execFile()` returns child object with `.pid`, cleared in callback after process exits. Used by `getActiveSubprocessCount()` and `getActiveSubprocesses()` for concurrency debugging.

## Process Cleanup Strategy

Uses unref'd `setTimeout()` for SIGKILL escalation timer (`timeout = timeoutMs + SIGKILL_GRACE_MS`) to prevent event loop blocking. Clears timer in `execFile()` callback after process exits. Attempts process group kill via `process.kill(-child.pid, 'SIGKILL')` in callback's explicit cleanup section, catches errors for already-dead processes. Handles timeout detection via `error.killed === true` from `execFile()` when SIGTERM terminates process.

## Exit Code Extraction

Prioritizes `error.code` (number type) from `execFile()` callback, falls back to `child.exitCode`, defaults to `1` for unknown failures and `0` for null error. Filters out string error codes like `'ERR_CHILD_PROCESS_STDIO_MAXBUFFER'`.

## Environment Configuration

Spreads `process.env` into `execFile()` options without modifications. Caller (AIService) injects resource limits: `NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`.

## Integration Points

Single subprocess spawn point for entire codebase. Called by `AIService.call()` in `src/ai/service.ts` which wraps with retry logic, telemetry logging, and trace emission. Returns `SubprocessResult` consumed by backend adapters (`src/ai/backends/*.ts`) for JSON parsing and error classification.