---
generated_at: 2026-02-09T21:28:36.698Z
content_hash: 2d0c4834799e406b4745aa058f264e3e30d85b9f9c1d84d8d8612ad0bd169e14
purpose: subprocess.ts spawns AI CLI processes via execFile() with timeout enforcement, SIGTERM→SIGKILL escalation, stdin pipi...
---
**subprocess.ts spawns AI CLI processes via execFile() with timeout enforcement, SIGTERM→SIGKILL escalation, stdin piping, process group termination, and active subprocess tracking.**

## Exported Functions

**runSubprocess(command: string, args: string[], options: SubprocessOptions): Promise<SubprocessResult>**

Spawns a CLI subprocess using Node.js `execFile()` with comprehensive process lifecycle management. Never rejects—always resolves with `SubprocessResult` containing `stdout`, `stderr`, `exitCode`, `signal`, `durationMs`, `timedOut`, and `childPid`. Executes the following sequence:

1. Spawns child process with `maxBuffer: 10485760` (10MB), `killSignal: 'SIGTERM'`, `encoding: 'utf-8'`
2. Tracks spawn in `activeSubprocesses` Map with command string and `spawnedAt` timestamp
3. Invokes `options.onSpawn?.(child.pid)` synchronously after spawn for trace event emission
4. Writes `options.input` to `child.stdin` if provided, then calls `.end()` to close stream (prevents EOF blocking)
5. Sets unref'd SIGKILL escalation timer for `options.timeoutMs + SIGKILL_GRACE_MS` (5000ms)
6. On callback: clears SIGKILL timer, attempts process group kill via `process.kill(-child.pid, 'SIGKILL')` with single-process fallback, removes PID from `activeSubprocesses`, resolves promise
7. Detects timeout via `error.killed === true` from execFile timeout mechanism
8. Extracts exit code from `error.code` (if number), else `child.exitCode`, else defaults to 1 (failure) or 0 (success)

**getActiveSubprocessCount(): number**

Returns current size of `activeSubprocesses` Map for debugging concurrency issues.

**getActiveSubprocesses(): Array<{ pid: number; command: string; spawnedAt: number; runningMs: number }>**

Returns array of active subprocess metadata with computed `runningMs` delta from `Date.now() - spawnedAt`.

## Interfaces

**SubprocessOptions**

```typescript
{
  timeoutMs: number;        // Maximum execution time before SIGTERM
  input?: string;           // Optional stdin payload
  onSpawn?: (pid: number | undefined) => void;  // Synchronous spawn callback
}
```

**SubprocessResult** (imported from `./types.js`)

Expected shape: `{ stdout: string, stderr: string, exitCode: number, signal: string | null, durationMs: number, timedOut: boolean, childPid: number | undefined }`

## Process Lifecycle Management

**Timeout Enforcement:**

`execFile()` timeout option sends SIGTERM at `timeoutMs`. Unref'd escalation timer sends SIGKILL at `timeoutMs + 5000ms` via `child.kill('SIGKILL')` to handle hung processes ignoring SIGTERM.

**Process Group Termination:**

On callback completion, attempts `process.kill(-child.pid, 'SIGKILL')` (negative PID targets process group) to kill entire subprocess tree. Falls back to single-process `process.kill(child.pid, 'SIGKILL')` if process group kill throws. Catch block ignores errors (process already dead).

**Zombie Prevention:**

Explicit SIGKILL cleanup in callback ensures no lingering child processes. Timer unref prevents event loop blocking.

## Active Subprocess Tracking

**activeSubprocesses: Map<number, { command: string; spawnedAt: number }>**

Module-level Map tracking PIDs with command string (`${command} ${args.join(' ')}`) and spawn timestamp. Updated on spawn (`.set()`) and callback (`.delete()`). Enables debugging via `getActiveSubprocessCount()` and `getActiveSubprocesses()`.

## Constants

**SIGKILL_GRACE_MS = 5000**

Grace period (5 seconds) between SIGTERM and SIGKILL escalation.

## Integration Points

Imported by `src/ai/service.ts` (`AIService.call()`) which wraps this with retry logic, telemetry logging, and backend-specific argument construction. The `onSpawn` callback is used by `AIService` to emit `subprocess:spawn` trace events with actual spawn timestamp.

## Environment Passthrough

Merges `process.env` into child environment without modification—caller (backends in `src/ai/backends/`) must set resource constraint variables (`NODE_OPTIONS`, `UV_THREADPOOL_SIZE`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS`) before invocation.

## Error Handling Strategy

Never throws. Captures all failure modes in `SubprocessResult`:
- Non-zero exit codes → `exitCode` field
- Timeout expiration → `timedOut: true`
- Kill signals → `signal` field (e.g., `'SIGTERM'`, `'SIGKILL'`)
- Execution errors → `stderr` field

Caller decides retry/abort via pattern matching on these fields (see `src/ai/retry.ts`).