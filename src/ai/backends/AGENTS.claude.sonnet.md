<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/ai/backends

AIBackend adapters translating unified `AICallOptions` to CLI-specific invocations: `claude` (JSON/NDJSON with Zod validation), `codex` (JSONL event streaming with plain-text fallback), `gemini` (JSON with model aliasing and XML system prompt wrapping), `opencode` (NDJSON aggregation with agent config enforcement and fallback cost calculation).

## Contents

- [`claude.ts`](./claude.ts): `ClaudeBackend` builds `['-p', '--output-format json', '--no-session-persistence', '--allowedTools Read Write', '--model', '--system-prompt', '--max-turns']` args, parses three-format responses (JSON array CLI ≥2.1.38, NDJSON, legacy single-object ≤2.1.31) via `extractResultJson`, validates `ClaudeResponseSchema` with `passthrough()`, extracts model from `modelUsage` keys.
- [`codex.ts`](./codex.ts): `CodexBackend` constructs `['-a', 'never', 'exec', '--json', '--skip-git-repo-check', '--ephemeral', '--color', 'never', '--model', '-']` args, wraps prompts in `<system-instructions>` tags, parses JSONL via three-tier cascade: `item.completed` agent messages → `collectText(event, out, shouldSkipTextObject)` recursive filter → plain-text fallback, deduplicates text via `uniq`, aggregates tokens from `turn.completed.usage` with snake_case/camelCase tolerance.
- [`common.ts`](./common.ts): `isCommandOnPath(command)` cross-platform PATH lookup using `path.delimiter` splits, `fs.stat` existence checks, Windows `PATHEXT` (.exe/.cmd/.bat) enumeration.
- [`gemini.ts`](./gemini.ts): `GeminiBackend` resolves `MODEL_ALIASES` (`sonnet`→`gemini-3-flash-preview`, `opus`→`gemini-3-pro-preview`, `haiku`→`gemini-2.5-flash`, `flash`/`pro` short names), builds `['-p', wrappedPrompt, '--output-format', 'json', '-m', model]` args, folds system prompts via `<system-instructions>` XML, parses JSON via `extractJson` (skips prefix text before `{`), aggregates `stats.models[*].tokens.prompt`/`response` across all models.
- [`opencode.ts`](./opencode.ts): `OpenCodeBackend` writes `.opencode/agents/are-summarizer.md` config with `steps: 5` and `tools: {"*": false}` to enforce single-turn mode, builds `['run', '--format', 'json', '--agent', 'are-summarizer', '--model', model]` args, parses NDJSON `text`/`step_finish` events via `parseNdjson`, aggregates tokens/cost across agentic turns, invokes `calculateCostFromTokens` (Anthropic pricing: $15/$75/$18.75/$1.50 per Mtok) when `totalCost === 0`, strips `'MAXIMUM STEPS REACHED'` marker.

## Response Parsing Strategies

**ClaudeBackend**: `extractResultJson` tries three formats: (1) parse as JSON array, find `type: "result"` element, re-serialize; (2) split on `\n`, find NDJSON line with `type: "result"`; (3) locate first `{`, slice remainder. `ClaudeResponseSchema` validates `subtype: 'success'|'error'`, `is_error`, `usage.input_tokens`/`output_tokens`/`cache_read_input_tokens`/`cache_creation_input_tokens`, `modelUsage[model].usage.*` with per-model breakdown. Extracts model from first `modelUsage` key.

**CodexBackend**: `parseResponse` implements three-tier fallback: (1) filter `item.completed` events where `type: 'agent_message'`, collect `text` and `content[]` with `type: 'text'|'output_text'`; (2) recursive `collectText(event, out, shouldSkipTextObject)` filtering objects where `type === 'reasoning'` or `type.endsWith('.reasoning')`; (3) if `parsedJsonLines === 0`, return entire stdout. `uniq(items)` deduplicates while preserving order. `extractUsageFromTurnCompleted` accepts snake_case (`input_tokens`) and camelCase (`inputTokens`) variants.

**GeminiBackend**: `extractJson` strips prefix text (version notices) by finding first `{` if stdout doesn't start with JSON. `extractMetrics` aggregates `stats.models[*].tokens.prompt`/`response` across all models, returns first model name or `'unknown'`. Throws `AIServiceError('PARSE_ERROR')` for missing JSON, empty `response`, or schema validation failure; throws `AIServiceError('SUBPROCESS_ERROR')` when `parsed.error` non-null/non-empty.

**OpenCodeBackend**: `parseNdjson` splits NDJSON lines, parses `text` events (`part.type === 'text'`) and `step_finish` events (`event.type === 'step_finish'` or `part.type === 'step-finish'`), aggregates `inputTokens`/`outputTokens`/`reasoningTokens`/`cacheReadTokens`/`cacheWriteTokens`/`totalCost` across turns, counts `numTurns`. Skips malformed lines via try/catch. `parseResponse` strips `'MAXIMUM STEPS REACHED'` marker if cleaned text ≥100 chars, else throws `PARSE_ERROR`. Invokes `calculateCostFromTokens` when `totalCost === 0 && (inputTokens > 0 || outputTokens > 0)`.

## CLI Argument Patterns

**ClaudeBackend**: `['-p', '--output-format json', '--no-session-persistence', '--allowedTools Read Write']` (always included), optional `['--model', model]`, `['--system-prompt', systemPrompt]`, `['--max-turns', maxTurns]`. Prompt routed to stdin by `runSubprocess` wrapper (not in `buildArgs`).

**CodexBackend**: `['-a', 'never', 'exec', '--json', '--skip-git-repo-check', '--ephemeral', '--color', 'never']`, optional `['--model', model]`, `['-']` for stdin mode. `composeStdinInput` wraps `systemPrompt` in `<system-instructions>\n...\n</system-instructions>\n\n` prefix. Approval policy `-a never` must precede `exec` (newer CLIs reject post-command placement).

**GeminiBackend**: `['-p', wrappedPrompt, '--output-format', 'json', '-m', resolvedModel]`. Prompt passed via `-p` flag (not stdin), so `composeStdinInput` returns empty string. `systemPrompt` folded into prompt as `<system-instructions>\n...\n</system-instructions>\n\n` prefix.

**OpenCodeBackend**: `['run', '--format', 'json', '--agent', 'are-summarizer', '--model', resolvedModel]`. `composeStdinInput` wraps `systemPrompt` in `<system-instructions>\n...\n</system-instructions>\n\n` prefix. `ensureProjectConfig` writes `.opencode/agents/are-summarizer.md` with frontmatter `steps: 5`, `tools: {"*": false}` to disable agentic loops.

## Model Resolution

**ClaudeBackend**: No aliasing — passes `model` directly to `--model` flag when present.

**CodexBackend**: No aliasing — passes `model` directly to `--model` flag when present.

**GeminiBackend**: `resolveModelForGemini(model)` returns input if prefixed `gemini-`, else looks up in `MODEL_ALIASES`: `sonnet`→`gemini-3-flash-preview`, `opus`→`gemini-3-pro-preview`, `haiku`→`gemini-2.5-flash`, `flash`→`gemini-3-flash-preview`, `pro`→`gemini-3-pro-preview`. Defaults to input if no match.

**OpenCodeBackend**: `resolveModelForOpenCode(model)` returns input if `model.includes('/')`, else maps via `MODEL_ALIASES`: `sonnet`→`anthropic/claude-sonnet-4-5`, `opus`→`anthropic/claude-opus-4-6`, `haiku`→`anthropic/claude-haiku-4-5`.

## Token Accounting

**ClaudeBackend**: `usage.input_tokens`, `usage.output_tokens`, `usage.cache_read_input_tokens`, `usage.cache_creation_input_tokens` from `ClaudeResponseSchema`. Per-model breakdown in `modelUsage[model].usage.*`.

**CodexBackend**: `extractUsageFromTurnCompleted` computes `inputTokens = rawInput - cacheRead` (where `rawInput` from `input_tokens`, `cacheRead` from `cached_input_tokens`/`cache_read_input_tokens`), `outputTokens` from `output_tokens`, `cacheCreationTokens` from `cache_creation_input_tokens`. Accepts snake_case and camelCase variants.

**GeminiBackend**: `extractMetrics` sums `stats.models[*].tokens.prompt` into `inputTokens`, `stats.models[*].tokens.response` into `outputTokens`, sets `cacheReadTokens: 0`, `cacheCreationTokens: 0` (Gemini CLI doesn't expose cache metrics).

**OpenCodeBackend**: `parseNdjson` aggregates `inputTokens`/`outputTokens`/`reasoningTokens`/`cacheReadTokens` (from `tokens.cache.read`)/`cacheWriteTokens` (from `tokens.cache.write`) across all `step_finish` events. `calculateCostFromTokens` applies Anthropic pricing: INPUT_COST_PER_MTOK=15, OUTPUT_COST_PER_MTOK=75, CACHE_WRITE_COST_PER_MTOK=18.75, CACHE_READ_COST_PER_MTOK=1.50.

## Behavioral Contracts

**ClaudeBackend extractResultJson format detection**:
1. JSON array `[{system}, {assistant}, {result}]` (CLI ≥2.1.38): `JSON.parse`, find `type: "result"`, `JSON.stringify`
2. NDJSON: `stdout.split('\n')`, filter `line.includes('"type":"result"')`
3. Legacy (CLI ≤2.1.31): `stdout.indexOf('{')`, `stdout.slice(index)`

**CodexBackend shouldSkipTextObject filter**: `type === 'reasoning' || type.endsWith('.reasoning')`

**GeminiBackend extractJson prefix handling**: `stdout.trim().startsWith('{') ? stdout : stdout.slice(stdout.indexOf('{'))`

**OpenCodeBackend agent config**: `.opencode/agents/are-summarizer.md` with frontmatter `steps: 5`, `tools: {"*": false}`, instructions to follow `<system-instructions>` tags and output raw content without preamble. Enforces non-agentic single-turn mode.

**OpenCodeBackend step limit marker**: `'MAXIMUM STEPS REACHED'` stripped if cleaned text ≥100 chars, else `AIServiceError('PARSE_ERROR')`.

**Cost calculation fallback** (OpenCodeBackend): triggers when `totalCost === 0 && (inputTokens > 0 || outputTokens > 0)`.