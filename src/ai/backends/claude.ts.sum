---
generated_at: 2026-02-09T17:44:06.859Z
content_hash: 9c98c917fde849284a46f0ed20bbef87a30caf8e94be8578b8d689ff92618f2d
purpose: ClaudeBackend implements AIBackend interface for Claude Code CLI, providing PATH detection via isCommandOnPath(), arg...
---
**ClaudeBackend implements AIBackend interface for Claude Code CLI, providing PATH detection via isCommandOnPath(), argument construction with permission bypass flags, JSON response parsing with Zod validation against ClaudeResponseSchema, and installation instructions.**

## Exported Interface

`ClaudeBackend` class implements `AIBackend` interface with:
- `name: 'claude'` — Backend identifier string
- `cliCommand: 'claude'` — Executable name for PATH lookup
- `isAvailable(): Promise<boolean>` — Delegates to `isCommandOnPath('claude')`
- `buildArgs(options: AICallOptions): string[]` — Constructs CLI arguments array
- `parseResponse(stdout: string, durationMs: number, exitCode: number): AIResponse` — Parses JSON output into normalized response
- `getInstallInstructions(): string` — Returns npm install command for `@anthropic-ai/claude-code`

`isCommandOnPath(command: string): Promise<boolean>` exported function splits `process.env.PATH` by platform delimiter, iterates through directories, checks file existence via `fs.stat()` (not `fs.access()` for cross-platform compatibility), handles Windows `PATHEXT` environment variable for extension variants (`.exe`, `.cmd`, `.bat`).

## CLI Arguments Construction

`buildArgs()` returns fixed arguments array:
- `-p` — Non-interactive print mode
- `--output-format json` — Structured JSON output
- `--no-session-persistence` — Prevent session disk writes
- `--permission-mode bypassPermissions` — Skip interactive permission prompts (PITFALLS.md §8)

Conditional arguments from `AICallOptions`:
- `--model <model>` if `options.model` provided
- `--system-prompt <systemPrompt>` if `options.systemPrompt` provided
- `--max-turns <maxTurns>` if `options.maxTurns !== undefined`

Prompt text NOT included in args array — delivered to stdin via `runSubprocess()` wrapper.

## Response Schema Validation

`ClaudeResponseSchema` validated against Claude CLI v2.1.31 JSON output (see RESEARCH.md):
```typescript
{
  type: 'result',
  subtype: 'success' | 'error',
  is_error: boolean,
  duration_ms: number,
  duration_api_ms: number,
  num_turns: number,
  result: string,
  session_id: string,
  total_cost_usd: number,
  usage: {
    input_tokens: number,
    cache_creation_input_tokens: number,
    cache_read_input_tokens: number,
    output_tokens: number,
  },
  modelUsage: Record<string, {
    inputTokens: number,
    outputTokens: number,
    cacheReadInputTokens: number,
    cacheCreationInputTokens: number,
    costUSD: number,
  }>
}
```

`parseResponse()` defensively finds first `{` character via `stdout.indexOf('{')` to handle non-JSON prefix text (upgrade notices per RESEARCH.md Pitfall 4). Extracts model name from first key in `modelUsage` object (defaults to `'unknown'`). Throws `AIServiceError` with code `PARSE_ERROR` if JSON missing or Zod validation fails.

## PATH Detection Algorithm

`isCommandOnPath()` algorithm:
1. Parse `process.env.PATH` with `path.delimiter` (`;` on Windows, `:` on Unix)
2. Strip quote characters via `.replace(/["]+/g, '')`
3. Parse `process.env.PATHEXT` on Windows for executable extensions (empty array on Unix defaults to `['']`)
4. Nested loop: for each directory × extension, construct candidate path via `path.join(dir, command + ext)`
5. Check `(await fs.stat(candidate)).isFile()` — returns `true` on first match, `false` if all candidates fail

Uses `fs.stat()` instead of `fs.access(fs.constants.X_OK)` because Windows lacks Unix execute permission bits.

## Dependencies

- `node:fs/promises` — `fs.stat()` for PATH detection
- `node:path` — `path.join()`, `path.delimiter` for cross-platform path manipulation
- `zod` — `ClaudeResponseSchema` validation, `z.infer<>` type extraction
- `../types.js` — `AIBackend`, `AICallOptions`, `AIResponse`, `AIServiceError` imports

## Integration Points

`ClaudeBackend` consumed by `AIService` in `src/ai/service.ts` via backend registry. `runSubprocess()` in `src/ai/subprocess.ts` receives args from `buildArgs()` and stdout for `parseResponse()`. `isCommandOnPath()` utility reusable for other backend availability checks.