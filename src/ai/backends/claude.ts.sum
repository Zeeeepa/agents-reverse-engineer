---
generated_at: 2026-02-09T21:27:56.449Z
content_hash: 9c98c917fde849284a46f0ed20bbef87a30caf8e94be8578b8d689ff92618f2d
purpose: ClaudeBackend implements AIBackend interface for Claude Code CLI, providing PATH detection via isCommandOnPath(), arg...
---
**ClaudeBackend implements AIBackend interface for Claude Code CLI, providing PATH detection via isCommandOnPath(), argument construction with bypass permissions, and JSON response parsing with Zod schema validation.**

## Exported Symbols

**isCommandOnPath(command: string): Promise<boolean>** — Splits `process.env.PATH` by platform delimiter, checks each directory for file matching command name, on Windows iterates `process.env.PATHEXT` extensions (`.exe`, `.cmd`, `.bat`), uses `fs.stat()` instead of `fs.access()` for cross-platform compatibility without Unix execute bits.

**ClaudeBackend** — Implements `AIBackend` interface with properties `name: 'claude'`, `cliCommand: 'claude'`, methods `isAvailable()`, `buildArgs()`, `parseResponse()`, `getInstallInstructions()`.

## ClaudeBackend Methods

**isAvailable(): Promise<boolean>** — Delegates to `isCommandOnPath(this.cliCommand)` to verify `claude` binary exists on system PATH.

**buildArgs(options: AICallOptions): string[]** — Constructs argument array `['-p', '--output-format', 'json', '--no-session-persistence', '--permission-mode', 'bypassPermissions']`, appends `--model` if `options.model` present, appends `--system-prompt` if `options.systemPrompt` present, appends `--max-turns` converted to string if `options.maxTurns` defined, does NOT include prompt text (goes to stdin via `runSubprocess()`).

**parseResponse(stdout: string, durationMs: number, exitCode: number): AIResponse** — Finds first `{` character via `stdout.indexOf('{')` to handle non-JSON prefix text (upgrade notices per RESEARCH.md Pitfall 4), slices stdout from `jsonStart`, parses JSON and validates against `ClaudeResponseSchema`, extracts model name from first key of `parsed.modelUsage` object (fallback `'unknown'`), returns normalized `AIResponse` with `text: parsed.result`, `inputTokens: parsed.usage.input_tokens`, `outputTokens: parsed.usage.output_tokens`, `cacheReadTokens: parsed.usage.cache_read_input_tokens`, `cacheCreationTokens: parsed.usage.cache_creation_input_tokens`, `durationMs`, `exitCode`, `raw: parsed`, throws `AIServiceError` with code `PARSE_ERROR` if JSON object missing or schema validation fails.

**getInstallInstructions(): string** — Returns multiline string with npm install command `npm install -g @anthropic-ai/claude-code` and URL `https://code.claude.com`.

## JSON Schema Validation

**ClaudeResponseSchema** — Zod schema validated against Claude CLI v2.1.31 JSON output format, defines object with `type: z.literal('result')`, `subtype: z.enum(['success', 'error'])`, `is_error: z.boolean()`, `duration_ms: z.number()`, `duration_api_ms: z.number()`, `num_turns: z.number()`, `result: z.string()`, `session_id: z.string()`, `total_cost_usd: z.number()`, nested `usage` object containing `input_tokens`, `cache_creation_input_tokens`, `cache_read_input_tokens`, `output_tokens` as numbers, `modelUsage: z.record(z.object({...}))` mapping model names to usage statistics with `inputTokens`, `outputTokens`, `cacheReadInputTokens`, `cacheCreationInputTokens`, `costUSD` fields.

## CLI Argument Patterns

**Permission Mode** — `--permission-mode bypassPermissions` flag enables non-interactive execution by skipping permission prompts (documented in PITFALLS.md §8), required for subprocess operation without TTY.

**Session Persistence** — `--no-session-persistence` flag prevents writing session state to disk, appropriate for stateless documentation generation tasks.

**Output Format** — `--output-format json` flag triggers structured JSON output instead of conversational text, enabling machine parsing with schema validation.

## Integration Dependencies

Imports `AIBackend`, `AICallOptions`, `AIResponse` from `../types.js`, imports `AIServiceError` from `../types.js`, uses `runSubprocess()` from subprocess module (referenced in JSDoc but not imported here), follows backend adapter pattern where prompt goes to stdin and CLI arguments configure behavior.