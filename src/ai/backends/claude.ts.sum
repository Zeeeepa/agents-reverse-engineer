---
generated_at: 2026-02-09T16:08:55.207Z
content_hash: 9c98c917fde849284a46f0ed20bbef87a30caf8e94be8578b8d689ff92618f2d
purpose: ClaudeBackend implements AIBackend interface for Claude Code CLI (`claude`), handling CLI argument construction, JSON...
---
**ClaudeBackend implements AIBackend interface for Claude Code CLI (`claude`), handling CLI argument construction, JSON response parsing with Zod validation, PATH availability detection, and install instructions.**

## Exported Symbols

**ClaudeBackend** class implements `AIBackend` interface with properties:
- `name: 'claude'` — Backend identifier
- `cliCommand: 'claude'` — CLI executable name

Methods:
- `async isAvailable(): Promise<boolean>` — Delegates to `isCommandOnPath('claude')` for PATH detection
- `buildArgs(options: AICallOptions): string[]` — Constructs CLI arguments array for `claude` command
- `parseResponse(stdout: string, durationMs: number, exitCode: number): AIResponse` — Parses Claude CLI JSON output into normalized `AIResponse`
- `getInstallInstructions(): string` — Returns multiline string with npm install command and URL

**isCommandOnPath** function `async (command: string): Promise<boolean>` — Cross-platform PATH lookup checking if command exists as file in any PATH directory. Splits `process.env.PATH` by `path.delimiter`, iterates directories, checks `process.env.PATHEXT` extensions on Windows (`.exe`, `.cmd`, `.bat`), uses `fs.stat().isFile()` for detection (not `fs.access()` to avoid Unix permission assumptions).

**ClaudeResponseSchema** Zod schema validates Claude CLI v2.1.31 JSON output structure:
- Root: `{ type: 'result', subtype: 'success'|'error', is_error: boolean, duration_ms: number, duration_api_ms: number, num_turns: number, result: string, session_id: string, total_cost_usd: number, usage: {...}, modelUsage: {...} }`
- `usage` object: `{ input_tokens, cache_creation_input_tokens, cache_read_input_tokens, output_tokens }` (all numbers)
- `modelUsage` record: `Map<modelName, { inputTokens, outputTokens, cacheReadInputTokens, cacheCreationInputTokens, costUSD }>`

## CLI Argument Construction

`buildArgs()` returns fixed base arguments:
- `-p` — Non-interactive print mode
- `--output-format json` — Structured JSON output
- `--no-session-persistence` — Prevents disk session saves
- `--permission-mode bypassPermissions` — Skips interactive permission prompts (references PITFALLS.md §8)

Conditionally appends:
- `--model <value>` if `options.model` provided
- `--system-prompt <value>` if `options.systemPrompt` provided
- `--max-turns <value>` if `options.maxTurns !== undefined`

Prompt text excluded from args array — passed via stdin by `runSubprocess()` caller.

## JSON Response Parsing

`parseResponse()` implements defensive parsing:
1. Finds first `{` character via `stdout.indexOf('{')` to skip non-JSON prefix text (upgrade notices, warnings)
2. Throws `AIServiceError` with code `PARSE_ERROR` if no JSON object found
3. Parses substring `stdout.slice(jsonStart)` and validates against `ClaudeResponseSchema`
4. Extracts model name from `Object.keys(parsed.modelUsage)[0]` (first key is active model)
5. Maps to `AIResponse` structure:
   - `text` ← `parsed.result`
   - `model` ← first modelUsage key or `'unknown'`
   - `inputTokens` ← `parsed.usage.input_tokens`
   - `outputTokens` ← `parsed.usage.output_tokens`
   - `cacheReadTokens` ← `parsed.usage.cache_read_input_tokens`
   - `cacheCreationTokens` ← `parsed.usage.cache_creation_input_tokens`
   - `durationMs` ← function parameter (wall-clock time)
   - `exitCode` ← function parameter
   - `raw` ← entire `parsed` object

## Error Handling

Throws `AIServiceError` with discriminated codes:
- `PARSE_ERROR` when `stdout.indexOf('{')` returns `-1` (includes first 200 chars of raw output in message)
- `PARSE_ERROR` when `ClaudeResponseSchema.parse()` throws (includes Zod validation error message)

## Dependencies

- `node:fs/promises` — `fs.stat()` for PATH detection
- `node:path` — `path.join()`, `path.delimiter` for cross-platform path manipulation
- `zod` — `ClaudeResponseSchema` validation, `z.infer<>` type extraction
- `../types.js` — `AIBackend`, `AICallOptions`, `AIResponse`, `AIServiceError` imports

## Integration Pattern

Intended usage flow (documented in class example):
1. Instantiate `new ClaudeBackend()`
2. Call `await backend.isAvailable()` for availability check
3. Call `backend.buildArgs({ prompt, model?, systemPrompt?, maxTurns? })` to construct CLI args
4. Pass args to `runSubprocess('claude', args, { input: prompt, timeoutMs })` (from `../subprocess.ts`)
5. Call `backend.parseResponse(result.stdout, result.durationMs, result.exitCode)` to normalize response

## Platform-Specific Behavior

Windows PATH detection differences:
- Reads `process.env.PATHEXT` (typically `".COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC"`)
- Checks each extension appended to command name: `claude.exe`, `claude.cmd`, `claude.bat`, etc.
- Uses `fs.stat()` rather than Unix execute bit checking for cross-platform compatibility

Unix/Linux/macOS:
- `process.env.PATHEXT` unset → single iteration with bare command name
- Checks `claude` (no extension)

PATH string cleaning:
- Strips double quotes via `.replace(/["]+/g, '')` before splitting (handles Windows quoted paths)
- Splits by `path.delimiter` (`:` on Unix, `;` on Windows)
- Filters empty strings via `.filter(Boolean)`