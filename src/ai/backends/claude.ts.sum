---
generated_at: 2026-02-09T15:06:03.391Z
content_hash: 9c98c917fde849284a46f0ed20bbef87a30caf8e94be8578b8d689ff92618f2d
purpose: ClaudeBackend implements AIBackend interface for claude CLI, providing subprocess argument construction, JSON output ...
---
**ClaudeBackend implements AIBackend interface for claude CLI, providing subprocess argument construction, JSON output parsing with Zod validation, PATH availability detection, and installation instructions.**

## Exported Symbols

**ClaudeBackend** — Primary backend adapter class implementing AIBackend interface with properties:
- `name: 'claude'` — Backend identifier string
- `cliCommand: 'claude'` — Executable command name
- `isAvailable(): Promise<boolean>` — Delegates to isCommandOnPath('claude') for PATH detection
- `buildArgs(options: AICallOptions): string[]` — Constructs CLI arguments array including `-p`, `--output-format json`, `--no-session-persistence`, `--permission-mode bypassPermissions`, with optional `--model`, `--system-prompt`, `--max-turns` flags
- `parseResponse(stdout: string, durationMs: number, exitCode: number): AIResponse` — Parses JSON from stdout starting at first `{` character, validates against ClaudeResponseSchema, extracts model name from modelUsage keys, throws AIServiceError with code PARSE_ERROR on failure
- `getInstallInstructions(): string` — Returns formatted npm install command for @anthropic-ai/claude-code

**isCommandOnPath(command: string): Promise<boolean>` — Checks PATH environment variable for executable by iterating pathDirs split by path.delimiter, testing each extension from PATHEXT on Windows (empty array on Unix), using fs.stat() to verify file existence (not fs.access() for cross-platform compatibility)

## Schema Definition

**ClaudeResponseSchema** — Zod schema validated against Claude CLI v2.1.31 JSON output structure containing:
- `type: z.literal('result')`
- `subtype: z.enum(['success', 'error'])`
- `is_error: z.boolean()`
- `duration_ms: z.number()`
- `duration_api_ms: z.number()`
- `num_turns: z.number()`
- `result: z.string()` — Response text
- `session_id: z.string()`
- `total_cost_usd: z.number()`
- `usage` object with `input_tokens`, `cache_creation_input_tokens`, `cache_read_input_tokens`, `output_tokens`
- `modelUsage: z.record()` — Map of model name to token counts and costs

## Defensive Parsing

Handles non-JSON prefix text (upgrade notices) by locating first `{` via `stdout.indexOf('{')`, then slicing stdout before JSON.parse(). Throws AIServiceError(PARSE_ERROR) if jsonStart === -1 or schema validation fails, including first 200 characters of raw output in error message.

## CLI Argument Construction

buildArgs() does NOT include prompt in args array — prompt passed via stdin through runSubprocess wrapper. Permission mode set to bypassPermissions to avoid interactive permission prompts during non-interactive execution (addresses PITFALLS.md §8). Session persistence disabled to prevent disk writes.

## Model Name Extraction

parseResponse() extracts model name from parsed.modelUsage object keys using `Object.keys(parsed.modelUsage)[0] ?? 'unknown'` pattern, assuming first key represents model used for invocation.

## Integration Points

Depends on:
- `AIBackend`, `AICallOptions`, `AIResponse`, `AIServiceError` from `../types.js`
- `zod` for ClaudeResponseSchema validation
- `node:fs/promises` and `node:path` for PATH detection
- runSubprocess() wrapper expected to inject prompt via stdin and respect args array

## Platform Compatibility

isCommandOnPath() handles Windows PATHEXT (semicolon-delimited extensions like `.EXE;.CMD;.BAT`) versus Unix empty extensions array. Uses fs.stat() instead of fs.access() because Windows lacks Unix execute permission bits.