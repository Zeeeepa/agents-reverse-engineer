<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/ai/backends

The backends directory contains multiple AIBackend implementations that adapt different CLI tools (Claude, Codex, Gemini, OpenCode) to a unified interface for AIResponse parsing and argument construction.

## Contents

### Backend Implementations

[claude.ts](./claude.ts) — Implements `ClaudeBackend` with response parsing for legacy JSON and NDJSON formats, token extraction from `modelUsage` map, and PATH detection via `isCommandOnPath()`; supports `--model`, `--system-prompt`, `--max-turns` options and requires `--allowedTools Read Write` for root execution.

[codex.ts](./codex.ts) — Implements `CodexBackend` with polymorphic JSONL event stream parsing, text extraction from `agent_message` items with fallback to recursive `collectText()`, token normalization across field naming variants, and usage aggregation across turns.

[gemini.ts](./gemini.ts) — Implements `GeminiBackend` as a stub that throws `AIServiceError('SUBPROCESS_ERROR')` from `parseResponse()`, deferring full implementation until Gemini CLI JSON output stabilizes; imports `isCommandOnPath()` from `claude.ts`.

[opencode.ts](./opencode.ts) — Implements `OpenCodeBackend` with NDJSON streaming parsing, cost calculation from tokens using Anthropic Claude Sonnet pricing constants, model alias mapping for short names, agent config injection via `.opencode/agents/are-summarizer.md`, and handling of "MAXIMUM STEPS REACHED" markers.

## Response Parsing Architecture

Each backend parses distinct CLI output formats into a unified `AIResponse` type:

- **Claude**: `ClaudeResponseSchema` (Zod) validates JSON object with `type: 'result'`, `subtype`, `is_error`, token counts in `usage` and `modelUsage` map (first key = model name), cost in `total_cost_usd`.
- **Codex**: Multi-stage JSONL fallback chain—preferred path extracts `agent_message` items via `extractAssistantTextFromItem()`; fallback recursively collects text with `shouldSkipTextObject()` filter for reasoning fields; final fallback returns raw stdout.
- **OpenCode**: NDJSON schema validation via `OpenCodeStepFinishSchema` and `OpenCodeTextSchema`; aggregates token counts across `step_finish` events, calculates cost via `calculateCostFromTokens()` if unprovided, concatenates text chunks from `text` events.

## Cost & Token Handling

**Claude**: extracts `input_tokens`, `output_tokens`, `cache_read_tokens`, `cache_creation_tokens` from `usage` object and `total_cost_usd`.

**Codex**: normalizes field names (`inputTokens`, `input_tokens`, `cached_input_tokens`, etc.) and isolates non-cached input by subtracting `cacheRead` from raw input; returns `{ inputTokens, outputTokens, cacheReadTokens, cacheCreationTokens }`.

**OpenCode**: pricing constants `INPUT_COST_PER_MTOK = 15`, `OUTPUT_COST_PER_MTOK = 75`, `CACHE_WRITE_COST_PER_MTOK = 18.75`, `CACHE_READ_COST_PER_MTOK = 1.50` (USD per million tokens) used by `calculateCostFromTokens()` when OpenCode provides zero cost.

## CLI Argument Construction

- **Claude**: `buildArgs()` → `['-p', '--output-format', 'json', '--no-session-persistence', '--allowedTools', 'Read', 'Write']` plus `--model`, `--system-prompt`, `--max-turns` if present.
- **Codex**: `buildArgs()` → `['-a', 'never', 'exec', '--json', '--skip-git-repo-check', '--ephemeral', '--color', 'never']` plus optional `--model` and stdin flag `'-'`.
- **OpenCode**: `buildArgs()` → `['run', '--format', 'json', '--agent', 'are-summarizer']` plus resolved model via `MODEL_ALIASES` (e.g., `'sonnet'` → `'anthropic/claude-sonnet-4-5'`).

## OpenCode Agent Configuration

`OPENCODE_AGENT_NAME = 'are-summarizer'` and `OPENCODE_AGENT_CONTENT` markdown disables all tools (`tools: {"*": false}`) and enforces single-turn execution with `steps: 5`. `ensureProjectConfig(projectRoot)` writes agent file to `.opencode/agents/are-summarizer.md` with parent directory creation; `composeStdinInput()` wraps system prompt in `<system-instructions>` XML tags for agent to follow exactly without output preamble.

## Error Handling

All backends throw `AIServiceError`:
- **Claude**: `PARSE_ERROR` if result JSON missing or schema validation fails (first 200 chars logged).
- **Codex**: `PARSE_ERROR` if all extraction paths fail (malformed JSON, no text found).
- **Gemini**: `SUBPROCESS_ERROR` unconditionally from `parseResponse()`.
- **OpenCode**: `PARSE_ERROR` if no text found or "MAXIMUM STEPS REACHED" marker leaves <100 chars content; throws on malformed NDJSON without validation.

## Behavioral Contracts

Claude's `isCommandOnPath()` detects executables cross-platform via `fs.stat()` instead of execute-bit checks; accounts for Windows `PATHEXT` extensions.

Codex's `extractUsageFromTurnCompleted()` deduplicates polymorphic token field names and normalizes cache terminology (`cached_input_tokens` → `cacheReadTokens`, etc.).

OpenCode filters NDJSON events by type: `step_finish`, `text` are processed; `step_start`, `tool_use`, `tool_result`, `error` are skipped.