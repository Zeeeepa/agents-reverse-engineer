<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/ai/backends
The `src/ai/backends` directory defines `AIBackend` implementations for various AI command-line interfaces (CLIs), acting as adapters to integrate external AI tools like Claude, Codex, Gemini, and OpenCode into the system by managing argument construction, subprocess output parsing, and error handling.

## Contents
*   [claude.ts](./claude.ts): Provides `ClaudeBackend` as an `AIBackend` adapter for the `claude` CLI.
*   [codex.ts](./codex.ts): Implements `CodexBackend` for the `codex` CLI, parsing JSONL events.
*   [common.ts](./common.ts): Offers `isCommandOnPath` for checking CLI availability on the system PATH.
*   [gemini.ts](./gemini.ts): Implements `GeminiBackend` for the `gemini` CLI, handling response parsing and token metric extraction.
*   [opencode.ts](./opencode.ts): Provides `OpenCodeBackend` for the `opencode` CLI, handling NDJSON stream parsing and token aggregation.

## Public Interface

### Classes
*   `class ClaudeBackend implements AIBackend`: Adapts the `claude` CLI, exporting `name: 'claude'`, `cliCommand: 'claude'`, `isAvailable()`, `buildArgs()`, `parseResponse()`, and `getInstallInstructions()`.
*   `class CodexBackend`: Implements `AIBackend` for the `codex` CLI, providing `name: 'codex'`, `cliCommand: 'codex'`, `isAvailable()`, `buildArgs()`, `composeStdinInput()`, `parseResponse()`, and `getInstallInstructions()`.
*   `class GeminiBackend`: Implements `AIBackend` for the `gemini` CLI, exposing `name: 'gemini'`, `cliCommand: 'gemini'`, `isAvailable()`, `buildArgs()`, `composeStdinInput()`, `parseResponse()`, and `getInstallInstructions()`.
*   `class OpenCodeBackend implements AIBackend`: Adapts the `opencode` CLI, with `name: 'opencode'`, `cliCommand: 'opencode'`, `isAvailable()`, `buildArgs()`, `composeStdinInput()`, `ensureProjectConfig()`, `parseResponse()`, and `getInstallInstructions()`.

### Functions
*   `isCommandOnPath(command: string): Promise<boolean>`: Checks for `command` presence on `process.env.PATH` across platforms.

### Interfaces
*   `interface CodexUsageTotals`: Defines `inputTokens`, `outputTokens`, `cacheReadTokens`, and `cacheCreationTokens` for token usage.
*   `interface ParsedOpenCodeOutput`: Aggregates `text`, `numTurns`, `inputTokens`, `outputTokens`, `reasoningTokens`, `cacheReadTokens`, `cacheWriteTokens`, `totalCost`, and `events` from NDJSON parsing.

## Data Structures & Validation

*   `ClaudeResponseSchema`: A `z.object` schema defining `type: 'result'`, `subtype`, `is_error`, `duration_ms`, `result`, `session_id`, `total_cost_usd`, `usage`, and `modelUsage` for Claude CLI output.
*   `GeminiModelTokensSchema`: `zod` schema validating objects with optional `prompt`, `response`, `total` token counts.
*   `GeminiStatsSchema`: `zod` schema validating `session` duration and `models` mapping to `GeminiModelTokensSchema`.
*   `GeminiResponseSchema`: `zod` schema validating top-level Gemini CLI responses, including optional `response`, `stats`, and `error`.
*   `OpenCodeTokensSchema`: `z.ZodObject` validating `step_finish` event token breakdown including `total`, `input`, `output`, `reasoning`, and `cache`.
*   `OpenCodeStepFinishPartSchema`: `z.ZodObject` validating the `part` of `step_finish` events with `type: "step-finish"`, `cost`, and `tokens`.
*   `OpenCodeStepFinishSchema`: `z.ZodObject` validating `step_finish` NDJSON lines, including `type: "step_finish"` and `part`.
*   `OpenCodeTextPartSchema`: `z.ZodObject` validating the `part` of `text` events with `type: "text"` and `text`.
*   `OpenCodeTextSchema`: `z.ZodObject` validating `text` NDJSON lines, including `type: "text"` and `part`.

## Key Algorithms

*   `extractResultJson(stdout: string): string | undefined`: In `claude.ts`, attempts to find the "result" JSON string in `stdout` from various formats.
*   `composePromptWithSystem(options: AICallOptions): string`: In `codex.ts`, wraps `options.systemPrompt` and `options.prompt` into `<system-instructions>` tags for stdin.
*   `collectText(value: unknown, out: string[], shouldSkipObject?: (obj: Record<string, unknown>) => boolean): void`: In `codex.ts`, recursively collects `text` fields from `value`.
*   `shouldSkipTextObject(obj: Record<string, unknown>): boolean`: In `codex.ts`, determines if an object (`type: 'reasoning'` or `'.reasoning'`) should be skipped during text collection.
*   `extractAssistantTextFromItem(item: unknown): string[]`: In `codex.ts`, extracts assistant text from `item.completed` payloads, prioritizing `type: 'agent_message'`.
*   `extractUsageFromTurnCompleted(usage: unknown): CodexUsageTotals`: In `codex.ts`, parses token usage from `turn.completed` events, normalizing keys.
*   `calculateCostFromTokens(inputTokens: number, outputTokens: number, cacheReadTokens: number, cacheWriteTokens: number): number`: In `opencode.ts`, computes total cost using defined per-million-token costs.
*   `parseNdjson(stdout: string): ParsedOpenCodeOutput`: In `opencode.ts`, processes `stdout` line-by-line to parse NDJSON events and aggregate metrics.

## Behavioral Contracts

### Claude CLI
*   **CLI Arguments**: `buildArgs` always includes `-p`, `--output-format json`, `--no-session-persistence`, and `--allowedTools Read Write`.
*   **Error Handling**: `parseResponse` throws `AIServiceError` with `'PARSE_ERROR'` for missing JSON (`No JSON result object found in Claude CLI output...`) or schema validation failures (`Failed to parse Claude CLI JSON response: ${message}`).
*   **Installation**: `getInstallInstructions` provides `'npm install -g @anthropic-ai/claude-code'`.

### Codex CLI
*   **System Prompt Formatting**: `composeStdinInput` formats `options.systemPrompt` within `<system-instructions>\n{systemPrompt}\n</system-instructions>\n\n{prompt}`.
*   **CLI Arguments**: `codex` is executed with `'-a', 'never'`, `'exec'`, `'--json'`, `'--skip-git-repo-check'`, `'--ephemeral'`, `'--color', 'never'`, and `'-'`.
*   **JSONL Event Types**: Recognizes `type: 'item.completed'` for text and `type: 'turn.completed'` for usage, ignoring `type: 'error'`, `type: 'thread.started'`, `type: 'turn.started'`, and types ending in `'.error'` or `'.failed'`.
*   **Token Usage Keys**: `extractUsageFromTurnCompleted` handles `input_tokens`, `inputTokens`, `cached_input_tokens`, `cache_read_input_tokens`, `cacheReadInputTokens`, `cache_creation_input_tokens`, `cacheCreationInputTokens`, `output_tokens`, `outputTokens`.
*   **Error Strings**: Throws `AIServiceError` with `'PARSE_ERROR'` and messages such as `'Empty Codex CLI output'` or `'Failed to extract assistant text from Codex CLI output'`.

### Gemini CLI
*   **Model Aliases**: `MODEL_ALIASES` maps `'sonnet'`, `'opus'`, `'haiku'`, `'flash'`, `'pro'` to full model identifiers (`'gemini-3-flash-preview'`, `'gemini-3-pro-preview'`, `'gemini-2.5-flash'`). `resolveModelForGemini` uses this mapping.
*   **System Prompts**: System prompts are injected via XML tags: `<system-instructions>\n${options.systemPrompt}\n</system-instructions>\n\n${prompt}`.
*   **CLI Arguments**: Expects `-p <prompt>` and `--output-format json`.
*   **Error Categories**: Errors are `'PARSE_ERROR'` (e.g., no JSON, empty response, schema mismatch) or `'SUBPROCESS_ERROR'` (model-reported errors).
*   **JSON Extraction**: `extractJson` locates JSON by searching for `{` to skip stdout prefix.
*   **Metric Extraction**: `extractMetrics` defaults `inputTokens`, `outputTokens` to `0` and `model` to `'unknown'` if stats are absent.
*   **Installation**: `getInstallInstructions` provides `npm install -g @google-gemini/gemini-cli`.

### OpenCode CLI
*   **Cost Constants**: `INPUT_COST_PER_MTOK` is `15`, `OUTPUT_COST_PER_MTOK` is `75`, `CACHE_WRITE_COST_PER_MTOK` is `18.75`, `CACHE_READ_COST_PER_MTOK` is `1.50`.
*   **Model Aliases**: `MODEL_ALIASES` maps `sonnet`, `opus`, `haiku` to OpenCode's `provider/model` format (e.g., `anthropic/claude-sonnet-4-5`). `resolveModelForOpenCode` translates these aliases.
*   **Agent Name**: `OPENCODE_AGENT_NAME` is `'are-summarizer'`.
*   **Step Limit Message**: `parseResponse` detects `MAXIMUM STEPS REACHED` to strip meta-commentary.
*   **Error Handling**: `AIServiceError` with `PARSE_ERROR` indicates issues like missing text content.
*   **System Prompts**: XML tags `<system-instructions>` are used in `composeStdinInput` for system prompts.
*   **Installation**: `getInstallInstructions` returns installation instructions for the `opencode` CLI.

## AI Agent Behavioral Instructions

*   `OPENCODE_AGENT_CONTENT`: In `opencode.ts`, defines an OpenCode agent configuration (`description`, `steps: 5`, `tools: { "*": false }`) and instructions for documentation generation by the model, emphasizing raw content output, no meta-commentary, and strict adherence to `<system-instructions>` tags.

## Integration Points

*   `../types.js`: `AIBackend`, `AICallOptions`, `AIResponse`, `AIServiceError` are imported by `claude.ts`, `codex.ts`, `gemini.ts`, and `opencode.ts`.
*   `./common.js`: `isCommandOnPath` is used by `claude.ts`, `codex.ts`, `gemini.ts`, and `opencode.ts`.
*   `node:fs/promises`: `writeFile`, `mkdir` are used by `ensureProjectConfig` in `opencode.ts`.
*   `node:path`: Used by `ensureProjectConfig` in `opencode.ts` for path manipulation.
*   `zod`: Used for schema validation in `gemini.ts` and `opencode.ts`.
*   External CLIs: Interaction with `claude`, `codex`, `gemini`, and `opencode` command-line tools is a core integration point for these backends.

## Annex References
*   Full `OPENCODE_AGENT_CONTENT` for `.opencode/agents/are-summarizer.md` agent file.