<!-- Generated by agents-reverse-engineer -->

# src/ai/backends

Backend adapters for AI CLI tools, implementing the `AIBackend` interface to provide CLI detection, argument construction, and response parsing. Currently supports Claude Code (fully implemented), with Gemini and OpenCode as stubs awaiting JSON output format stabilization.

## Contents

### [claude.ts](./claude.ts)
`ClaudeBackend` fully implements `AIBackend` for the `claude` CLI. Exports `isCommandOnPath()` for PATH detection (splits `process.env.PATH`, checks `fs.stat()`, handles Windows `PATHEXT` extensions). `buildArgs()` constructs `['-p', '--output-format', 'json', '--no-session-persistence', '--allowedTools', 'Read', 'Write']` plus optional `--model`, `--system-prompt`, `--max-turns`. `parseResponse()` handles three output formats (JSON array ≥2.1.38, NDJSON, legacy single object ≤2.1.31) via `extractResultJson()`, validates with `ClaudeResponseSchema` (Zod), normalizes to `AIResponse`.

### [gemini.ts](./gemini.ts)
`GeminiBackend` stub for future Google Gemini CLI. `isAvailable()` delegates to `isCommandOnPath()`, `buildArgs()` returns `['-p', '--output-format', 'json']`, but `parseResponse()` throws `AIServiceError` with code `'SUBPROCESS_ERROR'` and message `'Gemini backend is not yet implemented. Use Claude backend.'` until JSON output stabilizes (see RESEARCH.md Open Question 2).

### [opencode.ts](./opencode.ts)
`OpenCodeBackend` stub for OpenCode CLI. `isAvailable()` checks PATH via `isCommandOnPath()`, `buildArgs()` returns `['run', '--format', 'json']`, `parseResponse()` throws `AIServiceError` with code `'SUBPROCESS_ERROR'` and message `'OpenCode backend is not yet implemented. Use Claude backend.'` pending JSONL parsing implementation (RESEARCH.md Open Question 3).

## Architecture

All backends implement the `AIBackend` interface from `../types.js` with four methods: `isAvailable()` (async PATH check), `buildArgs()` (CLI argument construction), `parseResponse()` (stdout → `AIResponse` normalization), `getInstallInstructions()` (user-facing setup text). Registered in `src/ai/registry.ts` for runtime selection. `ClaudeBackend` serves as reference implementation, Gemini/OpenCode follow the extension pattern but defer response parsing until upstream CLI tools stabilize JSON output contracts.

## Behavioral Contracts

**ClaudeResponseSchema** (Zod):
```typescript
z.object({
  type: z.literal('result'),
  subtype: z.enum(['success', 'error']),
  is_error: z.boolean(),
  duration_ms: z.number(),
  duration_api_ms: z.number(),
  num_turns: z.number(),
  result: z.string(),
  session_id: z.string(),
  total_cost_usd: z.number(),
  usage: z.object({
    input_tokens: z.number(),
    cache_creation_input_tokens: z.number(),
    cache_read_input_tokens: z.number(),
    output_tokens: z.number(),
  }).passthrough(),
  modelUsage: z.record(z.object({
    inputTokens: z.number(),
    outputTokens: z.number(),
    cacheReadInputTokens: z.number(),
    cacheCreationInputTokens: z.number(),
    costUSD: z.number(),
  }).passthrough()),
}).passthrough()
```

**Claude CLI arguments**: `['-p', '--output-format', 'json', '--no-session-persistence', '--allowedTools', 'Read', 'Write']` (fixed), prompt via stdin, optional `--model`, `--system-prompt`, `--max-turns`.

**Gemini CLI arguments**: `['-p', '--output-format', 'json']`.

**OpenCode CLI arguments**: `['run', '--format', 'json']`.

**Error messages**:
- Gemini: `'Gemini backend is not yet implemented. Use Claude backend.'`
- OpenCode: `'OpenCode backend is not yet implemented. Use Claude backend.'`

## File Relationships

`ClaudeBackend.parseResponse()` calls private `extractResultJson()` to handle multiple output formats before Zod validation. `GeminiBackend` and `OpenCodeBackend` import `isCommandOnPath()` from `claude.ts` for PATH detection. All three backends throw `AIServiceError` with code `'PARSE_ERROR'` (Claude) or `'SUBPROCESS_ERROR'` (Gemini/OpenCode) on failures. Consumed by `AIService` in `src/ai/service.ts` via registry pattern (`src/ai/registry.ts`). Arguments from `buildArgs()` passed to `runSubprocess()` wrapper (`src/ai/subprocess.ts`) which manages stdin, timeouts, process lifecycle.