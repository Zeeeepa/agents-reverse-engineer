<!-- Generated by agents-reverse-engineer -->

# src/ai/backends

Concrete AIBackend implementations for Claude Code, Gemini CLI, and OpenCode CLI providing subprocess argument construction, JSON response parsing, PATH availability detection, and installation instructions.

## Contents

### Backend Implementations

**[claude.ts](./claude.ts)** — ClaudeBackend adapter implementing subprocess orchestration for `claude` CLI with `buildArgs()` constructing `['-p', '--output-format', 'json', '--no-session-persistence', '--permission-mode', 'bypassPermissions']` arguments, `parseResponse()` validating JSON via ClaudeResponseSchema (Zod), extracting model names from `modelUsage` object keys, handling non-JSON prefix text via `stdout.indexOf('{')` slicing, and `isCommandOnPath()` detecting CLI availability by iterating `process.env.PATH` directories with platform-specific PATHEXT handling.

**[gemini.ts](./gemini.ts)** — GeminiBackend stub adapter with functional `isAvailable()` delegating to `isCommandOnPath()`, `buildArgs()` returning `['-p', '--output-format', 'json']`, but `parseResponse()` throwing AIServiceError with code 'SUBPROCESS_ERROR' pending Gemini CLI JSON output format stabilization (deferred per RESEARCH.md Open Question 2).

**[opencode.ts](./opencode.ts)** — OpenCodeBackend stub adapter with functional `isAvailable()` via `isCommandOnPath()`, `buildArgs()` returning `['run', '--format', 'json']`, but `parseResponse()` throwing AIServiceError with code 'SUBPROCESS_ERROR' pending JSONL output parsing implementation (deferred per RESEARCH.md Open Question 3).

## AIBackend Interface Contract

All backend classes implement `AIBackend` from `../types.ts` requiring:
- `name: string` — Backend identifier ('claude' | 'gemini' | 'opencode')
- `cliCommand: string` — Executable name for PATH resolution
- `isAvailable(): Promise<boolean>` — CLI detection via PATH scanning
- `buildArgs(options: AICallOptions): string[]` — Subprocess argument array construction (prompt sent via stdin)
- `parseResponse(stdout: string, durationMs: number, exitCode: number): AIResponse` — JSON parsing with token/cost extraction
- `getInstallInstructions(): string` — Formatted installation command string

## Backend Registry Integration

Registered via `AIBackendRegistry` in `../registry.ts` enabling auto-detection when `config.ai.backend === 'auto'`. Registry calls `isAvailable()` sequentially across backends [ClaudeBackend, GeminiBackend, OpenCodeBackend] returning first available, falling back to ClaudeBackend if none detected.

## PATH Detection Pattern

`isCommandOnPath(command: string)` shared utility in `claude.ts`:
1. Split `process.env.PATH` by `path.delimiter` (`:` on Unix, `;` on Windows)
2. Iterate directories with platform-specific extensions (Windows: `process.env.PATHEXT.split(';')`, Unix: `['']`)
3. Test each `pathDir + command + ext` via `fs.stat()` (not `fs.access()` due to Windows lacking execute permission bits)
4. Return true if any path exists, false otherwise

## ClaudeBackend Parsing Strategy

`parseResponse()` defensively handles non-JSON CLI output:
1. Locate first `{` via `stdout.indexOf('{')`
2. Slice `stdout.substring(jsonStart)` before `JSON.parse()`
3. Validate against ClaudeResponseSchema containing `type`, `subtype`, `is_error`, `result`, `usage`, `modelUsage`, `total_cost_usd`
4. Extract model name from `Object.keys(parsed.modelUsage)[0] ?? 'unknown'`
5. Map to AIResponse with `result: parsed.result`, `usage: { inputTokens, cacheReadTokens, cacheCreationTokens, outputTokens }`, `model: modelName`, `cost: { totalUSD: parsed.total_cost_usd }`
6. Throw AIServiceError('PARSE_ERROR') on schema validation failure, including first 200 characters of raw output

## Subprocess Orchestration

Backends depend on `runSubprocess()` from `../subprocess.ts` which:
- Spawns `execFile(cliCommand, args)` child process
- Injects prompt via `stdin.write()` followed by `stdin.end()`
- Enforces resource limits: `NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`
- Implements timeout handling: SIGTERM at `timeoutMs`, SIGKILL after 5s grace period
- Performs process group killing via `kill(-pid)` to terminate subprocess trees
- Passes captured `stdout` to backend's `parseResponse()`

## Implementation Status

| Backend | isAvailable | buildArgs | parseResponse | Status |
|---------|-------------|-----------|---------------|--------|
| ClaudeBackend | ✓ PATH detection | ✓ Full args | ✓ Schema validation | **Production** |
| GeminiBackend | ✓ PATH detection | ✓ Basic args | ✗ Throws error | **Stub** (pending JSON stability) |
| OpenCodeBackend | ✓ PATH detection | ✓ Basic args | ✗ Throws error | **Stub** (pending JSONL parsing) |