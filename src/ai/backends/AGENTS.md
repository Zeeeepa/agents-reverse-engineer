<!-- Generated by agents-reverse-engineer -->

# src/ai/backends

AI backend implementations exposing Claude, Gemini, and OpenCode CLI integrations through a common `AIBackend` interface for multi-provider LLM orchestration.

## Contents

### Backend Implementations

- **[claude.ts](./claude.ts)** — `ClaudeBackend` implements full response parsing with `ClaudeResponseSchema` Zod validation, `extractResultJson()` handling JSON array/NDJSON/legacy formats, `buildArgs()` emitting `['-p', '--output-format', 'json', '--no-session-persistence', '--allowedTools', 'Read', 'Write']`, `isCommandOnPath()` PATH detection across Windows/Unix, and `getInstallInstructions()` returning npm install command for `@anthropic-ai/claude-code`.

- **[gemini.ts](./gemini.ts)** — `GeminiBackend` stub demonstrating extensibility with `buildArgs()` returning `['-p', '--output-format', 'json']`, `isAvailable()` delegating to `isCommandOnPath()` from claude.ts, and `parseResponse()` throwing `AIServiceError` until Gemini CLI output stabilizes per RESEARCH.md.

- **[opencode.ts](./opencode.ts)** — `OpenCodeBackend` stub providing `buildArgs()` returning `['run', '--format', 'json']`, `isAvailable()` via shared `isCommandOnPath()`, `getInstallInstructions()` referencing https://opencode.ai, and `parseResponse()` throwing `AIServiceError` pending JSONL parsing implementation.

## Architecture

### Interface Contract

All backends implement `AIBackend` from `../types.js` with four methods: `isAvailable()` detecting CLI presence on PATH, `buildArgs(options: AICallOptions)` constructing CLI arguments, `parseResponse(stdout, durationMs, exitCode)` returning normalized `AIResponse` with token counts and cost, and `getInstallInstructions()` providing user-facing setup guidance.

### Response Parsing Strategy

`ClaudeBackend.parseResponse()` extracts result JSON via three-path logic: JSON array with result element, NDJSON with `type: "result"` line, or legacy single object. `ClaudeResponseSchema` validates `{type, subtype, result, usage, modelUsage, total_cost_usd}` structure with `.passthrough()` for forward compatibility. Model name extracted from first `modelUsage` key, token counts normalized to `AIResponse.usage` fields.

### CLI Argument Construction

Backends emit base args arrays consumed by `runSubprocess()` in `../subprocess.ts`. `ClaudeBackend.buildArgs()` pre-approves Read/Write tools via `--allowedTools` to bypass root permission blocking, appends `--model`, `--system-prompt`, `--max-turns` from `AICallOptions`. Prompt text sent to stdin, never in args array.

### PATH Detection

`isCommandOnPath(command)` in claude.ts splits `process.env.PATH` by `path.delimiter`, iterates directories checking for `command` with `PATHEXT` extensions (Windows) or bare name (Unix), verifies via `fs.stat()`. Shared by all three backends through import reuse.

## Behavioral Contracts

### ClaudeResponseSchema Structure

```typescript
{
  type: "result",
  subtype: "success" | "error",
  is_error: boolean,
  duration_ms: number,
  duration_api_ms: number,
  num_turns: number,
  result: string,
  session_id: string,
  total_cost_usd: number,
  usage: {
    input_tokens: number,
    cache_creation_input_tokens: number,
    cache_read_input_tokens: number,
    output_tokens: number
  },
  modelUsage: {
    [model: string]: {
      inputTokens: number,
      outputTokens: number,
      cacheReadInputTokens: number,
      cacheCreationInputTokens: number,
      costUSD: number
    }
  }
}
```

### CLI Base Arguments

- **Claude**: `['-p', '--output-format', 'json', '--no-session-persistence', '--allowedTools', 'Read', 'Write']`
- **Gemini**: `['-p', '--output-format', 'json']`
- **OpenCode**: `['run', '--format', 'json']`

### Error Code Surface

`AIServiceError` with code `'PARSE_ERROR'` thrown on JSON extraction failure or schema validation failure, `'SUBPROCESS_ERROR'` thrown by unimplemented backends.

## File Relationships

`GeminiBackend` and `OpenCodeBackend` import `isCommandOnPath()` from claude.ts for shared PATH detection logic. All backends import `AIBackend`, `AICallOptions`, `AIResponse`, `AIServiceError` from `../types.js`. `ClaudeBackend.parseResponse()` calls `extractResultJson()` internal function before schema validation. Backend registry in `../registry.ts` instantiates and exports singleton instances consumed by `AIService` in `../service.ts`.