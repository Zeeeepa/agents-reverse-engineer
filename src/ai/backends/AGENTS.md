<!-- Generated by agents-reverse-engineer -->

# src/ai/backends

Backend adapters implementing AIBackend interface for three AI CLI tools: ClaudeBackend with full JSON parsing via Zod schema validation, GeminiBackend/OpenCodeBackend as stub implementations throwing AIServiceError until stable output formats arrive.

## Contents

**[claude.ts](./claude.ts)** — ClaudeBackend with isCommandOnPath() PATH detection splitting process.env.PATH by platform delimiter, buildArgs() constructing ['--output-format', 'json', '--no-session-persistence', '--permission-mode', 'bypassPermissions'] with optional --model/--system-prompt/--max-turns, parseResponse() slicing stdout from first '{' character to strip upgrade notices then validating against ClaudeResponseSchema extracting usage.input_tokens/output_tokens/cache_read_input_tokens/cache_creation_input_tokens and model name from modelUsage object keys, getInstallInstructions() returning npm command for @anthropic-ai/claude-code.

**[gemini.ts](./gemini.ts)** — GeminiBackend stub with isAvailable() delegating to isCommandOnPath('gemini'), buildArgs() returning ['-p', '--output-format', 'json'], parseResponse() unconditionally throwing AIServiceError with code SUBPROCESS_ERROR and message 'not yet implemented', getInstallInstructions() returning npm command for @anthropic-ai/gemini-cli with GitHub URL (implementation deferred per RESEARCH.md Open Question 2 pending stable JSON format).

**[opencode.ts](./opencode.ts)** — OpenCodeBackend stub with isAvailable() delegating to isCommandOnPath('opencode'), buildArgs() returning ['run', '--format', 'json'], parseResponse() unconditionally throwing AIServiceError with code SUBPROCESS_ERROR and message 'not yet implemented', getInstallInstructions() returning curl install command for https://opencode.ai (implementation deferred per RESEARCH.md Open Question 3 pending JSONL parsing).

## Architecture

**Backend Adapter Contract**

AIBackend interface defines five methods: isAvailable() checking CLI binary presence on PATH, buildArgs(options) constructing subprocess argument arrays with prompt delivered via stdin, parseResponse(stdout, durationMs, exitCode) extracting AIResponse with normalized token counts, getInstallInstructions() returning user-facing setup guidance, name/cliCommand properties identifying backend.

**PATH Detection Strategy**

isCommandOnPath() splits process.env.PATH by path.delimiter (';' on Windows, ':' elsewhere), iterates directories calling fs.stat() on potential executable paths, on Windows iterates process.env.PATHEXT extensions ['.exe', '.cmd', '.bat', '.com'] to match platform conventions, returns true on first match. Function exported from claude.ts and reused by gemini.ts/opencode.ts for cross-backend consistency.

**CLI Argument Patterns**

All backends use stdin for prompt delivery (not CLI arguments) to avoid shell escaping issues. ClaudeBackend appends --model/--system-prompt/--max-turns conditionally via buildArgs() inspecting AICallOptions properties. --permission-mode bypassPermissions enables non-interactive subprocess execution per PITFALLS.md §8. --no-session-persistence prevents state file writes.

**JSON Response Parsing**

ClaudeBackend.parseResponse() handles stdout prefix content (upgrade notices, warnings) by finding first '{' via indexOf() before JSON.parse(). ClaudeResponseSchema validates against v2.1.31 output format with type: 'result', usage object containing input_tokens/cache_creation_input_tokens/cache_read_input_tokens/output_tokens, modelUsage record mapping model names to detailed statistics. Throws AIServiceError with code PARSE_ERROR on validation failure or missing JSON.

**Stub Backend Pattern**

GeminiBackend and OpenCodeBackend implement full interface surface but throw AIServiceError from parseResponse() to prevent runtime usage until output format research completes. Enables backend registration in src/ai/registry.ts and auto-detection via detectFirstAvailableBackend() while blocking production execution.

## Integration Dependencies

Imports AIBackend/AICallOptions/AIResponse/AIServiceError from ../types.js. ClaudeBackend requires zod for ClaudeResponseSchema validation. Consumed by AIService in src/ai/service.ts via BackendRegistry.getBackend(name) lookup. Backend selection happens via config.ai.backend or auto-detection iterating ['claude', 'gemini', 'opencode'] until isAvailable() returns true.

## Behavioral Contracts

**ClaudeBackend Argument Construction**
```javascript
['-p', '--output-format', 'json', '--no-session-persistence', '--permission-mode', 'bypassPermissions']
// Appends conditionally:
['--model', options.model] if options.model present
['--system-prompt', options.systemPrompt] if options.systemPrompt present
['--max-turns', String(options.maxTurns)] if options.maxTurns defined
```

**ClaudeResponseSchema Token Fields**
```typescript
usage: z.object({
  input_tokens: z.number(),
  cache_creation_input_tokens: z.number(),
  cache_read_input_tokens: z.number(),
  output_tokens: z.number()
})
```

**GeminiBackend Arguments** — `['-p', '--output-format', 'json']`

**OpenCodeBackend Arguments** — `['run', '--format', 'json']`

**Stub Error Message Pattern** — `'<Backend> backend is not yet implemented. Use Claude backend.'` with AIServiceError code `'SUBPROCESS_ERROR'`