<!-- Generated by agents-reverse-engineer -->

# src/ai/backends

AIBackend concrete implementations for the three supported CLI runtimes (`claude`, `gemini`, `opencode`), providing PATH detection, argument construction, and response parsing with varying implementation completeness.

## Contents

**[claude.ts](./claude.ts)** — `ClaudeBackend` implements full AIBackend contract: `isAvailable()` detects `claude` via `isCommandOnPath()`, `buildArgs()` emits `['-p', '--output-format', 'json', '--no-session-persistence', '--allowedTools', 'Read', 'Write']` with optional `--model`/`--system-prompt`/`--max-turns`, `parseResponse()` validates JSON/NDJSON via `ClaudeResponseSchema` and extracts tokens/cost/model from `modelUsage`, `getInstallInstructions()` returns npm command. Exports `isCommandOnPath()` utility for shared PATH detection.

**[gemini.ts](./gemini.ts)** — `GeminiBackend` provides partial implementation: `buildArgs()` returns `['-p', '--output-format', 'json']`, `isAvailable()` reuses `isCommandOnPath()` from `claude.js`, `parseResponse()` throws `AIServiceError` code `SUBPROCESS_ERROR` pending Gemini CLI JSON output stabilization per RESEARCH.md.

**[opencode.ts](./opencode.ts)** — `OpenCodeBackend` stub mirrors GeminiBackend pattern: `buildArgs()` returns `['run', '--format', 'json']`, `isAvailable()` delegates to `isCommandOnPath()`, `parseResponse()` throws `AIServiceError` code `SUBPROCESS_ERROR`, `getInstallInstructions()` references https://opencode.ai curl install.

## Architecture

All backends implement `AIBackend` interface from `../types.js` with four required methods (`isAvailable`, `buildArgs`, `parseResponse`, `getInstallInstructions`). `buildArgs()` output feeds `runSubprocess()` args parameter in `src/ai/subprocess.ts`, which sends prompt via stdin. Response parsing normalizes CLI-specific JSON to `AIResponse` shape consumed by `AIService.call()` telemetry and `GenerationTask` result handling.

## Response Parsing Strategies

**ClaudeBackend**: `extractResultJson()` handles three stdout formats (JSON array, NDJSON, legacy single object) by finding `type: "result"` element, then `ClaudeResponseSchema.parse()` validates structure with `.passthrough()` for forward compatibility. Extracts model name from first `modelUsage` key, normalizes tokens/cost to `AIResponse`.

**GeminiBackend/OpenCodeBackend**: No parsing logic — both throw `AIServiceError` until upstream CLI output formats stabilize. Demonstrates extension pattern with interface compliance but deferred functionality.

## CLI Detection

`isCommandOnPath(command: string)` in `claude.ts` splits `process.env.PATH` by `path.delimiter`, checks each directory for `command` with `PATHEXT` extensions on Windows or bare name on Unix, uses `fs.stat()` to verify existence. Reused by all three backends via import.

## Behavioral Contracts

### ClaudeBackend buildArgs

```javascript
['-p', '--output-format', 'json', '--no-session-persistence', '--allowedTools', 'Read', 'Write']
// Conditional appends: --model, --system-prompt, --max-turns
```

### ClaudeResponseSchema

```typescript
z.object({
  type: z.literal('result'),
  subtype: z.enum(['success', 'error']),
  is_error: z.boolean(),
  duration_ms: z.number(),
  duration_api_ms: z.number(),
  num_turns: z.number(),
  result: z.string(),
  session_id: z.string(),
  total_cost_usd: z.number(),
  usage: z.object({
    input_tokens: z.number(),
    cache_creation_input_tokens: z.number().optional(),
    cache_read_input_tokens: z.number().optional(),
    output_tokens: z.number()
  }),
  modelUsage: z.record(z.object({
    inputTokens: z.number(),
    outputTokens: z.number(),
    cacheReadInputTokens: z.number().optional(),
    cacheCreationInputTokens: z.number().optional(),
    costUSD: z.number()
  }))
}).passthrough()
```

### extractResultJson Format Detection

1. JSON array: parse → find `element.type === "result"` → `JSON.stringify(element)`
2. NDJSON: `split('\n')` → find line with `"type":"result"`
3. Legacy: `stdout.slice(stdout.indexOf('{'))`

### GeminiBackend/OpenCodeBackend Error Codes

```javascript
throw new AIServiceError('SUBPROCESS_ERROR', '{Backend} backend is not yet implemented. Use Claude backend.')
```

## File Relationships

`claude.ts` exports `isCommandOnPath()` consumed by `gemini.ts` and `opencode.ts`. All three backends registered in `src/ai/registry.ts` backend map. `ClaudeBackend.parseResponse()` output feeds `AIService` telemetry recording in `src/ai/telemetry/run-log.ts`.