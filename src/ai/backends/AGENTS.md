<!-- Generated by agents-reverse-engineer -->

# backends

AI CLI backend adapters implementing AIBackend interface contract for subprocess spawning: argument construction, response parsing, availability detection, and installation instructions.

## Contents

**[claude.ts](./claude.ts)** — ClaudeBackend adapter: `buildArgs()` constructs `['-p', '--output-format', 'json', '--no-session-persistence', '--allowedTools', 'Read', 'Write']` with optional `--model`, `--system-prompt`, `--max-turns`; `parseResponse()` validates ClaudeResponseSchema extracting tokens from `modelUsage` object; `isCommandOnPath()` scans `process.env.PATH` for executable with `PATHEXT` Windows support.

**[gemini.ts](./gemini.ts)** — GeminiBackend stub: `buildArgs()` returns `['-p', '--output-format', 'json']`, `parseResponse()` throws `AIServiceError('SUBPROCESS_ERROR', 'Gemini backend is not yet implemented')`, delegates `isAvailable()` to `isCommandOnPath()` from claude.ts.

**[opencode.ts](./opencode.ts)** — OpenCodeBackend stub: `buildArgs()` returns `['run', '--format', 'json']`, `parseResponse()` throws `AIServiceError` until JSONL adapter implemented, reuses `isCommandOnPath()` for PATH detection.

## Architecture

### Backend Contract

All backends implement `AIBackend` interface from `../types.js`:
- `name`: unique identifier string (`'claude'` | `'gemini'` | `'opencode'`)
- `cliCommand`: executable name for PATH lookup
- `isAvailable()`: async check for CLI presence via `isCommandOnPath()`
- `buildArgs(options: AICallOptions)`: constructs args array (prompt sent separately via stdin per `runSubprocess()` contract in `src/ai/subprocess.ts`)
- `parseResponse(stdout: string, durationMs: number, exitCode: number)`: extracts `AIResponse` with model/tokens/cost/duration metadata
- `getInstallInstructions()`: returns npm/curl install command string

Consumed by `src/ai/registry.ts` `getBackend(name)` lookup, invoked by `src/ai/subprocess.ts` `runSubprocess()` during `AIService.call()`.

### Response Normalization

ClaudeBackend `parseResponse()` handles three CLI output formats:
1. **JSON array** (CLI ≥2.1.38): `[{type:"system"}, {type:"assistant"}, {type:"result"}]` — finds element with `type:"result"`
2. **NDJSON**: line-delimited JSON objects — scans lines for `type:"result"` object
3. **Legacy** (CLI ≤2.1.31): single JSON object preceded by non-JSON text — slices from first `{` character

Validates against ClaudeResponseSchema with `.passthrough()` for forward compatibility, extracts model name from first key in `modelUsage` object (defaults to `'unknown'` if empty).

## Behavioral Contracts

### PATH Scanning
```typescript
// isCommandOnPath() from claude.ts
for (const dir of process.env.PATH?.split(path.delimiter) ?? []) {
  for (const ext of ['', ...(process.env.PATHEXT?.split(';') ?? [])]) {
    await fs.stat(path.join(dir, command + ext)) // throws if not found
  }
}
```
Windows `PATHEXT` extensions: `.exe`, `.cmd`, `.bat`. Uses `fs.stat()` existence check, not Unix execute permission bit.

### Tool Pre-Approval
```typescript
// ClaudeBackend.buildArgs()
['--allowedTools', 'Read', 'Write']
```
Avoids blocked `bypassPermissions` error when running as root (per @anthropic-ai/claude-code CLI behavior).

### Response Validation
```typescript
// ClaudeResponseSchema (Zod)
z.object({
  type: z.literal('result'),
  subtype: z.enum(['success', 'error']),
  is_error: z.boolean(),
  duration_ms: z.number(),
  num_turns: z.number(),
  result: z.string(),
  total_cost_usd: z.number(),
  usage: z.object({...}).passthrough(),
  modelUsage: z.record(z.object({
    inputTokens: z.number(),
    outputTokens: z.number(),
    cacheReadInputTokens: z.number().optional(),
    cacheCreationInputTokens: z.number().optional(),
    costUSD: z.number()
  })).passthrough()
}).passthrough()
```
Throws `AIServiceError('PARSE_ERROR', ...)` if validation fails or no result object found.

### Unimplemented Backend Error
```typescript
// GeminiBackend + OpenCodeBackend
throw new AIServiceError(
  'SUBPROCESS_ERROR',
  'Gemini|OpenCode backend is not yet implemented. Use Claude backend.'
)
```