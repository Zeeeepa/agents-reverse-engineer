<!-- Generated by agents-reverse-engineer -->

# src/ai/backends

**Backend adapter implementations for Claude Code, Gemini CLI, and OpenCode providing AIBackend interface compliance with CLI argument construction, JSON response parsing, PATH availability detection, and installation instructions.**

## Contents

### Backend Implementations

**[claude.ts](./claude.ts)** — ClaudeBackend adapter with Zod-validated JSON parsing extracting `text`/`model`/`inputTokens`/`outputTokens`/`cacheReadTokens`/`cacheCreationTokens` from Claude CLI v2.1.31 output, `buildArgs()` constructing `['-p', '--output-format', 'json', '--no-session-persistence', '--permission-mode', 'bypassPermissions']` base arguments with conditional `--model`/`--system-prompt`/`--max-turns` appends, `isCommandOnPath()` cross-platform PATH detection handling Windows `PATHEXT` extension iteration.

**[gemini.ts](./gemini.ts)** — GeminiBackend stub returning `['-p', '--output-format', 'json']` from `buildArgs()` but throwing `SUBPROCESS_ERROR` in `parseResponse()` until Gemini JSON output format stabilizes per RESEARCH.md Open Question 2.

**[opencode.ts](./opencode.ts)** — OpenCodeBackend stub returning `['run', '--format', 'json']` from `buildArgs()` but throwing `SUBPROCESS_ERROR` in `parseResponse()` until JSONL parsing implementation completes per RESEARCH.md Open Question 3.

## AIBackend Interface Contract

All backends implement five required methods:

- **`isAvailable(): Promise<boolean>`** — Delegates to `isCommandOnPath(this.cliCommand)` checking PATH directories via `fs.stat().isFile()` with Windows PATHEXT handling
- **`buildArgs(options: AICallOptions): string[]`** — Constructs CLI argument arrays (prompt content delivered via stdin by `runSubprocess()` caller, not CLI arg)
- **`parseResponse(stdout: string, durationMs: number, exitCode: number): AIResponse`** — Normalizes CLI output to `{ text, model, inputTokens, outputTokens, cacheReadTokens, cacheCreationTokens, durationMs, exitCode, raw }` structure
- **`getInstallInstructions(): string`** — Returns multiline installation guidance with npm/curl commands and documentation URLs
- **Properties:** `name: string` (backend identifier), `cliCommand: string` (executable name)

## Claude Response Schema

`ClaudeResponseSchema` validates JSON structure:

```typescript
{
  type: 'result',
  subtype: 'success'|'error',
  is_error: boolean,
  duration_ms: number,
  duration_api_ms: number,
  num_turns: number,
  result: string,
  session_id: string,
  total_cost_usd: number,
  usage: {
    input_tokens: number,
    cache_creation_input_tokens: number,
    cache_read_input_tokens: number,
    output_tokens: number
  },
  modelUsage: Record<string, {
    inputTokens: number,
    outputTokens: number,
    cacheReadInputTokens: number,
    cacheCreationInputTokens: number,
    costUSD: number
  }>
}
```

## Integration with Registry

Backends registered in `src/ai/registry.ts` `AIBackendRegistry.backends` array enabling `detectAvailableBackend()` auto-detection via parallel `isAvailable()` checks. Registry returns first available backend when `config.ai.backend === 'auto'`.

## PATH Detection Strategy

`isCommandOnPath()` implements cross-platform availability checking:

1. Reads `process.env.PATH`, strips double quotes, splits by `path.delimiter` (`:` Unix, `;` Windows)
2. Reads `process.env.PATHEXT` on Windows (e.g., `.COM;.EXE;.BAT;.CMD`), defaults to `['']` on Unix
3. Iterates PATH directories × PATHEXT extensions constructing candidate paths
4. Calls `fs.stat(candidatePath).isFile()` returning `true` on first match (avoids Unix execute bit assumptions)
5. Returns `false` if no candidates exist as files

## Error Handling

ClaudeBackend throws `AIServiceError` with codes:

- **`PARSE_ERROR`** — When `stdout.indexOf('{')` returns `-1` (includes first 200 chars of raw output)
- **`PARSE_ERROR`** — When Zod validation fails (includes validation error message)

Stub backends throw:

- **`SUBPROCESS_ERROR`** — GeminiBackend/OpenCodeBackend until parsing implementation completes

## Behavioral Contracts

### ClaudeBackend CLI Arguments

Base arguments (always included):
```
-p
--output-format json
--no-session-persistence
--permission-mode bypassPermissions
```

Conditional arguments:
```
--model <value>               # if options.model present
--system-prompt <value>       # if options.systemPrompt present
--max-turns <value>           # if options.maxTurns !== undefined
```

### JSON Parsing Defensive Pattern

```javascript
const jsonStart = stdout.indexOf('{')
if (jsonStart === -1) {
  throw new AIServiceError('PARSE_ERROR', `No JSON in output: ${stdout.slice(0, 200)}`)
}
const parsed = ClaudeResponseSchema.parse(JSON.parse(stdout.slice(jsonStart)))
```

### Windows PATHEXT Extensions

```
.COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC
```