<!-- Generated by agents-reverse-engineer -->

# src/ai/backends

**AI backend adapter layer implementing AIBackend interface for Claude Code, Gemini, and OpenCode CLIs with PATH detection, argument construction, JSON response parsing, and installation instructions.**

## Contents

### Backend Adapters

**[claude.ts](./claude.ts)** — ClaudeBackend with isCommandOnPath() PATH detection, buildArgs() permission bypass flags (`--permission-mode bypassPermissions`, `--no-session-persistence`), parseResponse() with ClaudeResponseSchema Zod validation, defensive JSON extraction via stdout.indexOf('{'), and modelUsage-based model name extraction.

**[gemini.ts](./gemini.ts)** — GeminiBackend stub implementing AIBackend interface with isCommandOnPath() delegation, buildArgs() JSON output flags, parseResponse() throwing 'SUBPROCESS_ERROR' AIServiceError until stable JSON format available.

**[opencode.ts](./opencode.ts)** — OpenCodeBackend stub implementing AIBackend interface with isCommandOnPath() delegation, buildArgs() returning `['run', '--format', 'json']`, parseResponse() throwing 'SUBPROCESS_ERROR' AIServiceError until JSONL parsing implemented.

## Architecture

### AIBackend Interface Contract

All backends implement four methods:
- `isAvailable(): Promise<boolean>` — CLI executable detection via PATH scanning
- `buildArgs(options: AICallOptions): string[]` — Argument array construction for subprocess spawn
- `parseResponse(stdout: string, durationMs: number, exitCode: number): AIResponse` — JSON parsing with usage extraction
- `getInstallInstructions(): string` — NPM/curl install commands for missing CLI

### PATH Detection Algorithm

`isCommandOnPath(command: string)` shared utility (exported from claude.ts):
1. Parse `process.env.PATH` with `path.delimiter` (`;` Windows, `:` Unix)
2. Parse `process.env.PATHEXT` on Windows for executable extensions (`.exe`, `.cmd`, `.bat`)
3. Nested loop: directory × extension, construct candidate via `path.join(dir, command + ext)`
4. Check `(await fs.stat(candidate)).isFile()` — return `true` on first match
5. Uses `fs.stat()` not `fs.access(X_OK)` for Windows compatibility (no execute permission bits)

### Response Parsing Strategy

**ClaudeBackend (functional):**
- Defensive JSON extraction: `stdout.substring(stdout.indexOf('{'))` skips upgrade notices
- Zod validation against ClaudeResponseSchema from Claude CLI v2.1.31 output format
- Extracts model name from first `modelUsage` object key (defaults to `'unknown'`)
- Returns AIResponse with normalized `{ result, usage, modelName, durationMs }` structure
- Throws AIServiceError with `'PARSE_ERROR'` code on validation failure

**GeminiBackend/OpenCodeBackend (stubs):**
- Unconditionally throw AIServiceError with `'SUBPROCESS_ERROR'` code in parseResponse()
- Block backend usage until JSON format stabilizes (Gemini) or JSONL parsing implemented (OpenCode)
- Demonstrate extension pattern for future implementations

## Behavioral Contracts

### ClaudeBackend CLI Arguments

Fixed arguments returned by buildArgs():
```
['-p', '--output-format', 'json', '--no-session-persistence', '--permission-mode', 'bypassPermissions']
```

Conditional arguments from AICallOptions:
- `'--model', options.model` when model specified
- `'--system-prompt', options.systemPrompt` when systemPrompt provided
- `'--max-turns', String(options.maxTurns)` when maxTurns defined

Prompt delivered via stdin by `runSubprocess()` wrapper in `src/ai/subprocess.ts`.

### ClaudeResponseSchema Structure

Zod schema validated against Claude CLI v2.1.31:
```typescript
{
  type: 'result',
  subtype: 'success' | 'error',
  is_error: boolean,
  duration_ms: number,
  duration_api_ms: number,
  num_turns: number,
  result: string,
  session_id: string,
  total_cost_usd: number,
  usage: {
    input_tokens: number,
    cache_creation_input_tokens: number,
    cache_read_input_tokens: number,
    output_tokens: number
  },
  modelUsage: Record<string, {
    inputTokens: number,
    outputTokens: number,
    cacheReadInputTokens: number,
    cacheCreationInputTokens: number,
    costUSD: number
  }>
}
```

### Installation Instructions

**ClaudeBackend:** `npm install -g @anthropic-ai/claude-code`  
**GeminiBackend:** `npm install -g @anthropic-ai/gemini-cli` + `https://github.com/google-gemini/gemini-cli`  
**OpenCodeBackend:** `curl -fsSL https://opencode.ai/install | bash` + `https://opencode.ai`

## Integration Points

Backends registered in `src/ai/registry.ts` AIBackendRegistry map with keys `'claude'`, `'gemini'`, `'opencode'`. Registry consumed by AIService in `src/ai/service.ts` for backend selection via `ai.backend` config field. Auto-detection iterates backends calling `isAvailable()` until first match.

`buildArgs()` output consumed by `runSubprocess()` in `src/ai/subprocess.ts` for child_process.execFile() argument array. `parseResponse()` receives stdout/durationMs/exitCode from subprocess wrapper for normalization into AIResponse structure.