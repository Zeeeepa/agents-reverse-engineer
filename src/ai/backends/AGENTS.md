<!-- Generated by agents-reverse-engineer -->

# src/ai/backends

AI backend adapters implementing subprocess CLI invocation for Claude Code, Gemini, and OpenCode with unified AIBackend interface, PATH-based detection, argument construction, and JSON/JSONL response parsing.

## Contents

**[claude.ts](./claude.ts)** — ClaudeBackend implements AIBackend with `buildArgs()` producing `['-p', '--output-format', 'json', '--no-session-persistence', '--permission-mode', 'bypassPermissions']`, `parseResponse()` validating ClaudeResponseSchema extracting token counts from `modelUsage` keys, and `isCommandOnPath()` utility checking PATH environment variable with Windows PATHEXT extension handling.

**[gemini.ts](./gemini.ts)** — GeminiBackend stub implementing AIBackend with `isAvailable()` delegating to `isCommandOnPath('gemini')`, `buildArgs()` returning `['-p', '--output-format', 'json']`, and `parseResponse()` throwing AIServiceError with code `'SUBPROCESS_ERROR'` pending JSON output format stabilization.

**[opencode.ts](./opencode.ts)** — OpenCodeBackend stub implementing AIBackend with `buildArgs()` returning `['run', '--format', 'json']`, `parseResponse()` throwing AIServiceError directing users to Claude backend, and `getInstallInstructions()` providing curl install command from https://opencode.ai/install.

## Backend Registry Integration

AIService in `../service.ts` consumes backends via registry in `../registry.ts`, routing to ClaudeBackend/GeminiBackend/OpenCodeBackend based on config `ai.backend` field or auto-detection order. Backend interface contract defines `isAvailable()` for PATH detection, `buildArgs(AICallOptions)` for CLI argument construction, `parseResponse(stdout, durationMs, exitCode)` for JSON parsing into normalized AIResponse, and `getInstallInstructions()` for user guidance on missing CLIs.

## Response Parsing Patterns

**ClaudeBackend** uses defensive JSON extraction seeking first `{` in stdout to handle upgrade notice prefixes, validates against ClaudeResponseSchema defining `modelUsage: Record<string, {inputTokens, outputTokens, cacheReadInputTokens, cacheCreationInputTokens, costUSD}>`, extracts model name from first `modelUsage` key, and normalizes to AIResponse with `inputTokens`, `cacheReadTokens`, `cacheWriteTokens`, `outputTokens`, `model`, `raw` fields.

**GeminiBackend** and **OpenCodeBackend** defer parseResponse implementation pending upstream CLI JSON format stabilization (Gemini) and JSONL parsing design (OpenCode), throwing AIServiceError to prevent execution while preserving backend detection and argument construction capabilities.

## Cross-Platform CLI Detection

`isCommandOnPath(command)` splits `process.env.PATH` by `path.delimiter`, reads `process.env.PATHEXT` on Windows defaulting to `['']` elsewhere, nested-loops each `PATH_DIR × PATHEXT_SUFFIX` combination via `fs.stat(path.join(dir, command + ext))`, returns true on first `stat.isFile()` match, swallows all exceptions from missing files, strips quotes from PATH via `.replace(/["]+/g, '')` before splitting.

## Argument Construction Strategy

ClaudeBackend enforces non-interactive mode via `-p` print flag, `--output-format json` for structured parsing, `--no-session-persistence` to prevent disk writes, `--permission-mode bypassPermissions` to skip interactive prompts (PITFALLS.md §8), and optional `--model`, `--system-prompt`, `--max-turns` from AICallOptions. Prompt excluded from args array per runSubprocess contract delivering prompt via stdin stream. GeminiBackend and OpenCodeBackend follow similar patterns with backend-specific format flags.

## Error Handling

ClaudeBackend throws AIServiceError with code `'PARSE_ERROR'` if no `{` found in stdout or Zod validation fails, including truncated stdout (first 200 chars) in error message. GeminiBackend and OpenCodeBackend throw AIServiceError with code `'SUBPROCESS_ERROR'` and user-facing guidance messages. isCommandOnPath swallows all exceptions during PATH traversal, returning false when no executable found across all dir/extension candidates.

## Dependencies

Imports AIBackend, AICallOptions, AIResponse types and AIServiceError class from `../types.ts`. ClaudeBackend exports isCommandOnPath utility shared by GeminiBackend and OpenCodeBackend. Subprocess invocation wrapper in `../subprocess.ts` consumes backend.buildArgs() output and passes backend.parseResponse() to child process stdout. ClaudeResponseSchema validates against Claude CLI v2.1.31 JSON structure per RESEARCH.md live verification.