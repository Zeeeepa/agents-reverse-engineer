<!-- Generated by agents-reverse-engineer -->

# src/ai/backends

Backend adapters that implement the AIBackend interface for different AI CLI tools. Each backend translates AICallOptions into CLI-specific argument arrays, parses CLI stdout into AIResponse structures, and detects CLI availability on the system PATH.

## Contents

**[claude.ts](./claude.ts)** - ClaudeBackend adapter for `@anthropic-ai/claude-code` CLI. Implements `buildArgs()` returning `['-p', '--output-format', 'json', '--no-session-persistence', '--permission-mode', 'bypassPermissions']` plus optional `--model`, `--system-prompt`, `--max-turns`. Parses JSON responses via ClaudeResponseSchema extracting `text`, `model`, `inputTokens`, `outputTokens`, `cacheReadTokens`, `cacheCreationTokens`, `durationMs`, `exitCode`. Exports `isCommandOnPath(command)` helper for cross-platform PATH detection using `fs.stat` and `PATHEXT` on Windows.

**[gemini.ts](./gemini.ts)** - GeminiBackend stub for future Gemini CLI integration. Implements `buildArgs()` returning `['-p', '--output-format', 'json']`. Throws AIServiceError with `'SUBPROCESS_ERROR'` code in `parseResponse()` until Gemini JSON output stabilizes (see RESEARCH.md Open Question 2).

**[opencode.ts](./opencode.ts)** - OpenCodeBackend stub for OpenCode CLI. Implements `buildArgs()` returning `['run', '--format', 'json']`. Throws AIServiceError with `'SUBPROCESS_ERROR'` code in `parseResponse()` until JSONL parsing logic is implemented (see RESEARCH.md Open Question 3).

## Backend Interface Contract

All backends implement AIBackend from `../types.js`:
- **`name`** (readonly string) - backend identifier for registry lookup
- **`cliCommand`** (readonly string) - executable name for PATH detection
- **`isAvailable(): Promise<boolean>`** - checks if CLI exists on system PATH via `isCommandOnPath()`
- **`buildArgs(options: AICallOptions): string[]`** - constructs CLI argument array from AICallOptions (model, systemPrompt, maxTurns). Prompt itself goes to stdin via `runSubprocess()` in `src/ai/subprocess.ts`.
- **`parseResponse(stdout: string, durationMs: number, exitCode: number): AIResponse`** - normalizes CLI stdout into AIResponse structure with `text`, `model`, token counts, `durationMs`, `exitCode`, `raw`
- **`getInstallInstructions(): string`** - returns npm install command or installation URL for CLI tool

## CLI Detection Strategy

ClaudeBackend exports `isCommandOnPath(command)` reused by GeminiBackend and OpenCodeBackend. Splits `process.env.PATH` by `path.delimiter`, checks each directory for file matching `command + ext` where `ext` comes from `PATHEXT` (Windows) or `['']` (Unix), uses `fs.stat` to verify file existence. Strips quotes from PATH via `replace(/["]+/g, '')` for Windows compatibility.

## Response Parsing Patterns

ClaudeBackend.parseResponse performs defensive JSON extraction by searching for first `{` in stdout to handle upgrade notices or prefix text (RESEARCH.md Pitfall 4), validates against ClaudeResponseSchema, extracts model name from first key of `modelUsage`. Throws AIServiceError with `'PARSE_ERROR'` code if stdout contains no `{` or schema validation fails, includes first 200 chars of stdout in error message.

## Registry Integration

All three backends register in AIBackendRegistry (`src/ai/registry.ts`). AIService (`src/ai/service.ts`) looks up backend by name, calls `isAvailable()` during initialization, invokes `buildArgs()` to construct CLI command array, and calls `parseResponse()` to normalize subprocess output. Subprocess wrapper (`src/ai/subprocess.ts`) delivers prompts via stdin and captures stdout for parsing.

## Stub Backend Pattern

GeminiBackend and OpenCodeBackend implement command detection and argument building but block on `parseResponse()` by throwing AIServiceError with `'SUBPROCESS_ERROR'` code. This allows registry integration and availability checking without blocking on unstable JSON output formats, demonstrating the AIBackend extension pattern where new CLI adapters can be added incrementally.