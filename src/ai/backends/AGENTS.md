<!-- Generated by agents-reverse-engineer -->

# src/ai/backends

Backend adapters for AI CLI tools. Each backend implements `AIBackend` from `../types.js`, exposing `isAvailable()`, `buildArgs(options: AICallOptions)`, `parseResponse(stdout, durationMs, exitCode)`, and `getInstallInstructions()`. The registry in `../registry.ts` consumes these backends to route subprocess calls through `AIService`.

## Contents

### [claude.ts](./claude.ts)
ClaudeBackend with production-ready response parsing: handles JSON array (CLI ≥2.1.38), NDJSON, and legacy formats via `extractResultJson()`. Validates output against `ClaudeResponseSchema` (Zod), extracts token counts from `modelUsage`, enforces `--permission-mode bypassPermissions` per PITFALLS.md §8.

### [gemini.ts](./gemini.ts)
GeminiBackend stub: `isAvailable()` and `buildArgs()` functional, `parseResponse()` throws `AIServiceError('SUBPROCESS_ERROR', 'Gemini backend is not yet implemented')`. Awaiting Gemini CLI JSON output format stabilization (RESEARCH.md Open Question 2).

### [opencode.ts](./opencode.ts)
OpenCodeBackend stub: `isAvailable()` and `buildArgs(['run', '--format', 'json'])` operational, `parseResponse()` throws `AIServiceError('SUBPROCESS_ERROR', 'OpenCode backend is not yet implemented')`. Deferred pending OpenCode JSONL parsing implementation (RESEARCH.md Open Question 3).

## CLI Argument Patterns

All backends pass prompts via stdin (not CLI args). ClaudeBackend emits `['-p', '--output-format', 'json', '--no-session-persistence', '--permission-mode', 'bypassPermissions']` with optional `--model`, `--system-prompt`, `--max-turns` from `AICallOptions`. GeminiBackend outputs `['-p', '--output-format', 'json']`. OpenCodeBackend returns `['run', '--format', 'json']`.

## Response Parsing Strategy (Claude)

`ClaudeBackend.parseResponse()` implements three-phase extraction:

1. **JSON array** (modern CLI): parse `[{system}, {assistant}, {result}]`, locate `type: "result"` element, re-serialize
2. **NDJSON** (fallback): split by newline, find `{"type":"result",...}` line
3. **Legacy** (CLI ≤2.1.31): slice from first `{` to EOF

After extraction, validates against `ClaudeResponseSchema` (requires `type: "result"`, `subtype: "success" | "error"`, `usage`, `modelUsage`). Extracts model name from first key in `modelUsage` object. Maps fields to `AIResponse`: `text` ← `result`, `inputTokens` ← `usage.input_tokens`, `cacheReadTokens` ← `usage.cache_read_input_tokens`. Throws `AIServiceError('PARSE_ERROR')` if JSON absent or schema invalid.

## Schema Definition

`ClaudeResponseSchema` (Zod):
```typescript
z.object({
  type: z.literal('result'),
  subtype: z.enum(['success', 'error']),
  usage: z.object({
    input_tokens: z.number(),
    cache_creation_input_tokens: z.number(),
    cache_read_input_tokens: z.number(),
    output_tokens: z.number(),
  }).passthrough(),
  modelUsage: z.record(z.object({
    inputTokens: z.number(),
    outputTokens: z.number(),
    cacheReadInputTokens: z.number(),
    cacheCreationInputTokens: z.number(),
  }).passthrough()),
  result: z.string(),
})
```
Uses `.passthrough()` to tolerate future CLI version additions without breaking validation.

## Availability Detection

`isCommandOnPath(command: string)` (exported from `claude.ts`, imported by `gemini.ts` and `opencode.ts`) searches `process.env.PATH` directories for executable. On Windows, iterates `process.env.PATHEXT` extensions (`.exe`, `.cmd`, `.bat`). Uses `fs.stat()` over `fs.access()` for Windows compatibility (per docstring note).

## Install Instructions

- ClaudeBackend: `npm install -g @anthropic-ai/claude-code` + `https://code.claude.com`
- GeminiBackend: `npm install -g @anthropic-ai/gemini-cli` + `https://github.com/google-gemini/gemini-cli`
- OpenCodeBackend: `curl -fsSL https://opencode.ai/install | bash` + `https://opencode.ai`

## Integration Points

Backends consumed by `AIService` (likely `../service.ts`). Output from `buildArgs()` passed to `runSubprocess()` from `../subprocess.js`. `AIServiceError` from `../types.js` thrown on parse failures. Registry in `../registry.ts` selects backend by name (`'claude'` | `'gemini'` | `'opencode'`).