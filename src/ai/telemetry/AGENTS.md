<!-- Generated by agents-reverse-engineer -->

# src/ai/telemetry

Telemetry subsystem for accumulating per-request AI metrics (`TelemetryEntry` instances via `TelemetryLogger`), persisting run logs as timestamped JSON to `.agents-reverse-engineer/logs/`, and enforcing retention policies via `cleanupOldLogs()`.

## Contents

**[logger.ts](./logger.ts)** — `TelemetryLogger` class with `addEntry(TelemetryEntry)`, `setFilesReadOnLastEntry(FileRead[])`, `getSummary()` (computes `totalInputTokens`, `totalOutputTokens`, `totalCacheReadTokens`, `totalCacheCreationTokens`, `totalDurationMs`, `errorCount`, `uniqueFilesRead`), and `toRunLog()` snapshot generation.

**[run-log.ts](./run-log.ts)** — `writeRunLog(projectRoot, RunLog)` persists `RunLog` as `JSON.stringify(..., null, 2)` to `.agents-reverse-engineer/logs/run-{safeTimestamp}.json` with ISO 8601 timestamp sanitization (`[:.]/g` → `'-'`).

**[cleanup.ts](./cleanup.ts)** — `cleanupOldLogs(projectRoot, keepCount)` retains N most recent `run-*.json` files via lexicographic sort descending, deletes excess entries, returns deletion count (0 on ENOENT).

## Data Flow

1. `src/ai/service.ts` `AIService` constructs `TelemetryLogger(runId)` at CLI start
2. Each `AIService.call()` invokes `logger.addEntry(entry)` with token/latency/error metrics
3. `CommandRunner` attaches file metadata via `logger.setFilesReadOnLastEntry(filesRead)`
4. `AIService.finalize()` calls `logger.toRunLog()` → `writeRunLog()` → `cleanupOldLogs(config.ai.telemetry.keepRuns)`

## Integration Points

- **src/ai/service.ts**: creates logger, calls `addEntry()` per subprocess completion, invokes `finalize()` at CLI exit
- **src/orchestration/runner.ts**: provides `filesRead` metadata to service after phase completion
- **src/config/schema.ts**: `config.ai.telemetry.keepRuns` (default 10) controls cleanup retention

## Behavioral Contracts

### Timestamp Sanitization
```javascript
safeTimestamp = runLog.startTime.replace(/[:.]/g, '-')
// Example: "2026-02-11T14:30:45.123Z" → "2026-02-11T14-30-45-123Z"
```

### Lexicographic Sort
```javascript
entries.sort()  // Ascending ASCII
entries.reverse()  // Newest first (relies on ISO 8601 timestamp prefix)
```

### Retention Policy
Keeps N most recent `run-*.json` files where N = `config.ai.telemetry.keepRuns`. Deletion count returned for logging.

### Error Handling
`cleanupOldLogs()` returns 0 on ENOENT (logs directory missing) without throwing.