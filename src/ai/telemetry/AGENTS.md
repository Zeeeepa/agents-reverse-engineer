<!-- Generated by agents-reverse-engineer -->

# src/ai/telemetry

**Accumulates per-subprocess telemetry entries in memory via TelemetryLogger, serializes aggregate RunLog summaries to timestamped NDJSON files in `.agents-reverse-engineer/logs/`, and enforces retention limits via lexicographic filename sorting.**

## Contents

**[cleanup.ts](./cleanup.ts)** — `cleanupOldLogs(projectRoot, keepCount)` deletes oldest `run-*.json` files beyond retention threshold via lexicographic sort, catches `ENOENT` for missing logs directory.

**[logger.ts](./logger.ts)** — `TelemetryLogger` class accumulates `TelemetryEntry` instances in memory, computes aggregate statistics via `getSummary()` (token sums, error counts, unique file deduplication), exports `toRunLog()` for serialization.

**[run-log.ts](./run-log.ts)** — `writeRunLog(projectRoot, runLog)` serializes `RunLog` to `.agents-reverse-engineer/logs/run-<safeTimestamp>.json` with ISO timestamp transformation (`2026-02-07T12:00:00.000Z` → `2026-02-07T12-00-00-000Z.json`).

## Data Flow

1. **AIService** (`src/ai/service.ts`) invokes `TelemetryLogger.addEntry()` after each subprocess call with `TelemetryEntry` containing `inputTokens`, `outputTokens`, `cacheReadTokens`, `latencyMs`, `error`, `filesRead[]`.
2. **Command orchestrator** (`src/orchestration/runner.ts`) calls `logger.setFilesReadOnLastEntry(filesRead)` post-execution to attach file metadata (`path`, `sizeBytes`, `linesRead`).
3. **Run completion**: orchestrator calls `logger.toRunLog()` to produce `RunLog` with aggregated summary (`totalCalls`, `totalInputTokens`, `totalDurationMs`, `errorCount`, `uniqueFilesRead`).
4. **Persistence**: `writeRunLog(projectRoot, runLog)` serializes to `.agents-reverse-engineer/logs/run-<timestamp>.json`.
5. **Retention enforcement**: `cleanupOldLogs(projectRoot, keepCount)` deletes oldest logs beyond `config.ai.telemetry.keepRuns` threshold (default 50).

## Integration Points

**Consumed by:**
- `src/ai/service.ts` — AIService instantiates TelemetryLogger once per run, calls `addEntry()` per subprocess, invokes `toRunLog()` at finalization.
- `src/orchestration/runner.ts` — Orchestrates telemetry lifecycle: logger creation, entry enrichment with file reads, run log serialization, cleanup invocation.

**Consumes:**
- `src/ai/types.ts` — `TelemetryEntry`, `RunLog`, `FileRead` type definitions with token count fields, latency metrics, error summaries.

## Behavioral Contracts

**Filename transformation** (run-log.ts):
```typescript
runLog.startTime.replace(/[:.]/g, '-')
// Input:  "2026-02-09T12:34:56.789Z"
// Output: "run-2026-02-09T12-34-56-789Z.json"
```

**Lexicographic sorting** (cleanup.ts):
- ISO 8601 timestamps in filenames sort chronologically when treated as strings.
- `sort()` then `reverse()` produces newest-first order.
- `slice(keepCount)` targets oldest files for deletion.

**Aggregate statistics** (logger.ts `getSummary()`):
- `totalCalls` = `entries.length`
- `totalInputTokens` = `Σ(entry.inputTokens)`
- `uniqueFilesRead` = distinct count via `Set<string>` deduplication of `entry.filesRead.map(f => f.path)`

## Retention Policy

Default retention: 50 runs (`config.ai.telemetry.keepRuns`). `cleanupOldLogs()` invoked after every `writeRunLog()` call. Missing logs directory handled gracefully (returns 0 without error). Propagates non-`ENOENT` filesystem errors to caller.