<!-- Generated by agents-reverse-engineer -->

# src/ai/telemetry

Persistence layer for AI service call metrics: writes NDJSON run logs, enforces retention limits, and aggregates token/latency statistics per CLI invocation.

## Contents

### Core Classes and Functions

**[logger.ts](./logger.ts)** — `TelemetryLogger` accumulates `TelemetryEntry` instances via `addEntry()`, computes aggregate metrics through `getSummary()` (totalCalls, totalInputTokens, totalOutputTokens, totalCacheReadTokens, totalCacheCreationTokens, totalDurationMs, errorCount, uniqueFilesRead), and produces `RunLog` via `toRunLog()`. `setFilesReadOnLastEntry(filesRead: FileRead[])` mutates the most recent entry's filesRead field post-execution.

**[run-log.ts](./run-log.ts)** — `writeRunLog(projectRoot: string, runLog: RunLog): Promise<string>` serializes `RunLog` to `.agents-reverse-engineer/logs/run-${safeTimestamp}.json` with 2-space JSON indentation. Filename derives from `runLog.startTime` ISO 8601 timestamp with `:` and `.` replaced by `-`. Returns absolute path to written file.

**[cleanup.ts](./cleanup.ts)** — `cleanupOldLogs(projectRoot: string, keepCount: number): Promise<number>` removes telemetry log files exceeding retention limit. Targets `run-*.json` files in `LOGS_DIR`, sorts lexicographically in reverse (newest first), deletes entries beyond `keepCount`. Returns deleted file count, 0 on `ENOENT`.

## Behavioral Contracts

### Directory Constants
```
LOGS_DIR = '.agents-reverse-engineer/logs'
```

### Filename Sanitization Pattern
ISO 8601 timestamp transformation: `:` and `.` → `-`  
Input: `2026-02-07T12:00:00.000Z`  
Output: `run-2026-02-07T12-00-00-000Z.json`

### Retention Filter Regex
```javascript
name.startsWith('run-') && name.endsWith('.json')
```

## Data Flow

1. **Accumulation**: `TelemetryLogger.addEntry()` appends entries during AI service calls
2. **Completion**: `toRunLog()` invoked at CLI run end, calls `getSummary()` for aggregates
3. **Serialization**: `writeRunLog()` persists `RunLog` to timestamped JSON file
4. **Cleanup**: `cleanupOldLogs()` enforces retention policy by deleting oldest files

## Integration Points

- **Upstream**: `TelemetryEntry`, `RunLog`, `FileRead` types from `../types.js`
- **Downstream**: CLI commands instantiate `TelemetryLogger`, invoke `writeRunLog()` and `cleanupOldLogs()` post-execution
- **Configuration**: Retention count sourced from `.agents-reverse-engineer/` config (not defined in this directory)