<!-- Generated by agents-reverse-engineer -->

# src/ai/telemetry

Serializes per-call AI service metrics to timestamped JSON run logs with automatic retention enforcement via lexicographic file deletion.

## Contents

**[cleanup.ts](./cleanup.ts)** — `cleanupOldLogs(projectRoot, keepCount)` deletes oldest `run-*.json` files beyond retention threshold via lexicographic sort (relies on ISO 8601 filename timestamps for chronological ordering), returns deletion count, silently succeeds when logs directory missing (ENOENT).

**[logger.ts](./logger.ts)** — `TelemetryLogger` accumulates `TelemetryEntry[]` in memory with `addEntry()`, computes aggregates via `getSummary()` (totalInputTokens/totalOutputTokens/totalCacheReadTokens/totalCacheCreationTokens/totalDurationMs/totalCalls/errorCount/totalFilesRead/uniqueFilesRead), mutates last entry via `setFilesReadOnLastEntry(filesRead)` after AI service attaches file metadata, serializes via `toRunLog()` with current endTime.

**[run-log.ts](./run-log.ts)** — `writeRunLog(projectRoot, runLog)` sanitizes `runLog.startTime` ISO timestamp by replacing `:` and `.` with `-` for cross-platform filename safety, writes pretty-printed JSON to `.agents-reverse-engineer/logs/run-${safeTimestamp}.json`, returns absolute path.

## Integration with AI Service

`AIService` in `src/ai/service.ts` instantiates `TelemetryLogger` once per CLI command execution (runId from timestamp), invokes `addEntry()` after each subprocess call with per-invocation metrics (tokens, latency, optional error), calls `setFilesReadOnLastEntry()` when command runner attaches `FileRead[]` metadata (path/sizeBytes/linesRead), finalizes via `toRunLog()` at CLI termination, passes result to `writeRunLog()` for disk persistence, triggers `cleanupOldLogs(keepRuns)` post-write to enforce `config.yaml` retention limit (default 50).

## File Lifecycle

**Write**: Run completion triggers `writeRunLog()` → creates `.agents-reverse-engineer/logs/` via `fs.mkdir({recursive:true})` → serializes `RunLog` with 2-space JSON indentation → returns absolute path for caller logging.

**Cleanup**: Post-write invokes `cleanupOldLogs(keepCount)` → reads directory → filters `run-*.json` via regex → sorts lexicographically ascending → reverses for newest-first → slices beyond threshold → unlinks via `fs.unlink()` → returns deletion count.

**Retention assumptions**: Lexicographic sort correctness depends on ISO 8601 timestamp filenames (e.g., `run-2026-02-09T14-30-45-123Z.json`) where alphabetical ordering matches chronological ordering.

## Type Dependencies

Imports `TelemetryEntry`, `RunLog`, `FileRead` from `../types.js`. `TelemetryEntry` contains per-call fields (inputTokens, outputTokens, cacheReadTokens, cacheCreationTokens, durationMs, optional error, filesRead array). `RunLog` contains runId (string), startTime (ISO string), endTime (ISO string), entries (TelemetryEntry[]), summary (nine aggregate numeric fields). `FileRead` contains path (string), sizeBytes (number), linesRead (number) for file access tracking.