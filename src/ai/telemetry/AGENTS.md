<!-- Generated by agents-reverse-engineer -->

# src/ai/telemetry

Telemetry subsystem for accumulating AI service call metrics, writing JSON run logs with retention management, and tracking token costs, durations, and file metadata across concurrent worker pool operations.

## Contents

### [cleanup.ts](./cleanup.ts)
Exports `cleanupOldLogs(projectRoot, keepCount)` deleting expired telemetry logs from `.agents-reverse-engineer/logs/` by lexicographic timestamp sorting on `run-*.json` filenames. Returns count of deleted files.

### [logger.ts](./logger.ts)
Exports `TelemetryLogger` class accumulating `TelemetryEntry` instances in memory during CLI runs. Methods: `addEntry()` appends call metrics, `setFilesReadOnLastEntry()` attaches file metadata to most recent entry, `getSummary()` computes aggregate statistics (token totals, error counts, unique file paths), `toRunLog()` serializes complete `RunLog` object.

### [run-log.ts](./run-log.ts)
Exports `writeRunLog(projectRoot, runLog)` persisting `RunLog` as pretty-printed JSON with ISO-8601-derived filename pattern `run-2026-02-07T12-00-00-000Z.json`. Creates `.agents-reverse-engineer/logs/` directory via `mkdir(recursive: true)`.

## Data Flow

1. `TelemetryLogger` instantiated once per CLI invocation with unique `runId` (ISO timestamp)
2. AIService calls `logger.addEntry(entry)` after each subprocess completion with token counts, cost, duration, error status
3. Command runner invokes `logger.setFilesReadOnLastEntry(filesRead)` to attach file metadata to last entry
4. On run completion, caller invokes `logger.toRunLog()` → serializes in-memory entries + summary
5. `writeRunLog(projectRoot, runLog)` persists JSON to disk with timestamp-derived filename
6. `cleanupOldLogs(projectRoot, keepCount)` enforces retention policy by deleting oldest logs exceeding `keepRuns` threshold (default 50)

## Behavioral Contracts

**Filename derivation pattern** (from `run-log.ts`):
```typescript
const timestamp = runLog.startTime.replace(/:/g, '-').replace(/\./g, '-');
const filename = `run-${timestamp}.json`;
```

**Log directory constant** (shared across all modules):
```typescript
const LOGS_DIR = '.agents-reverse-engineer/logs';
```

**Cleanup sort order** (from `cleanup.ts`):
```typescript
entries.sort();      // Lexicographic ascending
entries.reverse();   // Newest first
const toDelete = entries.slice(keepCount);  // Oldest logs
```

**Summary deduplication** (from `logger.ts`):
```typescript
const uniquePaths = new Set<string>();
for (const entry of this.entries) {
  for (const file of entry.filesRead || []) {
    uniquePaths.add(file.path);
  }
}
return { uniqueFilesRead: uniquePaths.size };
```

## Integration Points

- **Created by**: `src/ai/service.ts` constructs `TelemetryLogger` when `config.ai.telemetry.enabled === true`
- **Consumed by**: `src/orchestration/runner.ts` invokes `writeRunLog()` after Phase 3 completion, then calls `cleanupOldLogs()` with `config.ai.telemetry.keepRuns`
- **Types imported from**: `../types.js` provides `TelemetryEntry`, `RunLog`, `FileRead` interfaces
- **Related configuration**: `src/config/schema.ts` defines `ai.telemetry.enabled`, `ai.telemetry.keepRuns`, `ai.telemetry.costThresholdUsd` validation rules

## Design Notes

`TelemetryLogger` uses eager summary computation on every `getSummary()` invocation without caching — acceptable since `toRunLog()` called once per run. Single-level flat `entries` array without phase-aware partitioning simplifies aggregation logic at cost of phase-specific analytics. Cleanup operates on filename lexicographic order assuming ISO 8601 timestamp sort equivalence (year-month-day-hour-minute-second-millisecond).