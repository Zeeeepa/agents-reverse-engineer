<!-- Generated by agents-reverse-engineer -->

# src/ai/telemetry

Telemetry subsystem for accumulating, persisting, and pruning AI service call metrics across CLI invocations.

## Contents

**[cleanup.ts](./cleanup.ts)** — `cleanupOldLogs(projectRoot, keepCount)` deletes oldest `run-*.json` files from `.agents-reverse-engineer/logs/`, retaining `keepCount` most recent via lexicographic sort (ISO timestamp prefix), returns deletion count, treats ENOENT as no-op.

**[logger.ts](./logger.ts)** — `TelemetryLogger` accumulates `TelemetryEntry` instances in memory per CLI run, exposes `addEntry()`, `setFilesReadOnLastEntry()`, `getEntries()`, `getSummary()` (computes `totalInputTokens`, `totalOutputTokens`, `totalCacheReadTokens`, `totalCacheCreationTokens`, `totalDurationMs`, `errorCount`, `totalFilesRead`, `uniqueFilesRead`), `toRunLog()` produces serializable `RunLog` with ISO 8601 `endTime`.

**[run-log.ts](./run-log.ts)** — `writeRunLog(projectRoot, runLog)` persists `RunLog` to `.agents-reverse-engineer/logs/run-${safeTimestamp}.json` with 2-space indentation, creates directory via `mkdir({recursive:true})`, filename derived from `runLog.startTime.replace(/[:.]/g, '-')` for cross-platform safety.

## Data Flow

1. `src/ai/service.ts` instantiates `TelemetryLogger(runId)` at command start
2. After each `AIService.call()` completion, `addEntry(entry)` appends metrics (tokens, latency, error)
3. Command runner calls `setFilesReadOnLastEntry(filesRead)` to attach file metadata
4. At run completion, `toRunLog()` assembles final `RunLog` with computed `summary`
5. `writeRunLog(projectRoot, runLog)` persists JSON to logs directory
6. `src/orchestration/runner.ts` invokes `cleanupOldLogs(projectRoot, config.ai.telemetry.keepRuns)` to enforce retention policy

## Behavioral Contracts

### Log Retention
```javascript
cleanupOldLogs(projectRoot, keepCount)
// Filters: name.startsWith('run-') && name.endsWith('.json')
// Sort: lexicographic ascending, reverse to newest-first
// Delete: entries.slice(keepCount)
```

### Filename Pattern
```javascript
`run-${runLog.startTime.replace(/[:.]/g, '-')}.json`
// Example: '2026-02-07T12:00:00.000Z' → 'run-2026-02-07T12-00-00-000Z.json'
```

### Summary Aggregation
`TelemetryLogger.getSummary()` iterates all entries, totals `inputTokens`, `outputTokens`, `cacheReadTokens`, `cacheCreationTokens`, `latencyMs`, counts entries where `error !== undefined`, sums `filesRead.length`, collects unique file paths in `Set`. Not cached — recomputes on every call.