<!-- Generated by agents-reverse-engineer -->

# src/ai/telemetry/

Accumulates AI service call metadata in memory, serializes completed runs to timestamped JSON logs in `.agents-reverse-engineer/logs/`, and enforces retention limits via automatic cleanup of stale log files.

## Contents

**[logger.ts](./logger.ts)** — `TelemetryLogger` class accumulates `TelemetryEntry` instances via `addEntry()`, attaches `FileRead` metadata via `setFilesReadOnLastEntry()`, computes aggregate statistics through `getSummary()` (total tokens, error counts, unique files), and assembles complete `RunLog` objects via `toRunLog()` for persistence.

**[run-log.ts](./run-log.ts)** — `writeRunLog()` creates `.agents-reverse-engineer/logs/` directory, sanitizes ISO 8601 timestamps by replacing `:` and `.` with `-`, writes pretty-printed JSON via `JSON.stringify(runLog, null, 2)`, returns absolute path to written file.

**[cleanup.ts](./cleanup.ts)** — `cleanupOldLogs()` lists `run-*.json` files from logs directory, sorts lexicographically descending (newest first via `entries.sort()` + `entries.reverse()`), slices beyond retention limit, deletes via `fs.unlink()`, suppresses ENOENT errors, returns deleted file count.

## Data Flow

1. **Accumulation Phase**: Command runner creates `TelemetryLogger(runId)` with ISO timestamp, threads logger through `AIService` which calls `addEntry()` after each subprocess completion and `setFilesReadOnLastEntry()` after file metadata attachment from command runner.

2. **Aggregation Phase**: `getSummary()` iterates entries array on every call (no caching), accumulates token counters (`inputTokens`, `outputTokens`, `cacheReadTokens`, `cacheCreationTokens`), latency totals, error counts, and unique file paths via `Set<string>`.

3. **Persistence Phase**: `toRunLog()` assembles complete `RunLog` object with shallow-copied entries and summary, `writeRunLog()` serializes to timestamped JSON file (e.g., `run-2026-02-07T12-00-00-000Z.json`), `cleanupOldLogs()` enforces retention limit from `Config.ai.telemetry.keepRuns` (default 50).

## Integration Points

- **Callers**: Command runners (`src/cli/generate.ts`, `src/cli/update.ts`) create `TelemetryLogger` instances, finalize via `toRunLog()` + `writeRunLog()` + `cleanupOldLogs()` sequence after run completion.
- **AI Service**: `src/ai/service.ts` calls `addEntry()` after subprocess execution, `setFilesReadOnLastEntry()` after file metadata attachment from command runner.
- **Type Definitions**: Imports `TelemetryEntry`, `RunLog`, `FileRead` from `../types.js` — per-call metadata schema with token counts, latency, error state, and file access records.

## Filename Sanitization Strategy

Regex pattern `/[:.]/g` replaces `:` and `.` characters in ISO 8601 timestamps to produce cross-platform-valid filenames (e.g., `2026-02-07T12:00:00.000Z` → `run-2026-02-07T12-00-00-000Z.json`). Lexicographic sort order preserved for cleanup logic.

## Concurrency Characteristics

Single atomic write per run log with unique timestamped filename eliminates concurrent write conflicts (unlike trace writer's promise-chain serialization pattern). Each CLI invocation produces separate `RunLog` object with distinct `runId`.