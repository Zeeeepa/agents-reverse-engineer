<!-- Generated by agents-reverse-engineer -->

# src/ai/telemetry

In-memory telemetry accumulation and persistent run log management for AI call tracking. Accumulates per-call entries via `TelemetryLogger`, writes completed run logs to `.agents-reverse-engineer/logs/` via `writeRunLog()`, and prunes old logs via `cleanupOldLogs()`.

## Contents

**[logger.ts](./logger.ts)** — `TelemetryLogger` class accumulates `TelemetryEntry` objects in memory, computes aggregate summaries (`totalCalls`, `totalInputTokens`, `totalOutputTokens`, `totalCacheReadTokens`, `totalCacheCreationTokens`, `totalDurationMs`, `errorCount`, `totalFilesRead`, `uniqueFilesRead`) via `getSummary()`, and produces `RunLog` objects via `toRunLog()`.

**[run-log.ts](./run-log.ts)** — `writeRunLog(projectRoot, runLog)` writes `RunLog` objects to `.agents-reverse-engineer/logs/run-{sanitizedTimestamp}.json` as pretty-printed JSON, creating the logs directory if needed.

**[cleanup.ts](./cleanup.ts)** — `cleanupOldLogs(projectRoot, keepCount)` deletes all but the N most recent `run-*.json` files from `.agents-reverse-engineer/logs/`, returning the deletion count.

## Data Flow

1. **Accumulation**: `TelemetryLogger` created once per CLI run, `addEntry()` called after each AI subprocess completes, `setFilesReadOnLastEntry()` attaches file metadata from command runner
2. **Finalization**: `toRunLog()` invoked when run completes, captures `endTime` and summary totals
3. **Persistence**: `writeRunLog()` serializes `RunLog` to disk with timestamp-derived filename
4. **Cleanup**: `cleanupOldLogs()` invoked after write to enforce retention policy, relies on lexicographic sort of ISO timestamp filenames

## Behavioral Contracts

**Filename Sanitization** (run-log.ts):  
`/[:.]/g` → `-` transforms ISO 8601 timestamps into filesystem-safe names (e.g., `2026-02-07T12:00:00.000Z` → `run-2026-02-07T12-00-00-000Z.json`)

**Log File Pattern** (cleanup.ts):  
`run-*.json` glob pattern for log file discovery

**Logs Directory**:  
`.agents-reverse-engineer/logs` (shared constant `LOGS_DIR` across cleanup.ts and run-log.ts)

## Integration Points

- Consumed by `../service.ts` (`AIService`) to record telemetry after each subprocess call
- `RunLog` and `TelemetryEntry` types defined in `../types.ts`
- Telemetry files written by run-log.ts are read by orchestration progress logger and CLI status displays