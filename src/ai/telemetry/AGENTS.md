<!-- Generated by agents-reverse-engineer v0.8.2 -->

# src/ai/telemetry

Telemetry subsystem accumulating TelemetryEntry instances during CLI runs, computing aggregate token/latency/error summaries, persisting RunLog JSON snapshots to `.agents-reverse-engineer/logs/`, and enforcing retention limits via lexicographic cleanup.

## Contents

**[cleanup.ts](./cleanup.ts)** — `cleanupOldLogs(projectRoot: string, keepCount: number): Promise<number>` deletes old `run-*.json` files from logs directory, retaining N most recent via lexicographic sort descending (`entries.sort(); entries.reverse()`), returns deletion count or 0 on ENOENT.

**[logger.ts](./logger.ts)** — `TelemetryLogger` class with constructor `(runId: string, backend: string, model: string, command: string)`, maintains in-memory `TelemetryEntry[]` array via `addEntry()`, mutates last entry via `setFilesReadOnLastEntry()`, computes `totalCalls`/`totalInputTokens`/`totalOutputTokens`/`totalCacheReadTokens`/`totalCacheCreationTokens`/`totalDurationMs`/`errorCount`/`totalFilesRead`/`uniqueFilesRead` via `getSummary()` on-demand iteration, exports `toRunLog(): RunLog` snapshot with ISO 8601 `startTime`/`endTime` and spread-copied entries.

**[run-log.ts](./run-log.ts)** — `writeRunLog(projectRoot: string, runLog: RunLog): Promise<string>` creates `.agents-reverse-engineer/logs/` via `recursive: true`, writes `JSON.stringify(runLog, null, 2)` to `run-${safeCommand}-${safeBackend}-${safeModel}-${safeTimestamp}.json` (sanitizes command/backend/model via `/[^a-z0-9]/g` → `'-'`, timestamp via `/[:.]/g` → `'-'`), returns absolute file path.

## Integration

`src/ai/service.ts` `AIService` instantiates `TelemetryLogger(runId, backend, model, command)` at construction, populates via `addEntry()` after each `runSubprocess()` call wrapped by `src/ai/retry.ts` `withRetry()`, calls `setFilesReadOnLastEntry(filesRead)` after `src/orchestration/runner.ts` `CommandRunner.run()` attaches FileRead metadata, invokes `finalize(projectRoot)` post-execution to write `writeRunLog()` and trigger `cleanupOldLogs(projectRoot, config.ai.telemetry.keepRuns)` retention enforcement.

## Behavioral Contracts

### Timestamp Sanitization
```javascript
safeTimestamp = runLog.startTime.replace(/[:.]/g, '-')
// Transforms ISO 8601 "2026-02-12T15:30:45.123Z" → "2026-02-12T15-30-45-123Z"
```

### Filename Sanitization
```javascript
safeCommand = runLog.command.replace(/[^a-z0-9]/g, '-')
safeBackend = runLog.backend.replace(/[^a-z0-9]/g, '-')
safeModel = runLog.model.replace(/[^a-z0-9]/g, '-')
// Filename format: run-${safeCommand}-${safeBackend}-${safeModel}-${safeTimestamp}.json
```

### Lexicographic Retention
```javascript
entries.sort()           // ASCII sort ascending
entries.reverse()        // Newest first (ISO timestamps sort correctly)
toDelete = entries.slice(keepCount)
```

### Unique File Counting
```javascript
uniqueFilesRead = new Set(entries.flatMap(e => e.filesRead?.map(f => f.path) ?? [])).size
```

### ENOENT Tolerance
```javascript
// cleanup.ts returns 0 without error when logs directory does not exist
```