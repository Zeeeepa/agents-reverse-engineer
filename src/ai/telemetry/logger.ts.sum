---
generated_at: 2026-02-09T14:07:57.873Z
content_hash: 27e3cf98055a02fd64a520570aee7849984b5a99f647427b1d6cedcecf8d88a3
purpose: TelemetryLogger accumulates per-call AI service metrics in memory and computes aggregate statistics for run logs.
---
**TelemetryLogger accumulates per-call AI service metrics in memory and computes aggregate statistics for run logs.**

## Exported Class

`TelemetryLogger` — In-memory accumulator for `TelemetryEntry` instances with summary aggregation and `RunLog` serialization.

**Constructor:**
```typescript
constructor(runId: string)
```
- `runId` — Unique run identifier (ISO timestamp-based)
- Sets `this.startTime` to current ISO 8601 timestamp
- Initializes empty `entries: TelemetryEntry[]` array

**Public Fields:**
```typescript
readonly runId: string
readonly startTime: string
```

**Methods:**

`addEntry(entry: TelemetryEntry): void` — Appends telemetry entry to internal array for completed AI call

`getEntries(): readonly TelemetryEntry[]` — Returns immutable view of accumulated entries

`setFilesReadOnLastEntry(filesRead: FileRead[]): void` — Mutates most recent entry's `filesRead` array after AI service attaches file metadata post-execution (no-op if entries array empty)

`getSummary(): RunLog['summary']` — Computes aggregate statistics across all entries without caching:
- Totals: `totalInputTokens`, `totalOutputTokens`, `totalCacheReadTokens`, `totalCacheCreationTokens`, `totalDurationMs`
- Counts: `totalCalls` (entries length), `errorCount` (entries with defined `error` field), `totalFilesRead`, `uniqueFilesRead` (distinct `FileRead.path` via `Set<string>`)

`toRunLog(): RunLog` — Assembles complete `RunLog` with `endTime` set to current ISO 8601 timestamp, shallow-copied entries array, and computed summary (call once at run completion)

## Integration Points

Consumed by `AIService` in `src/ai/service.ts` for per-invocation telemetry accumulation. Logger instance created once per CLI command execution (runId from timestamp), entries recorded via `addEntry()` after each AI subprocess call, `setFilesReadOnLastEntry()` invoked after command runner attaches file metadata, `toRunLog()` called at CLI termination to produce serializable log for `writeRunLog()` in `src/ai/telemetry/run-log.ts`.

## Type Dependencies

Imports `TelemetryEntry`, `RunLog`, `FileRead` from `../types.js`. `TelemetryEntry` contains per-call metrics (tokens, latency, optional error, filesRead array). `RunLog` contains runId, start/end timestamps, entries array, summary object with nine aggregate fields. `FileRead` contains path, sizeBytes, linesRead for file access tracking.