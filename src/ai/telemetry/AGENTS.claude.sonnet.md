<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/ai/telemetry

Manages AI service call telemetry collection, log persistence, and retention for `.agents-reverse-engineer/logs/` run artifacts.

## Contents

- [`cleanup.ts`](./cleanup.ts): `cleanupOldLogs(projectRoot: string, keepCount: number): Promise<number>` removes oldest `run-*.json` files from `.agents-reverse-engineer/logs/`, sorting lexicographically by ISO timestamp, returning deletion count. Returns 0 on ENOENT.
- [`logger.ts`](./logger.ts): `TelemetryLogger` class accumulates `TelemetryEntry` instances, computes `RunLog.summary` (totalCalls, totalInputTokens, totalOutputTokens, totalCacheReadTokens, totalCacheCreationTokens, totalDurationMs, errorCount, totalFilesRead, uniqueFilesRead). Methods: `addEntry()`, `setFilesReadOnLastEntry()`, `getSummary()`, `toRunLog()`.
- [`run-log.ts`](./run-log.ts): `writeRunLog(projectRoot: string, runLog: RunLog): Promise<string>` writes pretty-printed JSON to `run-{command}-{backend}-{model}-{timestamp}.json` with sanitized filename components (`[:.]/[^a-z0-9]` → `-`), returns absolute path.

## Architecture

**Collection Layer**: `TelemetryLogger` (in-memory chronological array) receives `TelemetryEntry` via `addEntry()`, attaches `FileRead[]` metadata via `setFilesReadOnLastEntry()`, produces `RunLog` via `toRunLog()` (non-cached `getSummary()` aggregation).

**Persistence Layer**: `run-log.ts:writeRunLog()` materializes `RunLog` to filesystem with sanitized naming (`command`/`backend`/`model`/`startTime` fields), creates `LOGS_DIR` if missing.

**Retention Policy**: `cleanup.ts:cleanupOldLogs()` enforces `keepRuns` limit (from `ai.telemetry.keepRuns` config) via lexicographic timestamp sort, deletes overflow.

## Data Flow

1. `src/ai/service.ts` creates `TelemetryLogger(runId, backend, model, command)` per CLI invocation
2. Per AI call: `addEntry(entry)` records `TelemetryEntry` (tokens, latency, success/error)
3. Post-call: `setFilesReadOnLastEntry(filesRead)` attaches `FileRead[]` from prompt context
4. On run completion: `toRunLog()` computes aggregate stats, `writeRunLog()` persists to `logs/`
5. Post-generation: `cleanupOldLogs()` enforces retention policy

## Behavioral Contracts

**Log Directory**: `.agents-reverse-engineer/logs` (constant `LOGS_DIR` in `cleanup.ts`, `run-log.ts`)

**Filename Pattern**: `run-{command}-{backend}-{model}-{timestamp}.json` where timestamp is `runLog.startTime` ISO string with `:/.` replaced by `-`

**Filename Sanitization** (from `run-log.ts`):
```typescript
.replace(/[:.]/g, '-').replace(/[^a-z0-9-]/gi, '-')
```

**Retention Sort Order**: Lexicographic descending by filename (newest first) — relies on ISO 8601 timestamp sortability

**Summary Computation**: No caching — `getSummary()` iterates `entries` array on every call

**Unique Files Deduplication**: `Set<string>` keyed by file path (case-sensitive)

**Error Count**: `entry.success === false` instances summed