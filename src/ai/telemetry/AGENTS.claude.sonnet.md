<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/ai/telemetry

Telemetry subsystem that tracks AI service usage per CLI run, persisting structured logs to `.agents-reverse-engineer/logs/` and managing log retention.

## Contents

- [`cleanup.ts`](./cleanup.ts): `cleanupOldLogs(projectRoot, keepCount)` removes old `run-*.json` files from `.agents-reverse-engineer/logs/`, retaining the N most recent by lexicographic sort on ISO timestamp filenames; returns deletion count or 0 on `ENOENT`.
- [`logger.ts`](./logger.ts): `TelemetryLogger` accumulates `TelemetryEntry[]` in-memory per CLI invocation; exposes `addEntry()`, `setFilesReadOnLastEntry()`, `getEntries()`, `getSummary()` (aggregates `totalInputTokens`, `totalOutputTokens`, `totalCacheReadTokens`, `totalCacheCreationTokens`, `totalDurationMs`, `errorCount`, unique file reads), and `toRunLog()` (finalizes `RunLog` with `startTime`, `endTime`, computed `summary`).
- [`run-log.ts`](./run-log.ts): `writeRunLog(projectRoot, runLog)` serializes `RunLog` to `.agents-reverse-engineer/logs/run-{command}-{backend}-{model}-{timestamp}.json` with 2-space indentation; creates log directory with `recursive: true`; sanitizes timestamp via `.replace(/[:.]/g, '-')`.

## Data Flow

1. CLI commands instantiate `TelemetryLogger` with `runId` (ISO timestamp), `backend`, `model`, `command` at invocation start.
2. AI service calls append `TelemetryEntry` via `addEntry()`; file reads attached to last entry via `setFilesReadOnLastEntry()`.
3. On CLI completion, `toRunLog()` produces immutable `RunLog` snapshot with aggregate `summary`.
4. `writeRunLog()` persists `RunLog` to timestamped JSON file.
5. Post-run, `cleanupOldLogs()` enforces retention policy per `config.yaml` `ai.telemetry.keepRuns`.

## Behavioral Contracts

**Log filename pattern** (from `run-log.ts`):
```
run-{command}-{backend}-{model}-{timestamp}.json
```
where `timestamp` is ISO 8601 with `:` and `.` replaced by `-` (regex: `.replace(/[:.]/g, '-')` followed by `.replace(/[^a-z0-9]/g, '-')`).

**Logs directory constant** (from `cleanup.ts`):
```
LOGS_DIR = '.agents-reverse-engineer/logs'
```

**JSON encoding** (from `run-log.ts`):
```javascript
JSON.stringify(runLog, null, 2)
```

**Summary aggregation fields** (from `logger.ts`):
- `totalCalls`, `totalInputTokens`, `totalOutputTokens`, `totalCacheReadTokens`, `totalCacheCreationTokens`, `totalDurationMs`, `errorCount` (sum across entries)
- `totalFilesRead`, `uniqueFilesRead` (deduplicated by `file.path`)

## File Relationships

- `logger.ts` imports `TelemetryEntry`, `RunLog`, `FileRead` from `../types.js`
- `run-log.ts` imports `RunLog` from `../types.js`
- `cleanup.ts` has no cross-module imports; operates on filesystem via `LOGS_DIR` constant
- `logger.ts` produces `RunLog` consumed by `run-log.ts` `writeRunLog()`
- `cleanup.ts` prunes files created by `run-log.ts` based on retention count