<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/ai/telemetry

Accumulates and persists telemetry data from AI service calls during CLI execution, providing cleanup and storage for run logs with aggregated metrics.

## Contents

**Telemetry accumulation:**
- [logger.ts](./logger.ts) — `TelemetryLogger` class accumulates `TelemetryEntry` objects and computes aggregate `RunLog` summaries (token counts, durations, error counts, file tracking).

**Telemetry persistence:**
- [run-log.ts](./run-log.ts) — `writeRunLog()` serializes completed `RunLog` to disk as pretty-printed JSON in `.agents-reverse-engineer/logs/` with sanitized filenames.

**Telemetry maintenance:**
- [cleanup.ts](./cleanup.ts) — `cleanupOldLogs()` removes old `run-*.json` log files, retaining only the N most recent by lexicographic (ISO timestamp) ordering.

## Data Flow

1. During CLI execution: `TelemetryLogger` instance accumulates calls via `addEntry(entry: TelemetryEntry)`
2. File reads deferred: `setFilesReadOnLastEntry(filesRead: FileRead[])` patches final entry after command completion
3. Run completion: `toRunLog()` snapshots current state with `endTime` and aggregates via `getSummary()`
4. Persistence: `writeRunLog()` writes `RunLog` JSON to disk with `startTime`-derived filename
5. Maintenance: `cleanupOldLogs()` prunes logs directory to retain only `keepCount` most recent runs

## Behavioral Contracts

**Filename sanitization** (`run-log.ts`): Replaces non-alphanumeric characters in command, backend, model with `-`, and `:` / `.` in ISO timestamp with `-`. Pattern: `run-{safeCommand}-{safeBackend}-{safeModel}-{safeTimestamp}.json`. Example: `run-generate-claude-sonnet-2026-02-07T12-00-00-000Z.json`.

**Log retention** (`cleanup.ts`): Filters entries by glob `run-*.json`, sorts lexicographically (newest first via reverse), slices to `keepCount`, deletes remainder. ISO timestamp filenames guarantee correct chronological ordering.

**Aggregation** (`logger.ts`): `getSummary()` computes fresh aggregates on each call (not cached): `totalCalls`, `totalInputTokens`, `totalOutputTokens`, `totalCacheReadTokens`, `totalCacheCreationTokens`, `totalDurationMs`, `errorCount`, `totalFilesRead`, `uniqueFilesRead`.

## Configuration

- `LOGS_DIR` constant: `.agents-reverse-engineer/logs` — relative path from project root for all telemetry operations.
- Directory auto-created by `writeRunLog()` if missing; `cleanupOldLogs()` returns 0 if directory absent (ENOENT handled gracefully).