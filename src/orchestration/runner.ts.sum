---
generated_at: 2026-02-09T15:08:49.519Z
content_hash: de27101980410fdd151600c2437ed1304b0f82022289c1be39ce621cc324d670
purpose: CommandRunner orchestrates the three-phase AI-driven documentation generation pipeline: concurrent file analysis writ...
---
**CommandRunner orchestrates the three-phase AI-driven documentation generation pipeline: concurrent file analysis writing `.sum` files, post-order directory aggregation producing `AGENTS.md`, and sequential root document synthesis generating `CLAUDE.md`.**

## Exported Classes

**CommandRunner** — Main orchestration class managing execution of `generate` and `update` commands. Constructor accepts `aiService: AIService` and `options: CommandRunOptions`. Holds private fields `aiService`, `options`, `tracer`, and computed getter `progressLog` returning `options.progressLog`.

### executeGenerate Method

**executeGenerate(plan: ExecutionPlan): Promise<RunSummary>** — Executes full three-phase generation pipeline with quality validation. Returns aggregated statistics including token counts, inconsistency metrics, and phantom path counts.

**Phase breakdown:**
- **Pre-Phase 1 (Cache)**: Reads existing `.sum` files into `oldSumCache: Map<string, SumFileContent>` via throttled pool (concurrency=20) calling `readSumFile()` for stale documentation detection
- **Phase 1 (Files)**: Concurrent file analysis via `runPool(fileTasks, {concurrency})` where each task reads source via `readFile()`, calls `this.aiService.call()`, computes `contentHash` via `computeContentHashFromString()`, writes `.sum` via `writeSumFile()`, caches content in `sourceContentCache: Map<string, string>` for quality checks
- **Post-Phase 1 (Quality)**: Groups files by directory via `Map<string, string[]>`, runs throttled pool (concurrency=10) executing `checkCodeVsDoc()` twice (old-doc for stale detection with `'(stale documentation)'` suffix, new-doc for LLM omissions), then `checkCodeVsCode()` per directory group. Builds `InconsistencyReport` via `buildInconsistencyReport()`, prints via `formatReportForCli()`
- **Phase 2 (Directories)**: Groups `plan.directoryTasks` by depth via `Map<number, typeof plan.directoryTasks>`, processes in descending depth order (deepest first = post-order). For each depth level, runs pool with `dirConcurrency = Math.min(this.options.concurrency, dirsAtDepth.length)`, builds prompts via `buildDirectoryPrompt()` passing `knownDirs: Set<string>` and `plan.projectStructure`, writes output via `writeAgentsMd()`
- **Post-Phase 2 (Phantom Paths)**: Reads `AGENTS.md` from each `dirTask.absolutePath`, calls `checkPhantomPaths()`, aggregates issues into `phantomReport` via `buildInconsistencyReport()`
- **Phase 3 (Root)**: Sequential execution (no pool) of `plan.rootTasks`, builds prompt via `buildRootPrompt()`, strips conversational preamble by finding first `# ` header index and removing preceding non-markdown text, writes to `rootTask.outputPath` via `writeFile()`

**Tracer integration:** Emits `phase:start`, `phase:end`, `task:start`, `task:done` events with metadata including `taskCount`, `concurrency`, `durationMs`, `tasksCompleted`, `tasksFailed`. Sets tracer on `aiService` via `this.aiService.setTracer(this.tracer)` for subprocess/retry events.

**Progress tracking:** Creates `ProgressReporter(plan.fileTasks.length, plan.directoryTasks.length, this.progressLog)`, calls `onFileStart()`, `onFileDone()`, `onFileError()`, `onDirectoryStart()`, `onDirectoryDone()`, `onRootDone()`, `printSummary()`. Creates `PlanTracker` writing `GENERATION-PLAN.md` via `formatExecutionPlanAsMarkdown()`, calls `markDone()` for each completed task, flushes via `planTracker.flush()`.

**Telemetry:** Tracks file sizes via `this.aiService.addFilesReadToLastEntry([{path, sizeBytes}])` using `Buffer.byteLength()` on in-memory content to avoid `stat()` syscalls.

**RunSummary fields:** `version` (via `getVersion()`), `filesProcessed`, `filesFailed`, `filesSkipped`, `totalCalls`, `totalInputTokens`, `totalOutputTokens`, `totalCacheReadTokens`, `totalCacheCreationTokens`, `totalDurationMs`, `errorCount`, `retryCount`, `totalFilesRead`, `uniqueFilesRead`, `inconsistenciesCodeVsDoc`, `inconsistenciesCodeVsCode`, `phantomPaths`, `inconsistencyReport`.

### executeUpdate Method

**executeUpdate(filesToAnalyze: FileChange[], projectRoot: string, config: Config): Promise<RunSummary>** — Runs Phase 1 (file analysis) only for changed files. Attempts to load `GENERATION-PLAN.md` from `CONFIG_DIR` for project context, passes as `projectPlan` to `buildFilePrompt()`. Reads existing `.sum` via `readSumFile()`, passes as `existingSum` to prompt builder for incremental update context. Runs post-analysis quality checks identical to `executeGenerate` Post-Phase 1 (groups by directory, throttled pool with concurrency=10, `checkCodeVsDoc` + `checkCodeVsCode`). Does NOT regenerate directory or root documents (caller handles `AGENTS.md` regeneration for affected directories).

**Cache management:** Stores source content in `updateSourceCache: Map<string, string>` during analysis, reuses for quality checks, clears via `.clear()` after inconsistency detection to free memory.

## Helper Functions

**stripPreamble(responseText: string): string** — Removes LLM conversational preamble via two patterns: (1) content after `\n---\n` separator if found within 500 chars, (2) content starting at first bold pattern `**[A-Z]` if preceded by short (<300 chars) non-markdown text.

**extractPurpose(responseText: string): string** — Extracts first non-header, non-separator, non-preamble line from response. Skips lines starting with `#` or `---`, filters lines matching `PREAMBLE_PREFIXES` array (`'now i'`, `'perfect'`, `'based on'`, `'let me'`, `'here is'`, `'i\'ll'`, `'i will'`, `'great'`, `'okay'`, `'sure'`, `'certainly'`, `'alright'`). Strips bold markdown wrapper via `/^\*\*(.+)\*\*$/` regex, truncates to 120 chars with `'...'` suffix if needed.

**PREAMBLE_PREFIXES** — String array constant defining case-insensitive prefixes indicating LLM preamble sentences.

## Integration Points

**Dependencies:**
- `AIService` from `../ai/index.js` for LLM calls with `call()`, `setTracer()`, `getSummary()`, `addFilesReadToLastEntry()`
- `ExecutionPlan`, `ExecutionTask` from `../generation/executor.js` defining task structure
- `writeSumFile()`, `readSumFile()`, `SumFileContent` from `../generation/writers/sum.js` for `.sum` YAML frontmatter files
- `writeAgentsMd()` from `../generation/writers/agents-md.js` for directory-level aggregation
- `buildFilePrompt()`, `buildDirectoryPrompt()`, `buildRootPrompt()` from `../generation/prompts/index.js` for prompt construction
- `runPool()` from `./pool.js` for iterator-based worker pool execution
- `PlanTracker` from `./plan-tracker.js` for serialized `GENERATION-PLAN.md` updates
- `ProgressReporter` from `./progress.js` for terminal and log file output
- `ITraceWriter` from `./trace.js` for NDJSON event emission
- `checkCodeVsDoc()`, `checkCodeVsCode()`, `checkPhantomPaths()`, `buildInconsistencyReport()`, `formatReportForCli()` from `../quality/index.js` for validation
- `computeContentHashFromString()` from `../change-detection/index.js` for SHA-256 hashing
- `FileChange` from `../change-detection/types.js` for update workflow
- `getVersion()` from `../version.ts` for run summary metadata
- `CONFIG_DIR` from `../config/loader.js` for plan file path resolution

**Exports used by:**
- `src/cli/generate.ts` creates `CommandRunner` instance, calls `executeGenerate()` with plan from orchestrator
- `src/cli/update.ts` creates `CommandRunner` instance, calls `executeUpdate()` with change detection results

## Quality Validation Pipeline

**Code-vs-Doc inconsistencies:** Detects missing exports in `.sum` summaries by comparing regex-extracted symbols (`checkCodeVsDoc()`) against substring search in documentation. Runs twice: old-doc check compares source against cached `oldSumCache` entries (appends `'(stale documentation)'` to description), new-doc check compares against freshly written `.sum` files.

**Code-vs-Code inconsistencies:** Detects duplicate export symbols across files within same directory group via `checkCodeVsCode()` aggregating into `Map<symbol, string[]>`.

**Phantom paths:** Validates markdown link targets, backtick-quoted paths, prose-embedded paths in `AGENTS.md` via `checkPhantomPaths()` with filesystem resolution and `.ts`/`.js` fallback.

**Non-throwing design:** All quality checks wrapped in `try-catch` logging errors via `console.error()` without breaking pipeline execution. Metrics (`inconsistenciesCodeVsDoc`, `inconsistenciesCodeVsCode`, `phantomPathCount`) included in `RunSummary` even on validator failure.

## Resource Management

**Memory optimization:**
- `sourceContentCache` and `updateSourceCache` cleared via `.clear()` after quality checks to release multi-MB string content
- File sizes computed from in-memory `Buffer.byteLength()` instead of filesystem `stat()` to avoid syscall overhead
- Content hash computed from already-loaded `sourceContent` string to prevent double reads

**Concurrency throttling:**
- Phase 1: Configurable via `options.concurrency` (default 2 WSL, 5 elsewhere)
- Phase 2: Per-depth-level with `Math.min(concurrency, dirsAtDepth.length)` to avoid over-allocation
- Phase 3: Sequential (concurrency=1) for root documents
- Quality checks: Hardcoded concurrency=10 for directory-group validation, concurrency=20 for `.sum` cache reads

**Pool integration:** All concurrent phases use `runPool()` with callbacks receiving `PoolResult<T>` discriminated unions (`success: true` with `value`, or `success: false` with `error`), updating counters (`filesProcessed++`, `filesFailed++`) and reporters (`onFileDone()`, `onFileError()`).