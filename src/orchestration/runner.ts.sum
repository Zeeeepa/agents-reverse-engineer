---
generated_at: 2026-02-09T16:11:43.268Z
content_hash: de27101980410fdd151600c2437ed1304b0f82022289c1be39ce621cc324d670
purpose: CommandRunner orchestrates AI-driven three-phase documentation generation (file analysis, directory AGENTS.md aggrega...
---
**CommandRunner orchestrates AI-driven three-phase documentation generation (file analysis, directory AGENTS.md aggregation, root document synthesis) with concurrency pool execution, quality validation, telemetry integration, and trace emission.**

## Exported Classes

**CommandRunner** — Main orchestration class accepting `AIService` instance and `CommandRunOptions`, exposes `executeGenerate(plan: ExecutionPlan): Promise<RunSummary>` for full three-phase generation and `executeUpdate(filesToAnalyze: FileChange[], projectRoot: string, config: Config): Promise<RunSummary>` for incremental file re-analysis.

Constructor accepts `aiService: AIService` and `options: CommandRunOptions`, optionally wires `options.tracer` into AI service via `setTracer()` for subprocess/retry event emission.

## Three-Phase Execution Pipeline

**Phase 1: File Analysis (executeGenerate lines 84-259)** — Pre-phase caches existing `.sum` files via `readSumFile()` at concurrency=20 for stale-doc detection. Maps file tasks to async functions reading source via `readFile()`, computing `contentHash` via `computeContentHashFromString()`, calling `aiService.call()` with `buildFilePrompt()` output, stripping preamble via `stripPreamble()`, extracting purpose via `extractPurpose()`, constructing `SumFileContent` with `generatedAt`/`contentHash`/`summary`/`metadata.purpose`, writing via `writeSumFile()`. Executes via `runPool(fileTasks, { concurrency, failFast, tracer, phaseLabel: 'phase-1-files', taskLabels })` with progress callback invoking `reporter.onFileDone()` and `planTracker.markDone()`. Caches `sourceContent` in `Map<string, string>` for quality checks.

**Post-Phase 1 Quality (lines 261-362)** — Groups processed files by directory via `path.dirname()` into `Map<string, string[]>`. Runs throttled (concurrency=10) validation per directory group: reads cached source content, compares against old `.sum` via `checkCodeVsDoc(sourceContent, oldSum, filePath)` appending `(stale documentation)` label, reads fresh `.sum` via `readSumFile()` and runs second `checkCodeVsDoc()` pass, aggregates `filesForCodeVsCode` array and runs `checkCodeVsCode()` for duplicate symbol detection. Flattens results, builds `InconsistencyReport` via `buildInconsistencyReport()`, prints via `formatReportForCli()`, clears `sourceContentCache`.

**Phase 2: Directory AGENTS.md (lines 364-445)** — Groups `plan.directoryTasks` by `metadata.depth` into `Map<number, ExecutionTask[]>`, sorts depth levels descending (deepest-first post-order traversal). For each depth level: builds `phaseLabel` as `phase-2-dirs-depth-${depth}`, computes `dirConcurrency = Math.min(options.concurrency, dirsAtDepth.length)`, emits `phase:start` trace event, maps directory tasks to async functions calling `buildDirectoryPrompt(dirTask.absolutePath, projectRoot, debug, knownDirs, projectStructure)` with `knownDirs` set for filtering, calls `aiService.call()` with prompt, writes via `writeAgentsMd(dirTask.absolutePath, projectRoot, dirResponse.text)`, updates reporter and plan tracker. Executes via `runPool()` with `phaseLabel`/`taskLabels`, emits `phase:end` with `tasksCompleted`/`tasksFailed` counts.

**Post-Phase 2 Quality (lines 447-467)** — Iterates `plan.directoryTasks`, reads `AGENTS.md` via `readFile(path.join(dirTask.absolutePath, 'AGENTS.md'))`, runs `checkPhantomPaths(agentsMdPath, content, projectRoot)`, aggregates issues, builds `phantomReport` via `buildInconsistencyReport()`, prints via `formatReportForCli()`. Non-throwing with catch-all error handler.

**Phase 3: Root Documents (lines 469-532)** — Sequential execution (concurrency=1) over `plan.rootTasks`. Emits `task:start` trace event, calls `buildRootPrompt(projectRoot, debug)` with all AGENTS.md injected, calls `aiService.call({ prompt, systemPrompt, maxTurns: 1 })`, strips conversational preamble via `content.indexOf('# ')` slice if leading content lacks `#` or `<!--`, writes via `writeFile(rootTask.outputPath, content)`, emits `task:done` with `workerId: 0`/`success`/`error`, updates reporter and plan tracker. Flushes `planTracker` via `await planTracker.flush()` after loop.

## Incremental Update Execution

**executeUpdate(filesToAnalyze, projectRoot, config)** — Phase 1 only implementation for changed file re-analysis. Attempts to load `GENERATION-PLAN.md` from `.agents-reverse-engineer/` via `path.join(projectRoot, CONFIG_DIR, 'GENERATION-PLAN.md')` for `projectPlan` context (falls through on error). Maps `filesToAnalyze` to async tasks reading source via `readFile()`, reading existing `.sum` via `readSumFile()`, building prompt via `buildFilePrompt({ filePath, content, projectPlan, existingSum })`, calling AI service, writing `.sum` with hash. Caches source in `updateSourceCache`. Runs post-analysis quality checks (lines 616-717) identical to generate flow but without stale-doc comparison. Builds `RunSummary` with `updateInconsistenciesCodeVsDoc`/`updateInconsistenciesCodeVsCode` from `report.summary`.

## Helper Functions

**stripPreamble(responseText: string): string** — Pattern 1: detects `\n---\n` separator within first 500 chars, returns content after. Pattern 2: regex `/^[\s\S]{0,500}?(\*\*[A-Z])/` matches bold uppercase start, strips preceding content if <300 chars and no `##` markdown headers. Returns original text if no patterns match.

**extractPurpose(responseText: string): string** — Splits on newlines, skips empty/`#`/`---` lines, filters lines starting with `PREAMBLE_PREFIXES` array (`['now i', 'perfect', 'based on', 'let me', 'here is', 'i\'ll', 'i will', 'great', 'okay', 'sure', 'certainly', 'alright']`) via `lower.startsWith()` checks, strips bold markdown via `.replace(/^\*\*(.+)\*\*$/, '$1')`, truncates to 120 chars with `...` suffix. Returns empty string if no valid line found.

## Integration Points

**Dependencies:** `AIService` from `../ai/index.js`, `ExecutionPlan`/`ExecutionTask` from `../generation/executor.js`, `writeSumFile`/`readSumFile` from `../generation/writers/sum.js`, `writeAgentsMd` from `../generation/writers/agents-md.js`, `buildFilePrompt`/`buildDirectoryPrompt`/`buildRootPrompt` from `../generation/prompts/index.js`, `runPool` from `./pool.js`, `PlanTracker` from `./plan-tracker.js`, `ProgressReporter` from `./progress.js`, `ITraceWriter` from `./trace.js`, `checkCodeVsDoc`/`checkCodeVsCode`/`checkPhantomPaths`/`buildInconsistencyReport`/`formatReportForCli` from `../quality/index.js`, `computeContentHashFromString` from `../change-detection/index.js`, `getVersion` from `../version.js`.

**Configuration:** `CommandRunOptions` with `concurrency` (worker pool size), `failFast` (abort on first error), `debug` (verbose prompts), `tracer` (ITraceWriter instance), `progressLog` (Writable stream for mirrored output). `Config` type threaded through `executeUpdate` for prompt building.

**Telemetry:** Calls `aiService.addFilesReadToLastEntry([{ path, sizeBytes }])` after each AI call to track file metadata. Calls `aiService.getSummary()` for aggregated token/cost/duration counts. Emits trace events via `tracer?.emit()`: `phase:start/end` with `taskCount`/`concurrency`/`durationMs`/`tasksCompleted`/`tasksFailed`, `task:start` with `taskLabel`/`phase`, `task:done` with `workerId`/`taskIndex`/`durationMs`/`success`/`error`/`activeTasks`.

## Error Handling

**Quality Validation Non-Throwing:** Both post-Phase 1 inconsistency detection (lines 261-362 generate, 616-717 update) and post-Phase 2 phantom path validation (lines 447-467) wrapped in try-catch blocks logging `[quality] Inconsistency detection failed: ${err.message}` or `[quality] Phantom path validation failed:` without propagating errors.

**Pool Error Handling:** Delegates to `runPool()` with `failFast` option. Progress callback distinguishes `result.success` vs `result.error`, invokes `reporter.onFileDone()` for success and `reporter.onFileError(taskPath, errorMsg)` for failure, increments `filesProcessed`/`filesFailed` counters.

**Root Task Errors:** Phase 3 sequential loop wraps each task in try-catch, increments `rootTasksFailed`, emits `task:done` with `success: false`/`error`, re-throws to maintain existing error handling.

## RunSummary Construction

**Fields:** `version` (from `getVersion()`), `filesProcessed`/`filesFailed`/`filesSkipped`, `totalCalls`/`totalInputTokens`/`totalOutputTokens`/`totalCacheReadTokens`/`totalCacheCreationTokens` (from `aiService.getSummary()`), `totalDurationMs` (`Date.now() - runStart`), `errorCount`, `retryCount: 0` (hardcoded), `totalFilesRead`/`uniqueFilesRead`, `inconsistenciesCodeVsDoc`/`inconsistenciesCodeVsCode`/`phantomPaths`, `inconsistencyReport`. Printed via `reporter.printSummary(summary)`.