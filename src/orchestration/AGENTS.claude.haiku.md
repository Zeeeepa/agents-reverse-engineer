<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/orchestration

The orchestration module coordinates AI-driven documentation generation and incremental updates across the entire project. It manages task scheduling, progress reporting, plan tracking, concurrent execution, and lifecycle tracing for both full-project generation (are generate) and change-detection-driven updates (are update) workflows.

## Contents

**Core Exports**
- [index.ts](./index.ts) — Barrel export aggregating CommandRunner, ProgressReporter, runPool, PlanTracker, trace utilities (createTraceWriter, cleanupOldTraces) and shared types (FileTaskResult, RunSummary, ProgressEvent, CommandRunOptions, PoolOptions, TaskResult, ITraceWriter, TraceEvent, TraceEventPayload).

**Orchestration & Planning**
- [orchestrator.ts](./orchestrator.ts) — DocumentationOrchestrator unifies generation (createPlan, prepareFiles, buildProjectStructure, filterExistingFiles, filterExistingDirectories, createDirectoryTasks) and update (preparePlan, checkPrerequisites, discoverFiles, recordFileAnalyzed, removeFileState, recordRun, getLastRun, isFirstRun) workflows; createFileTasks handles both PreparedFile and FileChange arrays polymorphically; emits tracer events (phase:start, phase:end, plan:created) throughout execution.
- [plan-tracker.ts](./plan-tracker.ts) — PlanTracker maintains in-memory markdown and serializes disk writes to GENERATION-PLAN.md via promise-chain queue; markDone replaces checkbox strings (`- [ ] \`path\`` → `- [x] \`path\``); flush awaits completion; writes to `${projectRoot}/${CONFIG_DIR}/GENERATION-PLAN.md`.

**Execution & Concurrency**
- [runner.ts](./runner.ts) — CommandRunner orchestrates two-phase AI generation: Phase 1 (concurrent file analysis via runPool calling aiService.call, writing .sum and annex files) with post-phase-1 quality checks (checkCodeVsDoc, checkCodeVsCode, checkPhantomPaths); Phase 2 (post-order directory aggregation via buildDirectoryPrompt, writeAgentsMd, writeAgentsMdHub, writeClaudeMdPointer); executeGenerate handles full workflow, executeUpdate processes changed files only; caches old .sum files (oldSumCache) and Phase 1 source reads (sourceContentCache) for stale-doc detection and quality checks; returns RunSummary with token counts, duration, error metrics, inconsistency counts, and phantom paths.
- [pool.ts](./pool.ts) — runPool executes async task factories with bounded concurrency using shared iterator; all workers pull from same iterator so tasks run exactly once; sparse result array indexed by original position; supports failFast abort and tracer events (worker:start, task:pickup, task:done, worker:end); no external dependencies.

**Progress & Observability**
- [progress.ts](./progress.ts) — ProgressLog streams analysis output to `.agents-reverse-engineer/progress.log` without ANSI codes for `tail -f` monitoring via promise-chain serialization; ProgressReporter logs file/directory analysis with ETA calculation via moving-average windows (onFileStart, onFileDone, onFileError, onDirectoryStart, onDirectoryDone, printSummary); formats `[X/Y] ANALYZING`, `[X/Y] DONE Xs in/out tok model ~ETA`, `[X/Y] FAIL` messages via picocolors.
- [trace.ts](./trace.ts) — ITraceWriter appends NDJSON events to `.agents-reverse-engineer/traces/trace-{ISO8601-timestamp}.ndjson` with promise-chain serialization; TraceEvent discriminated union covers PhaseStartEvent, PhaseEndEvent, WorkerStartEvent, WorkerEndEvent, TaskPickupEvent, TaskDoneEvent, TaskStartEvent, SubprocessSpawnEvent, SubprocessExitEvent, RetryEvent, DiscoveryStartEvent, DiscoveryEndEvent, FilterAppliedEvent, PlanCreatedEvent, ConfigLoadedEvent; createTraceWriter returns NullTraceWriter (zero-cost) when disabled; cleanupOldTraces deletes oldest files beyond retention limit.

**Type Definitions**
- [types.ts](./types.ts) — FileTaskResult (path, success, tokensIn, tokensOut, cacheReadTokens, cacheCreationTokens, durationMs, model, optional error); RunSummary (version, filesProcessed/filesFailed/filesSkipped, dirsProcessed/dirsFailed/dirsSkipped, totalCalls, totalInputTokens, totalOutputTokens, totalCacheReadTokens, totalCacheCreationTokens, totalDurationMs, errorCount, retryCount, totalFilesRead, uniqueFilesRead, inconsistenciesCodeVsDoc, inconsistenciesCodeVsCode, phantomPaths, inconsistencyReport); ProgressEvent (type: 'start'|'done'|'error'|'dir-done' with event-specific fields); CommandRunOptions (concurrency, failFast, debug, dryRun, tracer, progressLog, variant).

## Execution Workflows

**Generation (are generate)**
1. DocumentationOrchestrator.createPlan: prepareFiles → filterExistingFiles → analyzeComplexity → buildProjectStructure → createFileTasks → filterExistingDirectories → createDirectoryTasks; emits phase:start, plan:created, phase:end.
2. CommandRunner.executeGenerate Phase 1: reads oldSumCache (readSumFile, getSumPath) → concurrent file analysis via runPool (aiService.call) → writes .sum and annex files (writeSumFile, writeAnnexFile) → post-phase-1-quality directory checks (checkCodeVsDoc, checkCodeVsCode, buildInconsistencyReport) via runPool (throttled 10 concurrent).
3. Phase 2: post-order directory aggregation by depth (descending) → buildDirectoryPrompt → writeAgentsMd → writeAgentsMdHub (variant mode) → writeClaudeMdPointer; final validation checkPhantomPaths.

**Update (are update)**
1. DocumentationOrchestrator.preparePlan: checkPrerequisites (throws if not git repo) → discoverFiles → iterate each file, read .sum frontmatter hash (readSumFile) → computeContentHash → compare with stored content_hash → mark 'added'/'modified'; cleanupOrphans for deleted files; getAffectedDirectories for AGENTS.md regeneration; sets isFirstRun if all files added.
2. CommandRunner.executeUpdate: Phase 1 only (file analysis) for changed files (filesToAnalyze); skips Phase 2 (AGENTS.md/CLAUDE.md regeneration).

## Concurrency & Scaling

- **Phase 1**: runPool with configurable concurrency; pre-phase-1-cache throttled to 20 concurrent file descriptor opens; post-phase-1-quality directory checks throttled to 10.
- **Phase 2**: grouped by metadata.depth, each depth level processed with min(concurrency, dirCount) workers; post-order traversal ensures children process before parents.
- **Serialization**: ProgressLog, PlanTracker, TraceWriter all use promise-chain writeQueue to serialize concurrent writes and maintain output/file order.

## State & Caching

- **CommandRunner**: oldSumCache (pre-existing .sum files for stale-doc detection), sourceContentCache (Phase 1 file reads to avoid I/O in post-phase-1-quality), planTracker (GENERATION-PLAN.md progress), progressReporter (moving-average ETA calculation).
- **DocumentationOrchestrator**: frontmatter-based hash storage in .sum files (no persistent database); isFirstRun derived from plan metrics.
- **ProgressReporter**: completionTimes and dirCompletionTimes sliding windows (max 10) for ETA estimation.

## Behavioral Contracts

- **Trace filename format**: `trace-{ISO8601-timestamp}.ndjson` with colons and periods replaced by hyphens (e.g., `trace-2024-12-14T10-30-45-123Z.ndjson`).
- **NDJSON event serialization**: Each TraceEvent written as single JSON line (`JSON.stringify(event) + '\n'`) with auto-populated seq, ts, pid, elapsedMs fields.
- **Checkbox format**: PlanTracker.markDone performs literal string replacement on `- [ ] \`${itemPath}\`` (files: `src/cli/init.ts`, directories: `src/cli/AGENTS.md`, pointers: `CLAUDE.md`).
- **Progress log format**: `[X/Y] ANALYZING path`, `[X/Y] DONE path Xs in/out tok model [~ETA]`, `[X/Y] FAIL path error`; directory: `[dir X/Y] ANALYZING dirPath/AGENTS.md`.
- **ETA calculation**: moving-average window (≥2 completions required); formatted as seconds if <60, else as `Xm Ys remaining`.
- **Token accounting**: total input = tokensIn + cacheReadTokens + cacheCreationTokens; tracked separately in RunSummary.
- **Variant mode**: optional variant parameter affects .sum path (getSumPath), AGENTS.md filename (AGENTS.${variant}.md), triggers writeAgentsMdHub after writeAgentsMd.
- **Preamble stripping**: stripPreamble removes text before `\n---\n` (if offset <500) or before first bold header `**[A-Z]` (if preceding text <300 chars and lacks `##`).
- **Purpose extraction**: extractPurpose skips preamble lines (now i, perfect, based on, let me, here is, i'll, i will, great, okay, sure, certainly, alright), markdown headers, dashes; strips bold wrapper; truncates >120 chars to 117 + '...'.
- **Content hash format**: computeContentHash and computeContentHashFromString produce hex digests; stored in .sum frontmatter as `content_hash` field for comparison with preparePlan.
- **ANSI stripping**: ProgressLog.stripAnsi removes `/\x1b\[[0-9;]*m/g` escape sequences for plain-text output.
- **Trace cleanup**: sorts by lexicographic filename (ISO timestamps sort correctly); keeps `keepCount` most recent entries; silently handles missing directory.

## Integration Points

- **AI Service**: CommandRunner.executeGenerate calls aiService.call(systemPrompt, userPrompt) → AIResponse with response, tokensIn, tokensOut, cacheReadTokens, cacheCreationTokens, model.
- **File Analysis**: buildFilePrompt (../generation/prompts) generates prompts with existingSum (from readSumFile), sourceFileSize, compressionRatio; analyzeComplexity produces ComplexityMetrics.
- **Directory Aggregation**: buildDirectoryPrompt accepts knownDirs Set for filtering; variant mode triggers writeAgentsMdHub.
- **Quality Checks**: checkCodeVsDoc, checkCodeVsCode, checkPhantomPaths, buildInconsistencyReport, formatReportForCli from ../quality.
- **Change Detection**: isGitRepo, getCurrentCommit, computeContentHash, FileChange from ../change-detection; computeContentHashFromString for .sum frontmatter comparison.
- **Update Lifecycle**: cleanupOrphans, getAffectedDirectories from ../update; UpdatePlanOptions, CleanupResult types.
- **Discovery**: discoverFiles as runDiscovery from ../discovery/run.
- **Config**: Config.generation.compressionRatio setting; CONFIG_DIR from ../config/loader for GENERATION-PLAN.md path.
- **Logging**: Logger type; nullLogger default; debug flag triggers logger.debug([debug] prefix) output.
- **Version**: getVersion from ../version for RunSummary.version field.

## Variant & Annex Support

- **Variant Mode**: optional CommandRunOptions.variant parameter (eval model name string) routes .sum files via getSumPath(path, variant), renames AGENTS.md to AGENTS.${variant}.md, triggers writeAgentsMdHub after writeAgentsMd.
- **Annex Detection**: stripPreamble checks if cleaned text includes `'## Annex References'` to trigger writeAnnexFile(absolutePath, sourceContent, variant) for reproduction-critical constants.