---
generated_at: 2026-02-09T14:09:36.401Z
content_hash: 42c09530c03faf24c901c3a010c351a0a9bdabf54d884aca3f1e01ecece26b8d
purpose: Iterator-based worker pool executing async tasks with shared-iterator concurrency limiting, fail-fast abort, per-task...
---
**Iterator-based worker pool executing async tasks with shared-iterator concurrency limiting, fail-fast abort, per-task result tracking, and trace event emission.**

## Exported Functions

### runPool<T>

```typescript
async function runPool<T>(
  tasks: Array<() => Promise<T>>,
  options: PoolOptions,
  onComplete?: (result: TaskResult<T>) => void,
): Promise<TaskResult<T>[]>
```

Executes array of async task factories through concurrency-limited pool using shared-iterator pattern where all workers iterate over single `tasks.entries()` iterator so each task executes exactly once. Workers pull next task immediately upon completion, avoiding batch-chunking idle time. Returns `TaskResult<T>[]` indexed by original task position (may be sparse if `failFast` aborts early). Invokes `onComplete` callback after each task settles. Spawns `Math.min(options.concurrency, tasks.length)` workers via `Promise.allSettled()`. Uses `aborted` flag checked before each `iterator` pull to stop work on first error when `options.failFast` is true.

## Exported Interfaces

### PoolOptions

```typescript
interface PoolOptions {
  concurrency: number;
  failFast?: boolean;
  tracer?: ITraceWriter;
  phaseLabel?: string;
  taskLabels?: string[];
}
```

Configuration for `runPool` execution. `concurrency` caps parallel worker count. `failFast` stops pulling new tasks on first error. `tracer` writes trace events (worker:start/end, task:pickup/done) for debugging. `phaseLabel` tags trace events with phase identifier (e.g., 'phase-1-files'). `taskLabels` provides human-readable labels per task index for trace events (e.g., file paths).

### TaskResult<T>

```typescript
interface TaskResult<T> {
  index: number;
  success: boolean;
  value?: T;
  error?: Error;
}
```

Discriminated union result for single task execution. `index` correlates result to original task array position. `success: true` includes `value`, `success: false` includes `error`. Used as array return type from `runPool` and as parameter to `onComplete` callback.

## Worker Pattern Implementation

Internal `worker()` async function consumes shared `iterator` until exhaustion or `aborted` flag set. Each worker maintains `tasksExecuted` counter emitted in `worker:end` trace event. Increments `activeTasks` counter before task execution, decrements after settle (both success and error paths). Wraps non-Error rejections via `err instanceof Error ? err : new Error(String(err))`. Emits `task:pickup` with `activeTasks` snapshot before execution, `task:done` with `durationMs` and `success` boolean after settle.

## Trace Event Types

Emits six event types via `tracer.emit()`:
- `worker:start`: `{ workerId, phase }`
- `worker:end`: `{ workerId, phase, tasksExecuted }`
- `task:pickup`: `{ workerId, taskIndex, taskLabel, activeTasks }`
- `task:done`: `{ workerId, taskIndex, taskLabel, durationMs, success, activeTasks, error? }`

Uses `Date.now()` for duration measurement. `taskLabel` defaults to `'task-${index}'` when `taskLabels` array absent or index out of bounds. `phaseLabel` defaults to `'unknown'` when not provided.

## Integration Points

Imports `ITraceWriter` from `./trace.js` for telemetry integration. Used by `src/generation/executor.ts` Phase 1 file analysis (parallel `.sum` generation) and `src/update/orchestrator.ts` incremental update workflow. Receives `AIService.call()` wrapped task factories as input array. Progress reporting consumes `onComplete` callback to update ETA calculations via moving average in `src/orchestration/progress.ts`.

## Error Handling Strategy

Catch block converts all rejections to `TaskResult<T>` with `success: false` and `error` field. Does not rethrow exceptionsâ€”workers continue until iterator exhausted unless `failFast` aborts. `Promise.allSettled()` prevents worker rejection from crashing pool. Sparse result array may contain undefined entries if `failFast` aborted before all tasks pulled.