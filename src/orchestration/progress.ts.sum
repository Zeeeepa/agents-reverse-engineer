---
generated_at: 2026-02-09T17:45:57.105Z
content_hash: c129325fa41c4f2e6b88188dde1cc731f4ca8446e1efa863699cf9f1ae71447d
purpose: ProgressReporter provides streaming build-log progress reporting with ETA calculation via moving averages, outputting...
---
**ProgressReporter provides streaming build-log progress reporting with ETA calculation via moving averages, outputting colored console lines and optionally mirroring plain-text output to `.agents-reverse-engineer/progress.log` for tail monitoring in buffered environments.**

## Exported Classes

**ProgressLog** — Plain-text progress log file writer mirroring console output without ANSI codes.

```typescript
class ProgressLog {
  constructor(private readonly filePath: string)
  static create(projectRoot: string): ProgressLog
  write(line: string): void
  async finalize(): Promise<void>
}
```

Uses promise-chain serialization (`this.writeQueue = this.writeQueue.then(...)`) to serialize concurrent writes from multiple pool workers. Opens file handle in truncate mode (`'w'`) on first write, appends to open handle on subsequent writes. Silently swallows write failures (non-critical telemetry). Creates parent directory via `mkdir(path.dirname(this.filePath), { recursive: true })`. Static factory `create()` constructs path as `<projectRoot>/.agents-reverse-engineer/progress.log` using constant `PROGRESS_LOG_FILENAME = 'progress.log'`.

**ProgressReporter** — Streaming build-log progress reporter tracking file and directory tasks with ETA calculation.

```typescript
class ProgressReporter {
  constructor(totalFiles: number, totalDirectories: number = 0, progressLog?: ProgressLog)
  onFileStart(filePath: string): void
  onFileDone(filePath: string, durationMs: number, tokensIn: number, tokensOut: number, model: string, cacheReadTokens?: number, cacheCreationTokens?: number): void
  onFileError(filePath: string, error: string): void
  onDirectoryStart(dirPath: string): void
  onDirectoryDone(dirPath: string, durationMs: number, tokensIn: number, tokensOut: number, model: string, cacheReadTokens?: number, cacheCreationTokens?: number): void
  onRootDone(docPath: string): void
  printSummary(summary: RunSummary): void
}
```

Tracks counters: `started`, `completed`, `failed` for file tasks; `dirStarted`, `dirCompleted` for directory tasks. Maintains sliding windows `completionTimes` and `dirCompletionTimes` (max size `windowSize = 10`) for ETA moving averages. Records `startTime` via `Date.now()` for elapsed time calculation.

## Output Formats

File analysis start: `[X/Y] ANALYZING path` (cyan ANALYZING)  
File analysis done: `[X/Y] DONE path Xs in/out tok model ~Ns remaining` (green DONE)  
File analysis fail: `[X/Y] FAIL path error` (red FAIL)  
Directory start: `[dir X/Y] ANALYZING dirPath/AGENTS.md` (cyan ANALYZING)  
Directory done: `[dir X/Y] DONE dirPath/AGENTS.md Xs in/out tok model ~ETA` (blue DONE)  
Root document done: `[root] DONE docPath` (blue DONE)

All output uses `console.log()` for atomic non-corrupting concurrent writes. Color formatting via `picocolors` aliases: `pc.dim()`, `pc.cyan()`, `pc.green()`, `pc.red()`, `pc.blue()`, `pc.yellow()`, `pc.bold()`.

## ETA Calculation

`formatETA()` computes file task ETA using moving average of `completionTimes` array. Requires minimum 2 completions before displaying ETA. Calculates `avg = sum(completionTimes) / completionTimes.length`, `remaining = totalFiles - completed - failed`, `etaMs = avg * remaining`. Formats as `~Ns remaining` for <60s, `~Mm Ss remaining` for ≥60s. Returns empty string if `remaining <= 0` or fewer than 2 completions.

`formatDirectoryETA()` uses identical algorithm on `dirCompletionTimes` for directory tasks with `remaining = totalDirectories - dirCompleted`.

## Token Counting

`onFileDone()` and `onDirectoryDone()` accept `tokensIn` (non-cached input), `tokensOut` (output), `cacheReadTokens` (cache hits), `cacheCreationTokens` (cache writes). Displays total prompt size as `totalIn = tokensIn + cacheReadTokens + cacheCreationTokens` in format `${totalIn}/${tokensOut} tok`.

## Summary Output

`printSummary(summary: RunSummary)` prints multi-line report:
- `ARE version` from `summary.version`
- `Files processed` (green), `Files failed` (red if >0), `Files skipped` (yellow if >0)
- `Total calls`, `Tokens: X in / Y out`
- `Cache: X read / Y created` (if `totalCacheReadTokens > 0`)
- `Files read: X (Y unique)` (if `totalFilesRead > 0`)
- `Total time`, `Errors`, `Retries` (if `retryCount > 0`)

Computes elapsed time as `(Date.now() - this.startTime) / 1000` formatted to 1 decimal place.

## ANSI Stripping

`stripAnsi(str: string)` removes ANSI escape codes via regex `/\x1b\[[0-9;]*m/g` before writing to ProgressLog. Matches all SGR, cursor, and erase sequences.

## Integration Points

Receives `RunSummary` type from `./types.js` with fields: `version`, `filesProcessed`, `filesFailed`, `filesSkipped`, `totalCalls`, `totalInputTokens`, `totalOutputTokens`, `totalCacheReadTokens`, `totalCacheCreationTokens`, `totalFilesRead`, `uniqueFilesRead`, `errorCount`, `retryCount`. Instantiated per command run with total file/directory counts from discovery phase. Event methods called by worker pool during task execution. `printSummary()` invoked by orchestrator after all phases complete.