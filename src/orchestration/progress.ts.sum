---
generated_at: 2026-02-09T16:11:11.209Z
content_hash: c129325fa41c4f2e6b88188dde1cc731f4ca8446e1efa863699cf9f1ae71447d
purpose: ProgressReporter streams colored build-log progress events with ETA calculation via moving average of completion time...
---
**ProgressReporter streams colored build-log progress events with ETA calculation via moving average of completion times, optionally mirroring ANSI-stripped output to `.agents-reverse-engineer/progress.log` through ProgressLog for `tail -f` monitoring in buffered environments.**

## Exported Classes

**ProgressLog**: Promise-chain serialized file writer for plain-text progress logging.
- `static create(projectRoot: string): ProgressLog` — creates instance with path `<projectRoot>/.agents-reverse-engineer/progress.log`
- `write(line: string): void` — appends line to log file, creating parent directory and opening handle on first call in truncate mode ('w'), silently swallows write errors
- `async finalize(): Promise<void>` — flushes pending writes and closes file handle
- Uses pattern `writeQueue: Promise<void>` with chained `.then()` for serialization (same as TraceWriter)
- Private fields: `filePath: string`, `fd: FileHandle | null`, `writeQueue: Promise<void>`

**ProgressReporter**: Streaming progress reporter with ETA calculation for file/directory/root tasks.
- `constructor(totalFiles: number, totalDirectories: number = 0, progressLog?: ProgressLog)` — initializes with task counts and optional log mirror
- `onFileStart(filePath: string): void` — logs `[X/Y] ANALYZING path` with cyan color
- `onFileDone(filePath: string, durationMs: number, tokensIn: number, tokensOut: number, model: string, cacheReadTokens = 0, cacheCreationTokens = 0): void` — logs `[X/Y] DONE path Xs in/out tok model ~ETA` with green color, records completion time for ETA
- `onFileError(filePath: string, error: string): void` — logs `[X/Y] FAIL path error` with red color
- `onDirectoryStart(dirPath: string): void` — logs `[dir X/Y] ANALYZING dirPath/AGENTS.md` with cyan color
- `onDirectoryDone(dirPath: string, durationMs: number, tokensIn: number, tokensOut: number, model: string, cacheReadTokens = 0, cacheCreationTokens = 0): void` — logs `[dir X/Y] DONE dirPath/AGENTS.md Xs in/out tok model ~ETA` with blue color, records directory completion time
- `onRootDone(docPath: string): void` — logs `[root] DONE docPath` with blue color
- `printSummary(summary: RunSummary): void` — prints final summary with ARE version, files processed/failed/skipped, total calls, tokens (input + cache read + cache creation / output), cache statistics, files read (total and unique), elapsed time, errors, retries

## ETA Calculation Algorithm

- **File ETA**: `formatETA()` computes moving average of last `windowSize` (10) completion times from `completionTimes` array, multiplies by remaining file count (`totalFiles - completed - failed`), formats as `~Ns remaining` or `~Mm Ss remaining`, returns empty string if fewer than 2 completions
- **Directory ETA**: `formatDirectoryETA()` uses same algorithm with `dirCompletionTimes` array and `totalDirectories - dirCompleted` remaining count
- Sliding window maintenance: `completionTimes.push(durationMs); if (completionTimes.length > windowSize) completionTimes.shift()`

## State Tracking

ProgressReporter maintains counters:
- `totalFiles: number`, `totalDirectories: number` — immutable task counts
- `started: number`, `completed: number`, `failed: number` — file task progress
- `dirStarted: number`, `dirCompleted: number` — directory task progress
- `completionTimes: number[]`, `dirCompletionTimes: number[]` — sliding windows for ETA (max length 10)
- `startTime: number` — timestamp from `Date.now()` at construction for total elapsed calculation
- `progressLog: ProgressLog | null` — optional file mirror

## Output Format

All console output uses `console.log()` for atomic writes. Colored via `picocolors`:
- `pc.dim()` — counters, timestamps, token counts, model labels, ETA
- `pc.cyan('ANALYZING')` — file/directory start events
- `pc.green('DONE')` — file completion
- `pc.blue('DONE')` — directory/root completion
- `pc.red('FAIL')` — file errors
- `pc.bold()` — summary header
- `pc.yellow()` — skipped files count

## ANSI Stripping

`stripAnsi(str: string): string` removes ANSI escape codes via regex `/\x1b\[[0-9;]*m/g` for plain-text log output.

## Token Accounting

Total input tokens calculated as `tokensIn + cacheReadTokens + cacheCreationTokens` for display in completion messages and summary. Output tokens tracked separately.

## Integration Points

- Imported by `src/orchestration/runner.ts` and `src/generation/executor.ts` for progress reporting during pool execution
- Consumes `RunSummary` type from `src/orchestration/types.ts` for summary formatting
- Mirrors output to `PROGRESS_LOG_FILENAME` constant (`'progress.log'`) within `.agents-reverse-engineer/` directory