---
generated_at: 2026-02-09T14:09:40.584Z
content_hash: 42bc71afc0291d90fce6c22fab2e4b0092ad72e8638a0b72f11d3f01be14355e
purpose: ProgressReporter streams real-time file/directory analysis progress to console and optional log file with ETA calcula...
---
**ProgressReporter streams real-time file/directory analysis progress to console and optional log file with ETA calculation via moving average of completion times, using picocolors formatting and atomic console.log output to prevent concurrent worker corruption.**

## Exported Classes

**ProgressLog** mirrors console output to `.agents-reverse-engineer/progress.log` as plain text (ANSI-stripped) using promise-chain serialization pattern for concurrent-safe writes from pool workers.

- `constructor(filePath: string)` — creates instance with file path
- `static create(projectRoot: string): ProgressLog` — constructs ProgressLog at `projectRoot/.agents-reverse-engineer/progress.log`
- `write(line: string): void` — queues line write (opens file in 'w' mode on first call, swallows errors)
- `finalize(): Promise<void>` — flushes queue and closes FileHandle

**ProgressReporter** tracks file/directory processing state and emits formatted progress lines with counters, timing, token counts, model labels, and ETA estimates.

- `constructor(totalFiles: number, totalDirectories: number = 0, progressLog?: ProgressLog)` — initializes reporter with task counts and optional file logger
- `onFileStart(filePath: string): void` — logs `[X/Y] ANALYZING path` in cyan
- `onFileDone(filePath: string, durationMs: number, tokensIn: number, tokensOut: number, model: string, cacheReadTokens = 0, cacheCreationTokens = 0): void` — logs `[X/Y] DONE path Xs in/out tok model ~ETA` in green, records completion time for moving average
- `onFileError(filePath: string, error: string): void` — logs `[X/Y] FAIL path error` in red
- `onDirectoryStart(dirPath: string): void` — logs `[dir X/Y] ANALYZING dirPath/AGENTS.md` in cyan
- `onDirectoryDone(dirPath: string, durationMs: number, tokensIn: number, tokensOut: number, model: string, cacheReadTokens = 0, cacheCreationTokens = 0): void` — logs `[dir X/Y] DONE dirPath/AGENTS.md` in blue with ETA
- `onRootDone(docPath: string): void` — logs `[root] DONE docPath` in blue
- `printSummary(summary: RunSummary): void` — outputs multi-line summary with filesProcessed, filesFailed, filesSkipped, totalCalls, token counts (input/output/cacheRead/cacheCreation), totalFilesRead, uniqueFilesRead, elapsed time, errorCount, retryCount

## ETA Calculation Algorithm

ProgressReporter maintains two sliding windows (completionTimes[], dirCompletionTimes[]) with windowSize=10 for moving average calculation.

- `formatETA(): string` — computes file task ETA from avg(completionTimes) * (totalFiles - completed - failed), returns empty string if fewer than 2 completions, formats as `~Xs` or `~Xm Ys remaining`
- `formatDirectoryETA(): string` — computes directory task ETA from avg(dirCompletionTimes) * (totalDirectories - dirCompleted), same formatting rules

Both methods push durationMs to respective arrays on task completion, shift oldest when array exceeds windowSize.

## Token Aggregation

onFileDone and onDirectoryDone compute totalIn as `tokensIn + cacheReadTokens + cacheCreationTokens` for display, showing complete prompt cache accounting (non-cached, cache read, cache creation tokens).

## ANSI Stripping

`stripAnsi(str: string): string` removes escape sequences via regex `/\x1b\[[0-9;]*m/g` for plain-text log output, preserving content structure while removing picocolors formatting.

## State Management

ProgressReporter tracks six counters: started, completed, failed (files); dirStarted, dirCompleted (directories); plus startTime timestamp for elapsed calculation in printSummary.

## Integration Pattern

Used in src/orchestration/runner.ts and src/update/orchestrator.ts: instantiate ProgressReporter with counts, call onFileStart/onFileDone/onFileError from pool worker callbacks, call onDirectoryStart/onDirectoryDone from sequential directory generators, call onRootDone from root document generator, call printSummary(RunSummary) after pipeline completion, then progressLog.finalize().

## Dependencies

- `node:fs/promises` (open, mkdir, FileHandle) for file I/O
- `node:path` for log file path construction
- `picocolors` for terminal color formatting (cyan, green, red, blue, dim, bold)
- `RunSummary` type from `./types.js` for summary aggregation structure