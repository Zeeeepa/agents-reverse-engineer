---
generated_at: 2026-02-09T21:30:09.399Z
content_hash: c129325fa41c4f2e6b88188dde1cc731f4ca8446e1efa863699cf9f1ae71447d
purpose: ProgressReporter provides streaming build-log progress output with ETA calculation via moving averages, colored termi...
---
**ProgressReporter provides streaming build-log progress output with ETA calculation via moving averages, colored terminal formatting, and optional plain-text file mirroring for real-time monitoring in buffered environments.**

## Exported Classes

**ProgressLog** — Plain-text progress log file writer mirroring console output to `.agents-reverse-engineer/progress.log` without ANSI escape codes, enabling `tail -f` monitoring when CLI runs inside buffered environments like Claude Code's Bash tool.

- `constructor(filePath: string)` — Creates writer with promise-chain serialization for concurrent-safe writes
- `static create(projectRoot: string): ProgressLog` — Factory creating instance with path `<projectRoot>/.agents-reverse-engineer/progress.log`
- `write(line: string): void` — Appends line to log file, creating parent directory and opening file handle ('w' truncate mode) on first call, silently swallowing write failures
- `finalize(): Promise<void>` — Flushes pending writes and closes file handle

Private fields: `writeQueue: Promise<void>` (serialization chain), `fd: FileHandle | null` (open file handle)

**ProgressReporter** — Streaming build-log reporter tracking file/directory task progress with ETA calculation from sliding window of last 10 completion times, outputting colored console logs and optional plain-text file mirroring.

- `constructor(totalFiles: number, totalDirectories: number = 0, progressLog?: ProgressLog)` — Initializes reporter with task totals and optional file-based log
- `onFileStart(filePath: string): void` — Logs file analysis start with format `[X/Y] ANALYZING path`
- `onFileDone(filePath: string, durationMs: number, tokensIn: number, tokensOut: number, model: string, cacheReadTokens = 0, cacheCreationTokens = 0): void` — Logs file completion with format `[X/Y] DONE path Xs in/out tok model ~Ns remaining`, records duration for ETA calculation, computes total input tokens as `tokensIn + cacheReadTokens + cacheCreationTokens`
- `onFileError(filePath: string, error: string): void` — Logs file failure with format `[X/Y] FAIL path error`
- `onDirectoryStart(dirPath: string): void` — Logs directory AGENTS.md generation start with format `[dir X/Y] ANALYZING dirPath/AGENTS.md`
- `onDirectoryDone(dirPath: string, durationMs: number, tokensIn: number, tokensOut: number, model: string, cacheReadTokens = 0, cacheCreationTokens = 0): void` — Logs directory completion with format `[dir X/Y] DONE dirPath/AGENTS.md Xs in/out tok model ~ETA`, records duration for directory ETA calculation
- `onRootDone(docPath: string): void` — Logs root document completion with format `[root] DONE docPath`
- `printSummary(summary: RunSummary): void` — Outputs end-of-run summary with version, files processed/failed/skipped, total calls, token counts (input/output/cache read/cache created), files read (total and unique count), elapsed time, error count, retry count

Private fields: `totalFiles: number`, `started: number`, `completed: number`, `failed: number`, `completionTimes: number[]` (sliding window for file ETA), `windowSize: number = 10` (max window size), `startTime: number` (timestamp for elapsed calculation), `totalDirectories: number`, `dirStarted: number`, `dirCompleted: number`, `dirCompletionTimes: number[]` (sliding window for directory ETA), `progressLog: ProgressLog | null`

Private methods:
- `formatETA(): string` — Computes file ETA from moving average of `completionTimes`, returns empty string if fewer than 2 completions, formats as `~12s remaining` or `~2m 30s remaining`
- `formatDirectoryETA(): string` — Computes directory ETA from moving average of `dirCompletionTimes`, returns empty string if fewer than 2 completions

## Exported Functions

**stripAnsi(str: string): string** — Strips ANSI escape sequences from string for plain-text output via regex pattern `/\x1b\[[0-9;]*m/g` (matches SGR, cursor, erase codes).

## Dependencies

**picocolors (`pc`)** — Used for terminal color formatting: `pc.dim()`, `pc.cyan()`, `pc.green()`, `pc.red()`, `pc.blue()`, `pc.bold()`, `pc.yellow()`

**node:fs/promises** — `open()` for file handle creation, `mkdir()` for directory creation, `FileHandle` type

**./types.js** — Imports `RunSummary` type containing aggregated run statistics (version, filesProcessed, filesFailed, filesSkipped, totalCalls, token counts, files read, elapsed time, error/retry counts)

## Output Format Specifications

**File progress lines:**
- Start: `[X/Y] ANALYZING path`
- Done: `[X/Y] DONE path Xs in/out tok model ~Ns remaining`
- Fail: `[X/Y] FAIL path error`

**Directory progress lines:**
- Start: `[dir X/Y] ANALYZING dirPath/AGENTS.md`
- Done: `[dir X/Y] DONE dirPath/AGENTS.md Xs in/out tok model ~ETA`

**Root progress lines:**
- Done: `[root] DONE docPath`

**Summary format:**
```
=== Run Summary ===
  ARE version:     <version>
  Files processed: <count>
  Files failed:    <count>  (if > 0)
  Files skipped:   <count>  (if > 0)
  Total calls:     <count>
  Tokens:          <totalIn> in / <totalOut> out
  Cache:           <cacheRead> read / <cacheCreated> created  (if cacheRead > 0)
  Files read:      <total> (<unique> unique)  (if totalFilesRead > 0)
  Total time:      <elapsed>s
  Errors:          <count>
  Retries:         <count>  (if > 0)
```

## Constants

**PROGRESS_LOG_FILENAME** — `'progress.log'` (relative path for log file)

## Implementation Patterns

**Promise-chain serialization** — `ProgressLog.writeQueue` uses same pattern as `TraceWriter` to serialize concurrent writes from pool workers: `this.writeQueue = this.writeQueue.then(async () => { ... }).catch(() => {})`, preventing NDJSON corruption

**Moving average ETA** — `completionTimes` and `dirCompletionTimes` arrays maintain sliding window (max size `windowSize = 10`) of recent task durations, compute average via `reduce((a, b) => a + b, 0) / length`, multiply by remaining tasks to estimate time remaining

**Atomic console output** — Uses `console.log()` for each line instead of buffered streams to prevent interleaved output from concurrent pool workers

**ANSI stripping** — `stripAnsi()` removes color codes before writing to `ProgressLog` via regex `/\x1b\[[0-9;]*m/g` for plain-text tail monitoring

**Lazy file handle creation** — `ProgressLog.fd` remains null until first write, then opens in truncate mode ('w') and reuses handle for subsequent appends

**Graceful degradation** — Progress log write failures are silently caught (`catch(() => {})`) as non-critical telemetry loss is acceptable