---
generated_at: 2026-02-09T15:08:11.394Z
content_hash: c129325fa41c4f2e6b88188dde1cc731f4ca8446e1efa863699cf9f1ae71447d
purpose: ProgressReporter streams build-log progress events with ETA calculation via moving averages, ProgressLog mirrors outp...
---
**ProgressReporter streams build-log progress events with ETA calculation via moving averages, ProgressLog mirrors output to `.agents-reverse-engineer/progress.log` using promise-chain serialization for concurrent-safe file writes.**

## Exported Classes

**ProgressLog** — Plain-text progress log file writer mirroring console output without ANSI escape codes for `tail -f` monitoring.

- `constructor(filePath: string)` — Creates instance with target file path
- `static create(projectRoot: string): ProgressLog` — Factory method constructing ProgressLog for `projectRoot/.agents-reverse-engineer/progress.log`
- `write(line: string): void` — Appends line to log file via promise-chain serialization; creates parent directory and opens file handle in truncate mode ('w') on first call; swallows write errors silently
- `async finalize(): Promise<void>` — Flushes pending writes and closes file handle

**ProgressReporter** — Streaming build-log reporter tracking file/directory task progress with ETA calculation and optional ProgressLog mirroring.

- `constructor(totalFiles: number, totalDirectories: number = 0, progressLog?: ProgressLog)` — Initializes counters and optional log mirror
- `onFileStart(filePath: string): void` — Logs `[X/Y] ANALYZING path` via `pc.cyan()` and increments `started` counter
- `onFileDone(filePath: string, durationMs: number, tokensIn: number, tokensOut: number, model: string, cacheReadTokens = 0, cacheCreationTokens = 0): void` — Logs `[X/Y] DONE path Xs in/out tok model ~ETA` via `pc.green()`, increments `completed`, pushes `durationMs` to `completionTimes[]` sliding window (max size 10)
- `onFileError(filePath: string, error: string): void` — Logs `[X/Y] FAIL path error` via `pc.red()` and increments `failed` counter
- `onDirectoryStart(dirPath: string): void` — Logs `[dir X/Y] ANALYZING dirPath/AGENTS.md` via `pc.cyan()` and increments `dirStarted` counter
- `onDirectoryDone(dirPath: string, durationMs: number, tokinsIn: number, tokensOut: number, model: string, cacheReadTokens = 0, cacheCreationTokens = 0): void` — Logs `[dir X/Y] DONE dirPath/AGENTS.md Xs in/out tok model ~ETA` via `pc.blue()`, increments `dirCompleted`, pushes `durationMs` to `dirCompletionTimes[]` sliding window (max size 10)
- `onRootDone(docPath: string): void` — Logs `[root] DONE docPath` via `pc.blue()`
- `printSummary(summary: RunSummary): void` — Outputs end-of-run summary block showing `filesProcessed`, `filesFailed`, `filesSkipped`, `totalCalls`, token counts (`totalInputTokens + totalCacheReadTokens + totalCacheCreationTokens` for input, `totalOutputTokens` for output), cache stats, `totalFilesRead`/`uniqueFilesRead`, elapsed time via `Date.now() - startTime`, `errorCount`, `retryCount`
- `private formatETA(): string` — Computes file task ETA via `completionTimes[]` moving average; returns empty string if `completionTimes.length < 2`; formats as `~12s remaining` or `~2m 30s remaining`
- `private formatDirectoryETA(): string` — Computes directory task ETA via `dirCompletionTimes[]` moving average; returns empty string if `dirCompletionTimes.length < 2`; formats as `~12s remaining` or `~2m 30s remaining`

## Internal Helper

**stripAnsi(str: string): string** — Removes ANSI escape sequences via regex `/\x1b\[[0-9;]*m/g` for plain-text log output.

## Dependencies

- `node:fs/promises` — `open()`, `mkdir()`, `FileHandle` type for async file operations
- `node:path` — Path manipulation for `ProgressLog.create()` and `path.dirname()`
- `picocolors` — Terminal coloring via `pc.cyan()`, `pc.green()`, `pc.red()`, `pc.blue()`, `pc.dim()`, `pc.bold()`
- `./types.js` — Imports `RunSummary` interface with fields `version`, `filesProcessed`, `filesFailed`, `filesSkipped`, `totalCalls`, `totalInputTokens`, `totalOutputTokens`, `totalCacheReadTokens`, `totalCacheCreationTokens`, `totalFilesRead`, `uniqueFilesRead`, `errorCount`, `retryCount`

## ETA Algorithm

Uses moving average of last 10 completion times stored in `completionTimes[]` (file tasks) and `dirCompletionTimes[]` (directory tasks) sliding windows. Computes `avg = sum / length`, multiplies by `remaining = total - completed - failed` (or `total - completed` for directories), converts milliseconds to seconds. Displays ETA only after 2+ completions. Formatted as seconds below 60s, minutes+seconds above.

## Progress Log Integration

ProgressLog uses promise-chain serialization pattern (same as TraceWriter per CLAUDE.md) to handle concurrent writes from pool workers. All ProgressReporter event methods call `this.progressLog?.write(stripAnsi(line))` to mirror console output. ProgressLog creates `.agents-reverse-engineer/` directory via `mkdir(..., { recursive: true })` and opens file in truncate mode on first write. Write failures swallowed silently (non-critical telemetry).

## Output Format Patterns

- File start: `[X/Y] ANALYZING path`
- File done: `[X/Y] DONE path Xs in/out tok model ~ETA`
- File error: `[X/Y] FAIL path error`
- Directory start: `[dir X/Y] ANALYZING dirPath/AGENTS.md`
- Directory done: `[dir X/Y] DONE dirPath/AGENTS.md Xs in/out tok model ~ETA`
- Root done: `[root] DONE docPath`

Token counts combine non-cached (`tokensIn`), cache read (`cacheReadTokens`), and cache creation (`cacheCreationTokens`) into `totalIn` for display.