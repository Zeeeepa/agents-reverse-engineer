---
generated_at: 2026-02-09T15:08:09.428Z
content_hash: 6ac4e72fce4d5bde875f091b195d159ef667222d8c871b9f30b1d4b4eb838126
purpose: types.ts defines TypeScript interfaces for orchestration layer data structures: per-file task results, aggregated run...
---
**types.ts defines TypeScript interfaces for orchestration layer data structures: per-file task results, aggregated run summaries, progress event payloads, and command execution options shared across concurrency pool, progress reporter, and command runner.**

## Exported Interfaces

**FileTaskResult** — Per-file AI analysis outcome with token usage and timing
- `path: string` — Relative path to source file
- `success: boolean` — Whether AI call completed without error
- `tokensIn: number` — Non-cached input tokens consumed
- `tokensOut: number` — Output tokens generated
- `cacheReadTokens: number` — Cache hit input tokens
- `cacheCreationTokens: number` — Cache write input tokens
- `durationMs: number` — Wall-clock duration milliseconds
- `model: string` — Model identifier used for AI call
- `error?: string` — Error message when `success` is false

**RunSummary** — Aggregated statistics for entire generate/update command execution
- `version: string` — agents-reverse-engineer version that produced run
- `filesProcessed: number` — Successfully analyzed files
- `filesFailed: number` — Failed analysis attempts
- `filesSkipped: number` — Files excluded by dry-run or skip logic
- `totalCalls: number` — Number of AI subprocess invocations
- `totalInputTokens: number` — Sum of `tokensIn` across all calls
- `totalOutputTokens: number` — Sum of `tokensOut` across all calls
- `totalCacheReadTokens: number` — Sum of cache hits
- `totalCacheCreationTokens: number` — Sum of cache writes
- `totalDurationMs: number` — Total wall-clock time
- `errorCount: number` — Number of errors encountered
- `retryCount: number` — Number of retry attempts executed
- `totalFilesRead: number` — Total file read operations (may include duplicates)
- `uniqueFilesRead: number` — Deduplicated file read count
- `inconsistenciesCodeVsDoc?: number` — Exports missing from summaries (quality validation)
- `inconsistenciesCodeVsCode?: number` — Duplicate symbol definitions across files
- `phantomPaths?: number` — Unresolved path references in AGENTS.md
- `inconsistencyReport?: InconsistencyReport` — Full quality validation report when checks enabled

**ProgressEvent** — Real-time task status notification from runner to progress reporter
- `type: 'start' | 'done' | 'error' | 'dir-done' | 'root-done'` — Event discriminator
- `filePath: string` — File or directory path being processed
- `index: number` — Zero-based task index in current phase
- `total: number` — Total tasks in current phase
- `durationMs?: number` — Wall-clock duration (present for `type: 'done'`)
- `tokensIn?: number` — Input tokens (present for `type: 'done'`)
- `tokensOut?: number` — Output tokens (present for `type: 'done'`)
- `model?: string` — Model identifier (present for `type: 'done'`)
- `error?: string` — Error message (present for `type: 'error'`)

**CommandRunOptions** — Execution control parameters from config file + CLI flags
- `concurrency: number` — Worker pool size (1-10, default 2 for WSL, 5 elsewhere)
- `failFast?: boolean` — Abort on first task failure
- `debug?: boolean` — Log exact prompts and subprocess details
- `dryRun?: boolean` — Preview operations without writing files
- `tracer?: ITraceWriter` — NDJSON trace event sink (NullTraceWriter when `--trace` disabled)
- `progressLog?: ProgressLog` — File-based progress logger for `tail -f` monitoring

## Dependencies

Imports `InconsistencyReport` from `../quality/index.js` (quality validation result container), `ProgressLog` from `./progress.js` (file-based progress logger), and `ITraceWriter` from `./trace.js` (trace event sink interface). These types thread through the orchestration layer's dependency chain: `runner.ts` produces `FileTaskResult[]`, aggregates into `RunSummary`, emits `ProgressEvent` to `ProgressLog`, and forwards trace events to `ITraceWriter`.

## Event Flow Pattern

`ProgressEvent` supports five discriminated event types with type-specific optional fields. The `start` event fires when pool worker picks up task (carries `filePath`, `index`, `total`). The `done` event fires on successful AI call completion (adds `durationMs`, `tokensIn`, `tokensOut`, `model`). The `error` event fires on failure (adds `error` message). The `dir-done` event fires after directory AGENTS.md synthesis (Phase 2). The `root-done` event fires after root document synthesis (Phase 3). Progress reporter consumes this stream to compute ETA via moving average of last 10 `durationMs` values.

## Token Accounting

`FileTaskResult` and `RunSummary` track four token categories matching Anthropic API billing model: `tokensIn` (prompt tokens not served from cache), `tokensOut` (completion tokens), `cacheReadTokens` (prompt tokens served from cache at reduced cost), `cacheCreationTokens` (prompt tokens written to cache). Telemetry logger (`src/ai/telemetry/logger.ts`) multiplies these by per-backend pricing rates from config (`ai.pricing.<backend>.inputCostPer1kTokens`, etc.) to compute USD cost per call and cumulative run cost.