<!-- Generated by agents-reverse-engineer -->

# src/orchestration

Iterator-based concurrency pool executing three-phase AI documentation pipeline (file analysis → directory aggregation → root synthesis) with promise-chain serialization preventing write corruption, NDJSON trace emission for subprocess debugging, and streaming progress with ETA calculation.

## Contents

### Core Orchestration

**[index.ts](./index.ts)** — Barrel export consolidating `runPool`, `ProgressReporter`, `ProgressLog`, `PlanTracker`, `createTraceWriter`, `cleanupOldTraces`, `CommandRunner` public API plus shared types (`FileTaskResult`, `RunSummary`, `ProgressEvent`, `CommandRunOptions`, `PoolOptions`, `TaskResult<T>`, `TraceEvent`, `TraceEventPayload`).

**[runner.ts](./runner.ts)** — `CommandRunner` class orchestrating `executeGenerate(plan: ExecutionPlan)` three-phase pipeline and `executeUpdate(filesToAnalyze: FileChange[])` incremental workflow. Phase 1 runs `runPool()` concurrent file analysis writing `.sum` files via `writeSumFile()`, post-phase-1 executes `checkCodeVsDoc()`/`checkCodeVsCode()` quality validation grouped by directory. Phase 2 processes `directoryTasks` in descending depth order calling `buildDirectoryPrompt()` and `writeAgentsMd()`, post-phase-2 runs `checkPhantomPaths()`. Phase 3 sequentially generates root documents via `buildRootPrompt()` with `stripPreamble()` removing conversational prefixes. Emits `phase:start/end`, `task:start/done` trace events, updates `ProgressReporter` and `PlanTracker`, aggregates token counts into `RunSummary` with quality metrics (`inconsistenciesCodeVsDoc`, `inconsistenciesCodeVsCode`, `phantomPaths`).

**[pool.ts](./pool.ts)** — `runPool<T>(tasks, options, onComplete?)` shared-iterator worker pattern executing `Array<() => Promise<T>>` task factories through concurrency-limited pool, returns `TaskResult<T>[]` indexed by original position. Workers iterate single `tasks.entries()` iterator atomically consuming `[index, task]` pairs preventing batch-induced idling. Supports `failFast` abort via shared mutable flag checked before task pickup. Emits `worker:start/end`, `task:pickup/done` trace events with `activeTasks` counter, normalizes errors via `instanceof Error` check, invokes `onComplete(result)` callback in both success/error branches.

**[types.ts](./types.ts)** — Shared TypeScript interfaces: `FileTaskResult` (path, success, tokensIn/Out, cacheReadTokens, cacheCreationTokens, durationMs, model, error?), `RunSummary` (version, filesProcessed/Failed/Skipped, totalCalls, token counts, totalDurationMs, errorCount, retryCount, totalFilesRead/uniqueFilesRead, inconsistenciesCodeVsDoc/CodeVsCode, phantomPaths, inconsistencyReport?), `ProgressEvent` (discriminated type: start/done/error/dir-done/root-done with conditional filePath, index, total, durationMs?, tokensIn/Out?, model?, error?), `CommandRunOptions` (concurrency, failFast?, debug?, dryRun?, tracer?: ITraceWriter, progressLog?: ProgressLog).

### Progress Reporting

**[progress.ts](./progress.ts)** — `ProgressReporter` class streaming build-log events via `onFileStart()`, `onFileDone()`, `onFileError()`, `onDirectoryStart()`, `onDirectoryDone()`, `onRootDone()`, `printSummary()`. Computes ETA via `formatETA()`/`formatDirectoryETA()` using moving averages of last 10 completion times in `completionTimes[]`/`dirCompletionTimes[]` sliding windows. `ProgressLog` class mirrors output to `.agents-reverse-engineer/progress.log` via promise-chain serialization (`writeQueue = writeQueue.then(...)` pattern), opens file handle in truncate mode ('w') on first write, removes ANSI codes via `stripAnsi()` regex.

**[plan-tracker.ts](./plan-tracker.ts)** — `PlanTracker` class serializing `GENERATION-PLAN.md` checkbox updates preventing concurrent corruption from pool workers. `markDone(itemPath)` replaces `- [ ] \`${itemPath}\`` with `- [x]` in-memory, chains `writeFile()` to `writeQueue` promise. `flush()` awaits queue drain before returning. Created by `runner.ts` during `executeGenerate()`, updated per Phase 1/2/3 task completion.

### Tracing

**[trace.ts](./trace.ts)** — `ITraceWriter` interface defining `emit(event: TraceEventPayload)`, `finalize()`, `filePath` contract. `createTraceWriter(projectRoot, enabled)` factory returns `NullTraceWriter` (no-op) when `enabled=false` or `TraceWriter` writing `.agents-reverse-engineer/traces/trace-{timestamp}.ndjson` with promise-chain serialization. `TraceEvent` discriminated union comprising 14 event types: `phase:start/end` (taskCount, concurrency, tasksCompleted/Failed), `worker:start/end` (workerId, tasksExecuted), `task:pickup/done` (taskIndex, taskLabel, success, activeTasks), `task:start` (taskLabel, phase), `subprocess:spawn/exit` (childPid, command, exitCode, signal, timedOut), `retry` (attempt, errorCode), `discovery:start/end` (filesIncluded/Excluded), `filter:applied` (filterName, filesMatched/Rejected), `plan:created` (planType, fileCount), `config:loaded` (configPath, model, concurrency). All events extend `TraceEventBase` with auto-populated `seq`, `ts`, `pid`, `elapsedMs` fields. `TraceEventPayload` type alias equals `DistributiveOmit<TraceEvent, BaseKeys>` requiring callers omit auto-populated fields. `cleanupOldTraces(projectRoot, keepCount=500)` deletes oldest traces exceeding retention limit.

## Architecture

### Shared-Iterator Pool Pattern

`runPool()` prevents batch anti-pattern by sharing single `tasks.entries()` iterator across N workers. Each worker executes tight loop: pickup task → execute → emit result → pickup next, maintaining full slot utilization without idle periods. Workers coordinate via iterator protocol atomicity ensuring each `[index, task]` pair consumed by exactly one worker. Effective concurrency capped at `Math.min(options.concurrency, tasks.length)` preventing unused worker spawns.

### Promise-Chain Serialization

`PlanTracker`, `ProgressLog`, `TraceWriter` use identical pattern: `this.writeQueue = this.writeQueue.then(() => asyncWrite())` serializes concurrent writes from pool workers. Each write updates in-memory state immediately, then appends `writeFile()` promise to chain. Pattern prevents NDJSON corruption and markdown interleaving despite concurrent Phase 1 task completions.

### Three-Phase Pipeline Execution

`CommandRunner.executeGenerate()` orchestrates:
1. **Pre-Phase-1-Cache** (concurrency=20): Reads existing `.sum` files into `oldSumCache` via throttled pool for stale documentation detection
2. **Phase-1-Files** (configurable concurrency): Concurrent file analysis via `runPool(fileTasks)`, writes `.sum` with SHA-256 `content_hash`, caches source in `sourceContentCache`
3. **Post-Phase-1-Quality** (concurrency=10): Groups files by directory, runs `checkCodeVsDoc()` twice (old-doc for staleness, new-doc for LLM omissions), `checkCodeVsCode()` for duplicate symbols
4. **Phase-2-Dirs-Depth-{N}**: Groups `directoryTasks` by depth via `Map<number, DirectoryTask[]>`, processes descending (deepest first = post-order), per-depth-level concurrency via `Math.min(concurrency, dirsAtDepth.length)`
5. **Post-Phase-2-Phantom**: Validates path references in `AGENTS.md` via `checkPhantomPaths()` with filesystem resolution
6. **Phase-3-Root** (sequential): Generates `CLAUDE.md`/`GEMINI.md`/`OPENCODE.md` via `buildRootPrompt()`, strips preamble via pattern matching

### Trace Event Threading

`CommandRunOptions.tracer` parameter threads `ITraceWriter` instance through:
- `runner.ts` emits `phase:start/end`, `task:start`
- `pool.ts` emits `worker:start/end`, `task:pickup/done` with `activeTasks` counter
- `AIService` (via `setTracer()`) emits `subprocess:spawn/exit`, `retry` with exponential backoff metadata
- Trace events auto-populated with `seq` (monotonic counter), `ts` (ISO 8601), `pid` (process.pid), `elapsedMs` (high-resolution delta from `process.hrtime.bigint()`)

### ETA Calculation

`ProgressReporter` maintains sliding windows `completionTimes[]` (files) and `dirCompletionTimes[]` (directories) storing last 10 task durations. `formatETA()` computes moving average (`sum / length`), multiplies by `remaining = total - completed - failed`, formats as seconds (`~12s remaining`) below 60s or minutes+seconds (`~2m 30s remaining`) above. ETA displayed only after 2+ completions.

## File Relationships

- `runner.ts` constructs `ProgressReporter`, `PlanTracker`, calls `runPool()` passing `tracer` from `options`
- `pool.ts` emits trace events via `tracer?.emit()` optional chaining, invokes `onComplete()` callback with `TaskResult<T>` discriminated union
- `PlanTracker`/`ProgressLog`/`TraceWriter` all use promise-chain serialization pattern (`writeQueue = writeQueue.then(...)`)
- `types.ts` defines shared data structures consumed by `runner.ts`, `progress.ts`, `pool.ts`, threaded through `CommandRunOptions` interface
- `index.ts` barrel export provides single import point for consumers (`src/cli/generate.ts`, `src/cli/update.ts`)

## Integration Points

**Consumed by:**
- `../cli/generate.ts` creates `CommandRunner`, calls `executeGenerate()` with `ExecutionPlan` from `../generation/orchestrator.ts`
- `../cli/update.ts` creates `CommandRunner`, calls `executeUpdate()` with `FileChange[]` from `../change-detection/detector.ts`

**Consumes:**
- `../ai/service.ts` (`AIService`) for subprocess management via `call()`, `setTracer()`, `getSummary()`
- `../generation/executor.ts` (`ExecutionPlan`, `ExecutionTask`, `formatExecutionPlanAsMarkdown`) for task definitions
- `../generation/prompts/builder.ts` (`buildFilePrompt`, `buildDirectoryPrompt`, `buildRootPrompt`) for prompt construction
- `../generation/writers/sum.ts` (`writeSumFile`, `readSumFile`, `SumFileContent`) for YAML frontmatter `.sum` files
- `../generation/writers/agents-md.ts` (`writeAgentsMd`) for directory-level aggregation
- `../quality/inconsistency/code-vs-doc.ts` (`checkCodeVsDoc`), `../quality/inconsistency/code-vs-code.ts` (`checkCodeVsCode`), `../quality/phantom-paths/validator.ts` (`checkPhantomPaths`) for validation
- `../quality/inconsistency/reporter.ts` (`buildInconsistencyReport`, `formatReportForCli`) for quality metrics
- `../change-detection/detector.ts` (`computeContentHashFromString`, `FileChange`) for SHA-256 hashing and update workflow
- `../config/loader.ts` (`CONFIG_DIR`) for `.agents-reverse-engineer/` path resolution
- `../version.ts` (`getVersion`) for run summary metadata