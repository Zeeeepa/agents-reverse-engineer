<!-- Generated by agents-reverse-engineer -->

# src/orchestration

Iterator-based concurrency orchestration for parallel AI documentation generation with NDJSON tracing, serialized progress tracking, and post-order directory aggregation.

## Contents

### Barrel Export
[index.ts](./index.ts) — Re-exports PoolOptions, TaskResult, runPool, ITraceWriter, TraceEvent, TraceEventPayload, createTraceWriter, cleanupOldTraces, ProgressReporter, ProgressLog, PlanTracker, CommandRunner, FileTaskResult, RunSummary, ProgressEvent, CommandRunOptions from pool, trace, progress, plan-tracker, runner, and types submodules.

### Core Orchestration
[runner.ts](./runner.ts) — CommandRunner executes two-phase generation pipeline via executeGenerate() (pre-cache old .sum files, Phase 1 file analysis via runPool(), post-phase-1 quality checks with checkCodeVsDoc/checkCodeVsCode, Phase 2 post-order directory AGENTS.md generation grouped by depth, phantom path validation with checkPhantomPaths) and executeUpdate() (Phase 1 only with incremental .sum context). Integrates AIService, ProgressReporter, PlanTracker, stripPreamble(), extractPurpose().

[pool.ts](./pool.ts) — runPool() executes `Array<() => Promise<T>>` task factories through shared-iterator worker pattern with bounded parallelism, avoiding batch-and-wait idling. Returns `TaskResult<T>[]` indexed by original position. PoolOptions configures concurrency, failFast, tracer, phaseLabel, taskLabels. activeTasks tracks real-time concurrency snapshot.

### Progress Tracking
[progress.ts](./progress.ts) — ProgressReporter emits one-line-per-event colored console output via onFileStart/onFileDone/onFileError/onDirectoryStart/onDirectoryDone/onRootDone, computes ETA from sliding window (last 10 completion times), calls printSummary(RunSummary). ProgressLog mirrors output to `.agents-reverse-engineer/progress.log` via promise-chain serialization for `tail -f` monitoring.

[plan-tracker.ts](./plan-tracker.ts) — PlanTracker serializes concurrent checkbox updates to `GENERATION-PLAN.md` via writeQueue promise chain. markDone(itemPath) replaces `- [ ]` with `- [x]` for file paths, directory `/AGENTS.md` suffixes, and root docs.

### Tracing System
[trace.ts](./trace.ts) — ITraceWriter interface with emit(TraceEventPayload), finalize(), filePath. createTraceWriter(projectRoot, enabled) returns NullTraceWriter (zero overhead) or TraceWriter (NDJSON to `.agents-reverse-engineer/traces/trace-{ISO}.ndjson`). TraceEvent discriminated union includes phase:start/end, worker:start/end, task:pickup/done/start, subprocess:spawn/exit, retry, discovery:start/end, filter:applied, plan:created, config:loaded. Promise-chain serialization pattern prevents concurrent write corruption. DistributiveOmit fixes TypeScript union type distribution.

### Type Definitions
[types.ts](./types.ts) — FileTaskResult captures per-file path, success, tokensIn/Out, cacheReadTokens, cacheCreationTokens, durationMs, model, error. RunSummary aggregates filesProcessed/Failed/Skipped, totalCalls, token counts, errorCount, retryCount, totalFilesRead, uniqueFilesRead, inconsistenciesCodeVsDoc/CodeVsCode, phantomPaths, InconsistencyReport. ProgressEvent discriminates start/done/error/dir-done/root-done with filePath, index, total, optional durationMs/tokens/model/error. CommandRunOptions threads concurrency, failFast, debug, dryRun, tracer, progressLog through runner → pool → AIService.

## Concurrency Architecture

**Shared-Iterator Pattern**: runPool() creates effectiveConcurrency workers (capped at `Math.min(concurrency, tasks.length)`) pulling from `tasks.entries()` iterator. Workers immediately fetch next task after completing current task, preventing batch idling. aborted flag enables fail-fast: workers check before pulling next task, exit early on first failure when failFast is true.

**Phase Execution Order**: CommandRunner.executeGenerate() runs pre-phase-1-cache (concurrency 20 for .sum reads), phase-1-files (configurable concurrency), post-phase-1-quality (concurrency 10 for checkCodeVsDoc/checkCodeVsCode), phase-2-dirs-depth-{N} (grouped by metadata.depth, processed deepest-first via descending sort), post-phase-2-quality (phantom paths). executeUpdate() runs phase-1-files and post-phase-1-quality only.

**Serialized Writes**: PlanTracker and TraceWriter use writeQueue promise chain (`writeQueue = writeQueue.then(async () => { ... })`) to serialize concurrent disk writes from multiple pool workers, preventing corruption. ProgressLog uses same pattern for `.agents-reverse-engineer/progress.log`.

## Tracing Integration

ITraceWriter threaded through CommandRunOptions.tracer → pool workers (task:pickup/done, worker:start/end, activeTasks snapshot) → AIService (subprocess:spawn/exit, retry) → runner (phase:start/end). TraceEventBase auto-populates seq (monotonic), ts (ISO 8601), pid (parent process), elapsedMs (high-resolution via `process.hrtime.bigint()` / 1_000_000).

cleanupOldTraces(projectRoot, keepCount=500) deletes old `.ndjson` files sorted lexicographically by ISO timestamp, keeping keepCount most recent.

## Quality Checks

Post-phase-1: checkCodeVsDoc(sourceContent, oldSum/newSum, filePath) detects missing identifiers (stale/new doc checks), checkCodeVsCode(filesForCodeVsCode) detects cross-file import inconsistencies, grouped by directory, throttled to concurrency 10. Post-phase-2: checkPhantomPaths(agentsMdPath, content, projectRoot) detects invalid file references. All return `Inconsistency[]` aggregated into InconsistencyReport via buildInconsistencyReport(), printed via formatReportForCli(). Non-throwing: catches errors, logs `[quality] ... failed: ...`.

## Helper Functions

**stripPreamble(responseText)**: Removes LLM preamble via two patterns: content after `\n---\n` within 500 chars if non-empty, or content starting with `(\*\*[A-Z])` if preamble <300 chars and lacks `##`.

**extractPurpose(responseText)**: Extracts first substantive line by skipping empty lines, markdown headers, separators, lines starting with PREAMBLE_PREFIXES `['now i', 'perfect', 'based on', ...]`. Strips `**...**` wrapper, truncates to 120 chars with `...`, returns empty string if none found.

## File Relationships

CommandRunner imports AIService (type), AIResponse (type) from `../ai/`, ExecutionPlan, ExecutionTask, formatExecutionPlanAsMarkdown from `../generation/executor.js`, buildFilePrompt, buildDirectoryPrompt from `../generation/prompts/`, writeSumFile, readSumFile, writeAnnexFile, SumFileContent from `../generation/writers/sum.js`, writeAgentsMd from `../generation/writers/agents-md.js`, writeClaudeMdPointer from `../generation/writers/claude-md.js`, computeContentHashFromString from `../change-detection/`, Config from `../config/schema.js`, CONFIG_DIR from `../config/loader.js`, quality check functions from `../quality/`, getVersion from `../version.js`.

types.ts imports InconsistencyReport from `../quality/index.js`, ProgressLog from `./progress.js`, ITraceWriter from `./trace.js`.

plan-tracker.ts imports CONFIG_DIR from `../config/loader.js`.

## Behavioral Contracts

Full prompt template text and preamble prefix patterns: [runner.annex.sum](./runner.annex.sum)