<!-- Generated by agents-reverse-engineer -->

# src/orchestration

**Three-phase concurrency orchestration engine for AI-driven documentation generation: iterator-based worker pool, progress reporting with ETA calculation, promise-chain serialization for concurrent writes, NDJSON trace emission, and subprocess-aware command execution.**

## Contents

### Core Orchestration

[**runner.ts**](./runner.ts) — `CommandRunner` orchestrates three-phase pipeline: concurrent Phase 1 file analysis via `runPool()`, post-order Phase 2 directory AGENTS.md generation by depth level, sequential Phase 3 root document synthesis. `executeGenerate()` runs full pipeline with pre-phase-1 .sum cache loading and post-phase quality checks (`checkCodeVsDoc`, `checkCodeVsCode`, `checkPhantomPaths`). `executeUpdate()` runs Phase 1 only with new-doc inconsistency detection. Emits `phase:start/end`, `task:start/done` via `ITraceWriter`. Aggregates `FileTaskResult[]` into `RunSummary` with token counts and inconsistency reports.

[**pool.ts**](./pool.ts) — `runPool<T>(tasks, options, onComplete)` executes task factories through shared-iterator concurrency pool. Each worker pulls `[index, task]` pairs from `tasks.entries()` until exhausted, maintaining exactly `options.concurrency` active workers without batch idling. Supports `failFast` abort, emits `worker:start/end`, `task:pickup/done` trace events with `activeTasks` counter. Returns indexed `TaskResult<T>[]` preserving input order. `onComplete` callback fires per-task for streaming progress.

[**progress.ts**](./progress.ts) — `ProgressReporter` logs streaming build-log output via atomic `console.log()` calls with `picocolors` formatting. Tracks file/directory completion, computes ETA via moving average of last 10 durations (displayed after 2+ completions), prints `RunSummary` with token counts and quality metrics. `ProgressLog` mirrors console output to `.agents-reverse-engineer/progress.log` using promise-chain serialization (same pattern as `TraceWriter`) for safe concurrent writes. `stripAnsi()` removes ANSI escape codes from file output.

[**plan-tracker.ts**](./plan-tracker.ts) — `PlanTracker` maintains in-memory markdown for `GENERATION-PLAN.md`, serializes checkbox updates via promise-chain pattern to prevent file corruption during concurrent Phase 1 writes. `markDone(itemPath)` replaces `- [ ]` with `- [x]` in `content` field, enqueues `writeFile()` onto `writeQueue` chain. `flush()` awaits all pending writes before orchestrator exits. Instantiated by `executeGenerate()` in `src/generation/executor.ts` with initial markdown from plan builder.

[**trace.ts**](./trace.ts) — `createTraceWriter(projectRoot, enabled)` factory returns `NullTraceWriter` (zero overhead) when disabled, otherwise `TraceWriter` writing to `.agents-reverse-engineer/traces/trace-{timestamp}.ndjson`. `ITraceWriter.emit(event)` auto-populates `seq`, `ts` (ISO 8601), `pid`, `elapsedMs` (high-resolution delta from `process.hrtime.bigint()` anchor), serializes to JSON line. Promise-chain serialization ensures NDJSON lines appear in emission order despite concurrent workers. `cleanupOldTraces(projectRoot, keepCount)` removes old trace files, keeping 500 most recent. Supports 15 event types: `phase:start/end`, `worker:start/end`, `task:pickup/done/start`, `subprocess:spawn/exit`, `retry`, `discovery:start/end`, `filter:applied`, `plan:created`, `config:loaded`. `DistributiveOmit<T, K>` utility type correctly strips base fields from discriminated union.

### Type Definitions

[**types.ts**](./types.ts) — `FileTaskResult` captures per-file AI analysis outcome with `path`, `success`, `tokensIn/Out`, `cacheReadTokens`, `cacheCreationTokens`, `durationMs`, `model`, optional `error`. `RunSummary` aggregates totals: `filesProcessed/Failed/Skipped`, `totalCalls`, token counts, `errorCount`, `retryCount`, `totalFilesRead`, `uniqueFilesRead`, optional `inconsistenciesCodeVsDoc/Code`, `phantomPaths`, `inconsistencyReport`. `ProgressEvent` discriminated union (`type: 'start' | 'done' | 'error' | 'dir-done' | 'root-done'`) flows from runner to console output. `CommandRunOptions` threads configuration: `concurrency`, `failFast`, `debug`, `dryRun`, `tracer`, `progressLog`.

### Public API

[**index.ts**](./index.ts) — Barrel export aggregating orchestration subsystem: `runPool`, `FileTaskResult`, `RunSummary`, `ProgressEvent`, `CommandRunOptions`, `PoolOptions`, `TaskResult`, `ITraceWriter`, `TraceEvent`, `TraceEventPayload`, `ProgressReporter`, `ProgressLog`, `PlanTracker`, `CommandRunner`, `createTraceWriter`, `cleanupOldTraces`. Single import point for CLI commands and test suites.

## Architecture

### Iterator-Based Concurrency Model

`runPool()` uses shared-iterator worker pattern: all workers pull from single `tasks.entries()` iterator, ensuring exactly one worker executes each task. When a worker completes, it immediately pulls next entry without waiting for batch completion, maintaining full worker utilization. `effectiveConcurrency = Math.min(options.concurrency, tasks.length)` prevents spawning idle workers. Supports `failFast` abort via `aborted` flag checked before each iterator pull. Workers launched via `Promise.allSettled()` so in-flight tasks complete after abort.

### Promise-Chain Serialization

`PlanTracker`, `ProgressLog`, and `TraceWriter` use identical serialization pattern: `writeQueue: Promise<void>` initialized to `Promise.resolve()`, each write chains via `writeQueue = writeQueue.then(() => writeFile(...))`. Prevents concurrent pool workers from corrupting shared file output (GENERATION-PLAN.md, progress.log, trace NDJSON). Write errors swallowed silently as non-critical telemetry operations.

### Three-Phase Pipeline

1. **Pre-Phase 1**: Loads existing .sum files into `oldSumCache` Map (concurrency=20) for stale-doc detection
2. **Phase 1**: Analyzes files via `runPool()` with user concurrency, writes .sum files, updates `sourceContentCache` Map for quality checks
3. **Post-Phase 1**: Groups files by directory, runs `checkCodeVsDoc()` on old+new .sum, `checkCodeVsCode()` within directory groups (concurrency=10), clears `sourceContentCache`
4. **Phase 2**: Generates AGENTS.md post-order by depth (deepest first), each depth level runs concurrently
5. **Post-Phase 2**: Validates generated AGENTS.md via `checkPhantomPaths()` for invalid file references
6. **Phase 3**: Synthesizes root documents sequentially (concurrency=1) with all AGENTS.md injected into prompt

`executeUpdate()` runs Phase 1 only, skips directory/root generation.

### Trace Event Schema

All trace events extend `TraceEventBase` with auto-populated `seq` (monotonic counter), `ts` (ISO 8601), `pid` (process.pid), `elapsedMs` (high-resolution delta). Phase events include `taskCount`, `concurrency`, `durationMs`, `tasksCompleted`, `tasksFailed`. Task events include `taskIndex`, `taskLabel`, `activeTasks` counter, `success`, optional `error`. Subprocess events include `childPid`, `command`, `exitCode`, `signal`, `timedOut`.

### ETA Calculation

`ProgressReporter.formatETA()` computes moving average from `completionTimes[]` sliding window (max 10 entries), formats as `~12s remaining` or `~2m 30s remaining`. Returns empty string until 2+ completions collected. Separate `dirCompletionTimes[]` window for directory task ETA.

### Preamble Stripping

`stripPreamble()` removes LLM conversational preamble via two patterns: content after `\n---\n` separator (within first 500 chars), or content before bold purpose line `**[A-Z]` (if preamble <300 chars, no identifiers, no markdown headers). `extractPurpose()` skips lines matching PREAMBLE_PREFIXES constant (`'now i'`, `'perfect'`, `'based on'`, etc.), strips markdown headers/separators, unwraps bold syntax, truncates to 120 chars.

## Integration Points

**CommandRunner** orchestrates six subsystems: `AIService.call()` for LLM inference, `ExecutionPlan` for task lists, `runPool()` for concurrency control, `ProgressReporter` for console output, `PlanTracker` for GENERATION-PLAN.md checkbox updates, `ITraceWriter` for NDJSON trace emission. Quality checks (`checkCodeVsDoc`, `checkCodeVsCode`, `checkPhantomPaths`) aggregate into `InconsistencyReport` stored in `RunSummary.inconsistencyReport`. Prompt builders (`buildFilePrompt`, `buildDirectoryPrompt`, `buildRootPrompt`) from `src/generation/prompts/index.js` construct system/user messages. File writers (`writeSumFile`, `writeAgentsMd`) from `src/generation/writers/` persist LLM responses.