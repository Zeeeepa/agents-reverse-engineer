<!-- Generated by agents-reverse-engineer v1.0.1 -->

# orchestration
The `orchestration` directory manages the overall process of AI-driven documentation generation and updates, encompassing task planning, execution, concurrent processing, progress reporting, and trace logging.

## Contents
- [index.ts](./index.ts): The public API for the `orchestration` module, exporting `FileTaskResult`, `RunSummary`, `ProgressEvent`, `CommandRunOptions`, `PoolOptions`, `TaskResult`, `ITraceWriter`, `TraceEvent`, `TraceEventPayload` types, and `runPool`, `ProgressReporter`, `ProgressLog`, `PlanTracker`, `createTraceWriter`, `cleanupOldTraces`, `CommandRunner` functions and classes.
- [orchestrator.ts](./orchestrator.ts): Provides a unified orchestration layer for generating and incrementally updating documentation, combining file discovery, change detection, and task planning through `PreparedFile`, `AnalysisTask`, `GenerationPlan`, `UpdatePlan` interfaces and the `DocumentationOrchestrator` class.
- [plan-tracker.ts](./plan-tracker.ts): Manages asynchronous updates to `GENERATION-PLAN.md` checkboxes via the `PlanTracker` class, tracking generation progress by modifying content.
- [pool.ts](./pool.ts): Implements concurrent task management, likely providing the `runPool` function for processing tasks as integrated by [runner.ts](./runner.ts).
- [progress.ts](./progress.ts): Provides streaming build-log progress reporting with ETA calculation and optional file-based mirroring via `ProgressLog` and `ProgressReporter` classes.
- [runner.ts](./runner.ts): Orchestrates two-phase AI-driven documentation generation and updating using the `CommandRunner` class, managing concurrency, progress, and quality checks.
- [trace.ts](./trace.ts): Provides a concurrency tracing system via `ITraceWriter` for debugging task and subprocess lifecycles, producing NDJSON trace files through `createTraceWriter` and `cleanupOldTraces`.
- [types.ts](./types.ts): Defines shared interfaces `FileTaskResult`, `RunSummary`, `ProgressEvent`, and `CommandRunOptions` for `orchestration` module components.

## Architecture / Data Flow
The `orchestration` module implements a two-phase process for documentation generation and updates. The first phase, managed by `DocumentationOrchestrator` from [orchestrator.ts](./orchestrator.ts), involves preparing files, filtering existing artifacts via `sumFileExists` and `isGeneratedAgentsMd`, analyzing complexity with `analyzeComplexity` from `../generation/complexity.js`, and constructing either a `GenerationPlan` or an `UpdatePlan`. The second phase, executed by `CommandRunner` from [runner.ts](./runner.ts), orchestrates concurrent `file analysis` (Phase 1) to produce `.sum` and `.annex` files, and then proceeds with post-order `directory aggregation` (Phase 2) for generating `AGENTS.md` and `CLAUDE.md`. This execution involves `AIService` calls for `buildFilePrompt` and `buildDirectoryPrompt` from `../generation/prompts/index.js`, progress reporting through `ProgressReporter` from [progress.ts](./progress.ts), and plan tracking via `PlanTracker` from [plan-tracker.ts](./plan-tracker.ts). `Quality checks` like `checkCodeVsDoc`, `checkCodeVsCode`, and `checkPhantomPaths` from `../quality/index.js` are integrated during execution, producing an `inconsistencyReport`.

## API Surface
The [index.ts](./index.ts) file serves as the public API for the `orchestration` module, exposing types such as `FileTaskResult`, `RunSummary`, `ProgressEvent`, `CommandRunOptions`, `PoolOptions`, `TaskResult`, `ITraceWriter`, `TraceEvent`, `TraceEventPayload` and functions/classes including `runPool`, `ProgressReporter`, `ProgressLog`, `PlanTracker`, `createTraceWriter`, `cleanupOldTraces`, and `CommandRunner`.

## Configuration
Execution settings are primarily defined by the `CommandRunOptions` interface from [types.ts](./types.ts), which specifies `concurrency`, `failFast`, `debug`, `dryRun`, `tracer`, `progressLog`, and `variant`. The `DocumentationOrchestrator` in [orchestrator.ts](./orchestrator.ts) is initialized with a `Config` object from `../config/schema.js`.

## Patterns
- **Concurrency Management**: `runPool` from [index.ts](./index.ts) (implemented in [pool.ts](./pool.ts)) manages concurrent task execution, with types `PoolOptions` and `TaskResult` defining its configuration and output.
- **Progress Reporting**: The `ProgressReporter` and `ProgressLog` classes from [progress.ts](./progress.ts) provide streaming build-log progress, utilizing `ProgressEvent` for event definitions.
- **Tracing**: [trace.ts](./trace.ts) implements a concurrency tracing system through the `ITraceWriter` interface, `TraceEvent` types, `createTraceWriter` factory, and `cleanupOldTraces` utility.
- **Promise-chain Serialization**: Both `ProgressLog` in [progress.ts](./progress.ts) and `TraceWriter` in [trace.ts](./trace.ts) use a `writeQueue: Promise<void>` to serialize asynchronous file writes, preventing race conditions.

## Behavioral Contracts
- **Plan Tracking Checkbox Update**: The `PlanTracker` in [plan-tracker.ts](./plan-tracker.ts) identifies and replaces checkboxes using the exact regex pattern `/- \[ \] \`${itemPath}\`/`.
- **ANSI Escape Code Stripping**: `stripAnsi` in [progress.ts](./progress.ts) removes ANSI escape sequences using the regex `/\x1b\[[0-9;]*m/g`.
- **Progress Log Paths**: `ProgressLog.create` in [progress.ts](./progress.ts) constructs log file paths as `path.join(projectRoot, '.agents-reverse-engineer', PROGRESS_LOG_FILENAME)`.
- **Progress Output Formats**: `ProgressReporter` in [progress.ts](./progress.ts) logs `onFileStart` as `[X/Y] ANALYZING path`, `onFileDone` as `[X/Y] DONE path Xs in/out tok ~Ns remaining`, `onFileError` as `[X/Y] FAIL path error`, `onDirectoryStart` as `[dir X/Y] ANALYZING dirPath/AGENTS.md`, and `onDirectoryDone` as `[dir X/Y] DONE dirPath/AGENTS.md Xs in/out tok model ~ETA`. ETA is formatted as `~Xs remaining` or `~Xm Ys remaining`.
- **Trace File Naming**: Trace files created by [trace.ts](./trace.ts) are named `trace-{timestamp}.ndjson`, where `{timestamp}` is an ISO 8601 string with `[:.]` replaced by `-`.
- **Trace Event Format**: `TraceEvent` objects are written as newline-delimited JSON (NDJSON) by `TraceWriter` in [trace.ts](./trace.ts), including auto-populated `pid` from `process.pid` and `elapsedMs` from `process.hrtime.bigint()`.
- **AI Response Preamble Stripping**: `stripPreamble` in [runner.ts](./runner.ts) removes content before the first `\n---\n` (if within 500 chars) or before the first `**[A-Z]` (if preceding text < 300 chars, non-empty, and without `##`).
- **Purpose Extraction**: `extractPurpose` in [runner.ts](./runner.ts) skips empty lines, lines starting with `#` or `---`, and lines starting with any string from `PREAMBLE_PREFIXES`, then strips bold markdown `**` and truncates to 120 characters.
- **Phantom AGENTS.md Filename**: `runner.ts` constructs `phantomAgentsFilename` dynamically as `AGENTS.${this.variant}.md` if `this.variant` is defined, otherwise `AGENTS.md`.