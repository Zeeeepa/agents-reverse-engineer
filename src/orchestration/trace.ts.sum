---
generated_at: 2026-02-09T16:11:13.436Z
content_hash: b7da2dd98aaa94c1463e5499788d94f552f76fe10bddcc2d61a5c3387118c770
purpose: trace.ts provides append-only NDJSON tracing system for debugging task/subprocess lifecycle with promise-chain serial...
---
**trace.ts provides append-only NDJSON tracing system for debugging task/subprocess lifecycle with promise-chain serialization to handle concurrent pool worker writes safely.**

## Public Interface

### Factory Function
- `createTraceWriter(projectRoot: string, enabled: boolean): ITraceWriter` — returns `NullTraceWriter` when `enabled` is false (zero overhead), otherwise returns `TraceWriter` appending to `.agents-reverse-engineer/traces/trace-{timestamp}.ndjson`

### Cleanup Function
- `cleanupOldTraces(projectRoot: string, keepCount: number = 500): Promise<number>` — removes old trace files keeping only most recent ones, returns deletion count, mirrors pattern in `src/ai/telemetry/cleanup.ts`

### Core Interface
```typescript
interface ITraceWriter {
  emit(event: TraceEventPayload): void;
  finalize(): Promise<void>;
  readonly filePath: string;
}
```

### Event Type Union
`TraceEvent` discriminated union includes 14 event types: `PhaseStartEvent`, `PhaseEndEvent`, `WorkerStartEvent`, `WorkerEndEvent`, `TaskPickupEvent`, `TaskDoneEvent`, `TaskStartEvent`, `SubprocessSpawnEvent`, `SubprocessExitEvent`, `RetryEvent`, `DiscoveryStartEvent`, `DiscoveryEndEvent`, `FilterAppliedEvent`, `PlanCreatedEvent`, `ConfigLoadedEvent`

### Event Payload Type
`TraceEventPayload = DistributiveOmit<TraceEvent, BaseKeys>` — user-supplied event data without auto-populated fields (`seq`, `ts`, `pid`, `elapsedMs`)

## Event Schema

### Common Base Fields (Auto-Populated)
Every `TraceEvent` extends `TraceEventBase`:
- `seq: number` — monotonically increasing sequence number per-run
- `ts: string` — ISO 8601 timestamp at event creation
- `pid: number` — `process.pid` of Node.js parent process
- `elapsedMs: number` — high-resolution elapsed time since run start (milliseconds, fractional)

### Phase Events
- `PhaseStartEvent` (`type: 'phase:start'`) — includes `phase: string`, `taskCount: number`, `concurrency: number`
- `PhaseEndEvent` (`type: 'phase:end'`) — includes `phase: string`, `durationMs: number`, `tasksCompleted: number`, `tasksFailed: number`

### Worker Events
- `WorkerStartEvent` (`type: 'worker:start'`) — includes `workerId: number`, `phase: string`
- `WorkerEndEvent` (`type: 'worker:end'`) — includes `workerId: number`, `phase: string`, `tasksExecuted: number`

### Task Events
- `TaskPickupEvent` (`type: 'task:pickup'`) — includes `workerId: number`, `taskIndex: number`, `taskLabel: string`, `activeTasks: number`
- `TaskDoneEvent` (`type: 'task:done'`) — includes `workerId: number`, `taskIndex: number`, `taskLabel: string`, `durationMs: number`, `success: boolean`, `error?: string`, `activeTasks: number`
- `TaskStartEvent` (`type: 'task:start'`) — includes `taskLabel: string`, `phase: string`

### Subprocess Events
- `SubprocessSpawnEvent` (`type: 'subprocess:spawn'`) — includes `childPid: number`, `command: string`, `taskLabel: string`
- `SubprocessExitEvent` (`type: 'subprocess:exit'`) — includes `childPid: number`, `command: string`, `taskLabel: string`, `exitCode: number`, `signal: string | null`, `durationMs: number`, `timedOut: boolean`

### Retry Event
- `RetryEvent` (`type: 'retry'`) — includes `attempt: number`, `taskLabel: string`, `errorCode: string`

### Discovery Events
- `DiscoveryStartEvent` (`type: 'discovery:start'`) — includes `targetPath: string`
- `DiscoveryEndEvent` (`type: 'discovery:end'`) — includes `filesIncluded: number`, `filesExcluded: number`, `durationMs: number`

### Filter Event
- `FilterAppliedEvent` (`type: 'filter:applied'`) — includes `filterName: string`, `filesMatched: number`, `filesRejected: number`

### Plan Event
- `PlanCreatedEvent` (`type: 'plan:created'`) — includes `planType: 'generate' | 'update'`, `fileCount: number`, `taskCount: number`

### Config Event
- `ConfigLoadedEvent` (`type: 'config:loaded'`) — includes `configPath: string`, `model: string`, `concurrency: number`

## Implementation Classes

### NullTraceWriter
No-op implementation returned when `--trace` flag not set. All methods empty (zero overhead at call sites). `filePath` returns empty string. `emit()` and `finalize()` perform no operations.

### TraceWriter
Real NDJSON writer with promise-chain serialization. Constructor stores `filePath: string`. Maintains state: `seq: number` (incremented per event), `nodePid = process.pid`, `startHr = process.hrtime.bigint()` (for `elapsedMs` calculation), `writeQueue: Promise<void>` (serialization chain), `fd: FileHandle | null` (lazy-opened file handle).

`emit(partial: TraceEventPayload)` populates base fields (`seq`, `ts`, `pid`, `elapsedMs`), serializes to JSON line, enqueues write via `writeQueue = writeQueue.then(async () => {...})` pattern. Lazy-opens file handle via `open(filePath, 'a')` after ensuring directory exists with `mkdir(path.dirname(filePath), { recursive: true })`. Catches write errors silently (trace loss acceptable).

`finalize()` awaits `writeQueue` completion, closes file handle via `fd.close()`, nulls `fd` reference.

## Serialization Pattern

Promise-chain pattern identical to `PlanTracker` from `src/orchestration/plan-tracker.ts`. Each `emit()` call chains onto previous write: `this.writeQueue = this.writeQueue.then(async () => { await this.fd.write(line); })`. Guarantees NDJSON line order matches emission order despite concurrent pool workers.

## Storage Location

Constant `TRACES_DIR = '.agents-reverse-engineer/traces'` defines trace directory. Filename format: `trace-{timestamp}.ndjson` where timestamp uses ISO 8601 with colons/periods replaced by hyphens: `new Date().toISOString().replace(/[:.]/g, '-')`.

## Type Utilities

`DistributiveOmit<T, K extends PropertyKey> = T extends unknown ? Omit<T, K> : never` — correctly distributes `Omit` across union members (standard `Omit<Union, Keys>` fails for discriminated unions per TypeScript semantics). Used to define `TraceEventPayload` by stripping auto-populated base fields from `TraceEvent` union.

## Integration Points

Threaded via `CommandRunOptions.tracer: ITraceWriter` parameter passed to pool (`src/orchestration/pool.ts`), AIService (`src/ai/service.ts`), and runner (`src/orchestration/runner.ts`). Enabled by `--trace` CLI flag in command entry points (`src/cli/generate.ts`, `src/cli/update.ts`).