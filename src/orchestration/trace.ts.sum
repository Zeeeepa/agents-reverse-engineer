---
generated_at: 2026-02-09T21:30:06.065Z
content_hash: b7da2dd98aaa94c1463e5499788d94f552f76fe10bddcc2d61a5c3387118c770
purpose: trace.ts implements append-only NDJSON trace event emission for debugging task/subprocess lifecycle with promise-chai...
---
**trace.ts implements append-only NDJSON trace event emission for debugging task/subprocess lifecycle with promise-chain serialization to handle concurrent writes from pool workers.**

## Exported Interface

`ITraceWriter` — Public interface for trace event emission with three methods:
- `emit(event: TraceEventPayload): void` — Emits trace event with auto-populated base fields (seq, ts, pid, elapsedMs)
- `finalize(): Promise<void>` — Flushes pending writes and closes file handle
- `filePath: string` — Absolute path to trace file (empty string for NullTraceWriter)

`createTraceWriter(projectRoot: string, enabled: boolean): ITraceWriter` — Factory returning NullTraceWriter when `enabled` is false, otherwise TraceWriter writing to `.agents-reverse-engineer/traces/trace-{timestamp}.ndjson`

`cleanupOldTraces(projectRoot: string, keepCount: number = 500): Promise<number>` — Removes old trace files keeping only most recent ones, returns count deleted

## Event Schema

`TraceEvent` — Discriminated union of 15 event types:
- `PhaseStartEvent` — type `'phase:start'`, fields: `phase`, `taskCount`, `concurrency`
- `PhaseEndEvent` — type `'phase:end'`, fields: `phase`, `durationMs`, `tasksCompleted`, `tasksFailed`
- `WorkerStartEvent` — type `'worker:start'`, fields: `workerId`, `phase`
- `WorkerEndEvent` — type `'worker:end'`, fields: `workerId`, `phase`, `tasksExecuted`
- `TaskPickupEvent` — type `'task:pickup'`, fields: `workerId`, `taskIndex`, `taskLabel`, `activeTasks`
- `TaskDoneEvent` — type `'task:done'`, fields: `workerId`, `taskIndex`, `taskLabel`, `durationMs`, `success`, `error?`, `activeTasks`
- `TaskStartEvent` — type `'task:start'`, fields: `taskLabel`, `phase`
- `SubprocessSpawnEvent` — type `'subprocess:spawn'`, fields: `childPid`, `command`, `taskLabel`
- `SubprocessExitEvent` — type `'subprocess:exit'`, fields: `childPid`, `command`, `taskLabel`, `exitCode`, `signal`, `durationMs`, `timedOut`
- `RetryEvent` — type `'retry'`, fields: `attempt`, `taskLabel`, `errorCode`
- `DiscoveryStartEvent` — type `'discovery:start'`, fields: `targetPath`
- `DiscoveryEndEvent` — type `'discovery:end'`, fields: `filesIncluded`, `filesExcluded`, `durationMs`
- `FilterAppliedEvent` — type `'filter:applied'`, fields: `filterName`, `filesMatched`, `filesRejected`
- `PlanCreatedEvent` — type `'plan:created'`, fields: `planType`, `fileCount`, `taskCount`
- `ConfigLoadedEvent` — type `'config:loaded'`, fields: `configPath`, `model`, `concurrency`

`TraceEventBase` — Common fields auto-populated by TraceWriter: `seq` (monotonic number), `ts` (ISO 8601 string), `pid` (process.pid), `elapsedMs` (high-resolution fractional milliseconds since run start via `process.hrtime.bigint()`)

`TraceEventPayload` — Type alias using `DistributiveOmit<TraceEvent, BaseKeys>` to strip auto-populated fields from event payloads

`DistributiveOmit<T, K extends PropertyKey>` — Distributive conditional type `T extends unknown ? Omit<T, K> : never` ensuring Omit correctly distributes across discriminated union members

## Implementation Classes

`NullTraceWriter implements ITraceWriter` — No-op implementation with empty methods and empty `filePath`, ensures zero overhead when `--trace` flag absent

`TraceWriter implements ITraceWriter` — Real implementation using promise-chain serialization pattern:
- Private fields: `seq` (counter), `nodePid` (process.pid), `startHr` (process.hrtime.bigint() at construction), `writeQueue` (Promise<void> chain), `fd` (FileHandle | null)
- `emit()` enriches payload with base fields, serializes to JSON line, chains write via `this.writeQueue = this.writeQueue.then(async () => {...})`
- Lazy file handle opening: first write creates parent directory via `mkdir(path.dirname(this.filePath), { recursive: true })` and opens file in append mode
- Write errors caught and silently ignored (trace loss acceptable, non-critical)
- `finalize()` awaits `writeQueue` then closes `fd` if open

## Trace File Management

`TRACES_DIR` — Constant `'.agents-reverse-engineer/traces'` defines trace directory relative to project root

`createTraceWriter()` generates timestamp via `new Date().toISOString().replace(/[:.]/g, '-')` for filename `trace-{timestamp}.ndjson`

`cleanupOldTraces()` mirrors `src/ai/telemetry/cleanup.ts` pattern: filters `trace-*.ndjson` files, sorts lexicographically (ISO timestamps), reverses to newest-first, deletes beyond `keepCount` (default 500)

## Integration Points

Threaded via `CommandRunOptions.tracer` field to pool workers (`src/orchestration/pool.ts`), AIService (`src/ai/service.ts`), phase runners (`src/orchestration/runner.ts`)

Phase orchestration emits `phase:start`/`phase:end`, worker pool emits `worker:start`/`worker:end`/`task:pickup`/`task:done`, subprocess manager (`src/ai/subprocess.ts`) emits `subprocess:spawn`/`subprocess:exit`, retry logic (`src/ai/retry.ts`) emits `retry`

Discovery (`src/discovery/run.ts`) emits `discovery:start`/`discovery:end`/`filter:applied`, plan creation emits `plan:created`, config loading emits `config:loaded`