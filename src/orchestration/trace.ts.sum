---
generated_at: 2026-02-09T15:08:17.165Z
content_hash: b7da2dd98aaa94c1463e5499788d94f552f76fe10bddcc2d61a5c3387118c770
purpose: trace.ts implements append-only NDJSON concurrency tracing system with promise-chain serialization, discriminated eve...
---
**trace.ts implements append-only NDJSON concurrency tracing system with promise-chain serialization, discriminated event unions, and automatic base field population for debugging task/subprocess lifecycle across pool workers.**

## Exported Interfaces

**ITraceWriter** defines public trace emission contract with three members:
- `emit(event: TraceEventPayload): void` — enqueues trace event with auto-populated `seq`, `ts`, `pid`, `elapsedMs` fields
- `finalize(): Promise<void>` — flushes pending writes and closes file handle
- `filePath: string` — absolute path to trace file (empty string for NullTraceWriter)

**TraceEventPayload** type alias equals `DistributiveOmit<TraceEvent, BaseKeys>` where BaseKeys = `'seq' | 'ts' | 'pid' | 'elapsedMs'`, requiring callers to omit auto-populated fields.

**TraceEvent** discriminated union comprises 14 event types:
- **PhaseStartEvent** / **PhaseEndEvent** — track phase execution with `taskCount`, `concurrency`, `tasksCompleted`, `tasksFailed`
- **WorkerStartEvent** / **WorkerEndEvent** — track pool worker lifecycle with `workerId`, `tasksExecuted`
- **TaskPickupEvent** / **TaskDoneEvent** — track individual task execution with `taskIndex`, `taskLabel`, `success`, `activeTasks`
- **TaskStartEvent** — track non-pool task execution with `taskLabel`, `phase`
- **SubprocessSpawnEvent** / **SubprocessExitEvent** — track child process lifecycle with `childPid`, `command`, `exitCode`, `signal`, `timedOut`
- **RetryEvent** — track exponential backoff attempts with `attempt`, `errorCode`
- **DiscoveryStartEvent** / **DiscoveryEndEvent** — track file walking with `filesIncluded`, `filesExcluded`
- **FilterAppliedEvent** — track discovery filter application with `filterName`, `filesMatched`, `filesRejected`
- **PlanCreatedEvent** — track generation plan creation with `planType: 'generate' | 'update'`, `fileCount`
- **ConfigLoadedEvent** — track config loading with `configPath`, `model`, `concurrency`

All events extend **TraceEventBase** with `seq: number`, `ts: string`, `pid: number`, `elapsedMs: number`.

## Factory Function

**createTraceWriter(projectRoot: string, enabled: boolean): ITraceWriter** returns NullTraceWriter when `enabled` is false (zero overhead), otherwise returns TraceWriter writing to `.agents-reverse-engineer/traces/trace-{timestamp}.ndjson` where timestamp is ISO 8601 with `:` and `.` replaced by `-` for filesystem safety.

## Cleanup Function

**cleanupOldTraces(projectRoot: string, keepCount: number = 500): Promise<number>** deletes oldest trace files exceeding `keepCount` retention limit, sorts by lexicographic timestamp order (ISO 8601 descending), returns count of deleted files, throws on filesystem errors except ENOENT.

## Implementation Classes

**NullTraceWriter** implements ITraceWriter with no-op methods (`emit()` and `finalize()` are empty), `filePath` returns empty string, used when `--trace` flag absent.

**TraceWriter** implements ITraceWriter with:
- `seq` counter incremented on each `emit()` call (starts at 0)
- `startHr` captures `process.hrtime.bigint()` at construction for `elapsedMs` calculation
- `writeQueue: Promise<void>` serializes concurrent writes via promise chaining (identical pattern to PlanTracker in `plan-tracker.ts`)
- `fd: FileHandle | null` lazily opened on first `emit()` call with append mode (`'a'`)
- `emit()` constructs full event by spreading partial payload, appending base fields, stringifying to JSON + `\n`, chaining async write to `writeQueue`, swallowing errors (trace loss acceptable)
- `finalize()` awaits `writeQueue`, closes `fd` if non-null

## Type Engineering

**DistributiveOmit<T, K>** utility type defined as `T extends unknown ? Omit<T, K> : never` distributes `Omit` operation across discriminated union members, required because TypeScript's built-in `Omit<Union, Keys>` incorrectly removes keys from entire union instead of per-member. Referenced in MEMORY.md learning note.

## Integration Points

Threaded through **CommandRunOptions.tracer** parameter (see `types.ts` in `src/orchestration/`) into:
- **pool.ts** — emits worker:start/end, task:pickup/done events
- **runner.ts** — emits phase:start/end, task:start events
- **subprocess.ts** (via AIService) — emits subprocess:spawn/exit, retry events
- **walker.ts** (discovery) — emits discovery:start/end, filter:applied events
- **orchestrator.ts** (generation) — emits plan:created events
- **loader.ts** (config) — emits config:loaded events

## Resource Management

`writeQueue` promise chain prevents NDJSON corruption from concurrent pool workers by serializing all `fd.write()` calls. `mkdir()` called lazily on first write with `recursive: true`. `finalize()` waits for all pending writes before closing file handle, preventing truncation. Trace write errors caught and swallowed (non-critical — trace loss acceptable per comment).

## Constants

**TRACES_DIR** = `'.agents-reverse-engineer/traces'` defines output directory relative to project root.

## Retention Policy

Default **keepCount** = 500 in `cleanupOldTraces()` mirrors pattern in `src/ai/telemetry/cleanup.ts`. Cleanup triggered after each run (not shown in this file, invoked by caller).