<!-- Generated by agents-reverse-engineer v1.1.0 -->

# orchestration

Orchestrates two-phase AI-driven documentation generation (concurrent file analysis → depth-ordered directory synthesis), incremental updates with frontmatter-based change detection, worker-pool concurrency control, streaming progress telemetry, and NDJSON trace logging for reproduction debugging.

## Contents

- [`index.ts`](./index.ts): Barrel export re-exporting `CommandRunner`, `ProgressReporter`, `ProgressLog`, `PlanTracker`, `runPool`, `createTraceWriter`, `cleanupOldTraces`, and types (`FileTaskResult`, `RunSummary`, `ProgressEvent`, `CommandRunOptions`, `PoolOptions`, `TaskResult`, `ITraceWriter`, `TraceEvent`, `TraceEventPayload`) from subsystem modules.
- [`orchestrator.ts`](./orchestrator.ts): `DocumentationOrchestrator` coordinates generation and update workflows via `createPlan` (discovery → file filtering → complexity analysis → task building → directory filtering) and `preparePlan` (git-based change detection → frontmatter hash comparison → orphan cleanup → affected directory computation). Exports `createOrchestrator`, `createUpdateOrchestrator` factories. Methods include `prepareFiles`, `filterExistingFiles`, `filterExistingDirectories`, `createFileTasks` (embeds `buildFilePrompt` with existingSum context), `createDirectoryTasks`, `markDirtyWithAncestors`, `checkPrerequisites`, `isFirstRun`.
- [`runner.ts`](./runner.ts): `CommandRunner.executeGenerate` runs pre-phase-1 cache load (concurrency 20 `.sum` reads) → phase-1 file analysis (`runPool` at config concurrency, writes `.sum`/`.annex` via `writeSumFile`/`writeAnnexFile`) → post-phase-1 quality checks (`checkCodeVsDoc`, `checkCodeVsCode` at concurrency 10) → phase-2 directory synthesis (depth-sorted `buildDirectoryPrompt`, writes `AGENTS.md`/`CLAUDE.md`) → post-phase-2 phantom path validation. `executeUpdate` runs phase-1-only for incremental updates. Uses `stripPreamble`, `extractPurpose` helpers.
- [`pool.ts`](./pool.ts): `runPool` executes task factories via shared-iterator worker pattern at bounded concurrency, returns indexed `TaskResult<T>[]`, emits `worker:start`, `task:pickup`, `task:done`, `worker:end` trace events. Supports `failFast` abort mode, `onComplete` callback per task settlement.
- [`progress.ts`](./progress.ts): `ProgressReporter` emits `[X/Y] ANALYZING/DONE/FAIL` console output with moving-average ETA calculation (sliding window size 10). `ProgressLog` mirrors stripped output to `.agents-reverse-engineer/progress.log` via promise-chain serialized writes. Methods: `onFileStart`, `onFileDone`, `onFileError`, `onDirectoryStart`, `onDirectoryDone`, `printSummary`, `formatETA`, `formatDirectoryETA`.
- [`plan-tracker.ts`](./plan-tracker.ts): `PlanTracker` updates `GENERATION-PLAN.md` checkboxes via in-memory edit + promise-chain serialization. Methods: `initialize` (write initial plan), `markDone` (replace `- [ ]` with `- [x]` for item path), `flush` (drain write queue).
- [`trace.ts`](./trace.ts): `createTraceWriter` factory returns `NullTraceWriter` (no-op) when disabled, otherwise `TraceWriter` appending NDJSON to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` with auto-populated `seq`, `ts`, `pid`, `elapsedMs` fields. `cleanupOldTraces` deletes traces beyond `keepCount` (default 500). `ITraceWriter` interface: `emit`, `finalize`, `filePath`. `TraceEvent` union: `PhaseStartEvent`, `PhaseEndEvent`, `WorkerStartEvent`, `WorkerEndEvent`, `TaskPickupEvent`, `TaskDoneEvent`, `TaskStartEvent`, `SubprocessSpawnEvent`, `SubprocessExitEvent`, `RetryEvent`, `DiscoveryStartEvent`, `DiscoveryEndEvent`, `FilterAppliedEvent`, `PlanCreatedEvent`, `ConfigLoadedEvent`.
- [`types.ts`](./types.ts): Defines `FileTaskResult` (per-file AI result with `path`, `success`, `tokensIn`, `tokensOut`, `cacheReadTokens`, `cacheCreationTokens`, `durationMs`, `model`), `RunSummary` (aggregated metrics with `filesProcessed`, `filesFailed`, `filesSkipped`, `dirsProcessed`, `dirsFailed`, `dirsSkipped`, `totalCalls`, token counts, `totalDurationMs`, `errorCount`, `retryCount`, `totalFilesRead`, `uniqueFilesRead`, quality metrics), `ProgressEvent` (real-time notification with `type`, `filePath`, `index`, `total`), `CommandRunOptions` (execution config with `concurrency`, `failFast`, `tracer`, `progressLog`, `variant`, `debug`, `dryRun`).

## Architecture

**Two-Phase Pipeline**: Phase 1 (file analysis) reads source content, invokes AI service with `buildFilePrompt` (includes existingSum for incremental updates), writes `.sum` files with frontmatter (`summary`, `metadata.purpose`, `generatedAt`, `contentHash`), writes `.annex.sum` if response contains `## Annex References`. Phase 2 (directory synthesis) groups tasks by depth, processes depth levels in descending order (deepest-first post-order), invokes `buildDirectoryPrompt`, writes `AGENTS.md`/`CLAUDE.md`. Quality checks run post-phase-1 (`checkCodeVsDoc` stale/fresh, `checkCodeVsCode` per directory at concurrency 10) and post-phase-2 (`checkPhantomPaths` per `AGENTS.md`).

**Incremental Update Flow**: `preparePlan` discovers files, reads `content_hash` from `.sum` frontmatter, computes current hash, partitions into `filesToAnalyze` (added/modified) and `filesToSkip` (unchanged hash), calls `cleanupOrphans` for deleted files, calls `getAffectedDirectories` (sorted depth-descending), pre-builds `fileTasks` with `buildFilePrompt` (embeds existingSum), returns `UpdatePlan` with `baseCommit`, `currentCommit`, `isFirstRun` flag. Caller (`cli/update.ts`) runs phase-1 via `executeUpdate`, regenerates `AGENTS.md` for affected directories.

**Concurrency Control**: File tasks execute via `runPool(fileTasks, {concurrency: options.concurrency})`, directory tasks via `runPool(dirTasks, {concurrency: Math.min(options.concurrency, dirsAtDepth.length)})` per depth level. Shared-iterator pattern eliminates batch idling. Quality checks throttled at concurrency 10. Pre-phase-1 cache reads throttled at concurrency 20.

**Telemetry & Tracing**: `ProgressReporter` emits real-time console output with ETA, `ProgressLog` mirrors to `.agents-reverse-engineer/progress.log`. `TraceWriter` appends NDJSON events (`phase:start`, `phase:end`, `worker:start`, `worker:end`, `task:pickup`, `task:done`, subprocess/retry events) to `.agents-reverse-engineer/traces/trace-{timestamp}.ndjson`. `CommandRunner` aggregates `RunSummary` from `AIService.getSummary()` plus runner metrics (`filesProcessed`, `dirsProcessed`, quality counts).

## File Relationships

`DocumentationOrchestrator` prepares execution plans consumed by `CommandRunner`. `CommandRunner.executeGenerate` invokes `runPool` for concurrent file/directory task execution, uses `PlanTracker` for checkbox updates, `ProgressReporter` for console telemetry, `TraceWriter` for NDJSON logging. `runPool` emits trace events consumed by `TraceWriter`. `ProgressReporter` delegates to `ProgressLog` for file mirroring. `DocumentationOrchestrator.createFileTasks` embeds prompts via `buildFilePrompt` from `generation/prompts`, reads existing `.sum` via `readSumFile` from `generation/writers/sum` for incremental context. `CommandRunner` writes artifacts via `writeSumFile`, `writeAnnexFile`, `writeAgentsMd`, `writeClaudeMdPointer` from `generation/writers`.

## Behavioral Contracts

**Progress Log Path**: `.agents-reverse-engineer/progress.log` (from `PROGRESS_LOG_FILENAME` constant).

**Trace Path Pattern**: `.agents-reverse-engineer/traces/trace-{ISO8601-with-dashes}.ndjson` where timestamp uses `.replace(/[:.]/g, '-')`.

**Generation Plan Path**: `.agents-reverse-engineer/GENERATION-PLAN.md`.

**Phase-1 Output Format**:
```
[X/Y] ANALYZING path
[X/Y] DONE path Xs in/out tok model ~ETA
[X/Y] FAIL path error
```

**Phase-2 Output Format**:
```
[dir X/Y] ANALYZING dirPath/AGENTS.md
[dir X/Y] DONE dirPath/AGENTS.md Xs in/out tok model ~ETA
```

**ETA Calculation**: Moving average of last 10 completion times (`windowSize: 10`), displayed after ≥2 completions as ` ~Ns remaining` or ` ~Mm Ss remaining`.

**ANSI Strip Regex**: `/\x1b\[[0-9;]*m/g` for plain-text log mirroring.

**Annex Trigger**: Presence of `## Annex References` in stripped response text triggers `writeAnnexFile(absolutePath, sourceContent, variant)`.

**Preamble Strip Patterns**: (1) Content after `\n---\n` separator within first 500 chars, (2) Content starting at first `**[A-Z]` if preceding text <300 chars and lacks `##`. `PREAMBLE_PREFIXES`: `['now i', 'perfect', 'based on', 'let me', 'here is', 'i\'ll', 'i will', 'great', 'okay', 'sure', 'certainly', 'alright']` (case-insensitive).

**Purpose Extraction**: First non-header, non-separator, non-preamble line after stripping preamble prefixes and bold markdown `**...**`, truncated to 120 chars.

**Directory Dirty Propagation**: `markDirtyWithAncestors` marks entire parent chain from leaf to project root ('.') when any file changes, forcing `AGENTS.md` regeneration up the tree.

**Quality Check Concurrency**: Code-vs-doc, code-vs-code, phantom paths run at concurrency 10 via `runPool`.

**Depth Sorting**: Directory tasks grouped by `metadata.depth`, processed in descending order (deepest-first) for post-order aggregation.

**Variant Filenames**: When `variant` set, reads from `.sum.${variant}` paths via `getSumPath`, writes `AGENTS.${variant}.md` hub via `writeAgentsMdHub`, validates phantom paths in `AGENTS.${variant}.md`.

**Tracer Integration**: `CommandRunner` calls `aiService.setTracer(tracer)` if `options.tracer` present, emits `phase:start`/`phase:end` events with labels `pre-phase-1-cache`, `phase-1-files`, `post-phase-1-quality`, `phase-2-dirs-depth-${depth}`, `update-phase-1-files`, `update-post-phase-1-quality`.

**Error Handling**: Quality checks wrapped in try-catch, errors logged via `console.error` but do not propagate. Trace write failures swallowed (`.catch(() => {})`). ProgressLog write failures swallowed silently.

**Trace Cleanup**: `cleanupOldTraces` sorts trace files lexicographically newest-first, retains first `keepCount` (default 500), deletes rest.

**Pool Abort Mode**: `failFast: true` sets `aborted` flag stopping iterator consumption after first task failure.

**Task Result Indexing**: `runPool` returns sparse array indexed by original task position, preserving input order. `onComplete` callback fires with indexed result after each task settlement.