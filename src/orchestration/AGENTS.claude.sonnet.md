<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/orchestration

The `src/orchestration` directory implements concurrency pooling, progress tracking, tracing, and execution orchestration for the two-phase AI-driven documentation generation pipeline (Phase 1: file analysis via concurrent AI calls; Phase 2: directory AGENTS.md synthesis in post-order by depth).

## Contents

- [**index.ts**](./index.ts): Barrel export re-exporting `FileTaskResult`, `RunSummary`, `ProgressEvent`, `CommandRunOptions`, `PoolOptions`, `TaskResult`, `ITraceWriter`, `TraceEvent`, `TraceEventPayload`, `runPool`, `createTraceWriter`, `cleanupOldTraces`, `ProgressReporter`, `ProgressLog`, `PlanTracker`, `CommandRunner`.

- [**orchestrator.ts**](./orchestrator.ts): `DocumentationOrchestrator` unifies generation and incremental update workflows; exports `PreparedFile` (filePath/relativePath/content), `AnalysisTask` (type: 'file'|'directory', filePath, systemPrompt/userPrompt, directoryInfo), `GenerationPlan` (files, tasks, complexity, projectStructure, skippedFiles/Dirs), `UpdatePlan` (filesToAnalyze, fileTasks, affectedDirs sorted deepest-first, baseCommit/currentCommit, isFirstRun); `createPlan()` calls `filterExistingFiles`/`filterExistingDirectories` for artifact skip logic (unless force=true), `analyzeComplexity`, `buildProjectStructure`, `createFileTasks`, `createDirectoryTasks`; `preparePlan()` compares `content_hash` from `.sum` frontmatter via `readSumFile`/`computeContentHash`, calls `cleanupOrphans`/`getAffectedDirectories`; memory-release: clears `PreparedFile.content` after prompt building.

- [**plan-tracker.ts**](./plan-tracker.ts): `PlanTracker` orchestrates concurrent markdown checkbox updates in `GENERATION-PLAN.md`; `markDone(itemPath)` replaces `- [ ]` with `- [x]` in-memory, queues serialized write via promise-chain to `.agents-reverse-engineer/GENERATION-PLAN.md`; `flush()` waits for queue completion.

- [**pool.ts**](./pool.ts): `runPool<T>(tasks, options, onComplete?)` executes `() => Promise<T>` factories via shared-iterator worker pattern (all workers pull from single `tasks.entries()` iterator for atomic work distribution), returns `TaskResult<T>[]` (index/success/value/error) indexed by original position; `PoolOptions` configures concurrency, failFast, tracer, phaseLabel, taskLabels; emits `worker:start`, `task:pickup`, `task:done`, `worker:end` trace events; effective concurrency capped at `Math.min(options.concurrency, tasks.length)`.

- [**progress.ts**](./progress.ts): `ProgressReporter` outputs streaming build-log progress with ETA calculation via moving-average of last 10 completion times (`completionTimes`/`dirCompletionTimes` sliding windows, `windowSize=10`); `onFileStart`, `onFileDone(durationMs, tokensIn, tokensOut, model, cacheReadTokens, cacheCreationTokens)`, `onFileError`, `onDirectoryStart`, `onDirectoryDone`, `printSummary(RunSummary)` log colored status lines (cyan=start, green=done, red=fail, blue=dir-done) via `picocolors`; `ProgressLog` mirrors plain-text output to `.agents-reverse-engineer/progress.log` using promise-chain serialization, `stripAnsi()` removes ANSI codes; ETA formatted as `~Xs remaining` or `~Mm Ss remaining` after 2+ completions.

- [**runner.ts**](./runner.ts): `CommandRunner` orchestrates `executeGenerate(plan)` (two-phase pipeline: Phase 1 file analysis via `runPool(plan.fileTasks)` calling `aiService.call`, `computeContentHashFromString`, `writeSumFile`/`writeAnnexFile`, caching in `sourceContentCache`; Post-Phase 1 `checkCodeVsDoc`/`checkCodeVsCode` quality checks grouped by dir with concurrency 10; Phase 2 groups `plan.directoryTasks` by `metadata.depth`, processes descending depth via `buildDirectoryPrompt`, `writeAgentsMd`/`writeAgentsMdHub`/`writeClaudeMdPointer`; Post-Phase 2 `checkPhantomPaths`) and `executeUpdate(fileTasks)` (Phase 1 only for changed files); returns `RunSummary` with version, token counts, cache stats, duration, error/retry counts, inconsistency counts, phantom paths; variant support via `options.variant` alters filenames to `AGENTS.${variant}.md`; `stripPreamble()` removes LLM preamble via `\n---\n` or bold purpose detection within first 500 chars, skips `PREAMBLE_PREFIXES` lines; `PlanTracker` writes `GENERATION-PLAN.md`, `ProgressReporter` logs progress.

- [**trace.ts**](./trace.ts): `createTraceWriter(projectRoot, enabled)` factory returns `NullTraceWriter` (zero overhead when disabled) or `TraceWriter` appending NDJSON to `.agents-reverse-engineer/traces/trace-{timestamp}.ndjson` (ISO 8601 with `:` and `.` replaced by `-`); `ITraceWriter.emit(TraceEventPayload)` auto-populates `seq`, `ts`, `pid`, `elapsedMs`; `TraceEvent` discriminated union includes `phase:start` (phase, taskCount, concurrency), `phase:end` (phase, durationMs, tasksCompleted, tasksFailed), `worker:start`/`worker:end` (workerId, phase), `task:pickup`/`task:done` (workerId, taskIndex, taskLabel, activeTasks, durationMs, success), `subprocess:spawn`/`subprocess:exit` (childPid, command, taskLabel, exitCode, signal, timedOut), `retry` (attempt, taskLabel, errorCode), `discovery:start`/`discovery:end`, `filter:applied`, `plan:created` (planType: 'generate'|'update', fileCount, taskCount), `config:loaded`; promise-chain serialization via `writeQueue` for concurrent-safe appends; `cleanupOldTraces(projectRoot, keepCount=500)` removes old traces beyond retention limit.

- [**types.ts**](./types.ts): `FileTaskResult` captures per-file AI outcome (path, success, tokensIn/Out, cacheReadTokens, cacheCreationTokens, durationMs, model, error?); `RunSummary` aggregates metrics (version, filesProcessed/Failed/Skipped, totalCalls, totalInputTokens/OutputTokens/CacheReadTokens/CacheCreationTokens, totalDurationMs, errorCount, retryCount, totalFilesRead, uniqueFilesRead, inconsistenciesCodeVsDoc/CodeVsCode, dirsProcessed/Failed/Skipped, phantomPaths, inconsistencyReport?); `ProgressEvent` reports task lifecycle (type: 'start'|'done'|'error'|'dir-done', filePath, index, total, durationMs?, tokensIn?, tokensOut?, model?, error?); `CommandRunOptions` controls execution (concurrency, failFast?, debug?, dryRun?, tracer?, progressLog?, variant?).

## Architecture

**Two-Phase Pipeline**: Phase 1 processes file tasks concurrently via `runPool` with user-specified concurrency, calling AI service to generate `.sum` files, caching source content for quality checks; Post-Phase 1 runs `checkCodeVsDoc` (stale doc detection via `oldSumCache` + LLM omission detection) and `checkCodeVsCode` (cross-file identifier inconsistencies) grouped by directory; Phase 2 groups directory tasks by depth, processes descending (deepest-first = post-order), calling AI to generate `AGENTS.md` via `buildDirectoryPrompt`; Post-Phase 2 runs `checkPhantomPaths` for each `AGENTS.md`. **Update Workflow**: `preparePlan()` compares `content_hash` from `.sum` frontmatter against `computeContentHash` of current content, marks files with mismatched hashes as 'modified', missing `.sum` as 'added'; calls `cleanupOrphans` for deleted files, `getAffectedDirectories` sorted deepest-first; builds `fileTasks` via `createFileTasks` with existing `.sum` content for incremental context; `executeUpdate()` runs Phase 1 only.

**Concurrency Pooling**: `runPool` implements shared-iterator pattern: all workers call `iterator.next()` on single `tasks.entries()` instance for atomic work distribution, avoiding batch-and-wait anti-patterns; effective concurrency capped at `Math.min(options.concurrency, tasks.length)`; `activeTasks` counter tracks in-flight work; emits `worker:start`, `task:pickup`, `task:done`, `worker:end` trace events.

**Progress Tracking**: `ProgressReporter` logs colored status lines (cyan/green/red/blue) via `picocolors`, computes ETA via moving-average of last 10 completion times (`completionTimes`/`dirCompletionTimes` sliding windows, `windowSize=10`), formats as `~Xs remaining` or `~Mm Ss remaining` after 2+ completions; `ProgressLog` mirrors plain-text output to `.agents-reverse-engineer/progress.log` via promise-chain serialization, strips ANSI via regex `/\x1b\[[0-9;]*m/g`. `PlanTracker` writes `GENERATION-PLAN.md` via `formatExecutionPlanAsMarkdown`, marks tasks done via `markDone(itemPath)` (replaces `- [ ]` with `- [x]`), flushes writes via `flush()`.

**Tracing**: `createTraceWriter` factory returns `NullTraceWriter` (zero overhead when disabled) or `TraceWriter` appending NDJSON to `.agents-reverse-engineer/traces/trace-{timestamp}.ndjson`; `ITraceWriter.emit(TraceEventPayload)` auto-populates `seq`, `ts`, `pid`, `elapsedMs`; `TraceEvent` discriminated union includes phase lifecycle, worker lifecycle, task lifecycle, subprocess lifecycle, retry events, discovery events, filter events, plan creation events, config load events; promise-chain serialization via `writeQueue` for concurrent-safe appends from pool workers.

**Memory Management**: `orchestrator.ts` releases file content from `PreparedFile` objects after `createFileTasks` builds prompts by setting `content = ''`, as `runner.ts` re-reads files from disk; `runner.ts` clears `sourceContentCache` after Post-Phase 1 quality checks, clears `updateSourceCache` after update quality checks.

**Variant Support**: `options.variant` enables side-by-side model comparison; variant name passed to `getSumPath`, `writeSumFile`, `writeAnnexFile`, `buildDirectoryPrompt`, `writeAgentsMd`, `writeAgentsMdHub`; `AGENTS.md` filename becomes `AGENTS.${variant}.md`.

## Behavioral Contracts

**Progress Log Path**: `.agents-reverse-engineer/progress.log` (`PROGRESS_LOG_FILENAME = 'progress.log'`).

**Trace Path**: `.agents-reverse-engineer/traces/trace-{timestamp}.ndjson` where timestamp is ISO 8601 with `:` and `.` replaced by `-`.

**Trace Format**: NDJSON (one JSON object per line with `\n` terminator); auto-populated fields: `seq` (monotonic counter), `ts` (ISO 8601), `pid` (`process.pid`), `elapsedMs` (from `process.hrtime.bigint() - startHr` / `1_000_000`).

**Plan File Path**: `.agents-reverse-engineer/GENERATION-PLAN.md`.

**Checkbox Replacement**: `- [ ] \`${itemPath}\`` → `- [x] \`${itemPath}\``.

**ETA Calculation**: Average of last 10 completion times × remaining tasks; formatted as `~Xs remaining` (<60s) or `~Mm Ss remaining` (≥60s); shown after 2+ completions.

**Preamble Detection**: Strips text before `\n---\n` within first 500 chars OR before bold purpose line (`**[A-Z]`) within 500 chars; skips lines starting with `#`, `---`, or preamble prefixes: `'now i'`, `'perfect'`, `'based on'`, `'let me'`, `'here is'`, `'i\'ll'`, `'i will'`, `'great'`, `'okay'`, `'sure'`, `'certainly'`, `'alright'`.

**Quality Check Concurrency**: Pre-Phase 1 cache reading (concurrency 20), Post-Phase 1 inconsistency detection (concurrency 10), `checkCodeVsCode` grouped by directory (concurrency 10), phantom path checks (inline, one per `AGENTS.md`).

**Trace Cleanup Retention**: `cleanupOldTraces(projectRoot, keepCount=500)` retains 500 most recent traces by default, deletes older entries sorted lexicographically.