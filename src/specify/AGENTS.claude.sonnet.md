<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/specify
The `src/specify` directory provides `/are-specify` command implementation, transforming collected `AGENTS.md` documentation into comprehensive project specifications via AI synthesis with strict structural contracts.

## Contents
- [`index.ts`](./index.ts): Barrel module exporting `buildSpecPrompt`, `SpecPrompt`, `writeSpec`, `WriteSpecOptions`, `SpecExistsError` from `prompts.js` and `writer.js`.
- [`prompts.ts`](./prompts.ts): Exports `SpecPrompt` interface and `buildSpecPrompt(docs, annexFiles)` function; generates `SPEC_SYSTEM_PROMPT` enforcing 12-section specification structure with verbatim reproduction mandates for behavioral contracts and annex content.
- [`writer.ts`](./writer.ts): Exports `writeSpec(content, options)` function and `SpecExistsError` class; writes specification markdown with overwrite protection, supports multi-file splitting on `# ` headings via `slugify()` transformation.

## Architecture
Spec generation follows three-stage pipeline: (1) `buildSpecPrompt()` constructs AI prompt from `AgentsDocs` collection, injecting annexes for reproduction-critical content; (2) AI backend (via `../ai/service.js`) synthesizes specification adhering to `SPEC_SYSTEM_PROMPT` structural requirements; (3) `writeSpec()` persists output to `specs/SPEC.md` or split files with existence validation.

## Data Flow
`/are-specify` command invokes `src/cli/specify.ts` → calls `buildSpecPrompt(docs, annexFiles)` → passes `SpecPrompt.system`/`SpecPrompt.user` to AI service → receives specification text → calls `writeSpec(content, {outputPath, force, multiFile})` → writes final markdown to disk.

## Behavioral Contracts

**12-section specification structure (SPEC_SYSTEM_PROMPT):**
1. Project Overview
2. Architecture
3. Public API Surface
4. Data Structures & State
5. Configuration
6. Dependencies
7. Behavioral Contracts (split into 7a Runtime Behavior, 7b Implementation Contracts)
8. Test Contracts
9. Build Plan (phases with "Defines:" and "Consumes:" lists)
10. Prompt Templates & System Instructions
11. IDE Integration & Installer
12. File Manifest

**Organization mandate:** group by CONCERN, not directory structure; prohibits folder-mirroring and exact file path prescription.

**Build Plan requirements:** each phase MUST list `Defines:` (exact exported types/functions/classes from Public API Surface) and `Consumes:` (dependencies on prior phases); every API Surface item must appear in exactly one phase's Defines list.

**Reproduction-critical content (section 7b):** MUST reproduce verbatim regex patterns (backticked), format strings, output templates, magic constants, sentinel values, environment variable names, file format specifications (YAML schemas, NDJSON structures). Sections 10-11 MUST reproduce annex content (prompt templates, IDE templates, installer configs) verbatim in fenced code blocks preserving placeholder syntax like `{{TOKEN}}`; prohibits summarization or paraphrasing.

**Multi-file splitting behavior:**
- Pattern: `/^(?=# )/m` (lines starting with exactly `# `)
- Filename transform: `slugify()` applies `.toLowerCase()`, `\s+` → `-`, strips `[^a-z0-9-]`, collapses `/-+/g` → `-`, trims `/^-|-$/g`
- Pre-heading content: written to `00-preamble.md`
- Directory: `outputPath` parent directory

**Overwrite protection:**
- `writeSpec()` throws `SpecExistsError` with `paths: string[]` when `force=false` and target files exist
- Multi-file mode checks ALL targets before writing any file
- `fileExists()` uses `access(filePath, constants.F_OK)`, returns `false` on errors

## File Relationships
`index.ts` barrel re-exports `prompts.ts` prompt builder and `writer.ts` disk persistence; `prompts.ts` imports `AgentsDocs` from `../generation/collector.js`; `writer.ts` operates independently with Node.js `fs/promises` API.

## API Surface
- `buildSpecPrompt(docs: AgentsDocs, annexFiles?: AgentsDocs): SpecPrompt` — constructs system/user prompt pair
- `writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>` — writes spec files, returns absolute paths
- `SpecPrompt: {system: string, user: string}` — prompt structure
- `WriteSpecOptions: {outputPath: string, force: boolean, multiFile: boolean}` — writer configuration
- `SpecExistsError extends Error` — overwrite protection error with `paths: string[]`

## Reproduction-Critical Constants
Full system prompt template: see `SPEC_SYSTEM_PROMPT` in [`prompts.ts`](./prompts.ts) (81 lines, mandates 12-section structure with verbatim reproduction requirements).