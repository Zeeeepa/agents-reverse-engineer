<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/specify

Synthesizes project specifications from `AGENTS.md` documentation by assembling AI prompts that enforce 12-section mandatory structure and orchestrating file writes with multi-file splitting.

## Contents

- **[`index.ts`](./index.ts)**: Barrel exports `buildSpecPrompt`, `SpecPrompt`, `writeSpec`, `SpecExistsError`, `WriteSpecOptions` from `prompts.js` and `writer.js`.
- **[`prompts.ts`](./prompts.ts)**: Exports `buildSpecPrompt(docs, annexFiles?)` assembling system+user prompt pair with section delimiters, `SpecPrompt` interface (`system`/`user` fields), `SPEC_SYSTEM_PROMPT` constant (250-line template enforcing conceptual grouping, module boundaries, verbatim reproduction rules).
- **[`writer.ts`](./writer.ts)**: Exports `writeSpec(content, options)` writing markdown to single file or multi-file tree via `splitByHeadings()`, `WriteSpecOptions` interface (`outputPath`/`force`/`multiFile`), `SpecExistsError` with `paths: string[]` property.

## Data Flow

`buildSpecPrompt` maps `AgentsDocs` entries to `### ${relativePath}\n\n${content}` sections, appends annex files if provided, injects 12-section requirement list (Project Overview → Architecture → Public API Surface → Data Structures → Configuration → Dependencies → Behavioral Contracts split into Runtime Behavior + Implementation Contracts → Test Contracts → Build Plan with `Defines:`/`Consumes:` cross-references → Prompt Templates & System Instructions → IDE Integration & Installer → File Manifest), returns `{ system, user }` pair consumed by `ai/service.ts`. `writeSpec` receives AI-generated content, partitions on `/^(?=# )/m` regex in multi-file mode, validates paths via `fileExists()`, throws `SpecExistsError` if files exist and `force=false`, writes slugified filenames (`00-preamble.md` for pre-heading content, `{slugified-heading}.md` for sections).

## Behavioral Contracts

**Specification Structure**: mandates 12-section order with Behavioral Contracts section 7 split into Runtime Behavior (regex patterns, format specs, magic constants in backticks) and Implementation Contracts (verbatim code excerpts), sections 10-11 (Prompt Templates, IDE Integration) requiring full annex reproduction in fenced code blocks preserving placeholder syntax (e.g., `{{TOKEN}}`). Build Plan (section 9) must cross-reference Public API Surface via `Defines:` lists, File Manifest (section 12) must map every source file to Build Plan phases.

**Multi-File Splitting**:
- Top-level heading regex: `/^(?=# )/m`
- Heading extraction: `/^# (.+)/`
- Preamble filename: `00-preamble.md`
- Slugify: lowercase → whitespace-to-hyphens → strip non-alphanumeric except hyphens → collapse consecutive → trim

**Error Format**: `SpecExistsError` message: `"Spec file(s) already exist:\n{paths with '  - ' prefix}\nUse --force to overwrite."`

**Prohibition Rules**: `SPEC_SYSTEM_PROMPT` forbids exact file paths, directory-mirroring, directory names as headings. Requires module boundaries, full type signatures, exact identifiers, version numbers, explicit phase dependency ordering.

## Annex References

Full `SPEC_SYSTEM_PROMPT` content: [prompts.annex.sum](./prompts.annex.sum) (250-line system prompt enforcing 12-section structure, module boundary organization, reproduction-critical verbatim inclusion).