---
generated_at: 2026-02-09T17:46:04.587Z
content_hash: 1cd35b3f4d654b045247be0ba5624bf20469a0fb17c183876faa4c6897e2d9ee
purpose: writer.ts implements spec output file writing with overwrite protection, single/multi-file mode support, and markdown...
---
**writer.ts implements spec output file writing with overwrite protection, single/multi-file mode support, and markdown heading-based content splitting.**

## Exported Interface

`WriteSpecOptions` interface defines output control:
- `outputPath: string` — absolute path to output file (e.g., `/project/specs/SPEC.md`)
- `force: boolean` — overwrite existing files without throwing `SpecExistsError`
- `multiFile: boolean` — split AI output into separate files by top-level `# ` headings

## Exported Error Class

`SpecExistsError` extends `Error` and is thrown when `writeSpec()` detects existing files and `force=false`:
- `paths: string[]` — readonly array of conflicting file paths
- Constructor formats paths as bulleted list with instruction: `"Use --force to overwrite."`
- `name` property set to `'SpecExistsError'` for discriminated error handling

## Main Export Function

`writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>` writes spec output with two modes:

**Single-file mode** (`multiFile=false`):
- Checks `fileExists(outputPath)` via `access(filePath, constants.F_OK)` and throws `SpecExistsError([outputPath])` if exists and `force=false`
- Creates parent directory via `mkdir(path.dirname(outputPath), { recursive: true })`
- Writes `content` to `outputPath` with `writeFile(outputPath, content, 'utf-8')`
- Returns `[outputPath]` array

**Multi-file mode** (`multiFile=true`):
- Calls `splitByHeadings(content)` to partition content by top-level `# ` headings
- Returns `Array<{ filename: string; content: string }>` with slugified filenames
- Pre-flight checks all target paths `path.join(path.dirname(outputPath), section.filename)` for existence
- Throws `SpecExistsError(conflicts)` with all conflicting paths if any exist and `force=false`
- Creates output directory `mkdir(outputDir, { recursive: true })`
- Writes each section via `writeFile(filePath, section.content, 'utf-8')`
- Returns array of all written absolute paths

## Content Splitting Logic

`splitByHeadings(content: string): Array<{ filename: string; content: string }>` partitions markdown:
- Splits on regex `/^(?=# )/m` matching lines starting with exactly `# ` (top-level headings)
- Iterates parts, extracts heading text via `/^# (.+)/` match
- Passes heading text to `slugify()` for filename generation
- Content before first `# ` heading assigned to `'00-preamble.md'`
- Trims trailing whitespace via `trimEnd()` and appends single newline to each section's `content`

## Filename Sanitization

`slugify(heading: string): string` transforms heading into filesystem-safe slug:
- Lowercases entire string
- Replaces whitespace sequences (`/\s+/g`) with single hyphen
- Strips non-alphanumeric characters except hyphens (`/[^a-z0-9-]/g` → empty string)
- Collapses consecutive hyphens (`/-+/g` → single hyphen)
- Trims leading/trailing hyphens via `/^-|-$/g` replacement
- Returns slugified string used as `${slug}.md` filename

## File Existence Check

`fileExists(filePath: string): Promise<boolean>` wraps Node.js `fs/promises`:
- Calls `access(filePath, constants.F_OK)` to test file accessibility
- Returns `true` on success, `false` on caught exception (file not found or inaccessible)

## Dependencies

Imports from Node.js core:
- `writeFile`, `mkdir`, `access` from `node:fs/promises`
- `constants` from `node:fs` (specifically `constants.F_OK`)
- `path` module for `path.dirname()` and `path.join()`

## Integration Points

Called by `src/specify/index.ts` `generateProjectSpec()` with options from CLI:
- `outputPath` derived from project root and `--output` flag (default `specs/SPEC.md`)
- `force` flag from `--force` CLI option
- `multiFile` flag from `--multi-file` CLI option
- Caller catches `SpecExistsError` and logs `error.message` to stderr