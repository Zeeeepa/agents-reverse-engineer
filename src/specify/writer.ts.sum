---
generated_at: 2026-02-09T15:08:14.766Z
content_hash: 1cd35b3f4d654b045247be0ba5624bf20469a0fb17c183876faa4c6897e2d9ee
purpose: writeSpec() writes AI-generated specification markdown to disk with overwrite protection, slugified filename generati...
---
**writeSpec() writes AI-generated specification markdown to disk with overwrite protection, slugified filename generation from heading splits, and multi-file mode splitting on top-level `# ` heading boundaries.**

## Exported Interface

**WriteSpecOptions** configures spec output behavior:
- `outputPath: string` — full path to output file (e.g., `/project/specs/SPEC.md`)
- `force: boolean` — overwrite existing files without error
- `multiFile: boolean` — split AI output into multiple files by top-level `# ` headings

**SpecExistsError** extends Error, thrown when writeSpec() detects existing file(s) and `force=false`:
- `paths: readonly string[]` — paths of conflicting files
- Constructor accepts `string[]` and formats multi-line error message with `--force` hint

**writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>** orchestrates spec file writing:
- Single-file mode: writes `content` directly to `options.outputPath`
- Multi-file mode: calls splitByHeadings(), writes each section to `path.join(dirname(outputPath), section.filename)`
- Returns array of absolute paths to all written files
- Throws SpecExistsError if any target file exists and `force=false`
- Creates parent directories via `mkdir({ recursive: true })`
- Pre-checks all target files for existence before writing any (atomic conflict detection)

## Internal Functions

**fileExists(filePath: string): Promise<boolean>** checks file existence via `access(filePath, constants.F_OK)`, returns true on success, false on catch block entry.

**slugify(heading: string): string** sanitizes heading string into filename-safe slug via `.toLowerCase()` → `.replace(/\s+/g, '-')` → `.replace(/[^a-z0-9-]/g, '')` → `.replace(/-+/g, '-')` → `.replace(/^-|-$/g, '')`.

**splitByHeadings(content: string): Array<{ filename: string; content: string }>** splits markdown on `/^(?=# )/m` regex (positive lookahead for lines starting with `# `):
- Iterates parts, extracts heading text via `/^# (.+)/` match, calls slugify() to generate filename
- Content before first heading placed into `00-preamble.md`
- Empty slugs default to `00-preamble.md`
- Returns array of `{ filename, content }` pairs with `content` trimmed and newline-terminated

## Multi-File Split Strategy

Multi-file mode operates on `dirname(outputPath)` as target directory. Splits on top-level `# ` headings only (not `## ` or `### `). Filename generation pattern: `slugify(headingText) + '.md'`. Conflict detection checks all section target paths before writing any files, preventing partial writes on overwrite protection failures.

## Dependencies

Imports `writeFile`, `mkdir`, `access` from `node:fs/promises`, `constants` from `node:fs`, `path` from `node:path` for file system operations and path manipulation. No external npm dependencies.