---
generated_at: 2026-02-09T21:30:29.483Z
content_hash: 1cd35b3f4d654b045247be0ba5624bf20469a0fb17c183876faa4c6897e2d9ee
purpose: writeSpec() orchestrates single-file or multi-file specification output with overwrite protection, slugified heading-...
---
**writeSpec() orchestrates single-file or multi-file specification output with overwrite protection, slugified heading-based splitting, and existence-check guardrails for the `/are-specify` command.**

## Exported Interface

**WriteSpecOptions** configures output behavior:
- `outputPath: string` — absolute path to target file (e.g., `/project/specs/SPEC.md`)
- `force: boolean` — bypass existence checks to overwrite files
- `multiFile: boolean` — split AI output on top-level `# ` headings into separate files

**SpecExistsError** extends `Error` with `paths: string[]` property listing conflicting file paths. Constructor message formats paths as bullet list with `"Use --force to overwrite."` suffix.

**writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>** writes specification markdown to disk:
- Single-file mode: writes `content` directly to `outputPath` after `mkdir(dirname(outputPath), { recursive: true })`
- Multi-file mode: calls `splitByHeadings(content)` to partition on `/^# /m` regex, writes each section to `dirname(outputPath)/<slug>.md`
- Pre-write existence check: aggregates conflicts via `fileExists()` and throws `SpecExistsError` unless `force=true`
- Returns array of absolute paths for all written files

## Heading-Based Splitting

**splitByHeadings(content: string): Array<{ filename: string; content: string }>** partitions markdown on top-level headings:
- Splits via `/^(?=# )/m` regex (positive lookahead for lines starting with `# `)
- Extracts heading text via `/^# (.+)/` match, transforms via `slugify()`
- Pre-heading content assigned to `00-preamble.md` filename
- Each section object contains `{ filename, content }` with trailing newline appended

**slugify(heading: string): string** sanitizes heading text into filename-safe slug:
- Lowercases via `.toLowerCase()`
- Replaces whitespace with hyphens via `/\s+/g` → `'-'`
- Strips non-alphanumeric characters (except hyphens) via `/[^a-z0-9-]/g` → `''`
- Collapses consecutive hyphens via `/-+/g` → `'-'`
- Trims leading/trailing hyphens via `/^-|-$/g` → `''`

## File System Operations

**fileExists(filePath: string): Promise<boolean>** checks file existence:
- Invokes `access(filePath, constants.F_OK)` from `node:fs/promises`
- Returns `true` on success, `false` on rejection (file not found)

**Multi-file conflict detection:** Before writing any files in multi-file mode, iterates all sections to check existence via `fileExists()`. Aggregates conflicts into array and throws `SpecExistsError` if non-empty and `force=false`. Ensures atomic write operation (all-or-nothing).

## Integration Context

Consumed by `src/cli/specify.ts` after AI synthesis completes. The `outputPath` parameter receives value from `config.output.specPath` (default: `specs/SPEC.md`). The `--force` CLI flag maps to `WriteSpecOptions.force`. The `--multi-file` CLI flag maps to `WriteSpecOptions.multiFile`.