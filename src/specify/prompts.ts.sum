---
generated_at: 2026-02-09T21:30:37.009Z
content_hash: ad77f5938367b83507e390b679f6d580ab95cdf478b977886398559a9e703d38
purpose: prompts.ts defines the system prompt template and prompt construction logic for AI-driven specification synthesis fro...
---
**prompts.ts defines the system prompt template and prompt construction logic for AI-driven specification synthesis from AGENTS.md documentation corpus.**

## Exported Interface

`SpecPrompt` interface encapsulates prompt pair with `system: string` and `user: string` properties for AI service consumption.

## Exported Functions

`buildSpecPrompt(docs: AgentsDocs, annexFiles?: AgentsDocs): SpecPrompt` constructs complete prompt pair by:
- Mapping `docs` array to markdown sections with `### ${doc.relativePath}` headers and embedded `doc.content`
- Conditionally appending annex sections when `annexFiles` provided (reproduction-critical source files like templates)
- Injecting 11-point section requirement list into user prompt: Project Overview, Architecture, Public API Surface, Data Structures & State, Configuration, Dependencies, Behavioral Contracts (split into Runtime Behavior and Implementation Contracts with verbatim regex/format/constant requirements), Test Contracts, Build Plan (with "Defines:" and "Consumes:" interface contract lists), Prompt Templates & System Instructions (verbatim reproduction), IDE Integration & Installer (verbatim templates)
- Returns `SpecPrompt` with `SPEC_SYSTEM_PROMPT` as system and constructed markdown sections as user

## System Prompt Template

`SPEC_SYSTEM_PROMPT` constant defines 600+ character system instruction enforcing:
- **Audience**: AI agents (LLMs) requiring actionable, instruction-oriented language
- **Organization mandate**: Group by concern (not directory structure), use 11 conceptual sections in prescribed order
- **Anti-patterns**: Prohibits folder-mirroring, exact file path prescription, section headings derived from directory names
- **Module boundary focus**: Describe interfaces and exports rather than filesystem layout
- **Type precision**: Full signatures with parameters, return types, generics for all public APIs
- **Dependency versioning**: Exact version numbers for all external dependencies
- **Build Plan requirements**: Phased implementation with explicit "Defines:" and "Consumes:" lists cross-referencing Public API Surface section, dependency ordering
- **Behavioral contract mandates**: Exact error types/codes with throw conditions, verbatim regex patterns in backticks, format strings and output templates with exact structure, magic constants and sentinel values with meanings, environment variable names with expected values, file format specifications (YAML schemas, NDJSON structures)
- **Reproduction-critical content handling**: Sections 10-11 must reproduce annex file content verbatim (prompt templates, IDE templates, installer configs) without summarization or paraphrasing
- **Output format**: Raw markdown with no preamble, meta-commentary, or conversational prefix

## Prompt Construction Strategy

`buildSpecPrompt` assembles user prompt via:
1. Header: `"Generate a comprehensive project specification from the following documentation."`
2. Section delimiter: `"## AGENTS.md Files (${docs.length} directories)"`
3. Per-document subsections: `agentsSections` array mapping each doc to `### ${relativePath}\n\n${content}`
4. Conditional annex block: When `annexFiles` non-empty, appends `"## Annex Files (${annexFiles.length} reproduction-critical source files)"` followed by annex subsections
5. Requirement checklist: `"## Output Requirements"` followed by 11-item numbered list matching `SPEC_SYSTEM_PROMPT` section order
6. Verbatim mandate: `"Sections 10 and 11 MUST reproduce annex content verbatim. Do NOT summarize prompt templates or IDE templates into prose descriptions."`
7. Output constraint: `"Output ONLY the markdown content. No preamble."`

## Integration Points

Consumed by `src/specify/index.ts` specification synthesis command via `AIService.call()` invocation. Receives `AgentsDocs` from `collectAgentsDocs()` in `src/generation/collector.ts` (recursive AGENTS.md traversal). Optional `annexFiles` parameter populated from `.annex.md` companion files containing verbatim source code for reproduction-critical modules (prompt templates, IDE command templates, installer configs).

## Behavioral Contracts

User prompt sections joined with `'\n'` separator producing multiline string. Section 7 split into subsections: `"7a. Runtime Behavior"` and `"7b. Implementation Contracts"` targeting distinct documentation domains (execution semantics vs. reproduction-critical constants).