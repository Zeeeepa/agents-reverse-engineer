<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/specify

The `specify` directory exports utilities for generating AI-readable project specifications from AGENTS.md documentation. It provides prompt construction for specification synthesis and disk writing with conflict detection and optional multi-file splitting.

## Contents

### Core Exports
- [index.ts](./index.ts) — Barrel re-export of `buildSpecPrompt()`, `writeSpec()`, `SpecPrompt`, `WriteSpecOptions`, and `SpecExistsError`.
- [prompts.ts](./prompts.ts) — Constructs `SpecPrompt` (system + user pair) for AI specification generation; enforces 12-section specification schema via `SPEC_SYSTEM_PROMPT`.
- [writer.ts](./writer.ts) — Writes specification markdown to disk via `writeSpec()`; supports single-file and multi-file (heading-split) modes; enforces overwrite protection via `SpecExistsError`.

## Architecture

`buildSpecPrompt()` ingests `AgentsDocs` and optional annex files (both from `../generation/collector.js`), injects them into the user prompt template, and returns structured `SpecPrompt`. `writeSpec()` accepts AI-generated markdown content and `WriteSpecOptions`, validates output paths, splits on `^# ` regex if multi-file mode, creates parent directories, and returns written absolute paths or throws `SpecExistsError` on conflicts (unless `force=true`).

## Specification Schema (SPEC_SYSTEM_PROMPT)

Mandates 12-section AI reconstruction structure:

1. **Project Overview** — purpose, value proposition, tech stack with versions
2. **Architecture** — module boundaries, data flow, design decisions
3. **Public API Surface** — exported interfaces with full type signatures
4. **Data Structures & State** — types, schemas, config objects, state patterns
5. **Configuration** — options, types, defaults, validation, environment variables
6. **Dependencies** — exact versions and rationale
7. **Behavioral Contracts** — error handling, retry logic, concurrency, lifecycle; verbatim regex patterns in backticks, format strings, magic constants, environment variable names
8. **Test Contracts** — per-module scenarios, edge cases, error conditions
9. **Build Plan** — phased implementation with explicit "Defines:" and "Consumes:" lists cross-referencing Public API Surface
10. **Prompt Templates & System Instructions** — full verbatim text from annex files
11. **IDE Integration & Installer** — command templates, platform configs, permission lists (verbatim)
12. **File Manifest** — exhaustive source file list with relative path, module, public exports

## Behavioral Contracts

**`prompts.ts` enforcement rules:**
- Conceptual grouping by concern, not directory structure
- Module boundaries and interfaces described, not file paths
- Full type signatures for all public APIs
- All external dependency versions included
- Build Plan phases must cross-reference Public API Surface; each phase lists "Defines:" and "Consumes:" with exact names
- Regex patterns, format strings, magic constants reproduced verbatim in backticks
- Sections 10–11 require verbatim annex reproduction
- File Manifest entries must align with Build Plan phases

**`writer.ts` file handling:**
- `fileExists()` checks via `fs.access(..., constants.F_OK)`
- `slugify()` converts headings via lowercase, whitespace→hyphens (`/\s+/g`), strip non-alphanumeric (`/[^a-z0-9-]/g`), collapse hyphens (`/-+/g`), trim edges (`/^-|-$/g`)
- `splitByHeadings()` splits on `^(?=# )/m` regex; preamble → `00-preamble.md`; each section named `[slug].md`
- Conflict detection checks all target paths before writes (atomic validation)
- Parent directories created via `mkdir(..., { recursive: true })`; UTF-8 encoding used

## API Surface

**`buildSpecPrompt(docs: AgentsDocs, annexFiles?: AgentsDocs): SpecPrompt`** — assembles user prompt with AGENTS.md sections and optional annex files, returns `{ system: string, user: string }`.

**`writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>`** — writes markdown content to disk; single-file mode writes directly to `outputPath`; multi-file mode splits sections and writes to `outputPath` directory; throws `SpecExistsError` on conflicts unless `force=true`; returns array of written absolute paths.

**`WriteSpecOptions`** — `{ outputPath: string, force: boolean, multiFile: boolean }`.

**`SpecExistsError`** — extends Error; `paths: string[]` property lists conflicting file paths; message includes `--force` usage instruction.