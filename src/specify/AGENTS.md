<!-- Generated by agents-reverse-engineer -->

# src/specify

**Project specification synthesis from AGENTS.md documentation corpus: prompt engineering, heading-based file splitting, and overwrite-protected filesystem operations for single-file or multi-file spec generation.**

## Contents

### Core Modules

**[index.ts](./index.ts)** — Barrel export for specification synthesis API: `buildSpecPrompt`, `SpecPrompt`, `writeSpec`, `SpecExistsError`, `WriteSpecOptions`

**[prompts.ts](./prompts.ts)** — `buildSpecPrompt(docs, annexFiles?)` constructs `SpecPrompt` pair with `SPEC_SYSTEM_PROMPT` enforcing 11-section structure (Project Overview, Architecture, Public API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts [Runtime Behavior + Implementation Contracts], Test Contracts, Build Plan, Prompt Templates, IDE Integration) and verbatim annex reproduction mandates

**[writer.ts](./writer.ts)** — `writeSpec(content, options)` writes markdown to `specs/SPEC.md` (single-file) or `specs/<slug>.md` (multi-file via `splitByHeadings`), throws `SpecExistsError` on conflicts unless `force=true`, returns written paths array

## Architecture

### Prompt Construction Strategy

`buildSpecPrompt` assembles user prompts by concatenating:
1. Header directive: `"Generate a comprehensive project specification..."`
2. Documentation sections: `### ${doc.relativePath}` with embedded content from `AgentsDocs` array
3. Optional annex block: `## Annex Files` with verbatim source code for reproduction-critical modules (prompt templates, IDE configs)
4. Requirement checklist: 11-item numbered list matching `SPEC_SYSTEM_PROMPT` section order
5. Verbatim mandate: `"Sections 10 and 11 MUST reproduce annex content verbatim"`
6. Output constraint: `"Output ONLY the markdown content. No preamble."`

System prompt enforces:
- **Audience**: AI agents requiring instruction-oriented language (not human documentation)
- **Anti-patterns**: Prohibits folder-mirroring, file path prescription, directory-derived headings
- **Module boundary focus**: Describe interfaces/exports rather than filesystem layout
- **Type precision**: Full signatures with parameters, return types, generics for all public APIs
- **Dependency versioning**: Exact version numbers for external dependencies
- **Build Plan**: Phased implementation with explicit "Defines:"/"Consumes:" interface contract cross-references
- **Behavioral contracts**: Exact error types/codes, verbatim regex patterns in backticks, format strings with structure, magic constants with meanings, environment variable names with expected values, file format specifications (YAML schemas, NDJSON structures)
- **Reproduction-critical sections**: Sections 10-11 reproduce annex content without summarization

### Multi-File Splitting

`splitByHeadings` partitions markdown on `/^(?=# )/m` regex (positive lookahead for top-level headings):
- Extracts heading text via `/^# (.+)/` match, transforms via `slugify` (lowercase + whitespace→hyphens + strip non-alphanumeric + collapse consecutive hyphens + trim)
- Pre-heading content assigned to `00-preamble.md`
- Each section object contains `{ filename, content }` with trailing newline

Conflict detection: Before writing files, iterates sections to check existence via `fileExists` (wraps `fs.access(..., F_OK)`). Aggregates conflicts and throws `SpecExistsError` if non-empty and `force=false`. Ensures atomic write (all-or-nothing).

## Integration Points

### Consumed By

`src/cli/specify.ts` command invokes `writeSpec(aiOutput, { outputPath: config.output.specPath, force: cliFlags.force, multiFile: cliFlags.multiFile })` after `AIService.call(buildSpecPrompt(docs, annexFiles))` completes.

### Dependencies

**[../generation/collector.js](../generation/collector.ts)** — `collectAgentsDocs()` provides recursive `AGENTS.md` traversal results via `AgentsDocs` type

**node:fs/promises** — `mkdir`, `writeFile`, `access` for filesystem operations

**node:path** — `dirname`, `join` for path resolution

## Behavioral Contracts

### Runtime Behavior

- `writeSpec` throws `SpecExistsError` when target paths exist and `force=false`
- Single-file mode creates parent directory recursively via `mkdir(..., { recursive: true })`
- Multi-file mode writes all sections or none (atomic operation via upfront conflict check)

### Implementation Contracts

**Heading regex**: `/^(?=# )/m` (matches lines starting with `# ` via positive lookahead)

**Heading extraction**: `/^# (.+)/` (captures heading text after `# ` prefix)

**Slugification transforms**:
- Whitespace→hyphens: `/\s+/g` → `'-'`
- Strip non-alphanumeric: `/[^a-z0-9-]/g` → `''`
- Collapse hyphens: `/-+/g` → `'-'`
- Trim hyphens: `/^-|-$/g` → `''`

**SpecExistsError message format**: `"Specification file(s) already exist:\n" + paths.map(p => "  - " + p).join("\n") + "\n\nUse --force to overwrite."`

**Preamble filename**: `00-preamble.md` (for content before first `# ` heading)