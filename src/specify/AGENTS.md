<!-- Generated by agents-reverse-engineer v0.8.2 -->

# src/specify

Transforms hierarchical `AGENTS.md` documentation into concern-based project specifications via 12-section template enforcement and verbatim behavioral contract reproduction.

## Contents

**[index.ts](./index.ts)** — Barrel export re-exporting `buildSpecPrompt`, `SpecPrompt`, `writeSpec`, `SpecExistsError`, `WriteSpecOptions` from `prompts.js` and `writer.js` for specification transformation pipeline.

**[prompts.ts](./prompts.ts)** — Constructs `SpecPrompt` pairs via `buildSpecPrompt(docs, annexFiles?)` injecting `AgentsDocs` arrays into `SPEC_SYSTEM_PROMPT` template enforcing 12-section format (Project Overview → Build Plan → Prompt Templates → File Manifest) with mandatory verbatim reproduction of regex patterns, format strings, magic constants, prompt templates, installer configs from annex files.

**[writer.ts](./writer.ts)** — Writes specification markdown via `writeSpec(content, options)` with single-file mode (direct write to `outputPath`) or multi-file split on `# ` headings (slugified filenames in `outputPath` directory), throws `SpecExistsError` listing conflicting `paths[]` when files exist and `force=false`, pre-validates all targets atomically before writing.

## Architecture

`buildSpecPrompt()` formats input as two markdown sections: `## AGENTS.md Files (${docs.length} directories)` mapping each `AgentsDocs` entry to `### ${relativePath}\n\n${content}`, followed by optional `## Annex Files (${annexFiles.length} reproduction-critical source files)` for verbatim source embedding. Appends `## Output Requirements` enumerating 12 mandatory sections with Build Plan phase requirements (Defines/Consumes lists cross-referencing API Surface), prohibition of folder-mirroring structure, and emphasis on regex/format/constant/template verbatim reproduction. Output consumed by `src/cli/specify.ts` command handler calling `src/ai/service.ts` `AIService.call()` with resulting prompt, then `writeSpec()` for disk persistence.

`writeSpec()` single-file path invokes `writeFile(outputPath, content, 'utf-8')` directly after `fileExists()` check. Multi-file path calls `splitByHeadings()` extracting array of `{filename, content}` tuples via `/^(?=# )/m` split + `/^# (.+)/` heading capture + `slugify()` transformation, batch-validates all `join(outputPath, filename)` targets via `fileExists()`, aggregates conflicts into `SpecExistsError.paths[]`, writes all files sequentially on validation success. Preamble content before first heading written to `00-preamble.md`.

## Public API Surface

**`buildSpecPrompt(docs: AgentsDocs, annexFiles?: AgentsDocs): SpecPrompt`** — constructs AI prompt pair with system instructions (`SPEC_SYSTEM_PROMPT`) and user context (formatted docs + optional annex files + output requirements).

**`writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>`** — writes specification markdown to disk, returns array of written absolute paths.

**`SpecPrompt`** — interface with `system: string` and `user: string` prompt pair fields.

**`WriteSpecOptions`** — interface with `outputPath: string` (single-file path or multi-file directory), `force: boolean` (overwrite protection toggle), `multiFile: boolean` (heading-split toggle).

**`SpecExistsError extends Error`** — thrown on write conflict with `paths: string[]` of existing files, message format: `"Spec file(s) already exist:\n  - ${path1}\n  - ${path2}\nUse --force to overwrite."`.

## Behavioral Contracts

### SPEC_SYSTEM_PROMPT Section Order
1. Project Overview
2. Architecture
3. Public API Surface
4. Data Structures & State
5. Configuration
6. Dependencies
7. Behavioral Contracts (7a Runtime Behavior, 7b Implementation Contracts with verbatim regex/format/constants)
8. Test Contracts
9. Build Plan (phases with Defines/Consumes lists cross-referencing section 3)
10. Prompt Templates & System Instructions (FULL verbatim reproduction)
11. IDE Integration & Installer (FULL verbatim reproduction)
12. File Manifest

### Build Plan Validation Rules
- Every API Surface export MUST appear in exactly one phase's "Defines:" list
- Every File Manifest entry MUST be referenced in a phase
- Each phase MUST include "Defines:" list with exact type/interface/class/function names
- Each phase MUST include "Consumes:" list with exact imports from earlier phases

### Prohibited Specification Patterns
- Folder-mirroring section structure
- Directory names as headings
- Exact filename/path prescription
- Omitting version numbers from Dependencies section
- Missing type signatures in API Surface section
- Build Plan phases without Defines/Consumes lists

### Verbatim Reproduction Mandate
Regex patterns, format strings, output templates, magic constants, sentinel values, environment variable names, file format specs, prompt templates, IDE templates, installer configs MUST be reproduced VERBATIM in fenced code blocks. NO summarization, paraphrasing, abbreviation, or prose description substitution.

### Writer Behavioral Contracts

**Heading Split Regex**: `/^(?=# )/m` — splits on lines starting with exactly `# ` (top-level heading).

**Heading Extraction Regex**: `/^# (.+)/` — captures heading text after `# ` prefix.

**Slugification Algorithm**: lowercases → replaces `\s+` with `-` → strips `[^a-z0-9-]` → collapses `-+` → trims `^-|-$`.

**Multi-file Conflict Check**: validates all target paths via `fileExists()` before writing any files (atomic validation), aggregates all conflicts into single `SpecExistsError`.

**Default Preamble Filename**: `00-preamble.md` — used for content before first `# ` heading or headings that slugify to empty string.

## Integration Points

Consumes `AgentsDocs` type from `src/generation/collector.ts` (array of `{relativePath: string, content: string}` objects). Invoked by `src/cli/specify.ts` command handler which calls `collectAgentsDocs()` → `buildSpecPrompt()` → `AIService.call()` → `writeSpec()`. Output specification files consumed by `src/rebuild/spec-reader.ts` `readSpecFiles()` for reconstruction pipeline.

## Annex References

Full `SPEC_SYSTEM_PROMPT` template text (250 lines, 12-section format with verbatim reproduction mandates): [prompts.annex.sum](./prompts.annex.sum)