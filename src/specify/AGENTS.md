<!-- Generated by agents-reverse-engineer -->

# src/specify

Synthesizes project specifications from AGENTS.md corpus through prompt construction (`buildSpecPrompt()`), AI invocation by CLI orchestrator, and filesystem output via `writeSpec()` with single-file/multi-file modes.

## Contents

### Core Modules

**[prompts.ts](./prompts.ts)** — Prompt engineering infrastructure exporting `buildSpecPrompt(docs: AgentsDocs): SpecPrompt` to construct system/user prompt pairs from collected AGENTS.md files. System prompt (`SPEC_SYSTEM_PROMPT`) enforces concern-based organization (not directory mirroring) with nine mandatory sections: Project Overview (tech stack versions), Architecture (module boundaries, data flow), Public API Surface (full type signatures), Data Structures & State (schemas, state management), Configuration (Zod schemas, env vars), Dependencies (exact versions with rationale), Behavioral Contracts split into Runtime Behavior (error types/codes with throw conditions, retry logic formulas/delays, concurrency model, lifecycle hooks, resource management) and Implementation Contracts (verbatim regex patterns in backticks, format strings/templates with examples, magic constants/sentinel values with meanings, environment variables with expected values, file format specs for YAML schemas/NDJSON structures), Test Contracts (per-module scenarios with edge cases), Build Plan (phased implementation with dependency ordering). User prompt concatenates AGENTS.md content via `### ${relativePath}` sections and appends Output Requirements reiterating raw markdown constraint with emphasis on verbatim regex patterns, format specs, magic constants, and templates.

**[writer.ts](./writer.ts)** — Filesystem writer exporting `writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>` orchestrating single-file (`specs/SPEC.md`) vs. multi-file (`specs/<slug>.md`) output modes. Multi-file mode splits on top-level `# ` headings via `splitByHeadings()` regex (`/^(?=# )/m` positive lookahead), generates slugified filenames from heading text via `slugify()` lowercase+hyphen transform (`/\s+/g → '-'`, `/[^a-z0-9-]/g → ''`). Pre-checks all target paths for existence before writing (atomic conflict detection), throws `SpecExistsError` with `paths[]` array if `force=false`. Creates parent directories via `mkdir({ recursive: true })`, returns absolute paths of written files.

**[index.ts](./index.ts)** — Barrel export re-exporting `buildSpecPrompt()`, `SpecPrompt`, `writeSpec()`, `WriteSpecOptions`, `SpecExistsError` for consumption by `src/cli/specify.ts` command.

## Data Flow

1. **Specification synthesis** (`src/cli/specify.ts`) calls `collectAgentsDocs()` to recursively traverse project tree loading all `AGENTS.md` files with content and relative paths
2. **Prompt construction** via `buildSpecPrompt(docs)` aggregates markdown sections into user prompt, pairs with `SPEC_SYSTEM_PROMPT` system instructions
3. **AI invocation** by CLI orchestrator passes `SpecPrompt` to `AIService.call()`, receives synthesized specification markdown
4. **Output writing** via `writeSpec(response, { outputPath, force, multiFile })` writes single spec or splits/slugifies into directory-per-heading structure
5. **Error handling** catches `SpecExistsError` on overwrite protection failures, displays conflicting paths with `--force` hint

## Architecture Constraints

Prompt engineering prohibits directory-mirroring section structure, mandates MODULE BOUNDARY descriptions over file path prescriptions, requires exact symbol name preservation, enforces full type signatures with generics/parameters/return types, demands version numbers for all external dependencies, constrains Build Plan to phased dependency ordering without file path prescription, and requires MANDATORY verbatim inclusion of regex patterns, format strings, magic constants, and templates in Behavioral Contracts (no paraphrasing into prose descriptions).

## Integration Points

Consumed by `src/cli/specify.ts` implementing `/are-specify` command. Receives `AgentsDocs` type from `../generation/collector.js` containing array of `{ relativePath, content }` objects. Invokes AI backend via `AIService` from `../ai/service.ts` with constructed prompts. Filesystem operations via `node:fs/promises` (`writeFile`, `mkdir`, `access`) with no external npm dependencies.