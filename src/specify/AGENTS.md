<!-- Generated by agents-reverse-engineer -->

# src/specify/

Transforms AGENTS.md documentation into project specification format via AI prompt construction and multi-file markdown output. Consumed by `src/cli/specify.ts` command handler. Inverse operation of `src/rebuild/` module (which generates code from specs).

## Contents

**[index.ts](./index.ts)** — Barrel re-exporting `buildSpecPrompt`, `SpecPrompt`, `writeSpec`, `SpecExistsError`, `WriteSpecOptions` from `prompts.js` and `writer.js`. Entry point for `src/cli/specify.ts`.

**[prompts.ts](./prompts.ts)** — Exports `SPEC_SYSTEM_PROMPT` constant (100-line system prompt enforcing 12 mandatory sections) and `buildSpecPrompt(docs: AgentsDocs, annexFiles?: AgentsDocs): SpecPrompt` function. Constructs user prompt by injecting `docs` with `### ${relativePath}` delimiters, optional annexFiles under "## Annex Files" heading, and "## Output Requirements" restating mandatory sections. Returns `{system, user}` SpecPrompt object.

**[writer.ts](./writer.ts)** — Exports `writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>` function and `SpecExistsError` class. Writes specification markdown to disk with overwrite protection. Supports single-file mode (writes to `outputPath`) and multi-file mode (splits on `/^(?=# )/m` regex, slugifies headings via `slugify()`, writes to `{outputDir}/{slug}.md`). Throws `SpecExistsError` with conflicting paths if `force=false` and files exist. Uses `splitByHeadings()` for content partitioning, `fileExists()` for collision detection.

## Data Flow

```
AgentsDocs (from src/generation/collector.ts)
  ↓
buildSpecPrompt(docs, annexFiles?) → SpecPrompt {system, user}
  ↓
AI call (via src/ai/service.ts) → generated spec markdown
  ↓
writeSpec(content, options) → string[] (written file paths)
```

## Types

```typescript
interface SpecPrompt {
  system: string;  // SPEC_SYSTEM_PROMPT
  user: string;    // Injected docs + requirements
}

interface WriteSpecOptions {
  outputPath: string;  // Full path to output file
  force: boolean;      // Overwrite without error
  multiFile: boolean;  // Split by `# ` headings
}

class SpecExistsError extends Error {
  readonly paths: string[];  // Conflicting file paths
}
```

## Behavioral Contracts

### SPEC_SYSTEM_PROMPT — 12 Mandatory Sections

1. **Project Overview**
2. **Architecture**
3. **Public API Surface**
4. **Data Structures & State**
5. **Configuration**
6. **Dependencies**
7. **Behavioral Contracts** (subsections: Runtime Behavior, Implementation Contracts)
8. **Test Contracts**
9. **Build Plan** (each phase: "Defines:" exact type/function/class names from §3, "Consumes:" names from earlier phases)
10. **Prompt Templates & System Instructions** (verbatim annex reproduction)
11. **IDE Integration & Installer** (verbatim annex reproduction)
12. **File Manifest** (every source file with path/module/exports)

### Reproduction Rules (from SPEC_SYSTEM_PROMPT)

- Sections 10-11: reproduce annex content verbatim, preserve placeholder syntax `{{TOKEN}}`, omit if no annexFiles
- Regex patterns: backticks without prose paraphrasing
- Build Plan phases: cross-reference Public API Surface exports in "Defines:", reference File Manifest entries produced
- Organization: conceptual grouping by concern, NOT folder-mirroring

### Filename Slugification (from slugify())

Regex: lowercase → `\s+` to `-` → remove `[^a-z0-9-]` → collapse `-+` to `-` → trim `-`

### Heading Splitting (from splitByHeadings())

Split regex: `/^(?=# )/m` (positive lookahead for top-level headings)  
Heading extraction: `/^# (.+)/`  
Default filename for preamble or empty slugs: `"00-preamble.md"`

## Annex References

Full SPEC_SYSTEM_PROMPT text: [prompts.annex.sum](./prompts.annex.sum)