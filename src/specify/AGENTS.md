<!-- Generated by agents-reverse-engineer -->

# specify/

Specification synthesis from AGENTS.md corpus via AI-driven prompt construction (`buildSpecPrompt`) and filesystem output (`writeSpec`) with multi-file splitting and overwrite protection.

## Contents

### Files

**[index.ts](./index.ts)** — Barrel module re-exporting `buildSpecPrompt`, `writeSpec`, `SpecPrompt`, `WriteSpecOptions`, `SpecExistsError` for `/are-specify` command integration.

**[prompts.ts](./prompts.ts)** — `buildSpecPrompt(docs: AgentsDocs): SpecPrompt` constructs system/user prompts enforcing nine-section structure (Overview, Architecture, API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts, Test Contracts, Build Plan) with verbatim regex/format/constant preservation. `SPEC_SYSTEM_PROMPT` prohibits folder-mirroring, mandates concern-based organization, targets AI agents with actionable instructions.

**[writer.ts](./writer.ts)** — `writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>` writes single-file or multi-file specifications via heading-based splitting. `splitByHeadings(content)` partitions on `/^# /m` regex, `slugify()` sanitizes heading text to filenames (e.g., `"Project Overview"` → `"project-overview.md"`). Throws `SpecExistsError` with `paths: string[]` when targets exist and `force: false`.

## Data Flow

1. **Orchestration** (`src/cli/specify.ts`) invokes `collectAgentsDocs()` to gather all `AGENTS.md` files recursively
2. **Prompt Construction** (`prompts.ts`) injects corpus into `SPEC_SYSTEM_PROMPT` template with section delimiters `### ${relativePath}`, appends nine-section requirements
3. **AI Synthesis** (`AIService.call()` from `src/ai/service.ts`) processes prompt pair, returns specification markdown
4. **Output** (`writer.ts`) writes single `specs/SPEC.md` or splits into `specs/<slugified-heading>.md` per top-level heading
5. **Error Handling** catches `SpecExistsError` and displays `--force` hint

## Behavioral Contracts

### Prompt Constraints (SPEC_SYSTEM_PROMPT)

**Organization rules:**
- Regex `/^# (Project Overview|Architecture|Public API Surface|Data Structures & State|Configuration|Dependencies|Behavioral Contracts|Test Contracts|Build Plan)$/m` defines mandatory section headings
- Prohibition pattern: "Do NOT prescribe exact filenames or file paths" / "Do NOT mirror the project's folder structure" / "Do NOT use directory names as section headings"
- Behavioral Contracts split: "Runtime Behavior (error handling, concurrency, lifecycle)" + "Implementation Contracts (verbatim regex patterns, format specs, magic constants)"

**Output format enforcement:**
- Terminal instruction: `"OUTPUT: Raw markdown. No preamble. No meta-commentary. No 'Here is...' or 'I've generated...' prefix."`
- User prompt: `"Output ONLY the markdown content. No preamble."`

### File System Patterns (writer.ts)

**Heading splitting regex:** `/^(?=# )/m` (positive lookahead for top-level headings)  
**Heading extraction:** `/^# (.+)/` (capture heading text)  
**Slugification chain:**
1. `.toLowerCase()`
2. `/\s+/g` → `'-'` (whitespace to hyphens)
3. `/[^a-z0-9-]/g` → `''` (strip non-alphanumeric except hyphens)
4. `/-+/g` → `'-'` (collapse consecutive hyphens)
5. `/^-|-$/g` → `''` (trim leading/trailing hyphens)

**Preamble filename:** `00-preamble.md` (content before first `# ` heading)

## Integration Points

**Consumed by:** `src/cli/specify.ts` (command orchestrator)  
**Consumes:**
- `collectAgentsDocs()` from `../generation/collector.js` → `AgentsDocs` (array of `{relativePath, content}`)
- `AIService.call()` from `../ai/service.js` (prompt pair execution)
- `mkdir()`, `writeFile()`, `access()` from `node:fs/promises` (file operations)
- `path.dirname()`, `path.join()` from `node:path` (path resolution)

**Error propagation:** `SpecExistsError` thrown when `force: false` and target paths exist, caught by CLI layer for `--force` hint display