<!-- Generated by agents-reverse-engineer -->

# src/specify

The `src/specify/` directory implements the specification synthesis subsystem, which reverses the documentation generation flow by consuming AGENTS.md files and producing project specification documents that describe the codebase's architecture, API surface, behavioral contracts, and build plan in a format suitable for AI-driven reconstruction.

## Contents

### [index.ts](./index.ts)
Barrel export consolidating the specification generation API: re-exports `buildSpecPrompt`, `SpecPrompt`, `writeSpec`, `SpecExistsError`, and `WriteSpecOptions`.

### [prompts.ts](./prompts.ts)
Defines `SPEC_SYSTEM_PROMPT` (multi-paragraph system instructions enforcing 12-section spec structure with verbatim reproduction mandates for behavioral contracts, prompt templates, and IDE integration), `SpecPrompt` interface (system/user prompt pair), and `buildSpecPrompt(docs, annexFiles)` (assembles AGENTS.md content and annex files into structured user prompt with section delimiters).

### [writer.ts](./writer.ts)
Implements `writeSpec(content, options)` with single-file and multi-file output modes, `SpecExistsError` for atomic conflict detection, `splitByHeadings()` for markdown sectioning via `/^(?=# )/m` regex, and `slugify()` for filename generation.

## Data Flow

1. **CLI Invocation**: `src/cli/specify.ts` receives user command, validates flags (`--force`, `--multi-file`), discovers AGENTS.md files via `collectAgentsDocs()`, and optionally collects annex files
2. **Prompt Construction**: `buildSpecPrompt(docs, annexFiles)` injects AGENTS.md sections and annex content into `SPEC_SYSTEM_PROMPT` template, returning `SpecPrompt` with system/user pair
3. **AI Processing**: CLI handler passes `SpecPrompt` to `AIService.run()` (via subprocess backend), receives specification markdown
4. **Output Serialization**: `writeSpec(content, options)` splits on top-level headings (if `multiFile=true`), performs atomic existence check, throws `SpecExistsError` on conflict (unless `force=true`), writes files to `outputPath` or `dirname(outputPath)/{slug}.md`

## Behavioral Contracts

### Specification Structure (SPEC_SYSTEM_PROMPT)

Mandates 12 ordered sections:
1. Project Overview
2. Architecture
3. Public API Surface
4. Data Structures & State
5. Configuration
6. Dependencies
7. Behavioral Contracts (Runtime Behavior + Implementation Contracts with verbatim regex/formats/constants)
8. Test Contracts
9. Build Plan (with "Defines:" and "Consumes:" cross-references to API Surface)
10. Prompt Templates & System Instructions (verbatim annex reproduction)
11. IDE Integration & Installer (verbatim annex reproduction)
12. File Manifest (every source file with path/module/exports)

### Verbatim Reproduction Requirements

Sections 7, 10, 11 must preserve exact syntax for:
- Regex patterns (e.g., `/^(?=# )/m`)
- Format strings (e.g., `### ${doc.relativePath}\n\n${doc.content}`)
- Magic constants (e.g., `constants.F_OK`)
- Environment variables (e.g., `NODE_OPTIONS='--max-old-space-size=512'`)
- Placeholder syntax (e.g., `{{TOKEN}}`)
- Error types/codes with throw conditions
- Retry formulas and concurrency models

### Heading-Based Splitting (splitByHeadings)

Pattern: `/^(?=# )/m` — positive lookahead matching lines starting with `# ` (top-level headings only)

Filename generation:
1. Extract heading text via `/^# (.+)/`
2. Apply `slugify()`: lowercase → replace `\s+` with `-` → strip `[^a-z0-9-]` → collapse `-+` → trim leading/trailing `-`
3. Append `.md` extension

Preamble handling: content before first `# ` → `00-preamble.md`

### SpecExistsError Message Format

```
Spec file(s) already exist:
  - path1
  - path2
Use --force to overwrite.
```

## Integration Points

- **Consumed by**: `src/cli/specify.ts` (CLI command handler orchestrating prompt construction, AI invocation, and file writing)
- **Consumes**: `AgentsDocs` from `../generation/collector.js` (array of `{relativePath: string, content: string}` objects)
- **Pairs with**: `src/rebuild/` (executes generated specifications to reconstruct codebase)