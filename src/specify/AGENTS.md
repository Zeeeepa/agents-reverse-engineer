<!-- Generated by agents-reverse-engineer -->

# src/specify/

This directory implements reverse-engineering of project specifications from AGENTS.md documentation. It constructs AI prompts that synthesize rebuild specifications, enforces a 12-section structure with verbatim reproduction of annex content, and writes output in single-file or multi-file modes with overwrite protection.

## Contents

### Exports

- **[index.ts](./index.ts)**: Public API barrel exporting `buildSpecPrompt()`, `SpecPrompt`, `writeSpec()`, `SpecExistsError`, and `WriteSpecOptions` for use by `src/cli/specify.ts`
- **[prompts.ts](./prompts.ts)**: Defines `SPEC_SYSTEM_PROMPT` (402-line instruction set), `buildSpecPrompt()` (constructs AI prompts from `AgentsDocs` arrays), and `SpecPrompt` interface (system/user message pair)
- **[writer.ts](./writer.ts)**: Implements `writeSpec()` with `multiFile` toggle, `splitByHeadings()` for markdown partitioning via `/^(?=# )/m` regex, `slugify()` for filename derivation, and `SpecExistsError` thrown when `force=false` and conflicts detected

## Architecture

Specification generation follows a two-stage pipeline: prompt construction (`buildSpecPrompt()`) ingests collected AGENTS.md and annex files from `src/generation/collector.ts`, formats them with section headers, and appends mandatory output requirements. The resulting `SpecPrompt` is sent to an AI backend (orchestrated by `src/cli/specify.ts`). The AI response is processed by `writeSpec()`, which either writes a monolithic markdown file (`multiFile=false`) or splits on top-level `# ` headings (`multiFile=true`) and writes slugified filenames (`01-project-overview.md`, `02-architecture.md`, etc.).

## Behavioral Contracts

### Prompt Construction

`buildSpecPrompt()` formats each `AgentsDocs` entry as `### ${doc.relativePath}\n\n${doc.content}`, appends optional annex section with identical formatting under `## Annex Files (${annexFiles.length} reproduction-critical source files)`, and concatenates with `## Output Requirements` list of 12 mandatory sections.

### System Instruction Constraints (SPEC_SYSTEM_PROMPT)

- **Anti-mirroring rule**: `"Do NOT mirror the project's folder structure in your section organization"`, `"Do NOT use directory names as section headings"`, `"Do NOT prescribe exact filenames or file paths"`
- **Build Plan cross-reference**: `"Build Plan phases MUST cross-reference the Public API Surface: every type/function in the API Surface section must appear in exactly one phase's 'Defines:' list"`. Each phase must include `"Defines:"` (exact exported names) and `"Consumes:"` (exact imported names from earlier phases)
- **Verbatim reproduction**: Sections 10 (Prompt Templates & System Instructions) and 11 (IDE Integration & Installer) must reproduce annex content verbatim. `"Do NOT summarize, paraphrase, abbreviate, or 'improve' the text"`. Preserve placeholder syntax exactly (e.g., `{{TOKEN}}`)
- **Regex preservation**: `"Behavioral Contracts MUST include verbatim regex patterns, format strings, and magic constants from the source documents — do NOT paraphrase regex patterns into prose descriptions"`
- **File Manifest completeness**: `"The File Manifest MUST list every source file. Each Build Plan phase MUST reference which File Manifest entries it produces. A file missing from both is a spec defect."`

### Markdown Splitting

`splitByHeadings()` partitions on `/^(?=# )/m` (lines starting with exactly `# `). Heading extraction via `/^# (.+)/`. Content before first heading receives filename `00-preamble.md`. `slugify()` transforms headings via: lowercase → replace `\s+` with `-` → strip `[^a-z0-9-]` → collapse `-+` to `-` → trim via `.replace(/^-|-$/g, '')`.

### Overwrite Protection

`writeSpec()` checks `fileExists()` (via `access(filePath, constants.F_OK)`) before writing. In single-file mode, checks `outputPath`. In multi-file mode, iterates all `sections`, checks `path.join(outputDir, section.filename)`, accumulates conflicts, and throws `SpecExistsError(conflicts)` if any exist and `force=false`. `SpecExistsError` formats message as:
```
Spec file(s) already exist:
  - <path1>
  - <path2>
Use --force to overwrite.
```

## Dependencies

- **Internal**: Imports `AgentsDocs` from `src/generation/collector.ts`
- **Node.js**: Uses `node:fs/promises` (`writeFile`, `mkdir`, `access`), `node:fs` (`constants`), `node:path`

## Integration Points

Called by `src/cli/specify.ts`, which orchestrates AI service invocation and passes `WriteSpecOptions` with `outputPath`, `force`, and `multiFile` flags. Ingests `AgentsDocs` arrays from `src/generation/collector.ts` (collected AGENTS.md and annex files).

## Annex References

- [prompts.annex.sum](./prompts.annex.sum) — Full 402-line `SPEC_SYSTEM_PROMPT` system instruction template