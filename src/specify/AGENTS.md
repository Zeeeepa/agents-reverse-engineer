<!-- Generated by agents-reverse-engineer -->

# src/specify

Synthesizes collected AGENTS.md documentation into project specification documents through AI-driven prompt construction and multi-file output handling.

## Contents

### Core Modules

**[index.ts](./index.ts)** — Barrel export exposing `buildSpecPrompt()`, `writeSpec()`, `SpecPrompt`, `WriteSpecOptions`, and `SpecExistsError` as the public API for the `/are-specify` command.

**[prompts.ts](./prompts.ts)** — Exports `buildSpecPrompt(docs: AgentsDocs): SpecPrompt` to construct AI prompts from collected AGENTS.md files. Defines `SPEC_SYSTEM_PROMPT` constant enforcing nine mandatory specification sections (Project Overview, Architecture, Public API Surface, Data Structures & State, Configuration, Dependencies, Behavioral Contracts, Test Contracts, Build Plan). Injects document content under `### ${doc.relativePath}` headings in user prompt. Prohibits directory-mirroring organization.

**[writer.ts](./writer.ts)** — Exports `writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>` to persist specification markdown. Implements `splitByHeadings(content: string)` for multi-file output via `/^(?=# )/m` regex splitting. Provides `slugify(heading: string)` for filename generation. Throws `SpecExistsError` with `paths: string[]` when overwrite conflicts detected and `force: boolean` is false.

## Data Flow

1. **src/cli/specify.ts** invokes `collector.collectAgentsDocs()` from `../generation/collector.js` to gather AGENTS.md files
2. **buildSpecPrompt(docs)** constructs `SpecPrompt` with system instructions and injected documentation
3. **AIService** processes prompt pair to generate specification markdown
4. **writeSpec(content, options)** persists output as single file or split sections based on `WriteSpecOptions.multiFile`

## Integration Dependencies

- **AgentsDocs** type from `../generation/collector.js` provides collected documentation structure
- **src/cli/specify.ts** orchestrates prompt building → AI invocation → disk writing
- **src/ai/service.ts** consumes `SpecPrompt` for specification generation

## Design Patterns

**Template Method**: `SPEC_SYSTEM_PROMPT` defines invariant structure; `buildSpecPrompt()` injects variable content  
**Atomic Conflict Detection**: Multi-file mode checks all target paths before writing to prevent partial overwrites  
**Error Aggregation**: `SpecExistsError.paths` reports all conflicts upfront rather than failing on first collision