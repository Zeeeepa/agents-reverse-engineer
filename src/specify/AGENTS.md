<!-- Generated by agents-reverse-engineer -->

# src/specify/

Project specification synthesis from AGENTS.md documentation corpus via AI-driven prompt engineering. Exports `buildSpecPrompt()` for constructing two-part prompts (system constraints + aggregated AGENTS.md content), `writeSpec()` for filesystem output with overwrite protection and multi-file splitting, and `SpecExistsError` for conflict detection.

## Contents

**[index.ts](./index.ts)** — Barrel re-export aggregating `buildSpecPrompt`, `SpecPrompt`, `writeSpec`, `SpecExistsError`, `WriteSpecOptions` from `prompts.ts` and `writer.ts` submodules. Consumed by `src/cli/specify.ts` command orchestrator.

**[prompts.ts](./prompts.ts)** — Prompt template factory exporting `buildSpecPrompt(docs, annexFiles?)` which constructs `SpecPrompt` pairs: system instructions (`SPEC_SYSTEM_PROMPT` enforcing 11-section conceptual organization) and user content (concatenated AGENTS.md markdown with section delimiters, optional annex files for reproduction-critical constants). Returns structured prompt with mandatory output format rules (raw markdown, no preamble, verbatim reproduction of prompt templates/regex/IDE templates).

**[writer.ts](./writer.ts)** — Filesystem writer exporting `writeSpec(content, options)` supporting single-file (`specs/SPEC.md`) and multi-file (`specs/<slug>.md`) output modes. Implements pre-flight existence checks throwing `SpecExistsError(conflicts[])` when `force=false`, content splitting via `splitByHeadings()` (regex `/^(?=# )/m`), filename sanitization through `slugify()` (lowercase + hyphenation + alphanumeric filtering), and directory creation with `mkdir(outputDir, { recursive: true })`.

## Architecture

**Prompt Construction Pipeline:**  
`buildSpecPrompt()` receives `AgentsDocs[]` from `../generation/collector.js` (`collectAgentsDocs()` recursive traversal) and optional annex files (`collectAnnexFiles()`). Constructs user prompt by iterating docs array, emitting `### ${doc.relativePath}\n\n${doc.content}` sections, appending annex section if provided, injecting output requirements listing 11 mandatory sections. System prompt (`SPEC_SYSTEM_PROMPT`) prohibits folder-mirroring, exact file path prescription, mandates verbatim reproduction of behavioral contracts (regex patterns, format strings, magic constants, environment variables, prompt templates, IDE templates).

**Filesystem Writing Pipeline:**  
`writeSpec()` branches on `options.multiFile`. Single-file mode: checks `fileExists(outputPath)`, throws `SpecExistsError([outputPath])` if exists and `force=false`, creates parent directory, writes content. Multi-file mode: calls `splitByHeadings()` to partition by top-level `# ` headings, checks all target paths for conflicts, throws `SpecExistsError(conflicts)` if any exist and `force=false`, writes each section to slugified filename.

## Behavioral Contracts

**SPEC_SYSTEM_PROMPT Section 7 (Behavioral Contracts):**  
Enforces two subsections: (a) Runtime Behavior — error types/codes, retry formulas/delays, concurrency model, lifecycle hooks; (b) Implementation Contracts — verbatim regex patterns in backticks, format strings with examples, magic constants with meanings, environment variable names with expected values, file format specifications (YAML schemas, NDJSON structures). Prohibits paraphrasing regex into prose.

**SPEC_SYSTEM_PROMPT Section 10 (Prompt Templates):**  
Requires FULL verbatim text reproduction from annex files or AGENTS.md content, organized by pipeline phase or functional area, preserving placeholder syntax (e.g., `{{FILE_PATH}}`).

**SPEC_SYSTEM_PROMPT Section 11 (IDE Integration):**  
Requires verbatim reproduction of command templates per platform, platform configuration objects (path prefixes, filename conventions, frontmatter formats), installer permission lists, hook definitions.

**Content Splitting Regex:**  
`/^(?=# )/m` matches lines starting with exactly `# ` (top-level headings). Content before first heading assigned to `'00-preamble.md'`.

**Filename Sanitization Transform:**  
`slugify()` applies sequence: lowercase → whitespace (`/\s+/g`) to hyphen → strip non-alphanumeric except hyphens (`/[^a-z0-9-]/g`) → collapse hyphens (`/-+/g`) → trim edge hyphens (`/^-|-$/g`).

## Integration Points

**Upstream:** `src/cli/specify.ts` orchestrates workflow: validates project root, collects AGENTS.md via `collectAgentsDocs()`, optionally collects annex files via `collectAnnexFiles()`, calls `buildSpecPrompt(docs, annexFiles)`, invokes `AIService.call()` with returned `SpecPrompt`, passes AI output to `writeSpec()` with options from CLI flags (`--force`, `--multi-file`, `--output`).

**Downstream:** `writeSpec()` consumes `node:fs/promises` (`writeFile`, `mkdir`, `access`), `node:fs` (`constants.F_OK`), `node:path` (`dirname`, `join`). Throws `SpecExistsError` caught by CLI for user-facing error messages.