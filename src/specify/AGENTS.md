<!-- Generated by agents-reverse-engineer -->

# src/specify

Reverse specification synthesis module: transforms hierarchical AGENTS.md documentation into structured project specification markdown via 12-section AI prompt template.

## Contents

**[index.ts](./index.ts)** — Barrel export aggregating `buildSpecPrompt`, `SpecPrompt`, `writeSpec`, `SpecExistsError`, `WriteSpecOptions` from `prompts.js` and `writer.js`. Entry point for `src/cli/specify.ts` command handler.

**[prompts.ts](./prompts.ts)** — Exports `SPEC_SYSTEM_PROMPT` (12-section template enforcing Project Overview, Architecture, Public API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts, Test Contracts, Build Plan with Defines:/Consumes: cross-references, Prompt Templates, IDE Integration, File Manifest) and `buildSpecPrompt(docs: AgentsDocs, annexFiles?: AgentsDocs)` (constructs SpecPrompt by injecting AGENTS.md content with section delimiters, optional annex files under "## Annex Files", verbatim reproduction rules for regex/templates/constants).

**[writer.ts](./writer.ts)** — Exports `writeSpec(content: string, options: WriteSpecOptions)` (writes markdown to `outputPath`, splits by `/^(?=# )/m` headings when `multiFile=true`, throws `SpecExistsError` when files exist and `force=false`, returns absolute paths), `SpecExistsError` (paths array property), `WriteSpecOptions` (outputPath/force/multiFile fields), internal `splitByHeadings()` (regex partition with `slugify()` filename sanitization), `fileExists()` wrapper, `slugify()` (lowercases, replaces `\s+` with `-`, removes `[^a-z0-9-]`).

## Behavioral Contracts

### 12-Section Specification Template

SPEC_SYSTEM_PROMPT enforces mandatory sections: (1) Project Overview, (2) Architecture, (3) Public API Surface, (4) Data Structures & State, (5) Configuration, (6) Dependencies, (7) Behavioral Contracts (Runtime Behavior + Implementation Contracts subsections), (8) Test Contracts, (9) Build Plan (phases with "Defines:" exact exports + "Consumes:" dependencies), (10) Prompt Templates & System Instructions, (11) IDE Integration & Installer, (12) File Manifest (path/module/exports triples).

### Verbatim Reproduction Rules

- Regex patterns must appear in backticks without prose paraphrasing
- Prompt templates preserve placeholder syntax `{{TOKEN}}` exactly
- Environment variables, magic constants, format strings reproduced unmodified
- Build Plan "Defines:" must list exact type/function/class names from Public API Surface
- Build Plan "Consumes:" must reference exact names from earlier phases or File Manifest
- Sections 10-11 omitted if no annex files provided

### Multi-File Splitting

```regex
/^(?=# )/m  // Positive lookahead for top-level headings
/^# (.+)/   // Heading text extraction
```

Slug sanitization: lowercase → `\s+` to `-` → remove `[^a-z0-9-]` → collapse `-+` to `-` → trim `-`. Preamble content defaults to `00-preamble.md`.

### Error Handling

SpecExistsError thrown when `force=false` and `fileExists()` returns true for any target path. Message format: `"Spec file(s) already exist:\n  - {path}\nUse --force to overwrite."`

## Integration Points

Inverse of `src/rebuild/`: consumes AGENTS.md hierarchy via `AgentsDocs` type from `../generation/collector.js`, produces specification markdown consumed by `src/rebuild/orchestrator.ts`. Called by `src/cli/specify.ts` command handler implementing `/are-specify` skill.

## Annex References

Full SPEC_SYSTEM_PROMPT template: [prompts.annex.sum](./prompts.annex.sum)