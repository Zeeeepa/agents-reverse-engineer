<!-- Generated by agents-reverse-engineer -->

# src/specify/

AGENTS.md → project specification transformation subsystem: `prompts.ts` generates 12-section prompt templates (system + user pairs) enforcing verbatim reproduction of behavioral contracts (regex patterns, format strings, prompt templates, IDE configs) and Build Plan cross-referencing mandates (Defines/Consumes lists), `writer.ts` writes spec markdown to disk with overwrite protection and optional multi-file splitting on `# ` headings.

## Contents

**[index.ts](./index.ts)** — Public API re-exporting `buildSpecPrompt`, `SpecPrompt`, `writeSpec`, `SpecExistsError`, `WriteSpecOptions` from `prompts.ts` and `writer.ts`.

**[prompts.ts](./prompts.ts)** — Exports `buildSpecPrompt(docs: AgentsDocs, annexFiles?: AgentsDocs): SpecPrompt` (constructs `{system, user}` prompt pair by mapping docs/annexFiles to markdown sections), `SpecPrompt` interface, `SPEC_SYSTEM_PROMPT` (250-line system prompt defining 12-section specification format with verbatim reproduction mandates). Consumes `AgentsDocs` from `../generation/collector.js`.

**[writer.ts](./writer.ts)** — Exports `writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>` (writes spec markdown to single file or splits on `# ` headings into directory with slugified filenames, throws `SpecExistsError` on conflict), `WriteSpecOptions` (`outputPath`, `force`, `multiFile`), `SpecExistsError` (exposes `paths: string[]`).

## Data Flow

1. `src/cli/specify.ts` invokes `buildSpecPrompt()` with `AgentsDocs` from `src/generation/collector.ts` `collectAgentsDocs()`
2. `buildSpecPrompt()` injects docs into `SPEC_SYSTEM_PROMPT` template generating `{system, user}` prompt pair
3. Prompt pair passed to `src/ai/service.ts` `AIService.call()` for LLM spec generation
4. AI response passed to `writeSpec()` with `WriteSpecOptions` (outputPath from config, force flag, multiFile from CLI)
5. `writeSpec()` validates paths via `fileExists()`, splits on `/^(?=# )/m` if `multiFile=true`, slugifies headings, writes to disk
6. Output consumed by `src/rebuild/orchestrator.ts` for reconstruction pipeline initialization

## Behavioral Contracts

### 12-Section Specification Format (SPEC_SYSTEM_PROMPT)
1. Project Overview
2. Architecture
3. Public API Surface
4. Data Structures & State
5. Configuration
6. Dependencies
7. Behavioral Contracts
   - 7a. Runtime Behavior
   - 7b. Implementation Contracts (VERBATIM regex, format strings, magic constants)
8. Test Contracts
9. Build Plan (phases with "Defines:" lists cross-referencing section 3 exports, "Consumes:" lists referencing earlier phases)
10. Prompt Templates & System Instructions (FULL VERBATIM reproduction)
11. IDE Integration & Installer (FULL VERBATIM reproduction)
12. File Manifest

### Build Plan Cross-Referencing Mandates
- Every API Surface export MUST appear in exactly one phase's "Defines:" list
- Every phase MUST include "Consumes:" list with exact imports from earlier phases
- Every File Manifest entry MUST be referenced in a phase

### Heading Split Regex
```regex
/^(?=# )/m
```
Splits on lines starting with exactly `# ` (top-level heading).

### Heading Extraction
```regex
/^# (.+)/
```
Captures heading text after `# ` prefix.

### Slugification Algorithm
```javascript
heading.toLowerCase()
  .replace(/\s+/g, '-')
  .replace(/[^a-z0-9-]/g, '')
  .replace(/-+/g, '-')
  .replace(/^-|-$/g, '')
```

### Multi-file Conflict Check
Validates all target paths via `fileExists()` before writing any files (atomic validation), aggregates all conflicts into single `SpecExistsError`.

### Default Preamble Filename
`00-preamble.md` — used for content before first `# ` heading or headings that slugify to empty string.

## Annex References

- [prompts.annex.sum](./prompts.annex.sum) — `SPEC_SYSTEM_PROMPT` (250 lines, 12-section format with verbatim reproduction mandates)