---
generated_at: 2026-02-09T16:10:06.684Z
content_hash: 40987c5270cd4d77bfee1562927e78816e76974b5bdcaf2248dc4fb478b45447
purpose: `run.ts` exports `discoverFiles()`, the high-level entry point orchestrating four-filter pipeline execution (gitignor...
---
**`run.ts` exports `discoverFiles()`, the high-level entry point orchestrating four-filter pipeline execution (gitignore → vendor → binary → custom) after directory walking, returning `FilterResult` with included/excluded file lists and filter attribution.**

## Exported Interface

**`DiscoveryConfig`** — Structural subset of full `Config` schema from `src/config/schema.ts` containing:
- `exclude.vendorDirs: string[]` — Third-party directories to skip
- `exclude.binaryExtensions: string[]` — Non-text file extensions
- `exclude.patterns: string[]` — Gitignore-style globs
- `options.maxFileSize: number` — Binary detection threshold in bytes
- `options.followSymlinks: boolean` — Symlink traversal flag

**`DiscoverFilesOptions`** — Optional parameters for pipeline execution:
- `tracer?: ITraceWriter` — Trace event emitter for telemetry
- `debug?: boolean` — Verbose logging flag

**`discoverFiles(root: string, config: DiscoveryConfig, options?: DiscoverFilesOptions): Promise<FilterResult>`** — Async pipeline function creating filters in deterministic order (gitignore, vendor, binary, custom), invoking `walkDirectory()` with `cwd` and `followSymlinks` options, then applying filter chain via `applyFilters()` with tracer/debug propagation. Returns `FilterResult` containing `included: FileInfo[]`, `excluded: FileInfo[]` arrays with per-file filter attribution.

## Filter Chain Composition

Constructs four filters via factory functions:
1. **`createGitignoreFilter(root)`** — Parses `.gitignore` files using `ignore` library
2. **`createVendorFilter(config.exclude.vendorDirs)`** — Blocks third-party directories (node_modules, .git, dist)
3. **`createBinaryFilter({ maxFileSize, additionalExtensions })`** — Detects binary files via extension + content analysis
4. **`createCustomFilter(config.exclude.patterns, root)`** — Applies user-defined glob patterns

Filters applied sequentially in declared order via `applyFilters()` from `./filters/index.js`.

## Integration Points

**Callers:** All CLI commands requiring file discovery (`src/cli/discover.ts`, `src/cli/generate.ts`, `src/cli/update.ts`) invoke `discoverFiles()` with config loaded from `loadConfig()`.

**Dependencies:**
- `walkDirectory()` from `./walker.js` — Filesystem traversal with symlink control
- `applyFilters()` from `./filters/index.js` — Sequential filter application with attribution
- `ITraceWriter` from `../orchestration/trace.js` — Telemetry event emission

**Output consumption:** Returned `FilterResult.included` feeds into Phase 1 file analysis worker pool, `FilterResult.excluded` populates `GENERATION-PLAN.md` statistics.

## Design Pattern

Facade pattern consolidating filter creation, directory walking, and filter application into single async function with config-driven parameterization. Promotes structural compatibility via `DiscoveryConfig` interface instead of tight coupling to full `Config` type, enabling unit testing with minimal mock objects.