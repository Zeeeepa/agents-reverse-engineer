---
generated_at: 2026-02-09T15:06:52.895Z
content_hash: 40987c5270cd4d77bfee1562927e78816e76974b5bdcaf2248dc4fb478b45447
purpose: discoverFiles() orchestrates the four-stage filter pipeline (gitignore, vendor, binary, custom) over walkDirectory() ...
---
**discoverFiles() orchestrates the four-stage filter pipeline (gitignore, vendor, binary, custom) over walkDirectory() results, returning FilterResult with included/excluded file lists and filter attribution.**

## Exported Functions

**discoverFiles(root: string, config: DiscoveryConfig, options?: DiscoverFilesOptions): Promise<FilterResult>**
- Creates filter chain via createGitignoreFilter(), createVendorFilter(), createBinaryFilter(), createCustomFilter()
- Invokes walkDirectory() with followSymlinks from config.options
- Applies filters via applyFilters() with optional tracer and debug passthrough
- Returns FilterResult containing both included and excluded files with filter reason metadata

## Configuration Interface

**DiscoveryConfig**
- Subset of full Config schema from src/config/schema.ts
- Structure:
  ```typescript
  {
    exclude: {
      vendorDirs: string[];           // e.g., node_modules, .git, dist
      binaryExtensions: string[];     // e.g., .png, .jpg, .zip
      patterns: string[];             // gitignore-style globs
    };
    options: {
      maxFileSize: number;            // binary detection threshold (1MB default)
      followSymlinks: boolean;        // symlink traversal flag
    };
  }
  ```
- Structurally compatible with config/schema.ts Config type for duck typing

**DiscoverFilesOptions**
- Optional tracer: ITraceWriter for trace event emission
- Optional debug: boolean for verbose filter logging

## Filter Pipeline Order

1. **createGitignoreFilter(root)** — async, reads .gitignore from root directory
2. **createVendorFilter(config.exclude.vendorDirs)** — synchronous, blocks third-party directories
3. **createBinaryFilter({ maxFileSize, additionalExtensions })** — synchronous, checks extension + content analysis
4. **createCustomFilter(config.exclude.patterns, root)** — synchronous, applies user-defined glob patterns

All filters imported from './filters/index.js' barrel export.

## Integration Points

- **walkDirectory()** from './walker.js' performs directory traversal with symlink handling
- **applyFilters()** from './filters/index.js' executes filter chain and aggregates results
- **ITraceWriter** from '../orchestration/trace.js' enables NDJSON trace event emission
- Used by cli/discover.ts, cli/generate.ts, cli/update.ts as shared discovery entry point

## Design Rationale

High-level pipeline abstraction eliminates filter chain construction boilerplate across commands. Structural typing of DiscoveryConfig avoids circular dependency with config/schema.ts while maintaining type safety. Returns full FilterResult instead of just included files to support debug/diagnostics and plan generation metadata.