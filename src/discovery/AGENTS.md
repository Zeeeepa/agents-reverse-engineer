<!-- Generated by agents-reverse-engineer -->

# src/discovery

File discovery pipeline implementing four-stage filter chain (gitignore → vendor → binary → custom) with `walkDirectory()` traversal and bounded-concurrency exclusion processing.

## Contents

**[walker.ts](./walker.ts)** — Exports `walkDirectory(options: WalkerOptions)` wrapping `fast-glob@3.3.3` via `fg.glob('**/*', {cwd, absolute: true, onlyFiles: true, dot: true, followSymbolicLinks, suppressErrors: true, ignore: ['**/.git/**']})`, returning raw file list for subsequent filter application.

**[run.ts](./run.ts)** — Exports `discoverFiles(root, config, options?)` unified pipeline: invokes `walkDirectory()` then applies four-filter chain via `applyFilters(files, [createGitignoreFilter(), createVendorFilter(), createBinaryFilter(), createCustomFilter()], {tracer, debug})`, returning `FilterResult` with `included`/`excluded` arrays and per-filter stats.

**[types.ts](./types.ts)** — Defines `FileFilter` interface (`name: string`, `shouldExclude(path, stats?): boolean | Promise<boolean>`), `FilterResult` type (`included: string[]`, `excluded: ExcludedFile[]`), `ExcludedFile` schema (`path`, `reason`, `filter`), `WalkerOptions` config (`cwd`, `followSymlinks`, `dot`), and `DiscoveryConfig` subset.

## Subdirectories

**[filters/](./filters/)** — Four-stage filter chain: `gitignore.ts` (ignore library pattern matching), `vendor.ts` (10 default vendor directories with partition-based lookup), `binary.ts` (extension Set + isbinaryfile content analysis + 1MB size limit), `custom.ts` (user-defined patterns), `index.ts` (worker pool orchestrator with 30-worker concurrency, short-circuit evaluation, order-preserving result aggregation).

## Architecture

### Discovery Pipeline

1. **Traversal**: `walkDirectory()` invokes `fast-glob` with `.git` exclusion, symlink handling per `WalkerOptions.followSymlinks` (default: false), error suppression via `suppressErrors: true`.
2. **Filter Chain**: `applyFilters()` spawns 30 workers sharing `files.entries()` iterator, applies filters sequentially per file (halting on first `shouldExclude()` true), preserves input order via index sorting.
3. **Result Aggregation**: Populates `FilterResult.included` with passed paths, `FilterResult.excluded` with `ExcludedFile` records containing `path`, `reason`, `filter` name.

### Filter Application Strategy

`applyFilters()` maintains shared `files.entries()` iterator across `Math.min(30, files.length)` workers. Each worker pulls `[index, file]`, runs filter chain, records `{index, file, excluded?: ExcludedFile}`. Short-circuits on first exclusion. Final results sorted by `index` to restore input order despite parallel execution. Tracks per-filter `filesMatched`/`filesRejected` counts, emits `tracer.emit({type: 'filter:applied', filterName, filesMatched, filesRejected})`.

### Integration Points

`discoverFiles()` called by `src/cli/discover.ts`, `src/cli/generate.ts`, `src/cli/update.ts` for shared discovery logic. Filter constructors (`createGitignoreFilter()`, etc.) accept config subset: `exclude.vendorDirs`, `exclude.binaryExtensions`, `exclude.patterns`, `options.maxFileSize`, `options.followSymlinks`. `WalkerOptions.cwd` receives project root absolute path. `FilterResult` consumed by `src/generation/orchestrator.ts` `GenerationOrchestrator.preparePlan()`.

## Filter Chain

### Gitignore Filter
`createGitignoreFilter(root)` reads `.gitignore` via `fs.promises.readFile()`, parses with `ignore` library, converts absolute paths to relative via `path.relative(root, absolutePath)`, returns `false` (include) if path starts with `..` (outside root).

### Vendor Filter
`createVendorFilter(vendorDirs)` partitions directories into single-segment Set (`node_modules`) and multi-segment patterns (`.agents/skills`), normalizes separators via `pattern.replace(/[\\/]/g, path.sep)`, checks via `split(path.sep).some(segment => singleSegments.has(segment))` or `includes(pattern)`.

### Binary Filter
`createBinaryFilter(options)` phase 1 queries `BINARY_EXTENSIONS` Set (90+ patterns: `.png`, `.exe`, `.mp3`, `.woff`), phase 2 invokes `fs.stat()` for `maxFileSize` check (default 1MB), phase 3 runs `isbinaryfile()` content analysis.

### Custom Filter
`createCustomFilter(patterns, root)` wraps `ignore` library for user-defined `config.exclude.patterns`, converts absolute paths to relative, returns `false` for empty pattern arrays or paths outside root.

## Behavioral Contracts

### Walker Hardcoded Exclusion
```javascript
ignore: ['**/.git/**']
```
Prevents `.git` internals traversal regardless of filter configuration.

### Filter Concurrency Bound
```javascript
Math.min(30, files.length)
```
Caps worker pool size to prevent file descriptor exhaustion during binary detection I/O.

### Short-Circuit Evaluation
```javascript
for (const filter of filters) {
  if (await filter.shouldExclude(file)) {
    return { excluded: { file, reason: filter.name } };
  }
}
```
Chain halts on first exclusion, skipping subsequent filters.

### Binary Extension Normalization
```javascript
ext.startsWith('.') ? ext : `.${ext}`
```
Ensures both `.foo` and `foo` resolve to `.foo` for Set membership.

### Gitignore Relative Path Requirement
`ig.ignores()` requires relative paths. Absolute paths converted via `path.relative(root, absolutePath)`, returning `false` (include) if result starts with `..` (outside root).