<!-- Generated by agents-reverse-engineer -->

# src/discovery

**Gitignore-aware file discovery pipeline using fast-glob directory traversal with composable four-stage filter chain (gitignore, vendor, binary, custom) and bounded-concurrency short-circuit evaluation, exposing `discoverFiles()` facade for all CLI commands.**

## Contents

### Pipeline Orchestration

**[run.ts](./run.ts)** — `discoverFiles(root, config, options?)` facade composes `walkDirectory()` with four-stage filter chain: `createGitignoreFilter()` parses `.gitignore`, `createVendorFilter()` excludes `node_modules`/`.git`/`dist` via `config.exclude.vendorDirs`, `createBinaryFilter()` applies 96-extension allowlist + `isBinaryFile()` fallback with `config.options.maxFileSize` threshold, `createCustomFilter()` processes user glob patterns from `config.exclude.patterns`. Returns `FilterResult` with `included: string[]` and `excluded: Array<{file, reason, filter}>`. Exports `DiscoveryConfig` interface (structural subset of `Config`) and `DiscoverFilesOptions` (`tracer?: ITraceWriter`, `debug?: boolean`).

**[walker.ts](./walker.ts)** — `walkDirectory(options)` wraps `fast-glob` with `absolute: true`, `onlyFiles: true`, `suppressErrors: true`, hardcoded `ignore: ['**/.git/**']`, and `followSymbolicLinks: options.followSymlinks ?? false`. Requires `WalkerOptions` with `cwd: string` root, optional `dot?: boolean` (default `true` for dotfiles), `followSymlinks?: boolean` (default `false`). Returns raw `string[]` file paths without filtering logic (deferred to filter chain).

**[types.ts](./types.ts)** — Defines `FileFilter` interface (`name: string`, `shouldExclude(path, stats?): boolean | Promise<boolean>`), `ExcludedFile` record (`path`, `reason`, `filter`), `FilterResult` (`included[]`, `excluded[]`), `WalkerOptions` (`cwd`, `followSymlinks?`, `dot?`).

## Subdirectory

**[filters/](./filters/)** — Five modules implementing `FileFilter` contract: `gitignore.ts` (`createGitignoreFilter()` async factory with `ignore` library), `binary.ts` (96-extension set + `isBinaryFile()` content analysis), `vendor.ts` (single-segment Set + path-pattern array matching), `custom.ts` (gitignore-style glob parsing), `index.ts` (`applyFilters()` with 30-worker bounded concurrency, short-circuit evaluation, `filter:applied` trace emission).

## Filter Chain Architecture

`discoverFiles()` instantiates filters in priority order (gitignore → vendor → binary → custom), passes to `applyFilters()` which runs filters sequentially per file until `shouldExclude()` returns `true`. Concurrency pool prevents file descriptor exhaustion during `isBinaryFile()` I/O. Filters receive absolute paths; gitignore/custom filters convert to relative via `path.relative()` before pattern matching.

## Configuration Surface

- `config.exclude.vendorDirs: string[]` — directory names like `node_modules` (default 10 entries)
- `config.exclude.binaryExtensions: string[]` — additional extensions beyond 96-entry `BINARY_EXTENSIONS` set
- `config.exclude.patterns: string[]` — gitignore-style globs processed by `ignore` library
- `config.options.maxFileSize: number` — binary detection threshold (default 1MB)
- `config.options.followSymlinks: boolean` — symlink traversal toggle (default `false`)

## Integration Points

Consumed by `src/cli/discover.ts`, `src/cli/generate.ts`, `src/cli/update.ts` via `discoverFiles()` facade. Imports `ITraceWriter` from `../orchestration/trace.js` for `filter:applied` event emission. Filter factories depend on `ignore` library (gitignore parsing), `isbinaryfile` library (content analysis), `fast-glob` (directory traversal), `node:fs` (Stats objects).

## Behavioral Contracts

### Default Vendor Directories
`DEFAULT_VENDOR_DIRS`: `node_modules`, `vendor`, `.git`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`

### Binary Extension Set
96 extensions including: `.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.ico`, `.webp`, `.svg`, `.zip`, `.tar`, `.gz`, `.rar`, `.7z`, `.exe`, `.dll`, `.so`, `.dylib`, `.bin`, `.mp3`, `.mp4`, `.wav`, `.avi`, `.mov`, `.pdf`, `.doc`, `.docx`, `.xls`, `.xlsx`, `.woff`, `.woff2`, `.ttf`, `.eot`, `.class`, `.pyc`, `.o`, `.obj`, `.db`, `.sqlite`, `.wasm` (full list in `filters/binary.ts`)

### Concurrency Limit
`applyFilters()` uses `CONCURRENCY = 30` workers via iterator-based pool pattern from `src/orchestration/pool.ts`

### Trace Event Schema
```typescript
{
  type: 'filter:applied',
  filterName: string,
  filesMatched: number,
  filesRejected: number
}
```