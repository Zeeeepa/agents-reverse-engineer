<!-- Generated by agents-reverse-engineer -->

# src/discovery

Orchestrates file discovery pipeline for ARE: walks directory trees, applies composable filter chains (gitignore, vendor, binary, custom patterns), and returns included/excluded file lists with attribution metadata for subsequent analysis phases.

## Contents

### Orchestration

- **[run.ts](./run.ts)** — `discoverFiles(root: string, config: DiscoveryConfig, options?: DiscoverFilesOptions): Promise<FilterResult>` aggregates full discovery pipeline: instantiates standard four-filter chain (`createGitignoreFilter()`, `createVendorFilter()`, `createBinaryFilter()`, `createCustomFilter()`), invokes `walkDirectory()` for traversal, applies filters via `applyFilters()`, returns `FilterResult` with included/excluded arrays and per-filter statistics.

- **[types.ts](./types.ts)** — `FileFilter` interface defines `name: string` and `shouldExclude(path: string, stats?: Stats): Promise<boolean> | boolean` for strategy pattern composition; `FilterResult` aggregates `included: string[]` and `excluded: ExcludedFile[]`; `WalkerOptions` configures traversal via `cwd`, `followSymlinks` (default false), `dot` (default true).

- **[walker.ts](./walker.ts)** — `walkDirectory(options: WalkerOptions): Promise<string[]>` delegates to `fg.glob('**/*', { absolute: true, onlyFiles: true, dot: true, followSymbolicLinks: false, suppressErrors: true, ignore: ['**/.git/**'] })` for filesystem traversal, returns all candidate files without filtering.

## Subdirectories

- **[filters/](./filters/)** — Implements `FileFilter` interface via four concrete filters: `createBinaryFilter()` (extension + content + size checks), `createVendorFilter()` (path component matching), `createGitignoreFilter()` (async `.gitignore` parsing), `createCustomFilter()` (gitignore-style patterns); exports `applyFilters()` for bounded-concurrency evaluation with short-circuit semantics.

## Architecture

### Pipeline Phases

1. **Traversal**: `walkDirectory()` returns all files under `root` (dotfiles included, `.git/` excluded, symlinks not followed by default)
2. **Filter instantiation**: `discoverFiles()` constructs four filters with config-derived parameters
3. **Concurrent evaluation**: `applyFilters()` spawns worker pool (30 workers, shared iterator) applying filters sequentially per file until first exclusion
4. **Result aggregation**: Returns `FilterResult` partitioning files into included/excluded with `ExcludedFile` attribution

### Filter Chain Contract

Standard chain order enforced by `discoverFiles()`: gitignore → vendor → binary → custom. Each filter evaluates absolute paths, returns `true` to exclude. First matching filter terminates evaluation for that file (short-circuit), recording filter name in `ExcludedFile.filter` field.

### Configuration Surface

`DiscoveryConfig` structural subset extracts `exclude: { vendorDirs, binaryExtensions, patterns }` and `options: { maxFileSize, followSymlinks }` from full `Config` type. Passed to filter constructors: `vendorDirs` → `createVendorFilter()`, `binaryExtensions` → `createBinaryFilter({ additionalExtensions })`, `patterns` → `createCustomFilter()`, `followSymlinks` → `walkDirectory()`.

## Data Flow

```
walkDirectory() → string[]
    ↓
createGitignoreFilter() → FileFilter (async)
createVendorFilter() → FileFilter
createBinaryFilter() → FileFilter
createCustomFilter() → FileFilter
    ↓
applyFilters(files, filters, { tracer?, debug? }) → FilterResult
    ↓
{ included: string[], excluded: ExcludedFile[] }
```

## Dependencies

- **fast-glob** (`fg.glob()`) — directory traversal in walker.ts
- **filters/** — four filter implementations and `applyFilters()` orchestrator
- **../orchestration/trace.js** (`ITraceWriter`) — optional telemetry sink for filter statistics