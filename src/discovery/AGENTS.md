<!-- Generated by agents-reverse-engineer -->

# src/discovery

**Gitignore-aware file discovery system executing four-stage filter chain (gitignore, vendor, binary, custom) over fast-glob traversal results with bounded-concurrency processing (30 workers), early-termination optimization, and per-filter telemetry tracking.**

## Contents

**[run.ts](./run.ts)** — `discoverFiles()` orchestrates filter chain construction via `createGitignoreFilter()`, `createVendorFilter()`, `createBinaryFilter()`, `createCustomFilter()`, invokes `walkDirectory()` with `followSymlinks` flag, delegates filtering to `applyFilters()` with trace/debug options.

**[types.ts](./types.ts)** — Defines `FileFilter` interface (`name: string`, `shouldExclude(): boolean|Promise<boolean>`), `FilterResult` with `included: string[]` and `excluded: ExcludedFile[]`, `WalkerOptions` for traversal config, `ExcludedFile` audit record.

**[walker.ts](./walker.ts)** — `walkDirectory()` wraps `fast-glob` with `absolute: true`, `onlyFiles: true`, `dot: true` (dotfiles), `followSymbolicLinks: false` (default), `ignore: ['**/.git/**']` hardcoded, `suppressErrors: true` (permission denied).

## Architecture

### Filter Chain Execution Model

**Composition**: `discoverFiles()` creates four filters in fixed order before applying to walked files. No in-walker filtering per module comment in `walker.ts`.

**Orchestration**: `applyFilters()` (in `filters/index.ts`) spawns 30 workers sharing `files.entries()` iterator. Sequential filter evaluation per file with early termination on first `shouldExclude() === true`.

**Result Preservation**: Workers collect `{ index, file, excluded? }` tuples, sort by original index to maintain discovery order, segregate into `included`/`excluded` arrays.

### Filter Order

1. **Gitignore** — Async `.gitignore` parser via `ignore` library with relative path normalization
2. **Vendor** — Third-party directories (`node_modules`, `.git`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`)
3. **Binary** — Extension fast path (80+ extensions) → size threshold (1MB) → `isBinaryFile()` content analysis
4. **Custom** — User glob patterns from `config.exclude.patterns` via `ignore` library

### Decoupling Patterns

**DiscoveryConfig Interface**: Structural subset type with `exclude: {vendorDirs, binaryExtensions, patterns}` and `options: {maxFileSize, followSymlinks}` allows `run.ts` to accept full `Config` object without circular dependency on `src/config/schema.ts`.

**Factory Abstraction**: Filter creators (`createGitignoreFilter`, `createVendorFilter`, `createBinaryFilter`, `createCustomFilter`) return uniform `FileFilter` interface enabling chain composition.

**Statistics Aggregation**: `applyFilters()` returns `Map<string, {matched, rejected}>` keyed by filter name for telemetry without coupling to filter implementations.

## Behavioral Contracts

### Binary Detection Thresholds

- **Extension fast path**: 80+ extensions across images/archives/executables/media/documents/fonts/compiled/database
- **Size threshold**: `DEFAULT_MAX_FILE_SIZE = 1048576` (1MB)
- **Content analysis**: `isBinaryFile()` fallback for unknown extensions

### Concurrency Limit

`CONCURRENCY = 30` workers in `applyFilters()` prevents file descriptor exhaustion during I/O-heavy binary detection.

### Vendor Directories

`DEFAULT_VENDOR_DIRS`: `['node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target']`

### Glob Configuration

- `absolute: true` — returns full paths
- `onlyFiles: true` — excludes directories
- `dot: true` — includes dotfiles
- `followSymbolicLinks: false` — default symlink handling
- `ignore: ['**/.git/**']` — hardcoded `.git` exclusion

### Path Normalization

All filters use `path.relative(normalizedRoot, absolutePath)` before exclusion tests, with guards against `'..'` prefix or empty string.

## Subdirectories

**[filters/](./filters/)** — Five filter implementations: `gitignore.ts` (pattern matching via `ignore` library), `vendor.ts` (third-party directory detection), `binary.ts` (extension/size/content analysis), `custom.ts` (user glob patterns), `index.ts` (bounded-concurrency orchestrator with telemetry).

## Integration Points

**Consumed by**: `src/cli/discover.ts`, `src/cli/generate.ts`, `src/cli/update.ts` invoke `discoverFiles()` as single entry point.

**Configuration surface**: `DiscoveryConfig` threaded from `src/config/schema.ts` YAML parsing with fields `exclude.vendorDirs`, `exclude.binaryExtensions`, `exclude.patterns`, `options.maxFileSize`, `options.followSymlinks`.

**Telemetry integration**: Accepts `ITraceWriter` via `DiscoverFilesOptions.tracer`, emits `filter:applied` events with per-filter `filesMatched`/`filesRejected` counts.

**Debug output**: `options.debug` enables `console.error()` logging for filters with non-zero rejection counts.