<!-- Generated by agents-reverse-engineer -->

# src/discovery

File discovery pipeline that walks directory trees and applies composable exclusion filters (gitignore, binary, vendor, custom) to produce included/excluded file lists for documentation generation.

## Contents

### Pipeline Orchestration

- **[run.ts](./run.ts)** — **discoverFiles(root, config, options)** orchestrates full discovery pipeline by calling walkDirectory(), instantiating four filters (createGitignoreFilter, createVendorFilter, createBinaryFilter, createCustomFilter), and passing results to applyFilters() which returns FilterResult with included/excluded arrays
- **[walker.ts](./walker.ts)** — **walkDirectory(options)** uses fast-glob with pattern `**/*` and hardcoded `ignore: ['**/.git/**']` to traverse directory tree from WalkerOptions.cwd, returns absolute paths to all files before filter application
- **[types.ts](./types.ts)** — **FileFilter** interface (name, shouldExclude predicate), **FilterResult** (included, excluded arrays), **ExcludedFile** (path, reason, filter), **WalkerOptions** (cwd, followSymlinks, dot) define discovery contracts

## Subdirectories

- **[filters/](./filters/)** — Four filter implementations (binary.ts, gitignore.ts, vendor.ts, custom.ts) plus applyFilters() orchestrator with bounded concurrency (CONCURRENCY=30), short-circuit exclusion, and per-filter statistics tracking

## Discovery Pipeline Architecture

discoverFiles() in run.ts instantiates filters in fixed order: GitignoreFilter (`.gitignore` rules) → VendorFilter (`node_modules`, `.git`, `dist`, etc.) → BinaryFilter (extension + content detection with maxFileSize threshold) → CustomPatternFilter (user-defined globs from `config.exclude.patterns`). All filters implement FileFilter interface with shouldExclude() predicate. applyFilters() in filters/index.ts applies chain via shared iterator pattern with 30-worker concurrency pool, short-circuiting on first exclusion match and preserving deterministic ordering despite parallel execution.

## Configuration Surface

DiscoveryConfig interface in run.ts requires `exclude.vendorDirs` (string[]), `exclude.binaryExtensions` (string[]), `exclude.patterns` (string[]), `options.maxFileSize` (number), `options.followSymlinks` (boolean). DiscoverFilesOptions provides optional `tracer?: ITraceWriter` (from `../orchestration/trace.js`) for `filter:applied` events and `debug?: boolean` for CLI filter statistics. WalkerOptions.followSymlinks defaults to false per CONTEXT.md, WalkerOptions.dot defaults to true to include dotfiles.

## Filter Chain Execution Model

applyFilters() spawns `Math.min(CONCURRENCY, files.length)` workers sharing single iterator over `files.entries()`. Each worker applies filters sequentially per file, short-circuiting on first `shouldExclude=true` result. Excluded files annotated with ExcludedFile containing filter name and exclusion reason. Results sorted by original index to produce deterministic output despite concurrent processing. Trace events (`filter:applied` with matched/rejected counts) emitted when tracer provided.

## Binary Detection Strategy

BinaryFilter (filters/binary.ts) implements two-phase detection: fast-path extension check against BINARY_EXTENSIONS Set (80+ entries) + additionalExtensions, slow-path `isBinaryFile()` content analysis with maxFileSize gate (default 1MB). Returns `shouldExclude=true` on stat/read errors to prevent downstream failures. Concurrency limit of 30 prevents file descriptor exhaustion during content analysis.

## Path Normalization

Filters requiring relative paths (GitignoreFilter, CustomPatternFilter) use `path.relative(root, absolutePath)` and reject paths starting with `..` or empty strings. VendorFilter normalizes separators via `.replace(/[\\/]/g, path.sep)` for cross-platform matching. walker.ts always returns absolute paths via fast-glob `absolute: true` option.

## Integration Points

CLI commands (src/cli/discover.ts, src/cli/generate.ts, src/cli/update.ts) call discoverFiles() to obtain FilterResult, then pass `included` array to generation orchestrator (src/generation/orchestrator.ts). ExcludedFile array enables CLI reporting of skipped files with filter attribution. Change detector (src/change-detection/detector.ts) uses discoverFiles() to identify documentation targets during incremental updates.