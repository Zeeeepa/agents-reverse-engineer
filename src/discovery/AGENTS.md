<!-- Generated by agents-reverse-engineer -->

# src/discovery

Four-filter discovery pipeline (`gitignore`, `vendor`, `binary`, `custom`) with `walkDirectory()` traversal, `applyFilters()` concurrent chain execution, and `discoverFiles()` orchestration returning `FilterResult` with included files + exclusion attribution.

## Contents

**[run.ts](./run.ts)** — `discoverFiles(root: string, config: DiscoveryConfig, options?: DiscoverFilesOptions): Promise<FilterResult>` orchestrates full pipeline: instantiates filter chain (`createGitignoreFilter()`, `createVendorFilter()`, `createBinaryFilter()`, `createCustomFilter()`), invokes `walkDirectory({ cwd: root, followSymlinks: config.options.followSymlinks })`, applies filters via `applyFilters(files, filters, { tracer, debug })`. Exports `DiscoveryConfig` subset (`exclude: { vendorDirs, binaryExtensions, patterns }`, `options: { maxFileSize, followSymlinks }`) and `DiscoverFilesOptions` (`tracer?: ITraceWriter`, `debug?: boolean`).

**[types.ts](./types.ts)** — Defines `FileFilter` interface (`name: string`, `shouldExclude(path: string, stats?: Stats): Promise<boolean> | boolean`), `ExcludedFile` record (`path`, `reason`, `filter`), `FilterResult` aggregate (`included: string[]`, `excluded: ExcludedFile[]`), `WalkerOptions` config (`cwd`, `followSymlinks?`, `dot?`). Strategy pattern enables composable sync/async filters.

**[walker.ts](./walker.ts)** — `walkDirectory(options: WalkerOptions): Promise<string[]>` returns absolute file paths via `fg.glob('**/*', { cwd, absolute: true, onlyFiles: true, dot: true, followSymbolicLinks: false, suppressErrors: true, ignore: ['**/.git/**'] })`. No filtering—exclusion logic delegated to `src/discovery/filters/`.

## Subdirectories

**[filters/](./filters/)** — Four specialized filters: `binary.ts` (two-phase: extension check → `isBinaryFile()` content analysis), `custom.ts` (user gitignore-style patterns via `ignore` library), `gitignore.ts` (repository `.gitignore` parser), `vendor.ts` (dependency directory exclusion), `index.ts` (`applyFilters()` with 30-worker concurrent chain, short-circuit evaluation, per-filter statistics).

## Architecture

### Discovery Pipeline

`discoverFiles()` executes three-stage pipeline: (1) async filter creation (gitignore reads `.gitignore`, others instantiate synchronously), (2) `walkDirectory()` returns all files without filtering, (3) `applyFilters()` spawns worker pool testing each file against filter array sequentially until exclusion or acceptance. Filters share `DiscoveryConfig.exclude` for vendor/binary/custom rules and `DiscoveryConfig.options.maxFileSize` for binary threshold.

### Filter Chain Contract

Standard four-filter order enforced by `discoverFiles()`: gitignore (repository rules), vendor (dependency directories), binary (extension + content analysis), custom (user patterns). Chain invoked via `applyFilters()` with short-circuit semantics: first `shouldExclude() === true` records `ExcludedFile` with `filter.name` attribution. Filters implement `FileFilter` interface accepting absolute paths, returning sync/async boolean.

### Traversal Configuration

`walkDirectory()` delegates to `fast-glob` with `{ onlyFiles: true, dot: true, followSymbolicLinks: false, suppressErrors: true, ignore: ['**/.git/**'] }`. `followSymlinks` defaults to `false` per CONTEXT.md, overridden via `config.options.followSymlinks` passed from CLI. `suppressErrors: true` silently skips permission-denied files per RESEARCH.md guidance.

## Integration Points

Consumed by `src/cli/discover.ts` (standalone file listing), `src/cli/generate.ts` (full pipeline bootstrap), `src/update/orchestrator.ts` (incremental updates). Depends on `src/orchestration/trace.ts` `ITraceWriter` for optional telemetry, `filters/index.ts` `applyFilters()` for filter execution, `walker.ts` `walkDirectory()` for traversal. Returns `FilterResult` with `included` file list feeding `src/generation/orchestrator.ts` phase-1 task creation.