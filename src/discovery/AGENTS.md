<!-- Generated by agents-reverse-engineer -->

# src/discovery

Gitignore-aware file walker with composable four-stage filter chain (gitignore, vendor, binary, custom) producing FilterResult aggregates of included/excluded files with attribution metadata for discovery phase initialization.

## Contents

**[walker.ts](./walker.ts)** — `walkDirectory(options: WalkerOptions)` returns absolute paths for all files under `options.cwd` via `fast-glob('**/*')` with `onlyFiles: true`, `dot: true` (includes dotfiles), `followSymbolicLinks: options.followSymlinks ?? false`, hardcoded `.git/**` exclusion, `suppressErrors: true` (continues on permission errors).

**[run.ts](./run.ts)** — `discoverFiles(root: string, config: DiscoveryConfig, options?: DiscoverFilesOptions)` orchestrates filter pipeline: invokes `walkDirectory()`, constructs four filters via `createGitignoreFilter(root)`, `createVendorFilter(config.exclude.vendorDirs)`, `createBinaryFilter({ maxFileSize: config.options.maxFileSize, additionalExtensions: config.exclude.binaryExtensions })`, `createCustomFilter(config.exclude.patterns, root)`, executes via `applyFilters(files, filters, { tracer, debug })`, returns `FilterResult` with `included`/`excluded` arrays.

**[types.ts](./types.ts)** — Exports `FileFilter` interface (`{ name: string, shouldExclude(path: string, stats?: Stats): boolean | Promise<boolean> }`), `FilterResult` interface (`{ included: string[], excluded: ExcludedFile[] }`), `ExcludedFile` record (`{ path, reason, filter }`), `WalkerOptions` config (`{ cwd: string, followSymlinks?: boolean, dot?: boolean }`). No runtime dependencies—pure type definitions.

## Filter Pipeline Architecture

`discoverFiles()` executes filters in fixed order: gitignore → vendor → binary → custom. Short-circuit evaluation: file rejected on first filter match, remaining filters skipped. `applyFilters()` from `filters/index.ts` uses concurrency-bounded execution (30 worker pool) with trace emission via `filter:applied` events containing `{ type: 'filter:applied', filterName, filesMatched, filesRejected }`.

## Configuration Surface

`DiscoveryConfig` subset from `src/config/schema.ts`:
- `exclude.vendorDirs: string[]` — directories matched anywhere in path (e.g., `node_modules`, `.git`, `dist`)
- `exclude.binaryExtensions: string[]` — file extensions for fast-path exclusion (e.g., `.png`, `.zip`, `.exe`)
- `exclude.patterns: string[]` — gitignore-style globs matched via `ignore` library
- `options.maxFileSize: number` — binary detection threshold (default 1MB)
- `options.followSymlinks: boolean` — symlink traversal (default false per security constraints)

`DiscoverFilesOptions` extends runtime config:
- `tracer?: ITraceWriter` — NDJSON trace event emitter from `orchestration/trace.ts`
- `debug?: boolean` — verbose filter logging to stderr

## Data Flow

```
walkDirectory(cwd, followSymlinks) → string[]
  ↓
applyFilters(files, [gitignore, vendor, binary, custom], { tracer, debug }) → FilterResult
  ↓
{ included: string[], excluded: ExcludedFile[] }
```

Walker performs no filtering except `.git/**` exclusion—all semantic filtering delegated to filter chain. Result structure supports diagnostics via `excluded` metadata and plan generation via full file enumeration.

## Integration Points

- **cli/discover.ts**: calls `discoverFiles()`, writes `GENERATION-PLAN.md` with included/excluded breakdown
- **cli/generate.ts**: uses `included` array for Phase 1 file analysis task queue
- **cli/update.ts**: invokes `discoverFiles()` to detect new files not in existing `.sum` frontmatter hashes
- **filters/**: subdirectory containing `createGitignoreFilter`, `createVendorFilter`, `createBinaryFilter`, `createCustomFilter` factories implementing `FileFilter` interface

## Design Rationale

Separation of concerns: `walkDirectory()` handles traversal, filter chain handles exclusion logic. Composable filters enable independent testing and configurable ordering. `FilterResult` structure preserves exclusion metadata for debugging unlike simple string arrays. Async `FileFilter.shouldExclude()` supports I/O-bound filters (gitignore file reads, binary content analysis) without blocking synchronous filters (vendor directory lookups).