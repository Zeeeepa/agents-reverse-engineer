<!-- Generated by agents-reverse-engineer v0.8.2 -->

# src/discovery

Unified file discovery pipeline combining `walkDirectory()` fast-glob traversal with four-filter exclusion chain (gitignore → vendor → binary → custom), returning `FilterResult` with absolute paths partitioned by acceptance/rejection metadata.

## Contents

**[run.ts](./run.ts)** — `discoverFiles(root, config, options?)` orchestrates pipeline: invokes `walkDirectory()` with `config.options.followSymlinks`, constructs filter chain via `createGitignoreFilter(root)`, `createVendorFilter(config.exclude.vendorDirs)`, `createBinaryFilter({maxFileSize: config.options.maxFileSize, additionalExtensions: config.exclude.binaryExtensions})`, `createCustomFilter(config.exclude.patterns, root)`, applies via `applyFilters(files, filters, {tracer, debug})`. Exports `DiscoveryConfig` subset interface and `DiscoverFilesOptions` with optional `tracer`/`debug` flags.

**[types.ts](./types.ts)** — Core contracts: `FileFilter` interface (`name: string`, `shouldExclude(path, stats?): boolean | Promise<boolean>`), `ExcludedFile` record (`path`, `reason`, `filter`), `FilterResult` (`included: string[]`, `excluded: ExcludedFile[]`), `WalkerOptions` (`cwd`, optional `followSymlinks`/`dot`).

**[walker.ts](./walker.ts)** — `walkDirectory(options)` wraps `fast-glob@3.3.3` with `absolute: true`, `onlyFiles: true`, `dot` (default true), `followSymbolicLinks` (default false), `suppressErrors: true`, hardcoded `.git` exclusion via `ignore: ['**/.git/**']`. Returns raw absolute paths before filter chain application.

## Subdirectories

**[filters/](./filters/)** — Four-filter exclusion pipeline: `createGitignoreFilter()` (pattern matching via `ignore` library), `createVendorFilter()` (partitioned Set lookup + substring match for 10+ vendor dirs), `createBinaryFilter()` (two-phase: 90+ extension Set then `isbinaryfile()` content analysis with 1MB size cap), `createCustomFilter()` (user patterns). `applyFilters()` orchestrates concurrency-30 worker pool with short-circuit evaluation, preserves order, tracks per-filter stats, emits trace events.

## Architecture

### Discovery Flow

1. `walkDirectory(options)` → `fast-glob` → raw absolute paths
2. `createGitignoreFilter(root)` reads `.gitignore`, converts absolute→relative for `ignore().ignores()`
3. `createVendorFilter(dirs)` partitions single/multi-segment patterns, checks path segments + substrings
4. `createBinaryFilter(options)` checks extension Set (fast path) → content analysis fallback for unknown extensions
5. `createCustomFilter(patterns, root)` wraps user `.agents-reverse-engineer/config.yaml` exclusions
6. `applyFilters(files, filters, {tracer, debug})` runs concurrency-30 pool, short-circuits on first exclusion
7. Returns `FilterResult` with `included`/`excluded` arrays

### Concurrency Model

Iterator-based pool with `CONCURRENCY=30` bounds parallel I/O during binary content analysis (`fs.stat()` + `isbinaryfile()`). Spawns `Math.min(30, files.length)` workers sharing `files.entries()` iterator. Prevents file descriptor exhaustion on large repos.

## Behavioral Contracts

### Default Vendor Directories
```javascript
['node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target']
```

### Binary Size Limit
```javascript
DEFAULT_MAX_FILE_SIZE = 1048576  // 1MB
```

### Gitignore Path Conversion
```javascript
const relativePath = path.relative(normalizedRoot, absolutePath)
if (relativePath === '' || relativePath.startsWith('..')) return false
return ig.ignores(relativePath)
```

### Filter Short-Circuit
```javascript
for (const filter of filters) {
  if (await filter.shouldExclude(file)) {
    return { excluded: { file, reason: filter.name, filterName: filter.name } }
  }
}
return { included: file }
```

### Walker Exclusions
```javascript
ignore: ['**/.git/**']  // Hardcoded in walkDirectory()
```

## Integration

Entry point for CLI commands: `src/cli/discover.ts` writes `GENERATION-PLAN.md`, `src/cli/generate.ts` + `src/cli/update.ts` pass `FilterResult.included` to `src/generation/orchestrator.ts` phase-1 task creation. Shared discovery strategy ensures consistent file set across commands.