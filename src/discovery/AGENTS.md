<!-- Generated by agents-reverse-engineer -->

# src/discovery

File discovery orchestration composing gitignore, vendor, binary, and custom exclusion filters via fast-glob directory traversal and bounded-concurrency filter chain with telemetry emission.

## Contents

**[run.ts](./run.ts)** — discoverFiles() orchestrates discovery pipeline: composes four filters (createGitignoreFilter, createVendorFilter, createBinaryFilter, createCustomFilter), invokes walkDirectory() with symlink/follow options, applies filter chain via applyFilters(), returns FilterResult with included/excluded file lists and rejection metadata.

**[walker.ts](./walker.ts)** — walkDirectory() delegates to fast-glob with `**/*` pattern, hardcoded `.git/**` exclusion, absolute path output, permission error suppression via `suppressErrors: true`, configurable dot file inclusion and symlink following via WalkerOptions.

**[types.ts](./types.ts)** — Defines FileFilter interface (name, shouldExclude predicate supporting sync/async), FilterResult (included/excluded arrays), ExcludedFile (path/reason/filter tracking), WalkerOptions (cwd/followSymlinks/dot configuration).

## Architecture

### Two-Phase Discovery Pipeline

**Phase 1: Directory Walk** — walkDirectory() produces unfiltered file list via fast-glob, returns absolute paths for downstream filter consumption. Excludes `.git/**` hardcoded for performance optimization.

**Phase 2: Filter Chain** — applyFilters() from `filters/index.ts` applies composed filter array with short-circuit evaluation (stops at first exclusion), 30-worker concurrency pool, per-filter statistics aggregation, ITraceWriter emission of `filter:applied` events.

### Filter Composition Pattern

discoverFiles() creates filter instances in fixed order:

1. **GitignoreFilter** — Async initialization parses root `.gitignore`, converts absolute→relative paths for `ig.ignores()` predicate
2. **VendorFilter** — Synchronous third-party directory matching (node_modules, .git, dist, etc.)
3. **BinaryFilter** — Two-phase detection: extension fast path (91 types), content analysis fallback via isbinaryfile
4. **CustomFilter** — User-defined glob patterns via ignore library

Filter chain execution preserves order, tags excluded files with responsible filter name for telemetry and debugging.

### Configuration Surface

discoverFiles() consumes DiscoveryConfig subset of full Config schema:

- `exclude.vendorDirs[]` → VendorFilter
- `exclude.binaryExtensions[]` → BinaryFilter (merged with 91-entry default set)
- `exclude.patterns[]` → CustomFilter
- `options.maxFileSize` → BinaryFilter size threshold (default 1MB)
- `options.followSymlinks` → walkDirectory() symlink behavior (default false)

DiscoverFilesOptions threads `tracer?: ITraceWriter` and `debug?: boolean` through to applyFilters() for telemetry emission.

## Integration Points

**CLI Commands:**
- `src/cli/discover.ts` — Writes GENERATION-PLAN.md with phase breakdown from FilterResult
- `src/cli/generate.ts` — Feeds three-phase pipeline via orchestrateGeneration(FilterResult.included)
- `src/cli/update.ts` — Computes affected directories from FilterResult.included array

**Orchestration Layer:**
- `src/orchestration/trace.ts` — ITraceWriter receives filter:applied events with per-filter statistics (matched/rejected counts)

**Filter Implementations:**
- `filters/index.ts` — applyFilters() orchestrates 30-worker pool with short-circuit evaluation
- `filters/gitignore.ts`, `filters/vendor.ts`, `filters/binary.ts`, `filters/custom.ts` — FileFilter implementations

## File Relationships

run.ts depends on walker.ts (walkDirectory), filters/index.ts (filter factories, applyFilters), types.ts (FilterResult/DiscoveryConfig interfaces), ../orchestration/trace.ts (ITraceWriter). walker.ts has no internal dependencies (delegates to fast-glob). types.ts imports Stats from node:fs, defines interfaces consumed across discovery module. filters/ subdirectory operates independently with shared FileFilter contract from types.ts.

## Subdirectories

**[filters/](./filters/)** — FileFilter implementations: binary.ts (extension+content detection), custom.ts (user glob patterns), gitignore.ts (.gitignore parsing), vendor.ts (third-party directories), index.ts (applyFilters orchestration with 30-worker pool, short-circuit evaluation, statistics tracking).