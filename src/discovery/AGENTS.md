<!-- Generated by agents-reverse-engineer -->

# src/discovery

File discovery pipeline orchestrating directory traversal and four-filter exclusion chain (gitignore, vendor, binary, custom) to produce FilterResult with inclusion/exclusion attribution.

## Contents

**[run.ts](./run.ts)** — `discoverFiles(root: string, config: DiscoveryConfig, options?: DiscoverFilesOptions): Promise<FilterResult>` orchestrates discovery by calling `walkDirectory()`, assembling filter chain via `createGitignoreFilter()`, `createVendorFilter()`, `createBinaryFilter()`, `createCustomFilter()`, then invoking `applyFilters()`. Exports `DiscoveryConfig` (subset of Config with `exclude: { vendorDirs, binaryExtensions, patterns }` and `options: { maxFileSize, followSymlinks }`) and `DiscoverFilesOptions` (optional `tracer?: ITraceWriter`, `debug?: boolean`). Threads tracer and debug flags through to `applyFilters()`.

**[types.ts](./types.ts)** — Defines `FileFilter` interface (`name: string`, `shouldExclude(path: string, stats?: Stats): Promise<boolean> | boolean`), `ExcludedFile` record (`path`, `reason`, `filter`), `FilterResult` (`included: string[]`, `excluded: ExcludedFile[]`), and `WalkerOptions` (`cwd`, `followSymlinks?: boolean`, `dot?: boolean`). Strategy pattern enables pluggable exclusion rules.

**[walker.ts](./walker.ts)** — `walkDirectory(options: WalkerOptions): Promise<string[]>` traverses filesystem via `fg.glob('**/*')` with `absolute: true`, `onlyFiles: true`, `suppressErrors: true`, `ignore: ['**/.git/**']`. Returns all file paths without filtering (filters applied separately via `src/discovery/filters/index.ts`).

## Subdirectories

**[filters/](./filters/)** — Five-filter exclusion pipeline: `createGitignoreFilter()` (`.gitignore` parser), `createVendorFilter()` (directory name/substring matching against `DEFAULT_VENDOR_DIRS`), `createBinaryFilter()` (extension fast-path + size threshold + `isBinaryFile()` content analysis), `createCustomFilter()` (user patterns via `ignore` library), and `applyFilters()` orchestrator with short-circuit evaluation, iterator-based pool (concurrency=30), and trace event emission.

## Architecture

Three-stage pipeline: (1) `walkDirectory()` returns all file paths, (2) filter factories instantiate exclusion rules in fixed order (gitignore → vendor → binary → custom), (3) `applyFilters()` evaluates filter chain with short-circuit logic. Separation of traversal and filtering enables independent filter composition and testing.

## Integration Points

Consumed by CLI commands (`src/cli/discover.ts`, `generate.ts`, `update.ts`, `rebuild.ts`) as shared discovery logic. Imports `ITraceWriter` from `../orchestration/trace.js` for observability. Emits `filter:applied` trace events with matched/rejected counts.

## Behavioral Contracts

### Discovery Configuration
- `DiscoveryConfig.options.followSymlinks`: defaults false per CONTEXT.md
- `DiscoveryConfig.options.maxFileSize`: passed to `createBinaryFilter()` as size threshold (defaults 1MB)
- `DiscoveryConfig.exclude.vendorDirs`: array of directory names/patterns for `createVendorFilter()`
- `DiscoveryConfig.exclude.binaryExtensions`: additional extensions merged with `BINARY_EXTENSIONS` in `createBinaryFilter()`
- `DiscoveryConfig.exclude.patterns`: user-defined gitignore-style patterns for `createCustomFilter()`

### Filter Chain Order
1. Gitignore filter (`.gitignore` parsing)
2. Vendor filter (third-party directory exclusion)
3. Binary filter (extension/size/content analysis)
4. Custom filter (user-provided patterns)

### Path Normalization
All filter inputs use absolute paths from `walkDirectory()`. Gitignore and custom filters convert to relative via `path.relative(root, absolutePath)` before pattern matching. Vendor filter uses absolute paths with `includes()` substring matching.