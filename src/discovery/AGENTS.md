<!-- Generated by agents-reverse-engineer -->

# src/discovery

File discovery pipeline orchestrating four-filter chain execution (gitignore → vendor → binary → custom) after fast-glob directory traversal, returning attributed inclusion/exclusion results.

## Contents

**[run.ts](./run.ts)** — Exports `discoverFiles()` facade creating filter chain (GitignoreFilter → VendorFilter → BinaryFilter → CustomPatternFilter) via factory functions, invoking `walkDirectory()` with symlink control, applying filters via `applyFilters()` with trace/debug propagation, returning `FilterResult` with per-file attribution.

**[types.ts](./types.ts)** — Defines `FileFilter` interface (`name: string`, `shouldExclude(path, stats?): boolean | Promise<boolean>`), `ExcludedFile` record (`path`, `reason`, `filter`), `FilterResult` aggregate (`included: string[]`, `excluded: ExcludedFile[]`), `WalkerOptions` config (`cwd`, `followSymlinks?`, `dot?`).

**[walker.ts](./walker.ts)** — Implements `walkDirectory(options: WalkerOptions): Promise<string[]>` via `fg.glob('**/*', {absolute: true, onlyFiles: true, suppressErrors: true, ignore: ['**/.git/**']})` with cwd-relative traversal, dotfile inclusion (default true), symlink control (default false).

## Subdirectories

**[filters/](./filters/)** — Four filter implementations: `binary.ts` (extension Set + size threshold + content analysis), `gitignore.ts` (`.gitignore` parser via `ignore` library), `vendor.ts` (Set lookup for single-segment + substring for path patterns), `custom.ts` (user-defined glob patterns). Orchestrator `index.ts` exports `applyFilters()` with 30-worker concurrency, short-circuit evaluation, per-filter statistics (`matched`/`rejected`), `filter:applied` trace events.

## Architecture

### Discovery Pipeline Flow

1. **Configuration** — Caller (CLI commands) loads `DiscoveryConfig` subset from full config schema via `loadConfig()`
2. **Filter Creation** — `discoverFiles()` constructs four filters in deterministic order: `createGitignoreFilter(root)`, `createVendorFilter(config.exclude.vendorDirs)`, `createBinaryFilter({maxFileSize, additionalExtensions: config.exclude.binaryExtensions})`, `createCustomFilter(config.exclude.patterns, root)`
3. **Directory Walking** — Delegates to `walkDirectory({cwd: root, followSymlinks: config.options.followSymlinks})` returning absolute paths via fast-glob
4. **Filter Application** — Invokes `applyFilters(files, filters, {tracer, debug})` from `filters/index.ts` executing short-circuit filter chain across 30 concurrent workers
5. **Result Aggregation** — Returns `FilterResult` with `included` files passing all filters, `excluded` array containing `ExcludedFile` records with `filter`/`reason` attribution

### Path Normalization Contract

Filters receive absolute paths from walker, convert to relative via `path.relative(normalizedRoot, absolutePath)` for pattern matching (gitignore/custom patterns). Paths outside root (relative path starts with `..`) bypass filtering. Walker emits absolute paths via `fast-glob` option `{absolute: true}`.

### Filter Interface Polymorphism

`FileFilter.shouldExclude()` supports both sync/async implementations via union return type `boolean | Promise<boolean>`. Binary filter uses async `fs.stat()` + `isbinaryfile.isBinaryFile()`, others use sync string matching. Filter chain executor awaits all promises via `Promise.resolve()` wrapper.

### Configuration Structural Typing

`DiscoveryConfig` interface in `run.ts` defines minimal subset of full `Config` schema from `src/config/schema.ts` containing only `exclude.*`, `options.maxFileSize`, `options.followSymlinks` fields. Enables unit testing with minimal mock objects, prevents tight coupling to entire config schema.

## Integration Points

**Callers**: `src/cli/discover.ts`, `src/cli/generate.ts`, `src/cli/update.ts` invoke `discoverFiles()` with config from `loadConfig()`.

**Consumers**: `FilterResult.included` feeds Phase 1 file analysis worker pool in `src/generation/executor.ts`, `FilterResult.excluded` populates `GENERATION-PLAN.md` statistics via `PlanTracker.writeGenerationPlan()`.

**Telemetry**: `ITraceWriter` from `src/orchestration/trace.ts` emits `filter:applied` events with per-filter match/rejection counts when `--trace` flag enabled.