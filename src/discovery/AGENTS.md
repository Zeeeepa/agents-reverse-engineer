<!-- Generated by agents-reverse-engineer -->

# src/discovery

**File discovery pipeline orchestration with composable filter chain architecture.** Traverses directory trees via fast-glob, applies sequential filters (gitignore → vendor → binary → custom), and returns `FilterResult` with included files and exclusion metadata for downstream analysis.

## Contents

**[run.ts](./run.ts)** — `discoverFiles(root, config, options?)` orchestrates discovery pipeline by composing `walkDirectory()` with four-filter chain, returns `FilterResult { included, excluded }`. Exports `DiscoveryConfig` (config subset with `exclude.*` and `options.*` fields) and `DiscoverFilesOptions` for tracer/debug injection.

**[walker.ts](./walker.ts)** — `walkDirectory(options)` delegates to `fg.glob('**/*')` with `ignore: ['**/.git/**']`, `suppressErrors: true`, `onlyFiles: true`. Accepts `WalkerOptions { cwd, followSymlinks?, dot? }`, returns absolute file paths without filtering.

**[types.ts](./types.ts)** — `FileFilter` interface defines `{ name: string; shouldExclude(path, stats?): boolean | Promise<boolean> }`. `FilterResult` aggregates `{ included: string[], excluded: ExcludedFile[] }`. `ExcludedFile` captures `{ path, reason, filter }` metadata. `WalkerOptions` configures traversal with `{ cwd, followSymlinks?, dot? }`.

## Subdirectories

**[filters/](./filters/)** — Four filter implementations (`createGitignoreFilter`, `createVendorFilter`, `createBinaryFilter`, `createCustomFilter`) and `applyFilters` orchestrator with concurrency=30, short-circuit evaluation, per-filter stats tracking.

## Architecture

### Filter Chain Execution Order
1. `createGitignoreFilter(root)` — .gitignore patterns via `ignore` library, relative path conversion
2. `createVendorFilter(config.exclude.vendorDirs)` — partitioned matching (Set for single-segment, substring for multi-segment)
3. `createBinaryFilter({ maxFileSize, additionalExtensions })` — extension lookup (80+ BINARY_EXTENSIONS) + `isBinaryFile()` fallback
4. `createCustomFilter(config.exclude.patterns, root)` — user patterns via `ignore` library

Sequential order ensures gitignore precedence over custom patterns. Each filter's `shouldExclude()` evaluated until first exclusion.

### Concurrency Control
`applyFilters` spawns `Math.min(30, files.length)` workers sharing single iterator. Binary filter's I/O-bound `isBinaryFile()` calls distributed across workers to prevent file descriptor exhaustion. Results sorted by entry index to preserve input order.

### Integration Points
- **Consumers**: `src/cli/discover.ts`, `src/cli/generate.ts`, `src/cli/update.ts` all invoke `discoverFiles()` as shared entry point
- **Tracing**: `options.tracer` threaded to `applyFilters` for `filter:applied` events with per-filter match/reject counts
- **Dependencies**: fast-glob (traversal), ignore (gitignore patterns), isbinaryfile (content detection)

## File Relationships

`run.ts` imports `walkDirectory` from `walker.ts`, imports `applyFilters` + filter creators from `filters/index.ts`, imports `FilterResult` from `types.ts`. Filter modules implement `FileFilter` interface from `types.ts`. Discovery phase output feeds `src/generation/orchestrator.ts` file analysis workers.