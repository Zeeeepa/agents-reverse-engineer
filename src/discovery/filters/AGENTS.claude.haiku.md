<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/discovery/filters

The filters directory implements a composable chain of file exclusion filters for the discovery phase, combining gitignore patterns, vendor directory detection, binary file identification, and custom patterns into a unified filtering pipeline with bounded concurrency and trace recording.

## Contents

**Filter Factories**

- [binary.ts](./binary.ts) — Two-phase binary detection via `BINARY_EXTENSIONS` Set (O(1) extension check) and `isBinaryfile` content analysis for unknown types; exports `createBinaryFilter(options: BinaryFilterOptions): FileFilter` with configurable `maxFileSize` threshold.

- [vendor.ts](./vendor.ts) — Excludes third-party code via `DEFAULT_VENDOR_DIRS` (node_modules, dist, build, etc.); exports `createVendorFilter(vendorDirs: string[]): FileFilter` with dual-mode matching for single-segment directory names and multi-segment path patterns.

- [gitignore.ts](./gitignore.ts) — Loads `.gitignore` from root directory and wraps `ignore` library patterns; exports async `createGitignoreFilter(root: string): Promise<FileFilter>` that converts absolute paths to relative paths for pattern matching.

- [custom.ts](./custom.ts) — Applies caller-provided gitignore-style patterns via `ignore` library; exports `createCustomFilter(patterns: string[], root: string): FileFilter` for runtime pattern registration.

- [index.ts](./index.ts) — Orchestrates filter chain execution with `applyFilters(files: string[], filters: FileFilter[], options?): Promise<FilterResult>` applying filters in order with short-circuit semantics, bounded concurrency (`CONCURRENCY = 30`), and trace emission via `ITraceWriter`.

## Filter Chain Architecture

`applyFilters()` processes file arrays through an ordered filter chain where each `FileFilter` has `name: string` and `shouldExclude(absolutePath): Promise<boolean> | boolean`. Evaluation stops at first truthy exclusion per file; results returned as `{ included: string[], excluded: ExcludedFile[] }` with per-filter statistics tracked for trace events (`filter:applied`).

Concurrency bounded via worker pool from shared iterator to prevent file descriptor exhaustion during binary content I/O (critical for `isBinaryFile` checks in `createBinaryFilter`).

## Behavioral Contracts

**Path Normalization:**
- Absolute paths → relative paths via `path.relative(normalizedRoot, absolutePath)`
- Relative paths starting with `'..'` or empty strings treated as outside-root and never excluded
- OS-specific path separator normalization in vendor filter via `path.sep`

**Extension Detection (binary.ts):**
- Case-insensitive via `path.extname().toLowerCase()`
- 65 binary extensions pre-computed into `BINARY_EXTENSIONS` Set for O(1) lookup

**Vendor Directory Matching (vendor.ts):**
- Single-segment names ('node_modules') matched anywhere in path hierarchy via `absolutePath.split(path.sep)` segment checking
- Multi-segment patterns ('apps/vendor') matched via substring inclusion after OS normalization

**Pattern Matching (gitignore, custom):**
- Empty pattern arrays return `false` (pass all files)
- Missing .gitignore file silently handled (no error thrown)

## File Relationships

- `binary.ts`, `vendor.ts`, `gitignore.ts`, `custom.ts` each implement `FileFilter` interface from `../types.js`
- `index.ts` imports and re-exports all four filter factories, then chains their execution via `applyFilters()`
- `applyFilters()` consumes filter `name` field for trace event attribution and exclusion reason recording
- Trace events emitted to optional `ITraceWriter` (from `../../orchestration/trace.js`) with per-filter match counts
- Optional `logger` parameter (type `Logger` from `../../core/logger.js`) defaults to `nullLogger` for debug output