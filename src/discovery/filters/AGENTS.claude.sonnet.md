<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/discovery/filters
`src/discovery/filters` implements a composable file filtering pipeline for codebase discovery, combining gitignore pattern matching, vendor directory exclusion, binary file detection, and custom user patterns into a short-circuit evaluation chain with bounded concurrency.

## Contents
- [`binary.ts`](./binary.ts): Exports `createBinaryFilter(options?: BinaryFilterOptions): FileFilter` with two-phase exclusion: fast-path via `BINARY_EXTENSIONS` set (80+ extensions like .png, .exe, .woff), slow-path via `isBinaryFile()` content analysis and `maxFileSize` threshold (default 1MB).
- [`custom.ts`](./custom.ts): Exports `createCustomFilter(patterns: string[], root: string): FileFilter` for gitignore-style user patterns using `ignore` library; converts absolute paths to relative via `path.relative()`, returns false for empty patterns or paths outside root.
- [`gitignore.ts`](./gitignore.ts): Exports async `createGitignoreFilter(root: string): Promise<FileFilter>` that loads `.gitignore` from root, parses patterns via `ignore()`, excludes paths matching gitignore rules; paths outside root or missing `.gitignore` yield no exclusions.
- [`index.ts`](./index.ts): Exports `applyFilters(files: string[], filters: FileFilter[], options?): Promise<FilterResult>` with concurrency=30, short-circuit evaluation (stops at first shouldExclude=true), per-filter stats tracking, 'filter:applied' trace emission; re-exports all filter factories and constants.
- [`vendor.ts`](./vendor.ts): Exports `createVendorFilter(vendorDirs: string[]): FileFilter` matching `DEFAULT_VENDOR_DIRS` (`node_modules`, `vendor`, `.git`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`) as path segments or substrings; single-segment patterns match any directory name, multi-segment patterns match via normalized substring inclusion.

## Architecture
Filters implement `FileFilter` (from `../types.js`) with `name: string` and `shouldExclude(absolutePath: string): boolean | Promise<boolean>`; `applyFilters()` orchestrates sequential filter application per file using shared iterator-based worker pool (30 workers), preserving original file order via index-sorted results; constructs `FilterResult` with `included: string[]`, `excluded: ExcludedFile[]` (path, reason, filter); integrates with trace system via `ITraceWriter` and debug logging via `Logger`.

## Concurrency Management
`CONCURRENCY=30` bounds parallel file processing to prevent file descriptor exhaustion during binary content detection I/O; workers consume from shared iterator for load balancing; each file evaluated until first filter exclusion (short-circuit).

## Behavioral Contracts
- **Path Normalization**: All filters convert absolute paths to relative via `path.relative(normalizedRoot, absolutePath)` before pattern matching; paths starting with `..` (outside root) return false (not excluded).
- **Vendor Matching**: Single-segment patterns (no path separator) match any directory name in path components; multi-segment patterns match via substring inclusion after OS-specific separator normalization.
- **Binary Detection Fast-Path**: `BINARY_EXTENSIONS` set contains lowercase extensions with leading dots (`.png`, `.jpg`, `.zip`, `.exe`, `.pdf`, `.woff`, `.class`, `.db`); extension check via `path.extname().toLowerCase()`.
- **Binary Detection Slow-Path**: Enforces `maxFileSize` (default `DEFAULT_MAX_FILE_SIZE = 1024 * 1024` bytes) via `fs.stat()`, then `isBinaryFile(absolutePath)` content analysis; stat/read errors return true (exclude).
- **Gitignore Pattern Matching**: Uses `ignore` library's `ig.ignores(relativePath)` for exclusion; missing `.gitignore` caught silently (no exclusions).
- **Filter Chain Execution**: Per-file filter evaluation stops at first `shouldExclude=true`; `ExcludedFile.reason` set to filter name; `FilterResult` preserves original file order via index-based sorting.

## Integration Points
Consumed by `../walker.ts` discovery pipeline; emits `filter:applied` trace events to `ITraceWriter` from `../../orchestration/trace.js`; logs rejected counts via `Logger` from `../../core/logger.js` when `debug=true`; integrates with `.agents-reverse-engineer/config.yaml` via `exclude.vendorDirs`, `exclude.binaryExtensions`, `exclude.patterns`, `options.maxFileSize`.