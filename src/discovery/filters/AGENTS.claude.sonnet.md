<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/discovery/filters

File discovery filter chain implementing `.gitignore`, vendor directory, binary file, and custom pattern exclusions with bounded-concurrency evaluation and per-filter telemetry.

## Contents

- [`binary.ts`](./binary.ts): `createBinaryFilter(options?: BinaryFilterOptions)` returns two-phase detector checking extension-based fast path (`BINARY_EXTENSIONS` set: 97 extensions including `.png`/`.jpg`/`.zip`/`.exe`/`.mp3`/`.pdf`/`.woff`/`.class`/`.db`) then content analysis via `isBinaryFile()` for unknowns, enforces `maxFileSize` threshold (default 1048576 bytes).
- [`custom.ts`](./custom.ts): `createCustomFilter(patterns: string[], root: string)` wraps `ignore` library, validates paths within root via `path.relative()` prefix check (`..` returns `false`), matches gitignore-style patterns against relative paths.
- [`gitignore.ts`](./gitignore.ts): `createGitignoreFilter(root: string)` parses `{root}/.gitignore` via `ignore()`, converts absoluteâ†’relative paths, rejects paths outside root or empty, silently passes all if `.gitignore` missing.
- [`index.ts`](./index.ts): `applyFilters(files: string[], filters: FileFilter[], options?)` orchestrates short-circuit filter chain with 30-worker bounded concurrency pool, tracks `FilterResult.included`/`FilterResult.excluded` (with `path`/`reason`/`filter`), emits `filter:applied` trace events with `filesMatched`/`filesRejected` per filter, preserves input order via index sorting. Re-exports `createGitignoreFilter`, `createVendorFilter`, `DEFAULT_VENDOR_DIRS`, `createBinaryFilter`, `BINARY_EXTENSIONS`, `BinaryFilterOptions`, `createCustomFilter`.
- [`vendor.ts`](./vendor.ts): `createVendorFilter(vendorDirs: string[])` partitions input into `singleSegments` (no separators) and `pathPatterns` (contains `path.sep`), iterates path segments checking segment set membership then pattern substring matching. `DEFAULT_VENDOR_DIRS`: `['node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target']`.

## Architecture

**Filter Chain Pipeline**: `applyFilters()` executes filters sequentially per file with short-circuit on first exclusion. Concurrency applied at file level (30 workers) not filter level to bound file descriptor usage during `isBinaryFile()` I/O. Results deduplicated via index tracking to preserve input order.

**Filter Factory Pattern**: Each `create*Filter()` returns `FileFilter` interface (`name: string`, `shouldExclude(absolutePath: string): Promise<boolean> | boolean`). Stateless design enables reuse across discovery runs.

**Path Normalization**: Filters accept absolute paths, convert to relative via `path.relative(root, absolutePath)`, reject out-of-tree paths (prefix `..`) to enforce root boundary.

## Behavioral Contracts

**Concurrency Constant**: `CONCURRENCY = 30` workers in `applyFilters()` pool.

**Binary Extensions Set** (97 entries):
`.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.ico`, `.webp`, `.svg`, `.zip`, `.tar`, `.gz`, `.exe`, `.dll`, `.so`, `.mp3`, `.mp4`, `.pdf`, `.woff`, `.woff2`, `.ttf`, `.class`, `.pyc`, `.db`, `.sqlite` + 70 variants.

**Default Vendor Directories**:
`['node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target']`

**Exclusion Reason Format**: `"Excluded by ${filter.name} filter"` (from `index.ts:applyFilters`).

**Trace Event Schema**: `{ type: 'filter:applied', filterName: string, filesMatched: number, filesRejected: number }`.

**Debug Log Format**: `[debug] Filter [${filter.name}]: ${stats.rejected} files rejected` (only when `options.debug && stats.rejected > 0`).

**Default File Size Limit**: `maxFileSize: 1048576` bytes (1MB) in `createBinaryFilter`.

**Gitignore Trailing Slash Semantics**: Paths checked as-is without appended `/` (file-only assumption, directories require explicit suffix per `ignore` library).