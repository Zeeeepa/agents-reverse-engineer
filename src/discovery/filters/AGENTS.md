<!-- Generated by agents-reverse-engineer -->

# src/discovery/filters

Composable file exclusion filters implementing gitignore parsing, vendor directory detection, binary file analysis, and custom glob patterns for the discovery phase file walker.

## Contents

### Filter Implementations

**[binary.ts](./binary.ts)** — `createBinaryFilter(options?: BinaryFilterOptions)` implements three-layer binary detection: extension-based fast path against `BINARY_EXTENSIONS` set (80+ extensions: images, archives, executables, media, documents, fonts, bytecode, databases), size threshold enforcement via `fs.stat()`, content analysis fallback via `isBinaryFile()` from `isbinaryfile` package.

**[custom.ts](./custom.ts)** — `createCustomFilter(patterns: string[], root: string)` wraps `ignore` library for gitignore-style pattern matching against user-defined exclusion globs from config (`config.exclude.patterns`). Converts absolute paths to relative via `path.relative()`, guards against external paths (starting with `..`).

**[gitignore.ts](./gitignore.ts)** — `createGitignoreFilter(root: string)` async factory reads `.gitignore` from project root, populates `Ignore` instance from `ignore` library, returns FileFilter with `shouldExclude()` method converting absolute paths to relative before pattern matching. Silent fallback to pass-through filter if `.gitignore` missing.

**[vendor.ts](./vendor.ts)** — `createVendorFilter(vendorDirs: string[])` implements dual-strategy exclusion: single-segment lookup in `Set<string>` for directories like `node_modules`/`dist`/`build` (O(1) per segment), multi-segment substring search for nested patterns like `apps/vendor`. Exports `DEFAULT_VENDOR_DIRS` constant (10 common directories: node_modules, vendor, .git, dist, build, __pycache__, .next, venv, .venv, target).

**[index.ts](./index.ts)** — Filter chain orchestrator re-exporting all filter creators, providing `applyFilters(files: string[], filters: FileFilter[], options?)` with concurrency-bounded execution (`CONCURRENCY=30` worker pool), short-circuit evaluation per file, trace emission via `filter:applied` events, result aggregation into `FilterResult` with `included` and `excluded` arrays containing `ExcludedFile` metadata (`{ path, reason, filter }`).

## Filter Chain Architecture

Filters implement `FileFilter` interface from `../types.ts` with `name: string` property and `shouldExclude(absolutePath: string): boolean | Promise<boolean>` method. Walker in `src/discovery/walker.ts` composes filters into exclusion chain with short-circuit logic: file rejected on first filter match.

Execution pattern: `applyFilters()` uses iterator-based worker pool matching `src/orchestration/pool.ts` architecture — single shared `files.entries()` iterator across N concurrent workers prevents over-allocation during binary content detection I/O. Each worker processes files through filter array sequentially, accumulates results with original index preservation, returns `{ index, file, excluded?: ExcludedFile }` tuples.

## Binary Detection Strategy

`createBinaryFilter()` three-phase algorithm optimizes I/O:
1. Extension check: `path.extname().toLowerCase()` against `binaryExtensions` Set (merged from `BINARY_EXTENSIONS` constant and `additionalExtensions` config with leading-dot normalization)
2. Size threshold: `fs.stat()` enforces `maxFileSize` limit (default 1MB via `DEFAULT_MAX_FILE_SIZE=1048576`)
3. Content analysis: `isBinaryFile(absolutePath)` for unknown extensions

Fast path (extension match) avoids filesystem I/O for 80+ common binary types. Slow path (content analysis) only triggered for unknown extensions. Error handling returns `true` for `fs.stat()` failures (fail-safe exclusion of unreadable files).

## Vendor Directory Matching

`createVendorFilter()` normalizes patterns via `/[\\/]/g → path.sep` replacement before split decision:
- Single segments (no `path.sep`): stored in `Set<string>` for O(1) lookup per path segment via `absolutePath.split(path.sep).some(s => singleSegments.has(s))`
- Multi-segment patterns (contains `path.sep`): substring search via `absolutePath.includes(normalizedPattern)`

Single-segment matches occur anywhere in path (`node_modules` matches `/project/node_modules/pkg/index.js` and `/apps/client/node_modules/lib.js`). Multi-segment requires ordered substring (`apps/vendor` matches `/root/apps/vendor/lib.js` but not `/root/vendor/apps/lib.js`).

## Gitignore Integration

`createGitignoreFilter()` delegates to `ignore` library requiring relative paths. Path conversion logic in `shouldExclude()`: `path.relative(normalizedRoot, absolutePath)` with guards for external paths (starting with `..`) and empty paths (absolutePath equals root), both returning `false` to bypass exclusion. No trailing slash normalization since walker returns files only.

## Custom Pattern Handling

`createCustomFilter()` validates paths via `path.relative()` before delegation to `ignore` library. External file protection: paths starting with `..` return `false` to prevent exclusion of out-of-tree references. Empty pattern array results in pass-through filter (`shouldExclude()` always returns `false`).

## Result Aggregation

`applyFilters()` constructs `FilterResult` via:
1. Worker results sorted by original index to preserve file order
2. Exclusions collected into `excluded: ExcludedFile[]` with `{ path, reason, filter }` metadata indicating rejection source
3. Inclusions aggregated into `included: string[]` containing files passing all filters
4. Per-filter statistics tracked in `Map<string, { matched, rejected }>` for trace emission

Trace events (`filter:applied`) emitted with `{ type, filterName, filesMatched, filesRejected }` payloads. Debug mode outputs rejection counts via `console.error()` when `stats.rejected > 0`.

## Dependencies

- `ignore` library: gitignore/glob pattern matching engine (gitignore.ts, custom.ts)
- `isbinaryfile` package: content-based binary file detection (binary.ts)
- `node:fs/promises`: async file reading for `.gitignore` (gitignore.ts)
- `node:path`: path normalization, resolution, relative conversion (all filters)
- `../types.ts`: FileFilter, FilterResult, ExcludedFile interfaces
- `../../orchestration/trace.ts`: ITraceWriter for filter execution telemetry