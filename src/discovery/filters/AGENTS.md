<!-- Generated by agents-reverse-engineer -->

# src/discovery/filters

Implements composable file exclusion filters for discovery phase, providing gitignore integration, binary file detection, vendor directory filtering, and custom pattern matching with concurrent evaluation and per-filter statistics.

## Contents

### Filter Implementations

- **[binary.ts](./binary.ts)** — `createBinaryFilter(options?: BinaryFilterOptions): FileFilter` excludes binary files via two-phase detection: fast-path extension check against `BINARY_EXTENSIONS` Set (90+ extensions including `.png`, `.pdf`, `.exe`, `.wasm`, `.db`), slow-path `isBinaryFile()` content analysis for unknown types, and size threshold (`DEFAULT_MAX_FILE_SIZE = 1048576` bytes).

- **[custom.ts](./custom.ts)** — `createCustomFilter(patterns: string[], root: string): FileFilter` matches user-provided gitignore-style patterns using `ignore` library, normalizes `absolutePath` to relative form via `path.relative(root, absolutePath)`, returns false for paths outside root or empty pattern lists.

- **[gitignore.ts](./gitignore.ts)** — `createGitignoreFilter(root: string): Promise<FileFilter>` async loads `.gitignore` from root, delegates matching to `ignore()` library with relative path conversion, silently allows all files if `.gitignore` missing.

- **[vendor.ts](./vendor.ts)** — `createVendorFilter(vendorDirs: string[]): FileFilter` partitions input into single-segment names (`'node_modules'`) checked against path components and multi-segment patterns (`'apps/vendor'`) matched via substring inclusion; `DEFAULT_VENDOR_DIRS` includes `'node_modules'`, `'vendor'`, `'.git'`, `'dist'`, `'build'`, `'__pycache__'`, `'.next'`, `'venv'`, `'.venv'`, `'target'`.

### Orchestration

- **[index.ts](./index.ts)** — `applyFilters(files: string[], filters: FileFilter[], options?: { tracer?: ITraceWriter; debug?: boolean }): Promise<FilterResult>` applies filter chain with short-circuit evaluation (stops at first exclusion), bounded concurrency (`CONCURRENCY = 30` workers sharing iterator over `files.entries()`), per-filter statistics (`Map<string, { matched: number; rejected: number }>`), and `filter:applied` trace events. Re-exports all filter creators and constants.

## Architecture

### Filter Chain Pattern

Each FileFilter exposes `name: string` and `shouldExclude(absolutePath: string): boolean | Promise<boolean>`. `applyFilters()` evaluates filters in sequence, recording first matching filter in `ExcludedFile.filter` field and terminating evaluation for that file (short-circuit).

### Concurrency Model

Worker pool spawns `Math.min(CONCURRENCY, files.length)` workers sharing single iterator over `files.entries()`. Each worker processes files sequentially through filter chain, returning `Array<{ index: number; file: string; excluded?: ExcludedFile }>`. Results sorted by index to preserve input order before partitioning into `included` and `excluded` arrays.

### Path Normalization Strategy

Filters receiving absolute paths convert to relative via `path.relative(normalizedRoot, absolutePath)` before pattern matching. Paths outside root (starting with `..`) or empty relative paths bypass pattern matching. Binary filter uses `path.extname()` extraction with `.toLowerCase()` for case-insensitive extension comparison.

## Behavioral Contracts

### Binary Detection Algorithm

1. Extract extension via `path.extname(absolutePath).toLowerCase()`
2. Check merged set of `BINARY_EXTENSIONS` and `options.additionalExtensions` (normalized with leading dot)
3. If extension unknown: `fs.stat(absolutePath)` size check against `maxFileSize`, then `isBinaryFile(absolutePath)` content analysis
4. Fail-closed on stat/read errors (return true)

### Custom Pattern Semantics

`ignore` library gitignore syntax: `!` prefix negates pattern, `/` suffix matches directories, `*` glob wildcard, `**` recursive wildcard. Relative path requirement enforced by `path.relative()` conversion before `ig.ignores(relativePath)` call.

### Vendor Directory Matching

Single-segment dirs (`'node_modules'`) match if present in `absolutePath.split(path.sep)`. Multi-segment patterns (`'.agents/skills'`) match via `absolutePath.includes(pattern)` after normalizing separators to `path.sep`.

### Short-Circuit Evaluation

`applyFilters()` stops checking filters after first `shouldExclude()` returns true, recording reason string `"Excluded by ${filter.name} filter"` in `ExcludedFile`. Subsequent filters skipped for that file. Order matters: earlier filters preempt later filters.

## Dependencies

- **isbinaryfile** (`isBinaryFile()`) — content-based binary detection in binary.ts slow path
- **ignore** (`ignore()`, `Ignore` type) — gitignore pattern parsing and matching in custom.ts and gitignore.ts
- **FileFilter**, **FilterResult**, **ExcludedFile** from `../types.js` — interface contracts
- **ITraceWriter** from `../../orchestration/trace.js` — optional tracing sink for statistics