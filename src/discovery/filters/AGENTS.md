<!-- Generated by agents-reverse-engineer -->

# src/discovery/filters

File exclusion pipeline for the discovery phase. Implements filter chain composition with short-circuit evaluation, exposing five filters: gitignore, vendor, binary, custom, and the orchestrating `applyFilters()` runner.

## Contents

**[binary.ts](./binary.ts)** — `createBinaryFilter()` excludes binary files via three-phase detection: extension fast-path against `BINARY_EXTENSIONS` (80+ formats), size threshold (`DEFAULT_MAX_FILE_SIZE = 1MB`), and `isBinaryFile()` content analysis. Accepts `BinaryFilterOptions` for `maxFileSize` and `additionalExtensions[]`.

**[custom.ts](./custom.ts)** — `createCustomFilter(patterns: string[], root: string)` wraps user-provided gitignore-style patterns using the `ignore` library. Returns `FileFilter` with `name: 'custom'`, converts absolute paths to relative via `path.relative()`, short-circuits for paths outside root or empty pattern lists.

**[gitignore.ts](./gitignore.ts)** — `createGitignoreFilter(root: string)` reads `.gitignore` from `path.join(root, '.gitignore')`, parses via `ignore().add(content)`, returns `FileFilter` with `name: 'gitignore'`. Missing `.gitignore` silently proceeds with pass-through behavior. Converts absolute to relative paths before calling `ig.ignores()`.

**[vendor.ts](./vendor.ts)** — `createVendorFilter(vendorDirs: string[])` excludes third-party directories using dual matching: single-segment names (e.g. `'node_modules'`) checked against path components, multi-segment patterns (e.g. `'apps/vendor'`) matched via substring inclusion. Exports `DEFAULT_VENDOR_DIRS = ['node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target']`.

**[index.ts](./index.ts)** — Orchestration module re-exporting all filter creators and implementing `applyFilters(files: string[], filters: FileFilter[], options?)`. Executes filter chain with short-circuit evaluation (first exclusion wins), bounded concurrency (`CONCURRENCY = 30`) via iterator-based pool to prevent file descriptor exhaustion from `isBinaryFile()` I/O. Returns `FilterResult` with `included[]` and `excluded[]` arrays preserving original ordering. Maintains `Map<string, { matched, rejected }>` statistics, emits `filter:applied` trace events via `options.tracer`, logs rejection counts when `options.debug` enabled.

## Filter Chain Architecture

Filters implement `FileFilter` interface from `../types.js` requiring `name: string` and `shouldExclude(absolutePath: string): Promise<boolean>`. `applyFilters()` evaluates each file against the filter array sequentially, stopping at first exclusion to populate `ExcludedFile` records with `path`, `reason`, and `filter` name. Included files are those passing all filters.

## Concurrency Model

Worker coroutines share an iterator over `files.entries()`, each pulling `[index, file]` pairs until exhausted. Up to `Math.min(CONCURRENCY, files.length)` workers run concurrently. Results preserve original index via `allResults.sort((a, b) => a.index - b.index)` to maintain deterministic output ordering.

## Path Normalization

Gitignore and custom filters convert absolute paths to relative via `path.relative(normalizedRoot, absolutePath)`, returning `false` (pass-through) for empty paths or those outside root (starting with `'..'`). Vendor filter uses `absolutePath.includes(pattern)` for path patterns and segment-level matching for single-segment directory names.

## Behavioral Contracts

### Binary Extensions
`BINARY_EXTENSIONS` from `binary.ts`:
```
.png, .jpg, .jpeg, .gif, .bmp, .ico, .webp, .svg, .heif, .heic
.zip, .tar, .gz, .bz2, .xz, .7z, .rar
.exe, .dll, .so, .dylib, .bin, .msi
.mp3, .mp4, .avi, .mov, .wav, .flac, .mkv, .webm
.pdf, .doc, .docx, .xls, .xlsx, .ppt, .pptx
.woff, .woff2, .ttf, .otf, .eot
.class, .pyc, .pyo, .o, .a, .wasm
.db, .sqlite, .sqlite3
```

### Default Vendor Directories
`DEFAULT_VENDOR_DIRS` from `vendor.ts`:
```
['node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target']
```

### Concurrency Limit
`CONCURRENCY = 30` from `index.ts` — bounds concurrent filter workers to prevent file descriptor exhaustion during `isBinaryFile()` I/O operations.

## Integration Points

Consumed by `src/discovery/run.ts` which assembles filter instances (gitignore, vendor, binary, custom) and invokes `applyFilters()` on discovered file list. Trace events emitted to `ITraceWriter` from `../../orchestration/trace.js`. Filter statistics logged using `pc.dim()` when `debug` option enabled.