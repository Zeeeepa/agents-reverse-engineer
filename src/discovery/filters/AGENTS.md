<!-- Generated by agents-reverse-engineer -->

# src/discovery/filters

**Filter chain orchestration for file discovery exclusion rules.** Implements composable `FileFilter` instances that exclude binary files, third-party dependencies, gitignored paths, and custom patterns during the file discovery phase, with bounded concurrency and short-circuit evaluation to prevent resource exhaustion when processing large codebases.

## Contents

### Core Orchestration

**[index.ts](./index.ts)** — `applyFilters(files, filters, options)` implements iterator-based concurrency with `CONCURRENCY = 30` to evaluate filter chains across file arrays, short-circuiting on first exclusion and assembling `FilterResult { included, excluded, stats }` with per-filter rejection counts. Re-exports all filter creators and constants.

### Filter Implementations

**[binary.ts](./binary.ts)** — `createBinaryFilter(options?)` returns FileFilter with two-phase detection: fast-path extension lookup in `BINARY_EXTENSIONS` (80+ extensions: `.png`, `.zip`, `.exe`, `.mp4`, `.pdf`, `.class`, etc.), then fallback content analysis via `isBinaryFile()` for unknown extensions. Excludes oversized files exceeding `maxFileSize` (default 1MB).

**[vendor.ts](./vendor.ts)** — `createVendorFilter(vendorDirs)` excludes third-party dependency directories via partitioned matching: single-segment names (e.g., `'node_modules'`) use Set lookup, multi-segment patterns (e.g., `'apps/vendor'`) use substring matching. `DEFAULT_VENDOR_DIRS` includes `['node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target']`.

**[gitignore.ts](./gitignore.ts)** — `createGitignoreFilter(root)` loads `.gitignore` patterns via `ignore` library, converts absolute paths to relative via `path.relative(root, absolutePath)`, delegates exclusion to `ig.ignores(relativePath)`. Returns no-op filter if `.gitignore` missing.

**[custom.ts](./custom.ts)** — `createCustomFilter(patterns, root)` compiles gitignore-style patterns via `ignore` library, evaluates paths relative to `root`. Short-circuits when `patterns.length === 0`.

## FileFilter Interface

All filter creators return `{ name: string; shouldExclude(absolutePath: string): boolean | Promise<boolean> }` from `../types.js`, enabling composition in `applyFilters` orchestrator.

## Concurrency and Short-Circuit Evaluation

`applyFilters` spawns `Math.min(30, files.length)` workers sharing a single `files.entries()` iterator. Each worker evaluates filters sequentially for each file, breaking on first `shouldExclude = true`. Results sorted by `index` to preserve file order. Workers prevent file descriptor exhaustion when `createBinaryFilter` performs I/O via `isBinaryFile()`.

## Result Assembly

`FilterResult.excluded` entries contain `{ path, reason: "Excluded by ${filter.name} filter", filter: filter.name }`. `FilterResult.stats` Map tracks `{ matched, rejected }` counts per filter name. Included files increment `stats.matched` for all filters; excluded files increment `stats.rejected` for excluding filter only.

## Tracing and Debug Output

When `options.tracer` provided, emits `{ type: 'filter:applied', filterName, filesMatched, filesRejected }` after `applyFilters` completes. Debug mode (`options.debug = true`) prints `pc.dim("[debug] Filter [${name}]: ${rejected} files rejected")` for filters with `rejected > 0`.

## Path Normalization

`createGitignoreFilter` and `createCustomFilter` use `path.resolve(root)` for normalization. `shouldExclude` methods reject paths outside root (detected via `path.relative()` starting with `..`) by returning `false`. `createVendorFilter` normalizes path separators in multi-segment patterns via `dir.replace(/[\\/]/g, path.sep)`.

## Behavioral Contracts

### Extension Detection (binary.ts)
```typescript
BINARY_EXTENSIONS: Set<string> // 80+ entries: .png, .jpg, .gif, .bmp, .ico, .webp, .zip, .tar, .gz, .rar, .7z, .exe, .dll, .so, .dylib, .mp3, .mp4, .avi, .mkv, .pdf, .doc, .docx, .woff, .woff2, .ttf, .otf, .class, .jar, .pyc, .o, .a, .db, .sqlite, etc.
```

### Vendor Directories (vendor.ts)
```typescript
DEFAULT_VENDOR_DIRS = ['node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target']
```

### Concurrency Limit (index.ts)
```typescript
const CONCURRENCY = 30 // prevents file descriptor exhaustion during binary content analysis
```

### Size Threshold (binary.ts)
```typescript
const DEFAULT_MAX_FILE_SIZE = 1024 * 1024 // 1MB, excludes oversized files before content analysis
```