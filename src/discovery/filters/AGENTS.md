<!-- Generated by agents-reverse-engineer -->

# src/discovery/filters

File exclusion pipeline implementing four specialized filters (gitignore, vendor, binary, custom) with concurrent filter chain execution, short-circuit evaluation, and per-filter statistics tracking.

## Contents

**[binary.ts](./binary.ts)** — `createBinaryFilter(options?: BinaryFilterOptions): FileFilter` excludes binary files via two-phase detection: fast-path extension matching against `BINARY_EXTENSIONS` (90+ extensions: `.png`, `.jpg`, `.pdf`, `.exe`, `.zip`, `.mp3`, etc.) and slow-path content analysis via `isBinaryFile()` for unknown extensions. Enforces `maxFileSize` threshold (default: 1MB).

**[custom.ts](./custom.ts)** — `createCustomFilter(patterns: string[], root: string): FileFilter` applies user-defined gitignore-style exclusion patterns via `ignore` library. Normalizes paths to relative form, skips matching for paths outside root boundary.

**[gitignore.ts](./gitignore.ts)** — `createGitignoreFilter(root: string): Promise<FileFilter>` async factory loads `.gitignore` from root, parses with `ignore()` library, excludes files matching repository ignore rules. Silent fallback if `.gitignore` missing.

**[index.ts](./index.ts)** — `applyFilters(files: string[], filters: FileFilter[], options?: { tracer?: ITraceWriter; debug?: boolean }): Promise<FilterResult>` orchestrates concurrent filter chain execution with `CONCURRENCY = 30` worker pool. Short-circuits on first exclusion, preserves file order via index-based sorting, emits `filter:applied` trace events with per-filter match/reject counts. Re-exports all filter creators and constants.

**[vendor.ts](./vendor.ts)** — `createVendorFilter(vendorDirs: string[]): FileFilter` excludes third-party dependency directories and build outputs. `DEFAULT_VENDOR_DIRS` contains `'node_modules'`, `'vendor'`, `'.git'`, `'dist'`, `'build'`, `'__pycache__'`, `'.next'`, `'venv'`, `'.venv'`, `'target'`. Partitions patterns into single-segment directory names (Set-based lookup) and multi-segment path patterns (substring match).

## Architecture

### Filter Chain Execution

`applyFilters()` spawns `Math.min(30, files.length)` workers sharing single `files.entries()` iterator. Each worker processes file through filter array sequentially until `filter.shouldExclude(file)` returns `true` (short-circuit) or all filters pass. Workers return `Array<{ index: number; file: string; excluded?: ExcludedFile }>`, preserving original order via index-based sorting after `Promise.all(workers)`.

### Binary Detection Strategy

`createBinaryFilter()` implements two-phase detection: (1) fast path extracts extension via `path.extname(absolutePath).toLowerCase()`, checks against merged set of `BINARY_EXTENSIONS` + `additionalExtensions`, (2) slow path invokes `fs.stat()` for size check against `maxFileSize`, calls `isBinaryFile(absolutePath)` for content-based analysis of unknown extensions. Fail-closed on stat/read errors.

### Path Normalization

All filters normalize root with `path.resolve()`, convert absolutePath to relative via `path.relative(normalizedRoot, absolutePath)`. Paths outside root (starting with `..`) or empty relative paths return `false` from `shouldExclude()`. Custom and gitignore filters require relative paths for `ignore` library pattern matching.

### Vendor Pattern Matching

`createVendorFilter()` partitions `vendorDirs` into single-segment names (e.g., `'node_modules'`) stored in `Set<string>` for O(1) lookup against `absolutePath.split(path.sep)` components, and multi-segment patterns (e.g., `'apps/vendor'`) stored in string array for substring matching via `absolutePath.includes(pattern)` after `path.sep` normalization.

## Behavioral Contracts

### Concurrency Bound
```javascript
const CONCURRENCY = 30  // Limits file descriptor exhaustion during isBinaryFile() calls
const workers = Math.min(CONCURRENCY, files.length)
```

### Short-Circuit Evaluation
Filter chain stops at first `shouldExclude() === true`, recording `filter.name` in `ExcludedFile.filter` field and reason string `"Excluded by ${filter.name} filter"`.

### Binary Extension Set
`BINARY_EXTENSIONS` contains 90+ lowercase extensions with leading dots: images (`.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.ico`, `.webp`, `.svg`, `.tiff`, `.tif`, `.psd`, `.raw`, `.heif`, `.heic`), archives (`.zip`, `.tar`, `.gz`, `.rar`, `.7z`, `.bz2`, `.xz`, `.tgz`), executables (`.exe`, `.dll`, `.so`, `.dylib`, `.bin`, `.msi`, `.app`, `.dmg`), media (`.mp3`, `.mp4`, `.wav`, `.avi`, `.mov`, `.mkv`, `.flac`, `.ogg`, `.webm`, `.m4a`, `.aac`, `.wma`, `.wmv`, `.flv`), documents (`.pdf`, `.doc`, `.docx`, `.xls`, `.xlsx`, `.ppt`, `.pptx`, `.odt`, `.ods`, `.odp`), fonts (`.woff`, `.woff2`, `.ttf`, `.eot`, `.otf`), compiled (`.class`, `.pyc`, `.pyo`, `.o`, `.obj`, `.a`, `.lib`, `.wasm`), database (`.db`, `.sqlite`, `.sqlite3`, `.mdb`).

### Default Vendor Directories
```javascript
DEFAULT_VENDOR_DIRS = ['node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target']
```

### Gitignore Library Integration
`ignore()` factory from `ignore` library requires relative paths, not absolute. Trailing slash affects directory matching behavior; filters pass paths as-is without appending `/` because walker returns files only.

### Filter Statistics Schema
```typescript
Map<string, { matched: number; rejected: number }>
// Updated per-filter during applyFilters() execution, emitted via filter:applied trace events
```