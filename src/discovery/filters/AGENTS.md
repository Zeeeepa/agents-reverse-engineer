<!-- Generated by agents-reverse-engineer v0.8.2 -->

# src/discovery/filters

Four-filter exclusion pipeline implementing gitignore pattern matching, vendor directory detection, binary file content analysis, and custom user patterns with short-circuit evaluation and bounded concurrency.

## Contents

**[binary.ts](./binary.ts)** — `createBinaryFilter(options?)` returns `FileFilter` with two-phase detection: phase 1 checks `BINARY_EXTENSIONS` Set (90+ extensions: `.png`, `.exe`, `.pdf`, `.wasm`, etc.) via `path.extname()`, phase 2 runs `isbinaryfile()` content analysis for unknown extensions, enforces `maxFileSize` (default 1MB). Normalizes `additionalExtensions` with leading dots.

**[custom.ts](./custom.ts)** — `createCustomFilter(patterns, root)` wraps `ignore` library for user-defined exclusion patterns from `.agents-reverse-engineer/config.yaml`. Converts absolute paths to relative via `path.relative()`, delegates to `ig.ignores()`, skips paths outside root (starting with `..`).

**[gitignore.ts](./gitignore.ts)** — `createGitignoreFilter(root)` async factory reads `.gitignore`, parses via `ignore()`, returns filter converting absolute to relative paths for `ig.ignores()` matching. Missing `.gitignore` creates pass-through filter (empty patterns).

**[index.ts](./index.ts)** — `applyFilters(files, filters, options?)` orchestrates chain execution with `CONCURRENCY=30` worker pool, short-circuits on first exclusion per file, preserves input order via index sorting, tracks per-filter `matched`/`rejected` stats in `Map<string, {matched, rejected}>`, emits `filter:applied` trace events. Re-exports all filter factories and constants.

**[vendor.ts](./vendor.ts)** — `createVendorFilter(vendorDirs)` partitions input into single-segment Set (`node_modules`, `dist`, `__pycache__`, etc.) and multi-segment patterns (`.agents/skills`), normalizes separators via `.replace(/[\\/]/g, path.sep)`, checks path segments for Set membership then full path for pattern substring matches.

## Architecture

### Four-Filter Chain

Applied by `src/discovery/walker.ts` in sequence: **gitignore** → **vendor** → **binary** → **custom**. Each implements `FileFilter` interface (`name: string`, `shouldExclude(absolutePath: string): boolean | Promise<boolean>`). Short-circuit stops evaluation on first exclusion.

### Concurrency Control

`applyFilters()` uses iterator-based worker pool with `CONCURRENCY=30` to bound parallel I/O during binary content analysis (`fs.stat()` + `isbinaryfile()` per unknown extension). Spawns `Math.min(30, files.length)` workers sharing `files.entries()` iterator. Prevents file descriptor exhaustion on large repos.

### Filter Result

Returns `FilterResult` with `included: string[]` (passed all filters) and `excluded: ExcludedFile[]` (rejected, tracking `{ file, reason, filterName }`). Order preserved via index sorting after concurrent processing.

## Behavioral Contracts

### Binary Extension Set
```javascript
BINARY_EXTENSIONS = new Set([
  // Images
  '.png', '.jpg', '.jpeg', '.gif', '.webp', '.svg', '.ico', '.bmp', '.tiff',
  // Archives
  '.zip', '.tar', '.gz', '.7z', '.rar', '.tgz', '.bz2',
  // Executables
  '.exe', '.dll', '.so', '.dylib', '.bin',
  // Media
  '.mp3', '.mp4', '.wav', '.avi', '.mov', '.flac',
  // Documents
  '.pdf', '.docx', '.xlsx', '.pptx',
  // Fonts
  '.woff', '.woff2', '.ttf', '.eot', '.otf',
  // Compiled
  '.class', '.pyc', '.o', '.a', '.wasm',
  // Database
  '.db', '.sqlite', '.sqlite3'
  // ... 90+ total
])
```

### Two-Phase Detection
```javascript
// Phase 1: Extension lookup (fast path)
const ext = path.extname(absolutePath).toLowerCase()
if (allExtensions.has(ext)) return true

// Phase 2: Content analysis (fallback for unknown extensions)
const stats = await fs.stat(absolutePath)
if (stats.size > maxFileSize) return true
return await isbinaryfile(absolutePath)
```

### Default Vendor Directories
```javascript
DEFAULT_VENDOR_DIRS = [
  'node_modules', 'vendor', '.git', 'dist', 'build',
  '__pycache__', '.next', 'venv', '.venv', 'target'
]
```

### Vendor Partitioning
```javascript
// Single-segment: Set lookup O(1)
vendorSet = new Set(['node_modules', 'dist', 'build'])
pathSegments.some(segment => vendorSet.has(segment))

// Multi-segment: substring match O(n)
vendorPatterns = ['.agents/skills'].map(p => p.replace(/[\\/]/g, path.sep))
vendorPatterns.some(pattern => absolutePath.includes(pattern))
```

### Gitignore Path Conversion
```javascript
const relativePath = path.relative(normalizedRoot, absolutePath)
if (relativePath === '' || relativePath.startsWith('..')) return false
return ig.ignores(relativePath)  // Requires relative paths
```

### Filter Stats Tracking
```javascript
// Per-filter Map: { matched: files_passed, rejected: files_excluded }
filterStats.get(filterName).rejected++  // When filter excludes
allFilters.forEach(f => filterStats.get(f.name).matched++)  // When file passes chain
```

### Short-Circuit Evaluation
```javascript
for (const filter of filters) {
  if (await filter.shouldExclude(file)) {
    return { excluded: { file, reason: filter.name, filterName: filter.name } }
  }
}
return { included: file }
```

### Default Binary Size Limit
```javascript
DEFAULT_MAX_FILE_SIZE = 1048576  // 1MB in bytes
```

## Integration

Consumed by `src/discovery/walker.ts` `DiscoveryWalker.run()`: builds filter array via factory functions (`createGitignoreFilter(root)`, `createVendorFilter(config.exclude.vendorDirs || DEFAULT_VENDOR_DIRS)`, `createBinaryFilter()`, `createCustomFilter(config.exclude.patterns, root)`), passes to `applyFilters(globResults, filters, { tracer, debug, logger })`, partitions into `FilterResult.included` for phase-1 task creation.