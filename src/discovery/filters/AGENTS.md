<!-- Generated by agents-reverse-engineer -->

# src/discovery/filters

File exclusion pipeline implementing four-stage chain (gitignore → vendor → binary → custom) with short-circuit evaluation and bounded concurrency.

## Contents

**[binary.ts](./binary.ts)** — Exports `createBinaryFilter(options?: BinaryFilterOptions)` with two-phase detection: extension lookup against `BINARY_EXTENSIONS` (90+ patterns: `.png`, `.exe`, `.mp3`, `.pdf`, `.woff`, `.class`, `.db`) then fallback `isbinaryfile()` content analysis, enforcing `maxFileSize` (default 1MB) via `fs.stat()`.

**[custom.ts](./custom.ts)** — Exports `createCustomFilter(patterns: string[], root: string)` wrapping `ignore` library for user-defined exclusion patterns from `config.exclude.patterns`, converting absolute paths to relative via `path.relative()`, returning `false` for empty pattern arrays or paths outside root.

**[gitignore.ts](./gitignore.ts)** — Exports async `createGitignoreFilter(root: string)` reading `.gitignore` via `fs.promises.readFile()`, parsing with `ignore()`, excluding paths matching patterns or residing outside root (detected via `..` prefix in `path.relative()` result).

**[index.ts](./index.ts)** — Exports `applyFilters(files: string[], filters: FileFilter[], options?)` orchestrating worker pool with `CONCURRENCY = 30`, short-circuiting on first exclusion per file, preserving input order via index sorting, returning `FilterResult` with `included`/`excluded` arrays and per-filter `filesMatched`/`filesRejected` stats emitted via `tracer.emit('filter:applied')`.

**[vendor.ts](./vendor.ts)** — Exports `createVendorFilter(vendorDirs: string[])` and `DEFAULT_VENDOR_DIRS` (10 patterns: `node_modules`, `.git`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `vendor`), partitioning inputs into single-segment `Set` checks and multi-segment `includes()` pattern matching via normalized `path.sep`.

## Architecture

### Filter Chain

`src/discovery/walker.ts` applies filters sequentially: `.gitignore` patterns → vendor directories → binary detection → custom patterns. Each `FileFilter` implements `shouldExclude(absolutePath: string): boolean | Promise<boolean>`, with chain halting on first `true` return.

### Binary Detection Strategy

`createBinaryFilter()` phase 1 extracts extension via `path.extname()`, queries `BINARY_EXTENSIONS` Set (O(1) lookup), returns `true` on match. Phase 2 (unknown extensions) invokes `fs.stat()` for size check (excludes >1MB), then `isbinaryfile()` for content analysis. Catches `stat()` errors silently, defaulting to exclusion for unreadable paths.

### Concurrency Control

`applyFilters()` spawns `Math.min(30, files.length)` workers sharing `files.entries()` iterator. Each worker pulls `[index, file]` pairs, runs filter chain, records `{ index, file, excluded?: ExcludedFile }`. Final results sorted by `index` to restore input order despite parallel execution.

### Vendor Partitioning

`createVendorFilter()` splits `vendorDirs` into single-segment Set (e.g., `node_modules`) for component-wise lookup via `absolutePath.split(path.sep).some(segment => singleSegments.has(segment))`, and multi-segment patterns (e.g., `.agents/skills`) normalized with OS-specific separators for `includes()` substring matching.

## Filter Stats Tracking

Maintains `Map<string, { matched: number; rejected: number }>` during `applyFilters()` execution. Increments filter's `rejected` count when `shouldExclude()` returns `true`. Increments all filters' `matched` counts when file passes entire chain. Emits aggregated counts via `tracer.emit({ type: 'filter:applied', filterName, filesMatched, filesRejected })` post-processing.

## Behavioral Contracts

### Gitignore Relative Path Requirement
`ig.ignores()` requires relative paths. Absolute paths converted via `path.relative(root, absolutePath)`, returning `false` (include) if result starts with `..` (outside root).

### Binary Extension Normalization
```javascript
ext.startsWith('.') ? ext : `.${ext}`
```
Ensures both `.foo` and `foo` resolve to `.foo` for Set membership.

### Worker Pool Concurrency Bound
```javascript
Math.min(30, files.length)
```
Prevents file descriptor exhaustion during binary detection I/O operations.

### Filter Short-Circuit Pattern
```javascript
for (const filter of filters) {
  if (await filter.shouldExclude(file)) {
    return { excluded: { file, reason: filter.name } };
  }
}
```
Chain halts on first exclusion, skipping subsequent filters.

### Vendor Path Separator Normalization
```javascript
pattern.replace(/[\\/]/g, path.sep)
```
Converts `.agents/skills` to `.agents\skills` (Windows) or preserves `/` (Unix) for cross-platform substring matching.