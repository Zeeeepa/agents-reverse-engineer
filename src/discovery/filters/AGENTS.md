<!-- Generated by agents-reverse-engineer -->

# src/discovery/filters

File exclusion filters for documentation discovery phase, implementing gitignore semantics, binary detection, vendor directory exclusion, and custom pattern matching through a unified FileFilter interface.

## Contents

### Filter Implementations

- **[binary.ts](./binary.ts)** — Extension-based and content-based binary detection using `BINARY_EXTENSIONS` Set (80+ extensions) and `isBinaryFile()` with configurable `maxFileSize` threshold (default 1MB), implements two-phase fast-path/slow-path strategy
- **[gitignore.ts](./gitignore.ts)** — Async gitignore parser using `ignore` library, loads `.gitignore` from root via `fs.readFile()`, converts absolute paths to relative via `path.relative()` before matching, silently passes all files if `.gitignore` missing
- **[vendor.ts](./vendor.ts)** — Third-party directory exclusion supporting single-segment names (O(1) Set lookup per path segment) and multi-segment patterns (string inclusion), exports `DEFAULT_VENDOR_DIRS` containing node_modules, .git, dist, build, __pycache__, .next, venv, target
- **[custom.ts](./custom.ts)** — User-provided pattern matcher wrapping `ignore` library for gitignore-style patterns, normalizes paths via `path.relative()`, returns no-op filter when `patterns.length === 0`
- **[index.ts](./index.ts)** — Filter orchestration with `applyFilters(files, filters, options)` implementing bounded concurrency (CONCURRENCY=30), short-circuit exclusion logic, deterministic ordering preservation, per-filter statistics tracking (`filterStats: Map<string, { matched, rejected }>`), and `filter:applied` trace events

## Architecture

### FileFilter Interface

All filters implement `FileFilter` from `../types.js`:
- `name: string` — Filter identifier for logging and diagnostics
- `shouldExclude(absolutePath: string): Promise<boolean> | boolean` — Predicate returning true to exclude file from discovery

### Filter Chain Execution

applyFilters processes files concurrently via shared iterator pattern:
1. Spawns `Math.min(CONCURRENCY, files.length)` workers
2. Each worker iterates `files.entries()` applying filters sequentially
3. First filter returning `shouldExclude=true` short-circuits remaining filters
4. Results collected in `included: string[]` and `excluded: ExcludedFile[]` (annotated with `filter` name and `reason`)
5. Output sorted by original `index` to preserve deterministic ordering despite parallel execution

### Path Normalization Strategy

Filters requiring relative paths (gitignore.ts, custom.ts) use `path.relative(normalizedRoot, absolutePath)` and reject paths outside root (starting with `..` or empty strings). Vendor filter normalizes separators via `.replace(/[\\/]/g, path.sep)` for cross-platform compatibility.

## Binary Detection Strategy

binary.ts implements two-phase detection:
1. **Fast path**: `path.extname().toLowerCase()` check against combined `binaryExtensions` Set (BINARY_EXTENSIONS + additionalExtensions with `.` prefix normalization)
2. **Slow path**: Unknown extensions trigger `fs.stat()` size check followed by `isBinaryFile()` content analysis
3. **Error handling**: `shouldExclude` returns `true` (exclude) on stat/read errors to prevent downstream processing failures

## Concurrency and I/O Management

applyFilters limits concurrent file processing to CONCURRENCY=30 to prevent file descriptor exhaustion during binary content detection. Each worker calls async `filter.shouldExclude()` operations sequentially per file but processes multiple files in parallel across workers.

## Trace Integration

When `options.tracer` provided, index.ts emits `filter:applied` events with `filterName`, `matched`, `rejected` counts after all workers complete. Trace events enable visualization of filter effectiveness and bottleneck identification.

## Debug Output

When `options.debug=true`, logs `[debug] Filter [${filter.name}]: ${stats.rejected} files rejected` via picocolors dim styling for filters with `rejected > 0`, providing CLI visibility into filter behavior without trace file analysis.