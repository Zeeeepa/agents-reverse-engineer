<!-- Generated by agents-reverse-engineer -->

# src/discovery/filters

Composable file exclusion filters for discovery pipeline: gitignore pattern matching, binary file detection, vendor directory exclusion, and custom glob rules with short-circuit evaluation and bounded-concurrency application.

## Contents

### Filter Orchestration

**[index.ts](./index.ts)** — `applyFilters(files, filters, options)` executes filter chain with short-circuit evaluation (stops at first exclusion) using 30-worker bounded concurrency pool to prevent file descriptor exhaustion during `isBinaryFile()` I/O operations. Returns `FilterResult` with `included[]` and `excluded[]` arrays, emits `filter:applied` trace events with per-filter `filesMatched`/`filesRejected` counts. Re-exports all filter factory functions.

### Filter Implementations

**[gitignore.ts](./gitignore.ts)** — `createGitignoreFilter(root)` async factory reads `.gitignore`, parses via `ignore` library, returns `FileFilter` that converts absolute paths to relative before calling `ig.ignores()`. Returns `false` for paths outside root tree (relative path starts with `..`).

**[binary.ts](./binary.ts)** — `createBinaryFilter(options?)` constructs fast-path extension lookup in `BINARY_EXTENSIONS` set (96 extensions: `.png`, `.exe`, `.mp4`, `.pdf`, `.woff`, `.class`, `.db`, etc.) with fallback to `isBinaryFile()` content analysis. Excludes files exceeding `maxFileSize` (default 1MB via `DEFAULT_MAX_FILE_SIZE`). Returns `true` on `fs.stat()` errors.

**[vendor.ts](./vendor.ts)** — `createVendorFilter(vendorDirs)` partitions input into single-segment Set (e.g., `node_modules`) for O(1) membership testing and path-pattern array (e.g., `.agents/skills`) for substring matching. `DEFAULT_VENDOR_DIRS` contains `node_modules`, `vendor`, `.git`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`.

**[custom.ts](./custom.ts)** — `createCustomFilter(patterns, root)` parses gitignore-style glob patterns via `ignore` library, converts absolute paths to relative before evaluation. Returns `false` immediately for empty patterns array or paths outside root.

## Concurrency Strategy

`applyFilters()` uses iterator-based worker pool with `CONCURRENCY = 30` to share single `files.entries()` iterator across workers. Each file runs through `filters[]` sequentially until `shouldExclude()` returns `true` (short-circuit). BinaryFilter calls synchronous `isBinaryFile()`, making concurrency bounds critical to avoid ulimit violations.

## Filter Contract

All factories return `FileFilter` interface from `../types.js`:
- `name: string` — filter identifier for logging
- `shouldExclude(absolutePath: string): boolean` — exclusion predicate

## Behavioral Contracts

### Binary Extension Set
`BINARY_EXTENSIONS` (96 entries): `.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.ico`, `.webp`, `.svg`, `.tiff`, `.tif`, `.psd`, `.raw`, `.heif`, `.heic`, `.zip`, `.tar`, `.gz`, `.rar`, `.7z`, `.bz2`, `.xz`, `.tgz`, `.exe`, `.dll`, `.so`, `.dylib`, `.bin`, `.msi`, `.app`, `.dmg`, `.mp3`, `.mp4`, `.wav`, `.avi`, `.mov`, `.mkv`, `.flac`, `.ogg`, `.webm`, `.m4a`, `.aac`, `.wma`, `.wmv`, `.flv`, `.pdf`, `.doc`, `.docx`, `.xls`, `.xlsx`, `.ppt`, `.pptx`, `.odt`, `.ods`, `.odp`, `.woff`, `.woff2`, `.ttf`, `.eot`, `.otf`, `.class`, `.pyc`, `.pyo`, `.o`, `.obj`, `.a`, `.lib`, `.wasm`, `.db`, `.sqlite`, `.sqlite3`, `.mdb`, `.icns`, `.cur`, `.deb`, `.rpm`, `.jar`, `.war`, `.ear`

### Default Vendor Directories
`DEFAULT_VENDOR_DIRS` (10 entries): `node_modules`, `vendor`, `.git`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`

### Path Normalization
- Gitignore filter: `path.relative(normalizedRoot, absolutePath)` before `ig.ignores()`
- Vendor filter: `dir.replace(/[\\/]/g, path.sep)` for cross-platform separator handling
- Binary filter: `path.extname(absolutePath).toLowerCase()` for extension extraction

### Trace Event Schema
```typescript
{
  type: 'filter:applied',
  filterName: string,
  filesMatched: number,
  filesRejected: number
}
```