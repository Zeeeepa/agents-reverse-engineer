<!-- Generated by agents-reverse-engineer -->

# src/discovery/filters

Composable file exclusion filters implementing gitignore semantics, binary detection, vendor directory skipping, and custom glob patterns for the file discovery pipeline.

## Contents

### Filter Implementations

**[binary.ts](./binary.ts)** — Three-phase binary file detector: extension fast-path lookup in 82-member `BINARY_EXTENSIONS` set (images/archives/executables/media/fonts/bytecode/databases), size threshold comparison via `fs.stat()` (default 1MB), content analysis fallback via `isbinaryfile.isBinaryFile()`.

**[custom.ts](./custom.ts)** — User-defined gitignore-style pattern matcher via `ignore` library, converts absolute paths to relative via `path.relative()`, bypasses filtering for paths outside root (relative path starts with `..`).

**[gitignore.ts](./gitignore.ts)** — `.gitignore` parser consuming `ignore` library, silently passes all paths when `.gitignore` missing, converts absolute paths to relative for pattern matching.

**[vendor.ts](./vendor.ts)** — Vendor directory excluder with dual matching: single-segment Set lookup (`node_modules`, `.git`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`) and path-pattern substring search for multi-segment patterns (`.agents/skills`, `apps/vendor`).

**[index.ts](./index.ts)** — Filter chain orchestrator with `applyFilters()` executing short-circuit evaluation (stops at first exclusion) across 30 concurrent workers sharing iterator, collects per-filter statistics (`matched`/`rejected` counts), emits `filter:applied` trace events, re-exports all filter creators.

## Architecture

### Filter Chain Execution

`applyFilters()` bounds concurrency to 30 workers via `Math.min(CONCURRENCY, files.length)` to prevent file descriptor exhaustion during binary detection I/O. Each worker drains shared `files.entries()` iterator, processes files serially through filter array with short-circuit semantics (breaks on first `shouldExclude()` true return). Results sorted by original index to preserve input order despite concurrent execution.

### Path Normalization Contract

All filters receive absolute paths, convert to relative via `path.relative(normalizedRoot, absolutePath)` for pattern matching libraries (`ignore` requires relative paths without leading slash). Paths outside root (starting with `..`) bypass filtering by returning `false`. Empty relative paths also bypass exclusion.

### Binary Detection Strategy

`createBinaryFilter()` prioritizes performance via three-tiered approach:
1. Extension lookup in pre-allocated Set (O(1), no I/O)
2. Size threshold check via `fs.stat()` (single syscall)
3. Content analysis via `isbinaryfile` heuristics (reads file header bytes)

Returns `true` on `fs.stat()` failure (file unreadable/missing) to fail-safe exclude corrupt/inaccessible files.

### Vendor Path Pattern Classification

`createVendorFilter()` splits patterns into `singleSegments` Set and `pathPatterns` array based on presence of path separator after normalization (`dir.replace(/[\\/]/g, path.sep)`). Single segments use Set membership check, path patterns use substring search. Normalization ensures cross-platform compatibility (Windows backslashes converted to `path.sep`).

## Filter Statistics

`applyFilters()` aggregates statistics in `Map<string, { matched: number; rejected: number }>`:
- `rejected` increments when filter excludes file
- `matched` increments for all filters when file passes entire chain (not per individual filter pass)

Statistics emitted as `filter:applied` trace events with `filterName`, `filesMatched`, `filesRejected` fields for downstream effectiveness analysis.

## Behavioral Contracts

### Binary Extension Set (82 entries)
Images: `.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.ico`, `.webp`, `.svg`, `.tiff`, `.tif`, `.psd`, `.raw`, `.heif`, `.heic`
Archives: `.zip`, `.tar`, `.gz`, `.rar`, `.7z`, `.bz2`, `.xz`, `.tgz`
Executables: `.exe`, `.dll`, `.so`, `.dylib`, `.bin`, `.msi`, `.app`, `.dmg`
Media: `.mp3`, `.mp4`, `.wav`, `.avi`, `.mov`, `.mkv`, `.flac`, `.ogg`, `.webm`, `.m4a`, `.aac`, `.wma`, `.wmv`, `.flv`
Documents: `.pdf`, `.doc`, `.docx`, `.xls`, `.xlsx`, `.ppt`, `.pptx`, `.odt`, `.ods`, `.odp`
Fonts: `.woff`, `.woff2`, `.ttf`, `.eot`, `.otf`
Bytecode: `.class`, `.pyc`, `.pyo`, `.o`, `.obj`, `.a`, `.lib`, `.wasm`
Databases: `.db`, `.sqlite`, `.sqlite3`, `.mdb`
Misc: `.ico`, `.icns`, `.cur`, `.deb`, `.rpm`, `.jar`, `.war`, `.ear`

### Default Vendor Directories (10 entries)
`node_modules`, `vendor`, `.git`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`

### Default Max File Size
`1024 * 1024` (1MB)

### Filter Chain Concurrency
30 workers (constant `CONCURRENCY` in `index.ts`)

## Integration Points

Consumed by `src/discovery/walker.ts` as composable filter chain during Phase 1 file analysis. Configured via `config.exclude` fields in `.agents-reverse-engineer/config.yaml`:
- `patterns` → `createCustomFilter()`
- `vendorDirs` → `createVendorFilter()`
- `binaryExtensions` → `createBinaryFilter()` (merged with `BINARY_EXTENSIONS`)
- `.maxFileSize` → `createBinaryFilter()`

Implements `FileFilter` interface from `../types.js` with `name: string` and `shouldExclude(absolutePath: string): Promise<boolean>` signature.