<!-- Generated by agents-reverse-engineer -->

# src/discovery/filters

File exclusion predicates implementing gitignore parsing, binary detection, vendor directory matching, and custom glob patterns via composable FileFilter interface with short-circuit evaluation and statistics tracking.

## Contents

### Filter Implementations

**[binary.ts](./binary.ts)** — createBinaryFilter() with two-phase detection: extension-based fast path (BINARY_EXTENSIONS Set of 91 types), content analysis fallback via `isbinaryfile`, configurable maxFileSize threshold (default 1MB).

**[custom.ts](./custom.ts)** — createCustomFilter() wraps `ignore` library for gitignore-syntax pattern matching against user-defined exclusion patterns from config.exclude.patterns.

**[gitignore.ts](./gitignore.ts)** — createGitignoreFilter() loads root .gitignore via fs.promises.readFile(), converts absolute paths to relative for `ig.ignores()` predicate, silently passes all files when .gitignore missing.

**[vendor.ts](./vendor.ts)** — createVendorFilter() matches third-party directories via dual strategy: singleSegments Set for name-only matching (e.g., `node_modules`), pathPatterns array for multi-segment substring search (e.g., `.agents/skills`). Exports DEFAULT_VENDOR_DIRS with 10 common directory names.

**[index.ts](./index.ts)** — applyFilters() orchestrates filter chain with 30-worker concurrency pool, short-circuit evaluation (stops at first exclusion), per-filter statistics (matched/rejected counts), ITraceWriter emission of `filter:applied` events. Re-exports all filter creators and BINARY_EXTENSIONS/DEFAULT_VENDOR_DIRS constants.

## Architecture

### FileFilter Interface Contract

```typescript
interface FileFilter {
  name: string
  shouldExclude(absolutePath: string): boolean | Promise<boolean>
}
```

Implemented by all filter modules (gitignore, vendor, binary, custom) via `../types.js`. Enables polymorphic filter chaining with consistent error handling and telemetry.

### Execution Strategy

**Short-circuit evaluation** — applyFilters() iterates filter array for each file, breaks on first `shouldExclude()=true`, records exclusion reason as filter name. Prevents redundant I/O when gitignore filter rejects file before binary content analysis.

**Bounded concurrency** — Worker pool spawns `Math.min(30, files.length)` tasks sharing single `files.entries()` iterator. Prevents file descriptor exhaustion during binary detection (isBinaryFile() reads file chunks synchronously).

**Statistics aggregation** — Initializes `Map<filterName, {matched, rejected}>` for all filters. Increments `rejected` when filter excludes file. Increments `matched` for all filters when file survives full chain (tracks "pass-through" counts).

### Path Normalization Patterns

**binary.ts** — Uses `path.extname(absolutePath).toLowerCase()` for case-insensitive extension lookup, fs.stat() for size metadata.

**gitignore.ts / custom.ts** — Converts absolute paths to relative via `path.relative(normalizedRoot, absolutePath)` (ignore library requires relative paths, treats `../` prefixes as outside boundary).

**vendor.ts** — Normalizes input patterns via `.replace(/[\\/]/g, path.sep)` for cross-platform separator handling, splits paths via `path.sep` for segment matching.

## Integration Points

**Discovery walker** (`src/discovery/walker.ts`) — Composes filters via createGitignoreFilter + createVendorFilter + createBinaryFilter + createCustomFilter sequence, passes result to applyFilters().

**Config schema** (`src/config/schema.ts`) — Sources patterns from config.exclude.patterns (custom), config.exclude.vendorDirs (vendor), config.exclude.binaryExtensions (binary), config.options.maxFileSize (binary).

**Trace emission** (`src/orchestration/trace.ts`) — ITraceWriter.write() receives `{event: 'filter:applied', filterName, filesMatched, filesRejected}` events for telemetry aggregation.

## File Relationships

**index.ts** re-exports all filter creators and constants, centralizes applyFilters() orchestration logic. Binary/gitignore/vendor/custom modules operate independently (no cross-dependencies). All modules import FileFilter interface from `../types.js` (shared contract definition).