<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/discovery

The discovery directory orchestrates file enumeration and exclusion, walking directory trees and filtering results through a composable chain of gitignore, vendor, binary, and custom pattern filters with trace instrumentation and bounded concurrency.

## Contents

**Core Pipeline**

- [run.ts](./run.ts) — Entry point: `discoverFiles(root, config, options)` walks directory via `walkDirectory()`, instantiates filters in order (gitignore → vendor → binary → custom), chains them through `applyFilters()`, returns `FilterResult` with included/excluded files and filter attribution.

- [walker.ts](./walker.ts) — Low-level traversal: `walkDirectory(options: WalkerOptions)` delegates to `fast-glob` with `absolute: true`, `onlyFiles: true`, `dot: true` (default), `followSymlinks: false` (default), `suppressErrors: true`, and hardcoded `.git/**` exclusion; separation of concerns keeps walker filter-agnostic.

- [types.ts](./types.ts) — Interfaces: `FileFilter` (async-first `shouldExclude()` returning `Promise<boolean> | boolean`), `ExcludedFile` (path + reason + filter name), `FilterResult` (included/excluded arrays), `WalkerOptions` (cwd, followSymlinks, dot).

## Subdirectories

- [filters/](./filters/) — Filter chain factories (`createBinaryFilter`, `createVendorFilter`, `createGitignoreFilter`, `createCustomFilter`) and composition: `applyFilters(files, filters, options)` orchestrates ordered evaluation with short-circuit semantics, bounded concurrency (CONCURRENCY=30), and trace emission.

## Filter Pipeline Architecture

`discoverFiles()` constructs filter array in strict order: async `createGitignoreFilter(root)` → sync `createVendorFilter(vendorDirs)` → sync `createBinaryFilter(maxFileSize)` → sync `createCustomFilter(patterns, root)`. All filters passed to `applyFilters()` which evaluates per-file in order, stops at first exclusion, records reason and filter name, emits trace events (`filter:applied` with per-filter statistics).

Binary filter receives `maxFileSize` and `additionalExtensions` config tuple for two-phase detection (extension Set lookup, then `isBinaryFile` content analysis). Custom filter receives patterns array and root path for gitignore-style pattern application via `ignore` library.

## Configuration Surface

`DiscoveryConfig` interface: `exclude.vendorDirs[]`, `exclude.binaryExtensions[]`, `exclude.patterns[]`, `options.maxFileSize`, `options.followSymlinks`.

`DiscoverFilesOptions` interface: optional `tracer?: ITraceWriter`, `debug?: boolean` for pipeline instrumentation.

## Key Design Patterns

**Separation of Concerns:** Walker collects all files (no filtering); filters applied separately via composable chain.

**Async-First Filters:** `FileFilter.shouldExclude()` returns `Promise<boolean> | boolean`, allowing sync filters (gitignore, vendor, binary extension check) and async filters (binary content I/O via `isBinaryFile`).

**Trace Attribution:** Each `ExcludedFile` record includes `filter: string` (e.g., "gitignore", "vendor", "binary") for provenance tracking; `applyFilters()` emits `filter:applied` trace events with per-filter match counts.

**Bounded Concurrency:** Worker pool via shared iterator prevents file descriptor exhaustion during binary content checks (`isBinaryFile` I/O); CONCURRENCY=30 configurable in `filters/index.ts`.

## Behavioral Contracts

**Path Normalization:**
- Absolute paths → relative via `path.relative(normalizedRoot, absolutePath)` for pattern matching
- Relative paths starting with `'..'` or empty treated as outside-root (never excluded)
- OS-specific `path.sep` normalization in vendor filter for cross-platform matching

**Binary Extension Detection:**
- Case-insensitive via `path.extname().toLowerCase()`
- 65 pre-computed binary extensions in `BINARY_EXTENSIONS` Set (O(1) lookup)

**Vendor Directory Matching:**
- Single-segment names ('node_modules') matched anywhere in hierarchy via `absolutePath.split(path.sep)` segment checking
- Multi-segment patterns ('apps/vendor') matched via substring inclusion after normalization

**Pattern Matching (gitignore, custom):**
- Empty pattern arrays return `false` (pass all files)
- Missing .gitignore silently handled (no error)

## File Relationships

- `run.ts` orchestrates: `walkDirectory()` → `applyFilters([gitignore, vendor, binary, custom])`
- `walker.ts` produces file list; filters consume it sequentially
- `filters/index.ts` chains four factories and exports `applyFilters()` orchestrator
- All filters implement `FileFilter` interface from `types.ts`
- Trace events routed to optional `ITraceWriter` (from `../orchestration/trace.js`)