<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/discovery

`src/discovery` orchestrates file discovery by walking directory trees via `fast-glob`, applying filter chains (gitignore, vendor, binary, custom) with short-circuit evaluation and bounded concurrency, returning `FilterResult` with included/excluded file lists and attribution.

## Contents

- [`run.ts`](./run.ts): Exports `discoverFiles(root, config, options?)` which instantiates filter chain from `DiscoveryConfig` (createGitignoreFilter, createVendorFilter, createBinaryFilter, createCustomFilter), calls `walkDirectory` with `followSymlinks` option, applies filters via `applyFilters`, returns `FilterResult`.
- [`types.ts`](./types.ts): Defines `FileFilter` interface (`name: string`, `shouldExclude(path, stats?): boolean | Promise<boolean>`), `ExcludedFile` record (`path`, `reason`, `filter`), `FilterResult` output (`included: string[]`, `excluded: ExcludedFile[]`), `WalkerOptions` config (`cwd`, `followSymlinks?`, `dot?`).
- [`walker.ts`](./walker.ts): Exports `walkDirectory(options): Promise<string[]>` wrapping `fast-glob` with hardcoded `**/*` pattern, `dot: true`, `followSymlinks: false` defaults, `**/.git/**` exclusion, `suppressErrors: true` for permission failures.

## Subdirectories

- [`filters/`](./filters/): Implements composable `FileFilter` implementations (gitignore, vendor, binary, custom) and `applyFilters` orchestrator with concurrency=30, short-circuit evaluation, trace emission, per-filter stats.

## Architecture

**Discovery Pipeline**: `discoverFiles` → `walkDirectory` (fast-glob traversal) → `applyFilters` (sequential filter chain per file with 30-worker pool) → `FilterResult`. Filters evaluate in order: gitignore → vendor → binary → custom; first `shouldExclude=true` stops evaluation for that file.

**Filter Chain Construction**: `run.ts` creates filters from config fields (`exclude.vendorDirs`, `exclude.binaryExtensions`, `exclude.patterns`, `options.maxFileSize`) using filter factories from `filters/index.js`; gitignore filter created asynchronously from `.gitignore` at root.

**Concurrency Management**: `applyFilters` (filters/index.ts) bounds parallel file processing to 30 workers via shared iterator to prevent file descriptor exhaustion during binary content detection I/O.

## Integration Points

Consumed by `src/cli/discover.ts` and `src/cli/update.ts`; accepts `DiscoveryConfig` subset compatible with full `Config` schema from `src/config/schema.ts`; emits trace events to `ITraceWriter` from `src/orchestration/trace.js`; logs via `Logger` from `src/core/logger.js`.

## Behavioral Contracts

- **Default Traversal Options**: `dot: true` (include hidden files), `followSymlinks: false` (per CONTEXT.md security), `**/.git/**` always excluded, `suppressErrors: true` (skip permission errors).
- **Filter Evaluation Order**: Gitignore → Vendor → Binary → Custom; short-circuit on first match.
- **Path Requirements**: `walkDirectory` returns absolute paths; filters convert to relative via `path.relative(root, absolutePath)` before pattern matching.
- **Binary Detection**: Two-phase (extension set fast-path → content analysis + size threshold slow-path); defaults to `1024 * 1024` bytes max.