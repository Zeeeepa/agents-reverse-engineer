<!-- Generated by agents-reverse-engineer -->

# src/installer/

npx orchestration module copying ARE command templates and session lifecycle hooks to runtime-specific directories (`.claude`, `.opencode`, `.gemini`) with interactive prompts, environment-aware path resolution, settings.json hook registration, and reversible uninstallation workflows.

## Contents

### Entry Points

**[index.ts](./index.ts)** — Installer orchestrator exporting `runInstaller()` (main workflow), `parseInstallerArgs()` (CLI flag parser), `runInstall()`/`runUninstall()` (mode routing), `determineLocation()`/`determineRuntimes()` (argument normalization), `displayInstallResults()`/`displayUninstallResults()` (output formatting). Handles dual-mode operation: interactive TTY via `selectRuntime()`/`selectLocation()` from prompts.ts, non-interactive CI via flag validation (`--runtime`, `-g`/`-l` requirements). Aggregates per-runtime `InstallerResult[]` from `installFiles()`/`uninstallFiles()`, calls `verifyInstallation()`, invokes `showNextSteps()` banner.

### Core Installation Logic

**[operations.ts](./operations.ts)** — Implements `installFiles()` (template/hook copying), `verifyInstallation()` (file existence check), `registerHooks()` (settings.json hook insertion), `registerPermissions()` (bash command auto-approval), `writeVersionFile()` (ARE-VERSION tracking). Delegates to `installFilesForRuntime()` for per-runtime execution: calls `getTemplatesForRuntime()` from `src/integration/templates.ts`, writes command files via `ensureDir()` + `writeFileSync()`, reads bundled hooks from `hooks/dist/` via `getBundledHookPath()`/`readBundledHook()`, invokes `registerClaudeHooks()`/`registerGeminiHooks()` for settings.json mutation. Defines `ARE_HOOKS` (SessionStart/SessionEnd hook registry), `ARE_PLUGINS` (OpenCode plugin mappings), `ARE_PERMISSIONS` (bash command patterns).

**[uninstall.ts](./uninstall.ts)** — Reverses installation via `uninstallFiles()` (template/hook deletion), `unregisterHooks()` (settings.json cleanup), `unregisterPermissions()` (permission removal), `deleteConfigFolder()` (`.agents-reverse-engineer` deletion). Implements `uninstallFilesForRuntime()` mirroring `operations.ts` logic: removes files via `unlinkSync()`, filters hook arrays via `getHookPatterns()` command matching, triggers `cleanupEmptyDirs()` recursive pruning, calls `cleanupLegacyGeminiFiles()` for old `.md`/`.toml` formats. Uses `ARE_HOOKS`, `ARE_PLUGIN_FILENAMES`, `ARE_PERMISSIONS` constants for symmetrical install/uninstall.

### Path Resolution

**[paths.ts](./paths.ts)** — Exports `getRuntimePaths()` (runtime-to-directory mapping with env overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`), `resolveInstallPath()` (absolute path for global/local installs), `getSettingsPath()` (settings.json location), `isRuntimeInstalledLocally()`/`isRuntimeInstalledGlobally()` (installation detection via `stat()` directory checks), `getInstalledRuntimes()` (filter `getAllRuntimes()` by local presence). Returns `RuntimePaths` with `{ global: string, local: string, settingsFile: string }` fields. Uses `os.homedir()` and `path.join()` for cross-platform compatibility.

### User Interaction

**[prompts.ts](./prompts.ts)** — Implements `selectRuntime()` (choose claude/opencode/gemini/all), `selectLocation()` (global/local), `confirmAction()` (yes/no) via `selectOption<T>()` generic router. Calls `arrowKeySelect()` for TTY environments (raw mode with `readline.emitKeypressEvents()`, ANSI cursor control, cyan highlighting via `picocolors`), `numberedSelect()` for non-TTY (numbered list + readline question). Provides `isInteractive()` predicate checking `process.stdin.isTTY`. Manages terminal state via `cleanupRawMode()` (restore cooked mode on exit/SIGINT), `rawModeActive` flag preventing leaked raw mode.

### Display Utilities

**[banner.ts](./banner.ts)** — Exports `displayBanner()` (7-line green ASCII "ARE" logo with version from `getVersion()`), `showHelp()` (usage text with flags: `--runtime`, `-g`/`-l`, `-u`, `--force`, `-q`, `-h`), `showSuccess()`/`showError()`/`showWarning()`/`showInfo()` (colored symbol-prefixed messages ✓ ✗ ! >), `showNextSteps()` (post-install workflow: 7 commands `/are-help` → `/are-init` → `/are-discover` → `/are-generate` → `/are-update` → `/are-specify` → `/are-clean`, GitHub docs link). All functions write directly to `console.log()` via `picocolors` formatting.

### Type Definitions

**[types.ts](./types.ts)** — Defines `Runtime` (`'claude' | 'opencode' | 'gemini' | 'all'`), `Location` (`'global' | 'local'`), `InstallerArgs` (CLI flags: `runtime?`, `global`, `local`, `uninstall`, `force`, `help`, `quiet`), `InstallerResult` (operation outcome with `success`, `runtime`, `location`, `filesCreated[]`, `filesSkipped[]`, `errors[]`, `hookRegistered?`, `versionWritten?`), `RuntimePaths` (path config: `global`, `local`, `settingsFile`). Used across installer subsystem for type-safe argument passing and result aggregation.

## Architecture

**Workflow Phases:**

1. **Argument Parsing** — `parseInstallerArgs()` converts CLI flags to `InstallerArgs`, validates `--runtime` against `['claude', 'opencode', 'gemini', 'all']`, defaults `uninstall: false`.

2. **Mode Selection** — `runInstaller()` checks `args.help` → `showHelp()` + exit, detects interactive via `isInteractive()`, prompts via `selectRuntime()`/`selectLocation()` for missing values, enforces non-interactive flag requirements (`--runtime` + location flag).

3. **Runtime Expansion** — `determineRuntimes()` expands `'all'` to `['claude', 'opencode', 'gemini']` via `getAllRuntimes()`, wraps single runtime.

4. **Installation** — `runInstall()` per runtime: calls `installFiles()` → `installFilesForRuntime()` → writes templates via `getTemplatesForRuntime()` + `ensureDir()` + `writeFileSync()`, reads bundled hooks via `getBundledHookPath()`/`readBundledHook()`, registers hooks via `registerClaudeHooks()`/`registerGeminiHooks()` settings.json mutation, adds permissions via `registerPermissions()`, writes `ARE-VERSION` via `writeVersionFile()`. Verifies via `verifyInstallation()` file existence checks. Displays via `displayInstallResults()` aggregating counts.

5. **Uninstallation** — `runUninstall()` per runtime: calls `uninstallFiles()` → `uninstallFilesForRuntime()` → deletes templates/hooks via `unlinkSync()`, unregisters hooks via `unregisterClaudeHooks()`/`unregisterGeminiHooks()` array filtering, removes permissions via `unregisterPermissions()`, cleans empty directories via `cleanupEmptyDirs()`, deletes legacy formats via `cleanupLegacyGeminiFiles()`. Removes `.agents-reverse-engineer` via `deleteConfigFolder()` for local installs. Displays via `displayUninstallResults()`.

**Settings.json Mutation:**

Claude Code uses `SettingsJson` schema with `hooks: { SessionStart: HookEvent[], SessionEnd: HookEvent[] }` where `HookEvent = { hooks: SessionHook[] }` and `SessionHook = { type: 'command', command: string }`. Hook commands formatted as `node <runtimeDir>/hooks/<filename>`.

Gemini uses `GeminiSettingsJson` with flatter `hooks: { SessionStart: GeminiHook[], SessionEnd: GeminiHook[] }` where `GeminiHook = { name, type: 'command', command }`.

Both implementations use JSON parse-modify-stringify cycle preserving unknown fields via `[key: string]: unknown` index signature.

**Path Resolution Strategy:**

`getRuntimePaths()` applies environment overrides: `CLAUDE_CONFIG_DIR` overrides `~/.claude`, `OPENCODE_CONFIG_DIR` overrides `XDG_CONFIG_HOME/opencode` or `~/.config/opencode`, `GEMINI_CONFIG_DIR` overrides `~/.gemini`. `resolveInstallPath()` returns global path for `location === 'global'`, joins `projectRoot` + local path for `location === 'local'`.

**Terminal State Management:**

`arrowKeySelect()` enables raw mode via `process.stdin.setRawMode(true)`, registers `keypress` listener handling `up`/`down`/`return`/`Ctrl+C`, renders via ANSI escape codes (`\x1b[${n}A` cursor up, `\x1b[2K` clear line), highlights selected with `pc.cyan()`. `cleanupRawMode()` restores cooked mode via `setRawMode(false)` + `pause()`, registered on `process.on('exit')` and `process.on('SIGINT')` to prevent leaked raw mode.

**Bundled Hook Strategy:**

`getBundledHookPath()` resolves via `fileURLToPath(import.meta.url)` + `../../hooks/dist/${hookName}` relative to `dist/installer/operations.js` location. Hooks populated by `npm run build:hooks` during `prepublishOnly`. Claude/Gemini write to `<basePath>/hooks/<filename>`, OpenCode writes to `<basePath>/plugins/<destFilename>`.

## Integration Points

**Depends on:**
- `src/integration/templates.ts` — `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` for command file templates
- `src/version.ts` — `getVersion()` for package version display in banner and ARE-VERSION file
- `picocolors` — Color formatting for terminal output
- `readline` — Keypress events and question interface

**Consumed by:**
- `src/cli/index.ts` — Invokes installer via npx entry point
- IDE runtimes — Read installed commands/hooks from `.claude/`, `.opencode/`, `.gemini/` directories

**Produces:**
- Command templates at `<basePath>/commands/<name>/<filename>` or `<basePath>/skills/<name>/<filename>` (Claude)
- Hook files at `<basePath>/hooks/<filename>` (Claude/Gemini)
- Plugin files at `<basePath>/plugins/<filename>` (OpenCode)
- `ARE-VERSION` file at `<basePath>/ARE-VERSION` tracking installed package version
- Mutated `settings.json` with registered hooks and bash permissions

## Configuration Constants

**ARE_HOOKS** (operations.ts, uninstall.ts) — `HookDefinition[]` registry defining SessionStart/SessionEnd hooks with filenames `are-check-update.js`, `are-session-end.js`. Currently empty in operations.ts (both entries commented out), defined in uninstall.ts for cleanup.

**ARE_PLUGINS** (operations.ts) — `PluginDefinition[]` mapping OpenCode bundled hooks (`opencode-are-check-update.js`) to target filenames (`are-check-update.js` in `.opencode/plugins/`). Session-end plugin commented out.

**ARE_PERMISSIONS** (operations.ts, uninstall.ts) — `string[]` bash command patterns auto-approved in Claude Code: `npx agents-reverse-engineer@latest <cmd>` (init/discover/generate/update/clean), `tail -5 .agents-reverse-engineer/progress.log`, `rm -f .agents-reverse-engineer/progress.log`.

**CONFIG_DIR** (uninstall.ts) — Set to `.agents-reverse-engineer`, matches `src/config/loader.ts`.