<!-- Generated by agents-reverse-engineer -->

# src/installer/

**Orchestrates npx-based installation workflows for deploying ARE commands and session hooks to Claude Code, OpenCode, and Gemini runtime directories with support for global (~/.claude) and local (.claude) locations, interactive TTY prompts, and settings.json hook registration.**

## Contents

### Entry Points

**[index.ts](./index.ts)** — Main orchestrator exposing `runInstaller()` which parses CLI flags via `parseInstallerArgs()`, routes to `runInstall()` or `runUninstall()` based on `InstallerArgs.uninstall`, aggregates `InstallerResult[]` from operations, and re-exports all installer subsystem types/functions for external consumption.

**[operations.ts](./operations.ts)** — Core installation logic implementing `installFiles()` which copies command templates via `getTemplatesForRuntime()`, writes hook files to `hooks/` or `plugins/` subdirectories, registers hooks in settings.json via `registerClaudeHooks()`/`registerGeminiHooks()`, adds bash command permissions via `registerPermissions()`, writes `ARE-VERSION` file via `writeVersionFile()`.

**[uninstall.ts](./uninstall.ts)** — Reverses installation via `uninstallFiles()` which deletes command templates, removes hook entries from settings.json via `unregisterClaudeHooks()`/`unregisterGeminiHooks()`, strips permissions via `unregisterPermissions()`, cleans empty directories via `cleanupEmptyDirs()`, handles legacy Gemini `.md`/`.toml` cleanup via `cleanupLegacyGeminiFiles()`.

### Supporting Modules

**[paths.ts](./paths.ts)** — Path resolution exposing `getRuntimePaths()` which returns `RuntimePaths` with environment overrides (`CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`), `resolveInstallPath()` joining project root with local config dirs, `isRuntimeInstalledLocally()`/`isRuntimeInstalledGlobally()` existence checks via `stat()`.

**[prompts.ts](./prompts.ts)** — Interactive selection implementing `selectRuntime()`/`selectLocation()` routing to `arrowKeySelect()` for TTY raw mode navigation (up/down/return keypresses with `\x1b[${n}A` cursor repositioning) or `numberedSelect()` for non-interactive fallback (readline integer input), `isInteractive()` checking `process.stdin.isTTY`, `cleanupRawMode()` restoring terminal state on exit/SIGINT.

**[types.ts](./types.ts)** — Type definitions including `Runtime` union (`'claude' | 'opencode' | 'gemini' | 'all'`), `Location` union (`'global' | 'local'`), `InstallerArgs` with CLI flags (runtime/global/local/uninstall/force/help/quiet), `InstallerResult` with `filesCreated`/`filesSkipped`/`errors`/`hookRegistered`/`versionWritten`, `RuntimePaths` with global/local/settingsFile paths.

**[banner.ts](./banner.ts)** — Terminal output utilities providing `displayBanner()` ASCII art rendering, `showHelp()` usage documentation, `showSuccess()`/`showError()`/`showWarning()`/`showInfo()` with colored prefixes (`✓`/`✗`/`!`/`>` via picocolors), `showNextSteps()` listing seven ARE commands, `VERSION` constant from package.json via `fileURLToPath(import.meta.url)`.

## Architecture

### Dual-Mode Operation

Interactive TTY mode invokes `arrowKeySelect()` which enables raw mode via `process.stdin.setRawMode(true)`, listens for keypress events, renders cyan-highlighted selection with ANSI cursor control, resolves on `'return'` key. Non-interactive mode invokes `numberedSelect()` which prints numbered list, reads integer input via readline, validates range, rejects promise on parse failure. Mode detection via `isInteractive()` checking `process.stdin.isTTY`.

### Hook Registration Strategy

`registerClaudeHooks()` parses existing settings.json as `SettingsJson`, initializes `hooks.SessionStart`/`hooks.SessionEnd` arrays if missing, appends `HookEvent` objects containing `{ type: 'command', command: 'node <runtimeDir>/hooks/<filename>' }` for each `ARE_HOOKS` entry not matching existing commands via substring search, writes JSON with 2-space indent. `registerGeminiHooks()` follows identical logic but uses flat `GeminiHook` objects with name/type/command fields. `registerPermissions()` merges `ARE_PERMISSIONS` bash patterns into `permissions.allow` array for auto-approval of `npx agents-reverse-engineer@latest` commands and `tail`/`rm` operations on progress.log.

### Uninstall Reversal

`uninstallFilesForRuntime()` mirrors installation by extracting template paths via `.split('/').slice(1).join('/')` to strip runtime prefix, deleting via `unlinkSync()`, calling `unregisterHooks()`/`unregisterPermissions()` which filter settings.json arrays to remove entries matching `getHookPatterns()` (includes current and legacy command formats), cleaning empty structures, triggering recursive empty directory cleanup via `cleanupEmptyDirs()` stopping at runtime roots (`.claude`, `.opencode`, `.gemini`). `deleteConfigFolder()` removes `.agents-reverse-engineer` directory for local installations only via `rmSync()` with `recursive: true`.

### Template Integration

`operations.ts` and `uninstall.ts` both import `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` from `../integration/templates.js` for runtime-specific command definitions. Templates contain `name`, `path` (destination with runtime prefix), and `content` fields. Operations module writes files via `ensureDir()` + `writeFileSync()`, uninstall module deletes via `unlinkSync()` after path stripping.

## Configuration Constants

**ARE_HOOKS** (operations.ts, uninstall.ts) — Defines `HookDefinition[]` with `event: 'SessionStart' | 'SessionEnd'` and `filename` fields (currently empty array, both hooks commented out due to issues). Must match between modules for symmetrical install/uninstall.

**ARE_PLUGINS** (operations.ts) — Defines `PluginDefinition[]` mapping `srcFilename` (bundled hooks with `opencode-` prefix) to `destFilename` (target in `.opencode/plugins/`), currently contains `opencode-are-check-update.js` → `are-check-update.js`.

**ARE_PERMISSIONS** (operations.ts, uninstall.ts) — Defines bash command patterns for Claude Code auto-approval: `npx agents-reverse-engineer@latest` with subcommands (init/discover/generate/update/clean), `tail -5`/`rm -f` for `.agents-reverse-engineer/progress.log`. Must match between modules.

## File Relationships

`index.ts` depends on `operations.ts` (`installFiles`, `verifyInstallation`), `uninstall.ts` (`uninstallFiles`, `deleteConfigFolder`), `paths.ts` (`getRuntimePaths`, `getAllRuntimes`, `resolveInstallPath`), `prompts.ts` (`selectRuntime`, `selectLocation`, `isInteractive`), `banner.ts` (display functions, VERSION). `operations.ts` and `uninstall.ts` share dependency on `paths.ts` for path resolution, `types.ts` for shared interfaces, `../integration/templates.js` for template arrays. `prompts.ts` imports types from `types.ts` for type-safe selection return values. `banner.ts` reads package.json via ESM `import.meta.url` resolution with `fileURLToPath()`.

## Result Aggregation Pattern

`InstallerResult.filesCreated` tracks successfully written files during install, repurposed to track deleted files during uninstall. `InstallerResult.hookRegistered` indicates hook registration success during install, repurposed to indicate hook unregistration during uninstall. `InstallerResult.filesSkipped` tracks existing files skipped without `--force` flag during install, non-existent files during uninstall. `InstallerResult.errors` accumulates error strings from file operation failures or JSON parsing errors.

## Terminal State Management

`prompts.ts` maintains module-level `rawModeActive` flag for cleanup coordination. `cleanupRawMode()` restores terminal via `process.stdin.setRawMode(false)` and `process.stdin.pause()` when `rawModeActive && process.stdin.isTTY`, registered on `process.on('exit')` and `process.on('SIGINT')` to prevent raw mode leakage on interrupt or normal exit. `arrowKeySelect()` wraps raw mode setup in try/catch calling `cleanupRawMode()` before rethrowing to prevent terminal corruption.