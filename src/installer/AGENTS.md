<!-- Generated by agents-reverse-engineer v0.8.3 -->

# src/installer

Interactive installer module orchestrating command template/session hook deployment to AI runtime config directories (`.claude/`, `.gemini/`, `.config/opencode/`) with TTY-aware prompts, settings.json hook registration via jsonc-parser, permission injection for Claude, version tracking, and symmetric uninstall operations.

## Contents

**[banner.ts](./banner.ts)** — Terminal UI helpers: `displayBanner()` renders green ASCII "ARE" box-drawing art + version, `showHelp()` prints usage table (`--runtime`, `-g`, `-l`, `-u`, `--force`, `-q`, `-h`) + 3 examples, `showSuccess()`/`showError()`/`showWarning()`/`showInfo()` emit picocolors-styled messages, `showNextSteps()` displays 7-step post-install guide (/are-help, /are-init, /are-discover, /are-generate, /are-update, /are-specify, /are-clean) + GitHub docs link, `VERSION` constant from `getVersion()`.

**[index.ts](./index.ts)** — Main entry point: `runInstaller()` routes install/uninstall workflows via `runInstall()`/`runUninstall()`, `parseInstallerArgs()` parses CLI flags (`--runtime`, `-g/--global`, `-l/--local`, `--force`, `-q/--quiet`, `-h/--help`) validating runtime against `['claude', 'opencode', 'gemini', 'all']`, `displayInstallResults()`/`displayUninstallResults()` format operation summaries with file counts + hook status. Non-interactive mode requires `--runtime` + location flag or exits code 1. Interactive mode calls `selectRuntime()`/`selectLocation()` prompts. Re-exports types/functions from `./types.js`, `./paths.js`, `./banner.js`, `./prompts.js`.

**[operations.ts](./operations.ts)** — Install operations: `installFilesForRuntime()` copies command templates from `getTemplatesForRuntime()` to `resolveInstallPath()`, writes hooks (Claude/Gemini) or plugins (OpenCode) from `getBundledHookPath()` (navigates `../../hooks/dist/`), calls `registerHooks()`/`registerPermissions()` via jsonc-parser `modify()`/`applyEdits()` preserving comments, writes `ARE-VERSION` file via `writeVersionFile()`. `registerClaudeHooks()` constructs `node ${runtimeDir}/hooks/${hookDef.filename}` commands into nested hooks array. `registerGeminiHooks()` uses flat GeminiHook schema with name field. `registerPermissions()` merges `ARE_PERMISSIONS` (7 patterns: `Bash(npx agents-reverse-engineer@latest init*)`, `discover*`, `generate*`, `update*`, `clean*`, `Bash(rm -f .agents-reverse-engineer/progress.log*)`, `Bash(sleep *)`) into settings.permissions.allow. `verifyInstallation()` filters files via `existsSync()`. `formatInstallResult()` builds human-readable lines. `getPackageVersion()` reads `../../package.json` version field from dist/installer/operations.js. Returns `InstallerResult` with `filesCreated`/`filesSkipped`/`errors`/`hookRegistered`/`versionWritten`.

**[paths.ts](./paths.ts)** — Path resolver: `getAllRuntimes()` returns `['claude', 'opencode', 'gemini']`, `getRuntimePaths()` returns `RuntimePaths` with `global` (absolute config dir), `local` (relative project dir like `.claude`), `settingsFile` (settings.json path). `resolveInstallPath()` joins projectRoot + local dir for local installs, returns global path otherwise. `getSettingsPath()` returns settings.json absolute path. `isRuntimeInstalledLocally()`/`isRuntimeInstalledGlobally()` check directory existence via `stat()`. `getInstalledRuntimes()` returns array of locally installed runtimes. Uses env var overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `XDG_CONFIG_HOME`, `GEMINI_CONFIG_DIR`. Defaults: Claude `~/.claude`, OpenCode `~/.config/opencode`, Gemini `~/.gemini`.

**[prompts.ts](./prompts.ts)** — Interactive prompts: `isInteractive()` returns `process.stdin.isTTY === true`. `selectOption()` routes to `arrowKeySelect()` (TTY) or `numberedSelect()` (CI/non-TTY). `selectRuntime()` prompts for runtime from `['claude', 'opencode', 'gemini', 'all']`. `selectLocation()` prompts for `'global'` (~/.claude) or `'local'` (./.claude). `confirmAction()` Yes/No selection. `arrowKeySelect()` enables `readline.emitKeypressEvents()` + `setRawMode(true)`, listens for up/down/return keypresses, renders via ANSI escape codes (`\x1b[${n}A`, `\x1b[2K`, `\x1b[1B`), guarantees cleanup via `cleanupRawMode()` in finally block + `process.on('exit')` + `process.on('SIGINT')`.

**[types.ts](./types.ts)** — TypeScript interfaces: `Runtime = 'claude' | 'opencode' | 'gemini' | 'all'`, `Location = 'global' | 'local'`, `InstallerArgs` (CLI schema: `runtime?`, `global`, `local`, `uninstall`, `force`, `help`, `quiet`), `InstallerResult` (operation outcome: `success`, `runtime`, `location`, `filesCreated[]`, `filesSkipped[]`, `errors[]`, `hookRegistered?`, `versionWritten?`), `RuntimePaths` (resolved paths: `global`, `local`, `settingsFile`).

**[uninstall.ts](./uninstall.ts)** — Reverses install: `uninstallFilesForRuntime()` deletes command templates from `resolveInstallPath()`, hooks/plugins from `hooks/`/`plugins/` dirs, `ARE-VERSION` file, calls `unregisterHooks()`/`unregisterPermissions()`, `cleanupAreSkillDirs()` (Claude skills), `cleanupLegacyGeminiFiles()` (pre-TOML formats), `cleanupEmptyDirs()` (recursive removal stopping at runtime roots). `unregisterClaudeHooks()`/`unregisterGeminiHooks()` filter settings.json hook arrays removing entries matching `getHookPatterns()` (current `node ${runtimeDir}/hooks/${hookDef.filename}` + legacy `node hooks/${hookDef.filename}` formats) via jsonc-parser. `unregisterPermissions()` removes `ARE_PERMISSIONS` from settings.permissions.allow, cleans empty permissions object. `deleteConfigFolder()` deletes `.agents-reverse-engineer/` via `rmSync({recursive: true, force: true})` only when `location === 'local'`. Returns `InstallerResult` with `filesCreated` repurposed as deleted files, `hookRegistered` as `hookUnregistered`.

## Workflow

### Interactive Install
1. `parseInstallerArgs()` extracts `--runtime`/`-g`/`-l`/`--force`/`--quiet` flags
2. `displayBanner()` unless quiet
3. `selectRuntime()`/`selectLocation()` if missing via TTY arrow keys or numbered fallback
4. `runInstall()` calls `installFilesForRuntime()` per runtime:
   - Copy templates from `getTemplatesForRuntime()` to `resolveInstallPath()`
   - Write hooks from `getBundledHookPath('../../hooks/dist/')` to `hooks/`/`plugins/`
   - `registerHooks()` → `registerClaudeHooks()`/`registerGeminiHooks()` via jsonc-parser
   - `registerPermissions()` (Claude only) merges `ARE_PERMISSIONS` into settings.permissions.allow
   - `writeVersionFile()` writes package.json version to `ARE-VERSION`
5. `verifyInstallation()` checks `existsSync()` for all created files
6. `displayInstallResults()` shows filesCreated/filesSkipped/hookRegistered counts
7. `showNextSteps()` emits 7-step usage guide

### Non-Interactive Install
Requires `--runtime` + `-g`/`-l` flags or exits code 1. Skips prompts. Same file operations.

### Uninstall
1. `runUninstall()` calls `uninstallFilesForRuntime()`:
   - Delete command templates, hooks/plugins, `ARE-VERSION`
   - `unregisterHooks()` filters settings.json via jsonc-parser
   - `unregisterPermissions()` removes ARE_PERMISSIONS (Claude)
   - `cleanupAreSkillDirs()`/`cleanupLegacyGeminiFiles()`/`cleanupEmptyDirs()`
2. `deleteConfigFolder()` removes `.agents-reverse-engineer/` if local install
3. `displayUninstallResults()` shows deletion counts

## Behavioral Contracts

### Hook Definitions
```typescript
const ARE_HOOKS: HookDefinition[] = [
  // { event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' },
  // { event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }, // Disabled - causing issues
];
```
Currently empty array (all hooks disabled). Must mirror across operations.ts/uninstall.ts.

### Plugin Definitions
```typescript
const ARE_PLUGINS: PluginDefinition[] = [
  // Disabled - causing issues in OpenCode
  // { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' },
];
```
Currently empty array (all plugins disabled). Must mirror operations.ts.

### Permission Patterns
```typescript
const ARE_PERMISSIONS = [
  'Bash(npx agents-reverse-engineer@latest init*)',
  'Bash(npx agents-reverse-engineer@latest discover*)',
  'Bash(npx agents-reverse-engineer@latest generate*)',
  'Bash(npx agents-reverse-engineer@latest update*)',
  'Bash(npx agents-reverse-engineer@latest clean*)',
  'Bash(rm -f .agents-reverse-engineer/progress.log*)',
  'Bash(sleep *)',
];
```
Must mirror across operations.ts/uninstall.ts.

### Hook Command Format
Claude/Gemini: `node ${runtimeDir}/hooks/${hookDef.filename}` where runtimeDir is `.claude` or `.gemini`.

### Valid Runtimes
`['claude', 'opencode', 'gemini', 'all']` (index.ts:63).

### Error Messages
- `'Missing --runtime flag (required in non-interactive mode)'`
- `'Missing -g/--global or -l/--local flag (required in non-interactive mode)'`
- `'Unable to determine runtime and location'`
- `'Installation verification failed - some files missing:'`

### GitHub Docs URL
`'https://github.com/GeoloeG-IsT/agents-reverse-engineer'` (index.ts:290).

### Bundled Hook Path
`../../hooks/dist/${hookName}` from `dist/installer/operations.js`.

### jsonc-parser Formatting
```typescript
formattingOptions: { tabSize: 2, insertSpaces: true }
```

### Empty Directory Cleanup Boundary
Stops at `baseName !== '.claude' && baseName !== '.opencode' && baseName !== '.gemini' && baseName !== '.config'`.

## Integration Points

Depends on `../integration/templates.js` (`getClaudeTemplates`, `getOpenCodeTemplates`, `getGeminiTemplates`), `../version.js` (`getVersion`). Called by `src/cli/index.ts` after command routing. Uses `jsonc-parser` for comment-preserving JSON edits, `readline` for keypress events, `picocolors` for styled output.