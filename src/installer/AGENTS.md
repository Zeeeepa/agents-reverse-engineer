<!-- Generated by agents-reverse-engineer -->

# src/installer

The installer module implements the npx installation workflow for deploying agents-reverse-engineer commands, hooks, and plugins to Claude Code, OpenCode, and Gemini CLI runtimes, supporting both interactive terminal prompts and non-interactive CI execution.

## Contents

### Core Orchestration

**[index.ts](./index.ts)** — Entrypoint exposing `runInstaller(args)` and `parseInstallerArgs(argv)`. Handles command-line flag parsing (`--runtime`, `-g/-l`, `--force`, `-q`, `-u`), delegates to `determineLocation()` and `determineRuntimes()` for argument resolution, calls `selectRuntime()` and `selectLocation()` prompts in interactive mode via `isInteractive()` check, routes to `runInstall()` or `runUninstall()`, displays results via `displayInstallResults()` and `displayUninstallResults()`. Enforces `process.exit(1)` on missing required flags in non-interactive mode. Re-exports all public types and functions from other installer modules.

**[operations.ts](./operations.ts)** — Implements `installFiles(runtime, location, options)` writing command templates to `commands/` subdirectories, `registerHooks(basePath, runtime, dryRun)` adding SessionStart/SessionEnd entries to `settings.json` via JSONC-aware `jsonc-parser` (parse/modify/applyEdits), `registerPermissions(settingsPath, dryRun)` merging `ARE_PERMISSIONS` bash patterns into Claude Code's `permissions.allow` array, `writeVersionFile(basePath, dryRun)` creating `ARE-VERSION` file, `verifyInstallation(files)` checking existence of installed paths. Delegates to `getTemplatesForRuntime()` from `../integration/templates.js` for template inventory. Handles OpenCode plugin installation to `.opencode/plugins/` via `ARE_PLUGINS` definitions, Claude/Gemini hook registration via `registerClaudeHooks()` and `registerGeminiHooks()`, permission injection preserving JSONC comments.

**[uninstall.ts](./uninstall.ts)** — Implements `uninstallFiles(runtime, location, dryRun)` removing command templates and hooks, `unregisterHooks(basePath, runtime, dryRun)` filtering `settings.json` hook arrays to exclude ARE entries via `getHookPatterns()` matching, `unregisterPermissions(basePath, dryRun)` removing `ARE_PERMISSIONS` strings from `permissions.allow`, `deleteConfigFolder(location, dryRun)` removing `.agents-reverse-engineer` directory for local installs. Executes runtime-specific cleanup: `cleanupAreSkillDirs()` for Claude `.claude/skills/are-*` directories, `cleanupLegacyGeminiFiles()` for pre-TOML `.gemini/commands/are-*.md` and pre-flat `.gemini/commands/are/` subdirectories. Uses `cleanupEmptyDirs()` for recursive empty directory removal stopping at runtime roots. Mirrors `operations.ts` hook definitions for symmetric install/uninstall.

### Path Resolution

**[paths.ts](./paths.ts)** — Exports `getRuntimePaths(runtime)` resolving `global`, `local`, and `settingsFile` paths via `os.homedir()` and environment variable overrides (`CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `XDG_CONFIG_HOME`, `GEMINI_CONFIG_DIR`), `resolveInstallPath(runtime, location, projectRoot)` joining resolved paths with project root, `getSettingsPath(runtime)` returning `settings.json` absolute path, `getAllRuntimes()` returning `['claude', 'opencode', 'gemini']`, `isRuntimeInstalledLocally(runtime, projectRoot)` and `isRuntimeInstalledGlobally(runtime)` checking directory existence via `stat()`, `getInstalledRuntimes(projectRoot)` filtering locally installed runtimes.

### User Interface

**[prompts.ts](./prompts.ts)** — Exports `isInteractive()` checking `process.stdin.isTTY`, `selectOption(prompt, options)` dispatching to `arrowKeySelect()` (TTY) or `numberedSelect()` (piped/CI), `selectRuntime(mode)` prompting for `'claude' | 'opencode' | 'gemini' | 'all'`, `selectLocation(mode)` prompting for `'global' | 'local'`, `confirmAction(message)` for binary Yes/No. `arrowKeySelect()` enables raw mode via `setRawMode(true)`, handles keypress events via `readline.emitKeypressEvents()`, responds to `key.name === 'up'/'down'/'return'`, renders with ANSI escape sequences (`\x1b[${n}A`, `\x1b[2K`, `\x1b[1B`) for cursor control and line clearing, cleans up via `cleanupRawMode()` registered on `process.on('exit')` and `process.on('SIGINT')`.

**[banner.ts](./banner.ts)** — Exports `displayBanner()` rendering ASCII art "ARE" logo with version from `getVersion()` (imported from `../version.js`), `showHelp()` printing usage instructions with option flags and example commands, `showSuccess(msg)`, `showError(msg)`, `showWarning(msg)`, `showInfo(msg)` with colored prefixes via `picocolors` (`pc.green()`, `pc.red()`, `pc.yellow()`, `pc.cyan()`), `showNextSteps(runtime, filesCreated)` printing numbered workflow sequence (`/are-help` → `/are-init` → `/are-discover` → `/are-generate` → `/are-update` → `/are-specify` → `/are-clean`) and GitHub link `https://github.com/GeoloeG-IsT/agents-reverse-engineer`.

### Type Definitions

**[types.ts](./types.ts)** — Defines `Runtime` union `'claude' | 'opencode' | 'gemini' | 'all'`, `Location` union `'global' | 'local'`, `InstallerArgs` interface with fields `runtime?`, `global`, `local`, `uninstall`, `force`, `help`, `quiet`, `InstallerResult` interface tracking `success`, `runtime`, `location`, `filesCreated`, `filesSkipped`, `errors`, `hookRegistered?`, `versionWritten?`, `RuntimePaths` interface with `global`, `local`, `settingsFile` path strings. Consumed by all installer modules for type safety.

## Architecture

**Installation Flow**: `runInstaller()` → `parseInstallerArgs()` → `determineLocation()`/`determineRuntimes()` → interactive prompts (`selectRuntime()`, `selectLocation()`) if TTY → `runInstall()` → `installFilesForRuntime()` → template writing + hook registration + permission injection + VERSION file → `verifyInstallation()` → `displayInstallResults()`.

**Uninstallation Flow**: `runInstaller()` with `-u` flag → `runUninstall()` → `uninstallFilesForRuntime()` → template deletion + hook unregistration + permission removal → runtime-specific cleanup (`cleanupAreSkillDirs()`, `cleanupLegacyGeminiFiles()`) → `deleteConfigFolder()` for local installs → `displayUninstallResults()`.

**Settings.json Manipulation**: Uses `jsonc-parser` functions (`parse()`, `modify()`, `applyEdits()`) with `{ formattingOptions: { tabSize: 2, insertSpaces: true } }` to preserve comments and formatting when modifying Claude Code and Gemini CLI `settings.json` files. Hook registration adds nested structures: Claude uses `{ hooks: [{ type: 'command', command: 'node .claude/hooks/[filename]' }] }` format, Gemini uses flat `{ name: string, type: 'command', command: string }` format. Permission registration merges `ARE_PERMISSIONS` bash patterns into `permissions.allow` array.

**Cross-Runtime Compatibility**: `installFilesForRuntime()` and `uninstallFilesForRuntime()` dispatch to runtime-specific branches: Claude installs to `.claude/commands/` and `.claude/hooks/`, registers hooks and permissions; OpenCode installs to `.opencode/commands/` and `.opencode/plugins/`, skips settings.json (no hook registration); Gemini installs to `.gemini/commands/` (flat namespace) and `.gemini/hooks/`, registers hooks but skips permissions.

## Behavioral Contracts

### Command-Line Flag Parsing

Valid flags recognized by `parseInstallerArgs()`: `-g` (global), `-l` (local), `-u` (uninstall), `-q` (quiet), `-h` (help), `--global`, `--local`, `--runtime <value>`, `--force`, `--quiet`, `--help`, `--uninstall`.

Valid `--runtime` values: `claude`, `opencode`, `gemini`, `all`.

### Permission Strings

`ARE_PERMISSIONS` array (from `operations.ts` and `uninstall.ts`):
```
Bash(npx agents-reverse-engineer@latest init*)
Bash(npx agents-reverse-engineer@latest discover*)
Bash(npx agents-reverse-engineer@latest generate*)
Bash(npx agents-reverse-engineer@latest update*)
Bash(npx agents-reverse-engineer@latest clean*)
Bash(rm -f .agents-reverse-engineer/progress.log*)
Bash(sleep *)
```

### Hook File Patterns

`getHookPatterns(runtimeDir)` returns:
```
node ${runtimeDir}/hooks/are-check-update.js
node hooks/are-check-update.js
node ${runtimeDir}/hooks/are-session-end.js
node hooks/are-session-end.js
```

### ANSI Escape Sequences

`arrowKeySelect()` render function uses:
- `\x1b[${n}A` — move cursor up n lines
- `\x1b[2K` — clear entire line
- `\x1b[1B` — move cursor down one line

### ASCII Art Logo

`displayBanner()` renders:
```
  █████╗ ██████╗ ███████╗
 ██╔══██╗██╔══██╗██╔════╝
 ███████║██████╔╝█████╗  
 ██╔══██║██╔══██╗██╔══╝  
 ██║  ██║██║  ██║███████╗
 ╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝
```

### Environment Variables

Priority order for path resolution:
- Claude: `CLAUDE_CONFIG_DIR` → `~/.claude`
- OpenCode: `OPENCODE_CONFIG_DIR` → `XDG_CONFIG_HOME/opencode` → `~/.config/opencode`
- Gemini: `GEMINI_CONFIG_DIR` → `~/.gemini`

## Integration Points

**Template Sources**: Imports `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` from `../integration/templates.js` to retrieve command/hook file content for installation.

**Version Extraction**: Imports `getVersion()` from `../version.js` for banner display and VERSION file writing.

**Terminal Detection**: Uses `process.stdin.isTTY` boolean to switch between interactive arrow-key selection and numbered fallback for CI/piped environments.

**Process Management**: Registers `process.on('exit')` and `process.on('SIGINT')` handlers via `cleanupRawMode()` to restore terminal state after raw mode usage. Calls `process.exit(1)` for non-interactive validation failures.