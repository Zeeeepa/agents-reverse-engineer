<!-- Generated by agents-reverse-engineer -->

# installer

Executes npx-driven installation/uninstallation workflow for ARE commands and session hooks across Claude Code, Gemini CLI, and OpenCode runtimes, orchestrating interactive prompts with TTY-aware selection UI, file copying to global (`~/.claude`, `~/.gemini`, `~/.config/opencode`) or local (`.claude`, `.gemini`, `.opencode`) directories, settings.json hook/permission registration, and post-installation verification.

## Contents

### Core Entry Points

**[index.ts](./index.ts)** — Main orchestrator implementing `runInstaller(args: InstallerArgs): Promise<InstallerResult[]>`. Parses CLI flags via `parseInstallerArgs()` recognizing `--runtime`, `-g/-l`, `-u`, `--force`, `-q`. Routes to `runInstall()` for file copying + hook registration or `runUninstall()` for artifact deletion + deregistration. Delegates to `selectRuntime()`/`selectLocation()` for interactive prompts when flags omitted. Aggregates `InstallerResult[]` from multi-runtime operations (`runtime === 'all'` expands via `getAllRuntimes()`). Formats output via `displayInstallResults()`/`displayUninstallResults()` showing filesCreated/filesSkipped counts, hookRegistered status, `showNextSteps()` workflow guide.

**[operations.ts](./operations.ts)** — Implements `installFiles(runtime, location, options)` writing command templates via `getTemplatesForRuntime()` to `resolveInstallPath()` with `ensureDir()` directory creation. Installs hooks from bundled `hooks/dist/` via `readBundledHook()` + `writeFileSync()` to runtime hooks/plugins directories. Calls `registerHooks()` mutating settings.json with SessionStart/SessionEnd entries (nested format for Claude: `{ hooks: [{ type, command }] }`, flat format for Gemini: `{ name, type, command }`). Calls `registerPermissions()` appending `ARE_PERMISSIONS` bash patterns to `settings.permissions.allow`. Writes `ARE-VERSION` file via `writeVersionFile()` for update checks. Returns `InstallerResult` with filesCreated/filesSkipped/errors arrays, hookRegistered/versionWritten flags. Provides `verifyInstallation(files)` checking `existsSync()` for post-install validation.

**[uninstall.ts](./uninstall.ts)** — Implements `uninstallFiles(runtime, location, dryRun)` removing command templates, hook/plugin files, settings.json entries via `unregisterHooks()`/`unregisterPermissions()`, and `ARE-VERSION`. Delegates to `uninstallFilesForRuntime()` executing four-step removal: delete templates from `getTemplatesForRuntime()`, remove hooks (`ARE_HOOKS` for Claude/Gemini in `hooks/`, `ARE_PLUGIN_FILENAMES` for OpenCode in `plugins/`), deregister via settings.json filtering matching `getHookPatterns()` command patterns, trigger cleanup via `cleanupAreSkillDirs()`/`cleanupEmptyDirs()`/`cleanupLegacyGeminiFiles()`. Provides `deleteConfigFolder(location, dryRun)` removing `.agents-reverse-engineer/` for local uninstalls. Hook deregistration uses `unregisterClaudeHooks()` filtering `settings.hooks.SessionStart/SessionEnd` arrays by command substring match, `unregisterGeminiHooks()` parallel implementation for `GeminiSettingsJson` schema.

### Path Resolution & Detection

**[paths.ts](./paths.ts)** — Exports `getRuntimePaths(runtime)` returning `RuntimePaths` with global (e.g., `~/.claude`), local (`.claude`), settingsFile (`~/.claude/settings.json`) paths. Implements `resolveInstallPath(runtime, location, projectRoot)` joining global path or local path + projectRoot. Provides `getAllRuntimes()` returning `['claude', 'opencode', 'gemini']`. Exports `isRuntimeInstalledLocally()`/`isRuntimeInstalledGlobally()` checking directory existence via `stat()`, `getInstalledRuntimes(projectRoot)` filtering for installed runtimes. Supports environment overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR` (with `XDG_CONFIG_HOME` fallback), `GEMINI_CONFIG_DIR`.

### Interactive Selection UI

**[prompts.ts](./prompts.ts)** — Exports `isInteractive()` checking `process.stdin.isTTY` for TTY detection. Implements `selectOption<T>(prompt, options)` routing to `arrowKeySelect()` for TTY mode (arrow key navigation with `readline.emitKeypressEvents()`, `process.stdin.setRawMode(true)`, ANSI cursor control) or `numberedSelect()` for non-TTY fallback (numbered list with readline.question()). Provides `selectRuntime(mode)` prompting for `Runtime` selection from `['claude', 'opencode', 'gemini', 'all']`, `selectLocation(mode)` prompting for `Location` from `['global', 'local']`, `confirmAction(message)` returning boolean. Uses module-level `rawModeActive` flag with `cleanupRawMode()` registered via `process.on('exit')` and `process.on('SIGINT')` handlers.

### Output Formatting

**[banner.ts](./banner.ts)** — Exports `displayBanner()` rendering ASCII "ARE" logo with version from `getVersion()`. Provides `showHelp()` printing usage syntax, option flags (`--runtime`, `-g/-l`, `-u`, `--force`, `-q`, `-h`), example invocations. Exports semantic message functions: `showSuccess(msg)` with green checkmark, `showError(msg)` with red X, `showWarning(msg)` with yellow exclamation, `showInfo(msg)` with cyan arrow. Implements `showNextSteps(runtime, filesCreated)` displaying workflow guide invoking ARE skills (`/are-help`, `/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`) and GitHub docs URL.

### Type Definitions

**[types.ts](./types.ts)** — Defines `Runtime` union `'claude' | 'opencode' | 'gemini' | 'all'`, `Location` union `'global' | 'local'`. Exports `InstallerArgs` interface capturing CLI flags: `runtime`, `global`, `local`, `uninstall`, `force`, `help`, `quiet`. Exports `InstallerResult` with `success`, `runtime`, `location`, `filesCreated`, `filesSkipped`, `errors`, `hookRegistered`, `versionWritten`. Exports `RuntimePaths` with `global`, `local`, `settingsFile` fields.

## Architecture

### File Operation Pipeline

**Install Flow:** `runInstaller()` → `parseInstallerArgs()` → `selectRuntime()`/`selectLocation()` → `installFiles()` → `installFilesForRuntime()` → `getTemplatesForRuntime()` + `ensureDir()` + `writeFileSync()` → `registerHooks()`/`registerPermissions()` → `writeVersionFile()` → `verifyInstallation()` → `displayInstallResults()`.

**Uninstall Flow:** `runInstaller()` → `uninstallFiles()` → `uninstallFilesForRuntime()` → `getTemplatesForRuntime()` + `unlinkSync()` → `unregisterHooks()`/`unregisterPermissions()` → `cleanupAreSkillDirs()`/`cleanupEmptyDirs()`/`cleanupLegacyGeminiFiles()` → `deleteConfigFolder()` → `displayUninstallResults()`.

### Runtime-Specific Adaptations

**Claude:** Commands in `.claude/skills/are-*/SKILL.md` with `name: /are-*` frontmatter. Hooks in `.claude/hooks/` as Node.js scripts. Settings.json with nested hook format `{ hooks: [{ type: 'command', command }] }`. Permissions in `settings.permissions.allow` for bash command auto-approval.

**Gemini:** Commands in `.gemini/commands/*.toml` with `description`/`prompt` fields. Hooks in `.gemini/hooks/` as Node.js scripts. Settings.json with flat hook format `{ name, type: 'command', command }`.

**OpenCode:** Commands in `.opencode/commands/*.md` with `agent: build` frontmatter. Plugins in `.opencode/plugins/` as auto-loaded modules exporting async factory functions returning event handlers (`event['session.created']`, `event['session.deleted']`).

### Settings.json Mutation

**Hook Registration:** Parses existing settings.json via `JSON.parse()`, appends hook definitions to `settings.hooks.SessionStart`/`settings.hooks.SessionEnd` arrays, checks duplicates via command string match, writes via `JSON.stringify(settings, null, 2)`.

**Permission Registration:** Appends `ARE_PERMISSIONS` patterns (`npx agents-reverse-engineer@latest [command]*`, `rm -f .agents-reverse-engineer/progress.log*`, `sleep *`) to `settings.permissions.allow`, removes duplicates via `!arr.includes(pattern)` filter.

**Hook Deregistration:** Filters arrays removing entries matching `getHookPatterns(runtimeDir)` (both current `node ${runtimeDir}/hooks/${filename}` and legacy `node hooks/${filename}` formats), cleans empty arrays/objects via zero-length check.

### Cleanup Strategy

**Empty Directory Removal:** `cleanupEmptyDirs(dirPath)` recursively calls `rmdirSync()` on zero-entry directories, terminates at runtime root (`.claude`, `.opencode`, `.gemini`, `.config`) to prevent deletion of user directories.

**Legacy File Migration:** `cleanupLegacyGeminiFiles(commandsDir)` removes old `are-*.md` and `commands/are/*.toml` files from pre-0.4.0 installations.

**Skill Directory Pruning:** `cleanupAreSkillDirs(skillsDir)` iterates entries matching `are-*` prefix, calls `cleanupEmptyDirs()` on each.

### Hook File Bundling

Commands invoke pre-built hooks from `hooks/dist/` (created by `scripts/build-hooks.js` during `npm run build:hooks`). `getBundledHookPath(hookName)` navigates from `dist/installer/operations.js` → project root → `hooks/dist/${hookName}`. `readBundledHook(hookName)` reads content via `readFileSync()`, throws Error if missing.

## Integration Points

**Template Generation:** Consumes `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` from `src/integration/templates.ts` for command file content.

**Version Tracking:** Reads package.json version via `getPackageVersion()` using `import.meta.url` navigation, writes to `ARE-VERSION` for session hook update checks.

**CLI Entry Point:** Invoked from top-level `src/cli/index.ts` via argv pattern matching for `--runtime` flag, otherwise treated as generate/update/clean command.

**Session Hooks:** Installed hooks execute `npx agents-reverse-engineer@latest update --quiet` as detached background process when `git status --porcelain` detects changes (see `hooks/are-session-end.js`). Version checks compare `npm view agents-reverse-engineer version` against cached `ARE-VERSION` (see `hooks/are-check-update.js`).