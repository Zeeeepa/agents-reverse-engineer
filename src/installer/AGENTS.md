<!-- Generated by agents-reverse-engineer -->

# src/installer

Orchestrates npx-based installation of ARE command templates, session hooks, and permissions into Claude Code, OpenCode, and Gemini CLI runtime directories, supporting both global (`~/.claude`) and local (`.claude`) installation modes with interactive prompts and dry-run previews.

## Contents

### Core Entry Points

- **[index.ts](./index.ts)** — Main orchestrator exposing `runInstaller(args: InstallerArgs): Promise<InstallerResult[]>` and `parseInstallerArgs(args: string[]): InstallerArgs` for install/uninstall workflows; dispatches to `runInstall()` or `runUninstall()` based on flags, aggregates results across runtimes, re-exports all public symbols from submodules.

### File Operations

- **[operations.ts](./operations.ts)** — Core installer implementing `installFiles()`, `verifyInstallation()`, `registerHooks()`, and `registerPermissions()`; writes command templates from `getTemplatesForRuntime()`, installs hooks/plugins to runtime-specific directories, updates `settings.json` with `SessionStart`/`SessionEnd` hook entries and `ARE_PERMISSIONS` bash patterns, writes `ARE-VERSION` file.

- **[uninstall.ts](./uninstall.ts)** — Inverse of operations.ts providing `uninstallFiles()`, `unregisterHooks()`, `unregisterPermissions()`, and `deleteConfigFolder()`; removes command templates, filters hook entries from `settings.json`, deletes `.agents-reverse-engineer/` directory for local installs, cleans empty directories via `cleanupEmptyDirs()`, purges legacy Gemini `.toml` files.

### Path Resolution

- **[paths.ts](./paths.ts)** — Cross-platform path resolver exporting `getRuntimePaths(runtime)`, `resolveInstallPath(runtime, location, projectRoot?)`, and `getSettingsPath(runtime)`; reads environment overrides (`CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`), returns `RuntimePaths` with global/local/settingsFile mappings, provides `isRuntimeInstalledLocally()` and `getInstalledRuntimes()` detection.

### User Interaction

- **[prompts.ts](./prompts.ts)** — Interactive prompt system with `selectRuntime()`, `selectLocation()`, and `confirmAction()`; uses `arrowKeySelect()` for TTY mode with `readline.emitKeypressEvents()` and raw mode, falls back to `numberedSelect()` for CI/non-TTY environments, implements `cleanupRawMode()` with global exit handlers.

- **[banner.ts](./banner.ts)** — Terminal output helpers including `displayBanner()` ASCII art, `showHelp()` usage documentation, styled message functions (`showSuccess()`, `showError()`, `showWarning()`, `showInfo()`), `showNextSteps()` post-install guidance, and `getVersion()` package.json reader.

### Type Definitions

- **[types.ts](./types.ts)** — Type definitions for `Runtime` (`'claude' | 'opencode' | 'gemini' | 'all'`), `Location` (`'global' | 'local'`), `InstallerArgs` CLI flags, `InstallerResult` operation outcomes, and `RuntimePaths` filesystem mappings.

## Installation Flow

1. **Argument Parsing** — `parseInstallerArgs()` validates `--runtime`, `-g/--local`, `--force`, `--uninstall`, `--quiet` flags
2. **Interactive Prompts** — If missing required flags and TTY mode detected via `isInteractive()`, calls `selectRuntime()` and `selectLocation()`
3. **Path Resolution** — `resolveInstallPath()` computes target directory using environment overrides and `os.homedir()`
4. **Template Retrieval** — `getTemplatesForRuntime()` fetches command files from `src/integration/templates.ts`
5. **File Operations** — `installFiles()` writes templates, copies bundled hooks via `readBundledHook()`, installs OpenCode plugins
6. **Hook Registration** — `registerClaudeHooks()` or `registerGeminiHooks()` modifies `settings.json` with runtime-specific hook event structures
7. **Permission Setup** — `registerPermissions()` adds `ARE_PERMISSIONS` bash patterns to `settings.permissions.allow[]`
8. **Verification** — `verifyInstallation()` confirms file existence, `displayInstallResults()` shows summary with `showNextSteps()`

## Runtime-Specific Behavior

### Claude Code
- Global path: `~/.claude` (override: `CLAUDE_CONFIG_DIR`)
- Hook format: Nested `HookEvent[]` with `hooks: SessionHook[]` arrays
- Settings: `.claude/settings.json` with `permissions.allow` array
- Commands: `.claude/commands/are-*.md`
- Hooks: `.claude/hooks/are-*.js`

### OpenCode
- Global path: `~/.config/opencode` (XDG-compliant, overrides: `OPENCODE_CONFIG_DIR`, `XDG_CONFIG_HOME`)
- Plugin format: `.opencode/plugins/are-*.js` with `opencode-` prefixed source filenames
- Commands: `.opencode/commands/are-*.js`
- No settings.json hook registration (plugin-only architecture)

### Gemini CLI
- Global path: `~/.gemini` (override: `GEMINI_CONFIG_DIR`)
- Hook format: Flat `GeminiHook[]` with `name`, `type: 'command'`, `command` fields (no nested arrays)
- Settings: `.gemini/settings.json` without permissions field
- Commands: `.gemini/commands/are-*.md`
- Legacy cleanup: Removes old `.toml` files from `.gemini/commands/are/` subdirectory

## Dry Run and Verification

- `InstallOptions.dryRun` flag prevents `writeFileSync()`, `mkdirSync()`, `unlinkSync()` calls while logging intended operations
- `verifyInstallation(files)` checks `existsSync()` for all created files, returns `{ success, missing }` report
- `formatInstallResult()` converts `InstallerResult` to human-readable line array for progress display
- `displayUninstallResults()` repurposes `filesCreated` as deleted files, `filesSkipped` as not-found files

## Bundled Resource Access

- `getBundledHookPath(hookName)` navigates from `dist/installer/operations.js` to project root via `fileURLToPath(import.meta.url)`, resolves `hooks/dist/<hookName>`
- `readBundledHook(hookName)` reads precompiled hook scripts using `readFileSync()`, throws Error if missing
- `ARE_HOOKS` defines `SessionStart`/`SessionEnd` entries for `are-check-update.js` and `are-session-end.js`
- `ARE_PLUGINS` maps `opencode-are-*.js` source filenames to destination plugin paths

## Cross-Module Integration

- Imports command templates from `../integration/templates.js` via `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()`
- Uses `Runtime`, `Location`, `InstallerResult`, `RuntimePaths` type definitions from `./types.js`
- Calls `getAllRuntimes()` to expand `'all'` meta-runtime into concrete runtime array
- Delegates to `resolveInstallPath()` for filesystem path computation with projectRoot fallback to `process.cwd()`