<!-- Generated by agents-reverse-engineer -->

# src/installer

Implements npx-driven interactive installation wizard and uninstallation routines for distributing ARE command templates and session hooks across Claude Code (`~/.claude`), OpenCode (`~/.config/opencode`), and Gemini CLI (`~/.gemini`) runtimes with dual-mode CLI (arrow-key TTY navigation / numbered fallback for CI).

## Contents

**[banner.ts](./banner.ts)** — Exports `displayBanner()` (ASCII "ARE" logo via `pc.green()`, version from `getVersion()`), `showHelp()` (lists `--runtime`, `-g/--global`, `-l/--local`, `-u/--uninstall`, `--force`, `-q/--quiet` flags), status formatters `showSuccess()` / `showError()` / `showWarning()` / `showInfo()` with `✓`, `✗`, `!`, `>` prefixes, and `showNextSteps()` (prints `/are-*` command list).

**[index.ts](./index.ts)** — Orchestrates installation via `runInstaller(args: InstallerArgs)`: parses CLI flags with `parseInstallerArgs()`, dispatches to `selectRuntime()` / `selectLocation()` prompts in interactive mode, routes to `runInstall()` (calls `installFiles()`, `verifyInstallation()`, `displayInstallResults()`) or `runUninstall()` (calls `uninstallFiles()`, `deleteConfigFolder()`, `displayUninstallResults()`). Re-exports all public types and functions from submodules.

**[operations.ts](./operations.ts)** — Implements `installFiles()` writing command templates to `commands/are/`, hooks to `hooks/` (Claude/Gemini) or `plugins/` (OpenCode), ARE-VERSION via `writeVersionFile()`, and `registerHooks()` / `registerPermissions()` manipulating `settings.json` with jsonc-parser's `parse()` / `modify()` / `applyEdits()`. Claude uses nested `{ hooks: [{ type: 'command', command }] }`, Gemini uses flat `[{ name, type: 'command', command }]`. Defines `ARE_PERMISSIONS` Bash command allowlist.

**[paths.ts](./paths.ts)** — Exports `getRuntimePaths(runtime)` resolving global/local config paths with environment overrides (`CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`), `resolveInstallPath(runtime, location, projectRoot)` joining paths for installation targets, `getSettingsPath(runtime)` returning `settings.json` path, and `isRuntimeInstalledLocally()` / `isRuntimeInstalledGlobally()` checking directory existence via `stat()`.

**[prompts.ts](./prompts.ts)** — Provides `selectOption<T>(prompt, options)` dispatching to `arrowKeySelect()` (renders with `\x1b[${n}A` cursor escape, handles `up`/`down`/`return` keypresses via `readline.emitKeypressEvents()` + `setRawMode(true)`) or `numberedSelect()` (prints numbered list, reads via `rl.question()`) based on `isInteractive()` (`process.stdin.isTTY`). Exports `selectRuntime()`, `selectLocation()`, `confirmAction()` wrappers.

**[types.ts](./types.ts)** — Defines `Runtime = 'claude' | 'opencode' | 'gemini' | 'all'`, `Location = 'global' | 'local'`, `InstallerArgs` (parsed CLI flags), `InstallerResult` (success/filesCreated/filesSkipped/errors per operation), `RuntimePaths` (global/local/settingsFile paths).

**[uninstall.ts](./uninstall.ts)** — Implements `uninstallFiles()` removing command templates, hooks, `ARE-VERSION` via `unlinkSync()`, `unregisterHooks()` filtering hook entries from `settings.json`, `unregisterPermissions()` removing `ARE_PERMISSIONS` from allow list, `deleteConfigFolder()` deleting `.agents-reverse-engineer` for local installs, and `cleanupEmptyDirs()` recursively removing empty parent directories.

## Installation Flow

1. **Parse arguments**: `parseInstallerArgs()` in index.ts validates `--runtime <rt>`, `-g/-l` flags into `InstallerArgs`
2. **Resolve runtime/location**: Interactive prompts via prompts.ts `selectRuntime()` / `selectLocation()` or flag-based `determineRuntimes()` / `determineLocation()`
3. **Write files**: operations.ts `installFiles()` → `installFilesForRuntime()` fetches templates via `../integration/templates.js` `getClaudeTemplates()` / `getOpenCodeTemplates()` / `getGeminiTemplates()`, writes to `resolveInstallPath()` result
4. **Register hooks**: operations.ts `registerHooks()` for Claude/Gemini modifies `settings.json` hooks arrays with jsonc-parser, OpenCode auto-loads plugins from `plugins/`
5. **Verify**: `verifyInstallation()` checks all file paths with `existsSync()`, reports missing via `showWarning()`
6. **Display results**: `displayInstallResults()` shows per-runtime success/error counts, calls `showNextSteps()` with command list

## Uninstallation Flow

1. **Remove files**: uninstall.ts `uninstallFiles()` → `uninstallFilesForRuntime()` deletes templates, hooks/plugins, `ARE-VERSION` via `unlinkSync()`
2. **Unregister hooks**: `unregisterHooks()` filters `settings.json` hook arrays by matching `node ${runtimeDir}/hooks/${filename}` patterns
3. **Cleanup directories**: `cleanupEmptyDirs()` recursively removes empty parents until hitting runtime roots (`.claude`, `.opencode`, `.gemini`, `.config`)
4. **Delete config**: `deleteConfigFolder()` removes `.agents-reverse-engineer` for local installs via `rmSync()`

## Behavioral Contracts

### CLI Argument Parsing
```regex
/^--(runtime|force|global|local|uninstall|quiet|help)$/
/^-(g|l|u|f|q|h)$/
```
Supports long (`--runtime <rt>`) and short (`-g`, `-l`) flags. `--runtime` accepts `'claude' | 'opencode' | 'gemini' | 'all'`.

### Hook Registration Formats
Claude (nested):
```json
{ "hooks": { "SessionStart": [{ "hooks": [{ "type": "command", "command": "node .claude/hooks/are-check-update.js" }] }] } }
```
Gemini (flat):
```json
{ "hooks": { "SessionStart": [{ "name": "ARE Update Check", "type": "command", "command": "node .gemini/hooks/are-check-update.js" }] } }
```

### Permission Patterns
```javascript
[
  'Bash(npx agents-reverse-engineer@latest init*)',
  'Bash(npx agents-reverse-engineer@latest discover*)',
  'Bash(npx agents-reverse-engineer@latest generate*)',
  'Bash(npx agents-reverse-engineer@latest update*)',
  'Bash(npx agents-reverse-engineer@latest clean*)',
  'Bash(rm -f .agents-reverse-engineer/progress.log*)',
  'Bash(sleep *)'
]
```

### Hook Unregister Pattern Matching
```javascript
[
  `node ${runtimeDir}/hooks/${filename}`,   // Current format
  `node hooks/${filename}`                  // Legacy format
]
```

### Environment Variable Priority
- Claude: `CLAUDE_CONFIG_DIR` → `~/.claude`
- OpenCode: `OPENCODE_CONFIG_DIR` → `XDG_CONFIG_HOME/opencode` → `~/.config/opencode`
- Gemini: `GEMINI_CONFIG_DIR` → `~/.gemini`

### ANSI Cursor Control (TTY Mode)
```javascript
// Move up N lines
`\x1b[${N}A`
// Clear line and move down
`\x1b[2K\x1b[1B`
```

### Numbered Prompt Validation
```javascript
const num = parseInt(answer, 10);
if (isNaN(num) || num < 1 || num > options.length) {
  throw new Error(`Invalid selection: ${answer}. Expected 1-${options.length}`);
}
```

## Stack

- **Terminal UI**: picocolors@1.1.1 (`pc.green()`, `pc.cyan()`, `pc.bold()`), readline (`emitKeypressEvents()`, `createInterface()`)
- **Config Parsing**: jsonc-parser@3.3.1 (`parse()`, `modify()`, `applyEdits()` preserve JSONC comments)
- **File Operations**: Node.js `fs` (`mkdirSync()`, `writeFileSync()`, `unlinkSync()`, `rmSync()`), `path` (`join()`, `dirname()`)
- **Path Resolution**: `os.homedir()`, `process.stdin.isTTY`, environment variables (`CLAUDE_CONFIG_DIR`, etc.)
- **Template Loading**: `../integration/templates.js` (`getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()`)