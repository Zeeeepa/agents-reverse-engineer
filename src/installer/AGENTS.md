<!-- Generated by agents-reverse-engineer -->

# src/installer

npx installation orchestrator for deploying ARE command templates and session hooks into AI coding assistant runtime directories (`~/.claude`, `~/.config/opencode`, `~/.gemini`), with interactive prompts for missing parameters, parallel multi-runtime support, hook registration in settings.json, and permission preauthorization for Claude Code.

## Contents

### Core Installation Logic

**[operations.ts](./operations.ts)** — Writes command templates from `src/integration/templates.ts` to runtime directories, copies bundled hook files from `hooks/dist/`, registers hooks in `settings.json` via `registerClaudeHooks()`/`registerGeminiHooks()`, writes `ARE-VERSION` file, adds Bash permission patterns to Claude Code allow list. Exports `installFiles()` fan-out across runtimes, `verifyInstallation()` checking file existence via `existsSync()`, `getPackageVersion()` reading from package.json, `formatInstallResult()` for human-readable output.

**[uninstall.ts](./uninstall.ts)** — Removes command templates, hooks, hook registrations from `settings.json`, Bash permission entries from allow list, and `ARE-VERSION` file. Calls `cleanupAreSkillDirs()` deleting empty `are-*` skill directories for Claude, `cleanupLegacyGeminiFiles()` removing pre-TOML `*.md` files, `cleanupEmptyDirs()` recursively deleting empty parent directories stopping at runtime roots. Exports `uninstallFiles()`, `deleteConfigFolder()` for `.agents-reverse-engineer` removal.

**[paths.ts](./paths.ts)** — Resolves runtime installation paths with environment variable overrides (`CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`). Exports `getRuntimePaths()` returning `RuntimePaths` objects with `global`/`local`/`settingsFile` fields, `resolveInstallPath()` joining runtime paths with project root, `isRuntimeInstalledLocally()`/`isRuntimeInstalledGlobally()` existence checks via `stat()`.

### Workflow Orchestration

**[index.ts](./index.ts)** — Parses CLI args via `parseInstallerArgs()` supporting `-g`/`--global`, `-l`/`--local`, `--runtime`, `--force`, `-u`/`--uninstall`, `-q`/`--quiet`, dispatches to `runInstall()`/`runUninstall()` after resolving runtime and location via `determineRuntimes()`/`determineLocation()` with interactive prompt fallback. Calls `verifyInstallation()` checking created file existence, formats results via `displayInstallResults()`/`displayUninstallResults()` showing file counts, hook registration status, and `showNextSteps()` with ARE command list. Exits with code 1 in non-interactive mode when required flags missing.

**[prompts.ts](./prompts.ts)** — Arrow-key selection in TTY mode via `arrowKeySelect()` with `readline.emitKeypressEvents()`, numbered fallback via `numberedSelect()` for non-TTY. Exports `selectRuntime()` prompting for `'claude'`/`'opencode'`/`'gemini'`/`'all'`, `selectLocation()` for `'global'`/`'local'`, `confirmAction()` for yes/no prompts, `isInteractive()` checking `process.stdin.isTTY`. Enforces raw mode cleanup via `cleanupRawMode()` in try/finally blocks and process exit handlers (`'exit'`, `'SIGINT'`) preventing terminal state corruption.

### Display Formatting

**[banner.ts](./banner.ts)** — Styled terminal output with ASCII art "ARE" logo in green via `pc.green()`, version footer via `getVersion()`, usage instructions with `pc.bold()` section headers covering CLI options and example invocations. Exports `displayBanner()`, `showHelp()`, `showNextSteps()` listing ARE commands (`/are-help`, `/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`) in cyan, message helpers `showSuccess()`/`showError()`/`showWarning()`/`showInfo()` with prefixed symbols.

### Type Definitions

**[types.ts](./types.ts)** — Defines `Runtime = 'claude' | 'opencode' | 'gemini' | 'all'`, `Location = 'global' | 'local'`, `InstallerArgs` interface with boolean flags and optional runtime field, `InstallerResult` interface tracking `filesCreated[]`, `filesSkipped[]`, `errors[]`, `hookRegistered`, `versionWritten`, `RuntimePaths` interface with `global`/`local`/`settingsFile` path strings.

## Installation Flow

1. **Argument Parsing** — `parseInstallerArgs()` extracts flags, validates `--runtime` against `['claude', 'opencode', 'gemini', 'all']`
2. **Interactive Prompts** — `determineLocation()` calls `selectLocation()` if both/neither `-g`/`-l` set, `determineRuntimes()` calls `selectRuntime()` if `--runtime` missing
3. **Path Resolution** — `resolveInstallPath()` combines `getRuntimePaths(runtime)` with project root for local installs, uses global path for `-g`
4. **File Operations** — `installFilesForRuntime()` calls `getTemplatesForRuntime()` from `src/integration/templates.ts`, writes templates via `ensureDir()` → `writeFileSync()`, copies hooks from `hooks/dist/` via `readBundledHook()` → `writeFileSync()`
5. **Hook Registration** — `registerHooks()` dispatches to `registerClaudeHooks()` or `registerGeminiHooks()`, merges hooks into `settings.json` under `hooks.SessionStart`/`hooks.SessionEnd`, writes ARE Bash permission patterns via `registerPermissions()` for Claude only
6. **Verification** — `verifyInstallation()` checks all file paths via `existsSync()`, reports `missing[]` array for absent files
7. **Display Results** — `displayInstallResults()` accumulates `totalCreated`/`totalSkipped`/`hooksRegistered` counters, calls `showNextSteps()` with ARE command list unless `--quiet` flag set

## Uninstallation Flow

1. **File Deletion** — `uninstallFilesForRuntime()` reads templates for path extraction, deletes command files and hooks via `unlinkSync()`, removes `ARE-VERSION` file
2. **Hook Cleanup** — `unregisterHooks()` filters `settings.json` event arrays removing hooks matching `getHookPatterns()` for current (`node ${runtimeDir}/hooks/${filename}`) and legacy (`node hooks/${filename}`) formats, deletes empty event arrays and empty `hooks` object
3. **Permission Cleanup** — `unregisterPermissions()` filters `permissions.allow` removing all `ARE_PERMISSIONS` entries, cleans up empty `permissions.allow`/`permissions` structures
4. **Directory Cleanup** — `cleanupAreSkillDirs()` removes empty `are-*` skill subdirectories for Claude, `cleanupLegacyGeminiFiles()` deletes pre-TOML `*.md` files and nested `are/*.toml` files, `cleanupEmptyDirs()` recursively deletes empty parents stopping at runtime roots (`.claude`, `.opencode`, `.gemini`, `.config`)
5. **Config Removal** — `deleteConfigFolder()` removes `.agents-reverse-engineer` directory for local installs via `rmSync({ recursive: true, force: true })`

## Runtime-Specific Behaviors

**Claude Code:**
- Installs to `~/.claude` (global) or `.claude` (local), overridable via `CLAUDE_CONFIG_DIR`
- Registers hooks in nested format: `settings.hooks[event] = [{ hooks: [{ type: 'command', command: string }] }]`
- Adds five Bash permission patterns to `settings.permissions.allow`: `Bash(npx agents-reverse-engineer@latest init*)`, `discover*`, `generate*`, `update*`, `clean*`
- Cleans up skill directories matching `are-*` prefix during uninstall

**OpenCode:**
- Installs to `~/.config/opencode` (global) or `.opencode` (local), respects `OPENCODE_CONFIG_DIR` → `XDG_CONFIG_HOME/opencode` → default fallback chain
- Copies plugins to `plugins/` directory (auto-loaded by OpenCode runtime)
- No settings.json registration (plugin system auto-discovers)
- Supports plugin filenames: `are-check-update.js`, `are-session-end.js`

**Gemini:**
- Installs to `~/.gemini` (global) or `.gemini` (local), overridable via `GEMINI_CONFIG_DIR`
- Registers hooks in flat format: `settings.hooks[event] = [{ name: string, type: 'command', command: string }]`
- Cleans up legacy files during uninstall: `are-*.md` (pre-TOML commands), `are/*.toml` (pre-flat structure)

## Behavioral Contracts

**Hook Command Pattern:**
```
Current: node ${runtimeDir}/hooks/${filename}
Legacy:  node hooks/${filename}
```

**Permission Pattern:**
```
Bash(npx agents-reverse-engineer@latest <command>*)
```

**Settings JSON Indentation:**
```javascript
JSON.stringify(settings, null, 2)  // 2-space indent
```

**Runtime Root Basenames (recursion stop):**
```
.claude, .opencode, .gemini, .config
```

**Hook File Sources:**
```
hooks/dist/are-check-update.js
hooks/dist/are-session-end.js
hooks/dist/opencode-are-check-update.js
hooks/dist/opencode-are-session-end.js
```

**Version File Location:**
```
${basePath}/ARE-VERSION
```