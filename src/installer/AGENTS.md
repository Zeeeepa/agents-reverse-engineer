<!-- Generated by agents-reverse-engineer -->

# src/installer

Implements ARE CLI installer that copies command templates, hooks, and plugins to Claude Code (~/.claude), OpenCode (~/.config/opencode), and Gemini CLI (~/.gemini) runtime directories with support for global/local installations, hook registration in settings.json, and uninstallation workflows.

## Contents

### Entry Point and Orchestration

**[index.ts](./index.ts)** — exports `runInstaller(args: InstallerArgs)` which parses CLI arguments (`--runtime`, `-g`/`--global`, `-l`/`--local`, `--force`, `--uninstall`, `--quiet`), dispatches to `runInstall()` or `runUninstall()` based on `args.uninstall`, and returns `InstallerResult[]` array. Delegates interactive prompts to `selectRuntime()` and `selectLocation()` when TTY detected, enforces non-interactive mode exits when flags missing. Re-exports all types from `types.ts`, path resolution from `paths.ts`, and UI functions from `banner.ts`.

### Installation Operations

**[operations.ts](./operations.ts)** — exports `installFiles(runtime, location, options)` which writes command templates via `getTemplatesForRuntime()` to `commands/are/` subdirectories, copies bundled hooks from `hooks/dist/` to runtime-specific directories (`hooks/` for Claude/Gemini, `plugins/` for OpenCode), registers hooks in settings.json via `registerClaudeHooks()` or `registerGeminiHooks()` using jsonc-parser, adds bash command permissions via `registerPermissions()`, and writes `ARE-VERSION` file. Hook registration uses nested structure `settings.hooks.SessionStart = [{ hooks: [{ type: 'command', command: 'node .claude/hooks/are-check-update.js' }] }]` for Claude, flat structure `settings.hooks.SessionStart = [{ name: 'ARE Check Update', type: 'command', command: 'node .gemini/hooks/are-check-update.js' }]` for Gemini. All session hooks currently disabled (commented out in `ARE_HOOKS` constant). Returns `InstallerResult` with `filesCreated`, `filesSkipped`, `hookRegistered`, `versionWritten` fields.

**[uninstall.ts](./uninstall.ts)** — exports `uninstallFiles(runtime, location, dryRun)` which removes command templates via `getTemplatesForRuntime()`, deletes hook files matching `ARE_HOOKS` definitions (`are-check-update.js`, `are-session-end.js`) from `hooks/` or `plugins/` directories, removes `ARE-VERSION` file, cleans up empty `are-*` skill directories via `cleanupAreSkillDirs()`, recursively deletes empty parent directories via `cleanupEmptyDirs()`, and removes legacy Gemini TOML files via `cleanupLegacyGeminiFiles()`. Exports `unregisterHooks(basePath, runtime, dryRun)` which filters hook arrays in settings.json by matching patterns from `getHookPatterns()` (includes both current `node .claude/hooks/` and legacy `node hooks/` formats). Exports `deleteConfigFolder(location, dryRun)` which removes `.agents-reverse-engineer` directory for local installations only via `rmSync()`.

### Path Resolution

**[paths.ts](./paths.ts)** — exports `getRuntimePaths(runtime)` returning `RuntimePaths` object with `global` (`~/.claude`, `~/.config/opencode`, `~/.gemini`), `local` (`.claude`, `.opencode`, `.gemini`), and `settingsFile` paths. Applies environment variable overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR` take precedence over defaults, `XDG_CONFIG_HOME` affects OpenCode path. Exports `resolveInstallPath(runtime, location, projectRoot)` which combines `getRuntimePaths()` with `location` to return absolute installation directory. Exports `isRuntimeInstalledLocally(runtime, projectRoot)` and `isRuntimeInstalledGlobally(runtime)` which check directory existence via `stat()`.

### Interactive Prompts

**[prompts.ts](./prompts.ts)** — exports `selectRuntime(mode)`, `selectLocation(mode)`, `confirmAction(message)` which dispatch to `arrowKeySelect()` when `isInteractive()` returns true, otherwise `numberedSelect()` for CI environments. `arrowKeySelect()` uses `readline.emitKeypressEvents()`, `process.stdin.setRawMode(true)`, handles `up`/`down` arrow keys to navigate, `return` to select, renders with ANSI escape sequences `\x1b[${lines}A` (cursor up), `\x1b[2K\x1b[1B` (clear line, move down). `numberedSelect()` prints numbered list, reads line via `readline.createInterface()`, parses input with `parseInt()`, rejects invalid selections. Exports `cleanupRawMode()` which restores `process.stdin.setRawMode(false)` and pauses stdin, registered on `process.on('exit')` and `SIGINT`.

### UI Formatting

**[banner.ts](./banner.ts)** — exports `displayBanner()` which prints ASCII art "ARE" logo in green via `pc.green()` with version from `getVersion()` and tagline. Exports `showHelp()` listing flags `--runtime <runtime>`, `-g`/`--global`, `-l`/`--local`, `-u`/`--uninstall`, `--force`, `-q`/`--quiet`, `-h`/`--help` with example invocations. Exports `showSuccess(msg)`, `showError(msg)`, `showWarning(msg)`, `showInfo(msg)` prefixing with `✓` (green), `✗` (red), `!` (yellow), `>` (cyan) respectively. Exports `showNextSteps(runtime, filesCreated)` listing commands `/are-help`, `/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean` in cyan with GitHub docs URL.

### Type Definitions

**[types.ts](./types.ts)** — defines `Runtime = 'claude' | 'opencode' | 'gemini' | 'all'`, `Location = 'global' | 'local'`, `InstallerArgs` with `runtime?`, `global`, `local`, `uninstall`, `force`, `help`, `quiet` flags, `InstallerResult` with `success`, `runtime`, `location`, `filesCreated`, `filesSkipped`, `errors`, `hookRegistered?`, `versionWritten?` fields, and `RuntimePaths` with `global`, `local`, `settingsFile` paths.

## Architecture

### Runtime Target Resolution

Installation flow: `index.ts:parseInstallerArgs()` → `index.ts:determineLocation()` / `prompts.ts:selectLocation()` → `index.ts:determineRuntimes()` → `operations.ts:installFiles()` → `operations.ts:installFilesForRuntime()` → `paths.ts:resolveInstallPath()`. The `Runtime = 'all'` expands to `['claude', 'opencode', 'gemini']` via `paths.ts:getAllRuntimes()`, triggering parallel installations.

### Settings.json Manipulation

Hook registration uses jsonc-parser functions: `parse(settingsContent)` → `modify(parsedJson, ['hooks', event], newHookArray, {})` → `applyEdits(settingsContent, edits)`. Claude format nests hooks under `{ hooks: SessionHook[] }` event entries, Gemini uses flat `GeminiHook[]` arrays. OpenCode auto-loads plugins from `~/.config/opencode/plugins/` directory without settings.json registration.

### Permission Registration

`operations.ts:registerPermissions()` merges `ARE_PERMISSIONS` array into `settings.permissions.allow[]` field for Claude Code only. Current permissions allow `Bash(npx agents-reverse-engineer@latest init*)`, `Bash(npx agents-reverse-engineer@latest discover*)`, `Bash(npx agents-reverse-engineer@latest generate*)`, `Bash(npx agents-reverse-engineer@latest update*)`, `Bash(npx agents-reverse-engineer@latest clean*)`, `Bash(rm -f .agents-reverse-engineer/progress.log*)`, `Bash(sleep *)`. Uninstallation removes matching entries via array filter.

## Behavioral Contracts

### CLI Argument Patterns

`index.ts:parseInstallerArgs()` recognizes flags:
- Short form: `-g`, `-l`, `-h`, `-q`, `-u`
- Long form: `--global`, `--local`, `--help`, `--quiet`, `--uninstall`, `--force`
- Value flag: `--runtime <runtime>` where `<runtime> ∈ ['claude', 'opencode', 'gemini', 'all']`

Validation rejects unknown `--runtime` values with error message listing valid options.

### Hook Command Formats

Claude Code hook command: `node .claude/hooks/${filename}`  
Gemini CLI hook command: `node .gemini/hooks/${filename}`  
OpenCode plugin path: `~/.config/opencode/plugins/${filename}`

Legacy uninstall patterns include `node hooks/${filename}` (pre-runtime-prefix format).

### Directory Cleanup Rules

`uninstall.ts:cleanupEmptyDirs()` stops at sentinel directories: `.claude`, `.opencode`, `.gemini`, `.config`. Recursively removes parent directories only when `readdirSync(parentDir).length === 0`.

### Environment Variable Precedence

Claude: `CLAUDE_CONFIG_DIR` > `~/.claude`  
OpenCode: `OPENCODE_CONFIG_DIR` > `XDG_CONFIG_HOME/opencode` > `~/.config/opencode`  
Gemini: `GEMINI_CONFIG_DIR` > `~/.gemini`

## File Relationships

**operations.ts** depends on **paths.ts** for `resolveInstallPath()`, **types.ts** for `Runtime`/`Location`/`InstallerResult`, **../integration/templates.js** for `getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()`.

**uninstall.ts** mirrors **operations.ts** dependencies, shares `ARE_HOOKS` constant structure, reuses path resolution via **paths.ts**.

**index.ts** orchestrates all modules: delegates path resolution to **paths.ts**, UI to **banner.ts**, prompts to **prompts.ts**, installation to **operations.ts**, uninstallation to **uninstall.ts**.

**prompts.ts** reads `process.stdin.isTTY` to dispatch between `arrowKeySelect()` (TTY mode) and `numberedSelect()` (CI mode), ensuring consistent interface across environments.

**banner.ts** imports `getVersion()` from `../version.ts` to display current ARE version in banner.