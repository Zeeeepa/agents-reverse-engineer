<!-- Generated by agents-reverse-engineer -->

# src/installer

The installer directory implements the npx-driven installation workflow for agents-reverse-engineer, deploying command templates, session hooks, and configuration to Claude Code, OpenCode, and Gemini CLI environments through both interactive prompts and non-interactive CLI flags.

## Contents

### Core Entry Point

[index.ts](./index.ts) — main orchestrator exporting `runInstaller()`, `parseInstallerArgs()`, `determineLocation()`, `determineRuntimes()`, `runInstall()`, `runUninstall()`, `displayInstallResults()`, `displayUninstallResults()`; parses CLI arguments (`--runtime`, `-g`/`--global`, `-l`/`--local`, `--force`, `-q`/`--quiet`, `-h`/`--help`), dispatches to interactive prompts or direct execution, calls `installFiles()`/`uninstallFiles()`, invokes `verifyInstallation()`, displays summaries, routes to `showNextSteps()` on success.

### Installation & Removal

[operations.ts](./operations.ts) — implements `installFiles()`, `installFilesForRuntime()`, `verifyInstallation()`, `registerHooks()`, `registerPermissions()`, `registerClaudeHooks()`, `registerGeminiHooks()`, `getPackageVersion()`, `writeVersionFile()`, `formatInstallResult()`; copies command templates from `getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()`, reads bundled hooks via `getBundledHookPath()` and `readBundledHook()`, writes to resolved paths from `resolveInstallPath()`, merges hooks into `settings.json` with nested `HookEvent.hooks[]` structure for Claude or flat `GeminiHook[]` for Gemini, adds bash permission patterns to Claude `settings.permissions.allow` array, writes VERSION marker file.

[uninstall.ts](./uninstall.ts) — implements `uninstallFiles()`, `uninstallFilesForRuntime()`, `unregisterHooks()`, `unregisterClaudeHooks()`, `unregisterGeminiHooks()`, `unregisterPermissions()`, `deleteConfigFolder()`, `cleanupAreSkillDirs()`, `cleanupEmptyDirs()`, `cleanupLegacyGeminiFiles()`; removes command templates, hooks, plugins, VERSION files, filters hook arrays by pattern matching against `getHookPatterns()` (matches both current `node ${runtimeDir}/hooks/${filename}` and legacy `node hooks/${filename}` formats), deletes `ARE_PERMISSIONS` entries from `settings.json`, recursively removes empty directories up to runtime root, cleans up `.agents-reverse-engineer` directory for local uninstalls, removes obsolete `are-*.md` and nested `are/*.toml` files from old Gemini layouts.

### Path Resolution

[paths.ts](./paths.ts) — exports `getRuntimePaths()`, `resolveInstallPath()`, `getSettingsPath()`, `getAllRuntimes()`, `isRuntimeInstalledLocally()`, `isRuntimeInstalledGlobally()`, `getInstalledRuntimes()`; resolves global paths with environment variable precedence (`CLAUDE_CONFIG_DIR` → `~/.claude`, `OPENCODE_CONFIG_DIR` → `XDG_CONFIG_HOME/opencode` → `~/.config/opencode`, `GEMINI_CONFIG_DIR` → `~/.gemini`), resolves local paths as relative `.claude`/`.opencode`/`.gemini`, returns `RuntimePaths` with `global`, `local`, `settingsFile` fields, checks directory existence via `stat()`.

### User Interaction

[prompts.ts](./prompts.ts) — exports `selectRuntime()`, `selectLocation()`, `confirmAction()`, `isInteractive()`, `selectOption()`, `arrowKeySelect()`, `numberedSelect()`; dispatches to arrow-key navigation in TTY mode (raw mode with `readline.emitKeypressEvents()`, ANSI escape sequences `\x1b[${N}A`, `\x1b[2K`, `\x1b[1B`, cyan highlighting via `pc.cyan()`), falls back to numbered list input via `readline.createInterface()` in non-interactive environments, registers cleanup handlers for `process.on('exit')` and `process.on('SIGINT')` to restore terminal via `setRawMode(false)`.

[banner.ts](./banner.ts) — exports `displayBanner()`, `showHelp()`, `showSuccess()`, `showError()`, `showWarning()`, `showInfo()`, `showNextSteps()`, `VERSION`; renders ASCII art "ARE" with `pc.green()`, prints version string via `getVersion()` from `../version.js`, displays usage flags and examples, prefixes messages with colored symbols (`✓`, `✗`, `!`, `>`), shows seven-step post-install instruction list (`/are-help`, `/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`) followed by GitHub docs link `https://github.com/GeoloeG-IsT/agents-reverse-engineer`.

### Type Definitions

[types.ts](./types.ts) — defines `Runtime` (`'claude' | 'opencode' | 'gemini' | 'all'`), `Location` (`'global' | 'local'`), `InstallerArgs` (CLI flags: `runtime`, `global`, `local`, `uninstall`, `force`, `help`, `quiet`), `InstallerResult` (outcome fields: `success`, `runtime`, `location`, `filesCreated`, `filesSkipped`, `errors`, `hookRegistered`, `versionWritten`), `RuntimePaths` (resolved paths: `global`, `local`, `settingsFile`).

## Workflow Integration

Imports command template generators from `../integration/templates.js` (`getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()`), reads version via `getVersion()` from `../version.js`.

## Behavioral Contracts

### Runtime Selection Options
```typescript
{ label: 'Claude Code', value: 'claude' }
{ label: 'OpenCode', value: 'opencode' }
{ label: 'Gemini CLI', value: 'gemini' }
{ label: 'All runtimes', value: 'all' }
```

### Location Selection Options
```typescript
{ label: 'Global (~/.claude, ~/.config/opencode, etc.)', value: 'global' }
{ label: 'Local (./.claude, ./.opencode, etc.)', value: 'local' }
```

### Hook Definitions (operations.ts, uninstall.ts)
```typescript
ARE_HOOKS: [
  { event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' },
  { event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }
]
```

### Plugin Definitions (operations.ts)
```typescript
ARE_PLUGINS: [
  { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' },
  // { srcFilename: 'opencode-are-session-end.js', destFilename: 'are-session-end.js' } // disabled
]
```

### Permission Patterns (operations.ts, uninstall.ts)
```typescript
ARE_PERMISSIONS: [
  'Bash(npx agents-reverse-engineer@latest init*)',
  'Bash(npx agents-reverse-engineer@latest discover*)',
  'Bash(npx agents-reverse-engineer@latest generate*)',
  'Bash(npx agents-reverse-engineer@latest update*)',
  'Bash(npx agents-reverse-engineer@latest clean*)',
  'Bash(rm -f .agents-reverse-engineer/progress.log*)',
  'Bash(sleep *)'
]
```

### Hook Command Patterns (uninstall.ts)
```typescript
// Current format
`node ${runtimeDir}/hooks/${filename}`
// Legacy format (for backward compatibility)
`node hooks/${filename}`
```

## Settings.json Structure

### Claude Code Format
```typescript
{
  hooks?: {
    SessionStart?: HookEvent[], // HookEvent: { hooks: SessionHook[] }
    SessionEnd?: HookEvent[]    // SessionHook: { type: 'command', command: string }
  },
  permissions?: {
    allow?: string[],
    deny?: string[]
  }
}
```

### Gemini CLI Format
```typescript
{
  hooks?: {
    SessionStart?: GeminiHook[], // GeminiHook: { name: string, type: 'command', command: string }
    SessionEnd?: GeminiHook[]
  }
}
```

## Non-Interactive Mode Requirements

`runInstaller()` exits with code 1 if `isInteractive()` returns false and either `--runtime` or location flags (`-g`/`-l`) are missing, displaying errors: `'Missing --runtime flag (required in non-interactive mode)'` or `'Missing -g/--global or -l/--local flag (required in non-interactive mode)'`.