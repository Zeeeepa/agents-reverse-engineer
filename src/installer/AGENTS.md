<!-- Generated by agents-reverse-engineer -->

# src/installer/

**npx-driven installer orchestrating IDE command/hook deployment across Claude Code, OpenCode, and Gemini CLI with interactive prompts, platform-specific settings.json registration, detached version-check processes, and recursive empty directory cleanup.**

## Contents

### [banner.ts](./banner.ts)
ASCII art rendering and terminal output styling. `displayBanner()` renders 7-line "ARE" logo with version string, `showHelp()` prints usage with cyan-highlighted examples, `showSuccess()`/`showError()`/`showWarning()`/`showInfo()` output prefixed symbols (`✓`/`✗`/`!`/`>`), `showNextSteps()` displays numbered command list with `/are-*` shortcuts.

### [index.ts](./index.ts)
Main entry point orchestrating install/uninstall workflow. `runInstaller()` parses CLI args, displays banner, prompts for missing runtime/location in interactive mode, enforces non-interactive requirements (`--runtime` + `-g/-l` flags mandatory when `!isInteractive()`), dispatches to `runInstall()`/`runUninstall()`, aggregates results. `parseInstallerArgs()` handles short/long flags (`-g`/`--global`, `-h`/`--help`).

### [operations.ts](./operations.ts)
File copying, hook registration, permission configuration. `installFilesForRuntime()` writes command templates to `${basePath}/${relativePath}`, copies hooks from bundled `hooks/dist/`, calls `registerClaudeHooks()`/`registerGeminiHooks()` with nested `HookEvent.hooks[]` or flat `GeminiHook[]` schemas, adds `ARE_PERMISSIONS` patterns to Claude `settings.json`, writes `ARE-VERSION` file. `getPackageVersion()` reads package.json via `fileURLToPath(import.meta.url)`.

### [paths.ts](./paths.ts)
Cross-platform path resolution with environment overrides. `getRuntimePaths()` returns `{ global, local, settingsFile }` applying `CLAUDE_CONFIG_DIR`/`OPENCODE_CONFIG_DIR`/`GEMINI_CONFIG_DIR` precedence, `resolveInstallPath()` joins project root with local paths (`.claude`/`.opencode`/`.gemini`), `isRuntimeInstalledLocally()`/`isRuntimeInstalledGlobally()` check directory existence via `stat()`.

### [prompts.ts](./prompts.ts)
Interactive selection with arrow-key navigation or numbered fallback. `arrowKeySelect()` enables raw mode (`process.stdin.setRawMode(true)`), listens for `key.name === 'up'|'down'|'return'`, re-renders with ANSI escape sequences (`\x1b[${n}A` cursor up, `\x1b[2K` clear line). `numberedSelect()` prints 1-indexed list for non-TTY. `cleanupRawMode()` registered on `process.on('exit')` and `SIGINT`.

### [types.ts](./types.ts)
Interface definitions for installer workflow. `InstallerArgs` with `runtime?: Runtime`, `global/local/uninstall/force/help/quiet: boolean`. `InstallerResult` with `success`, `runtime: Exclude<Runtime, 'all'>`, `filesCreated[]`, `filesSkipped[]`, `errors[]`, `hookRegistered?`, `versionWritten?`. `RuntimePaths` with `global/local/settingsFile` strings.

### [uninstall.ts](./uninstall.ts)
Artifact removal and hook deregistration. `uninstallFilesForRuntime()` deletes command templates, hooks/plugins, `ARE-VERSION` file, calls `unregisterClaudeHooks()`/`unregisterGeminiHooks()` filtering `settings.json` by `getHookPatterns()` (current + legacy formats), `unregisterPermissions()` removes `ARE_PERMISSIONS` from Claude `permissions.allow[]`. `cleanupEmptyDirs()` recursively removes directories via `rmdirSync()`. `cleanupLegacyGeminiFiles()` deletes pre-TOML `are-*.md` and old TOML subdirectories.

## Installation Workflow

**Interactive mode (TTY):** `runInstaller()` displays banner → prompts for runtime via `selectRuntime()` (options: claude/opencode/gemini/all) → prompts for location via `selectLocation()` (global: `~/.claude`, local: `./.claude`) → confirms action → dispatches.

**Non-interactive mode (CI):** requires `--runtime <value>` and `-g`/`-l` flags, exits with error via `showError()` + `process.exit(1)` if missing.

**Installation:** `runInstall()` calls `installFiles()` → `installFilesForRuntime()` copies templates from `getTemplatesForRuntime()` to `${basePath}/${relativePath}` (path component after runtime prefix), reads bundled hooks from `hooks/dist/${filename}` via `readBundledHook()`, writes to `${basePath}/hooks/` or `${basePath}/plugins/`, updates `settings.json` with hook/permission entries, writes `ARE-VERSION` from `getPackageVersion()`.

**Uninstallation:** `runUninstall()` calls `uninstallFiles()` → `uninstallFilesForRuntime()` deletes files, unregisters hooks by filtering `settings.json` arrays with `getHookPatterns()` (matches current `node ${runtimeDir}/hooks/${filename}` and legacy `node hooks/${filename}` formats), removes permissions, deletes empty directories via `cleanupEmptyDirs()`, calls `deleteConfigFolder()` for local installs.

## Settings.json Hook Registration

**Claude Code format (nested structure):**
```json
{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          { "type": "command", "command": "node ~/.claude/hooks/are-check-update.js" }
        ]
      }
    ]
  }
}
```
Schema: `SettingsJson.hooks[event]` contains `HookEvent[]` where each `HookEvent` has `hooks: SessionHook[]` array with `{ type: 'command', command: string }` entries.

**Gemini CLI format (flat structure):**
```json
{
  "hooks": {
    "SessionStart": [
      { "name": "are-check-update", "type": "command", "command": "node ~/.gemini/hooks/are-check-update.js" }
    ]
  }
}
```
Schema: `GeminiSettingsJson.hooks[event]` contains flat `GeminiHook[]` array with `{ name: string, type: 'command', command: string }` entries.

**OpenCode (plugin system):** Copies `ARE_PLUGINS` files (`opencode-are-check-update.js` → `are-check-update.js`) to `${basePath}/plugins/`, sets `hookRegistered = true` without settings.json modification.

## Behavioral Contracts

**Hook definitions (operations.ts):**
- `ARE_HOOKS: HookDefinition[]` currently empty (commented: "causing issues")
- Intended entries: `{ event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' }`, `{ event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }`

**Plugin definitions (operations.ts):**
- `ARE_PLUGINS: PluginDefinition[]` with one active entry: `{ srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' }`
- Commented: `{ srcFilename: 'opencode-are-session-end.js', destFilename: 'are-session-end.js' }`

**Permission patterns (operations.ts):**
```javascript
ARE_PERMISSIONS = [
  'Bash(npx agents-reverse-engineer@latest init*)',
  'Bash(npx agents-reverse-engineer@latest discover*)',
  'Bash(npx agents-reverse-engineer@latest generate*)',
  'Bash(npx agents-reverse-engineer@latest update*)',
  'Bash(npx agents-reverse-engineer@latest clean*)',
  'Bash(rm -f .agents-reverse-engineer/progress.log*)',
  'Bash(sleep *)'
]
```

**Bundled hook paths:** `__dirname/../../hooks/dist/${hookName}` where `__dirname` from `fileURLToPath(import.meta.url)`, built via `scripts/build-hooks.js` during `npm run build:hooks`.

**Environment variable precedence:**
- Claude: `CLAUDE_CONFIG_DIR` overrides `~/.claude`
- OpenCode: `OPENCODE_CONFIG_DIR` overrides `XDG_CONFIG_HOME/opencode` overrides `~/.config/opencode`
- Gemini: `GEMINI_CONFIG_DIR` overrides `~/.gemini`

**ANSI escape sequences (prompts.ts):**
- `\x1b[${n}A` — cursor up n lines
- `\x1b[1B` — cursor down 1 line
- `\x1b[2K` — clear entire line

**Keypress matching (prompts.ts):** `key.name === 'up' | 'down' | 'return'`, interrupt via `key.ctrl && key.name === 'c'`.

## File System Conventions

**Template path extraction:** Remove runtime prefix via `template.path.split('/').slice(1).join('/')`, e.g., `.claude/commands/are/generate.md` → `commands/are/generate.md`.

**Installation paths:**
- Commands: `${basePath}/${relativePath}`
- Hooks: `${basePath}/hooks/${filename}` (Claude/Gemini)
- Plugins: `${basePath}/plugins/${destFilename}` (OpenCode)
- Settings: `${basePath}/settings.json`
- Version: `${basePath}/ARE-VERSION`

**Config folder:** `.agents-reverse-engineer` deleted only for local uninstalls via `deleteConfigFolder(location === 'local', dryRun)`.

## Error Handling

File write failures append to `errors[]` with format `"Failed to write ${fullPath}: ${err}"`. JSON parse failures in hook registration silently reset settings to `{}`. Missing bundled hooks throw Error in `readBundledHook()`. Directory cleanup ignores errors via empty catch blocks. `rmSync()` uses `{ recursive: true, force: true }` for graceful missing path handling. `InstallerResult.success = errors.length === 0`.

## Dependencies

**Core modules:** `node:os` (homedir), `node:path` (join/dirname), `node:fs` (writeFileSync/readFileSync/unlinkSync/mkdirSync/readdirSync/rmdirSync/rmSync/existsSync), `node:fs/promises` (stat), `node:url` (fileURLToPath).

**External libraries:** `picocolors` (ANSI colors: green/red/yellow/cyan/dim/bold), `readline` (keypress events/interface creation).

**Internal imports:**
- `../version.js` → getVersion (banner.ts)
- `../integration/templates.js` → getClaudeTemplates/getOpenCodeTemplates/getGeminiTemplates (operations.ts, uninstall.ts)
- `./paths.js` → getRuntimePaths/resolveInstallPath/getAllRuntimes (operations.ts, uninstall.ts, index.ts)
- `./types.js` → Runtime/Location/InstallerArgs/InstallerResult/RuntimePaths (all files)
- `./banner.js` → display functions (index.ts)
- `./prompts.js` → selectRuntime/selectLocation/confirmAction/isInteractive (index.ts)