<!-- Generated by agents-reverse-engineer -->

# src/installer

Implements npx-driven interactive installer for deploying ARE command templates, session hooks, and permissions to runtime-specific directories (`.claude/`, `.opencode/`, `.gemini/`) with support for global (`~/.claude`) and local (`./.claude`) installation modes, TTY-aware prompts, settings.json hook registration via jsonc-parser, and symmetric uninstall operations.

## Contents

### Core Orchestration

**[index.ts](./index.ts)** — Main entry point exposing `runInstaller(args)` routing install/uninstall workflows via `parseInstallerArgs()` CLI parser (supports `--runtime`, `-g/-l`, `--force`, `-q`, `-h` flags), `selectRuntime()` / `selectLocation()` interactive prompts for missing args, `runInstall()` / `runUninstall()` operation dispatchers with post-action `verifyInstallation()` checks, and `displayInstallResults()` / `displayUninstallResults()` formatters calling `showSuccess()` / `showError()` / `showNextSteps()` banner functions. Re-exports all public types (InstallerArgs, InstallerResult, Runtime, Location) and utility functions from sibling modules.

**[operations.ts](./operations.ts)** — File copier implementing `installFiles()` via `getTemplatesForRuntime()` → `resolveInstallPath()` → `writeFileSync()` with force-overwrite logic, hook installation (`registerClaudeHooks()` / `registerGeminiHooks()` injecting `node ${runtimeDir}/hooks/${filename}` commands into settings.json SessionStart/SessionEnd arrays), OpenCode plugin deployment (`getBundledHookPath()` → `are-check-update.js` / `are-session-end.js` copies), `registerPermissions()` merging `ARE_PERMISSIONS` into Claude settings.permissions.allow, `writeVersionFile()` emitting `ARE-VERSION` from `getPackageVersion()`, and `verifyInstallation()` existence checker. Uses jsonc-parser `modify()` / `applyEdits()` with `{tabSize: 2, insertSpaces: true}` for comment-preserving JSON edits.

**[uninstall.ts](./uninstall.ts)** — Reversal operations via `uninstallFiles()` dispatching `uninstallFilesForRuntime()` per runtime, deleting command templates, hooks (`unregisterClaudeHooks()` / `unregisterGeminiHooks()` filtering settings.json arrays via `getHookPatterns()` legacy + current command matchers), permissions (`unregisterPermissions()` removing `ARE_PERMISSIONS` from allow list), ARE-VERSION files, Claude ARE skill directories (`cleanupAreSkillDirs()`), legacy Gemini `are-*.md` / `are/*.toml` files (`cleanupLegacyGeminiFiles()`), and empty directory cleanup (`cleanupEmptyDirs()` stopping at `.claude/.opencode/.gemini/.config` roots). `deleteConfigFolder()` removes `.agents-reverse-engineer/` for local installs.

### Configuration Resolution

**[paths.ts](./paths.ts)** — Cross-platform path resolver exposing `getRuntimePaths()` returning `{global, local, settingsFile}` for each runtime (Claude: `CLAUDE_CONFIG_DIR || ~/.claude`, OpenCode: `OPENCODE_CONFIG_DIR || XDG_CONFIG_HOME/opencode || ~/.config/opencode`, Gemini: `GEMINI_CONFIG_DIR || ~/.gemini`), `resolveInstallPath()` joining projectRoot with local dir or returning global dir, `getSettingsPath()` building absolute settings.json path, `isRuntimeInstalledLocally()` / `isRuntimeInstalledGlobally()` stat-based existence checks, `getInstalledRuntimes()` filtering `['claude', 'opencode', 'gemini']` by local presence, and `getAllRuntimes()` excluding 'all' meta-runtime.

**[types.ts](./types.ts)** — Type definitions: Runtime (`'claude' | 'opencode' | 'gemini' | 'all'`), Location (`'global' | 'local'`), InstallerArgs (CLI flags: `runtime?`, `global`, `local`, `uninstall`, `force`, `help`, `quiet`), InstallerResult (per-runtime/location outcome: `success`, `filesCreated`, `filesSkipped`, `errors`, `hookRegistered?`, `versionWritten?`), RuntimePaths (resolved directory triplet: `global`, `local`, `settingsFile`).

### Terminal Interface

**[banner.ts](./banner.ts)** — Styled output helpers: `displayBanner()` rendering green ASCII "ARE" art + VERSION + tagline via picocolors block-drawing characters (U+25XX), `showHelp()` printing eight-option usage table (`--runtime`, `-g`, `-l`, `-u`, `--force`, `-q`, `-h`) + three example commands, `showSuccess()` / `showError()` / `showWarning()` / `showInfo()` prefixing messages with colored glyphs (✓/✗/!/›), `showNextSteps()` formatting seven-step post-install guide (`/are-help` → `/are-init` → `/are-discover` → `/are-generate` → `/are-update` → `/are-specify` → `/are-clean`) with GitHub docs URL.

**[prompts.ts](./prompts.ts)** — Interactive input via `selectOption<T>()` routing `arrowKeySelect()` (raw mode keypress events: up/down/return, ANSI escape sequence re-rendering) for TTY or `numberedSelect()` (1-indexed readline interface) for CI. Specialized wrappers: `selectRuntime()` prompting `['claude', 'opencode', 'gemini', 'all']`, `selectLocation()` prompting `['global', 'local']`, `confirmAction()` yes/no selector. `isInteractive()` returns `process.stdin.isTTY === true`. `cleanupRawMode()` disables raw mode + pauses stdin, registered on `exit` / `SIGINT` events.

## Architecture

### Installation Workflow

1. **Arg Parsing**: `parseInstallerArgs()` validates `--runtime` against `['claude', 'opencode', 'gemini', 'all']`, resolves `-g/-l` flags to Location, sets `uninstall: false` (command-level).
2. **Interactive Fallback**: Missing runtime/location triggers `selectRuntime()` / `selectLocation()` prompts unless non-interactive mode (exits with code 1).
3. **Operation Dispatch**: `runInstall()` calls `installFiles()` → `installFilesForRuntime()` per runtime, `registerHooks()` / `registerPermissions()`, `writeVersionFile()`.
4. **Verification**: `verifyInstallation()` filters filesCreated via `existsSync()`, displays missing files with `--force` hint.
5. **Result Display**: `displayInstallResults()` aggregates `totalCreated` / `totalSkipped` / `hooksRegistered` counts, invokes `showNextSteps(primaryRuntime, totalCreated)` with 7-step guide.

### Hook Registration

**Claude/Gemini**: `registerClaudeHooks()` / `registerGeminiHooks()` read settings.json via `jsonc-parser.parse()`, inject `{ hooks: [{ type: 'command', command: 'node ${runtimeDir}/hooks/${filename}' }] }` entries into SessionStart/SessionEnd arrays (Gemini flattens to `{ name, type, command }` schema), write back via `modify(content, ['hooks', event, index], newValue)` + `applyEdits()` preserving comments. Currently disabled (empty `ARE_HOOKS` array).

**OpenCode**: Copies `hooks/dist/opencode-are-check-update.js` → `.opencode/plugins/are-check-update.js` (no settings.json registration).

**Permissions**: `registerPermissions()` merges five bash patterns (`Bash(npx agents-reverse-engineer@latest init*)`, etc.) into settings.permissions.allow via `modify(content, ['permissions', 'allow'], updatedArray)`.

### Uninstall Workflow

1. **File Deletion**: `uninstallFilesForRuntime()` deletes command templates, hooks/plugins, ARE-VERSION files, tracks in `filesCreated` (repurposed as deleted file list).
2. **Hook Removal**: `unregisterClaudeHooks()` / `unregisterGeminiHooks()` filter settings arrays removing entries matching `getHookPatterns()` (current `node ${runtimeDir}/hooks/${filename}` + legacy `node hooks/${filename}`).
3. **Permission Cleanup**: `unregisterPermissions()` removes `ARE_PERMISSIONS` from allow list, deletes empty `permissions` object.
4. **Legacy Cleanup**: `cleanupAreSkillDirs()` (Claude), `cleanupLegacyGeminiFiles()` (Gemini pre-TOML `are-*.md` / `are/*.toml`), `cleanupEmptyDirs()` (recursive bottom-up removal stopping at runtime roots).
5. **Config Folder**: `deleteConfigFolder()` removes `.agents-reverse-engineer/` for local installs only.

## Behavioral Contracts

### Valid Runtimes
```typescript
['claude', 'opencode', 'gemini', 'all']
```

### Hook Definitions (Currently Disabled)
```typescript
const ARE_HOOKS: HookDefinition[] = [
  // { event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' },
  // { event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }, // Disabled - causing issues
];
```

### Plugin Files
```typescript
const ARE_PLUGINS: PluginDefinition[] = [
  { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' },
  // { srcFilename: 'opencode-are-session-end.js', destFilename: 'are-session-end.js' }, // Disabled - causing issues
];
```

### Permission Patterns
```typescript
const ARE_PERMISSIONS = [
  'Bash(npx agents-reverse-engineer@latest init*)',
  'Bash(npx agents-reverse-engineer@latest discover*)',
  'Bash(npx agents-reverse-engineer@latest generate*)',
  'Bash(npx agents-reverse-engineer@latest update*)',
  'Bash(npx agents-reverse-engineer@latest clean*)',
  'Bash(rm -f .agents-reverse-engineer/progress.log*)',
  'Bash(sleep *)',
];
```

### Hook Command Format
```
node ${runtimeDir}/hooks/${hookDef.filename}
```
Legacy format (for uninstall matching): `node hooks/${hookDef.filename}`

### Non-Interactive Error Messages
```
'Missing --runtime flag (required in non-interactive mode)'
'Missing -g/--global or -l/--local flag (required in non-interactive mode)'
'Unable to determine runtime and location'
```

### JSONC Formatting Options
```typescript
{ tabSize: 2, insertSpaces: true }
```

### Exit Codes
- **0**: Successful install/uninstall or no-op.
- **1**: Validation failure (missing args in non-interactive mode, unresolved runtime/location).

### GitHub Docs URL
```
https://github.com/GeoloeG-IsT/agents-reverse-engineer
```

### Runtime Root Boundaries (cleanupEmptyDirs)
```typescript
baseName !== '.claude' && baseName !== '.opencode' && baseName !== '.gemini' && baseName !== '.config'
```

### Version Fallback
```typescript
getPackageVersion(): string  // Returns 'unknown' on ../../package.json read failure
```

## Dependencies

**Terminal I/O**: picocolors (styled output), node:readline (keypress events, interface creation), node:tty (isInteractive check).

**Filesystem**: node:fs (`existsSync`, `readFileSync`, `writeFileSync`, `mkdirSync`, `unlinkSync`, `readdirSync`, `rmdirSync`, `rmSync`), node:path (cross-platform joining).

**Configuration**: jsonc-parser (`parse`, `modify`, `applyEdits` for comment-preserving JSON edits).

**Integration**: `../integration/templates.js` (`getClaudeTemplates`, `getOpenCodeTemplates`, `getGeminiTemplates` returning IntegrationTemplate[]).

**Version**: `../version.js` (`getVersion()` reading package.json).

## File Relationships

`index.ts` aggregates public API, imports from all sibling modules: `banner.ts` (display functions), `prompts.ts` (user input), `paths.ts` (path resolution), `operations.ts` (install logic), `uninstall.ts` (removal logic), `types.ts` (shared interfaces). `operations.ts` and `uninstall.ts` mirror each other's constants (`ARE_HOOKS`, `ARE_PERMISSIONS`, `ARE_PLUGINS`) and template retrieval logic. `prompts.ts` depends on `types.ts` for Runtime/Location enums. `paths.ts` provides filesystem abstraction consumed by both operations and uninstall modules.