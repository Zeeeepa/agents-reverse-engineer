<!-- Generated by agents-reverse-engineer -->

# src/installer

Orchestrates npx-based installation of ARE commands and hooks across Claude Code, OpenCode, and Gemini CLI runtimes with interactive prompts, platform-specific path resolution, settings.json manipulation, and uninstallation workflows.

## Contents

### Core Orchestration

**[index.ts](./index.ts)** — Entry point exposing `runInstaller()` and `parseInstallerArgs()` for CLI integration. Parses short/long flags (`-g`/`--global`, `-l`/`--local`, `--runtime`, `--force`, `--quiet`, `--uninstall`), validates non-interactive mode requirements, dispatches to `runInstall()` or `runUninstall()` based on arguments, displays results via `displayInstallResults()` and `displayUninstallResults()`. Re-exports all types and functions from sibling modules for barrel pattern.

**[operations.ts](./operations.ts)** — Implements `installFiles()`, `verifyInstallation()`, `registerHooks()`, `registerPermissions()` for file copying, settings.json hook registration (SessionStart/SessionEnd events with nested HookEvent arrays for Claude, flat GeminiHook arrays for Gemini), and bash permission patterns (`ARE_PERMISSIONS` array: `'Bash(npx agents-reverse-engineer@latest init*)'` through `clean*`, `'Bash(rm -f .agents-reverse-engineer/progress.log*)'`, `'Bash(sleep *)'`). Resolves bundled hooks via `getBundledHookPath()` navigating from `dist/installer/operations.js` up to `hooks/dist/`. Writes `ARE-VERSION` file via `getPackageVersion()`.

**[uninstall.ts](./uninstall.ts)** — Mirrors installation logic with `uninstallFiles()`, `unregisterHooks()`, `unregisterPermissions()`, `deleteConfigFolder()`. Removes command templates, hooks, plugins, settings.json entries, ARE-VERSION file. Implements `cleanupAreSkillDirs()` for Claude skills format, `cleanupEmptyDirs()` for recursive bottom-up directory removal, `cleanupLegacyGeminiFiles()` for obsolete Markdown/TOML formats. Repurposes `InstallerResult.filesCreated` to track deleted files, `hookRegistered` for unregistration status.

### Path Resolution

**[paths.ts](./paths.ts)** — Exports `getRuntimePaths()`, `resolveInstallPath()`, `getSettingsPath()`, `getAllRuntimes()`, `isRuntimeInstalledLocally()`, `isRuntimeInstalledGlobally()`, `getInstalledRuntimes()`. Resolves global/local paths with environment overrides: `CLAUDE_CONFIG_DIR` (`~/.claude` fallback), `OPENCODE_CONFIG_DIR` or `XDG_CONFIG_HOME/opencode` (`~/.config/opencode` fallback), `GEMINI_CONFIG_DIR` (`~/.gemini` fallback). Returns `RuntimePaths` with `global`, `local`, `settingsFile` fields.

### User Interface

**[prompts.ts](./prompts.ts)** — Provides `selectRuntime()`, `selectLocation()`, `confirmAction()`, `isInteractive()` with `arrowKeySelect()` for TTY mode (arrow-key navigation via `readline.emitKeypressEvents()` + `process.stdin.setRawMode(true)` with ANSI escape sequences `\x1b[${n}A`, `\x1b[2K`, `\x1b[1B` for rendering) and `numberedSelect()` fallback for piped input. Registers `cleanupRawMode()` on `process.on('exit')` and `process.on('SIGINT')` to restore terminal state via `setRawMode(false)` + `pause()`.

**[banner.ts](./banner.ts)** — Exports `displayBanner()` (Unicode box-drawing ASCII art logo U+2588/U+2550-U+2557), `showHelp()`, `showSuccess()`/`showError()`/`showWarning()`/`showInfo()` (prefix symbols: green ✓, red ✗, yellow !, cyan >), `showNextSteps()` (lists commands `/are-help`, `/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean` with GitHub documentation link).

### Type Definitions

**[types.ts](./types.ts)** — Defines `Runtime` (`'claude' | 'opencode' | 'gemini' | 'all'`), `Location` (`'global' | 'local'`), `InstallerArgs` (`runtime?`, `global`, `local`, `uninstall`, `force`, `help`, `quiet`), `InstallerResult` (`success`, `runtime: Exclude<Runtime, 'all'>`, `location`, `filesCreated`, `filesSkipped`, `errors`, `hookRegistered?`, `versionWritten?`), `RuntimePaths` (`global`, `local`, `settingsFile`).

## Subdirectories

None — flat structure with seven TypeScript modules.

## Architecture

### Two-Phase Workflow

**Installation (runInstall):**
1. Argument parsing via `parseInstallerArgs()` with short/long flag normalization
2. Interactive prompts via `selectRuntime()`/`selectLocation()` when TTY detected and values missing
3. Template copying via `getTemplatesForRuntime()` → `getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()` from `src/integration/templates.ts`
4. Hook/plugin installation: Claude/Gemini to `hooks/` subdirectory using `ARE_HOOKS` array (currently empty), OpenCode to `plugins/` using `ARE_PLUGINS` array
5. Settings.json modification: `registerHooks()` merges SessionStart/SessionEnd hooks with duplicate detection, `registerPermissions()` adds `ARE_PERMISSIONS` bash patterns to Claude's permissions.allow array
6. Version file creation via `writeVersionFile()` for update checker hooks
7. Verification via `verifyInstallation()` checking `existsSync()` for all filesCreated paths

**Uninstallation (runUninstall):**
1. Template path extraction with runtime prefix slicing (`template.path.split('/').slice(1).join('/')`)
2. File deletion via `unlinkSync()` for templates, hooks, plugins, ARE-VERSION
3. Settings.json cleanup: `unregisterHooks()` filters hook arrays via pattern matching (current format `node .claude/hooks/${filename}`, legacy `node hooks/${filename}`), `unregisterPermissions()` filters `ARE_PERMISSIONS` from permissions.allow
4. Directory cleanup: `cleanupAreSkillDirs()` removes empty `are-*` skill directories, `cleanupEmptyDirs()` recursively removes empty parents up to runtime root, `cleanupLegacyGeminiFiles()` deletes obsolete `.md`/`.toml` formats
5. Config folder deletion via `deleteConfigFolder()` only for local installations (`location === 'local'`)

### Runtime-Specific Patterns

**Claude Code:**
- Global path: `~/.claude` (override: `CLAUDE_CONFIG_DIR`)
- Commands: `.claude/skills/<command>/SKILL.md` with frontmatter `name: /are-<command>`
- Hooks: `.claude/hooks/<filename>.js` registered in `settings.json` with nested structure `{ hooks: { SessionStart?: [{ hooks: [{ type: 'command', command: string }] }] } }`
- Permissions: `settings.json` permissions.allow array with bash command patterns
- Settings file: `~/.claude/settings.json`

**OpenCode:**
- Global path: `~/.config/opencode` (overrides: `OPENCODE_CONFIG_DIR` > `XDG_CONFIG_HOME/opencode`)
- Commands: `.opencode/commands/<command>.md` with frontmatter `agent: build`
- Plugins: `.opencode/plugins/<filename>.js` exporting async factory functions with `event['session.created']`/`event['session.deleted']` handlers
- No settings file (plugin registration via file presence)

**Gemini CLI:**
- Global path: `~/.gemini` (override: `GEMINI_CONFIG_DIR`)
- Commands: `.gemini/commands/<command>.toml` with `description`/`prompt` fields
- Hooks: `.gemini/hooks/<filename>.js` registered in `settings.json` with flat structure `{ hooks: { SessionStart?: [{ name: string, type: 'command', command: string }] } }`
- Settings file: `~/.gemini/settings.json`

## Behavioral Contracts

### Hook/Plugin Definitions

**ARE_HOOKS (operations.ts):**
```typescript
const ARE_HOOKS: HookDefinition[] = [
  // Array intentionally empty — hooks disabled due to issues
];
```

**ARE_PLUGINS (operations.ts):**
```typescript
const ARE_PLUGINS: PluginDefinition[] = [
  { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' },
  // are-session-end.js disabled
];
```

**ARE_PERMISSIONS (operations.ts):**
```typescript
const ARE_PERMISSIONS: string[] = [
  'Bash(npx agents-reverse-engineer@latest init*)',
  'Bash(npx agents-reverse-engineer@latest discover*)',
  'Bash(npx agents-reverse-engineer@latest generate*)',
  'Bash(npx agents-reverse-engineer@latest update*)',
  'Bash(npx agents-reverse-engineer@latest clean*)',
  'Bash(rm -f .agents-reverse-engineer/progress.log*)',
  'Bash(sleep *)',
];
```

**Hook command pattern (operations.ts):**
```javascript
`node ${runtimeDir}/hooks/${hookDef.filename}`
```

**Legacy hook patterns (uninstall.ts):**
```typescript
function getHookPatterns(runtimeDir: string): string[] {
  return ARE_HOOKS.flatMap(hook => [
    `node ${runtimeDir}/hooks/${hook.filename}`,  // Current format
    `node hooks/${hook.filename}`,                 // Legacy format
  ]);
}
```

### ANSI Escape Sequences (prompts.ts)

**Cursor control in arrowKeySelect:**
- `\x1b[${n}A` — Move cursor up n lines
- `\x1b[2K` — Clear entire line
- `\x1b[1B` — Move cursor down 1 line

**Keypress handling:**
- Up arrow: `key.name === 'up'` → `selectedIndex = Math.max(0, selectedIndex - 1)`
- Down arrow: `key.name === 'down'` → `selectedIndex = Math.min(options.length - 1, selectedIndex + 1)`
- Enter: `key.name === 'return'` → resolve with `options[selectedIndex].value`
- Ctrl+C: `key.ctrl && key.name === 'c'` → `cleanupRawMode()` + `process.exit(0)`

### Settings.json Schemas

**Claude (operations.ts):**
```typescript
interface SettingsJson {
  hooks?: {
    SessionStart?: HookEvent[];
    SessionEnd?: HookEvent[];
  };
  permissions?: {
    allow?: string[];
    deny?: string[];
  };
}

interface HookEvent {
  hooks: SessionHook[];
}

interface SessionHook {
  type: 'command';
  command: string;
}
```

**Gemini (operations.ts):**
```typescript
interface GeminiSettingsJson {
  hooks?: {
    SessionStart?: GeminiHook[];
    SessionEnd?: GeminiHook[];
  };
}

interface GeminiHook {
  name: string;
  type: 'command';
  command: string;
}
```

### Directory Cleanup Terminal Conditions (uninstall.ts)

**Runtime root check in cleanupEmptyDirs:**
```typescript
const baseName = path.basename(dirPath);
if (['.claude', '.opencode', '.gemini', '.config'].includes(baseName)) {
  return;
}
```

**ARE skill directory pattern (uninstall.ts):**
```typescript
entry.startsWith('are-') && stats.isDirectory()
```

**Legacy Gemini file patterns (uninstall.ts):**
```typescript
// Markdown format
entry.startsWith('are-') && entry.endsWith('.md')

// TOML namespace directory
'commands/are/*.toml'
```

## File Relationships

**Orchestration chain:**
1. `index.ts` parses args → calls `prompts.ts` selectors → calls `operations.ts` or `uninstall.ts`
2. `operations.ts`/`uninstall.ts` call `paths.ts` for directory resolution
3. `operations.ts` calls `src/integration/templates.ts` for command content
4. `operations.ts` reads bundled hooks from `hooks/dist/` via `getBundledHookPath()`
5. `operations.ts`/`uninstall.ts` manipulate settings.json via in-memory JSON parse/stringify
6. `banner.ts` provides display functions consumed by `index.ts` for results rendering

**Shared state:**
- `prompts.ts` maintains module-level `rawModeActive` flag for terminal cleanup
- `operations.ts` and `uninstall.ts` share `ARE_HOOKS`, `ARE_PLUGINS`, `ARE_PERMISSIONS` definitions
- `paths.ts` provides single source of truth for runtime directory mappings

**Type flow:**
- `types.ts` defines discriminated union `Runtime` with `'all'` excluded via `Exclude<Runtime, 'all'>` in `InstallerResult.runtime`
- `InstallerArgs` parsed in `index.ts`, threaded through `runInstall()`/`runUninstall()` to `operations.ts`/`uninstall.ts`
- `RuntimePaths` returned by `paths.ts`, consumed by `operations.ts`/`uninstall.ts` for file path construction