<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/installer

Orchestrates installation and uninstallation of ARE command templates, hooks, plugins, and permissions for AI coding assistants (Claude Code, Codex, OpenCode, Gemini CLI) with interactive CLI prompts and runtime-specific config directory management.

## Contents

**Core Orchestration**

- [index.ts](./index.ts): Exports `runInstaller(args)` routing to `runInstall`/`runUninstall` based on `args.uninstall` flag; `parseInstallerArgs(args)` validates flags (`-g`/`-l`, `--runtime`, `--force`, `-q`, `-h`); `determineLocation`/`determineRuntimes` resolve interactive vs non-interactive mode; re-exports all types/paths/prompts/banner symbols.
- [operations.ts](./operations.ts): Exports `installFiles()` dispatching to `installFilesForRuntime()` per runtime; `registerHooks()`/`registerPermissions()` mutate settings.json via `jsonc-parser`; `writeVersionFile()` emits `getPackageVersion()` to `basePath/ARE-VERSION`; defines `ARE_HOOKS` (SessionStart/PostToolUse), `ARE_PLUGINS`, `CODEX_PREFIX_RULES`, `ARE_PERMISSIONS`, `LOCAL_CONTEXT_RULES_MARKER`.
- [uninstall.ts](./uninstall.ts): Exports `uninstallFiles()` removing templates/hooks/plugins/VERSION; `unregisterHooks()`/`unregisterPermissions()` strip settings.json entries; `deleteConfigFolder()` removes `.agents-reverse-engineer`; `cleanupAreSkillDirs()`/`cleanupEmptyDirs()`/`cleanupLegacyGeminiFiles()`/`cleanupOpenCodeInfrastructure()` recursively prune empty directories.

**Interactive UI**

- [prompts.ts](./prompts.ts): Exports `selectRuntime()`/`selectLocation()`/`confirmAction()` routing to `arrowKeySelect` (TTY raw mode with ANSI escape sequences `\x1b[${n}A`, `\x1b[2K`, `\x1b[1B`) or `numberedSelect` (readline); `isInteractive()` checks `process.stdin.isTTY`; `cleanupRawMode()` restores terminal on exit/SIGINT.
- [banner.ts](./banner.ts): Exports `displayBanner()` (6-line ASCII art "ARE" logo), `showHelp()` (usage/options/examples), `showSuccess()`/`showError()`/`showWarning()`/`showInfo()` (styled output via `picocolors`), `showNextSteps(runtime, filesCreated)` (lists 7 slash commands + GitHub docs link).

**Path Resolution**

- [paths.ts](./paths.ts): Exports `getRuntimePaths(runtime)` resolving `{global, local, settingsFile}` with env overrides `CLAUDE_CONFIG_DIR`/`OPENCODE_CONFIG_DIR`/`GEMINI_CONFIG_DIR`/`XDG_CONFIG_HOME`; `resolveInstallPath(runtime, location, projectRoot)` joins with CWD; `resolveCodexConfigPath(location)` returns `~/.codex` (global) or `{projectRoot}/.codex` (local); `isRuntimeInstalledLocally()`/`isRuntimeInstalledGlobally()` via stat; `getInstalledRuntimes(projectRoot)` filters `getAllRuntimes()`.

**Type Definitions**

- [types.ts](./types.ts): Defines `Runtime = 'claude'|'codex'|'opencode'|'gemini'|'all'`, `Location = 'global'|'local'`, `InstallerArgs` (CLI flags), `InstallerResult` (operation outcome with `filesCreated`/`filesSkipped`/`errors`/`hookRegistered`), `RuntimePaths`.

## Workflow & Conventions

**Interactive Installation**: `npx agents-reverse-engineer@latest` invokes `runInstaller()`. Non-interactive mode requires `--runtime` + location flag (`-g`/`-l`) or exits. Interactive mode prompts via `selectRuntime()`/`selectLocation()` when flags missing (`isInteractive()` checks `process.stdin.isTTY`). `runInstall()` calls `installFiles()` → `installFilesForRuntime()` writing templates from `getTemplatesForRuntime()` to `resolveInstallPath()`, registers hooks/plugins/permissions/rules per runtime, writes `ARE-VERSION`, verifies via `verifyInstallation()`, displays results via `displayInstallResults()`.

**Runtime-Specific Operations**:
- **Claude**: Writes commands to `~/.claude/` or `.claude/`, copies hooks (`are-check-update.js`, `are-context-loader.js`) to `basePath/hooks/`, registers via `registerClaudeHooks()` in settings.json SessionStart/PostToolUse arrays, adds `ARE_PERMISSIONS` to `settings.permissions.allow`.
- **Codex**: Writes commands to `~/.agents/` or `.agents/`, writes `CODEX_PREFIX_RULES` to `{resolveCodexConfigPath()}/rules/are.rules` via `buildCodexRulesFileContent()`, writes context-loading instructions to `AGENTS.override.md` (repo root or `~/.codex/`) via `buildLocalContextRulesContent()`.
- **OpenCode**: Writes commands to `~/.config/opencode/` or `.opencode/`, copies plugins to `basePath/plugins/` (no settings.json registration—auto-loaded).
- **Gemini**: Writes commands to `~/.gemini/` or `.gemini/`, copies SessionStart hooks to `basePath/hooks/`, registers via `registerGeminiHooks()` using flat `{name, type, command}` format (no PostToolUse support).

**Uninstallation**: `runInstaller({ uninstall: true })` invokes `runUninstall()` calling `uninstallFiles()` removing templates/hooks/plugins/VERSION via `uninstallFilesForRuntime()`, unregisters hooks/permissions via `unregisterClaudeHooks()`/`unregisterGeminiHooks()`/`unregisterPermissions()`, deletes Codex rules (`are.rules`, `AGENTS.override.md` if `LOCAL_CONTEXT_RULES_MARKER` present), cleans empty directories via `cleanupAreSkillDirs()`/`cleanupEmptyDirs()`/`cleanupLegacyGeminiFiles()`/`cleanupOpenCodeInfrastructure()`, optionally deletes `.agents-reverse-engineer` via `deleteConfigFolder()` (local only), displays results via `displayUninstallResults()`.

**Settings.json Mutation**: `operations.ts` uses `jsonc-parser` (`parse`, `modify`, `applyEdits`) preserving comments/formatting. Hook registration merges into `settings.hooks.{SessionStart|PostToolUse}[]` (Claude nested `{matcher?, hooks: [{type, command}]}` vs Gemini flat `{name, type, command}`). Permissions merge `ARE_PERMISSIONS` into `settings.permissions.allow`. Cleanup (`uninstall.ts`) filters entries matching `getHookPatterns(runtimeDir)` (current `node {runtimeDir}/hooks/{filename}` + legacy `node hooks/{filename}` formats), deletes empty hooks object.

**Version Tracking**: `writeVersionFile()` reads `../../package.json` (from `dist/installer/operations.js` via `import.meta.url`), writes `version` field to `basePath/ARE-VERSION` if `filesCreated.length > 0`.

**Error Handling**: `force: true` overwrites existing files; `dryRun: true` previews without writes. `shouldWriteManagedFile(filePath, marker, force)` only overwrites if `force && existsSync && content.includes(marker)` (protects user-authored files). Operations accumulate `errors[]` in `InstallerResult`, emit warnings via `showWarning()`.

## Behavioral Contracts

**ARE_HOOKS** (from operations.ts):
```typescript
[
  { event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' },
  { event: 'PostToolUse', filename: 'are-context-loader.js', name: 'are-context-loader', matcher: 'Read' }
]
```

**ARE_PLUGINS** (OpenCode):
```typescript
[
  // Disabled: { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' }
]
```

**CODEX_PREFIX_RULES** (from operations.ts):
```typescript
[
  ['npx', 'are', 'init'],
  ['npx', 'are', 'discover'],
  ['npx', 'are', 'generate'],
  ['npx', 'are', 'update'],
  ['npx', 'are', 'specify'],
  ['npx', 'are', 'rebuild'],
  ['npx', 'are', 'clean'],
  ['npx', 'are', 'dashboard'],
  ['rm', '-f', '.agents-reverse-engineer/progress.log'],
  ['sleep']
]
```

**ARE_PERMISSIONS** (Claude auto-allow patterns):
```typescript
[
  'Bash(npx are init*)',
  'Bash(npx are discover*)',
  'Bash(npx are generate*)',
  'Bash(npx are update*)',
  'Bash(npx are specify*)',
  'Bash(npx are rebuild*)',
  'Bash(npx are clean*)',
  'Bash(npx are dashboard*)',
  'Bash(rm -f .agents-reverse-engineer/progress.log*)',
  'Bash(sleep *)'
]
```

**LOCAL_CONTEXT_RULES_MARKER**: `'<!-- Generated by agents-reverse-engineer installer: local-context-rules -->'` (detects ARE-managed `AGENTS.override.md`).

**Codex Rules File Format** (`.codex/rules/are.rules`):
```
# Generated by agents-reverse-engineer installer.
# Allows ARE command prefixes for Codex CLI approvals.

prefix_rule = ["npx","are","init"]
prefix_rule = ["npx","are","discover"]
...
```

**Codex Context Rules Content** (`AGENTS.override.md`):
```
<!-- Generated by agents-reverse-engineer installer: local-context-rules -->

# ARE Local Context Rules

When working in this repository:
- After reading a project file, load `AGENTS.override.md` and `AGENTS.md` in the file's directory (if present).
- Then load `AGENTS.override.md` and `AGENTS.md` from each parent directory up to repo root (if present).
- Skip reloading unchanged instruction files already loaded in the current task.
- If instructions conflict, nearest-directory instructions override parent/root instructions.
```

**ANSI Escape Sequences** (from prompts.ts): `\x1b[${n}A` (move cursor up n lines), `\x1b[2K` (clear line), `\x1b[1B` (move down one line).

**Keypress Handling**: `key.name === 'up'|'down'|'return'`, `key.ctrl && key.name === 'c'` for Ctrl+C detection.

**Runtime Paths**:
- Claude: `~/.claude` (global), `.claude` (local)
- Codex: `~/.agents` (global), `.agents` (local), `~/.codex/rules` (global config), `{projectRoot}/.codex/rules` (local config)
- OpenCode: `~/.config/opencode` or `$OPENCODE_CONFIG_DIR` (global), `.opencode` (local)
- Gemini: `~/.gemini` or `$GEMINI_CONFIG_DIR` (global), `.gemini` (local)

**Environment Variable Overrides**:
- `CLAUDE_CONFIG_DIR` → overrides `~/.claude`
- `OPENCODE_CONFIG_DIR` → overrides `~/.config/opencode`
- `XDG_CONFIG_HOME` → fallback for OpenCode (default: `~/.config`)
- `GEMINI_CONFIG_DIR` → overrides `~/.gemini`
- Codex: no env override (fixed `~/.agents` / `.agents`)

**Bundled Hook Paths**: Resolved via `getBundledHookPath(hookName)` from `dist/installer/operations.js` → `../../hooks/dist/{hookName}`.

**OpenCode Infrastructure Files**: `['package.json', 'bun.lock', '.gitignore', 'node_modules/']` removed by `cleanupOpenCodeInfrastructure()` if no commands/plugins/agents remain (local only).

**Legacy Cleanup**:
- `cleanupLegacyGeminiFiles()` removes `are-*.md` commands and `are/*.toml` nested configs
- `getHookPatterns(runtimeDir)` matches both `node {runtimeDir}/hooks/{filename}` and legacy `node hooks/{filename}` formats

**Settings.json Formatting**: `{tabSize: 2, insertSpaces: true}` for `jsonc-parser` modify operations.

**Next Steps Command List** (from banner.ts `showNextSteps()`):
```
/are-help
/are-init
/are-discover
/are-generate
/are-update
/are-specify
/are-clean
```

**GitHub Docs URL**: `https://github.com/GeoloeG-IsT/agents-reverse-engineer`