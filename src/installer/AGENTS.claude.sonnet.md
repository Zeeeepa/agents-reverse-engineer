<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/installer

The `src/installer` directory implements the interactive installer that deploys ARE command templates, hooks, and runtime integration files to AI coding assistant environments (Claude Code, Codex CLI, OpenCode CLI, Gemini CLI), supporting both global (`~/.claude`, `~/.agents`, `~/.config/opencode`, `~/.gemini`) and local (`.claude`, `.agents`, `.opencode`, `.gemini`) installations with interactive prompts, dry-run mode, and uninstallation logic.

## Contents

- [`banner.ts`](./banner.ts) — Exports `displayBanner()`, `showHelp()`, `showSuccess()`, `showError()`, `showWarning()`, `showInfo()`, `showNextSteps()` for styled terminal output using `picocolors`, and `VERSION` constant from `../version.js`.

- [`index.ts`](./index.ts) — Exports `runInstaller(args: InstallerArgs): Promise<InstallerResult[]>` main orchestrator, `parseInstallerArgs(args: string[]): InstallerArgs` CLI parser, `determineLocation()`, `determineRuntimes()`, `runInstall()`, `runUninstall()`, `displayInstallResults()`, `displayUninstallResults()` internal coordinators. Re-exports all symbols from `types.ts`, `paths.ts`, `banner.ts`, `prompts.ts`.

- [`operations.ts`](./operations.ts) — Exports `installFiles(runtime, location, options): InstallerResult[]`, `verifyInstallation(files): { success, missing }`, `registerHooks(basePath, runtime, dryRun)`, `registerPermissions(settingsPath, dryRun)`, `getPackageVersion()`, `writeVersionFile(basePath, dryRun)`, `formatInstallResult(result)`. Writes command templates, hooks/plugins, `ARE-VERSION` file, updates `settings.json` (Claude/Gemini) or `are.rules` / `AGENTS.override.md` (Codex). Hook registration uses `jsonc-parser.modify()` to preserve JSON comments.

- [`paths.ts`](./paths.ts) — Exports `getAllRuntimes()`, `getRuntimePaths(runtime): RuntimePaths`, `resolveInstallPath(runtime, location, projectRoot)`, `resolveCodexConfigPath(location, projectRoot)`, `getSettingsPath(runtime)`, `isRuntimeInstalledLocally(runtime, projectRoot)`, `isRuntimeInstalledGlobally(runtime)`, `getInstalledRuntimes(projectRoot)`. Respects `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`, `XDG_CONFIG_HOME` env vars.

- [`prompts.ts`](./prompts.ts) — Exports `isInteractive(): boolean` (TTY check), `selectOption<T>(prompt, options)`, `selectRuntime(mode)`, `selectLocation(mode)`, `confirmAction(message)`. Uses `arrowKeySelect()` (raw mode, ANSI codes, keypress events) for TTY, `numberedSelect()` (readline.question) for non-interactive. Registers `cleanupRawMode()` on `process.on('exit')` and `SIGINT`.

- [`types.ts`](./types.ts) — Exports `Runtime` (`'claude' | 'codex' | 'opencode' | 'gemini' | 'all'`), `Location` (`'global' | 'local'`), `InstallerArgs` (CLI flags), `InstallerResult` (install outcome with `filesCreated`, `filesSkipped`, `errors`, `hookRegistered`, `versionWritten`), `RuntimePaths` (resolved paths).

- [`uninstall.ts`](./uninstall.ts) — Exports `uninstallFiles(runtime, location, dryRun): InstallerResult[]`, `unregisterHooks(basePath, runtime, dryRun)`, `unregisterPermissions(basePath, dryRun)`, `deleteConfigFolder(location, dryRun)`. Removes command templates, hooks, hook registrations (using `jsonc-parser.modify()`), permissions, `ARE-VERSION`, `are.rules`, `AGENTS.override.md` (if contains marker), empty skill directories, legacy Gemini files, and OpenCode infrastructure (`package.json`, `node_modules`, `bun.lock`).

## Architecture

**Data Flow**: `runInstaller()` → `parseInstallerArgs()` → `determineLocation()` / `determineRuntimes()` → `runInstall()` / `runUninstall()` → `installFilesForRuntime()` / `uninstallFilesForRuntime()` → `registerHooks()` / `unregisterHooks()` → `verifyInstallation()` → `displayInstallResults()` / `displayUninstallResults()`.

**Runtime-Specific Logic**:
- **Claude/Gemini**: Write hooks to `hooks/` directory, register in `settings.json` via `registerClaudeHooks()` / `registerGeminiHooks()` (Claude: nested `hooks` arrays with optional `matcher`, Gemini: flat arrays with `name` field), Claude adds permissions to `allow` list.
- **Codex**: Write `are.rules` with `prefix_rule` entries for ARE commands, write `AGENTS.override.md` with context-loading instructions (local: repo root, global: `~/.codex/`).
- **OpenCode**: Copy plugins to `plugins/` directory (auto-loaded, no registration needed), copy agent file to `agents/`, install infrastructure files locally.

## Behavioral Contracts

**CLI Args**: `-g`/`--global` (user-level install), `-l`/`--local` (project-level install), `--runtime <claude|codex|opencode|gemini|all>`, `-u`/`--uninstall`, `--force` (overwrite managed files), `-q`/`--quiet` (suppress output), `-h`/`--help`.

**Non-Interactive Mode**: Exits with error if `--runtime` or location flags missing when `!isInteractive()`.

**Interactive Mode**: Prompts for missing runtime/location using `selectRuntime()` / `selectLocation()` with arrow-key navigation (TTY) or numbered selection (non-TTY).

**Managed File Marker (Codex)**: `<!-- Generated by agents-reverse-engineer installer: local-context-rules -->` in `AGENTS.override.md` identifies files safe for `--force` overwrite.

**Codex Prefix Rules Format**: `prefix_rule = ["npx", "are", "init"]` for each ARE command, plus `["rm", "-f", ".agents-reverse-engineer/progress.log"]` and `["sleep"]`.

**Context Loading Instructions (Codex)**: After reading a project file, load `AGENTS.override.md` and `AGENTS.md` in the file's directory, then from each parent directory up to repo root. Skip reloading unchanged files. Nearest-directory instructions override parent instructions.

**Claude settings.json Structure**: `hooks.SessionStart` and `hooks.PostToolUse` are arrays of `{ matcher?: string, hooks: [{ type: 'command', command: string }] }`.

**Gemini settings.json Structure**: `hooks.SessionStart` is array of `{ name: string, type: 'command', command: string }`.

**Hook Command Paths**: `node .claude/hooks/are-check-update.js`, `node .claude/hooks/are-context-loader.js`, `node .gemini/hooks/are-check-update.js`.

**Permissions Allow List (Claude)**: `Bash(npx are init*)`, `Bash(npx are discover*)`, `Bash(npx are generate*)`, `Bash(npx are update*)`, `Bash(npx are specify*)`, `Bash(npx are rebuild*)`, `Bash(npx are clean*)`, `Bash(rm -f .agents-reverse-engineer/progress.log*)`, `Bash(sleep *)`.

**Bundled Hooks Path**: From `dist/installer/operations.js`, navigate `../../hooks/dist/<hookName>`.

**Package.json Path**: From `dist/installer/operations.js`, navigate `../../package.json`.

**ARE_HOOKS Definitions**: `SessionStart/are-check-update.js`, `PostToolUse/are-context-loader.js` (current), `SessionEnd/are-session-end.js` (legacy).

**ARE_PLUGIN_FILENAMES**: `['are-check-update.js']` for OpenCode.

**OPENCODE_AGENT_FILENAME**: `'are-summarizer.md'`.

**ARE-VERSION File**: Written to installation directory root (e.g., `.claude/ARE-VERSION`, `~/.agents/ARE-VERSION`) containing package version.

**Config Directory**: `.agents-reverse-engineer` (deleted by `deleteConfigFolder()` for local installs only).

**Uninstall Cleanup**: Removes empty `are-*` skill directories, legacy Gemini `are-*.md` / `are/*.toml` files, empty Codex `.codex/rules` tree, OpenCode infrastructure (`package.json`, `node_modules`, `bun.lock`, `.gitignore`) when no plugins/commands/agents remain (local only).

**ANSI Escape Codes**: `\x1b[${n}A` (cursor up), `\x1b[2K` (clear line), `\x1b[1B` (cursor down) for `arrowKeySelect()` rendering.

**Raw Mode Cleanup**: `cleanupRawMode()` restores terminal via `process.stdin.setRawMode(false)` and `process.stdin.pause()` on `process.on('exit')` and `SIGINT`.

## Integration Points

**Depends on**: `../version.js` (`getVersion()`), `../integration/templates.js` (`getClaudeTemplates()`, `getCodexTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()`), `jsonc-parser` (`parse`, `modify`, `applyEdits`), `picocolors`, `node:readline`, `node:fs`, `node:path`, `node:url`.

**Path Conventions**:
- Claude: `~/.claude` (global), `.claude` (local), `CLAUDE_CONFIG_DIR` override
- Codex: `~/.agents` (global), `.agents` (local), no env override; CLI config in `~/.codex` / `.codex`
- OpenCode: `~/.config/opencode` (global), `.opencode` (local), `OPENCODE_CONFIG_DIR` > `XDG_CONFIG_HOME/opencode` override
- Gemini: `~/.gemini` (global), `.gemini` (local), `GEMINI_CONFIG_DIR` override

**Export Barrel**: `index.ts` re-exports all types from `types.ts`, all functions from `paths.ts`, `banner.ts`, `prompts.ts` for single-import usage.