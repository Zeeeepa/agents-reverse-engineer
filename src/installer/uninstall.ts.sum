---
generated_at: 2026-02-09T17:45:47.889Z
content_hash: fdb4705e29e0d5786dff9ce35a4eea394d7080ae93f9e040dd41ad7bad4c2aab
purpose: Removes installed ARE command files, hooks, plugins, permissions, and configuration directories with runtime-specific...
---
**Removes installed ARE command files, hooks, plugins, permissions, and configuration directories with runtime-specific cleanup strategies matching installation mirror logic.**

## Exported Functions

- `uninstallFiles(runtime: Runtime, location: Location, dryRun: boolean = false): InstallerResult[]` — Orchestrates uninstallation for single runtime or all runtimes via `getAllRuntimes()` iteration when `runtime === 'all'`, returning array of results
- `unregisterHooks(basePath: string, runtime: Exclude<Runtime, 'all'>, dryRun: boolean): boolean` — Removes ARE hook entries from `settings.json` SessionStart/SessionEnd arrays, dispatches to `unregisterClaudeHooks()` or `unregisterGeminiHooks()` based on runtime, returns true if any hook removed
- `unregisterPermissions(basePath: string, dryRun: boolean): boolean` — Filters `ARE_PERMISSIONS` array from `settings.json` permissions.allow, cleans up empty structures, returns true if changes made
- `deleteConfigFolder(location: Location, dryRun: boolean): boolean` — Recursively deletes `.agents-reverse-engineer` directory via `rmSync()` with `recursive: true, force: true` only for `location === 'local'`

## Hook and Plugin Definitions

- `ARE_HOOKS: HookDefinition[]` — Array of `{ event: 'SessionStart' | 'SessionEnd', filename: string }` pairs: `are-check-update.js` (SessionStart), `are-session-end.js` (SessionEnd)
- `ARE_PLUGIN_FILENAMES: string[]` — OpenCode plugin filenames: `['are-check-update.js', 'are-session-end.js']`
- `ARE_PERMISSIONS: string[]` — Bash command permission patterns: `'Bash(npx agents-reverse-engineer@latest init*)'`, `discover*`, `generate*`, `update*`, `clean*`
- `CONFIG_DIR = '.agents-reverse-engineer'` — Configuration directory constant matching `config/loader.ts`

## Runtime-Specific Uninstallation

`uninstallFilesForRuntime(runtime: Exclude<Runtime, 'all'>, location: Location, dryRun: boolean): InstallerResult` performs sequential cleanup:

1. **Command template removal**: Iterates `getTemplatesForRuntime()` output, extracts relative paths after runtime directory prefix, calls `unlinkSync()` on full paths constructed via `path.join(basePath, relativePath)`
2. **Hook/plugin removal**: For Claude/Gemini, deletes files from `hooks/` subdirectory using `ARE_HOOKS` array; for OpenCode, deletes from `plugins/` using `ARE_PLUGIN_FILENAMES`
3. **Settings.json modification**: Calls `unregisterHooks()` for all runtimes, additionally calls `unregisterPermissions()` for Claude only
4. **Version file cleanup**: Deletes `ARE-VERSION` from basePath via `unlinkSync()`
5. **Directory cleanup**: Invokes `cleanupAreSkillDirs()` for Claude skills format, `cleanupEmptyDirs()` for all runtimes, `cleanupLegacyGeminiFiles()` for Gemini

Returns `InstallerResult` with `filesCreated` repurposed to track deleted files, `filesSkipped` for nonexistent paths, `hookRegistered` repurposed to indicate hook unregistration success.

## Settings File Manipulation

`unregisterClaudeHooks(basePath: string, dryRun: boolean): boolean` implements pattern-based filtering:

- Builds hook command patterns via `getHookPatterns('.claude')` including current format `node .claude/hooks/${filename}` and legacy `node hooks/${filename}`
- Filters `settings.hooks.SessionStart` and `SessionEnd` arrays removing events whose `hooks[].command` matches patterns via `event.hooks?.some(h => hookPatterns.includes(h.command))`
- Cleans empty arrays via `delete settings.hooks[eventType]`, empty hooks object via `delete settings.hooks`
- Writes updated JSON via `writeFileSync()` with 2-space indentation

`unregisterGeminiHooks()` follows identical logic but operates on simpler `GeminiHook[]` arrays (direct `command` property without nested `hooks[]` structure) and uses `.gemini` runtime directory in patterns.

`unregisterPermissions()` filters `settings.permissions.allow` array via `!ARE_PERMISSIONS.includes(perm)`, removes empty `allow` array and `permissions` object structures.

## Type Definitions

- `SessionHook` — `{ type: 'command', command: string }` for Claude/Gemini hook registration
- `HookEvent` — `{ hooks: SessionHook[] }` wrapper
- `SettingsJson` — Claude settings schema with `hooks?: { SessionStart?: HookEvent[], SessionEnd?: HookEvent[] }`, `permissions?: { allow?: string[], deny?: string[] }`
- `GeminiHook` — Simpler format `{ name: string, type: 'command', command: string }` without nested hooks array
- `GeminiSettingsJson` — Gemini settings schema with `hooks?: { SessionStart?: GeminiHook[], SessionEnd?: GeminiHook[] }`
- `HookDefinition` — `{ event: 'SessionStart' | 'SessionEnd', filename: string }`

## Directory Cleanup Strategies

`cleanupAreSkillDirs(skillsDir: string)` iterates `readdirSync()` output filtering entries via `entry.startsWith('are-')`, calls `cleanupEmptyDirs()` on each matching skill directory.

`cleanupEmptyDirs(dirPath: string)` implements recursive bottom-up removal:

- Checks `readdirSync().length === 0` predicate
- Calls `rmdirSync()` on empty directory
- Recurses to parent via `path.dirname()` with terminal condition checking `baseName` against runtime roots: `.claude`, `.opencode`, `.gemini`, `.config`

`cleanupLegacyGeminiFiles(commandsDir: string)` removes obsolete formats:

- Deletes `are-*.md` files (pre-TOML Markdown format) via `entry.startsWith('are-') && entry.endsWith('.md')` predicate
- Recursively deletes `.toml` files from nested `commands/are/` directory (old namespace structure), then removes empty `are/` directory

## Template Resolution

`getTemplatesForRuntime(runtime: Exclude<Runtime, 'all'>)` dispatches to integration layer functions:

- `'claude'` → `getClaudeTemplates()` from `src/integration/templates.ts`
- `'opencode'` → `getOpenCodeTemplates()`
- `'gemini'` → `getGeminiTemplates()`

Each returns array of template objects with `.path` property in format `.<runtime>/<subdir>/<filename>` requiring `.split('/').slice(1).join('/')` to extract relative installation path.

## Error Handling

All file system operations wrapped in try-catch blocks with errors collected into `InstallerResult.errors` array. Pattern: `catch (err) { errors.push(\`Failed to delete ${path}: ${err}\`) }`. Missing files tracked separately in `filesSkipped` array via `existsSync()` checks before deletion attempts. Directory cleanup operations silently ignore errors via empty catch blocks to handle permission issues and in-use directories.