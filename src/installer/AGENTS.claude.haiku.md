<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/installer

The installer directory handles interactive and automated installation of ARE commands, hooks, and plugins across multiple AI coding runtimes (Claude Code, Codex, OpenCode, Gemini), managing both global user-level and local project-level configurations with cross-platform path resolution and settings.json registration.

## Contents

### Entry Point & Orchestration
- [index.ts](./index.ts) — Main installer entry point; exports `parseInstallerArgs()`, `runInstaller()`, and mode-determination functions (`determineLocation()`, `determineRuntimes()`); orchestrates install/uninstall workflows with interactive prompts or CLI flags.

### User Interface & Prompts
- [banner.ts](./banner.ts) — Styled console output via picocolors; exports `displayBanner()`, `showHelp()`, `showSuccess()`, `showError()`, `showWarning()`, `showInfo()`, `showNextSteps()`, and `VERSION` constant.
- [prompts.ts](./prompts.ts) — Interactive terminal selection with arrow-key (TTY) and numbered (CI) fallback; exports `isInteractive()`, `selectRuntime()`, `selectLocation()`, `confirmAction()`, and raw mode lifecycle management.

### Installation & Uninstallation
- [operations.ts](./operations.ts) — Command template, hook, and plugin installation logic; exports `installFiles()`, `registerHooks()`, `registerPermissions()`, `verifyInstallation()`, `getPackageVersion()`, `writeVersionFile()`; routes to runtime-specific installers and manages settings.json registration.
- [uninstall.ts](./uninstall.ts) — Reverses installation across all runtimes; exports `uninstallFiles()`, `unregisterHooks()`, `unregisterPermissions()`, `deleteConfigFolder()`; handles hook removal, Codex rules cleanup, legacy file cleanup, and empty directory recursion.

### Path Resolution & Type Definitions
- [paths.ts](./paths.ts) — Cross-platform config directory resolution; exports `getRuntimePaths()`, `resolveInstallPath()`, `resolveCodexConfigPath()`, `getSettingsPath()`, `getAllRuntimes()`, and installation detection functions (`isRuntimeInstalledLocally()`, `isRuntimeInstalledGlobally()`, `getInstalledRuntimes()`).
- [types.ts](./types.ts) — Type signatures for CLI args, installation results, and runtime paths; exports `Runtime`, `Location`, `InstallerArgs`, `InstallerResult`, `RuntimePaths`.

## Workflow & Conventions

**CLI Flags & Modes:**
- `--runtime {claude|codex|opencode|gemini|all}` specifies target runtime(s); omitted flags trigger interactive prompts.
- `-g/--global`, `-l/--local` specify installation scope; both or neither requires prompt.
- `--force` overwrites existing files (only those marked ARE-generated); preserves user files.
- `-q/--quiet` suppresses display messages; `--help` calls `showHelp()` and exits.
- Non-interactive mode (no TTY, e.g., CI) requires `--runtime` and `-g`/`--local` flags; missing flags trigger `process.exit(1)`.

**Result Reporting:**
- `displayInstallResults()` aggregates per-runtime results (`filesCreated`, `filesSkipped`, `hookRegistered`), displays summary counts and post-install next steps referencing `/are-*` commands.
- `displayUninstallResults()` reuses `InstallerResult` fields (filesCreated tracks deletions); reports aggregate file removals and config folder deletion status.

**Hook Registration & Permissions:**
- Claude/Gemini: `registerHooks()` merges hook entries into settings.json without duplicating; Claude supports SessionStart, PostToolUse, SessionEnd events; Gemini supports SessionStart, SessionEnd only.
- Claude: `registerPermissions()` adds Bash command patterns (`npx are init`, `npx are discover`, etc.) to settings.allow to reduce friction.
- Codex: Generates `are.rules` prefix rules file and `AGENTS.override.md` context-loading instructions.

**File Management:**
- `shouldWriteManagedFile()` checks for ARE-generation marker before overwriting; `--force` flag bypasses for ARE-marked files.
- `writeVersionFile()` writes ARE-VERSION tracking installed version.
- `ensureDir()` creates parent directories before file writes.

## Behavioral Contracts

**Runtime Config Directory Naming:**
- Claude: `.claude`
- Codex: `.agents` (skills), `.codex` (CLI rules)
- OpenCode: `.opencode`
- Gemini: `.gemini`

**Settings.json Hook Command Format (Claude):**
```
node .claude/hooks/are-check-update.js
node .claude/hooks/are-context-loader.js
```

**Gemini Hook Format (Simplified):**
Flat hook objects with `name`, `type`, `command` fields; SessionStart/SessionEnd only (no PostToolUse).

**Codex Prefix Rules** (`CODEX_PREFIX_RULES`):
```
['npx', 'are', 'init']
['npx', 'are', 'discover']
['npx', 'are', 'generate']
['npx', 'are', 'update']
['npx', 'are', 'specify']
['npx', 'are', 'rebuild']
['npx', 'are', 'clean']
['rm', '-f', '.agents-reverse-engineer/progress.log']
['sleep']
```

**ARE-Specific Markers & Files:**
- Hook existence check: command string match in settings.json; no duplicates on re-registration.
- ARE-VERSION filename: written to config root (`basePath/ARE-VERSION`).
- ARE-generated marker: `'<!-- Generated by agents-reverse-engineer -->'` in file content; identifies files eligible for `--force` overwrite.
- Codex context-rules marker: `'<!-- Generated by agents-reverse-engineer installer: local-context-rules -->'`; only marked files deleted on uninstall.

**Dry Run Behavior:**
- `dryRun=true` skips `writeFileSync` calls; returns `InstallerResult` with `filesCreated` populated for preview.
- Verifies installations via file existence checks; missing files added to `filesSkipped` list.

## Installation Architecture

**Runtime-Specific Routing:**
- [operations.ts](./operations.ts) dispatches `installFiles()` to `installFilesForRuntime()` per runtime or expands 'all' to concrete runtimes.
- Command templates sourced from `../integration/templates.js` (`getClaudeTemplates()`, `getCodexTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()`).
- Hooks bundled in `dist/installer/operations.js` context; resolved via `getBundledHookPath()`.

**Claude/Gemini:** Install session hooks + register in settings.json.
**Codex:** Generate rules files (`are.rules`) + context-loading instructions (`AGENTS.override.md`).
**OpenCode:** Install plugins from bundled sources (currently empty `ARE_PLUGINS` array); infrastructure setup (package.json, bun.lock, node_modules/).

**Uninstall Logic:**
- [uninstall.ts](./uninstall.ts) reverses all installation steps: removes templates, hook files, plugins, Codex rules/context-rules, ARE-VERSION; unregisters hooks/permissions in settings.json.
- Hook pattern matching: `node {runtimeDir}/hooks/{filename}` (current) and `node hooks/{filename}` (legacy).
- Cleanup utilities: `cleanupAreSkillDirs()`, `cleanupEmptyDirs()` (recursive), `cleanupLegacyGeminiFiles()`, `cleanupOpenCodeInfrastructure()`.