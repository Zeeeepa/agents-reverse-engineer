<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/installer
`src/installer` orchestrates the `agents-reverse-engineer` CLI tool's installation and uninstallation, handling runtime detection, file operations, user prompts, and configuration modifications across various AI assistant runtimes.

## Contents
- [banner.ts](./banner.ts): Provides ASCII banners, help text, and styled console output for the installer.
- [index.ts](./index.ts): Provides the main entry point, orchestrating interactive/non-interactive installation and uninstallation workflows.
- [operations.ts](./operations.ts): Manages file operations for the installer, including copying runtime files, verifying installations, and configuring runtime-specific settings.
- [paths.ts](./paths.ts): Facilitates cross-platform path resolution for AI coding assistant runtimes.
- [prompts.ts](./prompts.ts): Provides interactive command-line selection prompts, adapting behavior for TTY vs. non-TTY environments.
- [types.ts](./types.ts): Defines types for the `npx` installation workflow, managing AI coding assistant runtime installations.
- [uninstall.ts](./uninstall.ts): Manages removal of installation artifacts, mirroring `operations.ts` logic.

## Architecture / Data Flow
The installation workflow begins with `runInstaller` in [index.ts](./index.ts) parsing `InstallerArgs` via `parseInstallerArgs`. It then determines the installation `Location` and `Runtime` using `determineLocation` and `determineRuntimes`. For installation, `runInstall` calls `installFiles` from [operations.ts](./operations.ts) to copy templates and configure hooks, followed by `verifyInstallation` and `displayInstallResults` for feedback. For uninstallation, `runUninstall` calls `uninstallFiles` from [uninstall.ts](./uninstall.ts) to remove artifacts, `deleteConfigFolder`, and `displayUninstallResults`. User interaction during interactive modes is managed by `prompts.ts` functions like `selectRuntime` and `selectLocation`. `banner.ts` functions (`displayBanner`, `showSuccess`, `showError`, `showNextSteps`) provide console feedback throughout. Path resolution across all operations is handled by `paths.ts` functions such as `resolveInstallPath` and `getSettingsPath`.

## API Surface
- **Types**: `Runtime`, `Location`, `InstallerArgs`, `InstallerResult`, `RuntimePaths` defined in [types.ts](./types.ts) configure outcomes, runtime identifiers, and installation paths.
- **Display Utilities**: `VERSION` (string), `displayBanner()` (void), `showHelp()` (void), `showSuccess(msg: string)` (void), `showError(msg: string)` (void), `showWarning(msg: string)` (void), `showInfo(msg: string)` (void), `showNextSteps(runtime: string, filesCreated: number)` (void) from [banner.ts](./banner.ts) manage console output.
- **Path Utilities**: `getAllRuntimes()` (Array), `getRuntimePaths(runtime: Exclude<Runtime, 'all'>)` (RuntimePaths), `resolveInstallPath(runtime: Exclude<Runtime, 'all'>, location: Location, projectRoot?: string)` (string), `resolveCodexConfigPath(location: Location, projectRoot?: string)` (string), `getSettingsPath(runtime: Exclude<Runtime, 'all'>)` (string), `isRuntimeInstalledLocally(runtime: Exclude<Runtime, 'all'>, projectRoot: string)` (Promise), `isRuntimeInstalledGlobally(runtime: Exclude<Runtime, 'all'>)` (Promise), `getInstalledRuntimes(projectRoot: string)` (Promise) from [paths.ts](./paths.ts) resolve installation targets.
- **Prompt Utilities**: `isInteractive()` (boolean), `selectOption<T>(prompt: string, options: SelectOption<T>[])` (Promise), `selectRuntime(mode?: 'install' | 'uninstall')` (Promise), `selectLocation(mode?: 'install' | 'uninstall')` (Promise), `confirmAction(message: string)` (Promise) from [prompts.ts](./prompts.ts) handle user input.
- **Installer Core**: `parseInstallerArgs(args: string[])` (InstallerArgs) from [index.ts](./index.ts) processes CLI arguments. `runInstaller(args: InstallerArgs)` (Promise) from [index.ts](./index.ts) orchestrates installation/uninstallation.
- **File Operations**: `InstallOptions` (interface), `installFiles(runtime: Runtime, location: Location, options: InstallOptions)` (InstallerResult[]), `verifyInstallation(files: string[])` (object), `registerHooks(basePath: string, runtime: Exclude<Runtime, 'all'>, dryRun: boolean)` (boolean), `registerPermissions(settingsPath: string, dryRun: boolean)` (boolean), `getPackageVersion()` (string), `writeVersionFile(basePath: string, dryRun: boolean)` (void), `formatInstallResult(result: InstallerResult)` (string[]) from [operations.ts](./operations.ts) manage installation tasks.
- **Uninstallation Functions**: `uninstallFiles(runtime: Runtime, location: Location, dryRun: boolean)` (InstallerResult[]), `unregisterHooks(basePath: string, runtime: Exclude<Runtime, 'all'>, dryRun: boolean)` (boolean), `unregisterPermissions(basePath: string, dryRun: boolean)` (boolean), `deleteConfigFolder(location: Location, dryRun: boolean)` (boolean) from [uninstall.ts](./uninstall.ts) handle removal tasks.

## Behavioral Contracts
- **CLI Flags**: `parseInstallerArgs` in [index.ts](./index.ts) recognizes `--runtime <value>`, `-g`/`--global`, `-l`/`--local`, `--force`, `-q`/`--quiet`, `-h`/`--help`.
- **Valid Runtimes**: `validRuntimes` in [index.ts](./index.ts) enumerates `['claude', 'codex', 'opencode', 'gemini', 'all']`.
- **Non-Interactive Requirements**: `isInteractive()` check in [index.ts](./index.ts) causes `runInstaller` to `process.exit(1)` if `--runtime` and location flags (`-g` or `-l`) are missing.
- **Overwrite Policy**: `displayInstallResults` in [index.ts](./index.ts) advises `--force` to overwrite `totalSkipped` existing files.
- **External Docs**: `displayInstallResults` in [index.ts](./index.ts) links to `Docs: https://github.com/GeoloeG-IsT/agents-reverse-engineer`.
- **`CODEX_RULES_FILENAME`**: `'are.rules'` in [operations.ts](./operations.ts) and [uninstall.ts](./uninstall.ts) specifies the filename for Codex rules.
- **`LOCAL_CONTEXT_RULES_FILENAME`**: `'AGENTS.override.md'` in [operations.ts](./operations.ts) and [uninstall.ts](./uninstall.ts) defines the filename for local context override rules.
- **`LOCAL_CONTEXT_RULES_MARKER`**: `'<!-- Generated by agents-reverse-engineer installer: local-context-rules -->'` in [operations.ts](./operations.ts) and [uninstall.ts](./uninstall.ts) identifies installer-generated local context files.
- **`CODEX_PREFIX_RULES`**: `['npx', 'are', 'init']`, `['npx', 'are', 'discover']`, `['npx', 'are', 'generate']`, `['npx', 'are', 'update']`, `['npx', 'are', 'specify']`, `['npx', 'are', 'rebuild']`, `['npx', 'are', 'clean']`, `['rm', '-f', '.agents-reverse-engineer/progress.log']`, and `['sleep']` in [operations.ts](./operations.ts) define allowed command prefixes for Codex CLI approvals.
- **`ARE_HOOKS`**: In [operations.ts](./operations.ts), defines `SessionStart` event with `filename: 'are-check-update.js'` and `name: 'are-check-update'`, and `PostToolUse` event with `filename: 'are-context-loader.js'`, `name: 'are-context-loader'`, and `matcher: 'Read'`. In [uninstall.ts](./uninstall.ts), enumerates current and legacy hook files for removal, including `{ event: 'PostToolUse', filename: 'are-context-loader.js' }`.
- **`ARE_PLUGINS`**: (Currently an empty array, no OpenCode plugins are actively defined) in [operations.ts](./operations.ts).
- **`ARE_PERMISSIONS`**: `'Bash(npx are init*)'`, `'Bash(npx are discover*)'`, `'Bash(npx are generate*)'`, `'Bash(npx are update*)'`, `'Bash(npx are specify*)'`, `'Bash(npx are rebuild*)'`, `'Bash(npx are clean*)'`, `'Bash(rm -f .agents-reverse-engineer/progress.log*)'`, and `'Bash(sleep *)'` in [operations.ts](./operations.ts) and [uninstall.ts](./uninstall.ts) list explicit `Bash` permissions for Claude.
- **Runtime Environment Variables**: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`, `XDG_CONFIG_HOME` override default paths for `claude`, `opencode`, and `gemini` runtimes in [paths.ts](./paths.ts).
- **Codex Paths**: [paths.ts](./paths.ts) specifies Codex skills implicitly use `~/.agents` global and `.agents` local paths, while Codex CLI config uses `~/.codex` global and `.codex` local paths.
- **ANSI escape codes**: [prompts.ts](./prompts.ts) uses `\x1b[...A`, `\x1b[2K`, `\x1b[1B` for cursor movement and line clearing.
- **`Ctrl+C` handling**: [prompts.ts](./prompts.ts) handles `Ctrl+C` (`key.ctrl && key.name === 'c'`) for graceful exit.
- **Input validation**: `numberedSelect` in [prompts.ts](./prompts.ts) expects numeric input within range `1-${options.length}`, rejecting invalid answers with error `Invalid selection: ${answer}. Expected 1-${options.length}`.
- **`OPENCODE_AGENT_FILENAME`**: `'are-summarizer.md'` in [uninstall.ts](./uninstall.ts) defines the OpenCode agent file name.
- **`CONFIG_DIR`**: `'.agents-reverse-engineer'` in [uninstall.ts](./uninstall.ts) specifies the configuration folder name.

## Workflow & Conventions
- `registerClaudeHooks` and `registerGeminiHooks` in [operations.ts](./operations.ts) generate `node ${runtimeDir}/hooks/${hookDef.filename}` commands for insertion into Claude's and Gemini's `settings.json`, respectively, ensuring uniqueness. `registerGeminiHooks` strictly applies to `SessionStart` hooks.
- `buildCodexRulesFileContent` in [operations.ts](./operations.ts) formats rules as `prefix_rule = ${JSON.stringify(prefix)}` within `CODEX_RULES_FILENAME`.
- `buildLocalContextRulesContent` in [operations.ts](./operations.ts) provides multi-line instructions for the hierarchical loading of `AGENTS.override.md` and `AGENTS.md`, specifying override logic and caching behavior.
- `cleanupRawMode()` in [prompts.ts](./prompts.ts) restores terminal state by calling `process.stdin.setRawMode(false)` and `process.stdin.pause()`, integrating with `process.on('exit')` and `process.on('SIGINT')` to ensure consistent terminal reset.
- `uninstallFilesForRuntime` in [uninstall.ts](./uninstall.ts) executes uninstallation for a specific `runtime` at `location`, handling runtime-specific file deletions (e.g., Claude/Gemini remove `ARE_HOOKS` files; Codex removes `CODEX_RULES_FILENAME`; OpenCode removes `ARE_PLUGIN_FILENAMES` and `OPENCODE_AGENT_FILENAME`).
- `unregisterClaudeHooks` and `unregisterGeminiHooks` in [uninstall.ts](./uninstall.ts) use `jsonc-parser` to filter `SessionHook` and `GeminiHook` entries respectively from `settings.json`, removing empty hook objects.
- `cleanupEmptyDirs` in [uninstall.ts](./uninstall.ts) recursively removes `dirPath` if empty, ascending to parent directories unless a common runtime root is encountered.

## File Relationships
- [index.ts](./index.ts) is the central orchestrator, depending on [types.ts](./types.ts) for data structures, [paths.ts](./paths.ts) for path resolution, [banner.ts](./banner.ts) for console output, [prompts.ts](./prompts.ts) for user interaction, [operations.ts](./operations.ts) for installation logic, and [uninstall.ts](./uninstall.ts) for uninstallation logic.
- [operations.ts](./operations.ts) and [uninstall.ts](./uninstall.ts) both depend on `jsonc-parser` for modifying `settings.json`, [types.ts](./types.ts) for shared data types, and [paths.ts](./paths.ts) for installation paths. They also both integrate with `../integration/templates.js` (e.g., `getClaudeTemplates`, `getGeminiTemplates`) to retrieve runtime-specific templates.
- [paths.ts](./paths.ts) depends on `node:os`, `node:path`, `node:fs/promises` for file system interactions and [types.ts](./types.ts) for type definitions.
- [prompts.ts](./prompts.ts) uses `node:readline` for interactive input and `picocolors` for terminal styling.
- [banner.ts](./banner.ts) uses `picocolors` for styling and `../version.js` for retrieving the `VERSION`.