---
generated_at: 2026-02-09T16:10:54.231Z
content_hash: 40263a7bd78ebd3ee1c3d6a811dd894beca7932b0b3dc7aa460d8735c917aba2
purpose: `operations.ts` installs ARE command templates and session hooks to IDE runtime directories (~/.claude, ~/.opencode, ...
---
**`operations.ts` installs ARE command templates and session hooks to IDE runtime directories (~/.claude, ~/.opencode, ~/.gemini), registers hooks in settings.json, writes ARE-VERSION files, and verifies installations.**

## Exported Functions

**`installFiles(runtime: Runtime, location: Location, options: InstallOptions): InstallerResult[]`**
Installs command templates and hooks for one or all runtimes. When `runtime === 'all'`, calls `getAllRuntimes()` and maps `installFilesForRuntime()` across all supported runtimes. Returns array of `InstallerResult` objects with `filesCreated`, `filesSkipped`, `errors`, `hookRegistered`, `versionWritten` fields.

**`verifyInstallation(files: string[]): { success: boolean; missing: string[] }`**
Checks existence of file paths via `existsSync()`. Returns object with `success: true` if all files exist, otherwise `missing` array of absent paths.

**`registerHooks(basePath: string, runtime: Exclude<Runtime, 'all'>, dryRun: boolean): boolean`**
Registers ARE session hooks in `settings.json` for Claude and Gemini runtimes. Dispatches to `registerClaudeHooks()` or `registerGeminiHooks()` based on runtime. Returns `true` if any hooks were added, `false` if all already existed. Skips for OpenCode (uses plugin system).

**`registerPermissions(settingsPath: string, dryRun: boolean): boolean`**
Adds `ARE_PERMISSIONS` bash command patterns to Claude Code `settings.json` permissions.allow array. Returns `true` if any permissions added. Used to reduce friction for ARE commands during execution.

**`getPackageVersion(): string`**
Reads version from `package.json` via `fileURLToPath(import.meta.url)` → `path.join(__dirname, '..', '..', 'package.json')`. Returns version string or `'unknown'` on parse failure.

**`writeVersionFile(basePath: string, dryRun: boolean): void`**
Writes `ARE-VERSION` file containing result of `getPackageVersion()` to `basePath`. Used by session hooks to detect installed version. Skips if `dryRun === true`.

**`formatInstallResult(result: InstallerResult): string[]`**
Generates human-readable display lines showing runtime/location header, created/skipped file paths, hook registration status, and summary counts.

## Exported Interfaces

**`InstallOptions`**
```typescript
{
  force: boolean;    // Overwrite existing files
  dryRun: boolean;   // Preview without writing
}
```

## Internal Functions

**`installFilesForRuntime(runtime: Exclude<Runtime, 'all'>, location: Location, options: InstallOptions): InstallerResult`**
Core installation logic. Calls `resolveInstallPath()` to get base directory, `getTemplatesForRuntime()` for command templates, writes template files via `writeFileSync()` after `ensureDir()`, copies hooks/plugins via `readBundledHook()` → `writeFileSync()`, registers hooks in settings.json, calls `writeVersionFile()`. Returns `InstallerResult` with success status and file lists.

**`getTemplatesForRuntime(runtime: Exclude<Runtime, 'all'>): Template[]`**
Dispatches to `getClaudeTemplates()`, `getOpenCodeTemplates()`, or `getGeminiTemplates()` from `src/integration/templates.ts` based on runtime.

**`ensureDir(filePath: string): void`**
Creates parent directory for `filePath` via `mkdirSync(path.dirname(filePath), { recursive: true })` if it doesn't exist.

**`getBundledHookPath(hookName: string): string`**
Resolves path to bundled hook file in `hooks/dist/` relative to compiled module location. Uses `fileURLToPath(import.meta.url)` → `path.join(__dirname, '..', '..', 'hooks', 'dist', hookName)`.

**`readBundledHook(hookName: string): string`**
Reads hook file content via `getBundledHookPath()` and `readFileSync()`. Throws error if hook not found.

**`registerClaudeHooks(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean`**
Registers hooks in Claude Code format (nested `hooks` array). For each `ARE_HOOKS` entry, constructs `hookCommand: "node ${runtimeDir}/hooks/${filename}"`, checks if hook exists via command string match, appends `HookEvent` object with `hooks: [{ type: 'command', command }]` structure. Writes merged settings to `settingsPath`.

**`registerGeminiHooks(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean`**
Registers hooks in Gemini CLI format (flat object with `name` field). Constructs `GeminiHook: { name, type: 'command', command }`, checks existence, appends to event array. Writes merged settings.

## Hook/Plugin Definitions

**`ARE_HOOKS: HookDefinition[]`**
Array defining session hooks for Claude and Gemini. Currently empty (hooks disabled due to issues). Format:
```typescript
{ event: 'SessionStart' | 'SessionEnd', filename: string, name: string }
```
Previously included:
- `'are-check-update.js'` for SessionStart
- `'are-session-end.js'` for SessionEnd (commented out)

**`ARE_PLUGINS: PluginDefinition[]`**
Array defining plugins for OpenCode runtime. Format:
```typescript
{ srcFilename: string, destFilename: string }
```
Includes:
- `{ srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' }`
- SessionEnd plugin commented out

**`ARE_PERMISSIONS: string[]`**
Bash command permission patterns for Claude Code auto-allow. Glob patterns:
- `'Bash(npx agents-reverse-engineer@latest init*)'`
- `'Bash(npx agents-reverse-engineer@latest discover*)'`
- `'Bash(npx agents-reverse-engineer@latest generate*)'`
- `'Bash(npx agents-reverse-engineer@latest update*)'`
- `'Bash(npx agents-reverse-engineer@latest clean*)'`
- `'Bash(rm -f .agents-reverse-engineer/progress.log*)'`
- `'Bash(sleep *)'`

## Settings.json Schema

**`SettingsJson` (Claude Code format)**
```typescript
{
  hooks?: {
    SessionStart?: HookEvent[];
    SessionEnd?: HookEvent[];
  };
  permissions?: {
    allow?: string[];
    deny?: string[];
  };
}
```
Where `HookEvent = { hooks: SessionHook[] }` and `SessionHook = { type: 'command', command: string }`.

**`GeminiSettingsJson` (Gemini CLI format)**
```typescript
{
  hooks?: {
    SessionStart?: GeminiHook[];
    SessionEnd?: GeminiHook[];
  };
}
```
Where `GeminiHook = { name: string, type: 'command', command: string }`.

## Integration Points

Imports `resolveInstallPath()` and `getAllRuntimes()` from `./paths.js` for runtime directory resolution. Imports `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` from `../integration/templates.js` for command template content. Uses `Runtime`, `Location`, `InstallerResult` types from `./types.js`.

## File Writing Pattern

All writes follow pattern: `ensureDir(fullPath)` → `writeFileSync(fullPath, content, 'utf-8')`. Errors caught individually and pushed to `errors[]` array. Template files written from in-memory template objects, hook files copied from bundled `hooks/dist/` directory. Settings.json merges with existing content, preserving user hooks/permissions.

## Installation Workflow

For each runtime: resolve base path → get templates → iterate templates (skip if exists and !force, else write) → iterate hooks/plugins (skip if exists and !force, else copy from bundled) → register in settings.json → write VERSION file if files created. OpenCode installs to `plugins/` directory (auto-loaded), Claude/Gemini install to `hooks/` directory (requires settings.json registration).