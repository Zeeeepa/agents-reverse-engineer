---
generated_at: 2026-02-09T17:45:44.138Z
content_hash: 40263a7bd78ebd3ee1c3d6a811dd894beca7932b0b3dc7aa460d8735c917aba2
purpose: operations.ts implements file installation, verification, and settings.json hook/permission registration for ARE comm...
---
**operations.ts implements file installation, verification, and settings.json hook/permission registration for ARE command/hook deployment across Claude Code, OpenCode, and Gemini CLI runtimes.**

## Exported Functions

`installFiles(runtime: Runtime, location: Location, options: InstallOptions): InstallerResult[]` — installs command templates and hook/plugin files for specified runtime ('claude' | 'opencode' | 'gemini' | 'all'), returns array of InstallerResult with filesCreated/filesSkipped/errors/hookRegistered/versionWritten status.

`verifyInstallation(files: string[]): { success: boolean; missing: string[] }` — checks existsSync() for each file path, returns verification status with missing file list.

`registerHooks(basePath: string, runtime: Exclude<Runtime, 'all'>, dryRun: boolean): boolean` — writes hook configuration to settings.json for Claude/Gemini, returns true if hooks added, false if already existed.

`registerPermissions(settingsPath: string, dryRun: boolean): boolean` — adds ARE_PERMISSIONS bash command patterns to Claude Code settings.json permissions.allow array.

`getPackageVersion(): string` — reads version field from package.json via import.meta.url resolution, returns 'unknown' on error.

`writeVersionFile(basePath: string, dryRun: boolean): void` — writes getPackageVersion() result to ARE-VERSION file in basePath.

`formatInstallResult(result: InstallerResult): string[]` — generates human-readable lines showing runtime/location, created/skipped files, hook registration status, summary counts.

## Exported Interfaces

`InstallOptions { force: boolean; dryRun: boolean }` — controls file overwrite behavior and preview mode for install operations.

## Hook/Plugin Definitions

`ARE_HOOKS: HookDefinition[]` — array defining SessionStart/SessionEnd hooks with filename/event/name mappings (currently empty - hooks disabled due to issues).

`HookDefinition { event: 'SessionStart' | 'SessionEnd'; filename: string; name: string }` — hook metadata for Claude/Gemini format conversion.

`ARE_PLUGINS: PluginDefinition[]` — array mapping OpenCode plugin source filenames (prefixed 'opencode-') to destination filenames in .opencode/plugins/ (are-check-update.js; are-session-end.js disabled).

`PluginDefinition { srcFilename: string; destFilename: string }` — source-to-destination mapping for OpenCode plugin installation.

## Settings.json Schema

`SettingsJson { hooks?: { SessionStart?: HookEvent[]; SessionEnd?: HookEvent[] }; permissions?: { allow?: string[]; deny?: string[] } }` — Claude Code settings.json structure with nested hooks arrays and permissions.

`HookEvent { hooks: SessionHook[] }` — Claude format wraps hooks in nested array.

`SessionHook { type: 'command'; command: string }` — individual hook definition with command string.

`GeminiSettingsJson { hooks?: { SessionStart?: GeminiHook[]; SessionEnd?: GeminiHook[] } }` — Gemini CLI settings.json structure with flat hook arrays.

`GeminiHook { name: string; type: 'command'; command: string }` — Gemini format includes explicit name field.

## Hook Registration Logic

`registerClaudeHooks(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean` — loads settings.json via readFileSync(), merges ARE_HOOKS into nested HookEvent structure, writes JSON if addedAny=true, returns false if all hooks pre-existing.

`registerGeminiHooks(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean` — loads settings.json, merges ARE_HOOKS into flat GeminiHook array structure, uses hookDef.name field for Gemini format.

Hook command pattern: `node ${runtimeDir}/hooks/${hookDef.filename}` where runtimeDir='.claude' or '.gemini'.

Duplicate detection: checks existing hooks via `event.hooks?.some((h) => h.command === hookCommand)` for Claude, `hooks[event].some((h) => h.command === hookCommand)` for Gemini.

## Permission Registration

`ARE_PERMISSIONS: string[]` — bash command patterns for auto-allow:
- `'Bash(npx agents-reverse-engineer@latest init*)'`
- `'Bash(npx agents-reverse-engineer@latest discover*)'`
- `'Bash(npx agents-reverse-engineer@latest generate*)'`
- `'Bash(npx agents-reverse-engineer@latest update*)'`
- `'Bash(npx agents-reverse-engineer@latest clean*)'`
- `'Bash(rm -f .agents-reverse-engineer/progress.log*)'`
- `'Bash(sleep *)'`

Merges via `settings.permissions.allow.includes(perm)` check before push, writes settings.json if addedAny=true.

## File Operations

`installFilesForRuntime(runtime: Exclude<Runtime, 'all'>, location: Location, options: InstallOptions): InstallerResult` — resolves basePath via resolveInstallPath(), fetches templates via getTemplatesForRuntime(), writes command files, installs hooks/plugins based on runtime type, calls registerHooks()/registerPermissions() for Claude, writeVersionFile() on success.

Template path extraction: splits template.path by '/' and slices first segment (runtime directory prefix) to get relativePath joined to basePath.

File write flow: existsSync() skip check unless options.force=true, ensureDir() via mkdirSync recursive, writeFileSync() with UTF-8, error capture to errors[] array.

Hook/plugin installation branches:
- Claude/Gemini: iterate ARE_HOOKS, call readBundledHook(), write to basePath/hooks/, invoke registerHooks()
- OpenCode: iterate ARE_PLUGINS, call readBundledHook(pluginDef.srcFilename), write to basePath/plugins/, set hookRegistered=true

## Bundled Hook Resolution

`getBundledHookPath(hookName: string): string` — resolves from dist/installer/operations.js up two levels to project root, then joins 'hooks/dist/' + hookName.

`readBundledHook(hookName: string): string` — reads hook content via getBundledHookPath(), throws Error if !existsSync().

Path navigation: uses fileURLToPath(import.meta.url) for ESM compatibility, dirname resolution via path.dirname(), relative join via `__dirname/../../../hooks/dist/`.

## Template Retrieval

`getTemplatesForRuntime(runtime: Exclude<Runtime, 'all'>)` — switch dispatches to getClaudeTemplates() | getOpenCodeTemplates() | getGeminiTemplates() from src/integration/templates.ts.

## Utility Functions

`ensureDir(filePath: string): void` — creates parent directory via mkdirSync({ recursive: true }) if !existsSync(dirname).

## Integration Points

Imports resolveInstallPath() and getAllRuntimes() from `./paths.js` for runtime-specific directory resolution.

Imports getClaudeTemplates(), getOpenCodeTemplates(), getGeminiTemplates() from `../integration/templates.js` for command file content.

Runtime type discriminated union: `Runtime = 'claude' | 'opencode' | 'gemini' | 'all'` determines installation target and hook format.

Location type: `Location = 'global' | 'local'` controls base path resolution (e.g., ~/.claude vs ./.claude).

## Error Handling

Non-blocking errors: JSON parse failures in registerHooks() start with empty settings object, writeVersionFile() failures suppressed (non-fatal), ARE-VERSION write errors don't populate errors[] array.

Blocking errors: readBundledHook() throws if hook not found, file write failures push to errors[] and set success=false in InstallerResult.

## Dry-Run Mode

When options.dryRun=true: skips writeFileSync() calls for templates/hooks/settings.json/ARE-VERSION, still populates filesCreated[] for preview output, sets versionWritten=false.