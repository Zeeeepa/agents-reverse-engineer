---
generated_at: 2026-02-09T21:29:47.615Z
content_hash: 40263a7bd78ebd3ee1c3d6a811dd894beca7932b0b3dc7aa460d8735c917aba2
purpose: operations.ts orchestrates file copying, settings.json hook registration, and permission configuration for IDE comman...
---
**operations.ts orchestrates file copying, settings.json hook registration, and permission configuration for IDE command/hook installation across Claude Code, Gemini CLI, and OpenCode runtimes.**

## Exported Functions

**installFiles(runtime: Runtime, location: Location, options: InstallOptions): InstallerResult[]** — installs command templates and hooks for one or all runtimes, returning array of InstallerResult objects. When runtime='all', iterates getAllRuntimes() and calls installFilesForRuntime() for each. Otherwise returns single-element array from installFilesForRuntime().

**verifyInstallation(files: string[]): { success: boolean; missing: string[] }** — checks existsSync() for each file path, returns missing array of non-existent files.

**registerHooks(basePath: string, runtime: Exclude<Runtime, 'all'>, dryRun: boolean): boolean** — updates settings.json with SessionStart/SessionEnd hook registrations, returns true if any hook added. Routes to registerClaudeHooks() or registerGeminiHooks() based on runtime.

**registerPermissions(settingsPath: string, dryRun: boolean): boolean** — adds ARE_PERMISSIONS array entries to settings.json permissions.allow for Claude Code, returns true if any permission added.

**getPackageVersion(): string** — reads package.json from `__dirname/../../package.json` via fileURLToPath(import.meta.url), returns version field or 'unknown'.

**writeVersionFile(basePath: string, dryRun: boolean): void** — writes getPackageVersion() result to `${basePath}/ARE-VERSION`.

**formatInstallResult(result: InstallerResult): string[]** — generates human-readable lines showing created/skipped files, hook registration status, summary counts.

## Exported Interfaces

**InstallOptions** — `{ force: boolean; dryRun: boolean }` controls overwrite behavior and preview mode.

## Internal Architecture

**installFilesForRuntime(runtime: Exclude<Runtime, 'all'>, location: Location, options: InstallOptions): InstallerResult** — main worker function handling:
1. Resolves basePath via resolveInstallPath()
2. Fetches templates via getTemplatesForRuntime()
3. Iterates templates, writes to `${basePath}/${relativePath}` after extracting path component past runtime directory (e.g., `commands/are/generate.md` from `.claude/commands/are/generate.md`)
4. For claude/gemini: copies ARE_HOOKS entries from getBundledHookPath() to `${basePath}/hooks/`, then calls registerHooks() and optionally registerPermissions() for Claude
5. For opencode: copies ARE_PLUGINS entries from srcFilename to `${basePath}/plugins/${destFilename}`, sets hookRegistered=true
6. Calls writeVersionFile() if filesCreated.length > 0 and not dryRun
7. Returns InstallerResult with success, filesCreated, filesSkipped, errors, hookRegistered, versionWritten

**getTemplatesForRuntime(runtime: Exclude<Runtime, 'all'>)** — switches on runtime to return getClaudeTemplates(), getOpenCodeTemplates(), or getGeminiTemplates() from `../integration/templates.js`.

**getBundledHookPath(hookName: string): string** — constructs path from `__dirname/../../hooks/dist/${hookName}` where `__dirname` is derived via fileURLToPath(import.meta.url). Hooks bundled during npm prepublishOnly via build-hooks.js.

**readBundledHook(hookName: string): string** — reads hook content from getBundledHookPath(), throws Error if not found.

**ensureDir(filePath: string): void** — calls mkdirSync(path.dirname(filePath), { recursive: true }) if directory doesn't exist.

## Hook Registration Formats

**registerClaudeHooks(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean** — parses settings.json as SettingsJson schema, ensures settings.hooks[event] exists for each ARE_HOOKS entry, appends HookEvent with nested hooks array containing `{ type: 'command', command: 'node ${runtimeDir}/hooks/${filename}' }`. Writes JSON with 2-space indentation.

**registerGeminiHooks(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean** — parses settings.json as GeminiSettingsJson schema, appends flat GeminiHook objects with name field to settings.hooks[event] arrays. Command format identical to Claude: `node ${runtimeDir}/hooks/${filename}`.

**SettingsJson** — Claude Code schema with `hooks?: { SessionStart?: HookEvent[]; SessionEnd?: HookEvent[] }`, `permissions?: { allow?: string[]; deny?: string[] }`. HookEvent contains `hooks: SessionHook[]` where SessionHook is `{ type: 'command'; command: string }`.

**GeminiSettingsJson** — simpler schema with `hooks?: { SessionStart?: GeminiHook[]; SessionEnd?: GeminiHook[] }` where GeminiHook is `{ name: string; type: 'command'; command: string }`.

## Hook and Plugin Definitions

**ARE_HOOKS: HookDefinition[]** — currently empty array (both SessionStart and SessionEnd entries commented out due to "causing issues"). HookDefinition schema: `{ event: 'SessionStart' | 'SessionEnd'; filename: string; name: string }`. Intended entries:
- `{ event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' }`
- `{ event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }`

**ARE_PLUGINS: PluginDefinition[]** — OpenCode plugin mappings with one active entry and one commented. PluginDefinition schema: `{ srcFilename: string; destFilename: string }`. Active entry maps `opencode-are-check-update.js` → `are-check-update.js`. Commented entry maps `opencode-are-session-end.js` → `are-session-end.js`.

**ARE_PERMISSIONS: string[]** — array of 7 bash command patterns for Claude Code auto-approval:
- `Bash(npx agents-reverse-engineer@latest init*)`
- `Bash(npx agents-reverse-engineer@latest discover*)`
- `Bash(npx agents-reverse-engineer@latest generate*)`
- `Bash(npx agents-reverse-engineer@latest update*)`
- `Bash(npx agents-reverse-engineer@latest clean*)`
- `Bash(rm -f .agents-reverse-engineer/progress.log*)`
- `Bash(sleep *)`

## Error Handling

File write failures append to errors array with format `Failed to write ${fullPath}: ${err}` or `Failed to write hook ${hookPath}: ${err}`. Subsequent filesCreated filtering checks `errors.some((e) => e.includes(hookPath))` to prevent listing failed files as created. JSON parse failures in registerHooks/registerPermissions silently reset settings to empty object `{}`. Missing bundled hooks throw Error in readBundledHook(). Version file write failures non-fatal (caught without adding to errors). InstallerResult.success = errors.length === 0.

## File System Conventions

Template paths contain runtime directory prefix (e.g., `.claude/commands/are/generate.md`). Relative path extraction via `template.path.split('/').slice(1).join('/')` removes first segment to yield `commands/are/generate.md`. Full installation path: `${basePath}/${relativePath}` where basePath from resolveInstallPath(runtime, location). Hook paths: `${basePath}/hooks/${filename}`. OpenCode plugin paths: `${basePath}/plugins/${destFilename}`. Settings path: `${basePath}/settings.json`. Version file: `${basePath}/ARE-VERSION`.