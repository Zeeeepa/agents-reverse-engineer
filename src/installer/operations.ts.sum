---
generated_at: 2026-02-09T15:07:54.480Z
content_hash: 40263a7bd78ebd3ee1c3d6a811dd894beca7932b0b3dc7aa460d8735c917aba2
purpose: operations.ts orchestrates installer file operations: copies command templates and hook/plugin files to runtime direc...
---
**operations.ts orchestrates installer file operations: copies command templates and hook/plugin files to runtime directories (`~/.claude`, `~/.gemini`, `~/.opencode`), registers SessionStart/SessionEnd hooks in settings.json, writes version tracking files, and verifies installations.**

## Exported Functions

**installFiles(runtime: Runtime, location: Location, options: InstallOptions): InstallerResult[]**
Entry point for installation operations. If `runtime === 'all'`, maps over `getAllRuntimes()` and calls `installFilesForRuntime()` for each; otherwise returns single-element array with result for specified runtime.

**verifyInstallation(files: string[]): { success: boolean; missing: string[] }**
Checks existence of file paths via `existsSync()`, returns object with `success` flag and `missing` array of non-existent paths.

**registerHooks(basePath: string, runtime: Exclude<Runtime, 'all'>, dryRun: boolean): boolean**
Registers ARE hooks in settings.json for Claude/Gemini runtimes. Routes to `registerClaudeHooks()` or `registerGeminiHooks()` based on runtime parameter. Returns true if any hook was added, false if all already existed.

**registerPermissions(settingsPath: string, dryRun: boolean): boolean**
Adds ARE bash command permissions to Claude Code settings.json. Appends entries from `ARE_PERMISSIONS` array to `settings.permissions.allow[]` if not already present. Returns true if permissions were added.

**formatInstallResult(result: InstallerResult): string[]**
Generates human-readable lines from `InstallerResult` showing created/skipped files, hook registration status, and summary counts.

**getPackageVersion(): string**
Reads package.json version via `fileURLToPath(import.meta.url)` navigation (dist/installer/operations.js → project root → package.json). Returns version string or 'unknown' on failure.

**writeVersionFile(basePath: string, dryRun: boolean): void**
Writes `ARE-VERSION` file to basePath containing `getPackageVersion()` output. Used for update checks in session hooks.

## Internal Functions

**installFilesForRuntime(runtime: Exclude<Runtime, 'all'>, location: Location, options: InstallOptions): InstallerResult**
Core installation logic: iterates over templates from `getTemplatesForRuntime()`, writes files to `resolveInstallPath()` with `ensureDir()` directory creation, respects `force`/`dryRun` options. Installs hooks for Claude/Gemini via `readBundledHook()` + `writeFileSync()`, plugins for OpenCode. Calls `registerHooks()` for Claude/Gemini, `registerPermissions()` for Claude only. Returns `InstallerResult` with `filesCreated`, `filesSkipped`, `errors`, `hookRegistered`, `versionWritten`.

**ensureDir(filePath: string): void**
Extracts directory via `path.dirname()`, creates with `mkdirSync({ recursive: true })` if not exists.

**getBundledHookPath(hookName: string): string**
Resolves hook file location in bundled npm package. Navigates from `dist/installer/operations.js` up two levels to project root, then to `hooks/dist/${hookName}`. Hook files copied to `hooks/dist/` during `npm run build:hooks` (see scripts/build-hooks.js).

**readBundledHook(hookName: string): string**
Reads hook content via `getBundledHookPath()` + `readFileSync()`. Throws Error if hook file not found.

**getTemplatesForRuntime(runtime: Exclude<Runtime, 'all'>)**
Routes to `getClaudeTemplates()`, `getOpenCodeTemplates()`, or `getGeminiTemplates()` based on runtime parameter.

**registerClaudeHooks(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean**
Parses settings.json, iterates over `ARE_HOOKS` array, appends hook definitions with format `{ hooks: [{ type: 'command', command: 'node ~/.claude/hooks/are-session-end.js' }] }` to `settings.hooks[event]` arrays. Checks for duplicates via command string match. Writes JSON with 2-space indent.

**registerGeminiHooks(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean**
Similar to `registerClaudeHooks()` but uses flat Gemini hook format: `{ name: 'are-session-end', type: 'command', command: '...' }` without nested `hooks` array.

## Key Data Structures

**InstallOptions**
Interface with `force: boolean` (overwrite existing files) and `dryRun: boolean` (preview mode).

**SettingsJson**
Claude Code settings.json schema with optional `hooks?: { SessionStart?: HookEvent[], SessionEnd?: HookEvent[] }` and `permissions?: { allow?: string[], deny?: string[] }`.

**GeminiSettingsJson**
Gemini CLI settings.json schema with simplified hook format: `hooks?: { SessionStart?: GeminiHook[], SessionEnd?: GeminiHook[] }`.

**HookDefinition**
Metadata for ARE hooks: `event: 'SessionStart' | 'SessionEnd'`, `filename: string`, `name: string` (for Gemini format).

**PluginDefinition**
OpenCode plugin metadata: `srcFilename: string` (source in hooks/dist/ with `opencode-` prefix), `destFilename: string` (destination in .opencode/plugins/).

## Constants

**ARE_HOOKS: HookDefinition[]**
Currently empty array (both hooks disabled due to reported issues). Previously contained are-check-update.js (SessionStart) and are-session-end.js (SessionEnd).

**ARE_PLUGINS: PluginDefinition[]**
OpenCode plugin registrations: `opencode-are-check-update.js` (enabled), `opencode-are-session-end.js` (disabled). Plugins auto-loaded from .opencode/plugins/ directory.

**ARE_PERMISSIONS: string[]**
Bash command permission patterns for Claude Code: `npx agents-reverse-engineer@latest [init|discover|generate|update|clean]*`, `rm -f .agents-reverse-engineer/progress.log*`, `sleep *`. Reduces friction by pre-approving ARE command execution.

## Integration Points

**Dependencies:**
- `../integration/templates.ts`: Provides `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` for command file content
- `./paths.ts`: `resolveInstallPath()` for runtime directory resolution, `getAllRuntimes()` for multi-runtime installation
- `./types.ts`: `Runtime`, `Location`, `InstallerResult` type definitions
- Node.js fs/path APIs for file operations

**Settings.json Mutation:**
Modifies Claude/Gemini settings.json to register hooks in `hooks.SessionStart/SessionEnd` arrays and permissions in `permissions.allow` array. Uses JSON.parse/stringify with 2-space indent preservation.

**Hook File Bundling:**
Expects pre-built hooks in `hooks/dist/` (created by scripts/build-hooks.js during `npm run build:hooks`). Template paths follow runtime-specific patterns: `.claude/commands/are/*.md`, `.opencode/commands/*.md`, `.gemini/commands/*.toml`.

## Critical Design Patterns

**Runtime Dispatch:**
`installFiles()` uses discriminated union pattern on `runtime` parameter: 'all' triggers `map()` over all runtimes, specific runtime calls `installFilesForRuntime()` directly. Ensures consistent return type `InstallerResult[]`.

**Hook Format Variants:**
Claude hooks use nested structure `{ hooks: [{ type, command }] }`, Gemini uses flat structure `{ name, type, command }`. OpenCode uses plugin system instead of hooks. Abstraction handled via separate `registerClaudeHooks()` / `registerGeminiHooks()` implementations.

**Force/DryRun Strategy:**
All file writes guarded by `if (!dryRun)` checks. Existence checks use `if (existsSync(path) && !force)` pattern to skip/overwrite. `filesCreated` array populated before actual write in dry-run mode for preview accuracy.

**Error Accumulation:**
Non-fatal errors appended to `errors: string[]` array instead of throwing. Installation continues for remaining files. `success` computed as `errors.length === 0` at end of `installFilesForRuntime()`.