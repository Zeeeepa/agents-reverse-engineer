<!-- Generated by agents-reverse-engineer v0.8.2 -->

# src/quality

Post-generation validation subsystem detecting documentation drift (code-vs-doc), symbol duplication (code-vs-code), and broken path references (phantom-paths) via regex-based export extraction, heuristic matching, and dual-resolution path validation, with severity-tagged reporting to CLI/markdown formats.

## Contents

**[index.ts](./index.ts)** — Public API barrel re-exporting types (`InconsistencySeverity`, `CodeDocInconsistency`, `CodeCodeInconsistency`, `PhantomPathInconsistency`, `Inconsistency`, `InconsistencyReport`, `FindabilityResult`) and functions (`extractExports`, `checkCodeVsDoc`, `checkCodeVsCode`, `buildInconsistencyReport`, `formatReportForCli`, `formatReportAsMarkdown`, `checkPhantomPaths`, `validateFindability`) from inconsistency/phantom-paths/density subsystems.

**[types.ts](./types.ts)** — Exports discriminated union `Inconsistency` with `type` discriminant: `CodeDocInconsistency` (`missingFromDoc`, `missingFromCode`, `purposeMismatch`), `CodeCodeInconsistency` (`files[]`, `pattern: 'duplicate-export'`), `PhantomPathInconsistency` (`referencedPath`, `resolvedTo`, `context`). `InconsistencyReport` aggregates `issues[]` with `summary` counts (total, codeVsDoc, codeVsCode, phantomPaths, errors, warnings, info) and `metadata` (timestamp, projectRoot, filesChecked, durationMs). `FindabilityResult` interface (`symbolsTested`, `symbolsFound`, `symbolsMissing`, `score`) for density validation.

## Subdirectories

**[density/](./density/)** — Provides `validateFindability()` stub (currently disabled) returning empty array; signature accepts `agentsMdContent` and `Map<string, SumFileContent>` for future symbol presence validation in AGENTS.md without LLM calls. `FindabilityResult` interface defines `score = symbolsFound.length / symbolsTested.length` ratio.

**[inconsistency/](./inconsistency/)** — Three validators: `code-vs-doc.ts` `checkCodeVsDoc()` compares `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` extracted symbols against `.sum` summary text via case-sensitive `includes()`; `code-vs-code.ts` `checkCodeVsCode()` flags duplicate exports when `exportMap.get(symbolName).length >= 2`; `reporter.ts` `buildInconsistencyReport()` aggregates findings, `formatReportForCli()` emits `[ERROR]`/`[WARN]`/`[INFO]` tagged output, `formatReportAsMarkdown()` generates pipe-delimited table.

**[phantom-paths/](./phantom-paths/)** — `validator.ts` `checkPhantomPaths()` extracts paths via three regex patterns (markdown links `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`, backtick-quoted `/`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g`, prose `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`), applies six exclusion patterns (`/node_modules/`, `/\.git\//`, `/^https?:/`, `/\{\{/`, `/\$\{/`, `/\*/`, `/\{[^}]*,[^}]*\}/`), resolves via dual strategy (relative to AGENTS.md directory + project root), handles `.js`→`.ts` substitution, returns `PhantomPathInconsistency[]` for nonexistent paths with `${line}:${referencedPath}` deduplication.

## Integration

`src/orchestration/runner.ts` `CommandRunner.run()` invokes quality checks in two phases: **post-phase-1-quality** (throttled directory group checks via `runPool()` concurrency 10: `checkCodeVsDoc()` detects undocumented exports, `checkCodeVsCode()` finds duplicates), **post-phase-2** (`checkPhantomPaths()` validates AGENTS.md links). Results aggregated via `buildInconsistencyReport()`, formatted via `formatReportForCli()`, written to stderr via `src/output/logger.ts`.

## Behavioral Contracts

### Export Extraction Regex
```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```
Captures identifier in group 1 after export keyword and declaration type.

### Path Extraction Patterns
```regex
/\[(?:[^\]]*)\]\((\.[^)]+)\)/g  // Markdown links [text](./path)
/`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g  // Backtick-quoted src/foo.ts or ../bar.js
/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi  // Prose references
```

### Resolution Strategy
```javascript
tryPaths = [
  path.resolve(agentsMdDir, rawPath),
  path.resolve(projectRoot, rawPath),
  ...(rawPath.endsWith('.js') ? [
    path.resolve(agentsMdDir, rawPath.slice(0, -3) + '.ts'),
    path.resolve(projectRoot, rawPath.slice(0, -3) + '.ts')
  ] : [])
]
```

### Duplicate Export Detection
```javascript
exportMap.get(symbolName).length >= 2  // Flags when 2+ files export same identifier
```

### Documentation Mention Check
```javascript
sumContent.summary.includes(symbolName)  // Case-sensitive substring match in .sum summary
```

### Severity Levels
- **error**: Blocking validation failures (unused in current checks)
- **warning**: Documentation drift (`code-vs-doc`), duplicate exports (`code-vs-code`), broken paths (`phantom-path`)
- **info**: Advisory findings (unused)

### CLI Report Format
```
=== Inconsistency Report ===
Checked N files in Nms

[WARN] code-vs-doc: Documentation out of sync: N exports undocumented
  File: path/to/file.ts
```

### Markdown Report Format
```markdown
## Inconsistency Report
**Checked N files in Nms**

| Severity | Type | Description | Location |
|----------|------|-------------|----------|
| `warning` | `code-vs-doc` | Documentation out of sync | `path/to/file.ts` |
```