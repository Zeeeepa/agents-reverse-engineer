<!-- Generated by agents-reverse-engineer -->

# src/quality

Post-generation validation suite detecting code-documentation inconsistencies via regex-based export extraction, duplicate symbol tracking, phantom path resolution, and structured reporting with discriminated union types.

## Contents

### Core API

**[index.ts](./index.ts)** — Barrel export aggregating all quality validators (`checkCodeVsDoc`, `checkCodeVsCode`, `checkPhantomPaths`, `validateFindability`) and report builders (`buildInconsistencyReport`, `formatReportForCli`) from subdirectories. Re-exports discriminated union types (`CodeDocInconsistency`, `CodeCodeInconsistency`, `PhantomPathInconsistency`, `Inconsistency`, `InconsistencyReport`) and `FindabilityResult` from `types.ts` and `density/validator.ts`.

**[types.ts](./types.ts)** — Defines discriminated union schema with `InconsistencySeverity` (`'info' | 'warning' | 'error'`), `CodeDocInconsistency` (exports missing from `.sum` summaries), `CodeCodeInconsistency` (duplicate symbols across files), `PhantomPathInconsistency` (unresolvable AGENTS.md path references), `Inconsistency` union type, and `InconsistencyReport` aggregate structure with metadata (timestamp/projectRoot/filesChecked/durationMs) and summary counts by type/severity.

## Subdirectories

**[inconsistency/](./inconsistency/)** — Regex-based validators: `code-vs-doc.ts` extracts exports via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` and verifies presence in `.sum` summaries via substring search, `code-vs-code.ts` aggregates exports into `Map<symbol, string[]>` to detect duplicates, `reporter.ts` constructs `InconsistencyReport` with type guard iteration and renders plain-text CLI output.

**[phantom-paths/](./phantom-paths/)** — Validates AGENTS.md references: `validator.ts` applies three regex patterns (markdown links, backtick-quoted paths, prose-embedded paths) with six SKIP_PATTERNS exclusions, resolves candidates relative to AGENTS.md directory and project root with `.js`→`.ts` fallback, returns `PhantomPathInconsistency[]` for failed `existsSync()` checks. `index.ts` re-exports `checkPhantomPaths`.

**[density/](./density/)** — Disabled findability validator: `validator.ts` defines `validateFindability()` returning empty array since `SumFileContent.publicInterface` removal, signature preserved for future structured metadata restoration. Exports `FindabilityResult` type with `symbolsTested`/`symbolsFound`/`symbolsMissing`/`score` fields.

## Validation Pipeline

**Code-vs-Doc Consistency:**  
`extractExports()` applies regex to source content, `checkCodeVsDoc()` verifies all extracted symbols appear in `.sum` summary text via `includes()`, returns `CodeDocInconsistency` with `missingFromDoc[]` arrays for undocumented exports.

**Code-vs-Code Duplicate Detection:**  
`checkCodeVsCode()` builds symbol-to-paths map via two-pass traversal, filters `exportMap.entries()` for paths.length > 1, returns `CodeCodeInconsistency[]` with `pattern: 'duplicate-export'` and `severity: 'warning'`.

**Phantom Path Resolution:**  
`checkPhantomPaths()` extracts path-like strings from AGENTS.md via PATH_PATTERNS, applies SKIP_PATTERNS filter, attempts four resolution candidates (AGENTS.md directory, project root, `.ts` fallback), reports `PhantomPathInconsistency` for unresolved references with deduplication via `seen` Set.

**Report Aggregation:**  
`buildInconsistencyReport()` aggregates `Inconsistency[]` via type guard iteration (`issue.type === 'code-vs-doc'`), computes type/severity counts, wraps in `InconsistencyReport` with metadata. `formatReportForCli()` renders multi-line plain-text with severity tags (`[ERROR]`, `[WARN]`, `[INFO]`) for ANSI color wrapping in `src/output/logger.ts`.

## Integration Points

**Upstream:** `src/cli/generate.ts` and `src/cli/update.ts` call validators after Phase 1 (`.sum` generation) and Phase 2 (AGENTS.md aggregation), pass discovered files/content to `checkCodeVsDoc()`, `checkCodeVsCode()`, `checkPhantomPaths()`, aggregate results via `buildInconsistencyReport()`.

**Downstream:** Formatted reports from `formatReportForCli()` logged to stderr via `logger.error()` with picocolors wrapping (`pc.red()`, `pc.yellow()`). Metrics written to `.agents-reverse-engineer/progress.log` as `code-vs-doc/code-vs-code inconsistencies: N`.

**Type Dependencies:** Imports `SumFileContent` from `../generation/writers/sum.js` for parsed `.sum` schema, uses `path.resolve()`, `fs.existsSync()` from Node.js stdlib for phantom path resolution.

## Limitations

**Regex-Based Extraction:** Misses destructured exports, namespace exports (`export * from`), dynamic `export {}` statements. Relies on statement-level syntax matching without AST traversal.

**Substring Matching:** `sumText.includes(exportName)` yields false negatives for prose mentions unrelated to API surface (e.g., "exports data" matching `exports`). No semantic context analysis.

**No AST Analysis:** Duplicate detection operates on symbol names only, cannot distinguish intentional duplication (facade pattern, barrel re-exports) from conflicts. Legacy `missingFromCode` field in `CodeDocInconsistency` always empty after `publicInterface` removal.

**Disabled Density Validator:** `validateFindability()` inoperative until structured metadata extraction restored to `.sum` frontmatter schema.