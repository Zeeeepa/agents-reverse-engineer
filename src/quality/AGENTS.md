<!-- Generated by agents-reverse-engineer -->

# src/quality

Three-validator quality gate system enforcing documentation-code consistency: `code-vs-doc` detects undocumented exports via regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, `code-vs-code` flags duplicate symbols across files, `phantom-paths` validates AGENTS.md path references via three-pattern extraction (markdown links `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`, backtick paths, prose references) and dual-resolution strategy (AGENTS.md-relative → project-root-relative → `.js`→`.ts` substitution), density validation stubbed pending metadata-driven reimplementation.

## Contents

**[index.ts](./index.ts)** — Re-exports `InconsistencySeverity`, `CodeDocInconsistency`, `CodeCodeInconsistency`, `PhantomPathInconsistency`, `Inconsistency`, `InconsistencyReport`, `FindabilityResult` from `types.js`; `extractExports`, `checkCodeVsDoc` from `inconsistency/code-vs-doc.js`; `checkCodeVsCode` from `inconsistency/code-vs-code.js`; `buildInconsistencyReport`, `formatReportForCli`, `formatReportAsMarkdown` from `inconsistency/reporter.js`; `checkPhantomPaths` from `phantom-paths/index.js`; `validateFindability` from `density/validator.js`.

**[types.ts](./types.ts)** — Defines `InconsistencySeverity` ('info' | 'warning' | 'error'), `CodeDocInconsistency` (type: 'code-vs-doc', details: `missingFromDoc`, `missingFromCode`, `purposeMismatch?`), `CodeCodeInconsistency` (type: 'code-vs-code', `pattern`, `files`), `PhantomPathInconsistency` (type: 'phantom-path', details: `referencedPath`, `resolvedTo`, `context`), discriminated `Inconsistency` union, `InconsistencyReport` (metadata: timestamp/projectRoot/filesChecked/durationMs, `issues`, summary: total/codeVsDoc/codeVsCode/phantomPaths/errors/warnings/info).

## Subdirectories

**[inconsistency/](./inconsistency/)** — Exports `extractExports()` regex-based symbol parser, `checkCodeVsDoc()` comparing source exports against `.sum` summary via case-sensitive `includes()`, `checkCodeVsCode()` mapping export names to file paths and flagging duplicates with 'warning' severity, `buildInconsistencyReport()` aggregating `Inconsistency[]` with summary counts, `formatReportForCli()` rendering severity-tagged plain text, `formatReportAsMarkdown()` generating pipe-delimited tables.

**[phantom-paths/](./phantom-paths/)** — Exports `checkPhantomPaths()` extracting paths via `PATH_PATTERNS` (markdown links, backtick paths `/`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g`, prose references `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`), filtering via `SKIP_PATTERNS` (node_modules, .git, http, templates, globs, brace expansion), dual-resolution (AGENTS.md-relative → project-root-relative), `.js`→`.ts` substitution fallback, `existsSync()` validation, returning `PhantomPathInconsistency` with 120-char context line.

**[density/](./density/)** — Exports `FindabilityResult` (filePath, symbolsTested, symbolsFound, symbolsMissing, score) and `validateFindability()` stub returning empty array; previously performed string matching of `.sum` exported symbols against `AGENTS.md` content, awaiting structured metadata extraction approach.

## Architecture

**Integration Pipeline**: `src/orchestration/runner.ts` `CommandRunner.run()` executes post-phase-1-quality (`checkCodeVsDoc()` and `checkCodeVsCode()` validate file `.sum` outputs) and post-phase-2 (`checkPhantomPaths()` validates directory `AGENTS.md` aggregates), aggregates via `buildInconsistencyReport()`, emits via `formatReportForCli()` to stderr.

**Discriminated Reporting**: `Inconsistency` union with `type` discriminant ('code-vs-doc' | 'code-vs-code' | 'phantom-path') enables type-safe filtering in `buildInconsistencyReport()` summary counts (`issues.filter(i => i.type === 'code-vs-doc').length`).

**Severity Classification**: `InconsistencySeverity` enum drives CLI formatting (`[ERROR]`/`[WARN]`/`[INFO]` prefixes) and future filtering thresholds; currently `code-vs-doc` defaults 'warning', `code-vs-code` defaults 'warning', `phantom-paths` defaults 'warning'.

## Behavioral Contracts

### Export Extraction Regex
```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```
Captures identifier in group 1, ignores re-exports, multiline declarations, commented exports.

### Path Extraction Patterns
- Markdown links: `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`
- Backtick paths: `/`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g`
- Prose references: `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`

### Path Resolution Strategy
```typescript
tryPaths = [
  path.resolve(agentsMdDir, rawPath),
  path.resolve(projectRoot, rawPath),
  ...(rawPath.endsWith('.js') ? [
    path.resolve(agentsMdDir, rawPath.slice(0, -3) + '.ts'),
    path.resolve(projectRoot, rawPath.slice(0, -3) + '.ts')
  ] : [])
]
```

### Path Exclusion Patterns
```javascript
SKIP_PATTERNS = [
  /node_modules/,
  /\.git\//,
  /^https?:/,
  /\{\{/,        // Template placeholders
  /\$\{/,        // Template literals
  /\*/,          // Glob patterns
  /\{[^}]*,[^}]*\}/  // Brace expansion
]
```

### Duplicate Symbol Detection
```typescript
exportMap: Map<string, Set<string>>  // symbol name → file paths
duplicates = [...exportMap.entries()].filter(([_, paths]) => paths.size >= 2)
```

### Documentation Match Heuristic
```typescript
missingFromDoc = exports.filter(name => !sumContent.summary.includes(name))
// Case-sensitive substring match; does not validate semantic context
```

### CLI Report Format
```
=== Inconsistency Report ===
Checked N files in Nms

[WARN] Documentation out of sync: M exports undocumented
  File: src/foo.ts
  Doc:  src/foo.ts.sum

[ERROR] Duplicate export detected: Bar
  Files:
    - src/a.ts
    - src/b.ts
```

### InconsistencyReport Schema
```typescript
{
  metadata: {
    timestamp: string,      // ISO 8601
    projectRoot: string,
    filesChecked: number,
    durationMs: number
  },
  issues: Inconsistency[],
  summary: {
    total: number,
    codeVsDoc: number,
    codeVsCode: number,
    phantomPaths: number,
    errors: number,
    warnings: number,
    info: number
  }
}
```