<!-- Generated by agents-reverse-engineer -->

# quality

Post-generation validation layer detecting inconsistencies between source code, generated documentation, and project structure through static analysis of exports, imports, path references, and identifier density.

## Contents

**[index.ts](./index.ts)** — Public API barrel re-exporting `extractExports`, `checkCodeVsDoc`, `checkCodeVsCode`, `checkPhantomPaths`, `buildInconsistencyReport`, `formatReportForCli`, `validateFindability` from inconsistency detectors, phantom path validators, and density analyzers. Exposes `Inconsistency` discriminated union (`CodeDocInconsistency`, `CodeCodeInconsistency`, `PhantomPathInconsistency`), `InconsistencyReport` structure, `InconsistencySeverity`, and `FindabilityResult` type.

**[types.ts](./types.ts)** — Core type system defining `InconsistencySeverity` (`'info' | 'warning' | 'error'`), discriminated union `Inconsistency` with variants `CodeDocInconsistency` (mismatches between source exports and `.sum` documentation), `CodeCodeInconsistency` (duplicate symbols across files), `PhantomPathInconsistency` (broken path references in AGENTS.md). Contains `InconsistencyReport` structure with `metadata` (timestamp, projectRoot, filesChecked, durationMs), `issues: Inconsistency[]`, and `summary` counts by type and severity.

## Subdirectories

**[inconsistency/](./inconsistency/)** — Three detectors for code-documentation sync violations: `code-vs-doc.ts` uses regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` to find undocumented exports; `code-vs-code.ts` finds duplicate exported symbols via `Map<string, string[]>`; `reporter.ts` aggregates findings into `InconsistencyReport` and formats CLI output with severity tags `[ERROR]`, `[WARN]`, `[INFO]`.

**[phantom-paths/](./phantom-paths/)** — Validates file path references in AGENTS.md against filesystem using markdown link extraction regex `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`, backtick pattern `/`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g`, and prose pattern `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`. Multi-strategy resolution (relative to AGENTS.md dir, project root, .ts/.js substitution) with skip patterns for node_modules, URLs, template syntax, globs.

**[density/](./density/)** — Exports `validateFindability(agentsMdContent, sumFiles)` for symbol coverage analysis. Currently returns empty array due to removal of `publicInterface` field from `SumFileContent` schema; function signature preserved for future re-implementation of string-based identifier presence validation.

## Architecture

### Detection Pipeline

```
Source Files + .sum Files + AGENTS.md
  ├─ extractExports() → Set<string>
  ├─ checkCodeVsDoc() → CodeDocInconsistency[]
  ├─ checkCodeVsCode() → CodeCodeInconsistency[]
  ├─ checkPhantomPaths() → PhantomPathInconsistency[]
  └─ validateFindability() → FindabilityResult[] (inactive)
         ↓
  buildInconsistencyReport() → InconsistencyReport
         ↓
  formatReportForCli() → string
```

### Validation Strategies

- **code-vs-doc**: Regex-based export extraction, case-sensitive substring match against `.sum` summary text
- **code-vs-code**: Symbol-to-files map accumulation, filter for `paths.length > 1`
- **phantom-path**: Multi-pattern path extraction, multi-strategy filesystem resolution
- **density**: String-based symbol presence validation (pending re-implementation)

All detectors stateless, no AI/LLM calls, purely syntactic heuristics.

## Behavioral Contracts

### Export Extraction Pattern

```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```

Captures identifier in group 1 after export keyword and declaration type.

### CLI Report Format

```
=== Inconsistency Report ===
Checked {filesChecked} files in {durationMs}ms
Found {total} issue(s)

[ERROR|WARN|INFO] {description}
  File: {filePath}         // code-vs-doc
  Doc: {agentsMdPath}      // phantom-path
  Path: {referencedPath}   // phantom-path
  Files: {file1}, {file2}  // code-vs-code
```

### Phantom Path Skip Patterns

- `/node_modules/`, `/\.git\//` — vendor directories
- `/^https?:/` — HTTP/HTTPS URLs
- `/\{\{/`, `/\$\{/` — template placeholders
- `/\*/`, `/\{[^}]*,[^}]*\}/` — glob/brace expansion

## Integration Points

- Called by `src/generation/orchestrator.ts` post-AGENTS.md generation
- Imports `SumFileContent` from `../generation/writers/sum.js` for `.sum` schema
- Consumes discovered file list from `src/discovery/run.ts`
- Emits `InconsistencyReport` filtered by severity threshold, logged via `src/output/logger.ts`

## Design Constraints

- **No AI involvement** — deterministic static analysis only
- **Stateless detectors** — pure functions accepting content strings
- **No ANSI coupling** — plain text output; colorization deferred to CLI layer
- **Caller-scoped grouping** — `checkCodeVsCode` requires per-directory file arrays to prevent false cross-module duplicate warnings