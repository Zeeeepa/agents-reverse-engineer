<!-- Generated by agents-reverse-engineer -->

# src/quality

Code-documentation consistency validation subsystem executing three detection strategies: regex-based export extraction with substring matching (`code-vs-doc`), cross-file duplicate symbol aggregation (`code-vs-code`), and regex-based path reference resolution with filesystem verification (`phantom-paths`).

## Contents

**[index.ts](./index.ts)** — Barrel module re-exporting `checkCodeVsDoc()`, `checkCodeVsCode()`, `checkPhantomPaths()` validators, `buildInconsistencyReport()`, `formatReportForCli()` reporters, disabled `validateFindability()` density validator, and discriminated union types (`CodeDocInconsistency`, `CodeCodeInconsistency`, `PhantomPathInconsistency`, `Inconsistency`, `InconsistencyReport`).

**[types.ts](./types.ts)** — Defines `InconsistencySeverity` (`'info' | 'warning' | 'error'`), `CodeDocInconsistency` (exported symbols missing from `.sum` with `missingFromDoc[]`), `CodeCodeInconsistency` (duplicate exports across files with `pattern: 'duplicate-export'`), `PhantomPathInconsistency` (unresolved paths in `AGENTS.md` with `referencedPath`, `resolvedTo`, `context`), `Inconsistency` discriminated union, `InconsistencyReport` container with metadata (`timestamp`, `projectRoot`, `filesChecked`, `durationMs`) and summary counts.

## Subdirectories

**[inconsistency/](./inconsistency/)** — code-vs-doc validator extracting exports via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` with substring verification against `.sum` content; code-vs-code detector aggregating exports into `Map<symbol, paths[]>` to identify duplicates; reporter building aggregated `InconsistencyReport` with formatted CLI output.

**[phantom-paths/](./phantom-paths/)** — Path reference validator extracting strings via three regex patterns (markdown links, backtick paths, prose references), resolving against `AGENTS.md` directory and project root with `.ts`/`.js` fallback, returning `PhantomPathInconsistency[]` for unresolved references.

**[density/](./density/)** — Disabled `validateFindability()` stub previously verifying exported symbols from `.sum` files appeared in parent `AGENTS.md`; implementation gutted after `SumFileContent.metadata.publicInterface` removal.

## Validation Workflow

**Code-vs-Doc Consistency:**  
`extractExports(filePath)` scans source via regex capturing export identifiers → `checkCodeVsDoc(filePath, sumContent)` performs substring search against `.sum` summary text → returns `CodeDocInconsistency` with `missingFromDoc[]` when drift detected or `null` when consistent.

**Code-vs-Code Duplicate Detection:**  
`checkCodeVsCode(files[])` aggregates `extractExports()` results into `Map<symbol, string[]>` → filters entries with `paths.length > 1` → returns `CodeCodeInconsistency[]` with `pattern: 'duplicate-export'` and `severity: 'warning'`.

**Phantom Path Resolution:**  
`checkPhantomPaths(agentsMdPath, content, projectRoot)` applies three regex patterns to extract path references → attempts resolution via `existsSync()` against `AGENTS.md` directory and project root with extension substitution → returns `PhantomPathInconsistency[]` for unresolved paths with 120-char context excerpt.

**Report Aggregation:**  
`buildInconsistencyReport(issues[], metadata)` merges inconsistency arrays → computes summary counts by `type` (`code-vs-doc`, `code-vs-code`, `phantom-path`) and `severity` (`error`, `warning`, `info`) → returns `InconsistencyReport` with timestamp metadata. `formatReportForCli(report)` transforms into plain-text output with severity tags (`[ERROR]`, `[WARN]`, `[INFO]`) and type-specific field rendering for stderr/`progress.log`.

## Behavioral Contracts

**Export Extraction Regex (inconsistency/):**  
`/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`

**Path Extraction Patterns (phantom-paths/validator.ts):**  
```javascript
/\[(?:[^\]]*)\]\((\.[^)]+)\)/g              // Markdown: [text](./path)
/`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g  // Backtick: `src/foo.ts`
/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi // Prose: "from src/foo/"
```

**Severity Tags (inconsistency/reporter.ts):**  
`severity: 'error'` → `[ERROR]`, `severity: 'warning'` → `[WARN]`, `severity: 'info'` → `[INFO]`

**Type Discriminator Field:**  
`type: 'code-vs-doc' | 'code-vs-code' | 'phantom-path'` enables exhaustive switch narrowing.

## Known Limitations

**Regex-Based Export Extraction:**  
Misses destructured (`export { foo }`), namespace (`export *`), dynamic exports, multiline declarations. No AST analysis—purely heuristic pattern matching.

**Substring Verification:**  
False negatives when export names appear in comments/prose rather than documented API surface. No structured field verification after `publicInterface` schema removal.

**Intentional Duplication:**  
Code-vs-code cannot distinguish factory patterns, parallel implementations, intentional re-exports. Caller must scope input to per-directory groups to minimize false positives.

**Extension Fallback Logic:**  
Path resolution attempts `.js` → `.ts` substitution but doesn't handle `.jsx`/`.tsx`, `.cjs`/`.mjs`, or index file resolution (`./foo` → `./foo/index.ts`).