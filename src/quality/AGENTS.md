<!-- Generated by agents-reverse-engineer -->

# src/quality

Quality validation subsystem for agents-reverse-engineer, detecting inconsistencies between source code and generated documentation through code-vs-doc validation, code-vs-code duplicate export detection, phantom path verification, and identifier density analysis.

## Contents

- **[index.ts](./index.ts)** — Public API barrel re-exporting `extractExports`, `checkCodeVsDoc`, `checkCodeVsCode`, `checkPhantomPaths`, `buildInconsistencyReport`, `formatReportForCli`, `validateFindability` and discriminated union types `CodeDocInconsistency`, `CodeCodeInconsistency`, `PhantomPathInconsistency`, `Inconsistency`, `InconsistencyReport`, `FindabilityResult`
- **[types.ts](./types.ts)** — Core type system defining `InconsistencySeverity` union (`'info' | 'warning' | 'error'`), discriminated `Inconsistency` union with literal `type` field, `InconsistencyReport` aggregate structure with `metadata` (timestamp, projectRoot, filesChecked, durationMs) and `summary` counts (total, codeVsDoc, codeVsCode, phantomPaths, errors, warnings, info)

## Subdirectories

- **[density/](./density/)** — Findability validation via `validateFindability()` that checks exported symbol presence in AGENTS.md content; currently stubbed pending re-implementation after `metadata.publicInterface` removal from sum schema
- **[inconsistency/](./inconsistency/)** — Code-vs-doc (`extractExports` regex + substring matching), code-vs-code (duplicate export Map), and CLI report formatting (`buildInconsistencyReport`, `formatReportForCli` with `[ERROR]`/`[WARN]`/`[INFO]` tags)
- **[phantom-paths/](./phantom-paths/)** — `checkPhantomPaths` validator extracts markdown links and backtick paths via `PATH_PATTERNS`, resolves against filesystem with `existsSync()`, filters false positives via `SKIP_PATTERNS`, returns `PhantomPathInconsistency[]` for broken references

## Validation Pipeline

Quality checks run during `are-generate` and `are-update` workflows:

1. **Code-vs-Doc**: `extractExports()` parses source via regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, `checkCodeVsDoc()` performs substring matching against `SumFileContent.summary` to detect `missingFromDoc` and `missingFromCode` arrays
2. **Code-vs-Code**: `checkCodeVsCode()` builds `Map<exportName, filePaths[]>` per directory and flags entries where `paths.length > 1`
3. **Phantom Paths**: `checkPhantomPaths()` extracts paths from AGENTS.md via `PATH_PATTERNS`, resolves relative to containing directory and project root, validates with `existsSync()`, generates warnings with 120-character context slices
4. **Report Generation**: `buildInconsistencyReport()` aggregates `Inconsistency[]` with run metadata, `formatReportForCli()` renders stderr output with severity tags and indented context
5. **Density Validation**: `validateFindability()` stub returns empty array pending re-implementation of symbol extraction from .sum files

## Behavioral Contracts

### Export Detection Regex
`/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` captures TypeScript/JavaScript export identifiers in group 1.

### Phantom Path Extraction Patterns
- Markdown links: `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`
- Backtick paths: `` /`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g ``
- Prose references: `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`

### CLI Report Format
Fixed header `=== Inconsistency Report ===\nChecked {filesChecked} files in {durationMs}ms\nFound {total} issue(s)\n\n` followed by severity-tagged blocks (`[ERROR]`, `[WARN]`, `[INFO]`) with two-space indented context lines.

## Integration Points

Imported by orchestrators in `src/generation/orchestrator.ts` and `src/update/orchestrator.ts` via `import { checkCodeVsDoc, checkPhantomPaths, buildInconsistencyReport } from '../quality/index.js'`. Consumes `SumFileContent` from `src/generation/writers/sum.ts` for parsed .sum schema validation. Exports `Inconsistency` and `InconsistencyReport` types consumed by CLI error handlers in `src/cli/generate.ts` and `src/cli/update.ts`.