---
generated_at: 2026-02-09T16:09:22.973Z
content_hash: be5da3f84bcde292733c820cb325be1212baf0436f982f8fc9bf91c74db73382
purpose: validator.ts detects unresolvable path references in AGENTS.md files by extracting path-like strings via regex patter...
---
**validator.ts detects unresolvable path references in AGENTS.md files by extracting path-like strings via regex patterns, resolving them against both the AGENTS.md directory and project root with .ts/.js fallback logic, and returning PhantomPathInconsistency objects for non-existent paths.**

## Exported Functions

### checkPhantomPaths
```typescript
function checkPhantomPaths(
  agentsMdPath: string,
  content: string,
  projectRoot: string,
): PhantomPathInconsistency[]
```

Extracts path-like references from AGENTS.md content using `PATH_PATTERNS`, resolves each unique path against `agentsMdDir` (via `path.dirname(agentsMdPath)`) and `projectRoot`, verifies existence via `existsSync()`, and returns `PhantomPathInconsistency[]` for unresolved paths with `type: 'phantom-path'`, `severity: 'warning'`, relative `agentsMdPath`, `description`, and `details` object containing `referencedPath`, `resolvedTo` (relative to projectRoot), and `context` (first 120 chars of containing line).

## Path Extraction Patterns

### PATH_PATTERNS
```typescript
const PATH_PATTERNS: RegExp[] = [
  /\[(?:[^\]]*)\]\((\.[^)]+)\)/g,              // Markdown links: [text](./path)
  /`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g,  // Backtick paths: `src/foo/bar.ts`
  /(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi, // Prose paths: "from src/foo/"
]
```

Three regex patterns capture: (1) markdown link targets starting with `.`, (2) backtick-quoted paths beginning with `src/`, `./`, or `../` with 1-4 letter extensions, (3) prose-embedded `src/` paths following keywords "from", "in", "by", "via", or "see" (case-insensitive via `i` flag).

### SKIP_PATTERNS
```typescript
const SKIP_PATTERNS: RegExp[] = [
  /node_modules/,
  /\.git\//,
  /^https?:/,
  /\{\{/,                  // template placeholders
  /\$\{/,                  // template literals
  /\*/,                    // glob patterns
  /\{[^}]*,[^}]*\}/,      // brace expansion: {a,b,c}
]
```

Excludes vendor directories (`node_modules`, `.git/`), URLs (`http://`, `https://`), template syntax (`{{`, `${`), glob wildcards (`*`), and brace expansions (`{a,b,c}`) from validation via `SKIP_PATTERNS.some((p) => p.test(rawPath))`.

## Path Resolution Strategy

Attempts resolution in order: (1) `path.resolve(agentsMdDir, rawPath)`, (2) `path.resolve(projectRoot, rawPath)`, (3) `.js` â†’ `.ts` substitution via `fromAgentsMd.replace(/\.js$/, '.ts')` and `fromRoot.replace(/\.js$/, '.ts')` for TypeScript import convention support. Uses `tryPaths.some((p) => existsSync(p))` to validate at least one candidate exists.

## Deduplication and Context Extraction

Maintains `seen` Set tracking `rawPath` strings to skip duplicate pattern matches via `seen.has(rawPath)` check before processing. Extracts context line via `content.split('\n')` and `lines.find((l) => l.includes(rawPath))`, truncating to 120 characters via `contextLine.trim().slice(0, 120)` for inclusion in `PhantomPathInconsistency.details.context`.

## Integration Points

Consumed by `src/quality/phantom-paths/index.ts` as part of quality validation pipeline. Returns `PhantomPathInconsistency` discriminated union member conforming to `src/quality/types.ts` schema with required fields: `type`, `severity`, `agentsMdPath`, `description`, `details`.