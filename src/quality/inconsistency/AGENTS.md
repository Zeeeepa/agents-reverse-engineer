<!-- Generated by agents-reverse-engineer -->

# src/quality/inconsistency

Validates code-documentation consistency by extracting exports from source files, verifying their presence in `.sum` documentation, detecting duplicate exports across file groups, and aggregating validation results into structured reports with CLI-formatted output.

## Contents

### Validators

**[code-vs-doc.ts](./code-vs-doc.ts)** — `extractExports()` extracts exported identifiers from TypeScript/JavaScript source via regex pattern `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`. `checkCodeVsDoc()` verifies extracted exports appear in `.sum` file `summary` text via substring search, returning `CodeDocInconsistency` with `missingFromDoc[]` array when drift detected, or `null` when consistent.

**[code-vs-code.ts](./code-vs-code.ts)** — `checkCodeVsCode()` detects duplicate exports across file groups by aggregating `extractExports()` results into `Map<symbol, paths[]>`, returning `CodeCodeInconsistency[]` array for symbols exported from multiple files with `pattern: 'duplicate-export'` and `severity: 'warning'`.

### Report Generation

**[reporter.ts](./reporter.ts)** — `buildInconsistencyReport()` aggregates `Inconsistency[]` into `InconsistencyReport` with summary counts by type (`code-vs-doc`, `code-vs-code`, `phantom-path`) and severity (`error`, `warning`, `info`). `formatReportForCli()` transforms report into plain-text output with severity tags `[ERROR]`/`[WARN]`/`[INFO]` and type-specific field rendering for stderr and `progress.log` output.

## Validation Algorithm

**Phase 1: Export Extraction**  
Regex-based identifier capture from source declarations (`export function foo`, `export const BAR`, `export default class App`). Matches capture group 1 containing symbol name, filtering lines matching `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`.

**Phase 2: Documentation Verification**  
Substring search against `.sum` file `summary` text. Export name must appear anywhere in summary content to pass validation. Missing symbols populate `CodeDocInconsistency.details.missingFromDoc[]` array.

**Phase 3: Cross-File Duplicate Detection**  
Aggregates exports into `Map<symbol, string[]>` where keys are export names and values are file paths. Filters map entries where `paths.length > 1`, constructing `CodeCodeInconsistency` records with formatted description `"Symbol \"${name}\" exported from ${paths.length} files"`.

**Phase 4: Report Aggregation**  
Merges inconsistency arrays from code-vs-doc, code-vs-code, and phantom-path validators into single `InconsistencyReport` with summary counts. Populates metadata (timestamp, projectRoot, filesChecked, durationMs) and discriminates union via `issue.type` for CLI rendering.

## Behavioral Contracts

**Regex Export Pattern (code-vs-doc.ts, code-vs-code.ts):**  
`/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`

**CLI Report Severity Tags (reporter.ts):**  
- `severity: 'error'` → `[ERROR]`  
- `severity: 'warning'` → `[WARN]`  
- `severity: 'info'` → `[INFO]`

**Type-Specific Field Rendering (reporter.ts):**  
- `code-vs-doc`: `File: ${filePath}`  
- `code-vs-code`: `Files: ${files.join(', ')}`  
- `phantom-path`: `Doc: ${agentsMdPath}`, `Path: ${referencedPath}`

## Integration with Quality Pipeline

Called by `src/quality/index.ts` orchestrator after per-file validation. `checkCodeVsDoc()` invoked for each source file with parsed `.sum` content. `checkCodeVsCode()` receives scoped per-directory file groups to avoid false positives across unrelated modules. Results merged with phantom-path validation output, passed to `buildInconsistencyReport()` with run metadata (filesChecked, durationMs), then formatted via `formatReportForCli()` for stderr and `progress.log` output.

## Known Limitations

**Regex-Based Export Extraction:**  
Misses destructured exports (`export { foo, bar }`), namespace exports (`export * from './module'`), dynamic exports, multiline declarations. No AST analysis—purely heuristic pattern matching.

**Substring Verification:**  
Produces false negatives when export names appear in comments, prose descriptions, or unrelated context rather than as documented API surface. No structured field verification after `publicInterface` schema removal.

**Intentional Duplication:**  
Code-vs-code validator cannot distinguish factory patterns, parallel implementations, or other intentional duplication without semantic analysis. Caller must scope input to per-directory groups to minimize false positives.