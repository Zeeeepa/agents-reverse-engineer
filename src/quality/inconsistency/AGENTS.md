<!-- Generated by agents-reverse-engineer -->

# src/quality/inconsistency

Detects documentation-code mismatches via regex-based export extraction, duplicate symbol tracking, and structured reporting with type-safe inconsistency aggregation.

## Contents

### Export Validators

**[code-vs-doc.ts](./code-vs-doc.ts)**  
Exports `extractExports(sourceContent: string): string[]` using regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` to extract identifier names from TypeScript/JavaScript source. Exports `checkCodeVsDoc(sourceContent: string, sumContent: SumFileContent, filePath: string): CodeDocInconsistency | null` which compares extracted symbols against `.sum` file summary text via substring search, returning `CodeDocInconsistency` with `missingFromDoc[]` array when exports lack documentation mentions.

**[code-vs-code.ts](./code-vs-code.ts)**  
Exports `checkCodeVsCode(files: Array<{ path: string; content: string }>): CodeCodeInconsistency[]` which builds `Map<string, string[]>` mapping export names to file paths via two-pass traversal calling `extractExports()` from `code-vs-doc.ts`, flagging symbols appearing in multiple files with `CodeCodeInconsistency` entries containing `pattern: 'duplicate-export'`, `severity: 'warning'`, `files: string[]`. Operates per-directory to avoid false positives across unrelated modules.

### Report Generation

**[reporter.ts](./reporter.ts)**  
Exports `buildInconsistencyReport(issues: Inconsistency[], metadata: { projectRoot: string; filesChecked: number; durationMs: number }): InconsistencyReport` which aggregates discriminated union array into structured report with type counts (`codeVsDoc`, `codeVsCode`, `phantomPaths`) and severity counts (`errors`, `warnings`, `info`) via type guard iteration. Exports `formatReportForCli(report: InconsistencyReport): string` which converts report to plain-text multi-line format with severity tags (`[ERROR]`, `[WARN]`, `[INFO]`) and type-specific detail blocks, enabling ANSI color wrapping at CLI layer (`src/output/logger.ts`).

## Algorithms

**Export Extraction**: Regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` with global and multiline flags matches export statements, captures identifier names. Misses destructured exports, namespace exports, dynamic `export {}` statements.

**Duplicate Detection**: Symbol-to-paths map construction via `exportMap.set(name, [...(exportMap.get(name) || []), filePath])`, followed by `Array.from(exportMap.entries()).filter(([_, paths]) => paths.length > 1)` to identify duplicates. No AST analysis to distinguish intentional duplication (facade pattern, barrel re-exports).

**Report Aggregation**: Type guard iteration `issue.type === 'code-vs-doc'` / `'code-vs-code'` / `'phantom-path'` increments type counters. Severity counters increment via `issue.severity === 'error'` / `'warning'` / `'info'` checks. Total computed as `issues.length`.

## Integration Points

**Upstream**: `src/quality/index.ts` validators (`validateCodeDocConsistency`, `validateCodeCodeConsistency`) call `checkCodeVsDoc()` and `checkCodeVsCode()` with file content arrays, then pass collected `Inconsistency[]` to `buildInconsistencyReport()`.

**Downstream**: Formatted reports from `formatReportForCli()` consumed by `src/cli/generate.ts` and `src/cli/update.ts` for stderr output with ANSI color wrapping via `pc.yellow()`, `pc.red()` from `src/output/logger.ts`.

**Type Dependencies**: Imports `SumFileContent` from `../../generation/writers/sum.js` (parsed `.sum` file schema), `CodeDocInconsistency`, `CodeCodeInconsistency`, `Inconsistency`, `InconsistencyReport` from `../types.js` (discriminated union members and aggregate schema).

## Limitations

**Regex-Based Extraction**: Misses complex patterns (destructured, namespace, dynamic exports), relies on statement-level syntax matching without AST traversal.

**Substring Matching**: `sumText.includes(exportName)` yields false negatives when symbols appear in prose unrelated to API documentation. No context-aware semantic analysis.

**No AST Analysis**: Duplicate detection operates on symbol names only, cannot distinguish intentional duplication (facade pattern, barrel re-exports) from accidental conflicts.

**Missing Obsolete Detection**: `code-vs-doc.ts` does not detect documentation for removed exports (`missingFromCode` field always empty array, retained for legacy `publicInterface` schema compatibility).