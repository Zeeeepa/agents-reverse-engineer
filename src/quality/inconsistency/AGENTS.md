<!-- Generated by agents-reverse-engineer -->

# src/quality/inconsistency

Detects inconsistencies between source code and documentation, duplicate exports, and formats validation reports for CLI output.

## Contents

### Inconsistency Detection

- **[code-vs-doc.ts](./code-vs-doc.ts)** — `extractExports()` parses TypeScript/JavaScript exports via regex, `checkCodeVsDoc()` compares extracted symbols against `SumFileContent.summary` text and `publicInterface` entries to detect missing documentation or phantom documented symbols
- **[code-vs-code.ts](./code-vs-code.ts)** — `checkCodeVsCode()` builds `Map<exportName, filePaths[]>` from directory-scoped file group and flags duplicate exports with `CodeCodeInconsistency` when `paths.length > 1`

### Report Formatting

- **[reporter.ts](./reporter.ts)** — `buildInconsistencyReport()` aggregates `Inconsistency[]` into `InconsistencyReport` with type/severity counts and metadata, `formatReportForCli()` renders plain-text output with `[ERROR]`/`[WARN]`/`[INFO]` severity tags and two-space indented context lines

## Data Flow

1. Validation phase calls `checkCodeVsDoc(sourceContent, sumContent, filePath)` for each file with corresponding `.sum` file
2. `extractExports()` applies regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` to source
3. `checkCodeVsDoc()` performs substring matching (`sumText.includes(e)`) to detect `missingFromDoc` and `missingFromCode`
4. Directory validator groups files by directory and calls `checkCodeVsCode(files)` to detect duplicate exports within scope
5. Caller passes all `Inconsistency[]` to `buildInconsistencyReport()` with run metadata
6. CLI invokes `formatReportForCli(report)` and writes to stderr

## Behavioral Contracts

**Export detection regex**: `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` captures group 1 as identifier name, matches `export function foo`, `export const BAR`, `export default class App`.

**Inconsistency description formats**:
- `code-vs-doc`: `"Documentation out of sync: ${missingFromDoc.length} exports undocumented"` or `"Documentation references ${missingFromCode.length} non-existent items"`
- `code-vs-code`: `"Symbol \"${name}\" exported from ${paths.length} files"`

**CLI output structure**: Fixed header `=== Inconsistency Report ===\nChecked {filesChecked} files in {durationMs}ms\nFound {total} issue(s)\n\n`, followed by issue blocks with severity tags `[ERROR]`, `[WARN]`, `[INFO]`, two-space indented context lines (`  File: {filePath}`), and blank line separators.

## Integration Points

Imports `SumFileContent` from `../../generation/writers/sum.js` for parsed `.sum` file schema. Imports `Inconsistency`, `CodeDocInconsistency`, `CodeCodeInconsistency`, `InconsistencyReport` from `../types.js` for discriminated union contracts. Used by quality validation system in `src/quality/index.ts` to flag drift during `generate` or `update` commands.