<!-- Generated by agents-reverse-engineer -->

# src/quality/inconsistency

Detects documentation drift and duplicate exports through syntactic analysis: `code-vs-doc.ts` flags undocumented exports via `.sum` text comparison, `code-vs-code.ts` flags duplicate symbols across files, `reporter.ts` formats findings for CLI stderr.

## Contents

**[code-vs-doc.ts](./code-vs-doc.ts)** — Exports `extractExports()` (regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` captures identifiers) and `checkCodeVsDoc()` (compares source exports against `SumFileContent.summary` text via `includes()`, emits `CodeDocInconsistency` with `missingFromDoc` details when symbols absent).

**[code-vs-code.ts](./code-vs-code.ts)** — Exports `checkCodeVsCode()` orchestrating duplicate detection: builds `Map<string, string[]>` mapping export names to file paths, filters entries where `paths.length > 1`, returns `CodeCodeInconsistency[]` with `pattern: 'duplicate-export'` and `severity: 'warning'`. Imports `extractExports()` from `./code-vs-doc.js` for symbol extraction.

**[reporter.ts](./reporter.ts)** — Exports `buildInconsistencyReport()` (aggregates `Inconsistency[]` into `InconsistencyReport` with summary counts by type/severity, attaches ISO timestamp and run metadata) and `formatReportForCli()` (renders plain text with severity tags `[ERROR]|[WARN]|[INFO]`, conditionally displays `filePath`/`agentsMdPath`/`files[]` based on discriminant `type` field).

## Algorithm

**Duplicate Export Detection**: `checkCodeVsCode()` iterates `files[]`, invokes `extractExports(content)` per file, populates `Map<symbol, paths[]>`, filters entries where `paths.length > 1`, constructs `CodeCodeInconsistency` with `files: paths` and template description.

**Documentation Drift Detection**: `checkCodeVsDoc()` calls `extractExports(sourceContent)`, filters symbols via `sumContent.summary.includes(e)`, returns `CodeDocInconsistency` when `missingFromDoc.length > 0`. Reverse check (`missingFromCode`) currently returns empty array.

**Report Aggregation**: `buildInconsistencyReport()` computes summary counts via imperative accumulation, attaches run metadata (`projectRoot`, `filesChecked`, `durationMs`). `formatReportForCli()` renders discriminated union variants with type-specific context fields.

## Behavioral Contracts

**Export Extraction Pattern**:
```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```
Captures identifier in group 1 after export keyword and declaration type. Matches `export function foo`, `export const BAR`, `export default class App`. Ignores re-exports and commented-out lines.

**Description Templates**:
- `code-vs-doc`: `"Documentation out of sync: ${missingFromDoc.length} exports undocumented"`
- `code-vs-code`: `"Symbol \"${name}\" exported from ${paths.length} files"`

**CLI Format**:
```
=== Inconsistency Report ===
Checked {filesChecked} files in {durationMs}ms
Found {total} issue(s)

[ERROR]|[WARN]|[INFO] {description}
  File: {filePath}
  Doc: {agentsMdPath}
  Path: {referencedPath}
  Files: {file1}, {file2}, ...
```

## Type Dependencies

- `SumFileContent` from `../../generation/writers/sum.js` — parsed .sum file structure with `summary` text field
- `CodeDocInconsistency`, `CodeCodeInconsistency`, `Inconsistency`, `InconsistencyReport` from `../types.js` — discriminated union types for quality issues

## Integration Points

Consumed by `src/orchestration/runner.ts` post-phase-1-quality checks: `checkCodeVsDoc()` invoked per file-sum pair, `checkCodeVsCode()` invoked per directory group, `buildInconsistencyReport()` aggregates findings across phases. `formatReportForCli()` output emitted to stderr via `src/core/logger.ts` when issues detected.

## Design Constraints

Pure syntactic analysis—no AST parsing or AI-based semantic checks. `checkCodeVsCode()` requires scoped input (per-directory groups) to avoid false positives across unrelated modules. Reporter functions avoid color dependencies for testability, deferring ANSI colorization to CLI layer.