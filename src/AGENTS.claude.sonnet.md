<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src

Core TypeScript implementation of the agents-reverse-engineer engine, partitioned into 16 specialized subsystems: AI service abstraction with subprocess-based LLM invocation and retry logic (`ai/`), git-based change detection with SHA-256 content hashing (`change-detection/`), CLI command dispatching (`cli/`), YAML config management with auto-computed concurrency defaults (`config/`), programmatic API facade (`core/`), telemetry analytics with Chart.js dashboards (`dashboard/`), gitignore-filtered directory traversal (`discovery/`), two-phase LLM-driven documentation generation (`generation/`), ESM import dependency extraction (`imports/`), interactive runtime installer for Claude/Codex/OpenCode/Gemini (`installer/`), runtime detection and command template provisioning (`integration/`), concurrent worker-pool orchestration with NDJSON trace logging (`orchestration/`), color-coded terminal logging (`output/`), post-generation export/path validation (`quality/`), checkpoint-resumable project reconstruction from specs (`rebuild/`), LLM prompt construction for 12-section specification synthesis (`specify/`), shared type definitions (`types/`), incremental update with orphan artifact cleanup (`update/`), and NPM package version retrieval (`version.ts`).

## Contents

### Utility Modules

- [**version.ts**](./version.ts): `getVersion()` reads `../package.json` via `fs.readFileSync` with `__dirname` ESM polyfill (`fileURLToPath(import.meta.url)`), returns `version` field or `'unknown'` on parse/read errors.

## Subdirectories

- [**ai/**](./ai/): AI service abstraction layer: `BackendRegistry` auto-detecting CLIs (Claude→Codex→Gemini→OpenCode priority), `AIService` orchestrating retry/telemetry/tracing, `SubprocessProvider` spawning CLI subprocesses with SIGTERM/SIGKILL timeout escalation, `TelemetryLogger` accumulating token/latency metrics, backend adapters (`ClaudeBackend`, `CodexBackend`, `GeminiBackend`, `OpenCodeBackend`) translating `AICallOptions` to CLI invocations with JSON/NDJSON/JSONL response parsing.
- [**change-detection/**](./change-detection/): Git-based incremental update engine: `getChangedFiles` parsing `git diff --name-status -M` with rename detection, `computeContentHash` generating SHA-256 hex digests for `.sum` frontmatter comparison, `isGitRepo`/`getCurrentCommit` for commit validation.
- [**cli/**](./cli/): Command-line entry point: `index.ts` routing user args to eight commands (`init`, `discover`, `generate`, `update`, `specify`, `rebuild`, `clean`, `dashboard`), `generate.ts` orchestrating two-phase pipeline (file analysis → directory synthesis), `update.ts` computing git-based change detection with frontmatter hash filtering, `specify.ts` synthesizing 12-section specs from `AGENTS.md` docs, `rebuild.ts` reconstructing projects from specs via checkpoint-resumable execution, `clean.ts` removing generated artifacts by `GENERATED_MARKER_PREFIX` sentinel.
- [**config/**](./config/): Configuration management: `ConfigSchema` Zod validator for `.agents-reverse-engineer/config.yaml`, `loadConfig` reading/parsing with `ZodError` wrapping, `findProjectRoot` walking upward to git root or config directory, `getDefaultConcurrency` computing `min(cores * 5, floor(totalMemGB * 0.5 / 0.512), 20)`, `writeDefaultConfig` emitting YAML with safe quoting for regex patterns.
- [**core/**](./core/): Public API barrel exporting types/functions from 20+ internal modules for programmatic access via `'agents-reverse-engineer/core'` subpath (all exports marked `@beta` until v1.0.0).
- [**dashboard/**](./dashboard/): Telemetry visualization: `generateHtmlReport` producing self-contained Chart.js dashboards with cost/token/trend charts, `readAllRunLogs` parsing `.agents-reverse-engineer/logs/run-*.json`, `parseTraceFile` reconstructing worker timelines from NDJSON events, terminal views rendering ASCII Gantt charts, sparklines, P90 latency outliers via `picocolors`.
- [**discovery/**](./discovery/): File discovery pipeline: `walkDirectory` globbing `**/*` via `fast-glob`, `applyFilters` executing gitignore→vendor→binary→custom filter chain with 30-worker concurrency pool, `FilterResult` tracking included paths and `ExcludedFile[]` with filter attribution.
- [**generation/**](./generation/): LLM-driven documentation generation: `buildExecutionPlan` constructing post-order dependency graph (file tasks → directory tasks by depth), `buildFilePrompt`/`buildDirectoryPrompt` injecting compression rules, import maps, manifest detection, `writeSumFile` emitting YAML frontmatter with SHA-256 `content_hash`, `writeAgentsMd` preserving user-authored content via `.local.md` renaming, `collectAgentsDocs`/`collectAnnexFiles` aggregating inputs for spec synthesis.
- [**imports/**](./imports/): ESM import extraction: `extractImports` regex-parsing named/namespace/default imports with type-only flags, `extractDirectoryImports` partitioning relative imports (`./` vs `../`), `formatImportMap` rendering `fileName: → specifier → symbols (type)` blocks for LLM prompt injection.
- [**installer/**](./installer/): Interactive installation orchestrator: `runInstaller` routing to install/uninstall flows, `selectRuntime`/`selectLocation` prompts with TTY raw mode arrow-key navigation, `installFiles` writing command templates to `.claude/`/`.agents/`/`.opencode/`/`.gemini/`, `registerHooks`/`registerPermissions` mutating settings.json via `jsonc-parser`, `uninstallFiles` removing templates/hooks/plugins with empty directory cleanup.
- [**integration/**](./integration/): Runtime environment adapter: `detectEnvironments` scanning for `.claude/`/`.opencode/`/`.gemini/` markers, `generateIntegrationFiles` writing skill/command templates via `getTemplatesForEnvironment`, `buildFrontmatter` constructing YAML/TOML metadata, `PLATFORM_CONFIGS` mapping `EnvironmentType` to path conventions and version file locations.
- [**orchestration/**](./orchestration/): Task execution orchestrator: `DocumentationOrchestrator` preparing `GenerationPlan`/`UpdatePlan` via discovery and change detection, `CommandRunner.executeGenerate` running pre-phase-1 cache load → phase-1 file analysis (concurrent via `runPool`) → post-phase-1 quality checks (`checkCodeVsDoc`/`checkCodeVsCode`) → phase-2 directory synthesis (depth-ordered) → phantom path validation, `ProgressReporter` emitting real-time console telemetry with ETA, `TraceWriter` appending NDJSON events to `.agents-reverse-engineer/traces/`, `PlanTracker` updating `GENERATION-PLAN.md` checkboxes via promise-chain serialization.
- [**output/**](./output/): Terminal logger factory: `createLogger` returning picocolors-backed `Logger` interface (`info`/`file`/`excluded`/`summary`/`warn`/`error`) or identity functions per `colors` flag, `createSilentLogger` providing no-op logger for testing.
- [**quality/**](./quality/): Post-generation validation: `extractExports` regex-extracting exported symbols, `checkCodeVsDoc` detecting missing symbols via case-sensitive `includes()`, `checkCodeVsCode` identifying duplicate exports across file groups, `checkPhantomPaths` resolving markdown link/backtick path references with `.js`→`.ts` variant fallback, `buildInconsistencyReport`/`formatReportForCli`/`formatReportAsMarkdown` synthesizing CLI/Markdown inconsistency reports.
- [**rebuild/**](./rebuild/): Spec-driven reconstruction orchestrator: `CheckpointManager` persisting rebuild state to `.rebuild-checkpoint` with SHA-256 spec drift detection, `readSpecFiles` loading `specs/*.md` sorted alphabetically, `partitionSpec` extracting `RebuildUnit[]` via Build Plan subsections or top-level heading fallback, `executeRebuild` executing dependency-ordered groups with `builtContext` accumulation (100K char limit with truncation), `parseModuleOutput` parsing LLM responses via delimiter (`===FILE:===`/`===END_FILE===`) or fenced block formats.
- [**specify/**](./specify/): Specification synthesis engine: `buildSpecPrompt` assembling system+user prompts enforcing 12-section mandatory structure (Project Overview → Architecture → Public API → Data → Config → Dependencies → Behavioral Contracts split Runtime/Implementation → Test → Build Plan with `Defines:`/`Consumes:` → Prompt Templates → IDE Integration → File Manifest), `writeSpec` writing single file or multi-file tree via top-level heading split (`/^(?=# )/m`), `SpecExistsError` thrown when output conflicts exist without `force` flag.
- [**types/**](./types/): Shared type definitions: `ExcludedFile` (`path`/`reason`), `DiscoveryResult` (`files`/`excluded`), `DiscoveryStats` (aggregated metrics).
- [**update/**](./update/): Incremental update primitives: `cleanupOrphans` deleting `.sum`/`.annex.sum` for deleted/renamed files via `getSumPath`/`getAnnexPath`, `cleanupEmptyDirectoryDocs` removing `AGENTS.md` from directories with no source files (excluding hidden/`.sum`/`GENERATED_FILES`), `getAffectedDirectories` collecting parent directory set from non-deleted changes (depth-sorted descending).

## Architecture

**Two-Phase Generation Pipeline**: Phase 1 (file analysis) reads source files via `discovery/walker.ts`, invokes AI service with `generation/prompts/builder.ts:buildFilePrompt` (includes existingSum for incremental updates), writes `.sum` files with SHA-256 `content_hash` frontmatter via `generation/writers/sum.ts`, optionally writes `.annex.sum` if response contains `## Annex References`. Phase 2 (directory synthesis) groups tasks by depth, processes depth levels in descending order (deepest-first post-order), invokes `buildDirectoryPrompt` with import maps (`imports/extractor.ts`), manifest detection, child `AGENTS.md` content, writes `AGENTS.md` via `generation/writers/agents-md.ts` (preserves user-authored files via `.local.md` renaming), writes `CLAUDE.md` pointer.

**AI Backend Abstraction**: `ai/registry.ts` auto-detects CLIs via `which` lookup (Claude→Codex→Gemini→OpenCode priority), `ai/service.ts` wraps backends in `SubprocessProvider` spawning `runSubprocess` with SIGTERM/SIGKILL timeout escalation (5s grace period), `ai/retry.ts` retries `AIServiceError` with `code === 'RATE_LIMIT'` (3 attempts, exponential backoff 1s base, 8s max, 2x multiplier), `ai/telemetry/run-log.ts` accumulates token/latency metrics to `run-{command}-{backend}-{model}-{timestamp}.json`, `ai/telemetry/cleanup.ts` enforces retention via lexicographic sort.

**Incremental Update Flow**: `change-detection/detector.ts` invokes `git diff --name-status -M <baseCommit>..HEAD` with rename detection, computes content hashes via `crypto.createHash('sha256')`, `update/orphan-cleaner.ts` deletes stale `.sum`/`AGENTS.md` artifacts, `update/orphan-cleaner.ts:getAffectedDirectories` collects parent directories from modified files (depth-sorted descending), `orchestration/orchestrator.ts` filters via frontmatter hash comparison, regenerates `.sum` for changed files (Phase 1), rebuilds `AGENTS.md` for affected directories (Phase 2 with incremental context from existing docs).

**Concurrency Control**: File/directory tasks execute via `orchestration/pool.ts:runPool` shared-iterator worker pattern at `config.ai.concurrency` (auto-computed via `cores * 5`, capped by `totalMemGB * 0.5 / 0.512`, max 20), quality checks throttled at concurrency 10, pre-phase-1 cache reads throttled at concurrency 20. `pool.ts` emits `worker:start`, `task:pickup`, `task:done`, `worker:end` trace events to `orchestration/trace.ts:TraceWriter` NDJSON logger.

**Checkpoint-Resumable Rebuild**: `rebuild/spec-reader.ts` reads `specs/*.md` sorted alphabetically, `rebuild/spec-reader.ts:partitionSpec` extracts `RebuildUnit[]` via Build Plan subsections or top-level heading fallback, `rebuild/checkpoint.ts:CheckpointManager.load` detects spec drift via SHA-256 hash comparison, `rebuild/orchestrator.ts:executeRebuild` processes dependency-ordered groups sequentially (concurrent within group), accumulates `builtContext` from generated files (100K char limit with truncation), `rebuild/output-parser.ts` parses LLM responses via delimiter or fenced block formats, `rebuild/checkpoint.ts` persists state via promise-chain serialization preventing concurrent writes.

**Telemetry & Tracing**: `orchestration/progress.ts:ProgressReporter` emits real-time console output with moving-average ETA (10-sample window), `orchestration/progress.ts:ProgressLog` mirrors stripped output to `.agents-reverse-engineer/progress.log` via promise-chain serialization, `orchestration/trace.ts:TraceWriter` appends NDJSON events (`phase:start`, `phase:end`, `worker:start`, `worker:end`, `task:pickup`, `task:done`, subprocess/retry events) to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson`, `dashboard/html-report.ts` aggregates `RunLog[]` into Chart.js dashboards with cost/token/trend visualizations, `dashboard/trace-reader.ts` reconstructs worker timelines for ASCII Gantt rendering.

## Module Dependencies

**Discovery Layer**: `cli/discover.ts` → `discovery/run.ts` → `discovery/walker.ts` (fast-glob) + `discovery/filters/index.ts` (gitignore/vendor/binary/custom chain).

**Generation Layer**: `cli/generate.ts` → `orchestration/runner.ts` → `orchestration/pool.ts` → `generation/executor.ts` → `generation/prompts/builder.ts` + `ai/service.ts` + `generation/writers/sum.ts`/`agents-md.ts`.

**Update Layer**: `cli/update.ts` → `orchestration/orchestrator.ts:preparePlan` → `change-detection/detector.ts` + `update/orphan-cleaner.ts` → `orchestration/runner.ts:executeUpdate`.

**Specification Layer**: `cli/specify.ts` → `generation/collector.ts` + `specify/prompts.ts` → `ai/service.ts` → `specify/writer.ts`.

**Rebuild Layer**: `cli/rebuild.ts` → `rebuild/spec-reader.ts` + `rebuild/checkpoint.ts` → `rebuild/orchestrator.ts` → `ai/service.ts` + `rebuild/output-parser.ts`.

**Config/Core**: All CLI commands invoke `config/loader.ts:loadConfig` + `config/loader.ts:findProjectRoot`, `core/index.ts` re-exports subset for programmatic API.

## Behavioral Contracts

**Project Root Discovery**: `config/loader.ts:findProjectRoot` walks upward via `access(${dir}/.agents-reverse-engineer/, F_OK)` until match or filesystem root.

**Config Path**: `.agents-reverse-engineer/config.yaml` (from `config/loader.ts`).

**Progress Log Path**: `.agents-reverse-engineer/progress.log` (from `orchestration/progress.ts`).

**Trace Path Pattern**: `.agents-reverse-engineer/traces/trace-{ISO8601-with-dashes}.ndjson` (from `orchestration/trace.ts`).

**Telemetry Log Pattern**: `.agents-reverse-engineer/logs/run-{command}-{backend}-{model}-{timestamp}.json` (from `ai/telemetry/run-log.ts`).

**Backend Priority Order**: Claude → Codex → Gemini → OpenCode (from `ai/registry.ts:createBackendRegistry`).

**Retry Defaults**: `maxRetries: 3`, `baseDelayMs: 1000`, `maxDelayMs: 8000`, `multiplier: 2` (from `ai/retry.ts:DEFAULT_RETRY_OPTIONS`).

**Subprocess Timeout Escalation**: SIGTERM at `timeoutMs` → SIGKILL at `timeoutMs + 5000ms` (from `ai/subprocess.ts:SIGKILL_GRACE_MS = 5000`).

**Concurrency Formula**: `min(cores * 5, floor(totalMemGB * 0.5 / 0.512), 20)` bounded by `[2, 20]` (from `config/defaults.ts`).

**Content Hash Algorithm**: SHA-256 hex digest (lowercase) from `crypto.createHash('sha256')` (from `change-detection/detector.ts`).

**Generation Marker**: `<!-- Generated by agents-reverse-engineer` (version-agnostic prefix) in `AGENTS.md`/`CLAUDE.md` files (from `generation/writers/agents-md.ts:GENERATED_MARKER_PREFIX`).

**YAML Frontmatter Format** (from `generation/writers/sum.ts`):
```yaml
---
generated_at: {ISO8601}
content_hash: {SHA-256}
purpose: {string}
critical_todos: [item] | - item
related_files: [path] | - path
---
```

**Delimiter Format** (rebuild, from `rebuild/output-parser.ts`):
```
===FILE: relative/path/to/file.ext===
[file content]
===END_FILE===
```

**Specification Structure** (from `specify/prompts.ts`): 12 mandatory sections (Project Overview, Tech Stack, Architecture, Module Dependencies, Public API Surface, Data Models, Configuration, Build & Deploy, Testing Strategy, Operations, Extension Points, Build Plan).

**Trace Events**: `phase:start`, `phase:end`, `worker:start`, `worker:end`, `task:pickup`, `task:done`, `subprocess:spawn`, `subprocess:exit`, `retry`, `discovery:start`, `discovery:end`, `filter:applied`, `plan:created`, `config:loaded` (from `orchestration/types.ts:TraceEvent`).

**Exit Codes**:
- `0`: Success or no-op
- `1`: Partial failure (some files failed, quality checks found issues)
- `2`: Total failure or CLI not found

**Version Retrieval**: `version.ts:getVersion()` reads `../package.json` via `__dirname` ESM polyfill, returns `version` field or `'unknown'` on errors.