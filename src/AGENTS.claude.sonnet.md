<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src

The `src` directory contains all TypeScript source modules for `agents-reverse-engineer`, organizing core functionality into specialized subsystems: AI backend abstraction, file discovery with filters, LLM prompt construction, documentation generation, incremental updates, quality analysis, installer orchestration, and CLI command routing.

## Contents

- [`version.ts`](./version.ts): `getVersion()` reads `../package.json` relative to this module's location via ESM `import.meta.url`, `fileURLToPath`, `readFileSync`, returns `version` field string or `'unknown'` on errors.

## Subdirectories

- [`ai/`](./ai/): Provides AI service layer abstraction for invoking AI coding assistants (Claude Code, Gemini, Codex, OpenCode) via CLI subprocesses, with backend auto-detection, retry logic with exponential backoff, structured telemetry logging, and subprocess lifecycle management with timeout enforcement.
- [`change-detection/`](./change-detection/): Git-based change detection subsystem providing file diff tracking and content hashing for `/are-update` incremental documentation regeneration workflow.
- [`cli/`](./cli/): Implements all CLI command entry points (`init`, `discover`, `generate`, `update`, `specify`, `rebuild`, `clean`), routing to orchestration logic, argument parsing, backend resolution, telemetry/tracing infrastructure.
- [`config/`](./config/): Configuration management exporting `loadConfig()`, `writeDefaultConfig()`, `ConfigSchema`, and constants (`CONFIG_DIR`, `CONFIG_FILE`) to read, validate, and generate `.agents-reverse-engineer/config.yaml` with defaults computed from system resources.
- [`core/`](./core/): Defines the public programmatic API for `agents-reverse-engineer`, re-exporting stable interfaces from AI, discovery, generation, quality, orchestration, change detection, config, and import modules for CLI-independent consumption.
- [`discovery/`](./discovery/): Orchestrates file discovery by walking directory trees via `fast-glob`, applying filter chains (gitignore, vendor, binary, custom) with short-circuit evaluation and bounded concurrency, returning `FilterResult` with included/excluded file lists and attribution.
- [`generation/`](./generation/): Orchestrates post-discovery documentation generation: builds dependency-ordered execution plans from discovery results, constructs LLM prompts with compression rules and cross-file context, manages `.sum` file serialization, writes variant-aware `AGENTS.md` overviews, and preserves user-authored documentation as `.local.md` files.
- [`imports/`](./imports/): Extracts and classifies TypeScript/JavaScript import statements from source files, providing structured import data for LLM context building and cross-module reference mapping.
- [`installer/`](./installer/): Implements the interactive installer that deploys ARE command templates, hooks, and runtime integration files to AI coding assistant environments (Claude Code, Codex CLI, OpenCode CLI, Gemini CLI), supporting both global and local installations with interactive prompts, dry-run mode, and uninstallation logic.
- [`integration/`](./integration/): Handles detection and file generation for AI coding assistant environments (Claude Code, Codex, OpenCode, Gemini CLI, Aider), enabling automatic installation of ARE command definitions into assistant-specific config directories.
- [`orchestration/`](./orchestration/): Implements concurrency pooling, progress tracking, tracing, and execution orchestration for the two-phase AI-driven documentation generation pipeline (Phase 1: file analysis via concurrent AI calls; Phase 2: directory AGENTS.md synthesis in post-order by depth).
- [`output/`](./output/): Exports terminal logging abstractions (`Logger`, `createLogger`, `createSilentLogger`) for file discovery feedback, exclusion reporting, and summary statistics with optional color formatting.
- [`quality/`](./quality/): Implements quality analysis for generated documentation by detecting inconsistencies between source code and `.sum` files (`code-vs-doc`), duplicate exports across files (`code-vs-code`), and unresolvable path references in `AGENTS.md` files (`phantom-paths`).
- [`rebuild/`](./rebuild/): Reconstructs projects from `specs/*.md` via AI-driven incremental build using checkpoint-based resumption, dependency-ordered phases, and context injection from prior groups.
- [`specify/`](./specify/): Provides `/are-specify` command implementation, transforming collected `AGENTS.md` documentation into comprehensive project specifications via AI synthesis with strict structural contracts.
- [`types/`](./types/): Defines core TypeScript interfaces for file discovery, exclusion tracking, and process statistics used across the `agents-reverse-engineer` codebase.
- [`update/`](./update/): Handles incremental documentation updates by orchestrating regeneration of changed files, cleaning up orphaned `.sum` files, and identifying affected directories for `AGENTS.md` regeneration.

## Architecture

**Request Flow**: CLI commands (`cli/`) load config (`config/loader.ts`), create backend registry (`ai/registry.ts`), resolve AI backend (`ai/backends/`), provision `AIService` (`ai/service.ts`), delegate to orchestrators (`orchestration/orchestrator.ts` for generate/update, `rebuild/orchestrator.ts` for rebuild, `specify/prompts.ts` for specify), which coordinate discovery (`discovery/run.ts`), prompt building (`generation/prompts/builder.ts`), parallel execution (`orchestration/pool.ts`), file writing (`generation/writers/`), and quality checks (`quality/`).

**Two-Phase Pipeline**: Generate/update workflows execute Phase 1 (file analysis: `runPool` concurrently calls `AIService.call` → `generation/prompts/buildFilePrompt` → AI backend → `generation/writers/writeSumFile`) then Phase 2 (directory rollup: post-order depth traversal calls `buildDirectoryPrompt` → `writeAgentsMd`); post-phase quality checks run `quality/checkCodeVsDoc`, `quality/checkCodeVsCode`, `quality/checkPhantomPaths`.

**Change Detection**: Update workflow (`update/`) integrates `change-detection/detector.ts` to compute `FileChange[]` from git diffs, filters via content hash comparison (`readSumFile` + `computeContentHash`), invokes `cleanupOrphans` to remove stale `.sum` files, identifies affected directories via `getAffectedDirectories` for `AGENTS.md` regeneration.

**Installer**: Interactive installer (`installer/index.ts`) detects AI coding assistant environments (`integration/detect.ts`), prompts for runtime/location (`installer/prompts.ts`), writes command templates via `integration/templates.ts`, registers hooks/permissions (`installer/operations.ts`), supports uninstallation (`installer/uninstall.ts`).

## Structure

The directory follows a layered architecture: **CLI Layer** (`cli/`) handles argument parsing, user interaction, exit codes; **Orchestration Layer** (`orchestration/`, `generation/`, `rebuild/`, `specify/`, `update/`) coordinates multi-step workflows; **Service Layer** (`ai/`, `discovery/`, `imports/`, `change-detection/`, `quality/`) provides domain-specific operations; **Infrastructure Layer** (`config/`, `output/`, `types/`) supplies cross-cutting utilities; **Integration Layer** (`installer/`, `integration/`) manages external tool interop.

## Workflow & Conventions

All modules use ESM syntax (`import`/`export`), absolute paths for file I/O, `path.relative()` for display, `process.cwd()` as root reference. Barrel exports (`index.ts`) consolidate subdirectory interfaces. Error handling uses custom error classes (`AIServiceError`, `ConfigError`, `SpecExistsError`) with `code` fields for machine-readable branching. Concurrency defaults to `getDefaultConcurrency()` (CPU/memory-aware, clamped 2-20). Telemetry writes to `.agents-reverse-engineer/logs/`, traces to `.agents-reverse-engineer/traces/`, progress to `.agents-reverse-engineer/progress.log`.

## Behavioral Contracts

**Package Version Resolution**: `version.ts` resolves `../package.json` from `src/version.ts` location via `path.join(path.dirname(fileURLToPath(import.meta.url)), '..', 'package.json')`.

**Default Concurrency Formula** (from `config/defaults.ts`): `min(cores * 5, memCap, 20)` where `memCap = floor(totalMemGB * 0.5 / 0.512)`.

**Config File Path**: `.agents-reverse-engineer/config.yaml` (from `config/loader.ts`).

**Progress Log Path**: `.agents-reverse-engineer/progress.log` (from `orchestration/progress.ts`).

**Trace Path Pattern**: `.agents-reverse-engineer/traces/trace-{timestamp}.ndjson` where timestamp is ISO 8601 with `:` and `.` replaced by `-` (from `orchestration/trace.ts`).

**Telemetry Log Pattern**: `.agents-reverse-engineer/logs/run-{command}-{backend}-{model}-{timestamp}.json` (from `ai/telemetry/run-log.ts`).

**Backend Priority Order** (from `ai/registry.ts`): `Claude → Codex → Gemini → OpenCode`.

**Generated Marker Prefix** (from `generation/writers/agents-md.ts`): `<!-- Generated by agents-reverse-engineer` (version-agnostic).

**Exit Codes** (from `cli/` commands): 0 = success/no-op, 1 = partial failure, 2 = total failure or CLI not found.

**Retry Options** (from `ai/retry.ts`): `maxRetries: 3`, `baseDelayMs: 1000`, `maxDelayMs: 8000`, `multiplier: 2`.

**Subprocess Timeout Escalation** (from `ai/subprocess.ts`): `SIGKILL_GRACE_MS = 5000` (5s after SIGTERM before SIGKILL).

**Rate Limit Patterns** (from `ai/providers/subprocess.ts`): `['rate limit', '429', 'too many requests', 'overloaded']`.

**Delimiter Format for Rebuild** (from `rebuild/output-parser.ts`): `===FILE: path===` ... `===END_FILE===`.

**Spec Structure** (from `specify/prompts.ts`): 12 mandatory sections including Project Overview, Architecture, Public API Surface, Build Plan with `Defines:`/`Consumes:` lists.