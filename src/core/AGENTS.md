<!-- Generated by agents-reverse-engineer -->

# src/core

Programmatic API surface exposing core subsystems (discovery, generation, AI, quality, config) for CLI-free library usage with dependency-injected logging and no terminal UI dependencies.

## Contents

**[index.ts](./index.ts)** — Barrel export re-exporting `Logger`/`nullLogger`/`consoleLogger`, `AIService`, `discoverFiles()`, `walkDirectory()`, `applyFilters()`, `buildFilePrompt()`, `buildDirectoryPrompt()`, `detectLanguage()`, `writeSumFile()`, `readSumFile()`, `getSumPath()`, `sumFileExists()`, `writeAgentsMd()`, `isGeneratedAgentsMd()`, `writeClaudeMdPointer()`, `GenerationOrchestrator`, `UpdateOrchestrator`, `extractExports()`, `checkCodeVsDoc()`, `checkCodeVsCode()`, `checkPhantomPaths()`, `buildInconsistencyReport()`, `formatReportForCli()`, `formatReportAsMarkdown()`, `runPool()`, `computeContentHash()`, `isGitRepo()`, `getCurrentCommit()`, `getChangedFiles()`, `loadConfig()`, `findProjectRoot()`, `getDefaultConcurrency()`, `extractImports()`, `extractDirectoryImports()`, `formatImportMap()`, and 40+ interface types (`AIServiceOptions`, `PromptContext`, `SumFileContent`, `GenerationPlan`, `UpdatePlan`, `Inconsistency`, `PoolOptions`, `Config`). Status: `@beta` API until v1.0.0.

**[logger.ts](./logger.ts)** — Defines `Logger` interface (`debug()`, `warn()`, `error()`) with `nullLogger` (no-op default for silent library operation) and `consoleLogger` (stderr-based CLI implementation).

## API Usage Pattern

1. **Discover**: `discoverFiles(projectRoot, config, logger)` → filtered file paths
2. **Phase 1**: `buildFilePrompt(context)` → `AIService.call()` → `writeSumFile()`
3. **Phase 2**: `buildDirectoryPrompt(context)` → `AIService.call()` → `writeAgentsMd()`
4. **Root**: `writeClaudeMdPointer(projectRoot)` → `CLAUDE.md`

## Dependency Injection

All core modules accept optional `Logger` parameter (defaults to `nullLogger`). CLI code passes `consoleLogger` from `src/output/logger.ts` to maintain stderr debug output. Library consumers inject custom loggers or use nullLogger for silent operation.

## Orchestration Workflow

**High-Level**: `GenerationOrchestrator.preparePlan()` → `buildExecutionPlan()` → `runPool(fileTasks)` → `runPool(directoryTasks)` → `writeClaudeMdPointer()`. Update workflow: `UpdateOrchestrator.preparePlan()` compares `content_hash` frontmatter via `readSumFile()` against `computeContentHash()`, regenerates stale `.sum` files, invokes `getAffectedDirectories()` for post-order `AGENTS.md` aggregation.

**Worker Pool**: `runPool<T>(tasks, fn, options)` spawns `options.concurrency` workers sharing single `tasks.entries()` iterator. Each worker calls `fn(task, index)` until iterator exhausted or `options.abort` signal fired. Optional `options.onComplete` callback serializes progress updates via promise-chain pattern.

## Quality Subsystem

Post-generation validation via `checkCodeVsDoc()` (regex export extraction comparing code vs `.sum` documented symbols), `checkCodeVsCode()` (duplicate symbol detection across files), `checkPhantomPaths()` (markdown link validation via `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g` + backtick path extraction + prose reference matching). Aggregated via `buildInconsistencyReport()` producing severity-tagged `InconsistencyReport`, formatted via `formatReportForCli()` (colored stderr) or `formatReportAsMarkdown()`.

## Behavioral Contracts

### Default Concurrency
```javascript
Math.min(20, Math.floor(totalMemGB * 0.5 / 0.512), Math.max(2, os.availableParallelism() * 5))
```

### Export Extraction Regex
```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```

### Import Extraction Regex
```regex
/^[ \t]*import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm
```

### Phantom Path Link Pattern
```regex
/\[(?:[^\]]*)\]\((\.[^)]+)\)/g
```

### Content Hash Algorithm
```javascript
crypto.createHash('sha256').update(fs.readFileSync(filePath, 'utf-8')).digest('hex')
```

### Generated AGENTS.md Marker
```markdown
<!-- Generated by agents-reverse-engineer -->
```