<!-- Generated by agents-reverse-engineer -->

# src/change-detection

**Git-based change detection with SHA-256 content hashing for incremental documentation updates, supporting rename tracking via `git diff -M`, uncommitted change merging via `git status --porcelain`, and hash-only fallback for non-git workflows.**

## Contents

### [detector.ts](./detector.ts)
Implements `isGitRepo()`, `getCurrentCommit()`, `getChangedFiles()`, `computeContentHash()`, and `computeContentHashFromString()` for delta computation. Parses `git diff --name-status -M` output with tab-split line parsing to extract status codes (`A`/`M`/`D`/`R<percentage>`) and file paths, maps to `FileChange` objects with optional `oldPath` for renames. Optionally merges uncommitted changes from `git.status()` (`modified`, `deleted`, `not_added`, `staged`) when `includeUncommitted: true`, using linear `Array.some()` deduplication to prevent duplicate entries. SHA-256 hashing via `node:crypto` `createHash('sha256')` with hex digest output.

### [types.ts](./types.ts)
Defines `ChangeType` (`'added' | 'modified' | 'deleted' | 'renamed'`), `FileChange` (discriminated by `status` with optional `oldPath` for `'renamed'`), `ChangeDetectionResult` (`currentCommit`, `baseCommit`, `changes[]`, `includesUncommitted`), and `ChangeDetectionOptions` (`includeUncommitted?: boolean`). Discriminated union pattern enables type-safe `oldPath` access after `status === 'renamed'` check.

### [index.ts](./index.ts)
Barrel export re-exporting all functions (`isGitRepo`, `getCurrentCommit`, `getChangedFiles`, `computeContentHash`, `computeContentHashFromString`) and types (`ChangeType`, `FileChange`, `ChangeDetectionResult`, `ChangeDetectionOptions`) from `detector.ts` and `types.ts`. Serves as public API consumed by `../update/orchestrator.ts` and `../cli/update.ts`.

## Integration Points

**Incremental Update Workflow:**
1. `src/update/orchestrator.ts` calls `getChangedFiles(projectRoot, baseCommit, options)` to compute `changes[]` array
2. For each changed file, reads `.sum` YAML frontmatter `content_hash` via `src/generation/writers/sum.ts`
3. Calls `computeContentHash(filePath)` to compute current file SHA-256 hash
4. Hash mismatch → add to `filesToAnalyze` as `FileChange`, hash match → add to `filesToSkip`
5. Detects orphans via `changes.filter(c => c.status === 'renamed')` and calls `cleanupOrphans()` to delete `.sum` files for `oldPath` entries
6. Session-end hooks (`hooks/are-session-end.js`) check `git status --porcelain` and spawn `npx agents-reverse-engineer@latest update --quiet` if changes detected

**Non-Git Fallback:**
When `isGitRepo(projectRoot)` returns `false`, consumers skip git operations and rely on SHA-256 hash comparison alone for change detection (reads all `.sum` files, compares hashes).

## Behavioral Contracts

**Diff output format:** `git diff --name-status -M` produces tab-delimited lines where:
- Add/Modify/Delete: `STATUS\tFILE` (e.g., `M\tsrc/foo.ts`)
- Rename: `R<percentage>\tOLDPATH\tNEWPATH` (e.g., `R100\tsrc/old.ts\tsrc/new.ts`)

**Rename similarity threshold:** `-M` flag uses git default 50% content similarity for rename detection.

**Status code mapping:**
```
A       → { status: 'added', path }
M       → { status: 'modified', path }
D       → { status: 'deleted', path }
R<pct>  → { status: 'renamed', path: newPath, oldPath }
```

**Uncommitted change sources (when `includeUncommitted: true`):**
- `status.modified` — modified files not staged for commit
- `status.deleted` — staged deletions
- `status.not_added` — untracked files
- `status.staged` — files added to git index

**Deduplication strategy:** Linear `changes.some(c => c.path === file)` scan before appending uncommitted entries prevents duplicate `FileChange` objects when working tree changes overlap with committed diff.

**SHA-256 output format:** 64-character hex string from `createHash('sha256').update(content).digest('hex')`.