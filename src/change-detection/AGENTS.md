<!-- Generated by agents-reverse-engineer -->

# src/change-detection

Git-based change detection and SHA-256 content hashing for incremental documentation updates. Parses `git diff --name-status -M` with rename detection, merges uncommitted working tree changes, and computes file content hashes for `.sum` frontmatter verification.

## Contents

### Core Implementation

**[detector.ts](./detector.ts)** — Implements `isGitRepo()`, `getCurrentCommit()`, `getChangedFiles()` with git diff parsing, `computeContentHash()` and `computeContentHashFromString()` for SHA-256 hex digest generation. Parses status codes (`'A'`/`'M'`/`'D'`/`'R'` prefix) from `git diff --name-status -M` (50% similarity threshold), merges `status.modified[]`, `status.deleted[]`, `status.not_added[]`, `status.staged[]` when `includeUncommitted` is true. Returns `ChangeDetectionResult` with `currentCommit`, `baseCommit`, `changes[]`, `includesUncommitted`.

**[types.ts](./types.ts)** — Defines `ChangeType` union (`'added' | 'modified' | 'deleted' | 'renamed'`), `FileChange` interface with `path`, `status`, optional `oldPath` (renames), optional `contentHash`, `ChangeDetectionResult` interface with `currentCommit`, `baseCommit`, `changes[]`, `includesUncommitted`, and `ChangeDetectionOptions` interface with `includeUncommitted` flag.

**[index.ts](./index.ts)** — Barrel export re-exporting `isGitRepo()`, `getCurrentCommit()`, `getChangedFiles()`, `computeContentHash()`, `computeContentHashFromString()` from `detector.ts` and all types from `types.ts`.

## Integration Points

- **src/update/orchestrator.ts**: Calls `getChangedFiles()` with `includeUncommitted` flag, compares `FileChange.contentHash` against `.sum` YAML frontmatter `content_hash` field, builds `filesToAnalyze` and `filesToSkip` sets, uses `ChangeType === 'deleted' | 'renamed'` for orphan cleanup targeting.
- **src/generation/writers/sum.ts**: Calls `computeContentHash()` before writing `.sum` files to populate YAML frontmatter `content_hash` field.
- **src/update/orphan-cleaner.ts**: Uses `FileChange.oldPath` (renames) and `FileChange.path` (deletes) to identify stale `.sum` files requiring removal.

## Behavioral Contracts

**Git diff parsing:** Splits `git diff --name-status -M` output on newlines, splits lines on tab separator. Status codes map to `ChangeType`:
- `'A'` → `status: 'added'`
- `'M'` → `status: 'modified'`
- `'D'` → `status: 'deleted'`
- `startsWith('R')` → `status: 'renamed'` with `oldPath = parts[1]`, `path = parts[parts.length - 1]`

**SHA-256 hashing:** Uses `crypto.createHash('sha256').update(content).digest('hex')` producing lowercase hex string (64 characters). Matches YAML frontmatter pattern `content_hash: [a-f0-9]{64}`.

**Uncommitted merge:** When `includeUncommitted` is true, deduplicates via `changes.some(c => c.path === file)` before pushing `status.modified[]`, `status.deleted[]`, `status.not_added[]`, `status.staged[]` entries.