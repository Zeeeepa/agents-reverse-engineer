<!-- Generated by agents-reverse-engineer -->

# src/change-detection

Git-based change detection subsystem providing SHA-256 content hashing and commit-to-commit diff analysis for `src/update/orchestrator.ts` incremental update workflow.

## Contents

**[detector.ts](./detector.ts)** — Implements `isGitRepo()`, `getCurrentCommit()`, `getChangedFiles()` (parses `git diff --name-status -M` with rename detection), `computeContentHash()` (SHA-256 hex digest), `computeContentHashFromString()` (in-memory variant). `getChangedFiles()` maps status codes (`A`/`M`/`D`/`R*`) to `ChangeType`, merges uncommitted changes from `git.status()` when `includeUncommitted: true`, deduplicates via path existence check.

**[types.ts](./types.ts)** — Exports `ChangeType` (`'added' | 'modified' | 'deleted' | 'renamed'`), `FileChange` (`path`, `status`, optional `oldPath`), `ChangeDetectionResult` (`currentCommit`, `baseCommit`, `changes[]`, `includesUncommitted`), `ChangeDetectionOptions` (`includeUncommitted?`).

**[index.ts](./index.ts)** — Barrel re-export of `detector.ts` functions and `types.ts` interfaces, serving as public API for `src/cli/update.ts` and `src/update/orchestrator.ts`.

## Integration

`src/update/orchestrator.ts` calls `getChangedFiles(baseCommit, { includeUncommitted: true })` to populate `filesToAnalyze`, compares `FileChange.path` content hashes against `.sum` frontmatter `content_hash` fields read by `src/generation/writers/sum.ts` `readSumFile()`, invokes `getAffectedDirectories()` on parent paths. `computeContentHash()` used by `src/generation/writers/sum.ts` to populate `.sum` frontmatter during phase 1 file analysis.

## Behavioral Contracts

### Diff Parsing
```regex
^(A|M|D|R\d+)\t([^\t]+)(\t([^\t]+))?$
```
Status codes: `A` (added), `M` (modified), `D` (deleted), `R<n>` (renamed with similarity percentage). Rename format: `R100\toldPath\tnewPath`. Non-rename format: `M\tpath`.

### Hash Algorithm
```javascript
createHash('sha256').update(content).digest('hex')
```
Produces 64-character lowercase hexadecimal string for frontmatter `content_hash` field.

### Git Diff Flags
```bash
git diff --name-status -M <baseCommit> HEAD
```
`-M` enables rename detection with default 50% similarity threshold.

### Deduplication Logic
```javascript
!changes.some(c => c.path === file)
```
Applied before adding uncommitted changes to prevent duplicates between committed diffs and working tree status.

### Uncommitted Change Mapping
- `status.modified` → `{ status: 'modified', path }`
- `status.deleted` → `{ status: 'deleted', path }`
- `status.not_added` → `{ status: 'added', path }`
- `status.staged.forEach(file => changes.push(file))`