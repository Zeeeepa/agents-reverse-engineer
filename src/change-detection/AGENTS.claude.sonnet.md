<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/change-detection

Git-based change detection subsystem providing file diff tracking and content hashing for `/are-update` incremental documentation regeneration workflow.

## Contents

- [`detector.ts`](./detector.ts): Exports `isGitRepo`, `getCurrentCommit`, `getChangedFiles` (parses `git diff --name-status -M` with rename detection, merges uncommitted changes from `git.status()`), `computeContentHash` (SHA-256 file hasher), `computeContentHashFromString` (in-memory SHA-256). Uses `simple-git` for git operations, `node:crypto` for `createHash('sha256')`, `node:fs/promises` for file I/O.
- [`types.ts`](./types.ts): Defines `ChangeType` union (`'added' | 'modified' | 'deleted' | 'renamed'`), `FileChange` interface (`path`, `status`, `oldPath?`), `ChangeDetectionResult` interface (`currentCommit`, `baseCommit`, `changes`, `includesUncommitted`), `ChangeDetectionOptions` interface (`includeUncommitted?`).
- [`index.ts`](./index.ts): Barrel export re-exporting all detector functions and types.

## Architecture

Change detection follows a three-stage pipeline: **repository validation** (`isGitRepo` checks `.git` presence via `simpleGit.checkIsRepo()`), **committed diff extraction** (`getChangedFiles` runs `git diff --name-status -M baseCommit..HEAD`, parses A/M/D/R status codes, applies 50% similarity threshold for rename detection), **uncommitted changes merge** (optionally queries `git.status()` for `modified`, `deleted`, `not_added`, `staged` arrays, appends as `FileChange` entries). `computeContentHash` provides SHA-256 fingerprinting for content-based invalidation (used by `src/update/` to skip regeneration when file unchanged despite git modification timestamp).

## Data Flow

`detector.ts` exports consumed by `src/update/index.ts` to build `changedPaths: Set<string>` from `ChangeDetectionResult.changes[]`. `getCurrentCommit` captures post-update HEAD hash for persisting in `.sum` frontmatter (`lastCommit` field). `computeContentHash` validates whether `.sum` file content matches current source, preventing redundant AI calls. `ChangeDetectionOptions.includeUncommitted` defaults true for `/are-update`, false for CI/CD batch workflows.

## Behavioral Contracts

- **Git diff status codes**: `A` (added), `M` (modified), `D` (deleted), `R100` (renamed, 100% similarity)
- **Rename detection threshold**: `git diff -M` uses 50% similarity (git default)
- **SHA-256 output format**: hex string (64 chars) from `hash.digest('hex')`
- **Uncommitted change sources**: `git.status()` returns `modified`, `deleted`, `not_added` (untracked), `staged` arrays

## File Relationships

`detector.ts` depends on `types.ts` for `FileChange`, `ChangeDetectionResult`, `ChangeDetectionOptions` interfaces. `index.ts` re-exports all symbols as public API surface. `src/update/index.ts` imports `getChangedFiles`, `computeContentHash` to implement incremental regeneration logic. `src/cli/update.ts` invokes `getCurrentCommit` to persist baseline commit in `.sum` frontmatter.