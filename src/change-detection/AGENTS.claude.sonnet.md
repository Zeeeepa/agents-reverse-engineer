<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/change-detection

Git-based change detection module providing SHA-256 content hashing and incremental file diff analysis for `/are-update` workflow. Detects added/modified/deleted/renamed files between commits and optionally includes uncommitted changes from staging area and working directory.

## Contents

- **[detector.ts](./detector.ts)**: Implements `isGitRepo`, `getCurrentCommit`, `getChangedFiles` (parses `git diff --name-status -M` with rename detection, aggregates staged/working/untracked when `includeUncommitted` is true), `computeContentHash` (SHA-256 from disk via `crypto.createHash`), `computeContentHashFromString` (in-memory SHA-256). Uses `simple-git` for all git operations, deduplicates uncommitted changes via `changes.some(c => c.path === file)`.
- **[index.ts](./index.ts)**: Barrel export re-exporting `isGitRepo`, `getCurrentCommit`, `getChangedFiles`, `computeContentHash`, `computeContentHashFromString` from `./detector.js` and types `ChangeType`, `FileChange`, `ChangeDetectionResult`, `ChangeDetectionOptions` from `./types.js`.
- **[types.ts](./types.ts)**: Exports `ChangeType` union (`'added' | 'modified' | 'deleted' | 'renamed'`), `FileChange` interface (`{ path: string; status: ChangeType; oldPath?: string }`), `ChangeDetectionResult` (`{ currentCommit: string; baseCommit: string; changes: FileChange[]; includesUncommitted: boolean }`), `ChangeDetectionOptions` (`{ includeUncommitted?: boolean }`).

## Architecture

**Two-Stage Detection**: `getChangedFiles` first invokes `git diff --name-status -M <baseCommit>..HEAD`, maps status codes (A→added, M→modified, D→deleted, R→renamed with oldPath preservation), then conditionally appends `git.status()` arrays (`staged`, `modified`, `deleted`, `not_added`) when `options.includeUncommitted` is true. Rename detection uses 50% similarity threshold (`-M` flag). Diff parsing handles two formats: `STATUS\tFILE` (add/modify/delete) and `STATUS\tOLD\tNEW` (renames).

**Content Hashing**: `computeContentHash` reads files via `fs/promises.readFile`, computes SHA-256 hex digest. `computeContentHashFromString` provides in-memory variant avoiding redundant disk I/O when content already loaded. Both return lowercase hex strings for `.sum` frontmatter comparison (see `../update/index.ts`).

## File Relationships

`detector.ts` implements core logic, `types.ts` defines contracts, `index.ts` aggregates public API. Consumed by `../update/index.ts` (`getChangedFiles`, `computeContentHash` for `.sum` frontmatter hash comparison) and `../cli/update.ts` (`isGitRepo` validation, `getCurrentCommit` for base commit resolution).

## Behavioral Contracts

**Git Diff Output Parsing** (from `detector.ts`):
```
STATUS\tFILE
STATUS\tOLD_FILE\tNEW_FILE
```
Status codes: `A` (added), `M` (modified), `D` (deleted), `R` (renamed), `R100` (100% similarity rename).

**Rename Detection**: `-M` flag uses 50% similarity threshold. `FileChange.path` holds new location, `FileChange.oldPath` preserves original for renames.

**Uncommitted Aggregation Order**: `status.modified` → `status.deleted` → `status.not_added` → `status.staged`. Deduplication via `changes.some(c => c.path === file)` prevents double-counting files in both committed diff and working directory.

**SHA-256 Output**: Lowercase hex digest (64 characters). Used for `.sum` frontmatter `contentHash:` field comparison.