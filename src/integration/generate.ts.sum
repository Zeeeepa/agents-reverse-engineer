---
generated_at: 2026-02-09T21:29:43.053Z
content_hash: 815c6784f88dbd27ad0b859beb5c7fa30845665400df4d51a3ed29f557812499
purpose: generateIntegrationFiles() orchestrates AI assistant integration file creation with environment-specific template sel...
---
**generateIntegrationFiles() orchestrates AI assistant integration file creation with environment-specific template selection, bundled hook copying, and skip-if-exists behavior.**

## Exported Functions

**generateIntegrationFiles(projectRoot: string, options?: GenerateOptions): Promise<IntegrationResult[]>**
- Main entry point for integration file generation
- Accepts `projectRoot` string and optional `GenerateOptions` with `dryRun`, `force`, and `environment` fields
- If `options.environment` is specified, bypasses `detectEnvironments()` and targets single environment using `configDirMap: Record<EnvironmentType, string>` mapping (`claude` → `.claude`, `opencode` → `.opencode`, `aider` → `.aider`, `gemini` → `.gemini`)
- Otherwise calls `detectEnvironments(projectRoot)` from `./detect.js` to get `{ type: EnvironmentType; configDir: string }[]` array
- For each environment, calls `getTemplatesForEnvironment(env.type)` to retrieve template array
- Iterates templates, constructs `fullPath` via `path.join(projectRoot, template.path)`, writes file if not exists or `force=true` via `writeFileSync(fullPath, template.content, 'utf-8')`
- Tracks created/skipped paths in `IntegrationResult.filesCreated[]` and `IntegrationResult.filesSkipped[]`
- Special case for `claude` environment: after template processing, generates hook file at `.claude/hooks/are-session-end.js` via `readBundledHook('are-session-end.js')` and `writeFileSync(fullHookPath, hookContent, 'utf-8')`
- Returns `IntegrationResult[]` array with one entry per environment

**getBundledHookPath(hookName: string): string**
- Resolves absolute path to bundled hook file in `hooks/dist/` directory
- Uses `fileURLToPath(import.meta.url)` to get current module path
- Navigates from `dist/integration/` up two levels to project root, then into `hooks/dist/`
- Returns `path.join(__dirname, '..', '..', 'hooks', 'dist', hookName)`

**readBundledHook(hookName: string): string**
- Calls `getBundledHookPath(hookName)` to resolve hook file path
- Throws `Error` with message `"Bundled hook not found: ${hookPath}"` if `existsSync(hookPath)` returns false
- Returns hook file content via `readFileSync(hookPath, 'utf-8')`

**ensureDir(filePath: string): void**
- Creates parent directories for `filePath` if they don't exist
- Calls `mkdirSync(dir, { recursive: true })` where `dir` is `path.dirname(filePath)`

**getTemplatesForEnvironment(type: EnvironmentType): ReturnType<typeof getClaudeTemplates>**
- Switch statement dispatches on `type` to call environment-specific template getters from `./templates.js`
- `'claude'` → `getClaudeTemplates()`
- `'opencode'` → `getOpenCodeTemplates()`
- `'gemini'` → `getGeminiTemplates()`
- `'aider'` → returns empty array `[]` (no templates defined)
- Default case returns empty array `[]`

## Type Definitions

**GenerateOptions** interface:
- `dryRun?: boolean` — preview mode without file writes
- `force?: boolean` — overwrite existing files instead of skipping
- `environment?: EnvironmentType` — bypass auto-detection and target specific environment

## Integration with Project

Imports `IntegrationResult` and `EnvironmentType` types from `./types.js`, `detectEnvironments()` from `./detect.js`, and template getters (`getClaudeTemplates`, `getOpenCodeTemplates`, `getGeminiTemplates`) from `./templates.js`. Called by installer CLI commands to create `.claude/skills/`, `.opencode/commands/`, `.gemini/commands/` files and session hooks.

## File System Operations

All file writes gated by `!dryRun` check to support preview mode. Uses `existsSync()` before write to implement skip-if-exists behavior (unless `force=true` overrides). Calls `ensureDir()` before every `writeFileSync()` to guarantee parent directories exist via `mkdirSync()` with `recursive: true`. Hook files read from build artifact location `hooks/dist/` which is populated by `scripts/build-hooks.js` during `npm run build:hooks` step.

## Environment Targeting Behavior

When `options.environment` is undefined, calls `detectEnvironments(projectRoot)` to scan for `.claude/`, `.opencode/`, `.aider/`, `.gemini/` config directories and generates files for all detected environments. When `options.environment` is specified, creates single-element environment array via `configDirMap` lookup, bypassing detection. This supports both multi-environment batch generation (`npx agents-reverse-engineer --runtime all`) and targeted single-environment installs (`npx agents-reverse-engineer --runtime claude -g`).