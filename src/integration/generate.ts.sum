---
generated_at: 2026-02-09T14:09:30.057Z
content_hash: 815c6784f88dbd27ad0b859beb5c7fa30845665400df4d51a3ed29f557812499
purpose: Integration file generator that writes platform-specific command files and hooks to `.claude/`, `.opencode/`, `.gemin...
---
**Integration file generator that writes platform-specific command files and hooks to `.claude/`, `.opencode/`, `.gemini/`, or `.aider/` directories for detected AI assistant environments.**

## Exported Functions

**`generateIntegrationFiles(projectRoot: string, options?: GenerateOptions): Promise<IntegrationResult[]>`**
- Orchestrates integration file generation across all detected or specified AI environments
- Calls `detectEnvironments(projectRoot)` when no `options.environment` specified
- Maps single `EnvironmentType` to `configDir` via hardcoded `configDirMap` when `options.environment` provided
- Iterates environments calling `getTemplatesForEnvironment(env.type)` to retrieve command file templates
- Writes template content to `path.join(projectRoot, template.path)` respecting `force`/`dryRun` flags
- Special handling for Claude: appends hook file `.claude/hooks/are-session-end.js` via `readBundledHook('are-session-end.js')`
- Populates `IntegrationResult.filesCreated` on write, `IntegrationResult.filesSkipped` when `existsSync()` and `!force`
- Returns `IntegrationResult[]` with per-environment file generation outcomes

**`getBundledHookPath(hookName: string): string`**
- Resolves bundled hook file path from `hooks/dist/` relative to `dist/integration/` via `import.meta.url` and `fileURLToPath()`
- Navigates `../.../hooks/dist/` (two parent directories up from current module)
- Returns absolute path to hook file like `are-session-end.js` or `opencode-are-session-end.js`

**`readBundledHook(hookName: string): string`**
- Reads hook file content via `readFileSync(getBundledHookPath(hookName), 'utf-8')`
- Throws `Error` with message `"Bundled hook not found: ${hookPath}"` if `!existsSync(hookPath)`

**`ensureDir(filePath: string): void`**
- Creates parent directories for `filePath` via `mkdirSync(dir, { recursive: true })` if `!existsSync(dir)`
- Extracts directory via `path.dirname(filePath)`

**`getTemplatesForEnvironment(type: EnvironmentType): ReturnType<typeof getClaudeTemplates>`**
- Switch-case dispatcher returning platform templates: `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()`
- Returns empty array `[]` for `'aider'` (no command file support)
- Falls through to empty array for unrecognized `type`

## Type Definitions

**`GenerateOptions`**
- `dryRun?: boolean` — Skip file writes, report planned operations only
- `force?: boolean` — Overwrite existing files instead of skipping via `filesSkipped`
- `environment?: EnvironmentType` — Bypass auto-detection, generate for single environment

## Dependencies

- `node:fs`: `existsSync`, `mkdirSync`, `writeFileSync`, `readFileSync` for file I/O
- `node:path`: Path manipulation via `dirname`, `join`
- `node:url`: `fileURLToPath` converts ESM `import.meta.url` to filesystem path
- `./detect.js`: `detectEnvironments()` returns detected AI environments with `type` and `configDir`
- `./templates.js`: `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` return command file templates
- `./types.js`: `IntegrationResult`, `EnvironmentType` type definitions

## File Generation Strategy

- **Skip logic**: `existsSync(fullPath) && !force` → add to `filesSkipped`, skip write
- **Write logic**: `!dryRun` → call `ensureDir()` then `writeFileSync()`
- **Hook bundling**: Claude hook sourced from `hooks/dist/are-session-end.js` at build time
- **Path resolution**: `configDirMap` hardcodes `.claude`, `.opencode`, `.aider`, `.gemini` relative directories
- **Template content**: Raw string content from `getTemplatesForEnvironment()` written verbatim (no interpolation)

## Claude-Specific Hook Handling

- Hook file path: `.claude/hooks/are-session-end.js`
- Content sourced via `readBundledHook('are-session-end.js')` from `hooks/dist/` distribution directory
- Bundled at build time via `scripts/build-hooks.js` copying `hooks/` to `hooks/dist/`
- Hook registration enables session-end auto-update workflow (spawns `npx agents-reverse-engineer@latest update --quiet`)