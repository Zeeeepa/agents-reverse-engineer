<!-- Generated by agents-reverse-engineer -->

# src/integration/

Environment detection and integration file generation for AI coding assistants (Claude Code, OpenCode, Gemini CLI, Aider), creating runtime-specific command templates and session hooks during installation workflow.

## Contents

**[detect.ts](./detect.ts)** — Exports `detectEnvironments(projectRoot)` returning `DetectedEnvironment[]` by checking `.claude/`/`CLAUDE.md` (Claude Code), `.opencode/` (OpenCode), `.aider.conf.yml`/`.aider/` (Aider), and `hasEnvironment(projectRoot, type)` filtering by `EnvironmentType`.

**[generate.ts](./generate.ts)** — Exports `generateIntegrationFiles(projectRoot, options?)` orchestrating template installation via `detectEnvironments()` → `getTemplatesForEnvironment()` → `writeFileSync()` with skip-if-exists/force overwrite logic, `getBundledHookPath(hookName)` resolving `hooks/dist/${hookName}` paths, `readBundledHook(hookName)` loading session-end hook content for Claude environments.

**[templates.ts](./templates.ts)** — Exports `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` generating platform-specific command files for eight ARE commands (`init`, `discover`, `generate`, `update`, `specify`, `rebuild`, `clean`, `help`), using `buildFrontmatter(platform, commandName, description)` for markdown headers, `buildGeminiToml(commandName, command)` for TOML format, substituting `COMMAND_PREFIX` (`/are-`) and `VERSION_FILE_PATH` placeholders.

**[types.ts](./types.ts)** — Exports `EnvironmentType` union (`'claude' | 'opencode' | 'aider' | 'gemini'`), `DetectedEnvironment` (`{type, configDir, detected}`), `IntegrationTemplate` (`{filename, path, content}`), `IntegrationResult` (`{environment, filesCreated, filesSkipped}`).

## Architecture

### Detection Pipeline

`detect.ts` `detectEnvironments()` scans project root via `existsSync()` checking four patterns: `.claude/` OR `CLAUDE.md` → `{type: 'claude', configDir: '.claude'}`, `.opencode/` → `{type: 'opencode', configDir: '.opencode'}`, `.aider.conf.yml` OR `.aider/` → `{type: 'aider', configDir: '.aider'}`, `.gemini/` → `{type: 'gemini', configDir: '.gemini'}`. Returns array of all detected environments with `detected: true`. Used by `generate.ts` for auto-discovery when `options.environment` not specified.

### Template Generation

`templates.ts` maintains `COMMANDS` constant defining eight command entries mapping to `{description, argumentHint, content}` structures. `buildTemplate(platform, commandName, command)` branches on platform: Gemini calls `buildGeminiToml()` creating `.gemini/commands/are-{command}.toml` with `description = "..."` and triple-quoted `prompt = """..."""`, Claude/OpenCode call `buildFrontmatter()` creating `.claude/skills/are-{command}/SKILL.md` or `.opencode/commands/are-{command}.md` with YAML frontmatter. `getTemplatesForPlatform(platform)` maps all command entries via `buildTemplate()` returning array of eight `IntegrationTemplate` objects.

### File Installation

`generate.ts` `generateIntegrationFiles()` iterates detected/specified environments, calls `getTemplatesForEnvironment(type)` mapping `'claude'` → `getClaudeTemplates()`, `'opencode'` → `getOpenCodeTemplates()`, `'gemini'` → `getGeminiTemplates()`, `'aider'` → `[]`, checks `existsSync(fullPath)` for each template, skips if `options.force=false` (adds to `filesSkipped`), otherwise writes via `ensureDir(filePath)` + `writeFileSync(fullPath, content)` (adds to `filesCreated`). Special case: Claude environments trigger `.claude/hooks/are-session-end.js` copy via `readBundledHook('are-session-end.js')` resolved through `getBundledHookPath()` navigating from `dist/integration/` to `hooks/dist/`. Respects `options.dryRun` flag for report-only mode. Returns `IntegrationResult[]` with per-environment file creation summaries.

## Platform Configuration

`templates.ts` `PLATFORM_CONFIGS` readonly record defines three platform mappings:

**Claude**: `{commandPrefix: '/are-', pathPrefix: '.claude/skills/', filenameSeparator: '.', usesName: true, versionFilePath: '.claude/ARE-VERSION'}` — creates directory structure `.claude/skills/are-{command}/SKILL.md` with `name:` frontmatter.

**OpenCode**: `{commandPrefix: '/are-', pathPrefix: '.opencode/commands/', filenameSeparator: '-', extraFrontmatter: 'agent: build', usesName: false, versionFilePath: '.opencode/ARE-VERSION'}` — creates flat files `.opencode/commands/are-{command}.md` with `agent: build` frontmatter.

**Gemini**: `{commandPrefix: '/are-', pathPrefix: '.gemini/commands/', filenameSeparator: '-', usesName: false, versionFilePath: '.gemini/ARE-VERSION'}` — creates TOML files `.gemini/commands/are-{command}.toml` with `description` and `prompt` fields.

## Command Templates

All commands use identical 4-step background execution pattern via `run_in_background: true` flag:

1. Read `VERSION_FILE_PATH` via Read tool, display "agents-reverse-engineer vX.Y.Z"
2. Execute `npx agents-reverse-engineer@latest {command} $ARGUMENTS` with Bash tool
3. Poll `.agents-reverse-engineer/progress.log` every 10-15s via Read tool with `offset` parameter showing last ~20 lines, check TaskOutput with `block: false`
4. On completion read full TaskOutput and summarize results

**`generate`** template: shows "X/Y files analyzed, ~Zm remaining" during phase-1-files, summarizes file/directory counts and quality warnings from `src/quality/` checks.

**`update`** template: shows "X/Y files updated, ~Zm remaining", summarizes files updated/unchanged/orphaned from `src/update/orphan-cleaner.ts`.

**`discover`** template: after completion reads `GENERATION-PLAN.md` and `config.yaml`, classifies Phase 1 files into seven categories (test/spec: `*.test.*`, `*.spec.*`, `__tests__/**`, `__mocks__/**`, `*.stories.*`, `*.story.*`; CI/CD: `.github/workflows/*.yml`, `.gitlab-ci.yml`, `Jenkinsfile`, `.circleci/**`, `.travis.yml`; tool configs: `.eslintrc*`, `.prettierrc*`, `jest.config.*`, `.editorconfig`, `babel.config.*`, `webpack.config.*`, `vite.config.*`, `rollup.config.*`, `tsconfig*.json`, `.lintstagedrc*`, `.huskyrc*`, `.stylelintrc*`, `commitlint.config.*`; migrations: paths containing `migrations/` or `*.migration.*`; fixtures/snapshots: `__snapshots__/**`, `*.fixture.*`, `fixtures/**`, `test-data/**`, `testdata/**`; type declarations: `*.d.ts`; Docker/infra: `Dockerfile*`, `docker-compose*`, `*.Dockerfile`, `k8s/**`, `terraform/**`, `helm/**`), presents summary table with counts/examples/proposed globs, invokes `AskUserQuestion` with `multiSelect: true`, appends accepted patterns to `config.yaml` via Edit tool.

**`help`** template: `<objective>` section mandates display version first then output comprehensive `<reference>` block with NO additional commentary, covering Quick Start workflow (init → generate → update), eight command entries with flag tables (`--concurrency N`, `--dry-run`, `--uncommitted`, `--multi-file`, `--force`, `--fail-fast`, `--debug`, `--trace`), CLI installation instructions, config.yaml schema, generated file format specs (*.sum YAML frontmatter, AGENTS.md structure, CLAUDE.md pointer), common workflows, tips.

## Integration Points

Invoked by `src/cli/init.ts` during `npx agents-reverse-engineer install` workflow: calls `detectEnvironments(projectRoot)` for multi-runtime discovery, `generateIntegrationFiles(projectRoot, {environment, force, dryRun})` installing command templates and hooks, reports `filesCreated`/`filesSkipped` counts. Bundled hook files (`hooks/dist/are-session-end.js`, `hooks/dist/are-check-update.js`) built via `scripts/build-hooks.js` during `npm run build:hooks` / `prepublishOnly`, copied to `.claude/hooks/` for SessionStart/SessionEnd automation.

## Behavioral Contracts

### Environment Detection Rules
```typescript
// Claude Code: .claude/ directory OR CLAUDE.md file
existsSync(path.join(projectRoot, '.claude')) || existsSync(path.join(projectRoot, 'CLAUDE.md'))
// OpenCode: .opencode/ directory only
existsSync(path.join(projectRoot, '.opencode'))
// Aider: .aider.conf.yml file OR .aider/ directory
existsSync(path.join(projectRoot, '.aider.conf.yml')) || existsSync(path.join(projectRoot, '.aider'))
// Gemini: .gemini/ directory only
existsSync(path.join(projectRoot, '.gemini'))
```

### Template Filename Patterns
```
Claude:   .claude/skills/are-{command}/SKILL.md
OpenCode: .opencode/commands/are-{command}.md
Gemini:   .gemini/commands/are-{command}.toml
```

### Frontmatter Generation
```yaml
# Claude (usesName: true)
---
name: are-{command}
description: {description}
---

# OpenCode (extraFrontmatter: "agent: build")
---
description: {description}
agent: build
---
```

### TOML Generation
```toml
# Gemini format
description = "{description}"
# Arguments: {argumentHint}
prompt = """
{content}
"""
```

### Template Variable Substitution
```typescript
content.replace(/COMMAND_PREFIX/g, config.commandPrefix)  // /are-
content.replace(/VERSION_FILE_PATH/g, config.versionFilePath)  // .{runtime}/ARE-VERSION
```

### Hook Path Resolution
```typescript
// From dist/integration/generate.js
getBundledHookPath('are-session-end.js')
// → ../../hooks/dist/are-session-end.js (relative to dist/integration/)
// → {projectRoot}/hooks/dist/are-session-end.js (absolute)
```

### File Skip Logic
```typescript
if (existsSync(fullPath) && !options.force) {
  result.filesSkipped.push(template.path)
} else {
  ensureDir(fullPath)
  if (!options.dryRun) writeFileSync(fullPath, template.content)
  result.filesCreated.push(template.path)
}
```

### Discover Category Classification
```
Test/Spec:         *.test.*, *.spec.*, __tests__/**, __mocks__/**, *.stories.*, *.story.*
CI/CD:             .github/workflows/*.yml, .gitlab-ci.yml, Jenkinsfile, .circleci/**, .travis.yml
Tool Configs:      .eslintrc*, .prettierrc*, jest.config.*, .editorconfig, babel.config.*, webpack.config.*, vite.config.*, rollup.config.*, tsconfig*.json, .lintstagedrc*, .huskyrc*, .stylelintrc*, commitlint.config.*
Migrations:        **/migrations/**, *.migration.*
Fixtures/Snapshots: __snapshots__/**, *.fixture.*, fixtures/**, test-data/**, testdata/**
Type Declarations: *.d.ts
Docker/Infra:      Dockerfile*, docker-compose*, *.Dockerfile, k8s/**, terraform/**, helm/**
```