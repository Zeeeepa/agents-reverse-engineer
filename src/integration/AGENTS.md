<!-- Generated by agents-reverse-engineer v0.8.3 -->

# src/integration

Environment detection and integration file generation for three AI coding assistants (Claude Code, OpenCode, Gemini CLI) via directory/file presence checks and platform-specific template rendering (markdown frontmatter, TOML).

## Contents

**[detect.ts](./detect.ts)** — `detectEnvironments(projectRoot): DetectedEnvironment[]` checks `.claude/` OR `CLAUDE.md` (Claude Code), `.opencode/` (OpenCode), `.aider.conf.yml` OR `.aider/` (Aider) via `existsSync()`, returns `{type, configDir, detected: true}[]`. `hasEnvironment(projectRoot, type)` filters results by `EnvironmentType`.

**[generate.ts](./generate.ts)** — `generateIntegrationFiles(projectRoot, options?): Promise<IntegrationResult[]>` orchestrates template writing via `getTemplatesForEnvironment()`, creates `ensureDir()` + `writeFileSync()` with skip-if-exists (unless `force=true`), copies `.claude/hooks/are-session-end.js` via `readBundledHook()` resolved from `hooks/dist/`, returns per-environment `{filesCreated, filesSkipped}`. `getBundledHookPath(hookName)` navigates from `dist/integration/` up two levels to `hooks/dist/${hookName}`.

**[templates.ts](./templates.ts)** — `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` return arrays mapping eight commands (init, discover, generate, update, specify, rebuild, clean, help) to `IntegrationTemplate` structures. `COMMANDS` defines `{description, argumentHint, content}` for each command with multi-paragraph markdown workflows. `buildTemplate(platform, commandName, command)` branches on platform: Gemini → `buildGeminiToml()` (TOML format with `description` + triple-quoted `prompt`), Claude/OpenCode → `buildFrontmatter()` (markdown with `name:`/`description:`/`agent: build`). Replaces `COMMAND_PREFIX` → `/are-`, `VERSION_FILE_PATH` → `.{platform}/ARE-VERSION`.

**[types.ts](./types.ts)** — `EnvironmentType = 'claude' | 'opencode' | 'aider' | 'gemini'`, `DetectedEnvironment = {type, configDir, detected}`, `IntegrationTemplate = {filename, path, content}`, `IntegrationResult = {environment, filesCreated, filesSkipped}`.

## Platform Configuration

**`PLATFORM_CONFIGS`** (templates.ts) maps `'claude' | 'opencode' | 'gemini'` to `PlatformConfig`:

- **Claude**: `pathPrefix: '.claude/skills/'`, `filenameSeparator: '.'`, `usesName: true`, `versionFilePath: '.claude/ARE-VERSION'` → creates `.claude/skills/are-{command}/SKILL.md` directories with `name:` frontmatter.
- **OpenCode**: `pathPrefix: '.opencode/commands/'`, `filenameSeparator: '-'`, `extraFrontmatter: 'agent: build'`, `usesName: false`, `versionFilePath: '.opencode/ARE-VERSION'` → creates `.opencode/commands/are-{command}.md` flat files.
- **Gemini**: `pathPrefix: '.gemini/commands/'`, `filenameSeparator: '-'`, `usesName: false`, `versionFilePath: '.gemini/ARE-VERSION'` → creates `.gemini/commands/are-{command}.toml` TOML files.

All platforms use `commandPrefix: '/are-'`.

## Detection Logic

**Claude Code**: triggers when `.claude/` directory OR `CLAUDE.md` file exists, assigns `configDir: '.claude'`.

**OpenCode**: triggers when `.opencode/` directory exists, assigns `configDir: '.opencode'`.

**Aider**: triggers when `.aider.conf.yml` file OR `.aider/` directory exists, assigns `configDir: '.aider'`.

**Gemini**: no detection implemented (manual via `options.environment='gemini'`).

## Command Workflows

All background commands (generate, update, discover, specify, rebuild) follow 5-step pattern: (1) read `VERSION_FILE_PATH` via Read tool, display "agents-reverse-engineer vX.Y.Z", (2) delete `.agents-reverse-engineer/progress.log`, (3) `Bash` invokes `npx agents-reverse-engineer@latest {command} $ARGUMENTS` with `run_in_background: true`, (4) poll `.agents-reverse-engineer/progress.log` every 10-15s using Read with `offset` showing "X/Y units processed", check TaskOutput with `block: false`, (5) summarize completion results.

**generate command**: displays version, deletes progress.log, runs `generate $ARGUMENTS` in background, polls progress.log every 15s showing "X/Y files analyzed, ~Zm remaining" via Read with `offset` and TaskOutput with `block: false`, summarizes file/directory counts and quality warnings. Describes two-phase pipeline: concurrent `.sum` file analysis with YAML frontmatter (`content_hash`, `file_type`, `purpose`, `public_interface`, `dependencies`, `patterns`), post-order `AGENTS.md` aggregation + `CLAUDE.md` pointers.

**update command**: mirrors generate 5-step workflow, polls progress.log showing "X/Y files updated, ~Zm remaining", summarizes files updated/unchanged/orphaned.

**discover command**: 6-step interactive workflow with STRICT RULES preamble ("DO NOT add ANY flags the user did not explicitly type"), runs `discover $ARGUMENTS` in background, polls progress.log every 10s, after completion reads `GENERATION-PLAN.md` + `config.yaml`, classifies Phase 1 files into seven categories (test/spec: `*.test.*`, `*.spec.*`, `__tests__/**`, `__mocks__/**`, `*.stories.*`, `*.story.*`; CI/CD: `.github/workflows/*.yml`, `.gitlab-ci.yml`, `Jenkinsfile`, `.circleci/**`, `.travis.yml`; tool configs: `.eslintrc*`, `.prettierrc*`, `jest.config.*`, `.editorconfig`, `babel.config.*`, `webpack.config.*`, `vite.config.*`, `rollup.config.*`, `tsconfig*.json`, `.lintstagedrc*`, `.huskyrc*`, `.stylelintrc*`, `commitlint.config.*`; migrations: `**/migrations/**`, `*.migration.*`; fixtures/snapshots: `__snapshots__/**`, `*.fixture.*`, `fixtures/**`, `test-data/**`, `testdata/**`; type declarations: `*.d.ts`; Docker/infra: `Dockerfile*`, `docker-compose*`, `*.Dockerfile`, `k8s/**`, `terraform/**`, `helm/**`), counts matches showing ≤3 examples, skips zero-match or already-excluded categories, presents summary table, invokes `AskUserQuestion` with `multiSelect: true`, appends selected globs to `config.yaml` `exclude.patterns` via Edit tool.

**specify command**: 5-step background workflow displaying version, deleting progress.log, running `specify $ARGUMENTS` in background, polling progress.log every 15s, summarizing AGENTS.md file count and output paths. Auto-runs `generate` if no AGENTS.md exist. Options: `--output` (default specs/SPEC.md), `--multi-file` (split into multiple files).

**rebuild command**: 5-step background workflow displaying version, deleting progress.log, running `rebuild $ARGUMENTS` in background, polling progress.log showing "X/Y rebuild units completed", summarizing completion. Reads `specs/`, partitions into ordered units via `===FILE: path===`/`===END_FILE===` delimiter parsing, processes sequentially between groups with concurrent pool per group, exit codes 0 (success), 1 (partial failure), 2 (total failure). Options: `--output` (default rebuild/), `--force` (wipe output directory).

**init command**: 2-step synchronous workflow displaying version, running `npx agents-reverse-engineer@latest init`, creates `.agents-reverse-engineer/config.yaml`.

**clean command**: synchronous workflow with STRICT RULES enforcing exact `clean $ARGUMENTS` invocation with zero added flags, displays version, runs command, reports deletion count. Deletes `.agents-reverse-engineer/GENERATION-PLAN.md`, `*.sum`, `AGENTS.md`, `CLAUDE.md`.

**help command**: displays version from `VERSION_FILE_PATH`, outputs `<reference>` block with NO additional commentary containing: Quick Start (init → generate → update), eight command entries with flag tables (`--concurrency N`, `--dry-run`, `--uncommitted`, `--multi-file`, `--force`, `--fail-fast`, `--debug`, `--trace`), CLI installation (`npx agents-reverse-engineer install --runtime <claude|opencode|gemini|all> -g|-l`, flags: `--runtime`, `-g/--global`, `-l/--local`, `--force`), config.yaml schema (exclude.patterns, vendorDirs, binaryExtensions, options.followSymlinks/maxFileSize, output.colors), generated file formats (*.sum YAML frontmatter: `file_type`, `generated_at`, `content_hash`, `purpose`, `public_interface`, `dependencies`, `patterns`, `related_files`; AGENTS.md directory overviews; CLAUDE.md pointer), common workflows (initial: init+generate, after changes: update, full regen: clean+generate, preview: discover+generate --dry-run), tips (custom exclusions via config.yaml, hook auto-update), resources (GitHub repo https://github.com/GeoloeG-IsT/agents-reverse-engineer, update: `npx agents-reverse-engineer@latest install --force`).

## Integration with CLI

Used by `src/cli/init.ts` during installation workflow. `src/installer/operations.ts` calls `generateIntegrationFiles()` after config initialization, reads bundled hooks from `hooks/dist/` distributed via `prepublishOnly` script (`scripts/build-hooks.js`).

## Behavioral Contracts

### Environment Resolution Priority
```javascript
// When options.environment provided:
configDirMap = { 'claude': '.claude', 'opencode': '.opencode', 'aider': '.aider', 'gemini': '.gemini' }
// Otherwise: detectEnvironments(projectRoot)
```

### File Creation Logic
```javascript
if (existsSync(fullPath) && !force) {
  filesSkipped.push(template.path)
} else {
  writeFileSync(fullPath, template.content)
  filesCreated.push(template.path)
}
```

### Hook Path Resolution
```javascript
// From dist/integration/ → hooks/dist/
path.join(__dirname, '..', '..', 'hooks', 'dist', hookName)
```

### Progress Polling Pattern
```javascript
// Read last ~20 lines every 10-15s
Read('.agents-reverse-engineer/progress.log', { offset: max(0, lineCount - 20) })
// Continues even if file doesn't exist yet
```

### Category Classification Regex
- **Tests/Specs**: `/\.(test|spec)\./`, `/__tests__/`, `/__mocks__/`, `/\.(stories|story)\./`
- **CI/CD**: `/\.github\/workflows\/.*\.yml$/`, `/\.gitlab-ci\.yml$/`, `/Jenkinsfile$/`, `/\.circleci\//`, `/\.travis\.yml$/`
- **Tool Configs**: `/\.eslintrc/`, `/\.prettierrc/`, `/jest\.config\./`, `/\.editorconfig$/`, `/babel\.config\./`, `/webpack\.config\./`, `/vite\.config\./`, `/rollup\.config\./`, `/tsconfig.*\.json$/`, `/\.lintstagedrc/`, `/\.huskyrc/`, `/\.stylelintrc/`, `/commitlint\.config\./`
- **Migrations**: `/\/migrations\//`, `/\.migration\./`
- **Fixtures/Snapshots**: `/__snapshots__/`, `/\.fixture\./`, `/\/fixtures\//`, `/\/test-data\//`, `/\/testdata\//`
- **Type Declarations**: `/\.d\.ts$/`
- **Docker/Infra**: `/^Dockerfile/, `/docker-compose/`, `/\.Dockerfile$/`, `/\/k8s\//`, `/\/terraform\//`, `/\/helm\//`