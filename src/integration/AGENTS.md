<!-- Generated by agents-reverse-engineer v0.8.2 -->

# src/integration

Environment detection and integration file generation for three AI coding assistants (Claude Code, OpenCode, Gemini CLI) via directory/file presence checks and platform-specific template rendering (markdown frontmatter, TOML).

## Contents

**[detect.ts](./detect.ts)** — `detectEnvironments(projectRoot): DetectedEnvironment[]` checks `.claude/` OR `CLAUDE.md` (Claude Code), `.opencode/` (OpenCode), `.aider.conf.yml` OR `.aider/` (Aider) via `existsSync()`, returns `{type, configDir, detected: true}[]`. `hasEnvironment(projectRoot, type)` filters results by `EnvironmentType`.

**[generate.ts](./generate.ts)** — `generateIntegrationFiles(projectRoot, options?): Promise<IntegrationResult[]>` orchestrates template writing via `getTemplatesForEnvironment()`, creates `ensureDir()` + `writeFileSync()` with skip-if-exists (unless `force=true`), copies `.claude/hooks/are-session-end.js` via `readBundledHook()` resolved from `hooks/dist/`, returns per-environment `{filesCreated, filesSkipped}`. `getBundledHookPath(hookName)` navigates from `dist/integration/` up two levels to `hooks/dist/${hookName}`.

**[templates.ts](./templates.ts)** — `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` return arrays mapping eight commands (init, discover, generate, update, specify, rebuild, clean, help) to `IntegrationTemplate` structures. `COMMANDS` defines `{description, argumentHint, content}` for each command with multi-paragraph markdown workflows. `buildTemplate(platform, commandName, command)` branches on platform: Gemini → `buildGeminiToml()` (TOML format with `description` + triple-quoted `prompt`), Claude/OpenCode → `buildFrontmatter()` (markdown with `name:`/`description:`/`agent: build`). Replaces `COMMAND_PREFIX` → `/are-`, `VERSION_FILE_PATH` → `.{platform}/ARE-VERSION`.

**[types.ts](./types.ts)** — `EnvironmentType = 'claude' | 'opencode' | 'aider' | 'gemini'`, `DetectedEnvironment = {type, configDir, detected}`, `IntegrationTemplate = {filename, path, content}`, `IntegrationResult = {environment, filesCreated, filesSkipped}`.

## Platform Configuration

**`PLATFORM_CONFIGS`** (templates.ts) maps `'claude' | 'opencode' | 'gemini'` to `PlatformConfig`:

- **Claude**: `pathPrefix: '.claude/skills/'`, `filenameSeparator: '.'`, `usesName: true`, `versionFilePath: '.claude/ARE-VERSION'` → creates `.claude/skills/are-{command}/SKILL.md` directories with `name:` frontmatter.
- **OpenCode**: `pathPrefix: '.opencode/commands/'`, `filenameSeparator: '-'`, `extraFrontmatter: 'agent: build'`, `usesName: false`, `versionFilePath: '.opencode/ARE-VERSION'` → creates `.opencode/commands/are-{command}.md` flat files.
- **Gemini**: `pathPrefix: '.gemini/commands/'`, `filenameSeparator: '-'`, `usesName: false`, `versionFilePath: '.gemini/ARE-VERSION'` → creates `.gemini/commands/are-{command}.toml` TOML files.

All platforms use `commandPrefix: '/are-'`.

## Detection Logic

**Claude Code**: triggers when `.claude/` directory OR `CLAUDE.md` file exists, assigns `configDir: '.claude'`.

**OpenCode**: triggers when `.opencode/` directory exists, assigns `configDir: '.opencode'`.

**Aider**: triggers when `.aider.conf.yml` file OR `.aider/` directory exists, assigns `configDir: '.aider'`.

**Gemini**: no detection implemented (manual via `options.environment='gemini'`).

## Command Workflows

All background commands (generate, update, discover, specify, rebuild) follow 4-step pattern: (1) read `VERSION_FILE_PATH` via Read tool, display "agents-reverse-engineer vX.Y.Z", (2) `Bash` invokes `npx agents-reverse-engineer@latest {command} $ARGUMENTS` with `run_in_background: true`, (3) poll `.agents-reverse-engineer/progress.log` every 10-15s using Read with `offset` showing "X/Y units processed", check TaskOutput with `block: false`, (4) summarize completion results.

**discover command** (interactive workflow): after background completion, reads `GENERATION-PLAN.md` + `config.yaml`, classifies Phase 1 files into seven categories (test/spec: `*.test.*`, `*.spec.*`, `__tests__/**`, `__mocks__/**`, `*.stories.*`; CI/CD: `.github/workflows/*.yml`, `.gitlab-ci.yml`, `Jenkinsfile`, `.circleci/**`, `.travis.yml`; tool configs: `.eslintrc*`, `.prettierrc*`, `jest.config.*`, `.editorconfig`, `babel.config.*`, `webpack.config.*`, `vite.config.*`, `rollup.config.*`, `tsconfig*.json`, `.lintstagedrc*`, `.huskyrc*`, `.stylelintrc*`, `commitlint.config.*`; migrations: `**/migrations/**`, `*.migration.*`; fixtures/snapshots: `__snapshots__/**`, `*.fixture.*`, `fixtures/**`, `test-data/**`, `testdata/**`; type declarations: `*.d.ts`; Docker/infra: `Dockerfile*`, `docker-compose*`, `*.Dockerfile`, `k8s/**`, `terraform/**`, `helm/**`), counts matches showing ≤3 examples, skips zero-match categories, presents summary table, invokes `AskUserQuestion` with `multiSelect: true`, appends selected globs to `config.yaml` `exclude.patterns` via Edit tool.

**help command**: displays version from `VERSION_FILE_PATH`, outputs `<reference>` block with NO additional commentary containing: Quick Start (init → generate → update), eight command entries with flags (`--concurrency N`, `--dry-run`, `--uncommitted`, `--multi-file`, `--force`, `--fail-fast`, `--debug`, `--trace`), installation instructions (`npx agents-reverse-engineer install --runtime <rt> -g|-l`), config.yaml schema (exclude.patterns, vendorDirs, binaryExtensions, options, output.colors), file formats (*.sum YAML frontmatter, AGENTS.md, CLAUDE.md pointer), common workflows, tips, resources.

## Integration with CLI

Used by `src/cli/init.ts` during installation workflow. `src/installer/operations.ts` calls `generateIntegrationFiles()` after config initialization, reads bundled hooks from `hooks/dist/` distributed via `prepublishOnly` script (`scripts/build-hooks.js`).

## Behavioral Contracts

### Environment Resolution Priority
```javascript
// When options.environment provided:
configDirMap = { 'claude': '.claude', 'opencode': '.opencode', 'aider': '.aider', 'gemini': '.gemini' }
// Otherwise: detectEnvironments(projectRoot)
```

### File Creation Logic
```javascript
if (existsSync(fullPath) && !force) {
  filesSkipped.push(template.path)
} else {
  writeFileSync(fullPath, template.content)
  filesCreated.push(template.path)
}
```

### Hook Path Resolution
```javascript
// From dist/integration/ → hooks/dist/
path.join(__dirname, '..', '..', 'hooks', 'dist', hookName)
```

### Progress Polling Pattern
```javascript
// Read last ~20 lines every 10-15s
Read('.agents-reverse-engineer/progress.log', { offset: max(0, lineCount - 20) })
// Continues even if file doesn't exist yet
```

### Category Classification Regex
- **Tests/Specs**: `/\.(test|spec)\./`, `/__tests__/`, `/__mocks__/`, `/\.(stories|story)\./`
- **CI/CD**: `/\.github\/workflows\/.*\.yml$/`, `/\.gitlab-ci\.yml$/`, `/Jenkinsfile$/`, `/\.circleci\//`, `/\.travis\.yml$/`
- **Tool Configs**: `/\.eslintrc/`, `/\.prettierrc/`, `/jest\.config\./`, `/\.editorconfig$/`, `/babel\.config\./`, `/webpack\.config\./`, `/vite\.config\./`, `/rollup\.config\./`, `/tsconfig.*\.json$/`, `/\.lintstagedrc/`, `/\.huskyrc/`, `/\.stylelintrc/`, `/commitlint\.config\./`
- **Migrations**: `/\/migrations\//`, `/\.migration\./`
- **Fixtures/Snapshots**: `/__snapshots__/`, `/\.fixture\./`, `/\/fixtures\//`, `/\/test-data\//`, `/\/testdata\//`
- **Type Declarations**: `/\.d\.ts$/`
- **Docker/Infra**: `/^Dockerfile/, `/docker-compose/`, `/\.Dockerfile$/`, `/\/k8s\//`, `/\/terraform\//`, `/\/helm\//`