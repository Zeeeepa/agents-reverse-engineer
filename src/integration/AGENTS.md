<!-- Generated by agents-reverse-engineer -->

# src/integration/

**Platform-specific AI assistant integration layer performing environment detection, template generation, and file installation for Claude Code, OpenCode, Gemini CLI, and Aider via filesystem marker scanning and bundled hook deployment.**

## Contents

### Environment Detection

**[detect.ts](./detect.ts)** — Exports `detectEnvironments()` and `hasEnvironment()` for AI runtime discovery via filesystem markers. `detectEnvironments()` scans `projectRoot` for Claude (`.claude/` or `CLAUDE.md`), OpenCode (`.opencode/`), Aider (`.aider.conf.yml` or `.aider/`) using synchronous `existsSync()` checks. Returns `DetectedEnvironment[]` with `type`, `configDir`, `detected` fields. `hasEnvironment()` provides predicate wrapper filtering by `EnvironmentType`.

**[types.ts](./types.ts)** — Defines `EnvironmentType` literal union `'claude' | 'opencode' | 'aider' | 'gemini'`, `DetectedEnvironment` with `type`/`configDir`/`detected` fields, `IntegrationTemplate` with `filename`/`path`/`content` fields, `IntegrationResult` with `environment`/`filesCreated`/`filesSkipped` arrays.

### Template Generation

**[templates.ts](./templates.ts)** — Exports `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` producing `IntegrationTemplate[]` arrays with platform-specific command files. Defines `COMMANDS` object with six templates (`generate`, `update`, `init`, `discover`, `clean`, `specify`, `help`) containing placeholder substitution for `COMMAND_PREFIX` (`/are-`), `VERSION_FILE_PATH` (`.claude/ARE-VERSION` | `.opencode/ARE-VERSION` | `.gemini/ARE-VERSION`), `$ARGUMENTS`. `PLATFORM_CONFIGS` maps `Platform` to `PlatformConfig` specifying `pathPrefix` (`.claude/skills/` | `.opencode/commands/` | `.gemini/commands/`), `filenameSeparator`, `usesName` (Claude-only YAML frontmatter), `extraFrontmatter` (OpenCode `agent: build`). `buildTemplate()` constructs paths, `buildFrontmatter()` injects YAML, `buildGeminiToml()` generates TOML format. Command content embeds background execution pattern with `run_in_background: true`, `TaskOutput` polling, `.agents-reverse-engineer/progress.log` monitoring via `Read` tool with `offset` parameter. `discover`/`clean` templates include strict rule blocks forbidding flag injection beyond `$ARGUMENTS`.

### File Installation

**[generate.ts](./generate.ts)** — Exports `generateIntegrationFiles(projectRoot, options?)` orchestrating setup via `detectEnvironments()` → `getTemplatesForEnvironment()` → `writeFileSync()` chain. Maps `EnvironmentType` to config directories (`claude` → `.claude`, `opencode` → `.opencode`, `aider` → `.aider`, `gemini` → `.gemini`). Creates parent directories via `ensureDir()` using `mkdirSync({ recursive: true })`. Skips existing files unless `options.force` overrides, populates `IntegrationResult.filesSkipped[]`. For `claude` environment specifically, copies bundled hook `are-session-end.js` from `hooks/dist/` to `.claude/hooks/are-session-end.js` via `readBundledHook()` → `writeFileSync()`. `getBundledHookPath()` resolves hook paths from `dist/integration/` up two levels to project root then into `hooks/dist/{hookName}`. Throws `Error` if bundled hook missing. Returns `IntegrationResult[]` with `filesCreated`/`filesSkipped` per environment. Respects `options.dryRun` for preview mode. Defines `GenerateOptions` interface with `dryRun?`, `force?`, `environment?` fields.

## Integration Points

Consumed by `src/installer/operations.ts` during npx-based installation workflow. `detectEnvironments()` validates target runtime presence before hook registration. Template generators provide command file content for `src/installer/operations.ts` writes. Generated files reference `VERSION_FILE_PATH` for session hooks' version checking logic.

## File Path Patterns

**Claude Code:**
- Commands: `.claude/skills/are-{command}/SKILL.md`
- Hooks: `.claude/hooks/are-session-end.js`
- Version cache: `.claude/ARE-VERSION`

**OpenCode:**
- Commands: `.opencode/commands/are-{command}.md`
- Version cache: `.opencode/ARE-VERSION`

**Gemini CLI:**
- Commands: `.gemini/commands/are-{command}.toml`
- Version cache: `.gemini/ARE-VERSION`

**Aider:**
- Markers: `.aider.conf.yml`, `.aider/`
- No template generation (detection only)

## Hook Bundling Convention

Hooks copied from `hooks/dist/{hookName}` (post-build artifacts from `scripts/build-hooks.js`). Claude `are-session-end.js` hook spawns detached `npx agents-reverse-engineer@latest update --quiet` process on `git status --porcelain` detecting changes. Disable via `ARE_DISABLE_HOOK=1` environment variable or `hook_enabled: false` config flag.