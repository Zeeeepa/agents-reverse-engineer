<!-- Generated by agents-reverse-engineer -->

# src/integration

**Detects AI coding assistant environments (Claude Code, OpenCode, Gemini, Aider) via filesystem markers, generates platform-specific command files with frontmatter-wrapped templates, and manages hook installation for session lifecycle integration.**

## Contents

### Environment Detection

**[detect.ts](./detect.ts)** — `detectEnvironments()` scans project root for environment markers (`.claude/`, `CLAUDE.md`, `.opencode/`, `.aider.conf.yml`, `.aider/`) via `existsSync()`, returns `DetectedEnvironment[]` with `type`, `configDir`, `detected` fields; `hasEnvironment()` tests single environment presence.

**[types.ts](./types.ts)** — `EnvironmentType` union (`'claude' | 'opencode' | 'gemini' | 'aider'`), `DetectedEnvironment` interface with detection metadata, `IntegrationTemplate` schema (`filename`, `path`, `content`), `IntegrationResult` tracking `filesCreated`/`filesSkipped` per environment.

### Template Generation

**[templates.ts](./templates.ts)** — `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` produce command files via `PLATFORM_CONFIGS` mapping (`.claude/skills/`, `.opencode/commands/`, `.gemini/commands/`); `buildFrontmatter()` constructs YAML headers with `name`/`description`/`agent` fields, `buildGeminiToml()` emits TOML format with triple-quoted `prompt`; seven commands (generate, update, init, discover, clean, specify, help) defined in `COMMANDS` constant with shared long-running monitoring pattern (delete stale `progress.log`, spawn background task, poll with Read tool offset, check TaskOutput).

**[generate.ts](./generate.ts)** — `generateIntegrationFiles()` orchestrates template write workflow: invokes `detectEnvironments()` or uses `options.environment` override, routes to `getTemplatesForEnvironment()`, writes files via `writeFileSync()` with `ensureDir()` directory creation, respects `dryRun`/`force` flags; Claude environment receives additional `are-session-end.js` hook copy via `readBundledHook()` from `hooks/dist/`.

## Platform Configuration

`PLATFORM_CONFIGS` in [templates.ts](./templates.ts) maps each `EnvironmentType` to:
- `commandPrefix` — `/are-` invocation prefix for all platforms
- `pathPrefix` — Directory structure (`.claude/skills/`, `.opencode/commands/`, `.gemini/commands/`)
- `filenameSeparator` — Filename joining character (`.` for Claude subdirectories, `-` for flat OpenCode/Gemini)
- `usesName` — Frontmatter `name` field presence (true for Claude only)
- `versionFilePath` — Platform-specific version tracking (`.claude/ARE-VERSION`, `.opencode/ARE-VERSION`, `.gemini/ARE-VERSION`)
- `extraFrontmatter` — Additional YAML fields (`agent: build` for OpenCode)

## File Naming Conventions

Claude uses nested structure: `.claude/skills/are-generate/SKILL.md` (constant `SKILL.md` filename within command subdirectory).

OpenCode and Gemini use flat structure: `.opencode/commands/are-generate.md`, `.gemini/commands/are-generate.toml`.

## Integration Points

Consumed by `src/installer/operations.ts` which prompts runtime selection via `selectRuntimes()` and invokes `generateIntegrationFiles()` with global/local installation mode.

Detection logic powers environment-specific template filtering in `getTemplatesForEnvironment()` (returns empty array for Aider, no command file support).

Templates embed placeholder replacement (`COMMAND_PREFIX`, `VERSION_FILE_PATH`) applied during `buildTemplate()` construction before content serialization.