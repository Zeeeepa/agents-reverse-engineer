<!-- Generated by agents-reverse-engineer -->

# src/integration

Detects AI coding assistant environments (Claude Code, OpenCode, Aider, Gemini) and generates platform-specific command templates with hooks for agents-reverse-engineer integration.

## Contents

### Environment Detection

**[detect.ts](./detect.ts)** — `detectEnvironments(projectRoot)` scans for `.claude/`, `CLAUDE.md`, `.opencode/`, `.aider.conf.yml`, `.aider/` using `existsSync()`, returns `DetectedEnvironment[]` with `type`, `configDir`, `detected` fields. `hasEnvironment(projectRoot, type)` filters detection results for single environment check.

**[types.ts](./types.ts)** — Defines `EnvironmentType` union (`'claude' | 'opencode' | 'aider' | 'gemini'`), `DetectedEnvironment` interface (`type`, `configDir`, `detected`), `IntegrationTemplate` interface (`filename`, `path`, `content`), `IntegrationResult` interface (`environment`, `filesCreated`, `filesSkipped`).

### Template Generation

**[templates.ts](./templates.ts)** — `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` return `IntegrationTemplate[]` arrays for platform-specific command files. `COMMANDS` constant defines seven commands (`generate`, `update`, `init`, `discover`, `clean`, `specify`, `rebuild`) with `description`, `argumentHint`, `content` fields. `buildTemplate(platform, commandName, command)` constructs markdown frontmatter for Claude/OpenCode or TOML via `buildGeminiToml()` for Gemini, replacing `COMMAND_PREFIX` and `VERSION_FILE_PATH` tokens.

**[generate.ts](./generate.ts)** — `generateIntegrationFiles(projectRoot, options)` orchestrates file creation by calling `detectEnvironments()` or using `options.environment`, retrieves templates via `getTemplatesForEnvironment()`, writes files with `ensureDir()` and `writeFileSync()` respecting skip-if-exists unless `force=true`. For Claude environment, `readBundledHook('are-session-end.js')` copies bundled hook from `hooks/dist/` resolved via `getBundledHookPath()` to `.claude/hooks/`.

## File Relationships

`generate.ts` imports `detectEnvironments()` from `detect.ts` and template getters from `templates.ts`, returns `IntegrationResult[]` using types from `types.ts`. Template generation flow: `detectEnvironments()` → `getTemplatesForEnvironment()` → `buildTemplate()` → `writeFileSync()`. All modules share `EnvironmentType`, `DetectedEnvironment`, `IntegrationTemplate`, `IntegrationResult` type contracts from `types.ts`.

## Platform Configuration

`PLATFORM_CONFIGS` in `templates.ts` maps each `Platform` to:
- `commandPrefix`: `/are-` (all platforms)
- `pathPrefix`: `.claude/skills/`, `.opencode/commands/`, `.gemini/commands/`
- `filenameSeparator`: `.` (Claude) or `-` (OpenCode, Gemini)
- `usesName`: `true` (Claude only) includes `name:` frontmatter field
- `versionFilePath`: `.claude/ARE-VERSION`, `.opencode/ARE-VERSION`, `.gemini/ARE-VERSION`
- `extraFrontmatter`: OpenCode adds `agent: build`

Claude templates output `SKILL.md` in subdirectories (`.claude/skills/are-{command}/SKILL.md`). OpenCode/Gemini use flat structure (`.opencode/commands/are-{command}.md`, `.gemini/commands/are-{command}.toml`).

## Behavioral Contracts

**Command execution pattern** (all long-running commands):
```bash
# 1. Display version from VERSION_FILE_PATH
# 2. Run npx agents-reverse-engineer@latest {command} with run_in_background: true
# 3. Poll .agents-reverse-engineer/progress.log every 10-15 seconds using Read tool with offset parameter
# 4. Check TaskOutput with block: false
# 5. Repeat until completion
```

**Command argument formats**:
- `generate`: `[path] [--dry-run] [--concurrency N] [--fail-fast] [--debug] [--trace]`
- `update`: `[path] [--uncommitted] [--dry-run] [--concurrency N] [--fail-fast] [--debug] [--trace]`
- `discover`: `[path] [--debug] [--trace]`
- `clean`: `[path] [--dry-run]`
- `specify`: `[path] [--dry-run] [--output <path>] [--multi-file] [--force] [--debug] [--trace]`
- `rebuild`: `[path] [--dry-run] [--output <path>] [--force] [--concurrency N] [--fail-fast] [--debug] [--trace]`

**Strict execution rules** (`discover`, `clean`): "VIOLATION IS FORBIDDEN" — run ONLY with user-provided arguments, NO added flags, ZERO flags if user omits arguments.

**Detection criteria**:
- Claude: `.claude/` directory OR `CLAUDE.md` file
- OpenCode: `.opencode/` directory
- Aider: `.aider.conf.yml` file OR `.aider/` directory
- Gemini: (not explicitly detected, supported via `options.environment`)

**Bundled hook resolution**: `getBundledHookPath(hookName)` resolves from `dist/integration/` up two levels to project root, then to `hooks/dist/{hookName}`.