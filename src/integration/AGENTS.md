<!-- Generated by agents-reverse-engineer -->

# src/integration/

Multi-platform AI assistant integration layer that detects installed coding assistants (Claude Code, OpenCode, Gemini, Aider), generates platform-specific command files and hooks, and manages installation lifecycle with skip-if-exists safety.

## Contents

### Environment Detection

**[detect.ts](./detect.ts)** — `detectEnvironments()` scans projectRoot for `.claude/` OR `CLAUDE.md` (Claude), `.opencode/` (OpenCode), `.aider.conf.yml` OR `.aider/` (Aider), returning `DetectedEnvironment[]`. `hasEnvironment()` predicate tests for specific `EnvironmentType`.

### Template Generation

**[templates.ts](./templates.ts)** — Exports `getClaudeTemplates()` (`.claude/skills/are-{command}/SKILL.md` with `name:` frontmatter), `getOpenCodeTemplates()` (`.opencode/commands/are-{command}.md` with `agent: build`), `getGeminiTemplates()` (`.gemini/commands/are-{command}.toml` with TOML format). `buildFrontmatter()` constructs platform-specific YAML headers, `buildGeminiToml()` generates TOML with triple-quoted prompts. COMMANDS constant defines seven commands (`generate`, `update`, `init`, `discover`, `clean`, `specify`, `help`) with `description`, `argumentHint`, and `content` fields. PLATFORM_CONFIGS maps `Platform` union to `PlatformConfig` objects specifying `commandPrefix`, `pathPrefix`, `filenameSeparator`, `extraFrontmatter`, and `usesName` flags.

### File Writing Orchestration

**[generate.ts](./generate.ts)** — `generateIntegrationFiles()` calls `detectEnvironments()` or targets specific `EnvironmentType`, retrieves templates via `getTemplatesForEnvironment()`, writes files unless they exist (accumulating `filesSkipped` when `force: false`), and for Claude environment copies bundled `are-session-end.js` from `hooks/dist/` via `readBundledHook()`. Returns `IntegrationResult[]` with `filesCreated` and `filesSkipped` arrays per environment.

### Type Definitions

**[types.ts](./types.ts)** — `EnvironmentType` union (`'claude' | 'opencode' | 'aider' | 'gemini'`), `DetectedEnvironment` interface (`type`, `configDir`, `detected`), `IntegrationTemplate` interface (`filename`, `path`, `content`), `IntegrationResult` interface (`environment`, `filesCreated`, `filesSkipped`).

## Data Flow

1. **Detection Phase**: `src/cli/init.ts` or `src/cli/generate.ts` calls `detectEnvironments()` to identify installed assistants
2. **Template Retrieval**: `generate.ts` maps each `EnvironmentType` to platform-specific templates via `getClaudeTemplates()`, `getOpenCodeTemplates()`, or `getGeminiTemplates()`
3. **Installation**: `generateIntegrationFiles()` writes templates to `.claude/skills/`, `.opencode/commands/`, or `.gemini/commands/`, skipping existing files unless `force: true`
4. **Hook Deployment**: For Claude, copies `hooks/dist/are-session-end.js` to `.claude/hooks/` for session cleanup

## Integration with CLI

Called by `src/cli/init.ts` during `are-init` command to install assistant-specific command files. Template paths match `src/installer/paths.ts` expectations for skill/command directory structures. All long-running commands (`generate`, `update`, `discover`, `specify`) embed identical progress monitoring pattern: remove stale `.agents-reverse-engineer/progress.log`, run command with `run_in_background: true`, poll via `tail -5` every 10-15 seconds, check `TaskOutput` with `block: false`, summarize on completion.

## Platform-Specific Adaptations

- **Claude Code**: Subdirectory structure (`.claude/skills/are-generate/SKILL.md`), frontmatter includes `name:` field, `COMMAND_PREFIX` resolves to `/are-`
- **OpenCode**: Flat structure (`.opencode/commands/are-generate.md`), frontmatter includes `agent: build`, dash separator for compound names
- **Gemini**: TOML format (`.gemini/commands/are-generate.toml`) with `description = "..."` and `prompt = """..."""` triple-quoted multiline strings
- **Aider**: Detection only; no template generation (`getTemplatesForEnvironment()` returns empty array)