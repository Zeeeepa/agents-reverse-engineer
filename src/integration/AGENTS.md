<!-- Generated by agents-reverse-engineer -->

# src/integration

**Platform-specific command file generation for AI coding assistants (Claude Code, OpenCode, Gemini CLI, Aider detection) with environment auto-detection, template instantiation, and idempotent file installation.**

## Contents

### Detection & Template Instantiation

**[detect.ts](./detect.ts)** — `detectEnvironments()` scans `projectRoot` for AI assistant markers (`.claude/` or `CLAUDE.md` for Claude Code, `.opencode/` for OpenCode, `.aider.conf.yml` or `.aider/` for Aider, no Gemini marker), returning `DetectedEnvironment[]` with `type: EnvironmentType`, `configDir: string`, and `detected: true`. `hasEnvironment()` convenience predicate tests specific environment presence. OR-condition logic allows multiple detection: Claude accepts directory OR file, Aider accepts config OR directory.

**[templates.ts](./templates.ts)** — Platform-specific template factories: `getClaudeTemplates()` generates `.claude/skills/are-{command}/SKILL.md` with `name:` frontmatter, `getOpenCodeTemplates()` generates `.opencode/commands/are-{command}.md` with `agent: build` frontmatter, `getGeminiTemplates()` generates `.gemini/commands/are-{command}.toml` with TOML `description` and triple-quoted `prompt`. Shared `COMMANDS` constant defines six ARE commands (`generate`, `update`, `init`, `discover`, `clean`, `specify`, `help`) with description, argumentHint, and execution instructions. Long-running commands (`generate`, `update`, `discover`, `specify`) embed identical monitoring protocol: `rm -f progress.log` → background spawn → 10-15s `tail -5` polling → `TaskOutput` completion check. `buildTemplate()` applies `PLATFORM_CONFIGS` transformation (`.claude/skills/` vs `.opencode/commands/` vs `.gemini/commands/`, frontmatter rules, `COMMAND_PREFIX` placeholder replacement). `buildFrontmatter()` constructs YAML with `description`, optional `name` (Claude), optional `extraFrontmatter` (OpenCode). `buildGeminiToml()` constructs TOML with triple-quote escaping.

**[generate.ts](./generate.ts)** — `generateIntegrationFiles(projectRoot, options)` orchestrates installation: calls `detectEnvironments()` when `options.environment` undefined, maps `EnvironmentType` to config dirs via `configDirMap`, retrieves templates via `getTemplatesForEnvironment()` switch delegating to `getClaudeTemplates()` / `getOpenCodeTemplates()` / `getGeminiTemplates()` (Aider returns empty array), writes files via `writeFileSync()` unless `options.dryRun` or (`existsSync()` and not `options.force`), accumulates `filesCreated` / `filesSkipped` into `IntegrationResult[]`. Special Claude handling: reads bundled `are-session-end.js` via `readBundledHook()` from `hooks/dist/` (resolved via `import.meta.url` → `fileURLToPath()` → two levels up), writes to `.claude/hooks/are-session-end.js`. `ensureDir()` ensures parent directory existence via `mkdirSync({ recursive: true })`. `GenerateOptions` includes `dryRun`, `force`, `environment` for targeted generation bypassing detection.

**[types.ts](./types.ts)** — Defines `EnvironmentType` (`'claude' | 'opencode' | 'aider' | 'gemini'`), `DetectedEnvironment` (detection result with `type`, `configDir`, `detected`), `IntegrationTemplate` (template artifact with `filename`, `path`, `content`), `IntegrationResult` (outcome tracking with `environment`, `filesCreated`, `filesSkipped`). Data flow: detection → template instantiation → installation → result accumulation.

## Architecture

### Environment Detection Strategy

OR-condition marker checks enable flexible deployment: Claude Code installed via `npx` may create only `CLAUDE.md` without `.claude/` directory, while full installations create both. Aider tolerates config-only or directory-only setups. OpenCode requires directory presence. Gemini templates generate without detection (manual installation). Multiple environments detected concurrently for polyglot assistant support.

### Template Platform Variations

| Platform | Path Pattern | Format | Frontmatter |
|----------|-------------|--------|-------------|
| Claude Code | `.claude/skills/are-{cmd}/SKILL.md` | Markdown | `name: are-{cmd}`, `description` |
| OpenCode | `.opencode/commands/are-{cmd}.md` | Markdown | `agent: build`, `description` |
| Gemini CLI | `.gemini/commands/are-{cmd}.toml` | TOML | `description`, `prompt` (triple-quoted) |
| Aider | None | N/A | No templates generated (detection only) |

### Idempotent Installation

`filesSkipped` array prevents overwrites of user-modified commands during repeated `are init` invocations. `force: true` option enables unconditional regeneration for version upgrades or corruption recovery. `dryRun` mode previews changes without filesystem writes, used by installer preview mode (`--dry-run` flag).

### Hook Bundling Strategy

Claude session hooks (`are-session-end.js`) bundled in `hooks/dist/` during `npm run build:hooks` (see `scripts/build-hooks.js`). `generate.ts` reads via `readBundledHook()` and copies to project-local `.claude/hooks/` alongside command files. Ensures hook deployment without separate installation step. Bundled path resolution via `import.meta.url` navigates from `dist/integration/generate.js` → project root → `hooks/dist/`.

## Command Content Patterns

### Background Execution Protocol

Long-running commands (`generate`, `update`, `discover`, `specify`) share monitoring template:
1. Pre-clean stale logs: `rm -f .agents-reverse-engineer/progress.log`
2. Spawn process with `run_in_background: true`
3. Poll `tail -5 .agents-reverse-engineer/progress.log` every 10-15 seconds
4. Non-blocking completion check via `TaskOutput` with `block: false`
5. Summarize results on completion

### Flag Passthrough Enforcement

`discover` and `clean` commands enforce strict zero-flag defaults with explicit warnings: "DO NOT add ANY flags the user did not explicitly type". Guards against assistant over-optimization adding unsolicited `--dry-run` or `--concurrency` flags. `generate` / `update` / `specify` document available flags but omit enforcement language.

### Help Command Structure

`help` command wraps output in `<objective>` and `<reference>` XML tags, formats command reference table with CLI examples, embeds configuration schema excerpt, includes workflow examples, provides resource links. `COMMAND_PREFIX` placeholder replaced per platform (`/are-` for all current platforms).

## Integration with Installer

Called by `src/installer/install.ts` during `npx agents-reverse-engineer --runtime claude` invocations. Installer determines `EnvironmentType` from runtime flag, constructs target directory paths (global `~/.claude` vs local `.claude`), invokes `generateIntegrationFiles()` with `force: true` when user confirms overwrite prompts. Returns `IntegrationResult[]` driving success/skip console output with file counts and paths.