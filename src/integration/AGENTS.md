<!-- Generated by agents-reverse-engineer -->

# src/integration/

**Platform-specific integration file generator for AI coding assistants: detects environment configuration directories (`.claude/`, `.opencode/`, `.gemini/`, `.aider/`), synthesizes command file templates with frontmatter and execution instructions, writes skills/commands/hooks to detected environments, and bundles session lifecycle hooks for automatic documentation refresh.**

## Contents

### Core Orchestration

**[detect.ts](./detect.ts)** — Probes `projectRoot` for AI assistant configuration artifacts via `existsSync()` checks. `detectEnvironments()` returns `DetectedEnvironment[]` with `type`/`configDir`/`detected` for Claude Code (`.claude/` OR `CLAUDE.md`), OpenCode (`.opencode/`), Aider (`.aider.conf.yml` OR `.aider/`). `hasEnvironment()` wraps detection with `Array.some()` predicate filtering by `EnvironmentType`.

**[generate.ts](./generate.ts)** — Writes platform-specific command files and hooks via `generateIntegrationFiles()`. Calls `detectEnvironments()` or resolves single environment from `GenerateOptions.environment`. Maps environments to templates via `getTemplatesForEnvironment()` dispatcher (`getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()`). Writes template content to `path.join(projectRoot, template.path)` with skip logic (`existsSync() && !force`) and directory creation via `ensureDir()`. Appends Claude session-end hook via `readBundledHook('are-session-end.js')` sourced from `hooks/dist/` distribution directory. Returns `IntegrationResult[]` with `filesCreated`/`filesSkipped` per environment.

**[templates.ts](./templates.ts)** — Constructs platform command templates via `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()`. `COMMANDS` constant defines six commands (`generate`, `update`, `init`, `discover`, `clean`, `specify`, `help`) with `description`, `argumentHint`, `content`. `buildTemplate()` dispatches to `buildGeminiToml()` for TOML format (triple-quoted `prompt` field) or constructs markdown via `buildFrontmatter()` for Claude/OpenCode. Claude uses nested directory structure (`are-{command}/SKILL.md` with `name:` frontmatter), OpenCode uses flat filenames with `agent: build` frontmatter, Gemini uses `.toml` files. Long-running commands (`generate`, `update`, `discover`, `specify`) share background execution pattern: remove stale `progress.log`, spawn with `run_in_background: true`, poll via `tail -5` every 10-15s, check completion via `TaskOutput`.

**[types.ts](./types.ts)** — Type contracts for integration system. `EnvironmentType` union (`'claude' | 'opencode' | 'aider' | 'gemini'`), `DetectedEnvironment` interface (`type`/`configDir`/`detected`), `IntegrationTemplate` interface (`filename`/`path`/`content`), `IntegrationResult` interface (`environment`/`filesCreated`/`filesSkipped`). Used by `detect.ts` return types, `generate.ts` orchestration logic, and `src/installer/` module for npx-based command/hook installation.

## Architecture

### Environment Detection Strategy

`detect.ts` uses filesystem probing with multiple detection paths per environment supporting different installation patterns. Claude Code detection checks both `.claude/` directory (for commands/hooks) and `CLAUDE.md` standalone file (for config-less integration). Accumulates matches into mutable `environments: DetectedEnvironment[]` array with explicit `type` tagging. Detection results feed `generate.ts` for conditional file generation and `src/installer/` for installation workflow.

### Template Generation Pipeline

`templates.ts` defines `COMMANDS` constant with execution instructions containing `COMMAND_PREFIX` placeholders replaced per-platform. `PLATFORM_CONFIGS` maps `Platform` to `PlatformConfig` with `commandPrefix` (e.g., `/are-`), `pathPrefix` (e.g., `.claude/skills/`), `filenameSeparator`, optional `extraFrontmatter`, and `usesName` boolean controlling frontmatter `name:` field inclusion. `getTemplatesForPlatform()` maps `Object.entries(COMMANDS)` to `buildTemplate()` calls, producing `IntegrationTemplate[]` consumed by `generate.ts` file writers.

### File Generation Workflow

`generate.ts` iterates detected environments calling `getTemplatesForEnvironment()` to retrieve platform templates. Writes template content to `path.join(projectRoot, template.path)` respecting `force`/`dryRun` flags. Skip logic: `existsSync(fullPath) && !force` → add to `filesSkipped`, skip write. Write logic: `!dryRun` → call `ensureDir()` then `writeFileSync()`. Special handling for Claude: appends hook file `.claude/hooks/are-session-end.js` via `readBundledHook()` sourced from `hooks/dist/` at build time.

### Hook Bundling System

`generate.ts` resolves bundled hook file paths via `getBundledHookPath()` navigating `../.../hooks/dist/` from `dist/integration/` using `import.meta.url` and `fileURLToPath()`. `readBundledHook()` reads hook content via `readFileSync()` with existence check throwing `Error` if `!existsSync()`. Bundled at build time via `scripts/build-hooks.js` copying `hooks/` to `hooks/dist/`. Hook registration enables session-end auto-update workflow (spawns `npx agents-reverse-engineer@latest update --quiet` when `git status --porcelain` detects changes).

## Platform-Specific Formats

**Claude Code:** Nested directory structure `.claude/skills/are-{command}/SKILL.md` with YAML frontmatter (`name: /are-{command}`, `description:`). Session-end hook at `.claude/hooks/are-session-end.js`.

**OpenCode:** Flat filenames `.opencode/commands/are-{command}.md` with YAML frontmatter (`agent: build`, `description:`).

**Gemini:** TOML format `.gemini/commands/are-{command}.toml` with double-quoted `description` and triple-quoted multiline `prompt` fields following https://geminicli.com/docs/cli/custom-commands/ specification.

**Aider:** Detection only via `.aider.conf.yml` or `.aider/` directory. No template generation (manual integration required, returns empty array from `getTemplatesForEnvironment()`).

## Command Execution Patterns

Long-running commands (`generate`, `update`, `discover`, `specify`) share identical background execution workflow:
1. Remove stale `progress.log` via Bash
2. Spawn `npx agents-reverse-engineer@latest {command}` with `run_in_background: true`
3. Poll via `tail -5 .agents-reverse-engineer/progress.log` every 10-15s
4. Check completion via `TaskOutput` with `block: false`
5. Summarize final output from completed task

`clean` command enforces strict argument preservation via `STRICT RULES` section forbidding flag injection beyond `$ARGUMENTS` placeholder. `help` command uses `COMMAND_PREFIX` placeholder replacement to generate platform-specific reference documentation showing command syntax, option tables, workflow examples, and installation instructions.

## Integration with ARE Workflow

Templates reference ARE three-phase pipeline (discovery → file analysis → directory/root synthesis), explain `.sum` file structure with YAML frontmatter (`content_hash`, `purpose`, `public_interface`, `dependencies`, `patterns`), document CLI flags (`--dry-run`, `--concurrency`, `--fail-fast`, `--debug`, `--trace`), and map skill commands to `npx agents-reverse-engineer@latest` CLI invocations consumed by `src/installer/operations.ts` during IDE integration setup.

## Dependencies

**Node.js Built-ins:**
- `node:fs` — `existsSync`, `mkdirSync`, `writeFileSync`, `readFileSync` for file I/O
- `node:path` — Path manipulation via `dirname`, `join`
- `node:url` — `fileURLToPath` converts ESM `import.meta.url` to filesystem path

**Internal Modules:**
- `src/installer/` — Consumes `DetectedEnvironment` and `IntegrationResult` for npx-based command/hook installation workflows
- `scripts/build-hooks.js` — Build-time hook bundling copying `hooks/` to `hooks/dist/` for distribution