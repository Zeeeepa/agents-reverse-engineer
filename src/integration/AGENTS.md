<!-- Generated by agents-reverse-engineer -->

# src/integration

Multi-platform AI assistant integration layer providing environment detection, template generation, and command file provisioning for Claude Code, OpenCode, Gemini CLI, and Aider.

## Contents

### Core Modules

[detect.ts](./detect.ts) — Environment detection via filesystem checks for `.claude/`, `.opencode/`, `.aider/`, `.gemini/` directories and configuration files; exports `detectEnvironments()` and `hasEnvironment()`.

[generate.ts](./generate.ts) — Integration file orchestrator with skip-if-exists semantics; exports `generateIntegrationFiles()` which writes command templates and hooks (including `.claude/hooks/are-session-end.js` via `readBundledHook()`) for detected or specified environments.

[templates.ts](./templates.ts) — Platform-specific template generators (`getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()`) producing SKILL.md frontmatter for Claude, agent-annotated markdown for OpenCode, and TOML documents for Gemini; embeds eight ARE commands (`generate`, `update`, `init`, `discover`, `clean`, `specify`, `rebuild`, `help`) with `<execution>` blocks and placeholder substitution (`COMMAND_PREFIX`, `VERSION_FILE_PATH`).

[types.ts](./types.ts) — Type definitions: `EnvironmentType` union (`'claude' | 'opencode' | 'aider' | 'gemini'`), `DetectedEnvironment` (detection result), `IntegrationTemplate` (filename/path/content tuple), `IntegrationResult` (filesCreated/filesSkipped report).

## Architecture

**Three-Phase Installation Flow:**
1. **Detection**: `detectEnvironments()` scans project root for AI assistant configuration artifacts (`.claude/`, `CLAUDE.md`, `.opencode/`, `.aider.conf.yml`, `.aider/`)
2. **Template Resolution**: `getTemplatesForEnvironment()` maps `EnvironmentType` → platform-specific template generator → `IntegrationTemplate[]` array
3. **Provisioning**: `generateIntegrationFiles()` writes templates with `ensureDir()` + `writeFileSync()`, skipping existing files unless `force: true`

**Platform Configuration Table:**
```typescript
const PLATFORM_CONFIGS = {
  claude: { commandPrefix: '/are-', pathPrefix: '.claude/skills/', filenameSeparator: '.', usesName: true, versionFilePath: '.claude/ARE-VERSION' },
  opencode: { commandPrefix: '/are-', pathPrefix: '.opencode/commands/', filenameSeparator: '-', extraFrontmatter: 'agent: build', versionFilePath: '.opencode/ARE-VERSION' },
  gemini: { commandPrefix: '/are-', pathPrefix: '.gemini/commands/', filenameSeparator: '-', versionFilePath: '.gemini/ARE-VERSION' }
}
```

## File Relationships

- `detect.ts` provides environment discovery consumed by `generate.ts` auto-detection path
- `templates.ts` supplies content to `generate.ts` via `getTemplatesForEnvironment()` dispatcher
- `types.ts` defines contracts shared across all three implementation modules
- `generate.ts` reads bundled hooks from `hooks/dist/` via `getBundledHookPath()` traversal (ESM `import.meta.url` → two levels up → `hooks/dist/`)

## Behavioral Contracts

### Detection Patterns
```typescript
// Claude Code detection
existsSync(join(projectRoot, '.claude')) || existsSync(join(projectRoot, 'CLAUDE.md'))

// OpenCode detection
existsSync(join(projectRoot, '.opencode'))

// Aider detection
existsSync(join(projectRoot, '.aider.conf.yml')) || existsSync(join(projectRoot, '.aider'))
```

### Progress Monitoring (embedded in templates.ts command content)
```markdown
Wait ~15 seconds (use `sleep 15` in Bash), then use the **Read** tool to read `.agents-reverse-engineer/progress.log` (use the `offset` parameter to read only the last ~20 lines for long files)
```

### Version Display (embedded in templates.ts command content)
```markdown
Read `VERSION_FILE_PATH` and show the user: `agents-reverse-engineer vX.Y.Z`
```

### Strict Execution Rule (embedded in templates.ts `discover`/`clean` content)
```markdown
## STRICT RULES - VIOLATION IS FORBIDDEN

1. Run ONLY this exact command: `npx agents-reverse-engineer@latest discover $ARGUMENTS`
2. DO NOT add ANY flags the user did not explicitly type
3. If user typed nothing after `COMMAND_PREFIXdiscover`, run with ZERO flags
```

### TaskOutput Polling (embedded in templates.ts background task monitoring)
```markdown
Check whether the background task has completed using `TaskOutput` with `block: false`
```

## Integration Points

Consumed by `src/installer/operations.ts` during `installIntegrationFiles()` to provision AI assistant command files. Templates reference bundled hooks from `hooks/dist/are-session-end.js` (built via `scripts/build-hooks.js`). Detection logic supports environment-conditional behavior in installer prompts (`src/installer/prompts.ts`).