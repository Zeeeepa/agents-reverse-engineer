<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/integration

Detects AI coding assistant environments (Claude Code, OpenCode, Aider, Gemini) and generates environment-specific integration command templates for ARE (agents-reverse-engineer) CLI execution.

## Contents

**Detection & Environment Discovery**

- [detect.ts](./detect.ts) — `detectEnvironments(projectRoot)` scans for `.claude/`, `.opencode/`, `.aider/`, `.gemini/` config directories and returns `DetectedEnvironment[]` array; `hasEnvironment(projectRoot, type)` checks for specific `EnvironmentType`.

**Template Generation**

- [templates.ts](./templates.ts) — `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` return `IntegrationTemplate[]` with platform-specific file paths and markdown/TOML frontmatter; `buildTemplate(platform, commandName, command)` assembles templates with placeholder substitution (`COMMAND_PREFIX`, `VERSION_FILE_PATH`, `BACKEND_FLAG`).

**Integration Orchestration**

- [generate.ts](./generate.ts) — `generateIntegrationFiles(projectRoot, options)` creates environment-specific command files and Claude session-end hooks; calls `detectEnvironments()`, fetches templates via `getTemplatesForEnvironment(type)`, writes files with `mkdirSync({ recursive: true })`, and copies bundled hook from `hooks/dist/are-session-end.js` for Claude environments.

**Type System**

- [types.ts](./types.ts) — Exports `EnvironmentType` (`'claude' | 'opencode' | 'aider' | 'gemini'`), `DetectedEnvironment`, `IntegrationTemplate` (`filename`, `path`, `content`), `IntegrationResult` (`filesCreated`, `filesSkipped` per environment).

## Environment Detection

Claude Code: `.claude/` directory OR `CLAUDE.md` file.

OpenCode: `.opencode/` directory.

Aider: `.aider.conf.yml` file OR `.aider/` directory.

Gemini: `.gemini/` directory (inferred from template generation).

## File Generation Workflow

1. `detectEnvironments(projectRoot)` returns array of detected environments
2. For each environment, `getTemplatesForEnvironment(type)` retrieves platform-specific templates
3. Files are written to environment-specific config paths unless they exist (skip unless `force: true` in `GenerateOptions`)
4. For Claude, additionally writes `.claude/hooks/are-session-end.js` from bundled hook (`readBundledHook('are-session-end.js')`)
5. Returns `IntegrationResult[]` with `filesCreated` and `filesSkipped` per environment

## Platform Configuration & Path Structure

| Platform | Config Dir | Command Path | File Format |
|----------|-----------|---|---|
| Claude Code | `.claude/` | `.claude/skills/are-{command}/SKILL.md` | Markdown w/ YAML frontmatter |
| OpenCode | `.opencode/` | `.opencode/commands/are-{command}.md` | Markdown w/ YAML frontmatter |
| Gemini | `.gemini/` | `.gemini/commands/are-{command}.toml` | TOML (no YAML) |
| Aider | `.aider/` | (detection only; no template generation) | N/A |

## Behavioral Contracts — ARE Command Execution Workflows

**generate / update / specify / rebuild:**
1. Display version from `VERSION_FILE_PATH` (platform-specific: `.claude/ARE-VERSION`, `.opencode/ARE-VERSION`, `.gemini/ARE-VERSION`)
2. Delete stale `.agents-reverse-engineer/progress.log`
3. Spawn background task: `npx are {command} --backend {platform} $ARGUMENTS` with `run_in_background: true`
4. Poll progress.log every 15 seconds; read last ~20 lines; continue until completion (tolerates missing log during startup)
5. Summarize full background task output on completion

**discover:**
- Run ONLY `npx are discover $ARGUMENTS` (no extra flags)
- Poll progress.log (~10s wait), read `GENERATION-PLAN.md` + `config.yaml`
- Classify files: test/spec (`*.test.*`, `*.spec.*`, `__tests__/**`), CI/CD (`.github/workflows/*.yml`, `.gitlab-ci.yml`), tool configs (`.eslintrc*`, `tsconfig*.json`, `jest.config.*`), migrations (`migrations/`, `*.migration.*`), fixtures (`__snapshots__/**`, `*.fixture.*`), type declarations (`*.d.ts`), Docker/infra (`Dockerfile*`, `k8s/**`)
- Present only categories with matches; skip if already in `config.yaml` exclude list
- Suggest exclusions via `AskUserQuestion` with `multiSelect: true`; edit `config.yaml` with accepted glob patterns

**clean:**
- Run ONLY `npx are clean $ARGUMENTS` (no extra flags)

## Command Registry

`COMMANDS` object defines six commands: `generate`, `update`, `init`, `discover`, `clean`, `specify`, `rebuild`, `help` — each with `description`, `argumentHint`, and `content` (instruction template with placeholder substitution).

## Placeholder Substitution

- `COMMAND_PREFIX` → `/are-` (all platforms)
- `VERSION_FILE_PATH` → platform-specific path
- `BACKEND_FLAG` → `--backend {claude|opencode|gemini}`

## Critical Dependencies

- `detectEnvironments()` from [detect.ts](./detect.ts) — returns array of detected environments with config dirs
- `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` from [templates.ts](./templates.ts) — environment-specific template arrays
- `readBundledHook('are-session-end.js')` — reads pre-built hook from `hooks/dist/`; validates existence before reading
- `existsSync()` from `node:fs` — filesystem checks
- `mkdirSync({ recursive: true })` — creates parent directories