<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/integration

The `src/integration` directory handles detection and file generation for AI coding assistant environments (Claude Code, Codex, OpenCode, Gemini CLI, Aider), enabling automatic installation of ARE command definitions into assistant-specific config directories.

## Contents

- [`detect.ts`](./detect.ts): Exports `detectEnvironments()` (scans for `.claude/`, `CLAUDE.md`, `.opencode/`, `.aider.conf.yml`, `.aider/`, `.gemini/`, returns `DetectedEnvironment[]`) and `hasEnvironment()` (checks for specific `EnvironmentType`).

- [`generate.ts`](./generate.ts): Exports `generateIntegrationFiles()` (detects environments, retrieves templates via `getTemplatesForEnvironment()`, writes command files to `.claude/skills/`, `.opencode/commands/`, `.gemini/commands/`, bundles hook `are-session-end.js` to `.claude/hooks/`, returns `IntegrationResult[]`) and `GenerateOptions` interface (`dryRun`, `force`, `environment` override).

- [`templates.ts`](./templates.ts): Exports `getClaudeTemplates()`, `getCodexTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` (return platform-specific `IntegrationTemplate[]` for seven ARE commands: `generate`, `update`, `init`, `discover`, `clean`, `specify`, `rebuild`). Defines `COMMANDS` object (command metadata), `PLATFORM_CONFIGS` (path/prefix mappings), `buildFrontmatter()`, `buildGeminiToml()`, `buildTemplate()` (constructs templates with placeholders `COMMAND_PREFIX`, `VERSION_FILE_PATH`, `BACKEND_FLAG`).

- [`types.ts`](./types.ts): Exports `EnvironmentType` (`'claude' | 'opencode' | 'aider' | 'gemini'`), `DetectedEnvironment` (type, configDir, detected flag), `IntegrationTemplate` (filename, path, content), `IntegrationResult` (environment, filesCreated, filesSkipped).

## Architecture

Detection layer (`detect.ts`) identifies assistant environments by filesystem markers. Generation layer (`generate.ts`) orchestrates template retrieval and file writes, delegating to platform-specific template builders (`templates.ts`). Templates embed polling workflows (Read `.agents-reverse-engineer/progress.log` with `offset` param every ~15s, TaskOutput with `block: false`), version display (`VERSION_FILE_PATH`), and command invocation patterns (`npx are {command} BACKEND_FLAG $ARGUMENTS`).

## Integration Workflow

`generateIntegrationFiles()` calls `detectEnvironments()` (or uses `options.environment` override), invokes platform-specific template getters (`getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()`), writes files to assistant config dirs, skips existing unless `options.force=true`, performs dry-run if `options.dryRun=true`, and for `claude` environment copies bundled hook `are-session-end.js` to `.claude/hooks/`.

## Command Definitions

`COMMANDS` object defines seven ARE commands with `description`, `argumentHint`, `content` fields. `generate` runs two-phase pipeline (concurrent `.sum` file analysis, sequential `AGENTS.md` post-order traversal), polls `progress.log` every ~15s, supports `--dry-run`, `--eval`, `--concurrency N`, `--fail-fast`, `--debug`, `--trace`. `update` regenerates docs for changed files, identical polling workflow, supports `--uncommitted`, same options. `init` creates `.agents-reverse-engineer/config.yaml`. `discover` generates `GENERATION-PLAN.md`, polls every ~10s, post-completion classifies files into categories (test/spec, CI/CD, tool configs, migrations, fixtures, type declarations, Docker/infra), uses `AskUserQuestion` with `multiSelect: true`, appends accepted globs to `exclude.patterns`. `clean` removes `.agents-reverse-engineer/GENERATION-PLAN.md`, all `*.sum` files, all `AGENTS.md`/`AGENTS.*.md`, `CLAUDE.md` pointers, supports `--dry-run`. `specify` synthesizes `AGENTS.md` into `specs/SPEC.md`, auto-runs generate if no `AGENTS.md` exist, polls every ~15s, supports `--dry-run`, `--output <path>`, `--multi-file`, `--force`, `--debug`, `--trace`. `rebuild` reconstructs projects from `specs/` via ordered rebuild units, checkpoint-based session continuity, polls every ~15s, supports `--dry-run`, `--output <path>`, `--force`, `--concurrency N`, `--fail-fast`, `--debug`, `--trace`, exit codes 0 (success), 1 (partial failure), 2 (total failure).

## Platform Configuration

`PLATFORM_CONFIGS` maps `Platform` type to `PlatformConfig` objects. `claude`: `commandPrefix: '/are-'`, `pathPrefix: '.claude/skills/'`, `filenameSeparator: '.'`, `usesName: true`, `versionFilePath: '.claude/ARE-VERSION'`. `codex`: `commandPrefix: '/are-'`, `pathPrefix: '.agents/skills/'`, `filenameSeparator: '.'`, `usesName: true`, `versionFilePath: '.agents/ARE-VERSION'`. `opencode`: `commandPrefix: '/are-'`, `pathPrefix: '.opencode/commands/'`, `filenameSeparator: '-'`, `extraFrontmatter: 'agent: build'`, `usesName: false`, `versionFilePath: '.opencode/ARE-VERSION'`. `gemini`: `commandPrefix: '/are-'`, `pathPrefix: '.gemini/commands/'`, `filenameSeparator: '-'`, `usesName: false`, `versionFilePath: '.gemini/ARE-VERSION'`.

## Template Construction

`buildTemplate()` constructs platform-specific templates with path formatting (Claude/Codex: `{pathPrefix}are-{command}/SKILL.md`, OpenCode: `{pathPrefix}are-{command}.md`, Gemini: `{pathPrefix}are-{command}.toml`), `buildFrontmatter()` generates YAML frontmatter with `name: are-{command}` (if `usesName`), `description`, `argument-hint` (Codex only), optional `extraFrontmatter`, `buildGeminiToml()` generates TOML with `description = "..."`, `prompt = """..."""` triple-quoted multiline string, placeholder replacements (`COMMAND_PREFIX`, `VERSION_FILE_PATH`, `BACKEND_FLAG`).

## Behavioral Contracts

File paths: `.claude/skills/are-{command}/SKILL.md`, `.agents/skills/are-{command}/SKILL.md`, `.opencode/commands/are-{command}.md`, `.gemini/commands/are-{command}.toml`.

Progress log polling: `sleep 15`, Read `.agents-reverse-engineer/progress.log` with `offset` param for last ~20 lines, TaskOutput with `block: false`, repeat until completion.

Command execution pattern: `npx are {command} BACKEND_FLAG $ARGUMENTS`.

Version display pattern: Read `VERSION_FILE_PATH`, show `agents-reverse-engineer vX.Y.Z`.

YAML frontmatter fields for `.sum` files: `file_type`, `generated_at`, `content_hash`, `purpose`, `public_interface`, `dependencies`, `patterns`, `related_files`.

Discover file classification globs: test/spec `**/*.test.*` `**/*.spec.*` `**/__tests__/**` `**/__mocks__/**` `**/*.stories.*` `**/*.story.*`, CI/CD `.github/workflows/*.yml` `.gitlab-ci.yml` `Jenkinsfile` `.circleci/**` `.travis.yml`, tool configs `.eslintrc*` `.prettierrc*` `jest.config.*` `.editorconfig` `babel.config.*` `webpack.config.*` `vite.config.*` `rollup.config.*` `tsconfig*.json` `.lintstagedrc*` `.huskyrc*` `.stylelintrc*` `commitlint.config.*`, migrations `migrations/` `*.migration.*`, fixtures `__snapshots__/**` `*.fixture.*` `fixtures/**` `test-data/**` `testdata/**`, type declarations `*.d.ts`, Docker/infra `Dockerfile*` `docker-compose*` `*.Dockerfile` `k8s/**` `terraform/**` `helm/**`.

Rebuild delimiters: `===FILE:===`.

Config file path: `.agents-reverse-engineer/config.yaml`.

Generation plan path: `.agents-reverse-engineer/GENERATION-PLAN.md`.

Progress log path: `.agents-reverse-engineer/progress.log`.

Default output paths: `specs/SPEC.md` (specify), `rebuild/` (rebuild).

Exit codes: 0 (success), 1 (partial failure), 2 (total failure) for rebuild.

Gemini TOML format: `description = "..."`, `prompt = """..."""`, comments `# Arguments: ...`.

## Workflow Rules

Strict command invocation for discover/clean: run ONLY `npx are {command} $ARGUMENTS` with ZERO flags if user typed nothing after `COMMAND_PREFIX{command}`. DO NOT add ANY flags user did not explicitly type.

Polling must continue even if `progress.log` doesn't exist yet (command takes a few seconds to start writing).

Help command objective: display ONLY reference content, NO project-specific analysis, git status, file context, next-step suggestions, or commentary beyond reference.

Discover post-processing: skip categories with zero matches, skip patterns already in `config.yaml` exclude list, present summary table (category, file count, examples, proposed globs), use `AskUserQuestion` with `multiSelect: true`, append accepted patterns to `exclude.patterns` array via Edit tool.