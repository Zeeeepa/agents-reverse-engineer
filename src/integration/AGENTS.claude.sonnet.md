<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/integration

Integration layer for installing agents-reverse-engineer into AI coding assistant runtimes (Claude Code, OpenCode, Gemini CLI, Aider) via environment detection, command template generation, and hook deployment.

## Contents

- [detect.ts](./detect.ts): `detectEnvironments(projectRoot)` scans for `.claude/`, `.opencode/`, `.gemini/`, `.aider/` directories and `CLAUDE.md`/`.aider.conf.yml` marker files, returns `DetectedEnvironment[]` with `type`/`configDir`/`detected` fields. `hasEnvironment(projectRoot, type)` delegates to `detectEnvironments`, filters by `EnvironmentType`.
- [generate.ts](./generate.ts): `generateIntegrationFiles(projectRoot, options?)` orchestrates installation: invokes `detectEnvironments()` (or uses `options.environment` override), retrieves templates via `getTemplatesForEnvironment()`, writes files with `ensureDir()`+`writeFileSync()`, respects `options.force`/`dryRun`, copies bundled `are-session-end.js` hook to `.claude/hooks/` for Claude environments, returns `IntegrationResult[]` with `filesCreated`/`filesSkipped` arrays. `getBundledHookPath(hookName)` resolves hooks from `{projectRoot}/hooks/dist/`.
- [templates.ts](./templates.ts): Exports `getClaudeTemplates()`/`getCodexTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()` returning `IntegrationTemplate[]` arrays with command file paths/content. `COMMANDS` object defines 8 command templates (`generate`, `update`, `init`, `discover`, `clean`, `specify`, `rebuild`, `dashboard`, `help`) with descriptions, argument hints, execution blocks. `PLATFORM_CONFIGS` maps `EnvironmentType` to `commandPrefix`, `pathPrefix`, `versionFilePath`, `ccusageHint`. `buildFrontmatter(platform, commandName, description, argumentHint?)` constructs YAML metadata. `buildGeminiToml(commandName, command)` produces TOML format with triple-quoted prompts. Placeholder substitution replaces `COMMAND_PREFIX`/`VERSION_FILE_PATH`/`BACKEND_FLAG`/`CCUSAGE_HINT` before output.
- [types.ts](./types.ts): Defines `EnvironmentType` union (`'claude'|'opencode'|'aider'|'gemini'`), `DetectedEnvironment` interface (`type`, `configDir`, `detected`), `IntegrationTemplate` interface (`filename`, `path`, `content`), `IntegrationResult` interface (`environment`, `filesCreated`, `filesSkipped`).

## File Naming Conventions

Claude/Codex use skill-directory pattern: `.claude/skills/are-{command}/SKILL.md`, `.agents/skills/are-{command}/SKILL.md`. OpenCode uses flat markdown: `.opencode/commands/are-{command}.md`. Gemini uses flat TOML: `.gemini/commands/are-{command}.toml`. Determined by `platform` argument in `buildTemplate()`.

## Command Template Structure

Command content includes `<execution>` blocks with: version display via Read on `VERSION_FILE_PATH`, `rm -f .agents-reverse-engineer/progress.log`, background command invocation with `run_in_background: true`, progress polling loop (`sleep 15`, Read progress.log with offset for tail behavior, TaskOutput `block: false`, repeat until completion), completion summary from background output. `discover` command adds category-based exclusion via `AskUserQuestion` with `multiSelect: true` (test/CI/tool-config/migration/fixture/type-declaration/docker patterns), edits config.yaml to append selected patterns. `help` command outputs markdown reference with `COMMAND_PREFIX` placeholders, CLI install syntax (`npx agents-reverse-engineer install --runtime <name> -g/-l`), artifact format descriptions.

## Platform Configurations

`PLATFORM_CONFIGS` entries:
- `claude`: `commandPrefix: '/are-'`, `pathPrefix: '.claude/skills/'`, `versionFilePath: '.claude/ARE-VERSION'`, `ccusageHint: 'npx ccusage@latest (https://github.com/ryoppippi/ccusage)'`, `usesName: true`
- `codex`: `commandPrefix: '/are-'`, `pathPrefix: '.agents/skills/'`, `versionFilePath: '.agents/ARE-VERSION'`, `ccusageHint: 'npx @ccusage/codex@latest (https://github.com/ryoppippi/ccusage)'`, `usesName: true`
- `opencode`: `commandPrefix: '/are-'`, `pathPrefix: '.opencode/commands/'`, `filenameSeparator: '-'`, `versionFilePath: '.opencode/ARE-VERSION'`, `ccusageHint: 'npx @ccusage/opencode@latest (https://github.com/ryoppippi/ccusage)'`, `extraFrontmatter: 'agent: build'`, `usesName: false`
- `gemini`: `commandPrefix: '/are-'`, `pathPrefix: '.gemini/commands/'`, `filenameSeparator: '-'`, `versionFilePath: '.gemini/ARE-VERSION'`, `ccusageHint: 'npx ccusage@latest (https://github.com/ryoppippi/ccusage)'`, `usesName: false`

## Behavioral Contracts

**Environment Detection Patterns**:
- Claude: `{projectRoot}/.claude/` directory OR `{projectRoot}/CLAUDE.md` file
- OpenCode: `{projectRoot}/.opencode/` directory
- Gemini: `{projectRoot}/.gemini/` directory
- Aider: `{projectRoot}/.aider.conf.yml` file OR `{projectRoot}/.aider/` directory

**Hook Deployment Path**: Bundled hooks resolved at `{projectRoot}/hooks/dist/{hookName}`, copied to `.claude/hooks/are-session-end.js` when `environment === 'claude'`.

**Frontmatter Structure**:
- Claude/Codex: `---\nname: are-{command}\ndescription: {description}\nargument-hint: {hint}\n---` (argument-hint only for Codex)
- OpenCode: `---\ndescription: {description}\nagent: build\n---`
- Gemini TOML: `description = "{description}"\n# Arguments: {hint}\nprompt = """..."""`

**Placeholder Substitutions** (applied before file write):
- `COMMAND_PREFIX` → `/are-` (all platforms)
- `VERSION_FILE_PATH` → `.claude/ARE-VERSION` | `.agents/ARE-VERSION` | `.opencode/ARE-VERSION` | `.gemini/ARE-VERSION`
- `BACKEND_FLAG` → `--backend claude` | `--backend codex` | `--backend opencode` | `--backend gemini`
- `CCUSAGE_HINT` → `npx ccusage@latest (https://github.com/ryoppippi/ccusage)` | `npx @ccusage/codex@latest` | `npx @ccusage/opencode@latest`

**Progress Polling Pattern** (from `generate` command template):
```
<loop until completion>
sleep 15
Read .agents-reverse-engineer/progress.log with offset parameter
TaskOutput with block: false timeout: 1000
</loop>
```

**Discover Category Patterns**:
- test: `['**/*.test.*', '**/*.spec.*', '**/__tests__/**']`
- ci: `['.github/**', '.gitlab-ci.yml', 'Jenkinsfile']`
- tool-config: `['.prettierrc*', '.eslintrc*', 'tsconfig.json']`
- migration: `['**/migrations/**', '**/migrate/**']`
- fixture: `['**/__fixtures__/**', '**/fixtures/**']`
- type-declaration: `['**/*.d.ts']`
- docker: `['Dockerfile*', 'docker-compose*.yml']`