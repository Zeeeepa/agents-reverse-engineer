---
generated_at: 2026-02-09T13:18:08.003Z
content_hash: 443955a0ece4db51d38ab0ef848bb889304e6e0bcb3989ddad46f26676f882e7
purpose: buildFilePrompt, buildDirectoryPrompt, and buildRootPrompt construct multi-stage AI prompts for file analysis, direct...
---
**buildFilePrompt, buildDirectoryPrompt, and buildRootPrompt construct multi-stage AI prompts for file analysis, directory synthesis, and root document generation by assembling source code, .sum files, AGENTS.md files, import maps, and project metadata.**

## Exported Functions

**buildFilePrompt(context: PromptContext, debug?: boolean): { system: string; user: string }**  
Constructs FILE_SYSTEM_PROMPT and FILE_USER_PROMPT with placeholders replaced: `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}`. Appends `context.contextFiles` as fenced code blocks under "Related Files" section. Calls detectLanguage for syntax highlighting hint.

**buildDirectoryPrompt(dirPath: string, projectRoot: string, debug?: boolean, knownDirs?: Set<string>, projectStructure?: string): Promise<{ system: string; user: string }>**  
Generates DIRECTORY_SYSTEM_PROMPT and multi-section user prompt for directory-level AGENTS.md synthesis. Reads all .sum files via getSumPath and readSumFile, collects child AGENTS.md files from subdirectories, extracts import map via extractDirectoryImports + formatImportMap, detects manifest files (`package.json`, `Cargo.toml`, `go.mod`, `pyproject.toml`, `pom.xml`, `build.gradle`, `Gemfile`, `composer.json`, `CMakeLists.txt`, `Makefile`), and includes AGENTS.local.md if present. Filters subdirectories using `knownDirs` Set. Uses parallel Promise.all for .sum and AGENTS.md reads.

**buildRootPrompt(projectRoot: string, debug?: boolean): Promise<{ system: string; user: string }>**  
Constructs ROOT_SYSTEM_PROMPT and user prompt for root CLAUDE.md generation. Calls collectAgentsDocs to gather all AGENTS.md files, parses root package.json for metadata (name, version, description, packageManager, scripts), and embeds all content directly in prompt (no tool access required by LLM). Returns synthesized prompt with explicit "Output Requirements" section forbidding invention of undocumented features.

**detectLanguage(filePath: string): string**  
Maps file extension to syntax highlighting language tag: `.ts` → `typescript`, `.tsx` → `tsx`, `.py` → `python`, `.go` → `go`, `.rs` → `rust`, `.json` → `json`, `.yaml`/`.yml` → `yaml`, `.md` → `markdown`, etc. Defaults to `text` for unmapped extensions.

## Internal Utilities

**logTemplate(debug: boolean, action: string, filePath: string, extra?: string): void**  
Emits picocolors-formatted debug log to stderr: `[prompt] action → relative/path extra`. Guards on `debug` flag.

## Template Placeholders

buildFilePrompt replaces:
- `{{FILE_PATH}}`: absolute path to file
- `{{CONTENT}}`: raw file content
- `{{LANG}}`: detectLanguage result
- `{{PROJECT_PLAN_SECTION}}`: optional `<project-structure>` block from `context.projectPlan`

## Prompt Assembly Stages

1. **File-level**: buildFilePrompt injects single file + optional contextFiles + projectPlan into FILE_USER_PROMPT
2. **Directory-level**: buildDirectoryPrompt aggregates .sum summaries, child AGENTS.md, import map, manifest hints, AGENTS.local.md into DIRECTORY_SYSTEM_PROMPT prompt
3. **Root-level**: buildRootPrompt synthesizes all AGENTS.md + package.json into ROOT_SYSTEM_PROMPT for CLAUDE.md generation

## Import Map Integration

buildDirectoryPrompt filters source files by extension regex `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, passes to extractDirectoryImports, then calls formatImportMap to generate "Import Map (verified — use these exact paths)" section for cross-reference accuracy.

## User Documentation Preservation

buildDirectoryPrompt checks for AGENTS.local.md first; if missing, checks existing AGENTS.md for absence of GENERATED_MARKER (user-authored content). Embeds user notes with preservation hint: "will be preserved as [AGENTS.local.md](./AGENTS.local.md)".

## Dependencies

Imports FILE_SYSTEM_PROMPT, FILE_USER_PROMPT, DIRECTORY_SYSTEM_PROMPT, ROOT_SYSTEM_PROMPT from `./templates.js`. Imports readSumFile, getSumPath from `../writers/sum.js`, GENERATED_MARKER from `../writers/agents-md.js`, extractDirectoryImports + formatImportMap from `../../imports/index.js`, collectAgentsDocs from `../collector.js`. Uses node:fs/promises (readdir, readFile), node:path, picocolors.