---
generated_at: 2026-02-09T15:06:15.009Z
content_hash: c3913119ba0947387369ae3e2d5aaee61cfc29e80a47bf9cc041a8318c537ac8
purpose: builder.ts constructs AI prompts for the three-phase documentation pipeline: `buildFilePrompt` generates per-file ana...
---
**builder.ts constructs AI prompts for the three-phase documentation pipeline: `buildFilePrompt` generates per-file analysis prompts with optional import context and incremental update support, `buildDirectoryPrompt` aggregates .sum files and child AGENTS.md into directory-level synthesis prompts with manifest detection and import maps, `buildRootPrompt` collects all AGENTS.md files and package.json metadata for project-wide overview generation.**

## Exported Functions

### buildFilePrompt
```typescript
function buildFilePrompt(context: PromptContext, debug = false): {
  system: string;
  user: string;
}
```
Constructs prompt pair (system + user messages) for Phase 1 file analysis. Reads `context.filePath`, `context.content`, `context.projectPlan` (optional), `context.contextFiles[]` (optional), `context.existingSum` (optional). Calls `detectLanguage()` for syntax highlighting hint. Replaces placeholders in `FILE_USER_PROMPT`: `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}`. Appends "Related Files" section when `context.contextFiles` is populated. For incremental updates (when `context.existingSum` present), appends existing summary section and returns `FILE_UPDATE_SYSTEM_PROMPT` instead of `FILE_SYSTEM_PROMPT`. Logs via `logTemplate()` when `debug=true`.

### buildDirectoryPrompt
```typescript
async function buildDirectoryPrompt(
  dirPath: string,
  projectRoot: string,
  debug = false,
  knownDirs?: Set<string>,
  projectStructure?: string,
  existingAgentsMd?: string,
): Promise<{ system: string; user: string }>
```
Constructs prompt for Phase 2 directory aggregation into AGENTS.md. Calls `readdir()` to enumerate entries, filters via `knownDirs` set (when provided) to skip untracked subdirectories. Reads all .sum files in parallel via `getSumPath()` + `readSumFile()`, child AGENTS.md files, AGENTS.local.md (user documentation preservation). Detects manifest files via hardcoded array: `package.json`, `Cargo.toml`, `go.mod`, `pyproject.toml`, `pom.xml`, `build.gradle`, `Gemfile`, `composer.json`, `CMakeLists.txt`, `Makefile`. Calls `extractDirectoryImports()` for source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, formats via `formatImportMap()`. Appends "Project Directory Structure" section when `projectStructure` provided. For incremental updates (when `existingAgentsMd` present), appends existing content and returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` instead of `DIRECTORY_SYSTEM_PROMPT`. Returns user prompt with sections: File Summaries, Import Map, Subdirectories, Directory Hints (manifests), User Notes (AGENTS.local.md or existing non-generated AGENTS.md). Checks for `GENERATED_MARKER` to distinguish user-authored AGENTS.md from generated versions.

### buildRootPrompt
```typescript
async function buildRootPrompt(
  projectRoot: string,
  debug = false,
): Promise<{ system: string; user: string }>
```
Constructs prompt for Phase 3 root document synthesis (CLAUDE.md/GEMINI.md/OPENCODE.md). Calls `collectAgentsDocs()` to recursively gather all AGENTS.md files with relative paths. Reads root package.json via `readFile()`, extracts `name`, `version`, `description`, `packageManager`, `scripts` object. Builds user prompt with sections: AGENTS.md Files (aggregated content), Package Metadata (JSON fields), Output Requirements (architecture, getting started, key technologies). Returns `ROOT_SYSTEM_PROMPT` as system message. Enforces synthesis-only constraint via user instructions: "Do NOT invent features, hooks, patterns, or APIs that are not explicitly mentioned in the AGENTS.md content."

### detectLanguage
```typescript
function detectLanguage(filePath: string): string
```
Maps file extension to syntax highlighting identifier. Uses `path.extname()` and hardcoded `langMap` object with 20 entries: `.ts` → `typescript`, `.tsx` → `tsx`, `.js` → `javascript`, `.jsx` → `jsx`, `.py` → `python`, `.rb` → `ruby`, `.go` → `go`, `.rs` → `rust`, `.java` → `java`, `.kt` → `kotlin`, `.swift` → `swift`, `.cs` → `csharp`, `.php` → `php`, `.vue` → `vue`, `.svelte` → `svelte`, `.json` → `json`, `.yaml`/`.yml` → `yaml`, `.md` → `markdown`, `.css` → `css`, `.scss` → `scss`, `.html` → `html`. Returns `'text'` for unmapped extensions.

## Incremental Update Strategy

`buildFilePrompt` and `buildDirectoryPrompt` switch to update-specific system prompts when existing content detected. File updates use `FILE_UPDATE_SYSTEM_PROMPT` + appended `context.existingSum`, directory updates use `DIRECTORY_UPDATE_SYSTEM_PROMPT` + appended `existingAgentsMd`. Prompts instruct: "preserve stable content, modify only what changed" to minimize unnecessary rewrites.

## Dependencies

Imports `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`, `ROOT_SYSTEM_PROMPT` from `./templates.js` (static prompt templates). Calls `readSumFile()`, `getSumPath()` from `../writers/sum.js`, `GENERATED_MARKER` constant from `../writers/agents-md.js`, `extractDirectoryImports()`, `formatImportMap()` from `../../imports/index.js`, `collectAgentsDocs()` from `../collector.js`. Uses `picocolors` for debug logging via `logTemplate()`.

## Debug Logging

Internal `logTemplate()` function logs when `debug=true` via `console.error()`. Formats: `[prompt] buildFilePrompt → path lang=typescript`, `[prompt] buildDirectoryPrompt → path files=5 subdirs=2 imports=8`. All logs dim via `pc.dim()` to reduce visual noise.

## User Documentation Preservation

`buildDirectoryPrompt` checks for AGENTS.local.md first, falls back to non-generated AGENTS.md (missing `GENERATED_MARKER`). Appends user content as "User Notes" section with file reference. First-run detection renames user AGENTS.md → AGENTS.local.md (handled by caller, not this module).