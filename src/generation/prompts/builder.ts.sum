---
generated_at: 2026-02-09T14:08:18.194Z
content_hash: 443955a0ece4db51d38ab0ef848bb889304e6e0bcb3989ddad46f26676f882e7
purpose: builder.ts constructs AI prompts for the three-phase documentation pipeline: file analysis (buildFilePrompt), directo...
---
**builder.ts constructs AI prompts for the three-phase documentation pipeline: file analysis (buildFilePrompt), directory aggregation (buildDirectoryPrompt), and root synthesis (buildRootPrompt).**

## Exported Functions

### buildFilePrompt(context: PromptContext, debug?: boolean): { system: string; user: string }
Assembles file analysis prompts by combining FILE_SYSTEM_PROMPT with FILE_USER_PROMPT template, substituting `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, and `{{PROJECT_PLAN_SECTION}}` placeholders. Appends related files section if `context.contextFiles` populated. Calls detectLanguage() for syntax highlighting hint. Returns object with `system` and `user` prompt strings.

### buildDirectoryPrompt(dirPath: string, projectRoot: string, debug?: boolean, knownDirs?: Set<string>, projectStructure?: string): Promise<{ system: string; user: string }>
Generates directory-level AGENTS.md prompts by aggregating child `.sum` files via readSumFile(getSumPath()), subdirectory AGENTS.md content, and AGENTS.local.md user notes. Detects manifest files (package.json, Cargo.toml, go.mod, etc.) to identify package roots. Calls extractDirectoryImports() + formatImportMap() to embed verified import statements. Filters subdirectories against `knownDirs` set when provided. Uses DIRECTORY_SYSTEM_PROMPT template. Includes `projectStructure` in `<project-structure>` tags if available.

### buildRootPrompt(projectRoot: string, debug?: boolean): Promise<{ system: string; user: string }>
Constructs root CLAUDE.md synthesis prompt via collectAgentsDocs() to gather all AGENTS.md files into sections. Parses root package.json for metadata (name, version, description, packageManager, scripts). Embeds complete directory documentation corpus in user prompt with synthesis-only constraints ("Do NOT invent features, hooks, patterns"). Uses ROOT_SYSTEM_PROMPT template. Returns comprehensive reference document requirements.

### detectLanguage(filePath: string): string
Maps file extensions to syntax highlighting language identifiers via `langMap` object (26 mappings: `.ts` → `'typescript'`, `.py` → `'python'`, `.md` → `'markdown'`, etc.). Returns `'text'` for unmapped extensions. Normalizes extension via `path.extname().toLowerCase()`.

## Internal Utilities

### logTemplate(debug: boolean, action: string, filePath: string, extra?: string): void
Debug logger using picocolors formatting: `[prompt] ${action} → ${relativePath} ${extra}`. Guards on `debug` flag, writes to stderr via `console.error()`.

## Dependencies

**Templates:** Imports FILE_SYSTEM_PROMPT, FILE_USER_PROMPT, DIRECTORY_SYSTEM_PROMPT, ROOT_SYSTEM_PROMPT from `./templates.js` (constant strings with Mustache-style placeholders).

**Writers:** Uses readSumFile() + getSumPath() from `../writers/sum.js` to load `.sum` YAML frontmatter + summary text. References GENERATED_MARKER from `../writers/agents-md.js` to detect user-authored vs. ARE-generated AGENTS.md files.

**Imports:** Calls extractDirectoryImports() + formatImportMap() from `../../imports/index.js` for static analysis of import statements in source files (`.ts`, `.tsx`, `.js`, `.jsx`, `.py`, `.go`, `.rs`, `.java`, `.kt` extensions).

**Collector:** Uses collectAgentsDocs(projectRoot) from `../collector.js` to recursively traverse directory tree and gather all AGENTS.md files with relativePath + content.

**Types:** Consumes PromptContext interface from `./types.js` (fields: filePath, content, projectPlan?, contextFiles?).

## Prompt Structure Patterns

**File prompts:** System prompt defines documentation density rules, user prompt embeds source code in triple-backtick fence with language tag, appends project structure in `<project-structure>` XML tags, includes related files as additional fenced blocks.

**Directory prompts:** User prompt sections: file summaries (H3 headers with purpose + summary), import map (verified paths), project structure (XML tags), subdirectories (H3 headers with full AGENTS.md content), directory hints (manifest detection), user notes (AGENTS.local.md or non-generated AGENTS.md content).

**Root prompts:** User prompt sections: synthesis instructions with anti-hallucination constraint, AGENTS.md corpus (H3 headers per directory), package metadata (bullet list from package.json fields), output requirements (bullet list mandating architecture, directories table, getting started, technologies).

## User Content Preservation

buildDirectoryPrompt() implements two-stage fallback for user documentation: first checks AGENTS.local.md, then checks existing AGENTS.md without GENERATED_MARKER (`<!-- Generated by agents-reverse-engineer -->`). Embeds user content in `## User Notes` section with reference links. First-run behavior converts user-authored AGENTS.md → AGENTS.local.md during generation phase (writer handles rename).

## Manifest Detection

Searches for 9 manifest file types: package.json (npm/pnpm/yarn), Cargo.toml (Rust), go.mod (Go), pyproject.toml (Python), pom.xml (Maven), build.gradle (Gradle), Gemfile (Ruby), composer.json (PHP), CMakeLists.txt (CMake), Makefile. Appends "likely a package or project root" hint to directory prompt when found.

## Import Analysis Integration

Filters source files by extension regex `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/` before calling extractDirectoryImports(). Embeds formatted import map with "verified — use these exact paths" annotation to prevent phantom path hallucination in generated documentation. Only includes section when `importMapText` non-empty.

## Debug Logging

All builder functions accept optional `debug` parameter. When enabled, logTemplate() emits: `buildFilePrompt` logs `lang=${lang}`, `buildDirectoryPrompt` logs `files=${count} subdirs=${count} imports=${count}`, `buildRootPrompt` logs `agents=${count}`. Skipped AGENTS.md files logged as `Skipping missing ${path}`.