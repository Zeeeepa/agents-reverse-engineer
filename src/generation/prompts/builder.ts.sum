---
generated_at: 2026-02-09T16:09:14.523Z
content_hash: c3913119ba0947387369ae3e2d5aaee61cfc29e80a47bf9cc041a8318c537ac8
purpose: buildFilePrompt, buildDirectoryPrompt, buildRootPrompt construct system+user prompt pairs for file analysis, director...
---
**buildFilePrompt, buildDirectoryPrompt, buildRootPrompt construct system+user prompt pairs for file analysis, directory aggregation, and root synthesis by assembling templates with runtime context (source code, .sum summaries, AGENTS.md, import maps, project structure).**

## Exported Functions

**buildFilePrompt(context: PromptContext, debug = false): { system: string; user: string }**  
Constructs file analysis prompts by substituting `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}` placeholders in `FILE_USER_PROMPT` template. Detects language via `detectLanguage()` for syntax highlighting. Appends contextFiles section if `context.contextFiles` populated. Returns `FILE_UPDATE_SYSTEM_PROMPT` when `context.existingSum` present (incremental update mode), otherwise `FILE_SYSTEM_PROMPT`.

**buildDirectoryPrompt(dirPath: string, projectRoot: string, debug = false, knownDirs?: Set<string>, projectStructure?: string, existingAgentsMd?: string): Promise<{ system: string; user: string }>**  
Assembles directory aggregation prompts by reading all `.sum` files via `readSumFile(getSumPath(entryPath))`, collecting child `AGENTS.md` files, extracting directory imports via `extractDirectoryImports()` + `formatImportMap()`, detecting manifest files (9 types: `package.json`, `Cargo.toml`, `go.mod`, `pyproject.toml`, `pom.xml`, `build.gradle`, `Gemfile`, `composer.json`, `CMakeLists.txt`, `Makefile`), and checking for `AGENTS.local.md` or non-generated `AGENTS.md` (lacking `GENERATED_MARKER`). Returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` supplied (incremental), otherwise `DIRECTORY_SYSTEM_PROMPT`. Filters subdirectories against `knownDirs` set when provided to skip non-source directories. Embeds `projectStructure` in `<project-structure>` tags when available.

**buildRootPrompt(projectRoot: string, debug = false): Promise<{ system: string; user: string }>**  
Constructs root synthesis prompts by collecting all `AGENTS.md` files via `collectAgentsDocs(projectRoot)`, parsing root `package.json` for metadata (name, version, description, packageManager, scripts), and embedding synthesis constraints: "Use ONLY the information provided below. Do NOT invent features, hooks, patterns, or APIs that are not explicitly mentioned in the AGENTS.md content." Returns `ROOT_SYSTEM_PROMPT` paired with user prompt containing all AGENTS.md content as `### ${relativePath}` sections, package metadata, and output requirements checklist (purpose, architecture, directories table, getting started, technologies).

**detectLanguage(filePath: string): string**  
Maps file extensions to syntax highlighting identifiers via lookup table. Supports 22 extensions: `.ts` → `'typescript'`, `.tsx` → `'tsx'`, `.js` → `'javascript'`, `.jsx` → `'jsx'`, `.py` → `'python'`, `.rb` → `'ruby'`, `.go` → `'go'`, `.rs` → `'rust'`, `.java` → `'java'`, `.kt` → `'kotlin'`, `.swift` → `'swift'`, `.cs` → `'csharp'`, `.php` → `'php'`, `.vue` → `'vue'`, `.svelte` → `'svelte'`, `.json` → `'json'`, `.yaml`/`.yml` → `'yaml'`, `.md` → `'markdown'`, `.css` → `'css'`, `.scss` → `'scss'`, `.html` → `'html'`. Defaults to `'text'` for unknown extensions.

## Internal Helpers

**logTemplate(debug: boolean, action: string, filePath: string, extra?: string): void**  
Emits debug logs to stderr with format: `[prompt] ${action} → ${relativePath} ${extra}`. Only executes when `debug=true`. Uses picocolors for formatting: `pc.dim()` for brackets/arrows, `pc.cyan()` for action labels.

## Integration Points

Imports template constants from `./templates.js`: `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`, `ROOT_SYSTEM_PROMPT`. Calls `readSumFile()` and `getSumPath()` from `../writers/sum.js` to retrieve `.sum` file metadata+content. References `GENERATED_MARKER` from `../writers/agents-md.js` to detect user-authored vs. generated AGENTS.md. Invokes `extractDirectoryImports()` + `formatImportMap()` from `../../imports/index.js` to build verified import maps. Calls `collectAgentsDocs(projectRoot)` from `../collector.js` to aggregate all AGENTS.md files recursively.

## Behavioral Contracts

**Source file extension regex for import extraction:**  
`/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/` — only files matching these extensions processed by `extractDirectoryImports()`.

**Manifest file names for package root detection:**  
`['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']` — presence triggers "likely a package or project root" hint in directory prompts.

**File summary format in directory prompts:**  
```
### ${fileName}
**Purpose:** ${metadata.purpose}

${summaryContent}
```

**Subdirectory section format:**  
```
### ${dirName}/
${childAgentsMdContent}
```

**User notes section header:**  
`"## User Notes (AGENTS.local.md)"` when AGENTS.local.md exists, `"## User Notes (existing AGENTS.md)"` when pre-existing non-generated AGENTS.md detected on first run.

**Incremental update instruction appended to prompts:**  
`"## Existing Summary (update this — preserve stable content, modify only what changed)"` for file prompts with `context.existingSum`, `"## Existing AGENTS.md (update this — preserve stable content, modify only what changed)"` for directory prompts with `existingAgentsMd`.

**Root prompt synthesis constraint:**  
`"Use ONLY the information provided below. Do NOT invent features, hooks, patterns, or APIs that are not explicitly mentioned in the AGENTS.md content."` — enforces faithful synthesis without hallucination.

**Root prompt output requirements:**  
```
The document MUST include:
- Project purpose and description
- Architecture overview with directory structure
- Key directories table
- Getting started (install, build, run commands)
- Key technologies and dependencies
```

**Root prompt de-duplication directive:**  
`"Individual file details belong in directory-level AGENTS.md files — reference them, don't duplicate them."` — prevents redundant file-level detail in root document.

## Data Flow

1. **File analysis:** `buildFilePrompt()` receives `PromptContext` (filePath, content, contextFiles, existingSum), detects language, substitutes template placeholders, appends related files section, returns system+user pair selecting update vs. fresh template based on `existingSum` presence.

2. **Directory aggregation:** `buildDirectoryPrompt()` reads directory via `readdir()`, filters known directories via `knownDirs` set, reads `.sum` files in parallel via `Promise.all()`, reads child `AGENTS.md` files in parallel, extracts imports from source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, detects manifest files, checks for user documentation (AGENTS.local.md or non-generated AGENTS.md), assembles sections in order: file summaries, import map, project structure, subdirectories, directory hints, user notes, existing AGENTS.md (update mode), returns system+user pair with `DIRECTORY_UPDATE_SYSTEM_PROMPT` if `existingAgentsMd` supplied.

3. **Root synthesis:** `buildRootPrompt()` calls `collectAgentsDocs()` to recursively gather all `AGENTS.md` files, reads root `package.json` and extracts metadata fields (name, version, description, packageManager, scripts), embeds all AGENTS.md content as `### ${relativePath}` sections, appends package metadata, includes synthesis constraints and output requirements checklist, returns `ROOT_SYSTEM_PROMPT` + user prompt.

## Error Handling

Silent fallback on missing files: `try/catch` blocks around `readFile()` for child AGENTS.md, AGENTS.local.md, existing AGENTS.md, package.json — logs skipped files to stderr when `debug=true` but proceeds without throwing. `readSumFile()` returns null on missing `.sum` files, filtered out via `.filter((r): r is string => r !== null)` type guard.