---
generated_at: 2026-02-09T21:28:13.817Z
content_hash: 7231684c7cbf85a34d756f1ba30d896859938cfcc4eff3ffdabf1c20002fe473
purpose: builder.ts constructs AI prompt pairs (system/user) for the three-phase documentation pipeline: file analysis with im...
---
**builder.ts constructs AI prompt pairs (system/user) for the three-phase documentation pipeline: file analysis with import maps and context files, directory-level AGENTS.md aggregation with child summaries and manifests, and root CLAUDE.md synthesis from all AGENTS.md corpus.**

## Exported Functions

### buildFilePrompt

```typescript
buildFilePrompt(context: PromptContext, debug = false): { system: string; user: string }
```

Constructs file-level analysis prompts by injecting `context.filePath`, `context.content`, detected language (via `detectLanguage()`), and optional `context.projectPlan` into `FILE_USER_PROMPT` template. Appends `context.contextFiles[]` as fenced code blocks if provided. For incremental updates, appends `context.existingSum` and returns `FILE_UPDATE_SYSTEM_PROMPT` instead of `FILE_SYSTEM_PROMPT`.

### buildDirectoryPrompt

```typescript
async buildDirectoryPrompt(
  dirPath: string,
  projectRoot: string,
  debug = false,
  knownDirs?: Set<string>,
  projectStructure?: string,
  existingAgentsMd?: string,
): Promise<{ system: string; user: string }>
```

Aggregates directory context for AGENTS.md generation via parallel reads:
- Reads all `.sum` files in `dirPath` via `getSumPath()` + `readSumFile()`, formats as `### filename\n**Purpose:** ...\n\nsummary`
- Reads all child `AGENTS.md` files from subdirectories (filtered by `knownDirs` set if provided)
- Detects user-authored documentation: reads `AGENTS.local.md` or non-generated `AGENTS.md` (checked via `GENERATED_MARKER` absence)
- Detects manifest files via hardcoded array: `['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']`
- Extracts actual import statements via `extractDirectoryImports()` for source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, formats via `formatImportMap()`
- Scans for `.annex.md` files and lists them in "Annex Files" section
- Injects optional `projectStructure` (full file tree) and `existingAgentsMd` for incremental updates
- Returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` if `existingAgentsMd` provided, else `DIRECTORY_SYSTEM_PROMPT`

### buildRootPrompt

```typescript
async buildRootPrompt(
  projectRoot: string,
  debug = false,
): Promise<{ system: string; user: string }>
```

Synthesizes project-wide CLAUDE.md by:
- Collecting all `AGENTS.md` files via `collectAgentsDocs(projectRoot)`, formatting as `### relativePath\n\ncontent`
- Reading root `package.json` and extracting metadata: `name`, `version`, `description`, `packageManager`, `scripts` (formatted as bullet list with inline code)
- Embedding synthesis constraints: "Use ONLY the information provided below. Do NOT invent features, hooks, patterns, or APIs..."
- Specifying output requirements: architecture overview, key directories table, getting started, key technologies
- Returns `ROOT_SYSTEM_PROMPT` with no update variant (root always regenerated fully)

### detectLanguage

```typescript
detectLanguage(filePath: string): string
```

Maps file extensions to syntax highlighting language identifiers via lookup table with 22 entries (`.ts` → `"typescript"`, `.py` → `"python"`, `.md` → `"markdown"`, etc.), defaulting to `"text"` for unknown extensions.

### logTemplate

```typescript
logTemplate(debug: boolean, action: string, filePath: string, extra?: string): void
```

Emits debug logs with picocolors formatting: `[prompt] action → relativePath extra` when `debug` is true. Used by all builder functions to trace prompt construction.

## Template Dependencies

Imports six constant templates from `./templates.js`:
- `FILE_SYSTEM_PROMPT` — system prompt for new file analysis
- `FILE_USER_PROMPT` — user prompt template with placeholders: `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}`
- `FILE_UPDATE_SYSTEM_PROMPT` — system prompt for incremental file updates
- `DIRECTORY_SYSTEM_PROMPT` — system prompt for new directory aggregation
- `DIRECTORY_UPDATE_SYSTEM_PROMPT` — system prompt for incremental directory updates
- `ROOT_SYSTEM_PROMPT` — system prompt for root synthesis (no update variant)

## Context Enrichment Strategies

**File-level:**
- Language detection for fenced code block syntax
- Full project structure tree via `context.projectPlan` (optional)
- Related files via `context.contextFiles[]` with auto-detected language per file
- Existing summary for diff-based updates

**Directory-level:**
- Child `.sum` file summaries with purpose frontmatter
- Subdirectory `AGENTS.md` recursion (one level deep)
- Import maps with verified path constraints via static analysis
- Manifest detection for package root hints
- Annex file listing for reproduction-critical constants
- User-authored documentation preservation (`AGENTS.local.md` or pre-existing `AGENTS.md`)
- Full project structure tree (optional)

**Root-level:**
- Complete `AGENTS.md` corpus via `collectAgentsDocs()`
- Root `package.json` metadata with script listings
- Explicit anti-invention constraints in prompt text

## Integration Points

- `readSumFile()` from `../writers/sum.js` — parses YAML frontmatter + summary content
- `getSumPath()` from `../writers/sum.js` — computes `.sum` file path from source path
- `GENERATED_MARKER` from `../writers/agents-md.js` — detects ARE-generated vs. user-authored AGENTS.md
- `extractDirectoryImports()` + `formatImportMap()` from `../../imports/index.js` — static import analysis
- `collectAgentsDocs()` from `../collector.js` — recursive AGENTS.md tree traversal

## Placeholder Syntax

User prompts use mustache-style placeholders replaced via `String.replace()` with regex flags `/g`:
- `{{FILE_PATH}}` — source file relative path
- `{{CONTENT}}` — file content (unescaped)
- `{{LANG}}` — detected language identifier
- `{{PROJECT_PLAN_SECTION}}` — project structure tree or empty string

## Debug Logging Pattern

All builder functions accept optional `debug` boolean (default `false`). When enabled, calls `logTemplate()` with:
- `buildFilePrompt`: logs `lang=<detected>`
- `buildDirectoryPrompt`: logs `files=<count> subdirs=<count> imports=<count>`
- `buildRootPrompt`: logs `agents=<count>`

Logs written to stderr via `console.error()` with picocolors formatting: `pc.dim('[prompt]')`, `pc.cyan(action)`, `pc.dim('→')`.