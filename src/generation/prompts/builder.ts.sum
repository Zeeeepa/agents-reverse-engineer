---
generated_at: 2026-02-09T17:44:19.758Z
content_hash: 7231684c7cbf85a34d756f1ba30d896859938cfcc4eff3ffdabf1c20002fe473
purpose: builder.ts constructs AI prompts for three-phase documentation generation: buildFilePrompt() assembles file analysis ...
---
**builder.ts constructs AI prompts for three-phase documentation generation: buildFilePrompt() assembles file analysis prompts with import context and optional incremental update sections, buildDirectoryPrompt() aggregates child .sum files and subdirectory AGENTS.md with import maps for directory synthesis, buildRootPrompt() collects all AGENTS.md files and package.json metadata for project-level CLAUDE.md generation.**

## Exported Functions

### buildFilePrompt
```typescript
function buildFilePrompt(context: PromptContext, debug = false): {
  system: string;
  user: string;
}
```
Constructs file analysis prompt by detecting language via `detectLanguage()`, substituting `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}` placeholders in `FILE_USER_PROMPT`, appending `context.contextFiles[]` as related file sections with syntax-highlighted code blocks, and conditionally appending `context.existingSum` with update instructions when incremental mode is active. Returns `FILE_SYSTEM_PROMPT` for fresh analysis or `FILE_UPDATE_SYSTEM_PROMPT` for incremental updates.

### buildDirectoryPrompt
```typescript
async function buildDirectoryPrompt(
  dirPath: string,
  projectRoot: string,
  debug = false,
  knownDirs?: Set<string>,
  projectStructure?: string,
  existingAgentsMd?: string,
): Promise<{ system: string; user: string }>
```
Aggregates directory documentation by reading all `.sum` files via `readSumFile()` and `getSumPath()`, collecting child `AGENTS.md` from subdirectories in `knownDirs` set, detecting user-authored content in `AGENTS.local.md` or non-generated `AGENTS.md` (checked via `GENERATED_MARKER` absence), extracting import maps via `extractDirectoryImports()` and `formatImportMap()`, enumerating manifest files from array `['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']`, scanning for `.annex.md` files, and appending optional `projectStructure` in `<project-structure>` tags. Returns `DIRECTORY_SYSTEM_PROMPT` for fresh generation or `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` is provided. Filters source files by regex `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/` for import extraction.

### buildRootPrompt
```typescript
async function buildRootPrompt(
  projectRoot: string,
  debug = false,
): Promise<{ system: string; user: string }>
```
Synthesizes project-level prompt by calling `collectAgentsDocs()` to gather all AGENTS.md files, parsing `package.json` to extract `name`, `version`, `description`, `packageManager`, and `scripts` object entries, embedding AGENTS.md content as `### {relativePath}` sections, and enforcing synthesis-only constraints with explicit instruction: "Use ONLY the information provided below. Do NOT invent features, hooks, patterns, or APIs." Returns `ROOT_SYSTEM_PROMPT` with user prompt listing output requirements (architecture, key directories table, getting started, technologies).

### detectLanguage
```typescript
function detectLanguage(filePath: string): string
```
Maps file extension via `path.extname()` to syntax identifier using `langMap` object covering 21 extensions: `.ts` → `'typescript'`, `.tsx` → `'tsx'`, `.js` → `'javascript'`, `.jsx` → `'jsx'`, `.py` → `'python'`, `.rb` → `'ruby'`, `.go` → `'go'`, `.rs` → `'rust'`, `.java` → `'java'`, `.kt` → `'kotlin'`, `.swift` → `'swift'`, `.cs` → `'csharp'`, `.php` → `'php'`, `.vue` → `'vue'`, `.svelte` → `'svelte'`, `.json` → `'json'`, `.yaml`/`.yml` → `'yaml'`, `.md` → `'markdown'`, `.css` → `'css'`, `.scss` → `'scss'`, `.html` → `'html'`. Fallback returns `'text'`.

## Template Integration

Imports six prompt templates from `templates.js`: `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`, `ROOT_SYSTEM_PROMPT`. `buildFilePrompt()` uses `FILE_USER_PROMPT` with mustache-style placeholder substitution pattern `/\{\{VARIABLE\}\}/g`. `buildDirectoryPrompt()` and `buildRootPrompt()` construct user prompts programmatically without template string substitution.

## Incremental Update Strategy

All three builders accept optional existing content parameters: `context.existingSum` in `buildFilePrompt()`, `existingAgentsMd` in `buildDirectoryPrompt()`. When provided, appends existing content under heading `## Existing [Summary|AGENTS.md] (update this — preserve stable content, modify only what changed)` and switches to update-specific system prompts (`FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`).

## User Content Preservation

`buildDirectoryPrompt()` checks for `AGENTS.local.md` first, falling back to checking existing `AGENTS.md` for absence of `GENERATED_MARKER` constant (imported from `../writers/agents-md.js`). User content appended as `## User Notes` section with reference link pattern `[AGENTS.local.md](./AGENTS.local.md)`. First-run detection message: "This user-defined content will be preserved as [AGENTS.local.md](./AGENTS.local.md)."

## Debug Logging

Internal `logTemplate()` function emits conditional debug output to stderr using `picocolors` formatting: `${pc.dim('[prompt]')} ${pc.cyan(action)} ${pc.dim('→')} ${relativePath} ${pc.dim(extra)}`. Called from all three builders with action names `'buildFilePrompt'`, `'buildDirectoryPrompt'`, `'buildRootPrompt'` and metadata strings like `lang=typescript`, `files=12 subdirs=3 imports=8`, `agents=15`.

## Dependencies

- `node:path`, `node:fs/promises` (readdir, readFile)
- `picocolors` as `pc` for terminal colors
- `./types.js` exports `PromptContext` interface
- `./templates.js` exports six prompt constant strings
- `../writers/sum.js` exports `readSumFile()`, `getSumPath()`
- `../writers/agents-md.js` exports `GENERATED_MARKER` string constant
- `../../imports/index.js` exports `extractDirectoryImports()`, `formatImportMap()`
- `../collector.js` exports `collectAgentsDocs()`