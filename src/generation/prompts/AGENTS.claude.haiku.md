<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/generation/prompts

This directory provides prompt construction utilities for AI-driven documentation generation, handling both single-file summaries and directory-level AGENTS.md synthesis with language detection, compression rules, and incremental update workflows.

## Contents

**Prompt Construction**
- [builder.ts](./builder.ts) — `detectLanguage()` maps file extensions to syntax highlighting codes; `buildFilePrompt()` assembles system/user prompts for single-file analysis with template substitution (`{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`), optional context files, and aggressive compression injection when `compressionRatio < 0.5`; `buildDirectoryPrompt()` generates AGENTS.md prompts by reading `.sum` file summaries, extracting imports via `extractDirectoryImports()`, detecting `.annex.sum` files and manifest indicators (`package.json`, `Cargo.toml`, etc.), preserving user-authored content via `GENERATED_MARKER_PREFIX` detection, and returning update system prompts when `existingAgentsMd` is provided.

**Type Definitions & Guidelines**
- [types.ts](./types.ts) — `PromptContext` interface with `filePath`, `content`, `contextFiles`, `existingSum`, `sourceFileSize`, `compressionRatio`; `SUMMARY_GUIDELINES` constant specifying `targetLength` ({min: 300, max: 500}) and required documentation topics.

**System Prompts**
- [templates.ts](./templates.ts) — `FILE_SYSTEM_PROMPT` (19,318 chars) instructs AI to produce dense, identifier-rich summaries with density rules, anchor term preservation, behavioral contract extraction, and annex handling; `FILE_USER_PROMPT` template with substitution slots; `DIRECTORY_SYSTEM_PROMPT` orchestrates AGENTS.md generation with adaptive section selection and density enforcement; `DIRECTORY_UPDATE_SYSTEM_PROMPT` and `FILE_UPDATE_SYSTEM_PROMPT` preserve existing content while modifying only changed sections.

**Public API**
- [index.ts](./index.ts) — Barrel re-exporting `PromptContext`, `SUMMARY_GUIDELINES`, `buildFilePrompt()`, `buildDirectoryPrompt()`, and `detectLanguage()` for consumers in `src/generation/`.

## Architecture

`buildFilePrompt()` consumes `PromptContext` and optional debug/logger parameters, substituting templates and conditionally injecting compression rules. `buildDirectoryPrompt()` orchestrates a multi-step pipeline: reads parallel `.sum` files via `readSumFile(getSumPath())`, extracts directory imports from source files (`.ts|tsx|js|jsx|py|go|rs|java|kt`) via `extractDirectoryImports(dirPath, sourceFileNames)`, formats imports with `formatImportMap()`, detects user-authored `AGENTS.md` by checking absence of `GENERATED_MARKER_PREFIX`, scans for `.annex.sum` files and manifest files, collects child subdirectory `AGENTS.md`/`AGENTS.{variant}.md` via `readSumFile()`, and assembles user section with directory path, file summaries, import map, project structure, annex files, subdirectories, and manifest hints. Incremental updates (`FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`) instruct the AI to preserve stable content and modify only affected entries.

## Behavioral Contracts

**Compression injection:** When `compressionRatio < 0.5` AND `sourceFileSize > 0`, calculate `targetSize = Math.round(sourceFileSize * ratio)` and `maxSize = Math.round(targetSize * 1.2)`, then append aggressive compression rules to user prompt.

**Template substitution:** Patterns `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}` replaced via `.replace(/\{\{...\}\}/g, ...)` in `FILE_USER_PROMPT`.

**Generated marker detection:** `GENERATED_MARKER_PREFIX` substring presence distinguishes generated AGENTS.md from user-authored versions; absence signals user-maintained content requiring preservation.

**Manifest file indicators:** Presence of `package.json`, `Cargo.toml`, `go.mod`, `pyproject.toml`, `pom.xml`, `build.gradle`, `Gemfile`, `composer.json`, `CMakeLists.txt`, or `Makefile` signals project root/manifest hints included in directory prompt.

**Incremental update mode activation:** `FILE_UPDATE_SYSTEM_PROMPT` triggered when `context.existingSum` truthy; `DIRECTORY_UPDATE_SYSTEM_PROMPT` triggered when `existingAgentsMd` truthy; existing content appended under "Existing Summary"/"Existing AGENTS.md" headers with explicit instruction to preserve stable sections.

## Reproduction-Critical Constants

Full template text: [templates.annex.sum](./templates.annex.sum)