<!-- Generated by agents-reverse-engineer -->

# src/generation/prompts

Constructs AI prompts for file analysis and directory AGENTS.md generation by injecting source code, existing summaries, import maps, and project structure into template strings. Consumed by `src/generation/executor.ts` during the three-phase documentation pipeline.

## Contents

### [builder.ts](./builder.ts)
Provides `buildFilePrompt()` and `buildDirectoryPrompt()` functions that construct system+user prompt pairs by replacing `{{PLACEHOLDER}}` tokens in template strings. Calls `extractDirectoryImports()` from `../../imports/index.js` to build verified import maps, reads child `.sum` files via `getSumPath()` and `readSumFile()` from `../writers/sum.js`, and detects package manifests (`package.json`, `Cargo.toml`, etc.) to identify technology stacks. Switches to incremental update prompts (`FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`) when `existingSum` or `existingAgentsMd` parameters present.

### [templates.ts](./templates.ts)
Exports `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT` string constants containing AI instructions for documentation generation. Enforces density rules (every sentence must reference an identifier), forbidden filler phrases (`"this file"`, `"provides"`, `"responsible for"`), behavioral contract preservation (verbatim regex patterns in backticks), and output format requirements (raw markdown, no code fences for AGENTS.md).

### [types.ts](./types.ts)
Defines `PromptContext` interface (`filePath`, `content`, `contextFiles?`, `projectPlan?`, `existingSum?`) and `SUMMARY_GUIDELINES` constant specifying 300-500 word target length, 8 mandatory content categories (purpose, public interface, dependencies, behavioral contracts, annex references), and 3 exclusions (control flow minutiae, generic TODOs, broad architecture).

### [index.ts](./index.ts)
Barrel export re-exporting `PromptContext`, `SUMMARY_GUIDELINES`, `buildFilePrompt()`, `buildDirectoryPrompt()`, `detectLanguage()` for consumption by `src/generation/executor.ts` and `src/generation/orchestrator.ts`.

## Architecture

**Template substitution flow:**
1. `builder.ts` reads template strings from `templates.ts`
2. Performs global `String.replace(/\{\{PLACEHOLDER\}\}/g, value)` for runtime variable injection (`{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`)
3. Conditionally appends sections (Related Files, Import Map, Project Structure, Annex References, Subdirectories, User Notes)
4. Returns `{system, user}` prompt pair to `executor.ts` for Claude subprocess invocation

**Update detection:** Presence of `context.existingSum` or `existingAgentsMd` parameter triggers incremental mode — switches to `*_UPDATE_SYSTEM_PROMPT` templates and appends existing content sections with preservation instructions.

**Import map injection:** `buildDirectoryPrompt()` extracts actual import statements from source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, formats via `formatImportMap()`, and injects under "## Import Map (verified — use these exact paths)" heading to enforce cross-reference accuracy.

## Behavioral Contracts

**Template placeholder syntax:** `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}` — replaced via global regex substitution.

**Manifest detection list:** `['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']` — exact filenames for package root identification.

**Source file extensions for import extraction:** `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`

**Annex file suffix:** `.annex.sum` — pattern for detecting reproduction-critical constant files.

**Forbidden filler phrases (enforced in templates):** `"this file"`, `"this module"`, `"provides"`, `"responsible for"`, `"is used to"`, `"basically"`, `"essentially"`, `"provides functionality for"`

**Density requirement (enforced in templates):** Every sentence must reference at least one identifier (function name, class name, type name, or constant).

**Generated marker detection:** `GENERATED_MARKER` from `../writers/agents-md.js` (value: `<!-- Generated by agents-reverse-engineer -->`) distinguishes ARE-managed AGENTS.md from user-authored content.

## Annex References

Full prompt template text: [templates.annex.sum](./templates.annex.sum)
SUMMARY_GUIDELINES structure: [types.annex.sum](./types.annex.sum)