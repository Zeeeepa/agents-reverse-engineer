<!-- Generated by agents-reverse-engineer -->

# prompts

**Prompt construction subsystem for AI-driven file analysis and directory documentation generation, exposing `buildFilePrompt` and `buildDirectoryPrompt` functions that inject template placeholders, import maps, behavioral contracts, and project structure into system/user prompt pairs.**

## Contents

### Core Modules

**[builder.ts](./builder.ts)** — Constructs `{ system, user }` prompt pairs for file analysis (`buildFilePrompt`) and directory overview generation (`buildDirectoryPrompt`), replacing `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}` placeholders and injecting import maps via `extractDirectoryImports`, manifest hints, annex file listings, and existing documentation for incremental updates.

**[templates.ts](./templates.ts)** — Exports `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT` string constants defining density rules, anchor term preservation, behavioral contract verbatim requirements, annex overflow mechanism, and path accuracy mandates for AI documentation generation.

**[types.ts](./types.ts)** — Defines `PromptContext` interface (`filePath`, `content`, `contextFiles`, `projectPlan`, `existingSum`) and `SUMMARY_GUIDELINES` constant specifying `{min: 300, max: 500}` word count, 8 required `include` categories (public interface, dependencies, behavioral contracts, annex references), 3 forbidden `exclude` categories (control flow minutiae, generic TODOs, broad architecture).

**[index.ts](./index.ts)** — Barrel export re-exporting `PromptContext`, `SUMMARY_GUIDELINES`, `buildFilePrompt`, `buildDirectoryPrompt`, `detectLanguage` from `types.ts` and `builder.ts` to provide unified public interface for `src/generation/executor.ts` and `src/generation/orchestrator.ts`.

## Data Flow

1. `src/generation/executor.ts` calls `buildFilePrompt(context)` with `PromptContext` populated from source file content and optional `projectPlan` from `src/discovery/walker.ts`
2. `buildFilePrompt` selects `FILE_SYSTEM_PROMPT` or `FILE_UPDATE_SYSTEM_PROMPT` based on `context.existingSum` presence, replaces `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}` (via `detectLanguage`), `{{PROJECT_PLAN_SECTION}}` in `FILE_USER_PROMPT`, appends `contextFiles` as fenced blocks and `existingSum` under `## Existing Summary` for updates
3. Prompt pair `{ system, user }` flows to `src/ai/service.ts` → `runSubprocess()` → Claude/Gemini backends for `.sum` generation
4. `src/generation/orchestrator.ts` calls `buildDirectoryPrompt(dirPath, projectRoot, debug, knownDirs, projectStructure, existingAgentsMd)` after file analysis completes
5. `buildDirectoryPrompt` reads all `.sum` files via `readSumFile(getSumPath(entryPath))`, extracts imports via `extractDirectoryImports` for `.ts|.tsx|.js|.jsx|.py|.go|.rs|.java|.kt` files, formats via `formatImportMap`, detects manifests (`package.json`, `Cargo.toml`, etc.), scans for `.annex.sum` files, reads user-authored `AGENTS.local.md` or detects `AGENTS.md` lacking `GENERATED_MARKER`, selects `DIRECTORY_SYSTEM_PROMPT` or `DIRECTORY_UPDATE_SYSTEM_PROMPT`, joins sections with newlines
6. Prompt pair flows to AI backend for `AGENTS.md` generation, enforcing first line `<!-- Generated by agents-reverse-engineer -->` and adaptive sections (Contents, Subdirectories, Architecture, Stack, Behavioral Contracts, etc.)

## Behavioral Contracts

**Placeholder replacement in `FILE_USER_PROMPT`:**
- `{{FILE_PATH}}` → `context.filePath`
- `{{CONTENT}}` → `context.content`
- `{{LANG}}` → `detectLanguage(context.filePath)` (uses `langMap: {'.ts': 'typescript', '.py': 'python', '.rs': 'rust', ...}`)
- `{{PROJECT_PLAN_SECTION}}` → `''` or `\n\n## Project Structure\n\nFull project file listing for context:\n\n<project-structure>\n${context.projectPlan}\n</project-structure>`

**Update mode section appends:**
- File analysis: `\n\n## Existing Summary (update this — preserve stable content, modify only what changed)\n\n${context.existingSum}`
- Directory analysis: `\n\n## Existing AGENTS.md (update this — preserve stable content, modify only what changed)\n\n${existingAgentsMd}`

**Source file regex for import extraction:** `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`

**Annex file detection:** `e.name.endsWith('.annex.sum')`

**Manifest file detection:** `['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']`

**User-defined content detection precedence:**
1. `AGENTS.local.md` exists → read and inject under `## User Notes`
2. `AGENTS.md` exists without `GENERATED_MARKER` → read and inject under `## User Notes`
3. No user content → omit section

**Output format contracts enforced by prompts:**
- File analysis first line: `**Purpose statement here.**` (bold, one paragraph)
- Directory analysis first line: `<!-- Generated by agents-reverse-engineer -->` followed by `#` heading with directory name
- No preamble ("Here is...", "Based on...", "Let me...")
- Every sentence must reference at least one identifier (function/class/type/constant name)
- Ban filler phrases: "this file", "provides", "responsible for", "is used to"

**Density rules:**
- Per-file descriptions in Contents sections: 1-2 sentences maximum
- Subdirectory descriptions: 1-2 sentences maximum
- Behavioral contracts (regex, format specs, constants) in separate section, verbatim from summaries
- Annex references: one line per annex file, link to `.annex.sum`, do not inline content

**Anchor term preservation:** All exported symbols from file summaries must appear in directory overview with exact casing

**Path accuracy mandates:**
- Use only paths from `## Import Map (verified — use these exact paths)` section
- Use exact directory names from `## Project Directory Structure`
- Cross-module references must use specifier format from actual imports (e.g., `"../generation/writers/sum.js"`)
- Omit cross-reference rather than guessing if path unknown

## Reproduction-Critical Constants

Full prompt template text: [templates.annex.sum](./templates.annex.sum)  
Summary guidelines schema: [types.annex.sum](./types.annex.sum)