<!-- Generated by agents-reverse-engineer -->

# generation/prompts

Constructs multi-stage AI prompts for the three-phase documentation pipeline: file-level `.sum` analysis, directory-level `AGENTS.md` synthesis, and root `CLAUDE.md` generation. Each builder function assembles template constants with runtime context (source code, import maps, child documentation, project metadata) to produce system/user prompt pairs consumed by `src/ai/service.ts`.

## Contents

### [builder.ts](./builder.ts)
Exports `buildFilePrompt`, `buildDirectoryPrompt`, and `buildRootPrompt` that replace placeholder tokens (`{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`) in template constants with concrete data. `buildFilePrompt` injects single file content + optional `contextFiles` array into FILE_USER_PROMPT. `buildDirectoryPrompt` aggregates all `.sum` files via `readSumFile`, collects child `AGENTS.md` via `readdir`, generates import map via `extractDirectoryImports` + `formatImportMap`, detects manifest files (package.json/Cargo.toml/go.mod/etc.), and preserves user-authored `AGENTS.local.md`. `buildRootPrompt` calls `collectAgentsDocs` to gather all directory-level documentation and parses root package.json metadata for CLAUDE.md synthesis. Internal `detectLanguage` maps file extensions to syntax highlighting language tags.

### [templates.ts](./templates.ts)
Defines `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, and `ROOT_SYSTEM_PROMPT` constants consumed by builder.ts. FILE_SYSTEM_PROMPT enforces density rules (every sentence references identifiers), anchor term preservation (exact exported names), and bans filler phrases ("this file", "provides"). DIRECTORY_SYSTEM_PROMPT mandates `<!-- Generated by agents-reverse-engineer -->` marker, adaptive section selection (Contents/Subdirectories/Architecture/Stack/Patterns/Configuration/API Surface), path accuracy (use Import Map paths only), and consistency (no self-contradiction). ROOT_SYSTEM_PROMPT constrains AI to synthesize only from provided AGENTS.md content without hallucination. FILE_USER_PROMPT embeds hardcoded project structure tree for cross-file context.

### [types.ts](./types.ts)
Exports `PromptContext` interface with `filePath: string`, `content: string`, `contextFiles?: Array<{path; content}>`, and `projectPlan?: string` fields passed to builder functions. Exports `SUMMARY_GUIDELINES` constant with `targetLength: {min: 200, max: 300}`, `include: string[]` (6 required documentation elements), and `exclude: string[]` (3 forbidden content types) sourced from CONTEXT.md. Consumed by quality validators in `src/quality/`.

### [index.ts](./index.ts)
Barrel export re-exporting `PromptContext`, `SUMMARY_GUIDELINES`, `buildFilePrompt`, `buildDirectoryPrompt`, `buildRootPrompt`, and `detectLanguage` from builder.ts and types.ts. API surface consumed by `src/generation/executor.ts` orchestration logic and `src/cli/` command handlers.

## Prompt Assembly Pipeline

1. **File-level**: `buildFilePrompt` injects single file + optional related files + project plan into FILE_USER_PROMPT → produces .sum summary enforcing identifier density rules
2. **Directory-level**: `buildDirectoryPrompt` reads all child .sum files via `getSumPath` + `readSumFile`, collects subdirectory AGENTS.md via parallel `Promise.all`, filters source files by `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/` regex for import map extraction, detects manifest files, preserves AGENTS.local.md → produces directory AGENTS.md with adaptive sections
3. **Root-level**: `buildRootPrompt` calls `collectAgentsDocs` to aggregate all AGENTS.md + parses package.json metadata → produces root CLAUDE.md synthesis

## Template Placeholder Conventions

Mustache-style placeholders: `{{FILE_PATH}}` (absolute path), `{{CONTENT}}` (raw source code), `{{LANG}}` (detectLanguage result), `{{PROJECT_PLAN_SECTION}}` (optional `<project-structure>` block). Builder functions perform string replacement before passing prompts to `AIService.analyzeFile` or `AIService.analyzeDirectory`.

## Import Map Integration

`buildDirectoryPrompt` filters source files, passes to `extractDirectoryImports` from `src/imports/index.ts`, then formats via `formatImportMap` to generate "Import Map (verified — use these exact paths)" section. Enforces path accuracy: AI must use only documented module specifiers, no invented cross-references.

## User Documentation Preservation

`buildDirectoryPrompt` checks for AGENTS.local.md first; if missing, inspects existing AGENTS.md for absence of `GENERATED_MARKER` (from `src/generation/writers/agents-md.ts`) to detect user-authored content. Embeds user notes with preservation hint: "will be preserved as [AGENTS.local.md](./AGENTS.local.md)".

## Manifest Detection

`buildDirectoryPrompt` detects manifest files: `package.json` (Node.js), `Cargo.toml` (Rust), `go.mod` (Go), `pyproject.toml` (Python), `pom.xml`/`build.gradle` (Java), `Gemfile` (Ruby), `composer.json` (PHP), `CMakeLists.txt`/`Makefile` (C/C++). Embeds manifest content in "Package Manifest" section of directory prompt for stack awareness.

## Debug Logging

`logTemplate(debug, action, filePath, extra?)` emits picocolors-formatted debug logs to stderr when `debug=true`: `[prompt] action → relative/path extra`. Used by builder functions to trace template assembly steps.