<!-- Generated by agents-reverse-engineer -->

# generation/prompts

Prompt construction engine for the three-phase documentation pipeline: `buildFilePrompt()` assembles file analysis prompts with import maps and incremental update sections, `buildDirectoryPrompt()` aggregates child `.sum` files and subdirectory `AGENTS.md` with import maps for directory synthesis, `buildRootPrompt()` collects all `AGENTS.md` files and package.json metadata for root document generation.

## Contents

### Prompt Builders

**[builder.ts](./builder.ts)** — Implements `buildFilePrompt()` with `detectLanguage()` mapping 21 extensions to syntax identifiers, `buildDirectoryPrompt()` aggregating `.sum` files via `readSumFile()` and extracting import maps via `extractDirectoryImports()`, `buildRootPrompt()` calling `collectAgentsDocs()` for project-level synthesis. Substitutes placeholders `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}` in user prompts. Switches between fresh generation prompts (`FILE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`) and update prompts (`FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`) based on `existingSum`/`existingAgentsMd` presence. Preserves user content from `AGENTS.local.md` by appending as `## User Notes` section. Debug logging emits template action/metadata pairs to stderr via `picocolors`.

**[templates.ts](./templates.ts)** — Exports six system prompt constants: `FILE_SYSTEM_PROMPT` enforces density rules (every sentence references specific identifiers), anchor term preservation (exact export name casing), behavioral contract extraction (verbatim regex patterns, format strings, magic constants), `FILE_USER_PROMPT` template with `{{FILE_PATH}}`/`{{CONTENT}}` placeholders, `FILE_UPDATE_SYSTEM_PROMPT` for incremental regeneration preserving unchanged sections, `DIRECTORY_SYSTEM_PROMPT` mandating first line `<!-- Generated by agents-reverse-engineer -->` with adaptive section strategy (Contents/Subdirectories/Architecture/Stack/Structure/Patterns/Configuration/API Surface/File Relationships/Behavioral Contracts), `DIRECTORY_UPDATE_SYSTEM_PROMPT` for directory-level incremental updates, `ROOT_SYSTEM_PROMPT` enforcing synthesis-only mode prohibiting invention of features/hooks/APIs/patterns. All prompts prohibit filler phrases: `"this file"`, `"this module"`, `"provides"`, `"responsible for"`, `"is used to"`.

**[types.ts](./types.ts)** — Defines `PromptContext` interface with fields `filePath`, `content`, `contextFiles[]`, `projectPlan`, `existingSum` for Phase 1/2 builders. Exports `SUMMARY_GUIDELINES` constant object with `targetLength: {min: 300, max: 500}`, `include[]` array of 8 mandatory content categories (purpose, public interface, patterns, dependencies, function signatures, coupled files, behavioral contracts, annex references), `exclude[]` array of 3 prohibited categories (control flow minutiae, generic TODOs, broad architectural relationships).

**[index.ts](./index.ts)** — Barrel module re-exporting `buildFilePrompt`, `buildDirectoryPrompt`, `buildRootPrompt`, `detectLanguage` from `builder.ts` and `PromptContext`, `SUMMARY_GUIDELINES` from `types.ts`. Separates prompt template strings (in `templates.ts`) from assembly logic.

## File Relationships

`builder.ts` consumes templates from `templates.ts` (`FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`, `ROOT_SYSTEM_PROMPT`). `builder.ts` imports `GENERATED_MARKER` from `../writers/agents-md.js` for user content detection, `readSumFile()`/`getSumPath()` from `../writers/sum.js` for child summary aggregation, `extractDirectoryImports()`/`formatImportMap()` from `../../imports/index.js` for dependency graph construction, `collectAgentsDocs()` from `../collector.js` for Phase 3 synthesis. `index.ts` re-exports `PromptContext` from `types.ts` for consumer type safety.

## Incremental Update Strategy

All three builders accept optional existing content: `context.existingSum` in `buildFilePrompt()`, `existingAgentsMd` in `buildDirectoryPrompt()`. When provided, appends existing content under heading `## Existing [Summary|AGENTS.md] (update this — preserve stable content, modify only what changed)` and switches to update-specific system prompts. `FILE_UPDATE_SYSTEM_PROMPT` enforces preservation rules: keep unchanged sections verbatim, modify only content affected by code changes, preserve behavioral contracts (regex/constants) unless source changed them. `DIRECTORY_UPDATE_SYSTEM_PROMPT` preserves structure/headings/descriptions for unchanged files, modifies only entries whose summaries changed, adds/removes entries for new/deleted files.

## User Content Preservation

`buildDirectoryPrompt()` checks for `AGENTS.local.md` first, falling back to checking existing `AGENTS.md` for absence of `GENERATED_MARKER` constant. User content appended as `## User Notes` section with reference link pattern `[AGENTS.local.md](./AGENTS.local.md)`. First-run detection message: "This user-defined content will be preserved as [AGENTS.local.md](./AGENTS.local.md)."

## Behavioral Contracts

All templates enforce:

- **Density rule**: Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)
- **Anchor term preservation**: All exported function/class/type/const names MUST appear in summary exactly as written in source
- **Filler phrase prohibition**: `"this file"`, `"this module"`, `"provides"`, `"responsible for"`, `"is used to"`, `"basically"`, `"essentially"`, `"provides functionality for"`
- **Output format**: Start response DIRECTLY with bold purpose statement without preamble
- **PATH ACCURACY**: Use only paths from "Import Map" section, exact directory names from "Project Directory Structure", no path invention
- **CONSISTENCY**: Do not contradict within same document (e.g., calling technique "regex-based" then "AST-based")

`DIRECTORY_SYSTEM_PROMPT` enforces first line exactly `<!-- Generated by agents-reverse-engineer -->` followed by `#` heading with directory name.

`FILE_SYSTEM_PROMPT` defines REPRODUCTION-CRITICAL CONTENT strategy: files with large string constants should list them in `## Annex References` section rather than inlining content, delegating extraction to pipeline automation.

## Annex References

Full prompt template text: [templates.ts.annex.md](./templates.ts.annex.md)  
PromptContext interface specification: [types.ts.annex.md](./types.ts.annex.md)