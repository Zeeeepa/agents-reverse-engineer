<!-- Generated by agents-reverse-engineer -->

# src/generation/prompts/

**Constructs AI prompts for the three-phase documentation pipeline: buildFilePrompt() generates file analysis prompts with import maps and language detection, buildDirectoryPrompt() aggregates child `.sum` files and subdirectory AGENTS.md with manifest detection, and buildRootPrompt() synthesizes root integration documents from the AGENTS.md corpus with anti-hallucination constraints.**

## Contents

### Prompt Builders

**[builder.ts](./builder.ts)** — Exports buildFilePrompt() which substitutes `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}` placeholders in FILE_USER_PROMPT and calls detectLanguage() for syntax hints; buildDirectoryPrompt() which aggregates child `.sum` files via readSumFile(getSumPath()), embeds extractDirectoryImports() + formatImportMap() for verified import paths, detects 9 manifest types (package.json/Cargo.toml/go.mod/pyproject.toml/etc.) to identify package roots, and preserves user content from AGENTS.local.md or non-generated AGENTS.md; buildRootPrompt() which calls collectAgentsDocs() to gather all AGENTS.md files and parses root package.json metadata. All builders return `{ system: string; user: string }` objects consumed by AIService.call() subprocesses.

**[templates.ts](./templates.ts)** — Exports FILE_SYSTEM_PROMPT and FILE_USER_PROMPT for Phase 1 file analysis (enforces identifier density, anchor term preservation, bold purpose statements without preamble), DIRECTORY_SYSTEM_PROMPT for Phase 2 directory aggregation (requires `<!-- Generated by agents-reverse-engineer -->` marker, adaptive section selection over fixed templates, path accuracy via Import Map constraints forbidding invented cross-module references), and ROOT_SYSTEM_PROMPT for Phase 3 root synthesis (critical synthesis-only constraint prohibiting invention of features/hooks/patterns not in AGENTS.md corpus, mandates raw markdown output without conversational text).

### Type Definitions

**[types.ts](./types.ts)** — Exports PromptContext interface (filePath, content, contextFiles?, projectPlan?) for buildPrompt() argument structure and SUMMARY_GUIDELINES frozen object defining `.sum` generation rules (targetLength: 200-300 words, include: 6 required elements like purpose/exports/patterns/dependencies, exclude: 3 categories like internal details/generic TODOs/broad architecture).

### Public Interface

**[index.ts](./index.ts)** — Re-exports PromptContext, SUMMARY_GUIDELINES from `./types.js` and buildFilePrompt, buildDirectoryPrompt, buildRootPrompt, detectLanguage from `./builder.js` as single entry point for prompt generation consumed by GenerationExecutor in `src/generation/executor.ts`.

## Prompt Construction Patterns

**Template Substitution** — FILE_USER_PROMPT uses mustache-style placeholders (`{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}`) replaced by buildFilePrompt() via string interpolation with detectLanguage() mapping 26 file extensions (`.ts` → `'typescript'`, `.py` → `'python'`) to syntax highlighting identifiers.

**User Content Preservation** — buildDirectoryPrompt() implements two-stage fallback: first checks AGENTS.local.md, then checks existing AGENTS.md without GENERATED_MARKER (`<!-- Generated by agents-reverse-engineer -->`), embeds user content in `## User Notes` section with reference links.

**Manifest Detection** — buildDirectoryPrompt() searches for 9 manifest file types (package.json for npm/pnpm/yarn, Cargo.toml for Rust, go.mod for Go, pyproject.toml for Python, pom.xml for Maven, build.gradle for Gradle, Gemfile for Ruby, composer.json for PHP, CMakeLists.txt/Makefile for C/C++) and appends "likely a package or project root" hint when found.

**Import Map Integration** — buildDirectoryPrompt() filters source files via `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/` regex before calling extractDirectoryImports(), embeds formatImportMap() output with "verified — use these exact paths" annotation to prevent phantom path hallucination in generated AGENTS.md.

## Constraint Enforcement

**Density Rules** — All prompts mandate identifier-rich sentences (every sentence references at least one function/class/type/constant), prohibit filler phrases ("this file", "provides", "responsible for"), enforce technical shorthand ("exports X, Y, Z" over "this module exports a function called X...").

**Anchor Term Preservation** — Require exact exported symbol names with preserved casing from file summaries to appear in directory overviews, discriminate against missing identifiers as failures.

**Path Accuracy** — DIRECTORY_SYSTEM_PROMPT restricts cross-module references to Import Map entries from actual import statements, forbids invented module paths, enforces exact directory names from project structure (e.g., if directory is "cli", write "src/cli/", NOT "src/commands/").

**Synthesis Constraints** — ROOT_SYSTEM_PROMPT limits root document generation to traceability against provided AGENTS.md corpus, prohibits hallucination of features/patterns/dependencies not explicitly mentioned in source documents.

## Debug Logging

All builder functions accept optional `debug` parameter. When enabled, logTemplate() emits picocolors-formatted stderr messages: buildFilePrompt logs `[prompt] buildFilePrompt → ${relativePath} lang=${lang}`, buildDirectoryPrompt logs `[prompt] buildDirectoryPrompt → ${relativePath} files=${count} subdirs=${count} imports=${count}`, buildRootPrompt logs `[prompt] buildRootPrompt → ${relativePath} agents=${count}`. Missing AGENTS.md files logged as `Skipping missing ${path}`.

## Integration with Execution Pipeline

Consumed by GenerationExecutor in `src/generation/executor.ts` during three-phase pipeline: Phase 1 calls buildFilePrompt() for each source file with PromptContext populated from file content and optional contextFiles from import extraction; Phase 2 calls buildDirectoryPrompt() for post-order directory traversal with aggregated child `.sum` files and subdirectory AGENTS.md; Phase 3 calls buildRootPrompt() sequentially for each AI platform template (CLAUDE.md/GEMINI.md/OPENCODE.md). Prompts passed to AIService.call() for subprocess execution with `--disallowedTools Task` flag.