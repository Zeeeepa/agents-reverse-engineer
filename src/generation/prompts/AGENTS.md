<!-- Generated by agents-reverse-engineer -->

# src/generation/prompts

Constructs system/user prompt pairs for the three-phase ARE documentation pipeline (file analysis → directory AGENTS.md → root CLAUDE.md) by injecting source content, existing summaries, project structure, import maps, and child documentation into template constants. Each phase enforces density rules (identifier-rich, no filler phrases), path accuracy (verified import maps only), and behavioral contract preservation (verbatim regex, format specs, magic constants).

## Contents

### Prompt Builders

- [builder.ts](./builder.ts) — `buildFilePrompt`, `buildDirectoryPrompt`, `buildRootPrompt` construct prompts for file/directory/root analysis by embedding context into templates, reading `.sum` files via `readSumFile` + `getSumPath`, extracting import maps via `extractDirectoryImports` + `formatImportMap`, collecting child AGENTS.md via `collectAgentsDocs`, detecting languages via `detectLanguage` (30-extension `langMap`), and switching to update prompts when existing content present
- [index.ts](./index.ts) — barrel re-export of `PromptContext`, `SUMMARY_GUIDELINES`, `buildFilePrompt`, `buildDirectoryPrompt`, `buildRootPrompt`, `detectLanguage` from `types.js` and `builder.js`
- [types.ts](./types.ts) — `PromptContext` interface (filePath, content, contextFiles, projectPlan, existingSum) and `SUMMARY_GUIDELINES` constant (targetLength 300-500 words, include/exclude arrays for required/prohibited content)

### Template Constants

- [templates.ts](./templates.ts) — six prompt constants: `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT` (incremental), `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT` (incremental), `ROOT_SYSTEM_PROMPT`

## Prompt Assembly Flow

1. **File Phase**: `buildFilePrompt` injects filePath, content, detected language (via `detectLanguage`), projectPlan into `FILE_USER_PROMPT` template (`{{FILE_PATH}}`, `{{CONTENT}}` placeholders); appends contextFiles as fenced code blocks; switches to `FILE_UPDATE_SYSTEM_PROMPT` when `context.existingSum` present
2. **Directory Phase**: `buildDirectoryPrompt` reads all `.sum` files in directory via `getSumPath` + `readSumFile`, collects subdirectory AGENTS.md filtered by `knownDirs` set, extracts import map from source files (`.ts|tsx|js|jsx|py|go|rs|java|kt`) via `extractDirectoryImports` + `formatImportMap`, detects manifest files (package.json, Cargo.toml, go.mod, etc.), lists `.annex.md` files, embeds `projectStructure` tree, and includes `AGENTS.local.md` or non-generated AGENTS.md as user notes; switches to `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` present
3. **Root Phase**: `buildRootPrompt` aggregates all AGENTS.md via `collectAgentsDocs`, parses package.json metadata (name, version, description, packageManager, scripts), and embeds output requirements (purpose, architecture, key directories, getting started, technologies) into `ROOT_SYSTEM_PROMPT`

## Incremental Update Strategy

- **File Updates**: `buildFilePrompt` appends existing summary block with header `## Existing Summary (update this — preserve stable content, modify only what changed)` and returns `FILE_UPDATE_SYSTEM_PROMPT` when `context.existingSum` truthy
- **Directory Updates**: `buildDirectoryPrompt` appends existing AGENTS.md block with header `## Existing AGENTS.md (update this — preserve stable content, modify only what changed)` and returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` provided
- **Preservation Rules**: update prompts mandate verbatim preservation of unchanged sections, especially behavioral contracts (regex patterns, format strings, constants), with modifications only where source changed

## User Documentation Handling

`buildDirectoryPrompt` preserves first-run user content by checking for `AGENTS.local.md`; if absent, reads `AGENTS.md` and includes as user notes only if lacking `GENERATED_MARKER` from `writers/agents-md.js`, ensuring user-authored introductions persist across regenerations with reference note `Reference [AGENTS.local.md](./AGENTS.local.md)`.

## File Type Detection

- **Language Map**: `detectLanguage` maps 30 file extensions (ts, tsx, js, jsx, py, go, rs, java, kt, swift, cs, php, vue, svelte, json, yaml, md, css, scss, html, etc.) to syntax highlighting identifiers; returns `'text'` for unknown extensions
- **Source Filtering**: `sourceExtensions` regex `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/` filters files for import extraction in `buildDirectoryPrompt`
- **Manifest Detection**: `manifestNames` array lists package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt, Makefile

## Integration Points

- **Sum File I/O**: delegates to `readSumFile(sumPath)` and `getSumPath(entryPath)` from `../writers/sum.js` to retrieve parsed summaries with `metadata.purpose` and `summary` fields
- **Import Extraction**: calls `extractDirectoryImports(dirPath, sourceFileNames)` and `formatImportMap(fileImports)` from `../../imports/index.js` to build verified cross-reference map
- **AGENTS.md Collection**: invokes `collectAgentsDocs(projectRoot)` from `../collector.js` to gather all AGENTS.md with `relativePath` and `content` for root synthesis
- **Generation Marker**: references `GENERATED_MARKER` from `../writers/agents-md.js` to distinguish user-authored vs. ARE-generated AGENTS.md

## Behavioral Contracts

### Template Placeholders
- `FILE_USER_PROMPT`: `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}`

### Prompt Enforcement Rules
- **Density Mandates**: prohibit filler phrases ("this file", "this module", "provides", "responsible for", "is used to"); require pattern `[ExportName] does X` instead of `The ExportName function is responsible for doing X`; every sentence must reference at least one identifier
- **Path Accuracy**: use only paths from "Import Map" section; cross-module references must use exact import statement specifiers; prohibit path invention or directory renaming
- **Output Format**: file/directory summaries start with bold purpose statement `**Purpose statement here.**`; AGENTS.md files start with `<!-- Generated by agents-reverse-engineer -->`; root CLAUDE.md prohibits conversational text like "Here is...", "I've generated..."
- **Incremental Updates**: `FILE_UPDATE_SYSTEM_PROMPT` and `DIRECTORY_UPDATE_SYSTEM_PROMPT` mandate verbatim preservation of unchanged content, especially behavioral contracts (regex patterns, format strings, magic constants)

### Debug Logging Pattern
- `logTemplate(debug, action, filePath, extra?)`: emits `picocolors`-formatted logs to stderr with pattern `[prompt] action → relativePath extra`

## Reproduction-Critical Constants

Full prompt template text: [templates.ts.annex.md](./templates.ts.annex.md)  
Full SUMMARY_GUIDELINES specification: [types.ts.annex.md](./types.ts.annex.md)