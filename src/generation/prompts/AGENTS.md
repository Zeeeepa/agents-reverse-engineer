<!-- Generated by agents-reverse-engineer -->

# generation/prompts

Prompt construction subsystem assembling LLM system/user message pairs for two-phase documentation pipeline: phase-1 file analysis injects source code, import maps, project structure, compression directives, and existing summaries into `FILE_SYSTEM_PROMPT`/`FILE_USER_PROMPT` templates; phase-2 directory aggregation reads child `.sum` files, extracts import maps via `extractDirectoryImports()`, detects manifests, and renders `DIRECTORY_SYSTEM_PROMPT` with adaptive section selection.

## Contents

**[builder.ts](./builder.ts)** — Constructs prompt pairs via `buildFilePrompt()` (selects `FILE_SYSTEM_PROMPT`/`FILE_UPDATE_SYSTEM_PROMPT` based on `existingSum`, replaces `{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}`/`{{PROJECT_PLAN_SECTION}}` placeholders, injects compression directives when `compressionRatio < 0.5` before `DENSITY RULES (MANDATORY):` marker, appends related files via `context.contextFiles`) and `buildDirectoryPrompt()` (parallel reads child `.sum` via `readSumFile()`, parallel reads child `AGENTS.md`, calls `extractDirectoryImports()` for source files, detects manifest files, returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` + existing content for updates or `DIRECTORY_SYSTEM_PROMPT` for new generation). Exports `detectLanguage()` mapping file extensions to syntax highlighting identifiers via static `langMap`.

**[templates.ts](./templates.ts)** — Defines five exported constants (`FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`) containing LLM prompts enforcing density rules (every sentence references identifiers, no filler phrases), anchor term preservation (exact casing), behavioral contract extraction (regex verbatim in backticks), workflow rule extraction (CONTRIBUTING.md/CI/linter configs), annex overflow handling (large constants in `## Annex References`), path accuracy constraints (reference only Import Map paths), output format mandates (`**Purpose statement.**`, no preamble), incremental update preservation (verbatim unchanged sections).

**[types.ts](./types.ts)** — Exports `PromptContext` interface (`filePath`, `content`, `contextFiles`, `projectPlan`, `existingSum`, `sourceFileSize`, `compressionRatio`) consumed by `buildFilePrompt()`. Exports `SUMMARY_GUIDELINES` constant specifying `.sum` generation rules: `targetLength: {min: 300, max: 500}`, `include` array mandating behavioral contract/annex reference extraction.

**[index.ts](./index.ts)** — Barrel re-export of `buildFilePrompt`, `buildDirectoryPrompt`, `detectLanguage`, `PromptContext`, `SUMMARY_GUIDELINES` public API.

## Architecture

### Two-Prompt Strategy

Phase-1 file analysis: `buildFilePrompt()` selects `FILE_SYSTEM_PROMPT` (new) vs `FILE_UPDATE_SYSTEM_PROMPT` (incremental), constructs user prompt via template string replacement: `FILE_USER_PROMPT.replace(/\{\{FILE_PATH\}\}/g, context.filePath).replace(/\{\{CONTENT\}\}/g, context.content).replace(/\{\{LANG\}\}/g, detectLanguage(context.filePath)).replace(/\{\{PROJECT_PLAN_SECTION\}\}/g, planSection)`. Appends `## Related Files` section via `context.contextFiles.map(f => \`### ${f.path}\n\`\`\`${detectLanguage(f.path)}\n${f.content}\n\`\`\`\`)`. For `compressionRatio < 0.5`, injects `TARGET LENGTH (MANDATORY)` block before `DENSITY RULES` marker. Appends `## Existing Summary (update this — preserve stable content, modify only what changed)` + `context.existingSum` for updates.

Phase-2 directory aggregation: `buildDirectoryPrompt()` reads `readdir()` results, filters `fileEntries = entries.filter(e => e.isFile() && !e.name.endsWith('.sum') && !e.name.startsWith('.'))`, reads `.sum` files via `Promise.all(fileEntries.map(async entry => readSumFile(getSumPath(entry))))`, formats as `### ${entry.name}\n**Purpose:** ${sumContent.metadata.purpose}\n\n${sumContent.summary}`. Reads child `AGENTS.md` via parallel `readFile()`, extracts user-authored `AGENTS.local.md` or detects ARE-generated via `GENERATED_MARKER`. Calls `extractDirectoryImports()` for source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, formats via `formatImportMap()`. Detects manifest files (`manifestNames = ['package.json', 'Cargo.toml', 'go.mod', ...]`). Returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` + existing for updates or `DIRECTORY_SYSTEM_PROMPT` for new.

### Compression Directive Injection

When `context.compressionRatio < 0.5 && context.sourceFileSize > 0`, `buildFilePrompt()` calculates `targetSize = Math.round(sourceFileSize * ratio)`, `maxSize = Math.round(targetSize * 1.2)`, `compressionPercentage = Math.round(ratio * 100)`, injects literal text block before `DENSITY RULES (MANDATORY):` marker:
```
TARGET LENGTH (MANDATORY):
- Source file: ${sourceSize} characters
- Target summary: ~${targetSize} characters (${compressionPercentage}% compression)
- Maximum: ${maxSize} characters
- Achieve this by: ultra-dense writing, minimal examples, single-sentence descriptions

ULTRA-COMPRESSION TECHNIQUES:
- Use telegraphic style: "exports foo, bar, baz" not "this file exports three functions"
- No code examples unless critical to understanding
- One sentence per export maximum
- Omit obvious parameter names ("opts: Options" not "options: Options - configuration object")
- Use abbreviations: "params" not "parameters", "config" not "configuration"
- Skip section if empty (don't write "No special concerns" or "N/A")
```

### Incremental Update Context

`FILE_UPDATE_SYSTEM_PROMPT` and `DIRECTORY_UPDATE_SYSTEM_PROMPT` add preservation rules: keep unchanged sections VERBATIM, modify only sections affected by code changes, preserve behavioral contracts/workflow rules unless source changed them. `buildFilePrompt()` appends existing summary: `user += '\n\n## Existing Summary (update this — preserve stable content, modify only what changed)\n\n' + context.existingSum`. `buildDirectoryPrompt()` appends existing AGENTS.md: `user += '\n\n## Existing AGENTS.md (update this...)\n\n' + existingAgentsMd`.

## Behavioral Contracts

### Language Detection Map
```typescript
const langMap: Record<string, string> = {
  '.ts': 'typescript', '.tsx': 'tsx', '.js': 'javascript', '.jsx': 'jsx',
  '.py': 'python', '.rb': 'ruby', '.go': 'go', '.rs': 'rust',
  '.java': 'java', '.kt': 'kotlin', '.swift': 'swift', '.cs': 'csharp',
  '.php': 'php', '.vue': 'vue', '.svelte': 'svelte', '.json': 'json',
  '.yaml': 'yaml', '.yml': 'yaml', '.md': 'markdown',
  '.css': 'css', '.scss': 'scss', '.html': 'html'
}
```

### Compression Calculation
```javascript
targetSize = Math.round(sourceFileSize * compressionRatio)
maxSize = Math.round(targetSize * 1.2)
compressionPercentage = Math.round(compressionRatio * 100)
```

### Compression Injection Condition
```javascript
compressionRatio < 0.5 && sourceFileSize > 0
```

### Directory Entry Filtering
```javascript
fileEntries = entries.filter(e => e.isFile() && !e.name.endsWith('.sum') && !e.name.startsWith('.'))
dirEntries = entries.filter(e => e.isDirectory() && (!knownDirs || knownDirs.has(relativeDir)))
sourceFiles = fileNames.filter(f => /\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/.test(f))
```

### Manifest Detection
```javascript
manifestNames = ['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']
```

### Template Placeholder Pattern
```javascript
FILE_USER_PROMPT.replace(/\{\{FILE_PATH\}\}/g, context.filePath)
                 .replace(/\{\{CONTENT\}\}/g, context.content)
                 .replace(/\{\{LANG\}\}/g, lang)
                 .replace(/\{\{PROJECT_PLAN_SECTION\}\}/g, planSection)
```

### Output Format Rules (Embedded in Templates)
- **Prohibited preambles**: "Here is...", "Now I'll...", "Based on my analysis...", "Let me create...", "Perfect."
- **Mandatory start**: `**Purpose statement here.**` (bold line, no preceding text)
- **Prohibited phrases**: "this file", "this module", "provides", "responsible for", "is used to", "basically", "essentially"
- **Preferred pattern**: "[ExportName] does X" not "The ExportName function is responsible for doing X"

### Path Accuracy Rules (Embedded in DIRECTORY_SYSTEM_PROMPT)
- **Import Map constraint**: reference only paths present in Import Map section, never invent module paths
- **Directory name preservation**: use exact names from Project Directory Structure (e.g., "src/cli/" NOT "src/commands/")

### Incremental Update Preservation (Embedded in UPDATE_SYSTEM_PROMPT Variants)
- **Verbatim preservation**: keep unchanged sections VERBATIM, do not rephrase/reorganize
- **Behavioral contract stability**: preserve regex patterns/constants/format strings unless source code changed them
- **Workflow rule stability**: preserve contribution guidelines/PR conventions/code conventions unless source changed them

## Reproduction-Critical Constants

Full prompt template text (6700 chars `FILE_SYSTEM_PROMPT`, 2500 chars `FILE_USER_PROMPT`, 5200 chars `DIRECTORY_SYSTEM_PROMPT`, 3000 chars `FILE_UPDATE_SYSTEM_PROMPT`, 3900 chars `DIRECTORY_UPDATE_SYSTEM_PROMPT`): [templates.annex.sum](./templates.annex.sum)