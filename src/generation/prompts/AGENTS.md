<!-- Generated by agents-reverse-engineer -->

# generation/prompts

**This directory exports `buildFilePrompt()`, `buildDirectoryPrompt()`, `buildRootPrompt()` for constructing system+user prompt pairs fed to AI CLI subprocesses during three-phase documentation generation: per-file `.sum` analysis, directory-level `AGENTS.md` aggregation, and root integration document synthesis (`CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`).**

## Contents

### [builder.ts](./builder.ts)
Implements `buildFilePrompt()` (substitutes `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}` placeholders, appends contextFiles, selects `FILE_UPDATE_SYSTEM_PROMPT` when `context.existingSum` present), `buildDirectoryPrompt()` (reads `.sum` files via `readSumFile()`, collects child `AGENTS.md`, extracts imports via `extractDirectoryImports()`, detects 9 manifest types: `package.json`, `Cargo.toml`, `go.mod`, `pyproject.toml`, `pom.xml`, `build.gradle`, `Gemfile`, `composer.json`, `CMakeLists.txt`, `Makefile`), `buildRootPrompt()` (calls `collectAgentsDocs()`, parses root `package.json`, embeds synthesis constraints), and `detectLanguage()` (maps 22 file extensions to syntax identifiers).

### [index.ts](./index.ts)
Barrel export re-exporting `PromptContext`, `SUMMARY_GUIDELINES`, `buildFilePrompt()`, `buildDirectoryPrompt()`, `buildRootPrompt()`, `detectLanguage()` from `types.ts` and `builder.ts` to form public API consumed by `src/generation/executor.ts`.

### [templates.ts](./templates.ts)
Defines `FILE_SYSTEM_PROMPT` (density rules, anchor term preservation, behavioral contract extraction), `FILE_USER_PROMPT` (placeholders: `{{FILE_PATH}}`, `{{CONTENT}}`), `DIRECTORY_SYSTEM_PROMPT` (path accuracy constraints, adaptive section selection), `FILE_UPDATE_SYSTEM_PROMPT` (incremental preservation directives), `DIRECTORY_UPDATE_SYSTEM_PROMPT` (structure preservation), `ROOT_SYSTEM_PROMPT` (synthesis constraints forbidding invention).

### [types.ts](./types.ts)
Exports `PromptContext` (fields: `filePath`, `content`, `contextFiles`, `projectPlan`, `existingSum`) consumed by prompt builders and `SUMMARY_GUIDELINES` (targetLength: 300-500 words, include array mandating behavioral contracts: verbatim regex patterns, format strings, magic constants, sentinel values, environment variables).

## Architecture

### Three-Phase Prompt Construction

**Phase 1: File Analysis**  
`buildFilePrompt()` receives `PromptContext`, detects language via extension lookup (`detectLanguage()`), substitutes placeholders in `FILE_USER_PROMPT` template, appends related files section when `contextFiles` populated, selects `FILE_UPDATE_SYSTEM_PROMPT` for incremental updates (when `existingSum` present) or `FILE_SYSTEM_PROMPT` for fresh analysis.

**Phase 2: Directory Aggregation**  
`buildDirectoryPrompt()` reads directory via `readdir()`, filters against `knownDirs` set (skips non-source directories), reads `.sum` files in parallel via `Promise.all(readSumFile(getSumPath(entryPath)))`, collects child `AGENTS.md`, extracts imports from source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/` via `extractDirectoryImports()`, detects manifest files, checks for user documentation (AGENTS.local.md or non-generated AGENTS.md lacking `GENERATED_MARKER`), assembles sections: file summaries, import map via `formatImportMap()`, project structure, subdirectories, directory hints, user notes, existing AGENTS.md (update mode), returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` supplied.

**Phase 3: Root Synthesis**  
`buildRootPrompt()` calls `collectAgentsDocs()` to recursively gather all `AGENTS.md` files, reads root `package.json` and extracts metadata (name, version, description, packageManager, scripts), embeds all AGENTS.md content as `### ${relativePath}` sections, appends package metadata, includes synthesis constraint: "Use ONLY the information provided below. Do NOT invent features, hooks, patterns, or APIs that are not explicitly mentioned in the AGENTS.md content."

### Template Substitution Pattern

All prompts follow structure: system prompt (behavioral constraints) + user prompt (context injection). Builder functions perform string interpolation with runtime data:
- `buildFilePrompt()` injects file path, source code, language identifier, project plan section
- `buildDirectoryPrompt()` injects `.sum` summaries, import maps, child AGENTS.md, manifest hints, user notes
- `buildRootPrompt()` injects all AGENTS.md content, package metadata, output requirements checklist

## Behavioral Contracts

### Density Rules (FILE_SYSTEM_PROMPT)
`"Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)"`. Banned filler phrases: `"this file", "this module", "provides", "responsible for", "is used to", "basically", "essentially", "provides functionality for"`.

### Anchor Term Preservation (FILE_SYSTEM_PROMPT)
`"All exported function/class/type/const names MUST appear in the summary exactly as written in source"`, `"Preserve exact casing of identifiers"`, `"Missing any exported identifier is a failure"`.

### Output Format Requirements (FILE_SYSTEM_PROMPT, DIRECTORY_SYSTEM_PROMPT)
`"Start your response DIRECTLY with the purpose statement"` for file prompts. `"Output ONLY the raw markdown content. No code fences, no preamble"` for directory prompts. `"First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->"` for AGENTS.md.

### Behavioral Contract Extraction (FILE_SYSTEM_PROMPT)
Required captures: `"Regex patterns for parsing/validation/extraction — include the full pattern verbatim in backticks"`, `"Format strings, output templates, serialization structures — show exact format"`, `"Magic constants, sentinel values, numeric thresholds (timeouts, buffer sizes, retry counts)"`, `"Prompt text or template strings that control AI/LLM behavior"`, `"Error message patterns and error code strings"`, `"Environment variable names and their expected values"`, `"File format specifications (YAML frontmatter schemas, NDJSON line formats)"`.

### Path Accuracy Constraints (DIRECTORY_SYSTEM_PROMPT)
`"When referencing files or modules outside this directory, use ONLY paths from the 'Import Map' section"`, `"Do NOT invent, rename, or guess module paths"`, `"Use the exact directory names from 'Project Directory Structure' — do NOT rename directories"`, `"Cross-module references must use the specifier format from actual import statements"`, `"If you are unsure about a path, omit the cross-reference rather than guessing"`.

### Incremental Update Preservation (FILE_UPDATE_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT)
`"Preserve the structure, section headings, and phrasing of the existing summary wherever the underlying code is unchanged"`, `"Only modify content that is directly affected by the code changes"`, `"Regex patterns, format strings, magic constants, and template content from the existing summary MUST be preserved verbatim unless the source code changed them"`, `"Never summarize or paraphrase regex patterns — always show the exact pattern in backticks"`.

### Root Synthesis Constraints (ROOT_SYSTEM_PROMPT)
`"Synthesize ONLY from the AGENTS.md content provided in the user prompt"`, `"Do NOT invent, extrapolate, or hallucinate features, hooks, APIs, patterns, or dependencies not explicitly mentioned"`, `"Every claim must be traceable to a specific AGENTS.md file provided"`.

### Source File Extension Filter (builder.ts)
`/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/` — only files matching these extensions processed by `extractDirectoryImports()` for import map generation.

### Manifest Detection Pattern (builder.ts)
`['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']` — presence triggers "likely a package or project root" hint in directory prompts.

### Language Extension Map (builder.ts detectLanguage())
22 extensions: `.ts` → `'typescript'`, `.tsx` → `'tsx'`, `.js` → `'javascript'`, `.jsx` → `'jsx'`, `.py` → `'python'`, `.rb` → `'ruby'`, `.go` → `'go'`, `.rs` → `'rust'`, `.java` → `'java'`, `.kt` → `'kotlin'`, `.swift` → `'swift'`, `.cs` → `'csharp'`, `.php` → `'php'`, `.vue` → `'vue'`, `.svelte` → `'svelte'`, `.json` → `'json'`, `.yaml`/`.yml` → `'yaml'`, `.md` → `'markdown'`, `.css` → `'css'`, `.scss` → `'scss'`, `.html` → `'html'`. Defaults to `'text'`.

## File Relationships

`builder.ts` calls `readSumFile()` + `getSumPath()` from `../writers/sum.js` to retrieve `.sum` frontmatter+content, references `GENERATED_MARKER` from `../writers/agents-md.js` to detect user-authored vs. generated AGENTS.md, invokes `extractDirectoryImports()` + `formatImportMap()` from `../../imports/index.js` for verified import maps, calls `collectAgentsDocs()` from `../collector.js` to aggregate AGENTS.md recursively. `templates.ts` provides raw prompt text consumed by `builder.ts` via import. `types.ts` defines `PromptContext` structure threaded through `builder.ts` functions. `index.ts` re-exports public API consumed by `src/generation/executor.ts` during three-phase pipeline execution.

## Integration Points

Consumed by `src/generation/executor.ts` which invokes prompt builders during phase execution: `buildFilePrompt()` called for each file in Phase 1 concurrent pool, `buildDirectoryPrompt()` called for each directory in Phase 2 post-order traversal, `buildRootPrompt()` called once per root document in Phase 3 sequential execution. Prompts passed as `{ system, user }` pairs to `AIService.call()` in `src/ai/service.ts` which spawns CLI subprocesses (`claude`, `gemini`, `opencode`) with resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`, `--disallowedTools Task`).