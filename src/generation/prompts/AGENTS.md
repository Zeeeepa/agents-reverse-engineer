<!-- Generated by agents-reverse-engineer -->

# src/generation/prompts

Prompt construction subsystem implementing dual-mode (new/update) template expansion for file analysis and directory aggregation phases. Exports `buildFilePrompt()` and `buildDirectoryPrompt()` with placeholder injection, incremental update logic, import map generation, and manifest detection.

## Contents

**[builder.ts](./builder.ts)** — `buildFilePrompt(context)` returns `{system, user}` prompt pairs, applies `FILE_UPDATE_SYSTEM_PROMPT` when `context.existingSum` present, replaces `{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}`/`{{PROJECT_PLAN_SECTION}}` placeholders, appends `contextFiles` as fenced code blocks, injects existingSum under update header. `buildDirectoryPrompt(dirPath)` reads child `.sum` and `AGENTS.md` files in parallel via `readSumFile()`, extracts `AGENTS.local.md`, calls `extractDirectoryImports()` for `.ts/.tsx/.js/.jsx/.py/.go/.rs/.java/.kt` files, scans manifests (`package.json`, `Cargo.toml`, `go.mod`, `pyproject.toml`, `pom.xml`, `build.gradle`, `Gemfile`, `composer.json`, `CMakeLists.txt`, `Makefile`), formats import map via `formatImportMap()`, lists `.annex.sum` files, applies `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` supplied. `detectLanguage(filePath)` maps extensions to syntax highlighting identifiers via `langMap` (`.ts` → `'typescript'`, `.py` → `'python'`, `.rs` → `'rust'`, fallback `'text'`).

**[index.ts](./index.ts)** — Barrel export aggregating `PromptContext` type, `SUMMARY_GUIDELINES` constant, `buildFilePrompt()`, `buildDirectoryPrompt()`, `detectLanguage()` from `types.ts` and `builder.ts`. Consumed by `src/generation/executor.ts` and `src/generation/orchestrator.ts` during two-phase documentation generation.

**[templates.ts](./templates.ts)** — Six prompt constants (`FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`) defining output format rules (no preamble, bold first-line purpose statement, raw markdown for directories), density mandates (every sentence references identifier, ban "this file"/"provides"), anchor term preservation (exact casing), behavioral contract sections (verbatim regex/constants/templates), annex overflow mechanism (companion `.annex.sum` for large constants), path accuracy requirements (use Import Map paths, no invented references), incremental update rules (preserve unchanged structure, modify only affected sections). Full content: [templates.annex.sum](./templates.annex.sum).

**[types.ts](./types.ts)** — `PromptContext` interface defines `filePath`, `content`, `contextFiles`, `projectPlan`, `existingSum` fields passed to builders. `SUMMARY_GUIDELINES` object specifies `targetLength: {min: 300, max: 500}`, `include` array (8 categories: purpose, public interface, patterns, dependencies, signatures, coupled files, behavioral contracts, annex references), `exclude` array (control flow minutiae, generic TODOs, broad architecture). Full definition: [types.annex.sum](./types.annex.sum).

## Architecture

**Prompt Construction Pipeline**: `buildFilePrompt(context)` → template selection (`FILE_SYSTEM_PROMPT` or `FILE_UPDATE_SYSTEM_PROMPT`) → placeholder replacement → context injection → `{system, user}` pair returned to `src/generation/executor.ts` → `AIService.call(prompt.system, prompt.user)` → subprocess spawn. Directory prompts follow parallel-read pattern: `buildDirectoryPrompt(dirPath)` → `Promise.all(readSumFile(), readFile('AGENTS.md'))` → import extraction via `extractDirectoryImports()` → manifest detection → section assembly → template application.

**Incremental Update Strategy**: When `context.existingSum` or `existingAgentsMd` present, switches to update-specific system prompts (`FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`) enforcing preservation rules. Appends existing content under `## Existing Summary (update this — preserve stable content, modify only what changed)` or `## Existing AGENTS.md (...)` header. Consumed by `src/update/orchestrator.ts` during staleness-driven regeneration.

**User Content Integration**: `buildDirectoryPrompt()` checks `AGENTS.local.md` first, falls back to user-authored `AGENTS.md` (lacking `GENERATED_MARKER`), includes under `## User Notes`. System prompts specify: user notes automatically prepended to output, do NOT repeat in generated content, may reference for context.

## Behavioral Contracts

### Placeholder Patterns (FILE_USER_PROMPT)
```
{{FILE_PATH}} → context.filePath
{{CONTENT}} → context.content
{{LANG}} → detectLanguage(context.filePath)
{{PROJECT_PLAN_SECTION}} → context.projectPlan ? `\n\n## Project Structure\n\n...\n` : ''
```

### Source File Regex (Import Extraction)
```regex
/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/
```

### Annex File Detection
```javascript
e.name.endsWith('.annex.sum')
```

### User Content Detection Priority
1. `AGENTS.local.md` if exists
2. `AGENTS.md` lacking `GENERATED_MARKER`

### Directory Section Ordering
```javascript
[
  '# ' + dirName,
  purposeStatement,
  '## Import Map (verified — use these exact paths)',
  '## Directory Hints',
  '## Contents',
  '## Annex Files (reproduction-critical constants)',
  '## User Notes',
  projectStructure
].join('\n')
```

### Language Map (detectLanguage)
```typescript
{ ts: 'typescript', tsx: 'typescript', js: 'javascript', jsx: 'javascript',
  py: 'python', rs: 'rust', go: 'go', java: 'java', kt: 'kotlin',
  rb: 'ruby', php: 'php', c: 'c', cpp: 'cpp', cs: 'csharp',
  swift: 'swift', sh: 'bash', yaml: 'yaml', yml: 'yaml',
  json: 'json', md: 'markdown', txt: 'text' }
```

### Manifest File Patterns
```javascript
['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml',
 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']
```

## Annex References

Full prompt template text: [templates.annex.sum](./templates.annex.sum)
Full type definitions and SUMMARY_GUIDELINES: [types.annex.sum](./types.annex.sum)