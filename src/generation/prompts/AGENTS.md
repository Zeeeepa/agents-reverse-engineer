<!-- Generated by agents-reverse-engineer -->

# generation/prompts

Exports prompt builders for the three-phase AI-driven documentation pipeline: `buildFilePrompt` constructs Phase 1 per-file `.sum` analysis prompts with import context and incremental update support, `buildDirectoryPrompt` aggregates child summaries into Phase 2 `AGENTS.md` synthesis prompts with manifest detection and import maps, `buildRootPrompt` collects all `AGENTS.md` files for Phase 3 platform-specific root document generation.

## Contents

### Core Prompt Builders

**[builder.ts](./builder.ts)** — Implements `buildFilePrompt()` reading `PromptContext.filePath`/`content`/`contextFiles`/`existingSum`, calls `detectLanguage()` for syntax highlighting, replaces placeholders in `FILE_USER_PROMPT`, appends import context and existing summaries for incremental updates switching to `FILE_UPDATE_SYSTEM_PROMPT`; `buildDirectoryPrompt()` enumerates directory via `readdir()`, reads `.sum` files in parallel via `getSumPath()` + `readSumFile()`, detects 9 manifest types (package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile), calls `extractDirectoryImports()` for source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, appends user documentation from `AGENTS.local.md` or non-generated `AGENTS.md` (missing `GENERATED_MARKER`), switches to `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` present; `buildRootPrompt()` calls `collectAgentsDocs()` for recursive `AGENTS.md` aggregation, reads root `package.json` via `readFile()`, extracts `name`/`version`/`description`/`packageManager`/`scripts`, enforces synthesis-only constraint prohibiting invention of features/hooks/patterns; `detectLanguage()` maps file extensions to 20 syntax highlighting identifiers via hardcoded `langMap` (`.ts` → `typescript`, `.py` → `python`, `.rs` → `rust`, etc.), defaults to `'text'` for unmapped types.

**[templates.ts](./templates.ts)** — Exports `FILE_SYSTEM_PROMPT` enforcing density rules (every sentence references identifiers, ban filler phrases "this file"/"provides"/"responsible for"), anchor term preservation (exact casing of exported symbols), adaptive documentation topics (public interface, algorithms, data structures, integration points, configuration, error handling, concurrency, lifecycle, domain patterns); `FILE_USER_PROMPT` template with `{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}` placeholders and embedded project structure tree (37 directories, 68 files); `FILE_UPDATE_SYSTEM_PROMPT` adding incremental rules (preserve structure/headings/phrasing where code unchanged, modify only affected content, update signatures/types to match source); `DIRECTORY_SYSTEM_PROMPT` mandating `<!-- Generated by agents-reverse-engineer -->` marker followed by `#` heading and one-paragraph purpose, specifying adaptive sections (Contents with `[filename](./filename)` links, Subdirectories with `[dirname/](./dirname/)` summaries, Architecture/Data Flow, Stack, Structure, Patterns, Configuration, API Surface, File Relationships), enforcing path accuracy (use only Import Map paths, exact directory names from Project Directory Structure, actual import specifiers), consistency (no self-contradiction, no technique renaming, use only summary values), scope (navigational index for finding files quickly); `DIRECTORY_UPDATE_SYSTEM_PROMPT` adding incremental rules (preserve accurate structure/headings/descriptions, modify only changed entries, add/remove for new/deleted files, avoid reorganizing unaffected sections); `ROOT_SYSTEM_PROMPT` mandating raw markdown output only (no preamble/meta-commentary), synthesize-only constraint (no invention/extrapolation/hallucination, every claim traceable to AGENTS.md, omit missing sections).

**[types.ts](./types.ts)** — Defines `PromptContext` interface with `filePath: string`, `content: string`, `contextFiles?: Array<{ path: string; content: string }>`, `projectPlan?: string`, `existingSum?: string`; exports `SUMMARY_GUIDELINES` frozen object with `targetLength: { min: 200, max: 300 }`, `include: string[]` array (6 entries: purpose statement, public interface, patterns/algorithms, dependencies with usage context, function signatures, tightly coupled siblings), `exclude: string[]` array (3 entries: internal implementation, generic TODOs/FIXMEs, broad architectural relationships).

**[index.ts](./index.ts)** — Barrel re-export module exposing `buildFilePrompt`, `buildDirectoryPrompt`, `buildRootPrompt`, `detectLanguage` from `./builder.js`, `PromptContext`, `SUMMARY_GUIDELINES` from `./types.js`.

## File Relationships

`builder.ts` imports `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`, `ROOT_SYSTEM_PROMPT` from `./templates.js`, calls `readSumFile()`/`getSumPath()` from `../writers/sum.js`, `GENERATED_MARKER` from `../writers/agents-md.js`, `extractDirectoryImports()`/`formatImportMap()` from `../../imports/index.js`, `collectAgentsDocs()` from `../collector.js`. Consumed by `src/generation/executor.ts` orchestrating three-phase pipeline via worker pool: Phase 1 uses `buildFilePrompt()` with import maps from `src/imports/extractor.ts`, Phase 2 uses `buildDirectoryPrompt()` with aggregated child `.sum` content, Phase 3 uses `buildRootPrompt()` with collected `AGENTS.md` files from `src/generation/collector.ts`. Guidelines in `SUMMARY_GUIDELINES` enforced by quality validators: `src/quality/inconsistency/code-vs-doc.ts` extracts exports via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, `src/quality/phantom-paths/validator.ts` resolves path references in `AGENTS.md` via `existsSync()`.

## Incremental Update Strategy

`buildFilePrompt()` and `buildDirectoryPrompt()` switch to update-specific system prompts (`FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`) when `existingSum` or `existingAgentsMd` detected. Update prompts instruct: "preserve stable content, modify only what changed" via explicit rules (preserve structure/headings/phrasing verbatim where code unchanged, add/remove sections only when code introduces/deletes concepts, update signatures/types/identifiers to match current source exactly). Reduces unnecessary rewrites during `are update` workflow minimizing version control churn.

## User Documentation Preservation

`buildDirectoryPrompt()` checks for `AGENTS.local.md` first, falls back to non-generated `AGENTS.md` (files missing `GENERATED_MARKER` constant `<!-- Generated by agents-reverse-engineer -->`). Appends user content as "User Notes" section with file reference. First-run detection renames user `AGENTS.md` → `AGENTS.local.md` (handled by caller in `src/generation/writers/agents-md.ts`, not this module). User notes automatically prepended to output by templates, prompt builders instructed not to repeat/paraphrase them in generated content.

## Debug Logging

Internal `logTemplate()` function in `builder.ts` logs when `debug=true` via `console.error()` with `picocolors.dim()` formatting. Outputs: `[prompt] buildFilePrompt → path lang=typescript`, `[prompt] buildDirectoryPrompt → path files=5 subdirs=2 imports=8` to reduce visual noise during pipeline execution.