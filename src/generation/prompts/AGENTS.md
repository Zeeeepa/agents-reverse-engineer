<!-- Generated by agents-reverse-engineer v0.8.4 -->

# src/generation/prompts

Assembles LLM prompts for two-phase documentation generation: phase-1 file analysis via `buildFilePrompt()` (injects source code, import maps, compression directives, existing summaries) and phase-2 directory aggregation via `buildDirectoryPrompt()` (parallel `.sum` reads, child `AGENTS.md` ingestion, manifest detection). Enforces density mandates, behavioral contract extraction, path accuracy, and incremental update preservation via five template constants (`FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`).

## Contents

### builder.ts

[builder.ts](./builder.ts) — Implements `buildFilePrompt()` (selects `FILE_SYSTEM_PROMPT` vs `FILE_UPDATE_SYSTEM_PROMPT`, replaces `{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}` placeholders, appends `context.contextFiles`, injects aggressive compression directives when `compressionRatio < 0.5`, appends `existingSum` for updates), `buildDirectoryPrompt()` (parallel reads of child `.sum` via `readSumFile()`, child `AGENTS.md` via `readFile()`, extracts `AGENTS.local.md` when lacking `GENERATED_MARKER_PREFIX`, calls `extractDirectoryImports()` + `formatImportMap()`, detects manifests `package.json`/`Cargo.toml`/`go.mod`, lists `.annex.sum` files, returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` provided), `detectLanguage()` (maps `.ts`→`'typescript'`, `.py`→`'python'` via static `langMap`), `logTemplate()` (emits debug log `[prompt] ${action} → ${relativePath}`).

### index.ts

[index.ts](./index.ts) — Barrel export: re-exports `buildFilePrompt`, `buildDirectoryPrompt`, `detectLanguage`, `PromptContext`, `SUMMARY_GUIDELINES` from `builder.ts` and `types.ts` for `src/generation/orchestrator.ts` consumption.

### templates.ts

[templates.ts](./templates.ts) — Exports five prompt template constants: `FILE_SYSTEM_PROMPT` (initial file analysis with density rules, anchor term preservation, behavioral contract extraction, workflow rule extraction, annex overflow handling), `FILE_USER_PROMPT` (`{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}` placeholders, static project structure tree), `DIRECTORY_SYSTEM_PROMPT` (adaptive section selection, path accuracy rules, user notes handling), `FILE_UPDATE_SYSTEM_PROMPT` (incremental updates with verbatim preservation, behavioral contract stability, workflow rule stability), `DIRECTORY_UPDATE_SYSTEM_PROMPT` (incremental directory updates with section preservation logic). Consumed by `builder.ts` via named imports.

### types.ts

[types.ts](./types.ts) — Defines `PromptContext` interface (`filePath`, `content`, `contextFiles`, `existingSum`, `sourceFileSize`, `compressionRatio`) and `SUMMARY_GUIDELINES` constant (`targetLength: {min: 300, max: 500}`, `include: string[]` mandating regex/constants/annex references, `exclude: string[]`).

## Architecture

### Prompt Assembly Pipeline

`buildFilePrompt()` constructs user prompt via template string replacement: `FILE_USER_PROMPT.replace(/\{\{FILE_PATH\}\}/g, context.filePath).replace(/\{\{CONTENT\}\}/g, context.content).replace(/\{\{LANG\}\}/g, detectLanguage(context.filePath))`. Appends `## Related Files` via `context.contextFiles.map(f => '### ${f.path}\n```${detectLanguage(f.path)}\n${f.content}\n```').join('\n')`. Injects compression directives before `DENSITY RULES (MANDATORY):` when `context.compressionRatio < 0.5 && context.sourceFileSize > 0`: `TARGET LENGTH: ~${targetSize} chars (${compressionPercentage}% compression), MAX: ${maxSize}`, `ULTRA-COMPRESSION TECHNIQUES: telegraphic style, no examples, one sentence per export, abbreviations`. Appends `## Existing Summary (update this — preserve stable content)` + `context.existingSum` for incremental updates. Selects `FILE_UPDATE_SYSTEM_PROMPT` when `existingSum` provided, else `FILE_SYSTEM_PROMPT`.

`buildDirectoryPrompt()` assembles user sections: `['Generate AGENTS.md for directory: "${relativePath}" (${dirName})', '## File Summaries (${count} files)', ...summaries, '## Import Map (verified)', importMapText, '## Project Directory Structure', projectStructure, '## Subdirectories', ...subdirSections, '## Directory Hints', manifestHint, localSection, annexSection, '## Existing AGENTS.md', existingAgentsMd]`. Reads `.sum` frontmatter via parallel `Promise.all(fileEntries.map(entry => readSumFile(getSumPath(entry))))`, formats as `### ${entry.name}\n**Purpose:** ${sumContent.metadata.purpose}\n\n${sumContent.summary}`. Reads child `AGENTS.md` via parallel `Promise.all(dirEntries.map(entry => readFile(childAgentsPath, 'utf-8')))`. Detects manifests via `manifestNames = ['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']`. Lists `.annex.sum` files via `entries.filter(e => e.isFile() && e.name.endsWith('.annex.sum'))`. Returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` provided, else `DIRECTORY_SYSTEM_PROMPT`.

### Context Extraction

`buildDirectoryPrompt()` filters `readdir()` results: `fileEntries = entries.filter(e => e.isFile() && !e.name.endsWith('.sum') && !e.name.startsWith('.'))`, `dirEntries = entries.filter(e => e.isDirectory() && (!knownDirs || knownDirs.has(relativeDir)))`. Calls `extractDirectoryImports(dirPath, fileEntries.map(e => e.name))` for source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, formats via `formatImportMap()`. Extracts user-authored `AGENTS.local.md` or `AGENTS.md` lacking `GENERATED_MARKER_PREFIX`.

## Behavioral Contracts

### Compression Calculation

```javascript
// When context.compressionRatio < 0.5 && context.sourceFileSize > 0
targetSize = Math.round(sourceFileSize * compressionRatio)
maxSize = Math.round(targetSize * 1.2)
compressionPercentage = Math.round(compressionRatio * 100)
```

Injected before `DENSITY RULES (MANDATORY):` marker in user prompt:

```
TARGET LENGTH (MANDATORY):
- Source file: ${sourceSize} characters
- Target summary: ~${targetSize} characters (${compressionPercentage}% compression)
- Maximum: ${maxSize} characters

ULTRA-COMPRESSION TECHNIQUES:
- Telegraphic style: "exports foo, bar, baz" not "this file exports three functions"
- No code examples unless critical
- One sentence per export maximum
- Omit obvious parameter names
- Abbreviations: "params" not "parameters"
- Skip empty sections
```

### Language Detection

```typescript
const langMap: Record<string, string> = {
  '.ts': 'typescript', '.tsx': 'tsx', '.js': 'javascript', '.jsx': 'jsx',
  '.py': 'python', '.rb': 'ruby', '.go': 'go', '.rs': 'rust',
  '.java': 'java', '.kt': 'kotlin', '.swift': 'swift', '.cs': 'csharp',
  '.php': 'php', '.vue': 'vue', '.svelte': 'svelte',
  '.json': 'json', '.yaml': 'yaml', '.yml': 'yaml', '.md': 'markdown',
  '.css': 'css', '.scss': 'scss', '.html': 'html'
}
// detectLanguage(filePath) returns langMap[extname(filePath)] ?? 'text'
```

### Directory Context Filtering

```javascript
// buildDirectoryPrompt() filters readdir() results
fileEntries = entries.filter(e => 
  e.isFile() && !e.name.endsWith('.sum') && !e.name.startsWith('.')
)
dirEntries = entries.filter(e => 
  e.isDirectory() && (!knownDirs || knownDirs.has(relativeDir))
)
```

### Manifest Detection

```javascript
manifestNames = [
  'package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml',
  'pom.xml', 'build.gradle', 'Gemfile', 'composer.json',
  'CMakeLists.txt', 'Makefile'
]
```

### Template Placeholder Replacement

```javascript
FILE_USER_PROMPT
  .replace(/\{\{FILE_PATH\}\}/g, context.filePath)
  .replace(/\{\{CONTENT\}\}/g, context.content)
  .replace(/\{\{LANG\}\}/g, detectLanguage(context.filePath))
```

### Summary Guidelines

```typescript
SUMMARY_GUIDELINES = {
  targetLength: { min: 300, max: 500 },
  include: [
    'Behavioral contracts: verbatim regex patterns, format strings, magic constants',
    'Annex references: list each constant name with one-line description'
  ],
  exclude: []
}
```

## Annex References

- [builder.annex.sum](./builder.annex.sum) — Implementation details of `buildFilePrompt()` and `buildDirectoryPrompt()` prompt assembly logic
- [templates.annex.sum](./templates.annex.sum) — Full text of `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT` constants
- [types.annex.sum](./types.annex.sum) — Complete `PromptContext` interface definition and `SUMMARY_GUIDELINES` object structure