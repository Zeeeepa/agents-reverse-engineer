<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/generation/prompts

Constructs system/user prompt pairs for LLM-driven file analysis (`.sum` generation) and directory synthesis (`AGENTS.md` generation) by combining template constants, source content, import maps, compression heuristics, and incremental update rules.

## Contents

- [`builder.ts`](./builder.ts): Exports `buildFilePrompt(context: PromptContext): {system: string, user: string}` (assembles file analysis prompt from `FILE_SYSTEM_PROMPT`/`FILE_USER_PROMPT`, injects compression rules when `context.compressionRatio < 0.5`, appends existing summary for updates), `buildDirectoryPrompt(dirPath, projectRoot, debug?, knownDirs?, projectStructure?, existingAgentsMd?, logger?, variant?): Promise<{system: string, user: string}>` (reads all `.sum` files, child `AGENTS.md`, `AGENTS.local.md`, extracts import map, detects manifest files, scans `.annex.sum`, uses `DIRECTORY_UPDATE_SYSTEM_PROMPT` for updates), `detectLanguage(filePath: string): string` (maps 20+ file extensions to syntax identifiers: `.ts`→`'typescript'`, `.py`→`'python'`, `.rs`→`'rust'`, defaults to `'text'`).
- [`index.ts`](./index.ts): Barrel re-export providing `PromptContext` type, `SUMMARY_GUIDELINES` const, `buildFilePrompt`, `buildDirectoryPrompt`, `detectLanguage` to orchestration layer (`orchestration/pool.ts`, Phase 2 directory synthesis).
- [`templates.ts`](./templates.ts): Defines five prompt constants: `FILE_SYSTEM_PROMPT` (initial file analysis with density/anchor term/behavioral contract rules), `FILE_USER_PROMPT` (template with `{{FILE_PATH}}`/`{{CONTENT}}` placeholders), `DIRECTORY_SYSTEM_PROMPT` (initial `AGENTS.md` generation with path accuracy/adaptive section rules, `<!-- Generated by agents-reverse-engineer -->` sentinel), `FILE_UPDATE_SYSTEM_PROMPT` (incremental file updates enforcing verbatim preservation), `DIRECTORY_UPDATE_SYSTEM_PROMPT` (incremental `AGENTS.md` updates with selective modification rules).
- [`types.ts`](./types.ts): Exports `PromptContext` interface (`filePath`, `content`, `contextFiles?`, `existingSum?`, `sourceFileSize?`, `compressionRatio?`), `SUMMARY_GUIDELINES` object (`targetLength: {min: 300, max: 500}`, 8-item `include` array, 3-item `exclude` array).

## Data Flow

`buildFilePrompt` receives `PromptContext` from `orchestration/pool.ts` (Phase 1), selects `FILE_UPDATE_SYSTEM_PROMPT` if `context.existingSum` exists, calculates `targetSize = sourceFileSize * compressionRatio`, injects ultra-compression rules when `ratio < 0.5` (telegraphic style, abbreviation mandates). `buildDirectoryPrompt` invoked by Phase 2 synthesis logic, performs parallel I/O (reads `.sum` files via `getSumPath(entryPath, variant)`, child `AGENTS.md`, `AGENTS.local.md`), calls `extractDirectoryImports`/`formatImportMap` from `../../imports/index.js`, detects 10 manifest filenames (`package.json`, `Cargo.toml`, `go.mod`, etc.), scans source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, lists `.annex.sum` files, selects `DIRECTORY_UPDATE_SYSTEM_PROMPT` if `existingAgentsMd` provided.

## Compression Strategy

When `context.compressionRatio < 0.5`, `buildFilePrompt` injects target length rules before `'DENSITY RULES (MANDATORY):'` marker: calculates `maxSize = targetSize * 1.2`, adds `ULTRA-COMPRESSION TECHNIQUES` section mandating telescopic sentences, abbreviations (fn→function, param→parameter, util→utility), example minimization. Used when config sets `ai.compressionRatio` or per-file heuristics detect bloat.

## Behavioral Contracts

**Sentinel Value**: `<!-- Generated by agents-reverse-engineer -->` — first line in `AGENTS.md` files (from `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`), version-agnostic marker for AI-generated content detection by hooks (`are-context-loader.js`).

**Placeholder Format**: `{{FILE_PATH}}`, `{{CONTENT}}` — mustache-style template variables in `FILE_USER_PROMPT`, replaced by `buildFilePrompt`.

**Density Rules** (all prompts):
- Regex: `"Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)"`
- Prohibited phrases: `"this file"`, `"this module"`, `"provides"`, `"responsible for"`, `"is used to"`, `"basically"`, `"essentially"`
- Pattern: `"[ExportName] does X"` not `"The ExportName function is responsible for doing X"`

**Anchor Term Preservation**:
- `"All exported function/class/type/const names MUST appear in the summary exactly as written in source"`
- `"Preserve exact casing of identifiers (e.g., buildAgentsMd, not 'build agents md')"`

**Path Accuracy Rules** (`DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`):
- `"When referencing files or modules outside this directory, use ONLY paths from the 'Import Map' section"`
- `"Do NOT invent, rename, or guess module paths"`
- `"Cross-module references must use the specifier format from actual import statements"`

**Output Format Rules**:
- `FILE_USER_PROMPT`: `"Start your response DIRECTLY with the purpose statement — a single bold line: **Purpose statement here.**"`
- `DIRECTORY_SYSTEM_PROMPT`: `"Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text."`
- Prohibited preambles: `"Here is..."`, `"Now I'll..."`, `"Based on my analysis..."`, `"Let me create..."`, `"Perfect."`

**Incremental Update Preservation** (`FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`):
- `"Preserve the structure, section headings, and phrasing of the existing summary wherever the underlying code is unchanged"`
- `"Keep it VERBATIM — do not rephrase, reorganize, or 'improve' stable text"`
- `"Regex patterns, format strings, magic constants, and template content from the existing summary MUST be preserved verbatim unless the source code changed them"`
- `"Contribution guidelines, testing mandates, PR conventions, code conventions, and AI agent instructions from the existing summary MUST be preserved verbatim unless the source file changed them"`

**Language Detection Map** (`detectLanguage`):
- `.ts`/`.tsx`→`'typescript'`, `.js`/`.jsx`→`'javascript'`, `.py`→`'python'`, `.rb`→`'ruby'`, `.go`→`'go'`, `.rs`→`'rust'`, `.java`→`'java'`, `.kt`→`'kotlin'`, `.swift`→`'swift'`, `.cs`→`'csharp'`, `.php`→`'php'`, `.vue`→`'vue'`, `.svelte`→`'svelte'`, `.json`→`'json'`, `.yaml`/`.yml`→`'yaml'`, `.md`→`'markdown'`, `.css`→`'css'`, `.scss`→`'scss'`, `.html`→`'html'`, default→`'text'`

**Manifest Detection List** (`buildDirectoryPrompt`):
- `package.json`, `Cargo.toml`, `go.mod`, `pyproject.toml`, `pom.xml`, `build.gradle`, `Gemfile`, `composer.json`, `CMakeLists.txt`, `Makefile`

**Compression Threshold**: `compressionRatio < 0.5` triggers ultra-compression rules injection

**Annex Handling**:
- File-level: `## Annex References` section with format `` `CONSTANT_NAME` — description (char count) ``
- Directory-level: `"Reproduction-Critical Constants: if file summaries reference annex files (.annex.sum), list them with links. Do NOT reproduce annex content in AGENTS.md — just link to it."`

## Workflow & Conventions

**Prompt Construction Sequence**:
1. Phase 1 (file analysis): `orchestration/pool.ts` calls `buildFilePrompt(context)` → selects `FILE_SYSTEM_PROMPT` or `FILE_UPDATE_SYSTEM_PROMPT` → injects compression rules if `ratio < 0.5` → replaces `{{FILE_PATH}}`/`{{CONTENT}}` in `FILE_USER_PROMPT` → returns `{system, user}` pair → passed to `ai/service.ts`
2. Phase 2 (directory synthesis): Phase 2 logic calls `buildDirectoryPrompt(dirPath, ...)` → performs parallel I/O (`.sum` files, child `AGENTS.md`, `AGENTS.local.md`) → calls `extractDirectoryImports` → detects manifests → scans source files → lists `.annex.sum` → selects `DIRECTORY_SYSTEM_PROMPT` or `DIRECTORY_UPDATE_SYSTEM_PROMPT` → returns `{system, user}` pair → passed to `ai/service.ts`

**Adaptive Section Selection**: All prompts enforce adaptive documentation topics ("Choose the documentation topics most relevant to THIS specific file. Do not follow a fixed template", "Analyze the directory contents and choose the most relevant sections. Do NOT use a fixed template").

**Section Priority** (`SUMMARY_GUIDELINES.include`): purpose, exports, patterns, dependencies, signatures, coupled files, behavioral contracts, annex references (8 items).

**Excluded Topics** (`SUMMARY_GUIDELINES.exclude`): control flow, generic TODOs, broad architecture (3 items).

**Template Modification**: When updating prompts in `templates.ts`, preserve all behavioral contract markers (`<!-- Generated by agents-reverse-engineer -->`, density rules, anchor term rules, path accuracy rules). Use `npm run build` before committing. Coordinate with `generation/writers/sum.ts` (consumes `buildFilePrompt` output), `generation/writers/agents-md.ts` (consumes `buildDirectoryPrompt` output).