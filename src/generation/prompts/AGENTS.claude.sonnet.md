<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/generation/prompts

The `src/generation/prompts` directory constructs system and user prompt pairs for LLM-based `.sum` file and `AGENTS.md` generation, dynamically injecting compression rules, context files, import maps, and existing summaries for incremental updates.

## Contents

- **[builder.ts](./builder.ts)**: `buildFilePrompt` assembles file analysis prompts with `FILE_SYSTEM_PROMPT`/`FILE_UPDATE_SYSTEM_PROMPT`, injecting `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}` placeholders, related files from `context.contextFiles`, and aggressive compression instructions when `context.compressionRatio < 0.5` (calculates `targetSize = sourceFileSize * ratio`, `maxSize = targetSize * 1.2`). `buildDirectoryPrompt` assembles directory-level prompts with `DIRECTORY_SYSTEM_PROMPT`/`DIRECTORY_UPDATE_SYSTEM_PROMPT`, reading all `.sum` files via `readSumFile(getSumPath(entryPath, variant))`, child `AGENTS.md` (or `AGENTS.${variant}.md`), `AGENTS.local.md`, extracting `importMapText` via `extractDirectoryImports`/`formatImportMap`, detecting manifest files (`['package.json', 'Cargo.toml', 'go.mod', ...]`), and listing `.annex.sum` files. `detectLanguage` maps file extension to syntax highlighting identifier via `langMap`.

- **[index.ts](./index.ts)**: Re-exports `PromptContext` type, `SUMMARY_GUIDELINES` const, `buildFilePrompt`, `buildDirectoryPrompt`, `detectLanguage` from `./types.js` and `./builder.js`.

- **[templates.ts](./templates.ts)**: `FILE_SYSTEM_PROMPT` instructs LLMs to produce dense, identifier-rich file summaries with adaptive sections (public interface, algorithms, integration points, behavioral contracts, workflow rules), mandatory density rules (no filler phrases, anchor term preservation), and annex overflow handling. `FILE_USER_PROMPT` template expects `{{FILE_PATH}}` and `{{CONTENT}}` placeholders. `DIRECTORY_SYSTEM_PROMPT` instructs LLMs to generate `AGENTS.md` with `<!-- Generated by agents-reverse-engineer -->` first line, adaptive sections (Contents, Subdirectories, Architecture, Stack, Behavioral Contracts, Workflow & Conventions, Reproduction-Critical Constants), and path accuracy requirements (use Import Map paths). `FILE_UPDATE_SYSTEM_PROMPT` enforces preservation of unchanged sections verbatim, behavioral contract preservation (regex patterns, format strings, magic constants), workflow rule preservation. `DIRECTORY_UPDATE_SYSTEM_PROMPT` enforces preservation of unaffected structure/headings/descriptions, updating only entries for changed file summaries.

- **[types.ts](./types.ts)**: `PromptContext` interface defines `filePath`, `content`, `contextFiles`, `existingSum`, `sourceFileSize`, `compressionRatio` (0.1-1.0). `SUMMARY_GUIDELINES` constant defines `targetLength` (`{min: 300, max: 500}`), `include` array (purpose, public interface, patterns, dependencies, signatures, coupled files, behavioral contracts—verbatim regex/format strings/magic constants/sentinel values/output templates/env vars, annex references), `exclude` array (control flow, generic TODOs, broad architecture).

## Architecture

`builder.ts` imports prompt templates from `templates.ts`, injects context from `PromptContext` (defined in `types.ts`), and consumes file summaries from `../writers/sum.js`, import metadata from `../../imports/index.js`. `index.ts` exposes public API surface.

## Behavioral Contracts

All prompts enforce density rules: "Every sentence must reference at least one specific identifier", forbid filler phrases (`"this file"`, `"this module"`, `"provides"`, `"responsible for"`, `"is used to"`, `"basically"`, `"essentially"`, `"provides functionality for"`), require pattern `"[ExportName] does X"` not `"The ExportName function is responsible for doing X"`.

All prompts mandate anchor term preservation: exported function/class/type/const names appear exactly as written in source, preserve exact casing (e.g., `buildAgentsMd`, not `"build agents md"`), missing any exported identifier is failure.

All prompts mandate output format: start response directly with purpose statement (single bold line), no preamble/thinking/meta-commentary before purpose statement, no phrases like `"Here is..."`, `"Now I'll..."`, `"Based on my analysis..."`, `"Let me create..."`, `"Perfect."`, response IS the documentation.

Compression rules injected when `ratio < 0.5`: `"TARGET LENGTH (MANDATORY):\n- Source file: ${sourceSize} characters\n- Target summary: ~${targetSize} characters (${compressionPercentage}% compression)\n- Maximum: ${maxSize} characters"`, followed by `"ULTRA-COMPRESSION TECHNIQUES:"` section and insertion point `'DENSITY RULES (MANDATORY):'`.

Template placeholders: `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`.

User prompt sections: `"## Related Files"`, `"## Existing Summary (update this — preserve stable content, modify only what changed)"`, `"## File Summaries"`, `"## Import Map (verified — use these exact paths)"`, `"## Project Directory Structure"`, `"## Annex Files (reproduction-critical constants)"`, `"## Subdirectories"`, `"## Directory Hints"`, `"## User Notes (AGENTS.local.md)"`, `"## Existing AGENTS.md"`.

Manifest hint text: `"Contains manifest file(s): ${foundManifests.join(', ')} — likely a package or project root."` Source file regex: `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`.

`langMap` syntax highlighting identifiers: `.ts` → `'typescript'`, `.tsx` → `'tsx'`, `.js` → `'javascript'`, `.jsx` → `'jsx'`, `.py` → `'python'`, `.rb` → `'ruby'`, `.go` → `'go'`, `.rs` → `'rust'`, `.java` → `'java'`, `.kt` → `'kotlin'`, `.swift` → `'swift'`, `.cs` → `'csharp'`, `.php` → `'php'`, `.vue` → `'vue'`, `.svelte` → `'svelte'`, `.json` → `'json'`, `.yaml`/`.yml` → `'yaml'`, `.md` → `'markdown'`, `.css` → `'css'`, `.scss` → `'scss'`, `.html` → `'html'`, defaults to `'text'`.

Debug log format: `"[prompt] ${action} → ${rel}"`.

## Reproduction-Critical Constants

- `FILE_SYSTEM_PROMPT`: [templates.ts](./templates.ts) (system prompt for file analysis)
- `FILE_USER_PROMPT`: [templates.ts](./templates.ts) (user prompt template for file analysis)
- `DIRECTORY_SYSTEM_PROMPT`: [templates.ts](./templates.ts) (system prompt for AGENTS.md generation)
- `FILE_UPDATE_SYSTEM_PROMPT`: [templates.ts](./templates.ts) (system prompt for incremental file updates)
- `DIRECTORY_UPDATE_SYSTEM_PROMPT`: [templates.ts](./templates.ts) (system prompt for incremental AGENTS.md updates)