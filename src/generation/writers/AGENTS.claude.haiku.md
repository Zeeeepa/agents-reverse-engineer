<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/generation/writers

Aggregates file writers for .sum documentation, AGENTS.md variants, and CLAUDE.md pointers. Handles marker-based user content preservation, version tracking, and annex file generation for reproduction-critical constants.

## Contents

### Sum File Generation
[sum.ts](./sum.ts) — Serializes source documentation into YAML-frontmatter .sum files with SHA-256 change detection. Exports `readSumFile()`, `writeSumFile()`, `getSumPath()`, `sumFileExists()`, `writeAnnexFile()`, `getAnnexPath()`. Uses `SumFileContent` type with `summary`, `metadata`, `generatedAt`, `contentHash` fields. Frontmatter parsing extracts `generated_at`, `content_hash`, `purpose`, and optional `critical_todos`, `related_files` via regex-based YAML array extraction.

### AGENTS.md Writers
[agents-md.ts](./agents-md.ts) — Manages AGENTS.md file generation with marker-based user content preservation. Exports `GENERATED_MARKER_PREFIX`, `GENERATED_MARKER`, `isGeneratedAgentsMd()`, `writeAgentsMd()`, `writeAgentsMdHub()`. Detects user-authored content by checking for `GENERATED_MARKER_PREFIX` substring; renames existing AGENTS.md to AGENTS.local.md and prepends `@AGENTS.local.md` reference if user content detected. Supports variant suffix (e.g., AGENTS.claude.haiku.md) and hub mode with active variant references.

### CLAUDE.md Pointer
[claude-md.ts](./claude-md.ts) — Generates CLAUDE.md with @-references to AGENTS.md and optional CLAUDE.local.md. Exports `writeClaudeMdPointer()`. Detects and preserves user-authored CLAUDE.md by renaming to CLAUDE.local.md, then writes hub file with `@CLAUDE.local.md` and `@AGENTS.md` references using identical marker and preservation logic as agents-md.ts.

### Barrel Export
[index.ts](./index.ts) — Re-exports `writeSumFile()`, `readSumFile()`, `getSumPath()`, `sumFileExists()`, `getAnnexFile()`, `writeAnnexFile()`, `writeAgentsMd()`, `writeAgentsMdHub()`, `writeClaudeMdPointer()` from aggregated writer modules.

## Behavioral Contracts

**Marker Format**: `GENERATED_MARKER_PREFIX` = `'<!-- Generated by agents-reverse-engineer'`; `GENERATED_MARKER` = `${GENERATED_MARKER_PREFIX} v${version} -->`

**User Content Detection**: Files lacking `GENERATED_MARKER_PREFIX` substring are treated as user-authored and preserved via rename to `.local.md` variant.

**File Naming Patterns**: 
- Sum files: `foo.ts.sum` or `foo.ts.${variant}.sum`
- Annex files: `foo.annex.sum` or `foo.annex.${variant}.sum`
- AGENTS variants: `AGENTS.${variant}.md` or hub `AGENTS.md`
- CLAUDE variants: `CLAUDE.md` and optional `CLAUDE.local.md`

**YAML Frontmatter Arrays**: Inline format `[a, b, c]` for ≤3 short items; multi-line `- item` format otherwise. Parsing uses regex `/key:\s*\[([^\]]*)\]/` (inline) and `/key:\s*\n((?:\s+-\s+.+\n?)+)/m` (multi-line).

**Content Preservation Workflow**: (1) Check existing file for GENERATED_MARKER_PREFIX, (2) if absent, rename to `.local.md`, (3) check for pre-existing `.local.md` from prior runs, (4) prepend `@${localFile}` reference to generated content if local content exists. Marker stripping removes leading `GENERATED_MARKER_PREFIX` + content up to `-->` + leading newlines from LLM input.

**Hub Reference Format**: @-references use exact identifiers: `@AGENTS.${variant}.md`, `@AGENTS.local.md`, `@CLAUDE.local.md`, `@AGENTS.md`.

## Architecture

**Layered Writer Stack**: sum.ts (lowest level, YAML serialization) → agents-md.ts, claude-md.ts (mid-level, variant/hub logic) → index.ts (export aggregation).

**Marker-Based Preservation**: All writers (sum.ts via annex headers, agents-md.ts, claude-md.ts) use `GENERATED_MARKER` constant from agents-md.ts to identify AI-generated files and trigger user-content rename-and-reference workflows. Prevents accidental overwrites of user contributions.

**Variant Support**: sum.ts and agents-md.ts support optional `variant` parameter for multi-model documentation (e.g., `file.ts.claude.haiku.sum`, `AGENTS.claude.haiku.md`); hub mode writes version-agnostic files that reference the active variant.