---
generated_at: 2026-02-09T21:28:16.615Z
content_hash: 933b3ad3745f59291dbebe07fe01eddb97942b85d21ce141dbf9f186483c9da6
purpose: sum.ts implements YAML frontmatter-based `.sum` file I/O for storing AI-generated file summaries with SHA-256 content...
---
**sum.ts implements YAML frontmatter-based `.sum` file I/O for storing AI-generated file summaries with SHA-256 content hashes and structured metadata.**

## Exported Types

**SumFileContent** — structured content for a `.sum` file with fields:
- `summary: string` — main summary text (detailed description)
- `metadata: SummaryMetadata` — extracted metadata (imported from `../types.js`)
- `generatedAt: string` — generation timestamp (ISO 8601 format)
- `contentHash: string` — SHA-256 hash of source file content for change detection

## Core File Operations

**writeSumFile(sourcePath: string, content: SumFileContent): Promise<string>** — writes `.sum` file alongside source file (e.g., `foo.ts` → `foo.ts.sum`), creates parent directory via `mkdir({ recursive: true })`, formats content via `formatSumFile()`, returns written `.sum` path.

**readSumFile(sumPath: string): Promise<SumFileContent | null>** — parses `.sum` file into structured content via `parseSumFile()`, returns `null` if file doesn't exist or parsing fails.

**getSumPath(sourcePath: string): string** — returns `.sum` path by appending `.sum` to source path.

**sumFileExists(sourcePath: string): Promise<boolean>** — checks if `.sum` file exists by calling `readSumFile()` and testing for non-null result.

## Annex File Operations

**writeAnnexFile(sourcePath: string, sourceContent: string): Promise<string>** — writes `.annex.md` file alongside source file (e.g., `foo.ts` → `foo.ts.annex.md`) containing full source content for reproduction-critical files whose verbatim constants cannot fit within `.sum` word limits, wraps source in triple-backtick code fence with markdown header using `GENERATED_MARKER` from `agents-md.js`, returns written annex path.

**getAnnexPath(sourcePath: string): string** — returns `.annex.md` path by appending `.annex.md` to source path.

## YAML Frontmatter Format

**formatSumFile(content: SumFileContent): string** — serializes `SumFileContent` to YAML frontmatter format:
```
---
generated_at: <ISO 8601 timestamp>
content_hash: <SHA-256 hex>
purpose: <single line string>
critical_todos: [<array>] or multi-line YAML
related_files: [<array>] or multi-line YAML
---

<summary text>
```

**parseSumFile(content: string): SumFileContent | null** — extracts frontmatter via regex `/^---\n([\s\S]*?)\n---\n/`, parses fields using line-based regex patterns (`/generated_at:\s*(.+)/`, `/content_hash:\s*(.+)/`, `/purpose:\s*(.+)/`), delegates array parsing to `parseYamlArray()`, returns `null` on parse failure.

## YAML Array Parsing

**parseYamlArray(frontmatter: string, key: string): string[]** — parses YAML array fields from frontmatter supporting two formats:
1. Inline: `key: [a, b, c]` via regex `/key:\s*\[([^\]]*)\]/`
2. Multi-line: `key:\n  - item1\n  - item2` via regex `/key:\s*\n((?:\s+-\s+.+\n?)+)/m`

Strips quotes from inline values via `.replace(/^["']|["']$/g, '')`, trims whitespace, filters empty strings.

**formatYamlArray(key: string, values: string[]): string** — serializes array to YAML frontmatter using inline format for arrays with ≤3 items where all items are <40 chars, otherwise uses multi-line format with `  - ` prefix per item.

## Integration Points

Imports `SummaryMetadata` from `../types.js` (contains `purpose`, optional `criticalTodos`, optional `relatedFiles`).

Imports `GENERATED_MARKER` from `./agents-md.js` for consistent generated file headers in annex files.

Uses Node.js `fs/promises` for async file operations (`writeFile`, `readFile`, `mkdir`).

## Behavioral Contracts

**Frontmatter regex patterns:**
- Frontmatter block: `/^---\n([\s\S]*?)\n---\n/`
- Scalar field: `/<key>:\s*(.+)/` (e.g., `generated_at`, `content_hash`, `purpose`)
- Inline array: `/<key>:\s*\[([^\]]*)\]/`
- Multi-line array: `/<key>:\s*\n((?:\s+-\s+.+\n?)+)/m`

**File naming conventions:**
- Summary file: `<sourcePath>.sum`
- Annex file: `<sourcePath>.annex.md`

**Annex file template:**
```
<!-- Generated by agents-reverse-engineer -->
# Annex: <fileName>

Reproduction-critical source content from `<fileName>`.
Referenced by `<fileName>.sum`.

```
<sourceContent>
```

```