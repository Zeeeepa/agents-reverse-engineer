---
generated_at: 2026-02-09T17:44:26.575Z
content_hash: 933b3ad3745f59291dbebe07fe01eddb97942b85d21ce141dbf9f186483c9da6
purpose: sum.ts manages .sum file I/O with YAML frontmatter serialization, parsing, and annex file generation for reproduction...
---
**sum.ts manages .sum file I/O with YAML frontmatter serialization, parsing, and annex file generation for reproduction-critical source content.**

## Exported Interfaces and Types

`SumFileContent` interface defines `.sum` file structure with `summary: string`, `metadata: SummaryMetadata`, `generatedAt: string`, `contentHash: string` (SHA-256 hex digest for change detection).

## Core I/O Functions

`writeSumFile(sourcePath: string, content: SumFileContent): Promise<string>` appends `.sum` extension to `sourcePath`, creates parent directory via `mkdir(..., { recursive: true })`, formats content via `formatSumFile()`, writes with `writeFile()`, returns absolute `.sum` path.

`readSumFile(sumPath: string): Promise<SumFileContent | null>` reads file via `readFile()`, delegates to `parseSumFile()`, returns `null` on read failure or parse error.

`getSumPath(sourcePath: string): string` returns `${sourcePath}.sum` without filesystem access.

`sumFileExists(sourcePath: string): Promise<boolean>` calls `readSumFile(getSumPath(sourcePath))` and checks for non-null result.

## Frontmatter Parsing

`parseSumFile(content: string): SumFileContent | null` extracts YAML frontmatter via regex `/^---\n([\s\S]*?)\n---\n/`, parses `generated_at`, `content_hash`, `purpose` fields via individual regex patterns (`/generated_at:\s*(.+)/`, `/content_hash:\s*(.+)/`, `/purpose:\s*(.+)/`), delegates array parsing to `parseYamlArray()` for `critical_todos` and `related_files`, returns `null` on parse failure.

`parseYamlArray(frontmatter: string, key: string): string[]` supports inline format `key: [a, b, c]` via regex `new RegExp(\`${key}:\\s*\\[([^\\]]*)\\]\`)` and multi-line format via `new RegExp(\`${key}:\\s*\\n((?:\\s+-\\s+.+\\n?)+)\`, 'm')`, strips quotes and list markers, returns empty array if neither pattern matches.

## Frontmatter Serialization

`formatSumFile(content: SumFileContent): string` builds YAML frontmatter block with `---` delimiters, writes `generated_at`, `content_hash`, `purpose` as top-level fields, conditionally includes `critical_todos` and `related_files` via `formatYamlArray()` if arrays non-empty, appends summary body after closing `---\n\n`.

`formatYamlArray(key: string, values: string[]): string` returns `key: []` for empty arrays, inline format `key: [val1, val2]` for arrays â‰¤3 elements with all values <40 chars, multi-line YAML list format `key:\n  - val1\n  - val2` otherwise.

## Annex File Generation

`writeAnnexFile(sourcePath: string, sourceContent: string): Promise<string>` creates `${sourcePath}.annex.md` with markdown structure: `GENERATED_MARKER` comment (imported from `agents-md.ts`), `# Annex: {basename}` heading, explanatory text referencing `.sum` file, triple-backtick code fence containing full `sourceContent`, writes via `writeFile()`, returns annex path.

`getAnnexPath(sourcePath: string): string` returns `${sourcePath}.annex.md` without filesystem access.

## Integration Points

Imports `GENERATED_MARKER` from `./agents-md.js` for consistent generated file annotation. Used by update workflow (`src/update/`) for hash comparison via `readSumFile()`, by file analysis phase (`src/generation/executor.ts`) for `.sum` output via `writeSumFile()`, by orphan cleanup (`src/update/orphan-cleaner.ts`) for stale file deletion.

## YAML Format Contract

Frontmatter delimiter: `---\n...\n---\n` with exactly one newline after closing delimiter before summary body begins.

Scalar field pattern: `key: value` with optional trailing whitespace.

Array formats:
- Inline: `key: [item1, item2]` with comma-separated values
- Multi-line: `key:\n  - item1\n  - item2` with two-space indent and `- ` prefix per line

Required fields: `generated_at` (ISO 8601 timestamp), `content_hash` (64-char hex string), `purpose` (single-line string).

Optional fields: `critical_todos` (string array), `related_files` (string array).