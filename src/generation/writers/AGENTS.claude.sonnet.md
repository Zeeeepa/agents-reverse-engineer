<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/generation/writers

Serialization layer for `.sum` documentation files, `AGENTS.md` overviews, and `CLAUDE.md` pointers with YAML frontmatter, content hashing, variant support, and user-authored file preservation.

## Contents

- [**agents-md.ts**](./agents-md.ts): Exports `writeAgentsMd`, `writeAgentsMdHub`, `isGeneratedAgentsMd` for variant-aware AGENTS.md writing; preserves user-authored AGENTS.md as AGENTS.local.md with `@AGENTS.local.md` reference; defines `GENERATED_MARKER_PREFIX` and `GENERATED_MARKER`.

- [**claude-md.ts**](./claude-md.ts): Exports `writeClaudeMdPointer` to write CLAUDE.md importing `@AGENTS.md`; preserves user-authored CLAUDE.md as CLAUDE.local.md if `GENERATED_MARKER_PREFIX` absent.

- [**index.ts**](./index.ts): Re-exports `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `getAnnexPath`, `writeAnnexFile`, `SumFileContent` from `sum.js`; exports `writeAgentsMd`, `writeAgentsMdHub` from `agents-md.js`; exports `writeClaudeMdPointer` from `claude-md.js`.

- [**sum.ts**](./sum.ts): Exports `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists` for `.sum` files with YAML frontmatter (`generated_at`, `content_hash`, `purpose`, `critical_todos`, `related_files`); exports `writeAnnexFile`, `getAnnexPath` for reproduction-critical source verbatim storage; exports `SumFileContent` interface; implements `parseSumFile`, `formatSumFile`, `parseYamlArray`, `formatYamlArray`.

## Architecture

Writers form output boundary layer: `sum.ts` serializes file-level summaries as `.sum` with SHA-256 hashing; `agents-md.ts` assembles directory-level overviews with variant routing (`AGENTS.${variant}.md` or AGENTS.md hub); `claude-md.ts` creates top-level pointer for Claude Code integration. All writers check for user-authored content via `GENERATED_MARKER_PREFIX` absence, preserving originals with `.local.md` suffix and injecting `@` references.

## Variant Support

`writeSumFile`, `writeAnnexFile`, `getSumPath`, `getAnnexPath`, `writeAgentsMd` accept optional `variant: string`. When specified: `foo.ts` → `foo.ts.${variant}.sum` / `foo.annex.${variant}.sum`. `writeAgentsMdHub(dirPath, activeVariant)` writes hub file referencing `@AGENTS.${activeVariant}.md`.

## User Content Preservation

Both `writeAgentsMd` and `writeClaudeMdPointer` detect user-authored files (lacking `GENERATED_MARKER_PREFIX`), rename to `.local.md`, inject `@<filename>.local.md` reference after `GENERATED_MARKER` so user instructions precede generated content for AI agents.

## Frontmatter Format

`.sum` files use YAML frontmatter between `---` delimiters. `formatYamlArray` serializes arrays inline (`[a, b, c]`) if ≤3 items under 40 chars, multi-line (`- item`) otherwise. `parseSumFile` extracts fields via regex `/generated_at:\s*(.+)/`, `/content_hash:\s*(.+)/`, `/purpose:\s*(.+)/`. `parseYamlArray` handles both inline `/key:\s*\[([^\]]*)\]/` and multi-line `/key:\s*\n((?:\s+-\s+.+\n?)+)/m` patterns.

## Content Assembly

`writeAgentsMd` strips existing marker from LLM content via `indexOf('-->')` + slice. Assembles final content: marker line, blank line, optional `@AGENTS.local.md` reference, blank line, LLM/variant reference. `writeClaudeMdPointer` generates `@CLAUDE.local.md` (if preserved) followed by `@AGENTS.md` reference. All writers create parent directories recursively before write.

## Behavioral Contracts

`GENERATED_MARKER_PREFIX = '<!-- Generated by agents-reverse-engineer'` (version-agnostic marker for generated file detection).

`GENERATED_MARKER` includes full version from `getVersion()`.

SHA-256 `contentHash` in `SumFileContent` enables change detection.

`getAnnexPath` strips source extension: `foo.ts` → `foo.annex.sum` or `foo.annex.${variant}.sum`.