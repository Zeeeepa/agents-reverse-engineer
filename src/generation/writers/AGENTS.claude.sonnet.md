<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/generation/writers

The `src/generation/writers` directory serializes LLM analysis results to filesystem artifacts: `.sum` files with YAML frontmatter and content-hash change detection, `AGENTS.md` directory overviews with user-content preservation via `.local.md` renaming, `.annex.sum` overflow files for verbatim source constants, and `CLAUDE.md` pointer files for @ reference imports.

## Contents

- [`agents-md.ts`](./agents-md.ts): `writeAgentsMd` writes `AGENTS.md` (standard) or `AGENTS.${variant}.md` (eval mode); detects user-authored files via `GENERATED_MARKER_PREFIX` absence, renames to `AGENTS.local.md`, prepends `@AGENTS.local.md` import before LLM content. `writeAgentsMdHub` creates hub `AGENTS.md` importing `@AGENTS.${activeVariant}.md`. `isGeneratedAgentsMd` checks marker presence. `GENERATED_MARKER_PREFIX` sentinel: `'<!-- Generated by agents-reverse-engineer'`.
- [`claude-md.ts`](./claude-md.ts): `writeClaudeMdPointer` writes `CLAUDE.md` importing `@AGENTS.md`; preserves user content via rename to `CLAUDE.local.md` with prepended `@CLAUDE.local.md` import.
- [`index.ts`](./index.ts): Barrel re-exporting `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `getAnnexPath`, `writeAnnexFile`, `SumFileContent` (from `sum.ts`), `writeAgentsMd`, `writeAgentsMdHub` (from `agents-md.ts`), `writeClaudeMdPointer` (from `claude-md.ts`).
- [`sum.ts`](./sum.ts): `writeSumFile` serializes `SumFileContent` (YAML frontmatter: `generated_at`, `content_hash` SHA-256, `purpose`, `critical_todos`, `related_files` + markdown summary) to `.sum` or `.${variant}.sum` files. `readSumFile` parses frontmatter via `parseYamlArray` (inline `[a,b]` or multiline `- item`). `writeAnnexFile` wraps verbatim source in triple-backticks with `GENERATED_MARKER` header. `getSumPath`/`getAnnexPath` resolve paths, `sumFileExists` checks presence.

## Behavioral Contracts

**Generation Marker**: `GENERATED_MARKER_PREFIX = '<!-- Generated by agents-reverse-engineer'` (version-agnostic detection), `GENERATED_MARKER = <!-- Generated by agents-reverse-engineer v${version} -->` (written header).

**User Content Preservation**: `writeAgentsMd`/`writeClaudeMdPointer` detect non-generated files via marker absence, rename to `.local.md`, prepend `@{filename}.local.md` import before LLM content.

**Frontmatter Format** (from `sum.ts`):
```yaml
---
generated_at: {ISO8601}
content_hash: {SHA-256}
purpose: {string}
critical_todos: [item] | - item (inline ≤3 items <40 chars, else multiline)
related_files: [path] | - path
---
{markdown summary}
```

**Annex File Format** (from `writeAnnexFile`):
```
<!-- Generated by agents-reverse-engineer v{version} -->

```{language}
{verbatim source content}
```
```

**Path Resolution**:
- `.sum` file: `sourcePath + '.sum'` or `sourcePath + '.${variant}.sum'`
- Annex file: `dirname(sourcePath) / basename(sourcePath, extname) + '.annex.sum'` or `.annex.${variant}.sum`

**YAML Array Parsing Patterns** (from `parseYamlArray`):
- Inline: `/key:\s*\[([^\]]*)\]/` → split by `, `
- Multiline: `/key:\s*\n((?:\s+-\s+.+\n?)+)/m` → match lines via `/^\s+-\s+(.+)$/gm`

## File Relationships

`index.ts` barrel exports all writers. `agents-md.ts` and `claude-md.ts` share `GENERATED_MARKER`/`GENERATED_MARKER_PREFIX` constants. `sum.ts` imports `SummaryMetadata` from `../types.js` for frontmatter schema. `agents-md.ts` calls `getVersion()` from `../../version.js` for marker construction.