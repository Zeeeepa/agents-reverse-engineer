---
generated_at: 2026-02-09T21:28:06.240Z
content_hash: a3686798d4657b8320955a2669b0c639817c3f9826ab2541bd626ff8713c4eb3
purpose: writeAgentsMd orchestrates preservation of user-authored AGENTS.md files by renaming them to AGENTS.local.md and prep...
---
**writeAgentsMd orchestrates preservation of user-authored AGENTS.md files by renaming them to AGENTS.local.md and prepending their content above LLM-generated documentation with marker-based identification.**

## Exported Functions

**writeAgentsMd(dirPath: string, _projectRoot: string, content: string): Promise<string>**
Writes AGENTS.md to dirPath with four-step preservation workflow: (1) detects existing non-generated AGENTS.md via absence of GENERATED_MARKER and renames to AGENTS.local.md, (2) reads AGENTS.local.md from previous runs if no rename occurred, (3) strips GENERATED_MARKER prefix from incoming LLM content, (4) assembles final content as `GENERATED_MARKER` + optional user content block with `<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->` delimiter + horizontal rule + LLM content. Returns written file path.

**isGeneratedAgentsMd(filePath: string): Promise<boolean>**
Returns true if file at filePath contains GENERATED_MARKER substring via readFile, false on read errors (treats missing files as non-generated).

## Marker Constant

**GENERATED_MARKER**
String constant `'<!-- Generated by agents-reverse-engineer -->'` used for detection of tool-generated AGENTS.md files versus user-authored ones. Referenced by isGeneratedAgentsMd for substring matching and writeAgentsMd for marker injection/stripping.

## User Content Preservation Strategy

writeAgentsMd implements two-path detection: (1) rename existing AGENTS.md to AGENTS.local.md if non-generated, (2) read AGENTS.local.md if already exists from prior runs. User content prepended with comment header `<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->` followed by content, horizontal rule separator `---`, then LLM content. Ensures AI assistants see user-defined context before generated summaries.

## Content Assembly Logic

LLM content undergoes marker stripping: if content.startsWith(GENERATED_MARKER), slices marker length and removes leading newlines via `/^\n+/` regex. Final assembly uses parts array joined with `\n`: marker, empty line, optional user block (comment + content + rule), LLM content. Directory creation via mkdir with `recursive: true` ensures parent paths exist before writeFile.

## Error Handling

Both readFile operations (existing AGENTS.md, AGENTS.local.md) wrapped in try-catch blocks that silently continue on errors, treating absence as null userContent. No explicit error propagation for missing filesâ€”only writeFile failures bubble up to caller.