---
generated_at: 2026-02-09T16:09:13.483Z
content_hash: a3686798d4657b8320955a2669b0c639817c3f9826ab2541bd626ff8713c4eb3
purpose: agents-md.ts manages `AGENTS.md` file lifecycle during directory aggregation, preserving user-authored content by ren...
---
**agents-md.ts manages `AGENTS.md` file lifecycle during directory aggregation, preserving user-authored content by renaming existing files to `AGENTS.local.md` and prepending them above generated documentation with marker-based ownership detection.**

## Exported Functions

**writeAgentsMd(dirPath: string, _projectRoot: string, content: string): Promise<string>**
Writes `AGENTS.md` for a directory with LLM-generated content, returns path to written file. Executes four-step preservation workflow: (1) reads existing `AGENTS.md` at `dirPath`, checks for `GENERATED_MARKER` absence to detect user authorship, renames to `AGENTS.local.md` via `rename()` if user-authored; (2) if no user content found in step 1, attempts to read already-renamed `AGENTS.local.md` from previous run; (3) strips `GENERATED_MARKER` prefix from incoming `content` parameter via `slice()` + regex `/^\n+/` to normalize LLM output; (4) constructs final content with structure: `GENERATED_MARKER` → newline → optional user content block with `<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->` header + `---` separator → LLM content, writes to `AGENTS.md` via `writeFile()` with `mkdir()` ensuring parent directory exists. Parameter `_projectRoot` unused (underscore-prefixed per linter convention). Called by Phase 2 orchestrator (`src/generation/orchestrator.ts`) during post-order directory aggregation after child `.sum` files processed.

**isGeneratedAgentsMd(filePath: string): Promise<boolean>**
Detects whether `AGENTS.md` at `filePath` was generated by ARE via substring search for `GENERATED_MARKER` in file content read via `readFile()`. Returns `false` on read errors (file not found, permission denied) via empty catch block. Used by `writeAgentsMd()` to determine preservation logic and by cleanup commands (`src/cli/clean.ts`) to distinguish generated vs. user-authored files for selective deletion.

## Marker Constant

**GENERATED_MARKER: string**
HTML comment string `'<!-- Generated by agents-reverse-engineer -->'` injected at top of all generated `AGENTS.md` files. Serves as ownership identifier for idempotent regeneration: presence indicates generated content safe to overwrite, absence indicates user authorship requiring preservation via `AGENTS.local.md` rename. Pattern avoids YAML frontmatter to maintain Markdown readability and compatibility with viewers that don't parse frontmatter.

## User Content Preservation Strategy

User-authored `AGENTS.md` files (lacking `GENERATED_MARKER`) renamed to `AGENTS.local.md` on first `writeAgentsMd()` invocation. Subsequent runs read `AGENTS.local.md` directly without re-checking original path, preventing repeated file system operations. Preserved content prepended above generated content with visual separator (`---`) ensuring AI assistants encounter project-specific context before auto-generated summaries. If `AGENTS.local.md` exists from previous run and user deletes/modifies `AGENTS.md` in interim, the `AGENTS.local.md` version takes precedence (step 2 fallback logic).

## Output Structure

Final `AGENTS.md` format:
```
<!-- Generated by agents-reverse-engineer -->

<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->

[user content verbatim with leading/trailing whitespace trimmed]

---

[LLM-generated content with GENERATED_MARKER prefix stripped]
```

If no user content exists, omits comment header and separator, outputs:
```
<!-- Generated by agents-reverse-engineer -->

[LLM-generated content]
```

## Integration Points

- **src/generation/orchestrator.ts**: Calls `writeAgentsMd()` in Phase 2 (`runDirectoryGeneration`) after aggregating child `.sum` files and subdirectory `AGENTS.md` files via `collectAgentsDocs()`, passes `dirPath` from sorted directory list and `content` from `AIService.call()` response
- **src/cli/clean.ts**: Calls `isGeneratedAgentsMd()` to filter deletion targets, skips user-authored files, restores `AGENTS.local.md` → `AGENTS.md` after removing generated version
- **src/update/orphan-cleaner.ts**: Uses `isGeneratedAgentsMd()` in `cleanupEmptyDirectoryDocs()` to determine whether to delete `AGENTS.md` from directories with no remaining source files

## Error Handling

Both functions use empty catch blocks with fallback behavior: `isGeneratedAgentsMd()` returns `false` on read errors (treats unreadable files as non-generated), `writeAgentsMd()` treats read errors as "no existing file" and proceeds with writing marker + LLM content only. No explicit error logging since failures indicate normal conditions (file not found on first run). Parent orchestrator (`src/generation/executor.ts`) captures write errors during task execution and reports via progress logger.