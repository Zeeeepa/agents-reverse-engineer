---
generated_at: 2026-02-09T13:17:46.975Z
content_hash: a3686798d4657b8320955a2669b0c639817c3f9826ab2541bd626ff8713c4eb3
purpose: `agents-md.ts` writes directory-level `AGENTS.md` files, preserving user-authored content by renaming to `AGENTS.loca...
---
**`agents-md.ts` writes directory-level `AGENTS.md` files, preserving user-authored content by renaming to `AGENTS.local.md` and prepending it to LLM-generated content.**

## Exported Constants

- `GENERATED_MARKER`: HTML comment string `'<!-- Generated by agents-reverse-engineer -->'` identifying generated `AGENTS.md` files

## Exported Functions

- `isGeneratedAgentsMd(filePath: string): Promise<boolean>` checks if `AGENTS.md` at `filePath` contains `GENERATED_MARKER` to determine if the file was generated by this tool
- `writeAgentsMd(dirPath: string, _projectRoot: string, content: string): Promise<string>` writes `AGENTS.md` to `dirPath` with LLM-generated `content`, returns path to written file

## User Content Preservation Strategy

`writeAgentsMd` implements a merge-on-write pattern: existing `AGENTS.md` without `GENERATED_MARKER` is renamed to `AGENTS.local.md` and prepended above generated content. On subsequent runs, `AGENTS.local.md` is read and prepended again, ensuring user-authored content always appears first for AI agents. The final structure is `GENERATED_MARKER` → user content (if any) with `<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->` → horizontal rule `---` → stripped LLM content.

## Content Processing Steps

1. Detect existing `AGENTS.md` via `readFile`, check for `GENERATED_MARKER`, rename to `AGENTS.local.md` via `rename` if user-authored
2. If no user content found in step 1, attempt `readFile` on `AGENTS.local.md` from previous run
3. Strip `GENERATED_MARKER` prefix from incoming `content` parameter if present, trim leading newlines
4. Build final content array: marker, optional user content block with separator, LLM content
5. Write via `writeFile` with `mkdir` ensuring parent directory exists

## Dependencies

- `node:fs/promises`: `writeFile`, `readFile`, `mkdir`, `rename` for atomic file operations
- `node:path`: `path.join`, `path.dirname` for path manipulation