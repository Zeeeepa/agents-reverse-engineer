---
generated_at: 2026-02-09T17:44:19.453Z
content_hash: a3686798d4657b8320955a2669b0c639817c3f9826ab2541bd626ff8713c4eb3
purpose: Manages AGENTS.md file lifecycle: writes LLM-generated directory documentation, preserves user-authored content by re...
---
**Manages AGENTS.md file lifecycle: writes LLM-generated directory documentation, preserves user-authored content by renaming to AGENTS.local.md, and prepends preserved content above generated sections with marker-based detection.**

## Exported Constants

`GENERATED_MARKER` â€” String constant `'<!-- Generated by agents-reverse-engineer -->'` embedded in all generated AGENTS.md files to distinguish them from user-authored versions.

## Exported Functions

### isGeneratedAgentsMd

```typescript
async function isGeneratedAgentsMd(filePath: string): Promise<boolean>
```

Reads file at `filePath`, returns `true` if content includes `GENERATED_MARKER` substring. Returns `false` on read failure (file not found, permission denied).

### writeAgentsMd

```typescript
async function writeAgentsMd(
  dirPath: string,
  _projectRoot: string,
  content: string,
): Promise<string>
```

Writes AGENTS.md to `dirPath` by composing marker + preserved user content + LLM-generated `content` parameter. Returns path to written AGENTS.md file (`path.join(dirPath, 'AGENTS.md')`).

## User Content Preservation Strategy

Executes three-step preservation workflow:

1. **Check existing AGENTS.md**: If file exists and lacks `GENERATED_MARKER`, renames to `AGENTS.local.md` via `rename()` and captures content as `userContent`
2. **Fallback to AGENTS.local.md**: If no user content captured in step 1, attempts `readFile(localPath)` to load previously preserved content
3. **Strip marker from LLM content**: Removes `GENERATED_MARKER` prefix via `slice()` if present, trims leading newlines with `/^\n+/` regex

## Final Content Assembly

Constructs `finalContent` string from ordered parts array:

```
<!-- Generated by agents-reverse-engineer -->

<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->

[userContent.trim()]

---

[llmContent]
```

User content section (comment + content + separator) omitted if `userContent?.trim()` is falsy. Calls `mkdir(path.dirname(agentsPath), { recursive: true })` before `writeFile()` to ensure parent directory exists.

## Integration Points

Invoked by Phase 2 directory aggregation orchestrator (`src/generation/orchestrator.ts`) after LLM subprocess generates AGENTS.md content. Works with `src/generation/collector.ts` which reads AGENTS.local.md files when collecting subdirectory documentation for parent directory prompts.

## Behavioral Contracts

- **Marker detection pattern**: Substring search `content.includes(GENERATED_MARKER)` without regex or parsing
- **Marker removal pattern**: `llmContent.startsWith(GENERATED_MARKER)` check followed by `slice(GENERATED_MARKER.length).replace(/^\n+/, '')`
- **File paths**: AGENTS.md (`path.join(dirPath, 'AGENTS.md')`), AGENTS.local.md (`path.join(dirPath, 'AGENTS.local.md')`)
- **User content separator**: Triple-dash Markdown horizontal rule `'---'` surrounded by blank lines