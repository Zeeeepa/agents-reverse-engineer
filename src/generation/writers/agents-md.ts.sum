---
generated_at: 2026-02-09T15:06:11.819Z
content_hash: a3686798d4657b8320955a2669b0c639817c3f9826ab2541bd626ff8713c4eb3
purpose: agents-md.ts manages AGENTS.md file lifecycle: preserves user-authored content via AGENTS.local.md renaming, prepends...
---
**agents-md.ts manages AGENTS.md file lifecycle: preserves user-authored content via AGENTS.local.md renaming, prepends user content above LLM-generated output, and writes final AGENTS.md with GENERATED_MARKER for provenance tracking.**

## Exported Constants

`GENERATED_MARKER` exports string constant `'<!-- Generated by agents-reverse-engineer -->'` used to distinguish generated AGENTS.md files from user-authored ones via substring matching.

## Exported Functions

### isGeneratedAgentsMd

```typescript
async function isGeneratedAgentsMd(filePath: string): Promise<boolean>
```

Reads file at `filePath` and returns true if content contains `GENERATED_MARKER` substring, false otherwise or on read failure.

### writeAgentsMd

```typescript
async function writeAgentsMd(
  dirPath: string,
  _projectRoot: string,
  content: string,
): Promise<string>
```

Orchestrates four-step AGENTS.md write protocol:

1. **User content preservation**: Reads existing `AGENTS.md`, renames to `AGENTS.local.md` if not generated (missing `GENERATED_MARKER`)
2. **Fallback loading**: Reads `AGENTS.local.md` from previous runs if no user content found in step 1
3. **Marker stripping**: Removes `GENERATED_MARKER` prefix from LLM `content` parameter to prevent duplication
4. **Content assembly**: Builds final output with `GENERATED_MARKER` header, optional user content block wrapped in `<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->` comment with `---` separator, followed by stripped LLM content

Computes `agentsPath` as `path.join(dirPath, 'AGENTS.md')` and `localPath` as `path.join(dirPath, 'AGENTS.local.md')`. Creates parent directory recursively via `mkdir()` before writing. Returns absolute path to written `AGENTS.md`.

## Integration Points

Called by Phase 2 directory aggregation executor (`src/generation/executor.ts`) after LLM synthesis of child `.sum` files and subdirectory `AGENTS.md` documents. Ensures user-authored documentation appears before generated content in AI assistant context windows via prepend ordering.

## User Content Handling Pattern

Implements two-pass user content detection: first checks in-place `AGENTS.md` for non-generated content (absence of marker), then falls back to `AGENTS.local.md` from previous runs. This supports both initial migration (user file exists, no marker) and incremental updates (user file already renamed to `.local.md`).

## Content Assembly Strategy

Strips `GENERATED_MARKER` from LLM output to prevent double-marking (LLM may include marker from prompt examples). Normalizes leading newlines after stripping via `/^\n+/` regex replacement. Joins final parts array with `\n` separator producing canonical format:

```
<!-- Generated by agents-reverse-engineer -->

<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->

[user content]

---

[LLM content]
```