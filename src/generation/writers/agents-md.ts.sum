---
generated_at: 2026-02-09T14:08:10.568Z
content_hash: a3686798d4657b8320955a2669b0c639817c3f9826ab2541bd626ff8713c4eb3
purpose: agents-md.ts manages AGENTS.md lifecycle: preserves user-authored content as AGENTS.local.md, prepends it above LLM-g...
---
**agents-md.ts manages AGENTS.md lifecycle: preserves user-authored content as AGENTS.local.md, prepends it above LLM-generated content, and writes final AGENTS.md with generation marker.**

## Exports

**`GENERATED_MARKER`**: `string` constant `'<!-- Generated by agents-reverse-engineer -->'` identifying ARE-generated AGENTS.md files.

**`isGeneratedAgentsMd(filePath: string): Promise<boolean>`** checks if AGENTS.md contains `GENERATED_MARKER` via substring search, returns false on read errors.

**`writeAgentsMd(dirPath: string, _projectRoot: string, content: string): Promise<string>`** orchestrates AGENTS.md write with user content preservation:
- Parameter `dirPath`: target directory for AGENTS.md
- Parameter `_projectRoot`: unused (present for interface compatibility)
- Parameter `content`: LLM-generated markdown from Phase 2 directory aggregation
- Returns: absolute path to written AGENTS.md file

## User Content Preservation Strategy

`writeAgentsMd` implements three-step user content detection:
1. Reads existing `AGENTS.md`, tests for `GENERATED_MARKER` absence, renames to `AGENTS.local.md` if user-authored
2. Reads `AGENTS.local.md` if Step 1 found no user content (handles previous runs)
3. Continues with `userContent = null` if neither file contains user content

## Content Assembly

`writeAgentsMd` strips `GENERATED_MARKER` prefix from LLM content via `slice()` + `replace(/^\n+/, '')`.

Final content structure built via `parts` array:
1. `GENERATED_MARKER` line
2. Empty line separator
3. Optional user content block with `<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->` comment, content, horizontal rule separator
4. Stripped LLM content

Writes via `writeFile()` with `mkdir(..., { recursive: true })` ensuring parent directory exists.

## Integration Points

Called by Phase 2 post-order directory aggregation in `src/generation/orchestrator.ts` after LLM synthesizes directory overview from child `.sum` files and subdirectory `AGENTS.md` files.

User content preservation ensures manual documentation survives ARE regeneration cycles, appearing first in AI assistant context windows.

## File System Operations

Uses `readFile()` for existing content detection with try-catch suppressing `ENOENT` errors.

Uses `rename()` to move user `AGENTS.md` â†’ `AGENTS.local.md` atomically before regeneration.

`mkdir()` with `recursive: true` creates intermediate directories (handles nested source tree structures).