<!-- Generated by agents-reverse-engineer v0.8.2 -->

# src/generation/writers

Serialization layer for `.sum` files (YAML frontmatter + markdown), `AGENTS.md` directory aggregates, and `CLAUDE.md` root pointers, with user-content preservation via `.local.md` renaming and `@import` directives.

## Contents

**[sum.ts](./sum.ts)** — `writeSumFile()` serializes `SumFileContent` to YAML frontmatter (`generated_at`, `content_hash`, `purpose`, optional `critical_todos`/`related_files`) + markdown body via `formatSumFile()`, `readSumFile()` parses via `/^---\n([\s\S]*?)\n---\n/` regex + `parseYamlArray()` multi-line/inline detection. `writeAnnexFile()` wraps full source in `.annex.sum` fenced blocks with `GENERATED_MARKER` header. `getSumPath()` appends `.sum`, `getAnnexPath()` replaces extension. `formatYamlArray()` uses inline `[a, b, c]` if ≤3 items and each <40 chars, else multi-line `- item` format.

**[agents-md.ts](./agents-md.ts)** — `writeAgentsMd()` preserves user AGENTS.md via `rename()` → AGENTS.local.md when `!isGeneratedAgentsMd()` (marker prefix absence), injects `@AGENTS.local.md` import above LLM content, prepends `GENERATED_MARKER` with version (`<!-- Generated by agents-reverse-engineer v${getVersion()} -->`). Strips marker from LLM content via `indexOf('-->')` + slice before assembly. Called by phase-2 directory aggregation in `src/generation/executor.ts`.

**[claude-md.ts](./claude-md.ts)** — `writeClaudeMdPointer()` generates root CLAUDE.md with `@AGENTS.md` import, renames user CLAUDE.md → CLAUDE.local.md + prepends `@CLAUDE.local.md` when `GENERATED_MARKER_PREFIX` missing. Deterministic output template: marker + optional `@CLAUDE.local.md` + `@AGENTS.md`.

**[index.ts](./index.ts)** — Barrel export for `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `SumFileContent` (from sum.ts), `writeAgentsMd` (from agents-md.ts), `writeClaudeMdPointer` (from claude-md.ts).

## File Relationships

`claude-md.ts` imports `GENERATED_MARKER`, `GENERATED_MARKER_PREFIX` from `agents-md.ts` for user-content detection. `agents-md.ts` imports `getVersion` from `../../version.js` for version-tagged marker. `sum.ts` imports `SummaryMetadata` from `../types.js` (defines `purpose`, `criticalTodos`, `relatedFiles` schema) and `GENERATED_MARKER` from `agents-md.ts` for annex headers. All three modules consumed by `src/generation/executor.ts` (phase-1 calls `writeSumFile()`, phase-2 calls `writeAgentsMd()`), `src/update/orchestrator.ts` (staleness detection via `readSumFile()` + `contentHash` comparison), root pointer generation (calls `writeClaudeMdPointer()`).

## Behavioral Contracts

### GENERATED_MARKER
```javascript
GENERATED_MARKER_PREFIX = '<!-- Generated by agents-reverse-engineer'
GENERATED_MARKER = '<!-- Generated by agents-reverse-engineer v${getVersion()} -->'
```

### YAML Array Serialization
```javascript
// Inline format: items.length <= 3 && items.every(x => x.length < 40)
formatYamlArray(items) => `[${items.join(', ')}]`
// Multi-line format: otherwise
formatYamlArray(items) => items.map(x => `- ${x}`).join('\n')
```

### Frontmatter Extraction
```regex
/^---\n([\s\S]*?)\n---\n/
```
Captures entire YAML block between triple-dash delimiters.

### Inline Array Parsing
```regex
/key:\s*\[([^\]]*)\]/
```
Captures content between square brackets in `key: [a, b, c]` format.

### Multi-line Array Parsing
```regex
/key:\s*\n((?:\s+-\s+.+\n?)+)/m
```
Captures multi-line `- item` format after key with colon.

### User Content Detection
```javascript
isGeneratedAgentsMd(path) => content.includes(GENERATED_MARKER_PREFIX)
// Absence triggers rename → AGENTS.local.md / CLAUDE.local.md
```

### Annex Filename Transformation
```javascript
getAnnexPath('foo.ts') => 'foo.annex.sum'
// Replaces extension, does NOT append (differs from .sum behavior)
```