<!-- Generated by agents-reverse-engineer -->

# generation/writers

Implements `.sum` file and `AGENTS.md` serialization with YAML frontmatter parsing, user content preservation, and annex file generation for reproduction-critical source content.

## Contents

### [sum.ts](./sum.ts)
YAML frontmatter I/O for `.sum` files with SHA-256 hash tracking, array serialization (inline/multi-line), annex file generation for reproduction-critical content. Exports `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `writeAnnexFile`, `getAnnexPath`, `parseSumFile`, `formatSumFile`, `SumFileContent` interface.

### [agents-md.ts](./agents-md.ts)
AGENTS.md lifecycle management preserving user-authored content via AGENTS.local.md rename, marker-based detection. Exports `writeAgentsMd`, `isGeneratedAgentsMd`, `GENERATED_MARKER` constant.

### [index.ts](./index.ts)
Barrel re-exporting `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `SumFileContent` from `sum.ts` and `writeAgentsMd` from `agents-md.ts`.

## Data Flow

**Phase 1 (File Analysis):**
`src/generation/executor.ts` → `writeSumFile(sourcePath, content)` → appends `.sum` extension → `formatSumFile()` → `mkdir` + `writeFile` → emits `.sum` file with frontmatter delimiter `---\n...\n---\n` + summary body.

**Phase 2 (Directory Aggregation):**
`src/generation/orchestrator.ts` → `writeAgentsMd(dirPath, projectRoot, llmContent)` → checks existing AGENTS.md via `isGeneratedAgentsMd()` → renames user file to AGENTS.local.md → prepends preserved content + separator `---` + LLM-generated sections.

**Incremental Updates:**
`src/update/orchestrator.ts` → `readSumFile(getSumPath(sourcePath))` → `parseSumFile()` extracts `contentHash` → SHA-256 comparison → hash mismatch triggers re-analysis.

**Orphan Cleanup:**
`src/update/orphan-cleaner.ts` → detects stale `.sum` files for deleted sources → calls `unlink(getSumPath(deletedPath))`.

## YAML Frontmatter Format

**Delimiter:** `---\n` before and after metadata block, exactly one newline before summary body.

**Scalar fields:**
```yaml
generated_at: 2026-02-09T12:34:56.789Z
content_hash: a3f5d8e9... (SHA-256 hex, 64 chars)
purpose: Single-line description
```

**Array fields (inline format <40 chars, ≤3 items):**
```yaml
critical_todos: [Security issue, Performance bug]
related_files: [path/to/file.ts]
```

**Array fields (multi-line format):**
```yaml
critical_todos:
  - Long security issue description exceeding 40 characters
  - Another long description
related_files:
  - very/long/path/to/related/file/exceeding/character/limit.ts
```

## Parsing Strategies

**Frontmatter extraction:** Regex `/^---\n([\s\S]*?)\n---\n/` captures metadata block.

**Scalar field extraction:** Individual regex per field (`/generated_at:\s*(.+)/`, `/content_hash:\s*(.+)/`, `/purpose:\s*(.+)/`), captures group 1, trims whitespace.

**Array parsing (inline):** `new RegExp(\`${key}:\\s*\\[([^\\]]*)\\]\`)` captures comma-separated values within brackets, splits on `,`, strips quotes and whitespace.

**Array parsing (multi-line):** `new RegExp(\`${key}:\\s*\\n((?:\\s+-\\s+.+\\n?)+)\`, 'm')` captures indented list items, splits on newlines, strips `- ` prefix per line.

## User Content Preservation Workflow

1. `writeAgentsMd()` called with `dirPath` and LLM-generated `content`
2. Constructs `agentsPath` (`dirPath/AGENTS.md`) and `localPath` (`dirPath/AGENTS.local.md`)
3. If `agentsPath` exists and `isGeneratedAgentsMd(agentsPath)` returns `false`: `rename(agentsPath, localPath)`, capture content as `userContent`
4. Else if `localPath` exists: `readFile(localPath)`, capture as `userContent`
5. Strip `GENERATED_MARKER` prefix from LLM `content` if present via `slice()` + `/^\n+/` trim
6. Assemble `finalContent`:
   - `GENERATED_MARKER` comment
   - If `userContent.trim()` non-empty: preservation comment + `userContent.trim()` + `---` separator
   - LLM-generated sections
7. `mkdir(dirPath, { recursive: true })` + `writeFile(agentsPath, finalContent)`

## Annex File Generation

`writeAnnexFile(sourcePath, sourceContent)` creates `${sourcePath}.annex.md`:
```markdown
<!-- Generated by agents-reverse-engineer -->

# Annex: <basename>

This annex file preserves the full source content of `<basename>` for AI coding assistants.
The primary summary is in `<basename>.sum`.

```<ext>
<sourceContent>
```
```

Used for files containing long regex patterns, template strings, or format specifications where verbatim content required for reproduction. `getAnnexPath()` computes path without filesystem access.

## Behavioral Contracts

**Marker detection:** `content.includes('<!-- Generated by agents-reverse-engineer -->')` substring search (no regex).

**Marker removal:** `llmContent.startsWith(GENERATED_MARKER) ? llmContent.slice(GENERATED_MARKER.length).replace(/^\n+/, '') : llmContent`.

**File extensions:** `.sum` (metadata + summary), `.annex.md` (full source preservation).

**User content separator:** Three-dash horizontal rule surrounded by blank lines (`\n\n---\n\n`).

**Frontmatter regex:** `/^---\n([\s\S]*?)\n---\n/` non-greedy capture of metadata block.

**Array inline regex:** `` new RegExp(`${key}:\\s*\\[([^\\]]*)\\]`) `` captures values within square brackets.

**Array multi-line regex:** `` new RegExp(`${key}:\\s*\\n((?:\\s+-\\s+.+\\n?)+)`, 'm') `` captures indented list items starting with `- `.

## Integration Points

**Imports:**
- `../types.js` → `SummaryMetadata` (metadata structure for frontmatter)
- `./agents-md.js` → `GENERATED_MARKER` (annex file header constant)

**Consumed By:**
- `src/generation/executor.ts` → `writeSumFile()` for Phase 1 output
- `src/generation/orchestrator.ts` → `writeAgentsMd()` for Phase 2 output
- `src/update/orchestrator.ts` → `readSumFile()` for hash comparison
- `src/update/orphan-cleaner.ts` → `getSumPath()` for stale file deletion
- `src/generation/collector.ts` → reads AGENTS.local.md when aggregating subdirectory docs