<!-- Generated by agents-reverse-engineer -->

# src/generation/writers

**YAML frontmatter-based file I/O layer implementing `.sum` file persistence with SHA-256 hashing, `AGENTS.md` generation with user content preservation, and `.annex.md` verbatim source archival for reproduction-critical artifacts.**

## Contents

### Core Writers

**[sum.ts](./sum.ts)** — SHA-256-tracked `.sum` file I/O with YAML frontmatter serialization via `writeSumFile()`/`readSumFile()`/`formatSumFile()`/`parseSumFile()`, regex-based field extraction (`/generated_at:\s*(.+)/`, `/content_hash:\s*(.+)/`, `/purpose:\s*(.+)/`), dual-format YAML array handling (inline `[a,b,c]` vs multi-line `  - item`) via `parseYamlArray()`/`formatYamlArray()`, `.annex.md` verbatim source archival via `writeAnnexFile()` for reproduction-critical files, path resolution via `getSumPath()`/`getAnnexPath()`.

**[agents-md.ts](./agents-md.ts)** — `AGENTS.md` preservation logic via `writeAgentsMd()` four-step workflow: (1) detects user-authored files lacking `GENERATED_MARKER` and renames to `AGENTS.local.md`, (2) reads preserved `AGENTS.local.md` content, (3) strips marker prefix from LLM content, (4) assembles final output with marker header + user content block (`<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->` delimiter) + horizontal rule + LLM content. Exports `isGeneratedAgentsMd()` marker detection predicate.

**[index.ts](./index.ts)** — Barrel re-exporting `writeSumFile`/`readSumFile`/`getSumPath`/`sumFileExists`/`SumFileContent` from sum.ts and `writeAgentsMd` from agents-md.ts for unified import in `src/generation/executor.ts`.

## File Naming Conventions

- **Summary files**: `<sourcePath>.sum` (e.g., `foo.ts` → `foo.ts.sum`)
- **Annex files**: `<sourcePath>.annex.md` (e.g., `foo.ts` → `foo.ts.annex.md`)
- **Preserved user docs**: `AGENTS.md` → `AGENTS.local.md` (renamed on first generation)

## YAML Frontmatter Structure

`.sum` files use YAML frontmatter block delimited by `---\n...\n---\n`:

```yaml
---
generated_at: 2026-02-09T12:34:56.789Z
content_hash: a3f5d8e9... (SHA-256 hex digest)
purpose: One-line file purpose statement
critical_todos: [Security issue, Performance bottleneck]
related_files: [../config/schema.ts, ./index.ts]
---

Markdown summary content...
```

**Field serialization rules** (via `formatYamlArray()`):
- Arrays with ≤3 items where all items <40 chars: inline format `key: [a, b, c]`
- Otherwise: multi-line format with `  - ` prefix per item

**Parsing patterns** (via `parseSumFile()`):
- Frontmatter block extraction: `/^---\n([\s\S]*?)\n---\n/`
- Scalar fields: `/generated_at:\s*(.+)/`, `/content_hash:\s*(.+)/`, `/purpose:\s*(.+)/`
- Arrays: inline `/key:\s*\[([^\]]*)\]/`, multi-line `/key:\s*\n((?:\s+-\s+.+\n?)+)/m`

## User Content Preservation Strategy

`writeAgentsMd()` implements two-path detection for existing `AGENTS.md` files:

1. **First-time generation**: If existing `AGENTS.md` lacks `GENERATED_MARKER` (via `isGeneratedAgentsMd()` substring search), rename to `AGENTS.local.md` to preserve user content
2. **Subsequent runs**: Read `AGENTS.local.md` if already exists from prior rename operation

Final assembly concatenates:
1. `GENERATED_MARKER` constant: `'<!-- Generated by agents-reverse-engineer -->'`
2. User content block (if present): `<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->\n<content>\n---`
3. LLM-generated content (with marker prefix stripped if present)

Ensures AI assistants see user-defined directory context before generated summaries during codebase navigation.

## Annex File Pattern

**Purpose**: Archive verbatim source content for reproduction-critical files (e.g., prompt templates with regex patterns, config schemas with magic constants) whose behavioral contracts cannot fit within `.sum` word limits.

**Generated format** (via `writeAnnexFile()`):
```markdown
<!-- Generated by agents-reverse-engineer -->
# Annex: <fileName>

Reproduction-critical source content from `<fileName>`.
Referenced by `<fileName>.sum`.

```
<triple-backtick code fence with full source content>
```
```

**Reference pattern**: `.sum` files include `## Annex References` section linking to annex: `[templates.ts.annex.md](./templates.ts.annex.md)`.

## Integration with Generation Pipeline

**Phase 1 (File Analysis)**:
- `src/generation/executor.ts` calls `writeSumFile()` after LLM subprocess returns `SumFileContent`
- `writeSumFile()` creates `.sum` alongside source file via `mkdir({ recursive: true })`
- Optional `writeAnnexFile()` call for files flagged as reproduction-critical

**Phase 2 (Directory Aggregation)**:
- `src/generation/executor.ts` reads child `.sum` files via `readSumFile()` for aggregation prompts
- After LLM generates directory summary, calls `writeAgentsMd()` to assemble final `AGENTS.md`
- `writeAgentsMd()` preserves any existing `AGENTS.local.md` content above generated sections

**Phase 3 (Root Synthesis)**:
- Root document generators consume all `AGENTS.md` files via `src/generation/collector.ts`
- No direct writer interaction (root docs written by `src/integration/generate.ts`)

## Change Detection Integration

`readSumFile()` exposes `contentHash` field parsed from YAML frontmatter, consumed by `src/update/orchestrator.ts` for SHA-256-based incremental update detection:

1. Read current file content hash via `src/change-detection/detector.ts`
2. Read `.sum` file's stored `contentHash` via `readSumFile()`
3. Hash mismatch → add to regeneration queue
4. Hash match → skip (file unchanged)

## Error Handling

- **`readSumFile()`**: Returns `null` on missing file or parse failure (no exceptions thrown)
- **`sumFileExists()`**: Returns `false` if `readSumFile()` returns `null`
- **`isGeneratedAgentsMd()`**: Returns `false` on read errors (treats missing files as non-generated)
- **`writeAgentsMd()`**: Silent try-catch blocks for existing `AGENTS.md` / `AGENTS.local.md` reads, treats absence as `null` user content
- **`writeSumFile()` / `writeAnnexFile()`**: No error handling—writeFile failures bubble to caller

## Behavioral Contracts

### Regex Patterns (sum.ts)

**Frontmatter extraction**:
- Block delimiter: `/^---\n([\s\S]*?)\n---\n/`
- Scalar fields: `/<key>:\s*(.+)/` (e.g., `generated_at`, `content_hash`, `purpose`)
- Inline array: `/<key>:\s*\[([^\]]*)\]/`
- Multi-line array: `/<key>:\s*\n((?:\s+-\s+.+\n?)+)/m`

**Value normalization**:
- Quote stripping: `/^["']|["']$/g` (removes leading/trailing quotes from inline array items)
- Leading newline removal: `/^\n+/` (strips marker prefix from LLM content)

### Constants

**GENERATED_MARKER** (agents-md.ts): `'<!-- Generated by agents-reverse-engineer -->'` — marker for tool-generated `AGENTS.md` detection, referenced by `isGeneratedAgentsMd()` substring search and `writeAgentsMd()` marker injection/stripping.