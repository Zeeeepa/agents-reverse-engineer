<!-- Generated by agents-reverse-engineer -->

# src/generation/writers

**.sum file and AGENTS.md lifecycle management: YAML frontmatter serialization with SHA-256 content hashing, filesystem I/O with parent directory creation, user content preservation via AGENTS.local.md renaming, and generation marker injection for provenance tracking.**

## Contents

### Core Writers

**[sum.ts](./sum.ts)** — `.sum` file I/O with `writeSumFile()` (YAML frontmatter serialization via `formatSumFile()`, SHA-256 `content_hash` persistence), `readSumFile()` (regex-based frontmatter extraction via `parseSumFile()`, null on parse failure), `getSumPath()` (appends `.sum` extension), `sumFileExists()` (filesystem check via `readSumFile()` null test), `parseYamlArray()` (supports inline `[a, b, c]` and multi-line `- item` formats), `formatYamlArray()` (inline format for ≤3 items <40 chars, multi-line otherwise).

**[agents-md.ts](./agents-md.ts)** — `AGENTS.md` lifecycle with `writeAgentsMd()` (four-step protocol: AGENTS.md → AGENTS.local.md rename if missing `GENERATED_MARKER`, fallback AGENTS.local.md load, marker stripping from LLM content, assembly with user content prepended in comment block), `isGeneratedAgentsMd()` (substring check for `GENERATED_MARKER`), `GENERATED_MARKER` constant (`'<!-- Generated by agents-reverse-engineer -->'`).

**[index.ts](./index.ts)** — Barrel re-export of `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `SumFileContent` from `./sum.js` and `writeAgentsMd` from `./agents-md.js`.

## Serialization Strategy

### YAML Frontmatter Format

sum.ts implements custom YAML serialization avoiding library dependencies. `formatSumFile()` produces frontmatter with required fields (`generated_at`, `content_hash`, `purpose`) and conditionally includes optional arrays (`critical_todos`, `related_files`) via `formatYamlArray()`. Frontmatter separated from markdown summary body with `---` delimiters.

Inline array format (`key: [a, b, c]`) used when all items <40 chars and array length ≤3. Multi-line format (`key:\n  - item`) used otherwise. Empty arrays serialized as `key: []`.

### Frontmatter Parsing

`parseSumFile()` extracts frontmatter via `/^---\n([\s\S]*?)\n---\n/` regex, parses single-line fields (`generated_at: value`) via targeted patterns, delegates array parsing to `parseYamlArray()`. Returns null on regex match failure or missing required fields.

`parseYamlArray()` supports dual formats: inline via `/key:\s*\[([^\]]*)\]/` and multi-line via `/key:\s*\n((?:\s+-\s+.+\n?)+)/m`. Trims whitespace and quote characters from extracted items.

## User Content Preservation

agents-md.ts implements two-pass user content detection. `writeAgentsMd()` first checks in-place `AGENTS.md` for `GENERATED_MARKER` absence (indicating user-authored content), renames to `AGENTS.local.md` if non-generated. Second pass reads `AGENTS.local.md` from previous runs as fallback.

User content prepended to LLM-generated content with comment block wrapper:
```
<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->
[user content]
---
[LLM content]
```

Strips `GENERATED_MARKER` from LLM content to prevent duplication when LLM includes marker from prompt examples. Normalizes leading newlines after stripping.

## File Relationships

**Consumed by Phase 1 (src/generation/orchestrator.ts):**
- Calls `writeSumFile()` after concurrent file analysis to persist `.sum` files with YAML frontmatter

**Consumed by Phase 2 (src/generation/executor.ts):**
- Calls `readSumFile()` to load child `.sum` files during directory aggregation
- Calls `writeAgentsMd()` after LLM synthesis of directory documentation

**Consumed by Incremental Updates (src/update/orchestrator.ts):**
- Calls `readSumFile()` to extract `content_hash` for SHA-256 comparison
- Calls `sumFileExists()` for orphan detection (stale `.sum` files for deleted sources)

**Consumed by Quality Validation (src/quality/inconsistency/code-vs-doc.ts):**
- Calls `readSumFile()` to extract exported symbols from `.sum` summaries for consistency checks

**Consumed by Orphan Cleanup (src/update/orphan-cleaner.ts):**
- Calls `getSumPath()` to compute paths for deletion of stale `.sum` files