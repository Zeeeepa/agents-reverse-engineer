<!-- Generated by agents-reverse-engineer -->

# src/generation/writers

Implements ARE's three-tier documentation output system: per-file `.sum` files with YAML frontmatter and optional annex files for large constants, directory-level `AGENTS.md` files with user-authored content preservation, and root-level `CLAUDE.md` pointer files that import AGENTS.md via `@` references.

## Contents

**[agents-md.ts](./agents-md.ts)** — Generates `AGENTS.md` files with `GENERATED_MARKER` prefix, detects user-authored content via `isGeneratedAgentsMd()`, preserves existing AGENTS.md by renaming to `AGENTS.local.md`, and injects `@AGENTS.local.md` import directive when `hasLocalContent` flag is true. Uses marker stripping via `content.startsWith(GENERATED_MARKER)` and `/^\n+/` regex to prevent double-marker accumulation.

**[claude-md.ts](./claude-md.ts)** — Writes `CLAUDE.md` pointer files via `writeClaudeMdPointer()`, imports `GENERATED_MARKER` from `agents-md.js` for user content detection, renames existing non-generated CLAUDE.md to `CLAUDE.local.md`, and builds import chain with `@CLAUDE.local.md` (conditional) and `@AGENTS.md` (always).

**[sum.ts](./sum.ts)** — Writes `.sum` files via `writeSumFile()` with YAML frontmatter (`generated_at`, `content_hash`, `purpose`, optional `critical_todos`/`related_files`), parses via `readSumFile()` and `parseSumFile()` using regex-based YAML extraction, creates `.annex.sum` sidecar files via `writeAnnexFile()` for reproduction-critical constants exceeding word limits, and formats arrays via `formatYamlArray()` with inline `[a, b]` for short arrays or multi-line `  - item` for long/wide arrays.

**[index.ts](./index.ts)** — Barrel export consolidating `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `SumFileContent` from `sum.js`, `writeAgentsMd` from `agents-md.js`, and `writeClaudeMdPointer` from `claude-md.js`.

## User Content Preservation

All writers implement rename-based preservation: detect user-authored files by absence of `GENERATED_MARKER`, rename to `.local.md` suffix without content modification, inject `@<filename>.local.md` import directive into generated output. Strategy ensures user instructions appear first during AI agent directory traversal while preventing merge conflicts across regeneration cycles.

## Output Templates

`AGENTS.md` structure: `GENERATED_MARKER` + newline + optional `@AGENTS.local.md` + newline + LLM content. `CLAUDE.md` structure: `GENERATED_MARKER` + newline + optional `@CLAUDE.local.md` + `@AGENTS.md` + newline. `.sum` structure: `---\n` + YAML frontmatter + `---\n` + summary body. `.annex.sum` structure: `GENERATED_MARKER` + explanatory header + markdown code fence with full source.

## Behavioral Contracts

### Markers and Delimiters
- `GENERATED_MARKER`: `'<!-- Generated by agents-reverse-engineer -->'` — distinguishes ARE-generated files from user-authored content
- YAML frontmatter delimiter: `/---\n...\n---\n/` — bounds metadata section in `.sum` files
- Leading newline strip pattern: `/^\n+/` — removes excess newlines after marker extraction

### YAML Parsing Patterns
- Inline array format: `/key:\s*\[([^\]]*)\]/` — matches `key: [a, b, c]` style
- Multi-line array format: `/key:\s*\n((?:\s+-\s+.+\n?)+)/m` — matches `key:\n  - item1\n  - item2` style
- Frontmatter field extraction: `/^generated_at:\s*(.+)$/m`, `/^content_hash:\s*(.+)$/m`, `/^purpose:\s*(.+)$/m`

### File Extensions
- `.sum` — appended to source path via `${sourcePath}.sum`
- `.annex.sum` — constructed via `path.parse(sourcePath).name + '.annex.sum'`

### Array Formatting Thresholds
- Inline format: `values.length <= 3 && values.every(v => v.length < 40)`
- Multi-line format: fallback when inline thresholds exceeded

## File Relationships

`index.ts` exports all writer functions, `agents-md.ts` provides `GENERATED_MARKER` constant imported by `claude-md.ts` and `sum.ts`, `sum.ts` imports `SummaryMetadata` type from `../types.js` for frontmatter structure. Consumers in `src/generation/orchestrator.ts` invoke writers during three-phase documentation generation: file analysis calls `writeSumFile()`, directory traversal calls `writeAgentsMd()`, root assembly calls `writeClaudeMdPointer()`.

## Annex File Strategy

`writeAnnexFile()` creates `.annex.sum` files containing full source in markdown code fence when prompt templates, regex patterns, or magic constants exceed `.sum` word limits. Annex files referenced via `## Annex References` sections in `.sum` summaries, enabling AI agents to retrieve verbatim constants for reproduction tasks without cluttering navigational summaries.