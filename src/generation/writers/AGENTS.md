<!-- Generated by agents-reverse-engineer -->

# src/generation/writers

Serialization layer for three-tier documentation artifacts: `.sum` YAML frontmatter files (per-file summaries with SHA-256 content hashes), `AGENTS.md` directory aggregates (post-order hierarchical navigation), and root `CLAUDE.md` pointer (deterministic import).

## Contents

**[agents-md.ts](./agents-md.ts)** — `writeAgentsMd()` orchestrates four-step AGENTS.md generation: (1) detects user-authored files via `GENERATED_MARKER` absence → `rename()` to AGENTS.local.md, (2) checks `existsSync()` for local content, (3) strips marker from LLM output, (4) injects `@AGENTS.local.md` import when local exists. Exports `isGeneratedAgentsMd()` marker check predicate.

**[claude-md.ts](./claude-md.ts)** — `writeClaudeMdPointer()` writes deterministic `@AGENTS.md` import at project root, preserving user content by renaming unmarked CLAUDE.md → CLAUDE.local.md and prepending `@CLAUDE.local.md` import. Imports `GENERATED_MARKER` from agents-md.ts for consistency.

**[sum.ts](./sum.ts)** — `.sum` lifecycle manager: `writeSumFile()` serializes YAML frontmatter (`generated_at`, `content_hash`, `purpose`, optional `critical_todos`/`related_files`) + markdown via `formatSumFile()` (adaptive array formatting: inline `[a, b]` if ≤3 items <40 chars, else multi-line), `readSumFile()` parses via regex + `parseYamlArray()`, `writeAnnexFile()` wraps full source in fenced code blocks for reproduction-critical artifacts, `getSumPath()`/`getAnnexPath()` compute paths, `sumFileExists()` checks presence.

**[index.ts](./index.ts)** — Barrel re-export aggregating `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `SumFileContent` (sum.ts), `writeAgentsMd` (agents-md.ts), `writeClaudeMdPointer` (claude-md.ts) for upstream orchestrators.

## Architecture

### User Content Preservation

Both AGENTS.md and CLAUDE.md writers follow rename-then-import pattern to preserve uncommitted local documentation:

1. Check `content.includes(GENERATED_MARKER)` on existing file
2. If absent (user-authored), `rename()` to `*.local.md`
3. Prepend `@*.local.md` import directive to generated output
4. Write with `GENERATED_MARKER` header

### YAML Frontmatter Serialization

`formatSumFile()` uses adaptive array formatting controlled by item count and length thresholds:
- **Inline** (`key: [a, b, c]`): arrays ≤3 items where each item <40 characters
- **Multi-line** (`key:\n  - item`): exceeds count/length threshold

`parseSumFile()` supports both formats via dual-regex strategy:
- `/key:\s*\[([^\]]*)\]/` for inline arrays
- `/key:\s*\n((?:\s+-\s+.+\n?)+)/m` for multi-line arrays

### Integration Points

**Phase 1 (File Analysis)**: `src/generation/executor.ts` calls `writeSumFile()` after `AIService.call()`, passes `computeContentHash()` in metadata for staleness detection.

**Phase 2 (Directory Aggregation)**: executor calls `readSumFile()` during `buildDirectoryPrompt()`, then `writeAgentsMd()` for each directory post-order, finally `writeClaudeMdPointer()` at root.

**Update Pipeline**: `src/update/orchestrator.ts` `preparePlan()` reads `.sum` frontmatter via `readSumFile()`, compares `contentHash` fields, triggers regeneration on mismatch.

## File Relationships

```
sum.ts → ../types.js (SummaryMetadata)
sum.ts → agents-md.js (GENERATED_MARKER)
agents-md.ts ← claude-md.ts (GENERATED_MARKER)
index.ts ← all three (public API aggregation)
```

## Behavioral Contracts

### Generated File Marker
```javascript
GENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'
```

### YAML Array Format Rules
```javascript
// Inline if: items.length <= 3 && items.every(item => item.length < 40)
key: [value1, value2, value3]

// Multi-line otherwise:
key:
  - value1
  - value2
```

### Frontmatter Extraction Regex
```regex
/^---\n([\s\S]*?)\n---\n/
```
Captures YAML block between triple-dash delimiters at file start.

### Array Parsing Regex (Inline)
```regex
/key:\s*\[([^\]]*)\]/
```
Captures comma-separated values within square brackets.

### Array Parsing Regex (Multi-line)
```regex
/key:\s*\n((?:\s+-\s+.+\n?)+)/m
```
Captures multi-line list items prefixed with `- `.

### AGENTS.md Output Structure
```markdown
<!-- Generated by agents-reverse-engineer -->

@AGENTS.local.md

[LLM-generated content]
```
Local import only present if user content detected.

### CLAUDE.md Output Structure
```markdown
<!-- Generated by agents-reverse-engineer -->

@CLAUDE.local.md
@AGENTS.md

```
Deterministic root pointer with optional local import.