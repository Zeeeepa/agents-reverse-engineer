<!-- Generated by agents-reverse-engineer -->

# src/generation/writers

Exports two-tier documentation serializers: `writeSumFile` and `readSumFile` for file-level `.sum` YAML-frontmatter artifacts, and `writeAgentsMd` for directory-level `AGENTS.md` aggregation with user-content preservation.

## Contents

### [sum.ts](./sum.ts)
Implements `.sum` file I/O with YAML frontmatter containing `generated_at`, `content_hash` (SHA-256), `purpose`, optional `critical_todos` and `related_files`. `writeSumFile` creates `${sourcePath}.sum` via `mkdir` and `writeFile`. `parseSumFile` regex-extracts frontmatter delimiters, parses inline `[a, b, c]` and multi-line YAML arrays via `parseYamlArray`. `readSumFile` returns `SumFileContent | null`, consumed by `src/change-detection/detector.ts` for hash-based change detection and by `src/generation/orchestrator.ts` for incremental update reads.

### [agents-md.ts](./agents-md.ts)
Generates directory-level `AGENTS.md` with user-authored content preservation. `writeAgentsMd` detects existing `AGENTS.md` lacking `GENERATED_MARKER`, renames to `AGENTS.local.md`, prepends user content above LLM-generated sections. `isGeneratedAgentsMd` checks for `'<!-- Generated by agents-reverse-engineer -->'` marker. Final structure: marker → optional `AGENTS.local.md` block with separator → stripped LLM content. Consumed by `src/generation/orchestrator.ts` during post-order Phase 2 directory traversal.

### [index.ts](./index.ts)
Barrel re-export aggregating `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `SumFileContent` from `sum.js` and `writeAgentsMd` from `agents-md.js`. Imported by `src/generation/orchestrator.ts` and `src/update/orchestrator.ts` to access both file-level and directory-level writers.

## File Format Specifications

### .sum File Structure
```
---
generated_at: ISO-8601 timestamp
content_hash: SHA-256 hex digest
purpose: single-line string
critical_todos: [inline, array] OR
  - multiline
  - format
related_files: [inline] OR multiline
---
Summary text content (markdown)
```

### AGENTS.md Structure
```
<!-- Generated by agents-reverse-engineer -->
<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->
[User content from AGENTS.local.md if present]
---
[LLM-generated directory documentation]
```

## Integration Points

**Phase 1 (Concurrent File Analysis)**: `writeSumFile` invoked by `src/generation/executor.ts` workers via pool for each discovered file, writing atomic `.sum` artifacts with `contentHash` for change detection.

**Phase 2 (Post-Order Directory Aggregation)**: `writeAgentsMd` invoked by `src/generation/orchestrator.ts` during bottom-up directory traversal, consuming `.sum` files from Phase 1 to construct directory-level overviews.

**Change Detection**: `readSumFile` consumed by `src/change-detection/detector.ts` to compare stored `contentHash` against current file content SHA-256, enabling skip-unchanged optimization in `src/update/orchestrator.ts`.

**Orphan Cleanup**: `sumFileExists` predicate used by `src/update/orphan-cleaner.ts` to detect stale `.sum` files when source files deleted.

## Content Hash Strategy

`sum.ts` computes SHA-256 digest of source file content via `createHash('sha256').update(content).digest('hex')`, stored in `.sum` frontmatter as `content_hash` field. Change detection compares stored hash against recomputed hash to skip redundant AI analysis during incremental `update` command execution.

## User Content Merge Protocol

`writeAgentsMd` implements rename-and-prepend strategy: on first run, user-authored `AGENTS.md` → `AGENTS.local.md`, prepended above generated content. Subsequent runs preserve `AGENTS.local.md`, enabling persistent user annotations visible to AI agents while allowing regeneration of LLM sections without clobbering manual edits.