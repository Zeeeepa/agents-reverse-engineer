<!-- Generated by agents-reverse-engineer -->

# writers

Serializes LLM-generated documentation to filesystem as .sum files, AGENTS.md directory indexes, and CLAUDE.md pointers while preserving user-authored content through .local.md renaming and @import directives.

## Contents

### [agents-md.ts](./agents-md.ts)
Exports `writeAgentsMd(dirPath, projectRoot, content)` for writing AGENTS.md, `isGeneratedAgentsMd(filePath)` for detecting generated files via `GENERATED_MARKER`, and `GENERATED_MARKER` constant (`<!-- Generated by agents-reverse-engineer -->`). Renames user-authored AGENTS.md to AGENTS.local.md and injects `@AGENTS.local.md` import directive before LLM content.

### [claude-md.ts](./claude-md.ts)
Exports `writeClaudeMdPointer(dirAbsolutePath)` which generates deterministic CLAUDE.md with `@AGENTS.md` import line. Renames user CLAUDE.md to CLAUDE.local.md and prepends `@CLAUDE.local.md` directive when detected.

### [index.ts](./index.ts)
Barrel export aggregating `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `SumFileContent` from `./sum.js`, `writeAgentsMd` from `./agents-md.js`, and `writeClaudeMdPointer` from `./claude-md.js`. Public API boundary for `src/generation/orchestrator.ts`.

### [sum.ts](./sum.ts)
Exports `writeSumFile(sourcePath, content)` for .sum serialization, `readSumFile(sumPath)` and `parseSumFile(content)` for parsing, `getSumPath(sourcePath)` and `sumFileExists(sourcePath)` for path resolution, `writeAnnexFile(sourcePath, sourceContent)` and `getAnnexPath(sourcePath)` for annex generation. Defines `SumFileContent` type with `summary`, `metadata`, `generatedAt`, `contentHash` fields.

## File Format Contracts

### .sum YAML Frontmatter

```
---
generated_at: <ISO timestamp>
content_hash: <SHA-256 hex>
purpose: <single-line summary>
critical_todos: [item1, item2] or
  - item1
  - item2
related_files: [path1, path2] or
  - path1
  - path2
---
<Markdown body>
```

Frontmatter parsed via `/^---\n([\s\S]*?)\n---\n/`, scalars via `/purpose:\s*(.+)/`, arrays via `parseYamlArray` handling inline `key: [a, b, c]` and multi-line `key:\n  - item` formats. Serialized via `formatYamlArray` using inline when `length <= 3` and all items under 40 chars, else multi-line with `  - ` indent.

### AGENTS.md Structure

```
<!-- Generated by agents-reverse-engineer -->

[@AGENTS.local.md (optional)]
@AGENTS.md
<LLM markdown body>
```

`writeAgentsMd` strips `GENERATED_MARKER` prefix from LLM content, injects optional `@AGENTS.local.md` directive when user file exists, reassembles with newline separators.

### CLAUDE.md Pointer Template

```
<!-- Generated by agents-reverse-engineer -->

[@CLAUDE.local.md (optional)]
@AGENTS.md

```

`writeClaudeMdPointer` emits fixed structure with conditional local import, always includes `@AGENTS.md`, terminates with blank line.

## User Content Preservation Protocol

1. **Detection**: `isGeneratedAgentsMd` tests for `GENERATED_MARKER` presence
2. **Rename**: User files lacking marker renamed to `.local.md` suffix via `fs/promises.rename`
3. **Import Injection**: `@<filename>.local.md` directive inserted after marker, before LLM content
4. **Idempotence**: Subsequent runs detect existing `.local.md`, skip rename, preserve directive

Applied by `writeAgentsMd` for AGENTS.md and `writeClaudeMdPointer` for CLAUDE.md using identical rename-and-import pattern.

## Annex File Generation

`writeAnnexFile(sourcePath, sourceContent)` produces `<basename>.annex.sum` files for reproduction-critical source content. Output format: `GENERATED_MARKER` header, triple-backtick fenced code block, cross-reference comment. Path computed via `getAnnexPath` stripping extension with `path.parse`, substituting `.annex.sum`. Example: `prompts/templates.ts` → `prompts/templates.annex.sum`.

## Dependencies

- `node:fs/promises` — `writeFile`, `readFile`, `mkdir`, `rename` for I/O
- `node:fs` — `existsSync` for synchronous checks
- `node:path` — `join`, `parse`, `dirname` for path manipulation
- `../types.js` — `SummaryMetadata` type imported by sum.ts
- `./agents-md.js` — `GENERATED_MARKER` shared across writers

## Orchestration Integration

`src/generation/orchestrator.ts` invokes writers in three phases:

1. **File Phase**: Parallel `writeSumFile` calls from worker pool produce per-file .sum artifacts
2. **Directory Phase**: Post-order `writeAgentsMd` aggregates .sum files into AGENTS.md per directory
3. **Root Phase**: Single `writeClaudeMdPointer` creates deterministic entry point at project root