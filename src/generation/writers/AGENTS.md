<!-- Generated by agents-reverse-engineer -->

# src/generation/writers

`.sum` file I/O with YAML frontmatter serialization, `AGENTS.md` lifecycle management with user content preservation, and path resolution utilities for Phase 1/Phase 2 writer operations.

## Contents

**[sum.ts](./sum.ts)** — Serializes `SumFileContent` to `.sum` files with YAML frontmatter (`generated_at`, `content_hash`, `purpose`, `critical_todos`, `related_files`), parses frontmatter via regex extraction of inline/multi-line arrays, computes `.sum` paths via `getSumPath()`, validates existence via `sumFileExists()`.

**[agents-md.ts](./agents-md.ts)** — Writes directory-level `AGENTS.md` with `GENERATED_MARKER` ownership detection, preserves user-authored content by renaming to `AGENTS.local.md` and prepending above LLM output, strips marker prefix from incoming content, constructs final structure with optional user content block and `---` separator.

**[index.ts](./index.ts)** — Re-exports `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `SumFileContent` from `sum.ts` and `writeAgentsMd` from `agents-md.ts` as public API boundary.

## YAML Frontmatter Format

sum.ts serializes frontmatter with adaptive array formatting: inline `[a, b, c]` for ≤3 items under 40 chars each, multi-line `- item` otherwise. Parses via dual-pattern regex supporting both syntaxes. Mandatory fields: `generated_at` (ISO 8601), `content_hash` (SHA-256 hex), `purpose` (single-line string). Optional arrays: `critical_todos`, `related_files`.

## User Content Preservation

agents-md.ts implements idempotent preservation via four-step workflow:

1. Read existing `AGENTS.md`, detect user authorship via `GENERATED_MARKER` absence, rename to `AGENTS.local.md` if user-authored
2. Attempt read of already-renamed `AGENTS.local.md` from previous run if step 1 found no user content
3. Strip `GENERATED_MARKER` prefix from incoming LLM content via `slice()` + `/^\n+/` normalization
4. Construct final content: `GENERATED_MARKER` → optional user block with `<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->` header and `---` separator → LLM content, write via `writeFile()` with `mkdir({recursive: true})`

Preserved content prepended above generated content ensures AI assistants encounter project-specific context before auto-generated summaries.

## Path Resolution

`getSumPath(sourcePath)` returns `${sourcePath}.sum` for given source file. No directory transformation — `.sum` files colocate with source files throughout tree. `sumFileExists()` delegates to `readSumFile()` non-null check, avoiding redundant `access()` syscalls.

## Integration with Pipeline Phases

**Phase 1 (File Analysis):** `src/generation/executor.ts` workers call `writeSumFile()` after AI subprocess returns `SumFileContent`, writes to path from `getSumPath(sourceFile.path)`.

**Phase 2 (Directory Aggregation):** `src/generation/orchestrator.ts` calls `readSumFile()` via `collectAgentsDocs()` to load child `.sum` files for prompt construction, calls `writeAgentsMd()` with LLM response from `AIService.call()`.

**Incremental Updates:** `src/update/orphan-cleaner.ts` calls `readSumFile()` to extract `content_hash` from YAML frontmatter for SHA-256 comparison, `cleanupEmptyDirectoryDocs()` uses `isGeneratedAgentsMd()` to determine deletion eligibility.

**Cleanup:** `src/cli/clean.ts` calls `isGeneratedAgentsMd()` to filter deletion targets, skips user-authored files, restores `AGENTS.local.md` → `AGENTS.md` after removing generated version.

## Behavioral Contracts

**GENERATED_MARKER constant:**
```javascript
'<!-- Generated by agents-reverse-engineer -->'
```

**Frontmatter extraction regex (parseSumFile):**
```javascript
/^---\n([\s\S]*?)\n---\n/
```

**Field patterns:**
```javascript
/generated_at:\s*(.+)/
/content_hash:\s*(.+)/
/purpose:\s*(.+)/
```

**Array parsing patterns (parseYamlArray):**
```javascript
/key:\s*\[([^\]]*)\]/  // Inline: key: [a, b, c]
/key:\s*\n((?:\s+-\s+.+\n?)+)/m  // Multi-line: key:\n  - item
```

**Quote stripping (inline arrays):**
```javascript
.replace(/^["']|["']$/g, '')
```

**Multi-line item prefix:**
```javascript
/^\s*-\s*/  // Strips leading '  - '
```

**Array format heuristic (formatYamlArray):**
- Inline if `values.length <= 3` and all items `< 40` chars
- Multi-line otherwise
- Empty: `key: []`

**Newline normalization (writeAgentsMd):**
```javascript
content.slice(GENERATED_MARKER.length).replace(/^\n+/, '')
```