<!-- Generated by agents-reverse-engineer -->

# src/generation/writers

Serialization layer for three-tier documentation artifacts: per-file `.sum` YAML+markdown via `writeSumFile()`, directory `AGENTS.md` aggregates via `writeAgentsMd()`, and root `CLAUDE.md` pointer via `writeClaudeMdPointer()`. Implements user content preservation by renaming non-generated files to `.local.md` variants and injecting `@import` directives.

## Contents

**[sum.ts](./sum.ts)** — Exports `writeSumFile()` (formats `SumFileContent` as YAML frontmatter + markdown body, writes to `${sourcePath}.sum`), `readSumFile()` (parses via regex `/^---\n([\s\S]*?)\n---\n/` for frontmatter + `/purpose:\s*(.+)/` for scalar fields + `parseYamlArray()` for list fields), `getSumPath()` (`${sourcePath}.sum`), `sumFileExists()` (null check), `writeAnnexFile()` (writes `${basename}.annex.sum` with fenced source content for reproduction-critical files), `getAnnexPath()` (strips extension, appends `.annex.sum`), `formatSumFile()` (serializes frontmatter: `generated_at`, `content_hash`, `purpose`, `critical_todos`, `related_files` via `formatYamlArray()` choosing inline `[a, b, c]` format when `length <= 3 && all items < 40 chars`, else multi-line `- item` format). Type `SumFileContent` defines structure: `summary: string`, `metadata: SummaryMetadata`, `generatedAt: string`, `contentHash: string`.

**[agents-md.ts](./agents-md.ts)** — Exports `writeAgentsMd(dirPath, _projectRoot, content)` (renames existing user `AGENTS.md` → `AGENTS.local.md` if missing `GENERATED_MARKER`, strips marker from LLM `content`, assembles `finalContent` joining marker + optional `@AGENTS.local.md` directive (when `hasLocalContent`) + llmContent), `isGeneratedAgentsMd(filePath)` (tests for `GENERATED_MARKER` presence), constant `GENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'`. Implements four-step preservation: detect user-authored file → rename to `.local.md` → strip LLM prefix → inject import directive.

**[claude-md.ts](./claude-md.ts)** — Exports `writeClaudeMdPointer(dirAbsolutePath)` generating root `CLAUDE.md` with `GENERATED_MARKER`, optional `@CLAUDE.local.md` (when user file renamed), and `@AGENTS.md` import line. Preservation logic: `existsSync(claudeMdPath)` → `readFile()` + test for `GENERATED_MARKER` → `rename()` user file to `CLAUDE.local.md` if missing marker → emit import directive. Degrades gracefully on `readFile()` errors by overwriting.

**[index.ts](./index.ts)** — Barrel re-export aggregating `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `SumFileContent` from `./sum.js`, `writeAgentsMd` from `./agents-md.js`, `writeClaudeMdPointer` from `./claude-md.js`. Serves as public API boundary for `src/generation/orchestrator.ts` consumers.

## File Format Contracts

### .sum YAML Frontmatter Structure
```yaml
---
generated_at: <ISO8601>
content_hash: <SHA-256 hex>
purpose: <one-line description>
critical_todos: [item1, item2, item3]  # optional, inline when <=3 items <40 chars
related_files:  # optional, multi-line when >3 items or any item >=40 chars
  - path/to/file1
  - path/to/file2
---
<markdown body>
```

### AGENTS.md Assembly Format
```markdown
<!-- Generated by agents-reverse-engineer -->
@AGENTS.local.md

<LLM-generated content>
```
Second line (`@AGENTS.local.md`) omitted when `!hasLocalContent`.

### CLAUDE.md Pointer Format
```markdown
<!-- Generated by agents-reverse-engineer -->

@CLAUDE.local.md
@AGENTS.md

```
Third line (`@CLAUDE.local.md`) omitted when no user file renamed.

## Behavioral Contracts

### Frontmatter Array Formatting Logic
```javascript
formatYamlArray(key, values) {
  if (values.length <= 3 && values.every(v => v.length < 40)) {
    return `${key}: [${values.join(', ')}]`
  }
  return `${key}:\n${values.map(v => `  - ${v}`).join('\n')}`
}
```

### Frontmatter Extraction Regex
```regex
/^---\n([\s\S]*?)\n---\n/
```
Captures YAML block between delimiters in group 1.

### Scalar Field Parsing
```regex
/purpose:\s*(.+)/
```
Extracts value in group 1 after colon and whitespace.

### Inline Array Parsing
```regex
/${key}:\s*\[([^\]]*)\]/
```
Captures comma-separated values in group 1.

### Multi-line Array Parsing
```regex
/${key}:\s*\n((?:\s+-\s+.+\n?)+)/m
```
Captures block of `- item` lines in group 1, split on `/^\s+-\s+/gm`.

### Annex Path Transformation
```javascript
getAnnexPath(sourcePath) {
  const parsed = path.parse(sourcePath)  // { dir, name, ext }
  return path.join(parsed.dir, `${parsed.name}.annex.sum`)
}
// Example: "src/foo.ts" → "src/foo.annex.sum"
```

### User Content Detection
```javascript
isGeneratedAgentsMd(filePath) {
  const content = await readFile(filePath, 'utf-8')
  return content.includes(GENERATED_MARKER)
}
```

## Dependencies

- **Node.js APIs**: `fs/promises` (`writeFile`, `readFile`, `mkdir`, `rename`), `fs` (`existsSync`), `path` (`join`, `parse`)
- **Internal**: `GENERATED_MARKER` constant shared across `agents-md.ts` / `claude-md.ts`, `SummaryMetadata` type from `../types.js`