<!-- Generated by agents-reverse-engineer -->

# src/generation/writers

**Manages `.sum` file and `AGENTS.md` file I/O operations with YAML frontmatter parsing, content hash storage, and user content preservation for the three-phase documentation pipeline.**

## Contents

### File Writers

**[sum.ts](./sum.ts)** — Writes `.sum` files via `writeSumFile(sourcePath, content)` with YAML frontmatter (`generated_at`, `content_hash`, `purpose`, optional `critical_todos`/`related_files`), reads via `readSumFile(sumPath)` using regex-based frontmatter extraction, computes paths via `getSumPath(sourcePath)` by appending `.sum` suffix, checks existence via `sumFileExists(sourcePath)`, parses arrays using `parseYamlArray()` supporting both inline `[a,b,c]` and multi-line `- item` formats, formats arrays via `formatYamlArray()` with length/character thresholds determining inline vs. multi-line output.

**[agents-md.ts](./agents-md.ts)** — Writes directory-level `AGENTS.md` via `writeAgentsMd(dirPath, _projectRoot, content)` with three-step user content preservation: detects user-authored files missing `GENERATED_MARKER` and renames to `AGENTS.local.md`, reads existing `AGENTS.local.md`, assembles final output prepending preserved content above LLM-generated markdown, uses `isGeneratedAgentsMd(filePath)` for marker detection via substring search, creates directories recursively before write.

**[index.ts](./index.ts)** — Barrel re-export providing public API: `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `SumFileContent` from `sum.ts`; `writeAgentsMd`, `isGeneratedAgentsMd`, `GENERATED_MARKER` from `agents-md.ts`.

## File Format Specifications

### .sum File Structure

```
---
generated_at: 2026-02-09T12:34:56.789Z
content_hash: a3f5d8e9... (SHA-256 hex)
purpose: One-line purpose statement
critical_todos:
  - TODO item 1
  - TODO item 2
related_files: [path1, path2]
---

Markdown summary content...
```

### AGENTS.md Structure

```markdown
<!-- Generated by agents-reverse-engineer -->

<!-- User-defined AGENTS.md preserved as AGENTS.local.md -->
[User content if AGENTS.local.md exists]
---

[LLM-generated directory overview]
```

## Integration Points

**Phase 1 (File Analysis):**
- `src/generation/executor.ts` calls `writeSumFile()` after AI summarization via worker pool
- `src/update/orchestrator.ts` calls `readSumFile()` to extract `contentHash` for change detection

**Phase 2 (Directory Aggregation):**
- `src/generation/collector.ts` calls `readSumFile()` to gather child summaries for prompt construction
- `src/generation/orchestrator.ts` calls `writeAgentsMd()` after post-order directory traversal

**Quality Validation:**
- `src/quality/inconsistency/code-vs-doc.ts` parses `.sum` files via `readSumFile()` for export verification
- `src/quality/phantom-paths/validator.ts` reads `AGENTS.md` to extract and validate path references

## Parsing Strategy

**YAML Frontmatter:**
- Uses regex `/^---\n([\s\S]*?)\n---\n/` to extract frontmatter block
- Parses key-value pairs via `String.match()` per field rather than full YAML parser dependency
- `parseYamlArray()` handles dual formats with fallback: inline array → multi-line list → empty array

**User Content Detection:**
- Substring search for `GENERATED_MARKER` avoids full markdown parsing
- Three-step lookup (existing `AGENTS.md` → `AGENTS.local.md` → null) handles all preservation scenarios
- Atomic `rename()` prevents race conditions during concurrent Phase 2 directory processing

## File System Semantics

- All writes use `mkdir({recursive: true})` to handle arbitrary nesting depth
- All reads suppress `ENOENT` errors via try-catch returning null
- UTF-8 encoding enforced for all `readFile()`/`writeFile()` calls
- No symbolic link following (uses default `fs` behavior)
- `.sum` paths always computed as `${sourcePath}.sum` (no path normalization)