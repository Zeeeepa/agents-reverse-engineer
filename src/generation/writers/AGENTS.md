<!-- Generated by agents-reverse-engineer -->

# src/generation/writers/

Serializes file analysis results and directory-level documentation to disk, managing `.sum` files with YAML frontmatter and `AGENTS.md` files with user content preservation.

## Contents

### Core Writers

**[sum.ts](./sum.ts)** — `writeSumFile()` creates `.sum` files with frontmatter (`generated_at`, `content_hash`, `purpose`, `critical_todos`, `related_files`) and summary body; `readSumFile()` parses via `parseSumFile()`; `writeAnnexFile()` generates `.annex.md` with full source in code fences; `formatYamlArray()` uses inline `[a, b]` format for ≤3 items <40 chars, otherwise multi-line bulleted format.

**[agents-md.ts](./agents-md.ts)** — `writeAgentsMd()` writes directory `AGENTS.md` files, preserving user-authored versions as `AGENTS.local.md` if no `GENERATED_MARKER` detected; `isGeneratedAgentsMd()` checks for marker presence; generated files follow structure: marker, optional user content block with separator, then LLM content.

**[index.ts](./index.ts)** — Re-exports `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `SumFileContent` from `./sum.js` and `writeAgentsMd` from `./agents-md.js`.

## Data Flow

1. `src/generation/executor.ts` calls `writeSumFile(sourcePath, content)` with `SumFileContent` object
2. `sum.ts` formats frontmatter via `formatSumFile()`, writes to `${sourcePath}.sum` 
3. If file contains reproduction-critical content, `writeAnnexFile()` creates `${sourcePath}.annex.md` with full source
4. `src/generation/collector.ts` gathers `.sum` files and calls `writeAgentsMd(dirPath, projectRoot, llmContent)`
5. `agents-md.ts` checks existing `AGENTS.md` via `isGeneratedAgentsMd()`, renames user versions to `AGENTS.local.md`, merges user + LLM content with `GENERATED_MARKER` header

## Behavioral Contracts

### YAML Frontmatter Keys (sum.ts)

Required fields:
```yaml
generated_at: <ISO 8601 timestamp>
content_hash: <SHA-256 hex digest>
purpose: <single-line description>
```

Optional fields:
```yaml
critical_todos: [item1, item2]  # or multi-line - prefixed format
related_files: [path1, path2]   # same format rules as critical_todos
```

Array format rules:
- Inline `[a, b]` when ≤3 items and each <40 chars
- Multi-line bulleted `  - item` otherwise

### File Naming Convention

- `.sum` files: `${sourcePath}.sum` (e.g., `foo.ts` → `foo.ts.sum`)
- `.annex.md` files: `${sourcePath}.annex.md` (e.g., `foo.ts` → `foo.ts.annex.md`)
- User-authored AGENTS.md preserved as: `AGENTS.local.md`

### Marker String

```
<!-- Generated by agents-reverse-engineer -->
```

Appears as first line of generated `AGENTS.md` and `.annex.md` files. Absence in existing `AGENTS.md` triggers preservation as `AGENTS.local.md`.

## Dependencies

- `node:fs/promises` (`writeFile`, `readFile`, `mkdir`, `rename`) for file I/O
- `node:path` for path construction
- `../types.js` exports `SummaryMetadata` (imported by `sum.ts`)