---
generated_at: 2026-02-09T17:45:20.386Z
content_hash: c0712c285f40f41fb325d88722e2d7bd8fd599a11ad3eb1124e785743dad01a6
purpose: GenerationOrchestrator coordinates three-phase documentation generation: prepares files by reading content, creates f...
---
**GenerationOrchestrator coordinates three-phase documentation generation: prepares files by reading content, creates file analysis tasks with prompts from buildFilePrompt, creates directory tasks for AGENTS.md synthesis, computes complexity metrics via analyzeComplexity, and emits trace events for plan creation.**

## Exported Types

**PreparedFile** represents a file ready for analysis with `filePath: string` (absolute), `relativePath: string` (from project root), `content: string` (file text).

**AnalysisTask** discriminated union with `type: 'file' | 'directory'`. File tasks include `systemPrompt?: string` and `userPrompt?: string` set during creation. Directory tasks include `directoryInfo?: { sumFiles: string[], fileCount: number }` with prompts built at execution time by buildDirectoryPrompt (not in this file).

**GenerationPlan** aggregates `files: PreparedFile[]`, `tasks: AnalysisTask[]`, `complexity: ComplexityMetrics`, `projectStructure?: string` (compact directory listing for AI context).

## Class: GenerationOrchestrator

Constructor accepts `config: Config`, `projectRoot: string`, `options?: { tracer?: ITraceWriter, debug?: boolean }`.

**prepareFiles(discoveryResult: DiscoveryResult): Promise<PreparedFile[]>** reads file content via `readFile(filePath, 'utf-8')`, computes relative paths, silently skips unreadable files.

**createFileTasks(files: PreparedFile[], projectStructure?: string): AnalysisTask[]** calls `buildFilePrompt({ filePath, content, projectPlan }, debug)` for each file, returns tasks with `type: 'file'`, `systemPrompt`, `userPrompt` populated.

**createDirectoryTasks(files: PreparedFile[]): AnalysisTask[]** groups files by `path.dirname(relativePath)`, creates tasks with `type: 'directory'`, `directoryInfo.sumFiles` as array of `${relativePath}.sum` paths, `directoryInfo.fileCount` set to group size. Prompts not built hereâ€”deferred to execution time.

**createPlan(discoveryResult: DiscoveryResult): Promise<GenerationPlan>** orchestrates plan creation: emits `phase:start` with `phase: 'plan-creation'`, calls `prepareFiles`, `analyzeComplexity`, `buildProjectStructure`, `createFileTasks`, `createDirectoryTasks`, concatenates file and directory tasks, emits `plan:created` with `planType: 'generate'` and `taskCount: tasks.length + 1` (accounting for root CLAUDE.md task added later), clears `PreparedFile.content` to free memory after prompt embedding, emits `phase:end` with `durationMs` computed via `process.hrtime.bigint()` delta.

**buildProjectStructure(files: PreparedFile[]): string** (private) groups files into `Map<dirPath, fileNames[]>`, sorts directories and filenames, formats as indented text: `${dir}/\n  ${file}` for bird's-eye AI context.

## Factory Function

**createOrchestrator(config: Config, projectRoot: string, options?: { tracer?: ITraceWriter, debug?: boolean }): GenerationOrchestrator** instantiates GenerationOrchestrator with provided parameters.

## Integration Points

Imports `buildFilePrompt` from `./prompts/index.js` to construct system/user prompts for file tasks. Imports `analyzeComplexity` from `./complexity.js` to compute `ComplexityMetrics` (directory depth). Imports `ITraceWriter` from `../orchestration/trace.js` for event emission. Imports `Config` from `../config/schema.js` and `DiscoveryResult` from `../types/index.js`.

## Trace Events

Emits `phase:start` with `{ type: 'phase:start', phase: 'plan-creation', taskCount, concurrency: 1 }` at plan start. Emits `plan:created` with `{ type: 'plan:created', planType: 'generate', fileCount, taskCount }` after task creation. Emits `phase:end` with `{ type: 'phase:end', phase: 'plan-creation', durationMs, tasksCompleted: 1, tasksFailed: 0 }` at plan completion.

## Memory Management

After `createFileTasks` embeds file content into prompts, `createPlan` clears `PreparedFile.content` fields via `(file as { content: string }).content = ''` to free memory. Comment notes runner re-reads files from disk during execution.

## Debug Logging

When `debug: true`, logs to stderr via `console.error(pc.dim(...))` for: file preparation start, complexity analysis depth, plan summary with file/task/directory counts. Uses `picocolors` for dim formatting.

## Task Count Calculation

Comment in `createPlan` notes `taskCount: tasks.length + 1` because `buildExecutionPlan()` (external to this file) adds root CLAUDE.md synthesis task after plan creation.