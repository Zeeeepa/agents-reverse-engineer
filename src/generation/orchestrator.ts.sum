---
generated_at: 2026-02-09T16:10:32.207Z
content_hash: c0712c285f40f41fb325d88722e2d7bd8fd599a11ad3eb1124e785743dad01a6
purpose: GenerationOrchestrator coordinates three-phase documentation generation: prepares files from DiscoveryResult, creates...
---
**GenerationOrchestrator coordinates three-phase documentation generation: prepares files from DiscoveryResult, creates AnalysisTask lists for concurrent file analysis and post-file directory aggregation, computes ComplexityMetrics, and emits trace events for plan lifecycle.**

## Exported Types

**PreparedFile** interface contains `filePath: string` (absolute), `relativePath: string` (from project root), `content: string` (file text).

**AnalysisTask** discriminated union via `type: 'file' | 'directory'`:
- `filePath: string` (relative path for files, directory path for directories)
- `systemPrompt?: string` and `userPrompt?: string` (populated for file tasks via buildFilePrompt, built at execution time for directory tasks via buildDirectoryPrompt)
- `directoryInfo?: { sumFiles: string[], fileCount: number }` (populated only for directory tasks)

**GenerationPlan** interface aggregates:
- `files: PreparedFile[]` (all prepared files with content initially populated, then cleared)
- `tasks: AnalysisTask[]` (file tasks followed by directory tasks)
- `complexity: ComplexityMetrics` (computed via analyzeComplexity)
- `projectStructure?: string` (compact directory tree listing)

## Core Class

**GenerationOrchestrator** constructor accepts `config: Config`, `projectRoot: string`, `options?: { tracer?: ITraceWriter, debug?: boolean }`. Stores as private fields `this.config`, `this.projectRoot`, `this.tracer`, `this.debug`.

**prepareFiles(discoveryResult: DiscoveryResult): Promise<PreparedFile[]>** reads content via `readFile(filePath, 'utf-8')`, computes `relativePath` via `path.relative(this.projectRoot, filePath)`, silently skips unreadable files (permission errors), returns array of PreparedFile objects with populated content.

**createFileTasks(files: PreparedFile[], projectStructure?: string): AnalysisTask[]** invokes `buildFilePrompt({ filePath, content, projectPlan: projectStructure }, this.debug)` for each file, returns AnalysisTask array with `type: 'file'`, `filePath: relativePath`, `systemPrompt: prompt.system`, `userPrompt: prompt.user`.

**createDirectoryTasks(files: PreparedFile[]): AnalysisTask[]** groups files via `Map<string, PreparedFile[]>` keyed by `path.dirname(relativePath)`, generates one AnalysisTask per directory with `type: 'directory'`, `filePath: dir || '.'`, `directoryInfo: { sumFiles: string[], fileCount: number }` where sumFiles contains `${relativePath}.sum` paths. Prompts intentionally omitted (built at execution time).

**createPlan(discoveryResult: DiscoveryResult): Promise<GenerationPlan>** orchestrates full planning:
1. Emits `phase:start` trace event with `phase: 'plan-creation'`, `taskCount: discoveryResult.files.length`, `concurrency: 1`
2. Calls `prepareFiles(discoveryResult)` to read file content
3. Calls `analyzeComplexity(files.map(f => f.filePath), projectRoot)` from `./complexity.js`
4. Calls `buildProjectStructure(files)` to generate compact directory tree string
5. Calls `createFileTasks(files, projectStructure)` to generate file analysis tasks
6. Calls `createDirectoryTasks(files)` to generate directory aggregation tasks
7. Concatenates `[...fileTasks, ...dirTasks]` into single tasks array
8. Clears `content` field from PreparedFile objects via `(file as { content: string }).content = ''` to free memory (content already embedded in prompts)
9. Emits `plan:created` trace event with `planType: 'generate'`, `fileCount`, `taskCount: tasks.length + 1` (+1 for root CLAUDE.md task added by buildExecutionPlan)
10. Emits `phase:end` trace event with `phase: 'plan-creation'`, `durationMs`, `tasksCompleted: 1`, `tasksFailed: 0`
11. Returns GenerationPlan object

## Factory Function

**createOrchestrator(config: Config, projectRoot: string, options?: { tracer?: ITraceWriter, debug?: boolean }): GenerationOrchestrator** constructs and returns new GenerationOrchestrator instance with provided parameters.

## Private Methods

**buildProjectStructure(files: PreparedFile[]): string** groups files via `Map<string, string[]>` keyed by `path.dirname(relativePath) || '.'`, sorts directories alphabetically, formats output as:
```
dir1/
  file1.ts
  file2.ts
dir2/
  file3.ts
```
Returns multi-line string for LLM bird's-eye context.

## Integration Points

Imports `buildFilePrompt` from `./prompts/index.js` (called per-file to generate system/user prompts with content and project structure).

Imports `analyzeComplexity` from `./complexity.js` (returns ComplexityMetrics with directoryDepth and other metrics).

Imports `Config` from `../config/schema.js` (Zod-validated configuration object).

Imports `DiscoveryResult` from `../types/index.js` (contains `files: string[]` array from file discovery phase).

Imports `ITraceWriter` from `../orchestration/trace.js` (optional tracer for NDJSON event emission with `.emit()` method).

## Memory Management

After createFileTasks embeds file content into task prompts, createPlan clears PreparedFile.content fields via cast `(file as { content: string }).content = ''` to release memory. Comment notes "The runner re-reads files from disk" during execution phase.

## Task Ordering

Tasks array contains file analysis tasks first (concurrent execution), followed by directory aggregation tasks (post-file execution). Directory tasks intentionally omit systemPrompt/userPrompt fields â€” buildDirectoryPrompt constructs these at execution time after .sum files exist.

## Trace Events

Emits three trace event types via `this.tracer?.emit()`:
- `phase:start` with `phase: 'plan-creation'`, `taskCount`, `concurrency: 1`
- `plan:created` with `planType: 'generate'`, `fileCount`, `taskCount`
- `phase:end` with `phase: 'plan-creation'`, `durationMs`, `tasksCompleted: 1`, `tasksFailed: 0`

Duration computed via `process.hrtime.bigint()` delta converted to milliseconds via `Number(delta) / 1_000_000`.

## Debug Logging

When `this.debug === true`, emits stderr messages via `console.error(pc.dim())`:
- `"[debug] Preparing files: reading and detecting types..."`
- `"[debug] Analyzing complexity..."`
- `"[debug] Complexity analysis: depth=${complexity.directoryDepth}"`
- `"[debug] Generation plan: ${files.length} files, ${tasks.length} tasks (${dirTasks.length} directories)"`

Uses `picocolors` (imported as `pc`) for dimmed output.