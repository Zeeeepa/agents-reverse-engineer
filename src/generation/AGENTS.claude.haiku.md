<!-- Generated by agents-reverse-engineer v0.9.10 -->

Based on the provided file summaries and project structure, here is the AGENTS.md for src/generation:

<!-- Generated by agents-reverse-engineer -->

# src/generation

This directory orchestrates documentation generation pipelines, combining file discovery, complexity analysis, and plan execution to produce .sum file summaries and AGENTS.md directory overviews with intelligent post-order traversal, variant support, and user content preservation.

## Contents

### Core Pipeline Files
- [collector.ts](./collector.ts) — `collectAgentsDocs()` recursively walks project tree to locate and aggregate AGENTS.md files; `collectAnnexFiles()` collects .annex.sum files for reproduction-critical constants. Both functions skip directories (node_modules, .git, .agents-reverse-engineer, vendor, dist, build, __pycache__, .next, venv, .venv, target, .cargo, .gradle) and return sorted `AgentsDocs` tuples.

- [complexity.ts](./complexity.ts) — `analyzeComplexity()` computes `ComplexityMetrics` (fileCount, directoryDepth, files Set, directories Set) from file lists; `calculateDirectoryDepth()` measures maximum nesting; `extractDirectories()` recursively traverses parent directories via `path.dirname()` until reaching filesystem root.

- [executor.ts](./executor.ts) — `buildExecutionPlan()` transforms `GenerationPlan` into `ExecutionPlan` with post-order sorted directory tasks (deepest first) and file task dependencies; `isDirectoryComplete()` checks if all files have .sum artifacts; `getReadyDirectories()` filters directories with complete .sum coverage; `formatExecutionPlanAsMarkdown()` generates GENERATION-PLAN.md with task phase breakdown and skipped file/directory counts.

- [types.ts](./types.ts) — Defines `SummaryMetadata` interface with `purpose`, optional `criticalTodos[]`, optional `relatedFiles[]` for pipeline type contracts.

## Subdirectories

### [prompts/](./prompts/)
Prompt construction utilities for file summaries and AGENTS.md synthesis. `buildFilePrompt()` handles template substitution, compression injection (when ratio < 0.5), and language detection; `buildDirectoryPrompt()` orchestrates multi-step synthesis: reads .sum files, extracts directory imports, detects .annex.sum files and manifest indicators (package.json, Cargo.toml, etc.), preserves user-authored content via `GENERATED_MARKER_PREFIX` detection, and returns update prompts when existingAgentsMd provided.

### [writers/](./writers/)
File writers for .sum serialization, AGENTS.md variants, and CLAUDE.md pointers. `readSumFile()`, `writeSumFile()` handle YAML-frontmatter .sum files with SHA-256 change detection; `writeAgentsMd()`, `writeAgentsMdHub()` manage variant suffix and marker-based user content preservation (rename to .local.md if user-authored); `writeClaudeMdPointer()` generates CLAUDE.md with @-references to AGENTS.md and optional CLAUDE.local.md.

## Architecture & Data Flow

**Generation Pipeline:** discovery → complexity analysis → execution plan building → parallel file/directory task execution → .sum + AGENTS.md output.

1. **File Discovery & Collection** (collector.ts): `collectAgentsDocs()` and `collectAnnexFiles()` recursively aggregate project documentation.

2. **Complexity Metrics** (complexity.ts): `analyzeComplexity()` computes fileCount, directoryDepth, directory ancestors from discovered file paths to inform traversal order.

3. **Execution Plan** (executor.ts): `buildExecutionPlan()` consumes `GenerationPlan` type (from src/orchestration), creates `ExecutionTask` objects (type: 'file'|'directory', path, absolutePath, systemPrompt, userPrompt, dependencies, outputPath, metadata), post-order sorts directory tasks by depth descending (deepest first) to ensure child AGENTS.md generation completes before parents, tracks all discovered files in `directoryFileMap` for complete prompt context, and marks skipped files/directories.

4. **Prompt Assembly** (prompts/): `buildFilePrompt()` and `buildDirectoryPrompt()` construct system/user prompts with template substitution, compression rules, import extraction, and preservation of existing summaries for incremental updates.

5. **Artifact Writing** (writers/): `writeSumFile()` serializes documentation into YAML-frontmatter .sum files with content hash; `writeAgentsMd()` writes directory overviews with marker-based user content detection and .local.md preservation; `writeClaudeMdPointer()` generates hub files with @-references.

**Variant Support:** Optional `variant` parameter (e.g., "claude.haiku") propagates through `getSumPath()`, `sumFileExists()`, `getAnnexPath()`, and file naming (AGENTS.${variant}.md, file.ts.${variant}.sum).

**Post-Order Traversal:** Directory tasks sorted by `getDirectoryDepth()` descending ensures parent AGENTS.md synthesis waits for all child `.sum` file completion, enabling aggregated imports and nested directory references in parent directory prompts.

## Behavioral Contracts

**Directory Task Dependencies:** fileTaskIds are formatted as `file:${f}` and assigned to directoryTasks[].dependencies; only directories in plan.tasks (plannedDirs) become ExecutionTasks.

**Complexity Depth Calculation:** directoryDepth = max(relative path segment count - 1 for file itself). Root '.' = 0, 'src' = 1, 'src/cli' = 2.

**Skip Directory List (SKIP_DIRS):** node_modules, .git, .agents-reverse-engineer, vendor, dist, build, __pycache__, .next, venv, .venv, target, .cargo, .gradle. Graceful handling: readdir/readFile failures trigger silent skip.

**Compression Ratio Trigger:** When sourceFileSize > 0 and compressionRatio < 0.5, targetSize = Math.round(sourceFileSize * ratio), maxSize = Math.round(targetSize * 1.2); aggressive compression rules injected into user prompt.

**Template Substitution Patterns:** `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}` replaced via `.replace(/\{\{...\}\}/g, ...)` in FILE_USER_PROMPT.

**Generated Marker Detection:** `GENERATED_MARKER_PREFIX` = `'<!-- Generated by agents-reverse-engineer'`; files lacking this substring treated as user-authored and preserved via rename to `.local.md` variant.

**Manifest File Indicators:** Presence of package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt, or Makefile signals project root/manifest hints in directory prompt.

**Incremental Update Mode:** FILE_UPDATE_SYSTEM_PROMPT triggered when context.existingSum truthy; DIRECTORY_UPDATE_SYSTEM_PROMPT triggered when existingAgentsMd truthy; existing content appended under "Existing Summary"/"Existing AGENTS.md" headers with explicit preserve-stable-sections instruction.

**YAML Frontmatter Arrays:** Inline format `[a, b, c]` for ≤3 short items; multi-line `- item` format otherwise. Parsing uses regex `/key:\s*\[([^\]]*)\]/` (inline) and `/key:\s*\n((?:\s+-\s+.+\n?)+)/m` (multi-line).

**Sum File Path Convention:** format `${dir}/${basename}.${ext}.sum` or `${dir}/${basename}.${ext}.${variant}.sum`; annex files follow `${dir}/${basename}.annex.sum` or `${dir}/${basename}.annex.${variant}.sum`.

**Content Hash Tracking:** SHA-256 contentHash stored in sum file frontmatter; enables change detection for incremental update decisions.

## Reproduction-Critical Constants

Full prompt template text: [templates.annex.sum](./prompts/templates.annex.sum)