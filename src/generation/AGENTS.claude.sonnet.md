<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/generation

The `src/generation` directory orchestrates two-phase LLM-driven documentation generation: Phase 1 (file analysis → `.sum` artifacts) and Phase 2 (directory synthesis → `AGENTS.md` artifacts), using dependency-ordered task planning, prompt construction with compression heuristics, and filesystem writers with content-hash change detection.

## Contents

- [`collector.ts`](./collector.ts): `collectAgentsDocs` and `collectAnnexFiles` recursively gather `AGENTS.md` and `.annex.sum` files under `projectRoot`, returning sorted `AgentsDocs` arrays of `{relativePath, content}` tuples. Skip patterns: `node_modules`, `.git`, `.agents-reverse-engineer`, `vendor`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`.
- [`complexity.ts`](./complexity.ts): `analyzeComplexity(files: string[], projectRoot: string): ComplexityMetrics` computes `fileCount`, `directoryDepth` (max depth via `path.relative` + `path.sep` split), and `directories` (unique dirs via `path.dirname` ancestry traversal).
- [`executor.ts`](./executor.ts): `buildExecutionPlan(plan: GenerationPlan, projectRoot: string, variant?: string): ExecutionPlan` constructs post-order execution plan with `ExecutionTask` objects (`id`, `type: 'file'|'directory'`, `path`, `systemPrompt`, `userPrompt`, `dependencies`, `outputPath`, `metadata`), sorting file tasks by directory depth descending, building `directoryFileMap` from `plan.allDiscoveredFiles`, filtering directory tasks via `plannedDirs` set to exclude skipped directories, assigning dependencies (file task IDs → directory task dependencies). `isDirectoryComplete` checks all files have `.sum` artifacts via `sumFileExists`, `getReadyDirectories` filters directories with complete file artifacts, `formatExecutionPlanAsMarkdown` renders `GENERATION-PLAN.md` with Phase 1/Phase 2 sections, skipped artifact lists.
- [`types.ts`](./types.ts): `SummaryMetadata` interface defines `purpose` (string), optional `criticalTodos` (string[]), optional `relatedFiles` (string[]) for file analysis metadata.

## Subdirectories

- [`prompts/`](./prompts/): Constructs system/user prompt pairs for file analysis (`.sum` generation) and directory synthesis (`AGENTS.md` generation) via `buildFilePrompt`/`buildDirectoryPrompt`, injecting compression rules when `compressionRatio < 0.5`, selecting update prompts when existing artifacts present, enforcing density/anchor term/path accuracy/behavioral contract rules.
- [`writers/`](./writers/): Serializes LLM analysis results via `writeSumFile` (YAML frontmatter with `generated_at`, `content_hash` SHA-256, `purpose`, `critical_todos`, `related_files` + markdown summary), `writeAgentsMd` (user-content preservation via `.local.md` renaming when `GENERATED_MARKER_PREFIX` absent), `writeAnnexFile` (verbatim source in triple-backticks), `writeClaudeMdPointer` (`CLAUDE.md` importing `@AGENTS.md`).

## Data Flow

**Phase 1 (File Analysis)**: `orchestration/pool.ts` receives file tasks from `buildExecutionPlan`, calls `prompts/builder.ts:buildFilePrompt(context)` with `PromptContext` containing `filePath`, `content`, optional `existingSum`, optional `compressionRatio`, receives `{system, user}` prompts, invokes `ai/service.ts`, passes response to `writers/sum.ts:writeSumFile`, writes `.sum` file with content-hash frontmatter.

**Phase 2 (Directory Synthesis)**: Phase 2 logic receives directory tasks, calls `prompts/builder.ts:buildDirectoryPrompt(dirPath, projectRoot, debug, knownDirs, projectStructure, existingAgentsMd, logger, variant)`, which performs parallel I/O (reads `.sum` files via `getSumPath`, child `AGENTS.md`, `AGENTS.local.md`, extracts import map via `imports/extractor.ts`, detects manifests, scans `.annex.sum`), returns `{system, user}` prompts, invokes `ai/service.ts`, passes response to `writers/agents-md.ts:writeAgentsMd`, writes `AGENTS.md` or `AGENTS.${variant}.md`, renames user-authored files to `.local.md`, prepends `@AGENTS.local.md` import.

**Task Dependencies**: File tasks have empty dependencies array. Directory tasks depend on all child file tasks via `dependencies: files.map(f => \`file:${f}\`)`, ensuring post-order execution (files analyzed before directory synthesis). `getReadyDirectories` filters directories where `isDirectoryComplete` returns `{complete: true, missing: []}`.

## Execution Planning

`buildExecutionPlan` converts `GenerationPlan` into dependency-ordered `ExecutionPlan`:

1. **File Task Creation**: Maps `plan.files` to `ExecutionTask` objects with `type: 'file'`, calls `prompts/builder.ts:buildFilePrompt` (deferred until Phase 1 execution), sets `outputPath` via `writers/sum.ts:getSumPath(absolutePath, variant)`, sets `dependencies: []`.
2. **Directory File Map Construction**: Builds `directoryFileMap` (Record<string, string[]>) from `plan.allDiscoveredFiles ?? plan.files`, groups files by `path.dirname`.
3. **Planned Directory Filtering**: Creates `plannedDirs` set from `plan.plannedDirectories ?? Object.keys(directoryFileMap)`, excludes directories with all skipped files.
4. **Directory Task Creation**: Iterates `plannedDirs`, creates `ExecutionTask` with `type: 'directory'`, calls `prompts/builder.ts:buildDirectoryPrompt` (deferred until Phase 2 execution), sets `outputPath` to `path.join(dirPath, variant ? \`AGENTS.${variant}.md\` : 'AGENTS.md')`, sets `dependencies: files.map(f => \`file:${f}\`)`.
5. **Depth Sorting**: Sorts file tasks by `depthB - depthA` (deepest first), directory tasks by `depthB - depthA` (deepest first), ensuring post-order traversal.

`formatExecutionPlanAsMarkdown` renders `GENERATION-PLAN.md` with ISO date header, summary stats (total/file/directory tasks, skipped counts), Phase 1 section (file tasks grouped by directory depth with `- [ ] \`path\`` checkboxes), Phase 2 section (directory tasks grouped by depth descending with `- [ ] \`dir/AGENTS.md\`` checkboxes), Skipped section listing existing artifacts.

## Prompt Construction

**File Analysis Prompts** (`prompts/builder.ts:buildFilePrompt`):
- Selects `FILE_UPDATE_SYSTEM_PROMPT` if `context.existingSum` exists, else `FILE_SYSTEM_PROMPT`
- Calculates `targetSize = sourceFileSize * compressionRatio`
- Injects ultra-compression rules when `compressionRatio < 0.5`: mandates telescopic sentences, abbreviations (fn→function, param→parameter, util→utility), example minimization
- Replaces `{{FILE_PATH}}`/`{{CONTENT}}` placeholders in `FILE_USER_PROMPT`
- Returns `{system, user}` pair

**Directory Synthesis Prompts** (`prompts/builder.ts:buildDirectoryPrompt`):
- Performs parallel I/O: reads all `.sum` files via `getSumPath(entryPath, variant)`, child `AGENTS.md`, `AGENTS.local.md`
- Calls `imports/extractor.ts:extractDirectoryImports` and `formatImportMap` from `../../imports/index.js`
- Detects 10 manifest filenames: `package.json`, `Cargo.toml`, `go.mod`, `pyproject.toml`, `pom.xml`, `build.gradle`, `Gemfile`, `composer.json`, `CMakeLists.txt`, `Makefile`
- Scans source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/` via glob
- Lists `.annex.sum` files
- Selects `DIRECTORY_UPDATE_SYSTEM_PROMPT` if `existingAgentsMd` provided, else `DIRECTORY_SYSTEM_PROMPT`
- Injects import map, project structure, detected manifests, `.annex.sum` list into user prompt
- Returns `{system, user}` pair

## File Relationships

`executor.ts` imports `GenerationPlan` from `../orchestration/orchestrator.js`, exports `ExecutionPlan` consumed by `orchestration/pool.ts` (Phase 1) and Phase 2 synthesis logic. `types.ts` exports `SummaryMetadata` consumed by `writers/sum.ts` for frontmatter schema. `collector.ts` exports `collectAgentsDocs`/`collectAnnexFiles` consumed by `specify/index.ts` for spec synthesis. `complexity.ts` exports `analyzeComplexity` consumed by `orchestration/orchestrator.ts` for complexity metrics. `prompts/builder.ts` imports `SummaryMetadata` from `./types.js`, exports `buildFilePrompt`/`buildDirectoryPrompt` consumed by `orchestration/pool.ts`. `writers/sum.ts` imports `SummaryMetadata` from `../types.js`, exports `writeSumFile`/`getSumPath`/`sumFileExists` consumed by `executor.ts` and `update/index.ts`.

## Behavioral Contracts

**Generation Marker**: `<!-- Generated by agents-reverse-engineer` (version-agnostic prefix) in `AGENTS.md`/`CLAUDE.md` files marks AI-generated content. `writers/agents-md.ts` and `writers/claude-md.ts` use `GENERATED_MARKER_PREFIX` for detection, write `GENERATED_MARKER = <!-- Generated by agents-reverse-engineer v${version} -->`.

**Directory Depth Calculation** (`executor.ts:getDirectoryDepth`): Returns `0` for root `"."`, else counts path separators via `dir.split(path.sep).length`.

**Post-Order Traversal**: File tasks sorted by `depthB - depthA` (deepest first), directory tasks sorted by `depthB - depthA` (deepest first). Directory task dependencies include all child file task IDs via `files.map(f => \`file:${f}\`)`.

**Content Hash Algorithm** (`writers/sum.ts`): SHA-256 hex digest of file content, stored in `content_hash` frontmatter field, used for incremental update change detection.

**User Content Preservation** (`writers/agents-md.ts`, `writers/claude-md.ts`): Detects non-generated files via `GENERATED_MARKER_PREFIX` absence, renames to `.local.md`, prepends `@{filename}.local.md` import before LLM content.

**Compression Threshold**: `compressionRatio < 0.5` triggers ultra-compression rules injection in `prompts/builder.ts:buildFilePrompt`.

**Annex File Format** (`writers/sum.ts:writeAnnexFile`):
```
<!-- Generated by agents-reverse-engineer v{version} -->

```{language}
{verbatim source content}
```
```

**YAML Frontmatter Format** (`writers/sum.ts:writeSumFile`):
```yaml
---
generated_at: {ISO8601}
content_hash: {SHA-256}
purpose: {string}
critical_todos: [item] | - item (inline ≤3 items <40 chars, else multiline)
related_files: [path] | - path
---
{markdown summary}
```

**Path Resolution** (`writers/sum.ts`):
- `.sum` file: `sourcePath + '.sum'` or `sourcePath + '.${variant}.sum'`
- Annex file: `dirname(sourcePath) / basename(sourcePath, extname) + '.annex.sum'` or `.annex.${variant}.sum`
- `AGENTS.md`: `path.join(dirPath, variant ? \`AGENTS.${variant}.md\` : 'AGENTS.md')`

**YAML Array Parsing Patterns** (`writers/sum.ts:parseYamlArray`):
- Inline: `/key:\s*\[([^\]]*)\]/` → split by `, `
- Multiline: `/key:\s*\n((?:\s+-\s+.+\n?)+)/m` → match lines via `/^\s+-\s+(.+)$/gm`

**Language Detection Map** (`prompts/builder.ts:detectLanguage`): `.ts`/`.tsx`→`'typescript'`, `.js`/`.jsx`→`'javascript'`, `.py`→`'python'`, `.rb`→`'ruby'`, `.go`→`'go'`, `.rs`→`'rust'`, `.java`→`'java'`, `.kt`→`'kotlin'`, `.swift`→`'swift'`, `.cs`→`'csharp'`, `.php`→`'php'`, `.vue`→`'vue'`, `.svelte`→`'svelte'`, `.json`→`'json'`, `.yaml`/`.yml`→`'yaml'`, `.md`→`'markdown'`, `.css`→`'css'`, `.scss`→`'scss'`, `.html`→`'html'`, default→`'text'`.

**Collector Skip Patterns** (`collector.ts:SKIP_DIRS`): `node_modules`, `.git`, `.agents-reverse-engineer`, `vendor`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`.

## Workflow & Conventions

**Phase 1 Execution**: `orchestration/pool.ts` receives file tasks from `buildExecutionPlan`, iterates concurrently (controlled by `config.ai.concurrency`), calls `prompts/builder.ts:buildFilePrompt`, invokes `ai/service.ts:generateAIResponse`, parses LLM output, calls `writers/sum.ts:writeSumFile`, logs progress to `.agents-reverse-engineer/progress.log`, updates telemetry via `ai/telemetry/run-log.ts`.

**Phase 2 Execution**: Phase 2 logic filters directories via `getReadyDirectories`, iterates depth-first (deepest first), calls `prompts/builder.ts:buildDirectoryPrompt`, invokes `ai/service.ts:generateAIResponse`, calls `writers/agents-md.ts:writeAgentsMd`, renames user-authored files to `.local.md`, prepends `@AGENTS.local.md` import.

**Incremental Updates**: `update/index.ts` invokes `change-detection/detector.ts` to compute git-based file changes, filters via content hash comparison against `.sum` frontmatter, identifies affected directories via `update/index.ts:getAffectedDirectories`, calls `buildExecutionPlan` with filtered file list, regenerates `.sum`/`AGENTS.md` for modified subtrees.

**Eval Mode**: When `variant` parameter provided (e.g., `'claude.sonnet'`), writes `.${variant}.sum` and `AGENTS.${variant}.md` files, `writeAgentsMdHub` creates hub `AGENTS.md` importing `@AGENTS.${activeVariant}.md`.

**Checkpoint Resumption**: `buildExecutionPlan` marks directories with existing `AGENTS.md` as skipped via `plan.skippedDirectories`, `formatExecutionPlanAsMarkdown` lists skipped artifacts in separate section, allows partial regeneration after interruption.