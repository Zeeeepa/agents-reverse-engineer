<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/generation

The `src/generation` directory orchestrates post-discovery documentation generation: builds dependency-ordered execution plans from discovery results, constructs LLM prompts with compression rules and cross-file context, manages `.sum` file serialization, writes variant-aware `AGENTS.md` overviews, and preserves user-authored documentation as `.local.md` files.

## Contents

- **[collector.ts](./collector.ts)**: `collectAgentsDocs(projectRoot)` recursively collects `AGENTS.md` files, `collectAnnexFiles(projectRoot)` collects `.annex.sum` files, returning `AgentsDocs` (array of `{relativePath, content}`). Skips `SKIP_DIRS` (`node_modules`, `.git`, `.agents-reverse-engineer`, `vendor`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`). Gracefully handles permission-denied via empty catch blocks.

- **[complexity.ts](./complexity.ts)**: `analyzeComplexity(files, projectRoot)` computes `ComplexityMetrics` (`fileCount`, `directoryDepth`, `files`, `directories`). `calculateDirectoryDepth` finds max nesting via `path.relative` split by `path.sep`. `extractDirectories` walks `path.dirname` upward until root (when `parent === dir`).

- **[executor.ts](./executor.ts)**: `buildExecutionPlan(plan, projectRoot, variant?)` constructs dependency graph with `ExecutionTask` nodes (`id`, `type`, `path`, `absolutePath`, `systemPrompt`, `userPrompt`, `dependencies`, `outputPath`, `metadata`). Builds `directoryFileMap`, creates file tasks (`"file:${path}"`), directory tasks (`"dir:${dir}"`) with child file IDs as dependencies, sorts by depth descending (post-order traversal). `getReadyDirectories(executionPlan, variant?)` returns directories where all child `.sum` files exist. `formatExecutionPlanAsMarkdown(plan)` generates `GENERATION-PLAN.md` with Summary (counts, skipped, post-order mode), Phase 1 (file analysis by directory), Phase 2 (AGENTS.md by depth), Skipped section. `isDirectoryComplete(dirPath, expectedFiles, projectRoot, variant?)` checks `.sum` existence via `sumFileExists`. Uses `plan.allDiscoveredFiles ?? plan.files` for complete prompt context.

- **[types.ts](./types.ts)**: `SummaryMetadata` interface with `purpose`, optional `criticalTodos`, `relatedFiles`.

## Subdirectories

- **[prompts/](./prompts/)**: Constructs system and user prompt pairs for LLM-based `.sum` file and `AGENTS.md` generation via `buildFilePrompt`, `buildDirectoryPrompt`. Injects compression rules when `context.compressionRatio < 0.5`, related files from `context.contextFiles`, import maps, existing summaries for incremental updates. Defines `FILE_SYSTEM_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT` templates with density rules (identifier-rich, filler-phrase-free), anchor term preservation, and behavioral contract preservation (verbatim regex/format strings/magic constants).

- **[writers/](./writers/)**: Serialization layer for `.sum` files with YAML frontmatter (`generated_at`, `content_hash`, `purpose`, `critical_todos`, `related_files`), variant-aware `AGENTS.md` overviews, and `CLAUDE.md` pointers. `writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`, `writeAnnexFile`, `getAnnexPath` handle `.sum`/`.annex.sum` files. `writeAgentsMd`, `writeAgentsMdHub`, `isGeneratedAgentsMd` manage directory overviews. `writeClaudeMdPointer` creates top-level pointer. Preserves user-authored files lacking `GENERATED_MARKER_PREFIX` as `.local.md`, injecting `@` references.

## Architecture

Execution pipeline: `buildExecutionPlan` reads `GenerationPlan` from `../orchestration/orchestrator.js`, constructs post-order task graph. `prompts/builder.ts` assembles LLM prompts, reading `.sum` files via `writers/sum.js`, import metadata via `../../imports/index.js`. `writers/` serializes LLM outputs to filesystem with SHA-256 change detection (`sum.ts`), variant routing (`agents-md.ts`), and user content preservation (`.local.md` mechanism). `collectAgentsDocs` and `collectAnnexFiles` support regeneration by scanning existing artifacts.

## Post-Order Traversal

`buildExecutionPlan` sorts tasks by directory depth descending (deepest first) to ensure child directories process before parents. `getDirectoryDepth(dir)` counts `path.sep` occurrences (root `"."` is depth 0). File tasks group by directory; directory tasks depend on child file task IDs. This ensures leaf `.sum` files exist before parent `AGENTS.md` generation reads them.

## Variant Support

`buildExecutionPlan`, `writeSumFile`, `writeAnnexFile`, `getSumPath`, `getAnnexPath`, `writeAgentsMd`, `isDirectoryComplete`, `getReadyDirectories` accept optional `variant: string`. When specified: `foo.ts` → `foo.ts.${variant}.sum`, `AGENTS.md` → `AGENTS.${variant}.md`. `writeAgentsMdHub(dirPath, activeVariant)` writes hub file referencing `@AGENTS.${variant}.md`.

## Behavioral Contracts

`SKIP_DIRS` excludes `node_modules`, `.git`, `.agents-reverse-engineer`, `vendor`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle` during recursive traversal.

`ExecutionTask` `id` format: `"file:${relativePath}"` for file tasks, `"dir:${relativePath}"` for directory tasks.

`GENERATED_MARKER_PREFIX = '<!-- Generated by agents-reverse-engineer'` (version-agnostic marker). Writers detect absence of marker to identify user-authored files for preservation.

SHA-256 `contentHash` in `.sum` frontmatter enables change detection. `getAnnexPath` strips source extension: `foo.ts` → `foo.annex.sum` or `foo.annex.${variant}.sum`.