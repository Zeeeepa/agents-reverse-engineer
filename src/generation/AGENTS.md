<!-- Generated by agents-reverse-engineer -->

# generation

Orchestrates the three-phase documentation generation pipeline: concurrent file-level `.sum` analysis, post-order directory-level `AGENTS.md` synthesis, and root `CLAUDE.md` aggregation. Builds dependency graphs enforcing bottom-up traversal, assesses codebase complexity for concurrency tuning, and manages prompt construction with import map extraction and user content preservation.

## Contents

### [orchestrator.ts](./orchestrator.ts)
Exports `GenerationOrchestrator` with `createPlan(discoveryResult)` workflow: `prepareFiles` reads file contents via `readFile`, `createFileTasks` invokes `buildFilePrompt` to embed source code in prompts, `createDirectoryTasks` groups files by `path.dirname` and defers prompt construction to runtime, `createPlan` calls `analyzeComplexity` and `buildProjectStructure`, emits trace events (`phase:start`, `plan:created`, `phase:end`), then zeroes `PreparedFile.content` to reclaim memory. Returns `GenerationPlan` with `PreparedFile[]`, `AnalysisTask[]`, `ComplexityMetrics`, and optional `projectStructure` string.

### [executor.ts](./executor.ts)
Exports `buildExecutionPlan(plan, projectRoot)` that constructs `ExecutionPlan` with dependency graph: file tasks have `id: "file:${filePath}"` and empty dependencies, directory tasks have `id: "dir:${dir}"` depending on child file task IDs, root tasks have `id: "root:CLAUDE.md"` depending on all directory task IDs. Sorts directory tasks via `getDirectoryDepth` for post-order traversal (deepest first). `isDirectoryComplete` checks if all expected `.sum` files exist via `sumFileExists`. `getReadyDirectories` filters directories where `isDirectoryComplete` returns true. `formatExecutionPlanAsMarkdown` serializes three-phase structure grouped by directory depth descending.

### [complexity.ts](./complexity.ts)
Exports `analyzeComplexity(files, projectRoot)` returning `ComplexityMetrics` with `fileCount`, `directoryDepth` (via `calculateDirectoryDepth` splitting `path.relative` on `path.sep`), `files` array, and `directories` Set. `extractDirectories` walks upward from each `path.dirname` until reaching root (detected when `parent === dir`), accumulating unique directory paths. Consumed by orchestration layer to determine concurrency parameters based on codebase size and nesting depth.

### [collector.ts](./collector.ts)
Exports `collectAgentsDocs(projectRoot)` that recursively walks directory tree via post-order depth-first traversal, reads all `AGENTS.md` files via `readFile`, skips `SKIP_DIRS` Set (node_modules/.git/.agents-reverse-engineer/vendor/dist/build/__pycache__/.next/venv/.venv/target/.cargo/.gradle), returns `AgentsDocs` (alias for `Array<{relativePath: string; content: string}>`) sorted alphabetically. Silently skips unreadable directories and files. Output consumed by root documentation builders and specification generators.

### [types.ts](./types.ts)
Exports `AnalysisResult` with `summary: string` and `metadata: SummaryMetadata` (populated by LLM subprocess). Exports `SummaryMetadata` with `purpose: string`, optional `criticalTodos?: string[]` (security/breaking issues only), and `relatedFiles?: string[]` (tightly coupled dependencies). Exports `SummaryOptions` with `targetLength: 'short' | 'standard' | 'detailed'` and `includeCodeSnippets: boolean`. Boundary type between AI analysis subprocess (populates fields) and generation orchestrator (consumes to build `.sum` files and `AGENTS.md`).

## Subdirectories

### [prompts/](./prompts/)
Constructs multi-stage AI prompts via `buildFilePrompt`, `buildDirectoryPrompt`, and `buildRootPrompt` that replace mustache-style placeholders (`{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`) in template constants with runtime context. Templates enforce density rules (every sentence references identifiers), path accuracy (use Import Map paths only), and consistency (no self-contradiction). `buildDirectoryPrompt` aggregates `.sum` files via `readSumFile`, extracts import maps via `extractDirectoryImports`, detects manifest files (package.json/Cargo.toml/go.mod), preserves `AGENTS.local.md`. `buildRootPrompt` calls `collectAgentsDocs` and parses package.json metadata.

### [writers/](./writers/)
Exports two-tier serializers: `writeSumFile` generates YAML-frontmatter `.sum` artifacts with `content_hash` (SHA-256), `purpose`, optional `critical_todos` and `related_files`. `readSumFile` parses frontmatter via regex and `parseYamlArray`, consumed by change detection. `writeAgentsMd` generates directory-level `AGENTS.md`, detects user-authored content lacking `GENERATED_MARKER`, renames to `AGENTS.local.md`, prepends above LLM sections. `sumFileExists` predicate used by `getReadyDirectories` and orphan cleanup.

## Three-Phase Execution Flow

**Phase 1 (Concurrent File Analysis)**: `runner.ts` pools execute file tasks from `ExecutionPlan.fileTasks`, calling `buildFilePrompt` to embed source code, invoking `AIService.analyzeFile`, writing `.sum` via `writeSumFile` with SHA-256 `contentHash`.

**Phase 2 (Post-Order Directory Aggregation)**: `runner.ts` iterates `ExecutionPlan.directoryTasks` sorted by `getDirectoryDepth` descending, calling `buildDirectoryPrompt` to aggregate child `.sum` files and subdirectory `AGENTS.md`, invoking `AIService.analyzeDirectory`, writing `AGENTS.md` via `writeAgentsMd` with user content merge.

**Phase 3 (Root Document Synthesis)**: `runner.ts` executes `ExecutionPlan.rootTasks`, calling `buildRootPrompt` to aggregate all `AGENTS.md` via `collectAgentsDocs`, generating root `CLAUDE.md`.

## Dependency Graph Strategy

`buildExecutionPlan` enforces dependencies: file tasks → directory tasks → root tasks. Post-order traversal via `getDirectoryDepth` sorting ensures child `.sum` files and child directory `AGENTS.md` exist before parent directory tasks execute. `isDirectoryComplete` predicate gates directory task execution until all child files have `.sum` artifacts.

## Memory Management

`GenerationOrchestrator.createPlan` embeds file content into file task prompts via `buildFilePrompt`, then zeroes `PreparedFile.content` via `(file as { content: string }).content = ''` to release memory before returning plan. Runner re-reads files from disk during execution as needed.

## Complexity-Driven Concurrency

`analyzeComplexity` computes `ComplexityMetrics` with `fileCount` (total sources), `directoryDepth` (max nesting), and `directories` Set (unique directory count). Orchestration layer consumes metrics to tune pool concurrency (default 2, configurable via `config.concurrency`) and progress reporting granularity based on codebase size.

## Trace Event Integration

`GenerationOrchestrator.createPlan` emits trace events via `ITraceWriter`: `phase:start` (phase: 'plan-creation', taskCount, concurrency: 1), `plan:created` (planType: 'generate', fileCount, taskCount + 1 for root), `phase:end` (phase: 'plan-creation', durationMs via `process.hrtime.bigint()`, tasksCompleted: 1, tasksFailed: 0). Consumed by `src/orchestration/trace.ts` for NDJSON trace output.

## Import Map Extraction

`buildDirectoryPrompt` filters source files by `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/` regex, passes to `extractDirectoryImports` from `src/imports/index.ts`, formats via `formatImportMap` to generate "Import Map (verified — use these exact paths)" section. Enforces path accuracy: AI must use only documented module specifiers.

## User Content Preservation

`writeAgentsMd` implements rename-and-prepend: user-authored `AGENTS.md` → `AGENTS.local.md` on first run, prepended above LLM-generated sections. `isGeneratedAgentsMd` checks for `GENERATED_MARKER` (`<!-- Generated by agents-reverse-engineer -->`). Subsequent runs preserve `AGENTS.local.md`, enabling persistent user annotations without clobbering manual edits.

## Manifest Detection

`buildDirectoryPrompt` detects manifest files (package.json/Cargo.toml/go.mod/pyproject.toml/pom.xml/build.gradle/Gemfile/composer.json/CMakeLists.txt/Makefile), embeds in "Package Manifest" section for stack awareness. Consumed by AI to recognize package roots and adjust section selection (e.g., include "Stack" section for package directories).