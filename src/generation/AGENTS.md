<!-- Generated by agents-reverse-engineer v0.8.4 -->

# src/generation

Orchestrates two-phase documentation pipeline: phase-1 file analysis (source → `.sum` via `buildFilePrompt()` with import maps, compression directives, existing summary preservation) and phase-2 directory aggregation (parallel `.sum` reads → `AGENTS.md` via `buildDirectoryPrompt()` with post-order dependency graph).

## Contents

**[collector.ts](./collector.ts)** — `collectAgentsDocs()` recursively walks project tree, collects all `AGENTS.md` files via `readdir()` + recursive traversal, skips `SKIP_DIRS` (`node_modules`, `.git`, `dist`, `build`, etc.), returns `AgentsDocs` array (`{relativePath, content}`) sorted by `localeCompare()`. `collectAnnexFiles()` identical logic for `.annex.sum` collection. Consumed by `src/specify/prompts.ts` (specification aggregation) and `src/rebuild/spec-reader.ts` (annex constant injection).

**[complexity.ts](./complexity.ts)** — `analyzeComplexity()` computes `ComplexityMetrics` (`fileCount`, `directoryDepth`, `files[]`, `directories Set`) via `calculateDirectoryDepth()` (max depth via `path.relative()` + `split(path.sep).length - 1`) and `extractDirectories()` (parent traversal via `path.dirname()` until root).

**[executor.ts](./executor.ts)** — `buildExecutionPlan()` transforms `GenerationPlan` → `ExecutionPlan` with post-order dependency graph: creates `fileTasks` (`id: "file:${path}"`, `outputPath: "${absolutePath}.sum"`), sorts directories by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending), creates `directoryTasks` (`id: "dir:${path}"`, `dependencies: fileTaskIds`, `outputPath: "${dirAbsPath}/AGENTS.md"`, `metadata.depth`). `formatExecutionPlanAsMarkdown()` generates `GENERATION-PLAN.md` with ISO date, Summary counts, Phase 1 checkboxes grouped by depth, Phase 2 checkboxes sorted deepest-first. `isDirectoryComplete()` validates all child `.sum` files exist via `sumFileExists()`, `getReadyDirectories()` filters `directoryFileMap` to complete directories.

**[types.ts](./types.ts)** — `AnalysisResult` (`summary: string`, `metadata: SummaryMetadata`), `SummaryMetadata` (`purpose`, optional `criticalTodos`/`relatedFiles`), `SummaryOptions` (`targetLength`, `includeCodeSnippets`).

## Subdirectories

**[prompts/](./prompts/)** — Assembles LLM prompts for two-phase documentation generation: phase-1 file analysis via `buildFilePrompt()` (injects source code, import maps, compression directives, existing summaries) and phase-2 directory aggregation via `buildDirectoryPrompt()` (parallel `.sum` reads, child `AGENTS.md` ingestion, manifest detection). Enforces density mandates, behavioral contract extraction, path accuracy, and incremental update preservation via five template constants (`FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`).

**[writers/](./writers/)** — Serialization layer: `writeSumFile()` formats YAML frontmatter (`generated_at`, `content_hash`, `purpose`) + markdown body, `readSumFile()` parses via `/^---\n([\s\S]*?)\n---\n/` regex. `writeAgentsMd()` preserves user content via rename → `AGENTS.local.md` + `@AGENTS.local.md` import when `GENERATED_MARKER` missing. `writeClaudeMdPointer()` generates root `CLAUDE.md` with `@AGENTS.md` import. `writeAnnexFile()` wraps full source in `.annex.sum` fenced blocks.

## Architecture

### Two-Phase Execution Flow

`buildExecutionPlan()` constructs `ExecutionPlan.fileTasks` with empty `dependencies[]`, enabling full parallelization during phase-1. `directoryTasks` populated with `dependencies: files.map(f => "file:${f}")`, enforcing post-order constraint: child `.sum` files must exist before parent `AGENTS.md` generation. `formatExecutionPlanAsMarkdown()` preserves depth grouping via `dirsByDepth` dictionary with `depths.sort((a, b) => b - a)` output, matching depth-descending sort in task execution order.

### Prompt Context Assembly

`prompts/builder.ts` `buildFilePrompt()` selects `FILE_SYSTEM_PROMPT` vs `FILE_UPDATE_SYSTEM_PROMPT` based on `context.existingSum` presence. Replaces `{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}` placeholders, appends `## Related Files` via `context.contextFiles.map()`, injects compression directives before `DENSITY RULES (MANDATORY):` when `compressionRatio < 0.5`: `TARGET LENGTH: ~${targetSize} chars (${compressionPercentage}% compression), MAX: ${maxSize}`, `ULTRA-COMPRESSION TECHNIQUES: telegraphic style, no examples, one sentence per export`.

`buildDirectoryPrompt()` assembles sections: `['Generate AGENTS.md for directory: "${relativePath}" (${dirName})', '## File Summaries (${count} files)', ...summaries, '## Import Map (verified)', importMapText, '## Project Directory Structure', projectStructure, '## Subdirectories', ...subdirSections, '## Directory Hints', manifestHint, localSection, annexSection, '## Existing AGENTS.md', existingAgentsMd]`. Reads `.sum` frontmatter via parallel `Promise.all(fileEntries.map(entry => readSumFile(getSumPath(entry))))`, formats as `### ${entry.name}\n**Purpose:** ${sumContent.metadata.purpose}\n\n${sumContent.summary}`. Reads child `AGENTS.md` via parallel `readFile()`, detects manifests via `manifestNames = ['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']`. Lists `.annex.sum` files via `entries.filter(e => e.isFile() && e.name.endsWith('.annex.sum'))`. Filters `readdir()` results: `fileEntries = entries.filter(e => e.isFile() && !e.name.endsWith('.sum') && !e.name.startsWith('.'))`, `dirEntries = entries.filter(e => e.isDirectory() && (!knownDirs || knownDirs.has(relativeDir)))`. Extracts user-authored `AGENTS.local.md` or `AGENTS.md` lacking `GENERATED_MARKER_PREFIX`. Calls `extractDirectoryImports(dirPath, fileEntries.map(e => e.name))` for source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, formats via `formatImportMap()`. Returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` provided, else `DIRECTORY_SYSTEM_PROMPT`.

### User Content Preservation

`writers/agents-md.ts` `writeAgentsMd()` checks `isGeneratedAgentsMd(path)` via `content.includes(GENERATED_MARKER)`. When marker absent, calls `rename(path, agentsLocalPath)` → `AGENTS.local.md`, prepends `@AGENTS.local.md\n\n` before LLM content. `writers/claude-md.ts` `writeClaudeMdPointer()` identical logic for root `CLAUDE.md` → `CLAUDE.local.md`, deterministic template: `${GENERATED_MARKER}\n\n${localImport}@AGENTS.md\n`.

## Behavioral Contracts

### Post-Order Sort
```javascript
getDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth
// getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length
```

### Task ID Conventions
```javascript
// File tasks: "file:${relativePath}"
// Directory tasks: "dir:${relativePath}"
// Dependencies: files.map(f => `file:${f}`)
```

### Compression Calculation
```javascript
// When compressionRatio < 0.5 && sourceFileSize > 0
targetSize = Math.round(sourceFileSize * compressionRatio)
maxSize = Math.round(targetSize * 1.2)
compressionPercentage = Math.round(compressionRatio * 100)
```

### Language Detection
```typescript
langMap = {
  '.ts': 'typescript', '.tsx': 'tsx', '.js': 'javascript', '.jsx': 'jsx',
  '.py': 'python', '.rb': 'ruby', '.go': 'go', '.rs': 'rust',
  '.java': 'java', '.kt': 'kotlin', '.swift': 'swift', '.cs': 'csharp',
  '.php': 'php', '.vue': 'vue', '.svelte': 'svelte',
  '.json': 'json', '.yaml': 'yaml', '.yml': 'yaml', '.md': 'markdown',
  '.css': 'css', '.scss': 'scss', '.html': 'html'
}
// detectLanguage(filePath) => langMap[extname(filePath)] ?? 'text'
```

### Manifest Detection
```javascript
manifestNames = [
  'package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml',
  'pom.xml', 'build.gradle', 'Gemfile', 'composer.json',
  'CMakeLists.txt', 'Makefile'
]
```

### Template Placeholder Replacement
```javascript
FILE_USER_PROMPT
  .replace(/\{\{FILE_PATH\}\}/g, context.filePath)
  .replace(/\{\{CONTENT\}\}/g, context.content)
  .replace(/\{\{LANG\}\}/g, detectLanguage(context.filePath))
```

### Directory Context Filtering
```javascript
fileEntries = entries.filter(e => 
  e.isFile() && !e.name.endsWith('.sum') && !e.name.startsWith('.')
)
dirEntries = entries.filter(e => 
  e.isDirectory() && (!knownDirs || knownDirs.has(relativeDir))
)
```

### Summary Guidelines
```typescript
SUMMARY_GUIDELINES = {
  targetLength: { min: 300, max: 500 },
  include: [
    'Behavioral contracts: verbatim regex patterns, format strings, magic constants',
    'Annex references: list each constant name with one-line description'
  ],
  exclude: []
}
```

### YAML Array Serialization
```javascript
// Inline: items.length <= 3 && items.every(x => x.length < 40)
formatYamlArray(items) => `[${items.join(', ')}]`
// Multi-line: otherwise
formatYamlArray(items) => items.map(x => `- ${x}`).join('\n')
```

### Generated File Marker
```javascript
GENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'
// Absence triggers rename → .local.md + @import injection
```

## Annex References

- [prompts/builder.annex.sum](./prompts/builder.annex.sum) — Implementation details of `buildFilePrompt()` and `buildDirectoryPrompt()` prompt assembly logic
- [prompts/templates.annex.sum](./prompts/templates.annex.sum) — Full text of `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT` constants
- [prompts/types.annex.sum](./prompts/types.annex.sum) — Complete `PromptContext` interface definition and `SUMMARY_GUIDELINES` object structure