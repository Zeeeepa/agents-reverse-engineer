<!-- Generated by agents-reverse-engineer -->

# src/generation

Orchestrates ARE's three-phase documentation generation pipeline: file analysis (concurrent `.sum` generation), directory synthesis (post-order `AGENTS.md` assembly), and root document creation (`CLAUDE.md` pointer files). Coordinates task planning, execution ordering, AI prompt construction, and output writing across the entire project tree.

## Contents

**[orchestrator.ts](./orchestrator.ts)** — `GenerationOrchestrator` class coordinates workflow via `createPlan()`: invokes `prepareFiles()` to read file contents with `readFile()`, calls `analyzeComplexity()` from `complexity.ts` for structural metrics, builds `AnalysisTask[]` arrays via `createFileTasks()` and `createDirectoryTasks()`, emits `phase:start`/`plan:created`/`phase:end` trace events with task counts and duration, clears `PreparedFile.content` fields after embedding into task prompts to free memory. Returns `GenerationPlan` with `files`, `tasks`, `complexity`, and optional `projectStructure` (compact directory tree for AI context).

**[executor.ts](./executor.ts)** — `buildExecutionPlan()` transforms `GenerationPlan` into `ExecutionPlan` by assigning task IDs (`file:${path}` or `dir:${path}`), sorting `fileTasks` and `directoryTasks` by `getDirectoryDepth()` descending for post-order traversal, setting `dependencies` arrays on directory tasks (child file IDs), and populating `directoryFileMap` via `path.dirname()` grouping. `getReadyDirectories()` checks `.sum` file existence via `sumFileExists()` from `writers/sum.js` to identify directories ready for AGENTS.md generation. `formatExecutionPlanAsMarkdown()` generates GENERATION-PLAN.md with checkbox lists grouped by directory and depth.

**[complexity.ts](./complexity.ts)** — `analyzeComplexity()` computes `ComplexityMetrics` from file path list: `fileCount` via `length`, `directoryDepth` via `calculateDirectoryDepth()` (splits by `path.sep`, subtracts filename, returns max), `directories` via `extractDirectories()` (walks ancestors with `path.dirname()` until root sentinel), and `files` passthrough. Metrics inform concurrency decisions in orchestrator and provide directory inventory for AGENTS.md phase.

**[collector.ts](./collector.ts)** — `collectAgentsDocs()` and `collectAnnexFiles()` recursively walk project tree via `readdir()` and `stat()`, skipping `SKIP_DIRS` set (`['node_modules', '.git', 'dist', 'build', 'vendor', '__pycache__', '.next', 'venv', 'target']`), reading matching files (`AGENTS.md` exact or `.annex.sum` suffix) via `readFile('utf-8')`, returning `AgentsDocs` arrays sorted by `relativePath.localeCompare()`. Silently ignores permission errors with empty `catch` blocks.

**[types.ts](./types.ts)** — `AnalysisResult` interface specifies LLM response shape with `summary: string` and `metadata: SummaryMetadata` fields. `SummaryMetadata` defines frontmatter structure: `purpose` (required), optional `criticalTodos` (security/breaking only), optional `relatedFiles` (tight coupling). `SummaryOptions` configures generation with `targetLength: 'short' | 'standard' | 'detailed'` and `includeCodeSnippets: boolean` flags.

## Subdirectories

**[prompts/](./prompts/)** — Constructs AI prompts via `buildFilePrompt()` and `buildDirectoryPrompt()` by replacing `{{PLACEHOLDER}}` tokens in template strings from `templates.ts`. Injects import maps via `extractDirectoryImports()`, existing summaries via `readSumFile()`, package manifests (detects `package.json`, `Cargo.toml`, etc. with exact filename matches), and switches to incremental update templates when `existingSum` or `existingAgentsMd` present. Templates enforce density rules, forbidden filler phrases, and behavioral contract preservation.

**[writers/](./writers/)** — Implements three-tier output system: `writeSumFile()` for `.sum` files with YAML frontmatter (`generated_at`, `content_hash`, `purpose`), `writeAgentsMd()` for directory AGENTS.md with `GENERATED_MARKER` prefix and user content preservation via `.local.md` rename, `writeClaudeMdPointer()` for root CLAUDE.md with `@AGENTS.md` import chain. `writeAnnexFile()` creates `.annex.sum` sidecars for reproduction-critical constants exceeding word limits.

## Architecture

**Three-phase pipeline:**
1. File analysis phase (`fileTasks`) — parallel workers process source files via AI service, generate `.sum` files via `writeSumFile()`, tasks independent (no dependencies array)
2. Directory synthesis phase (`directoryTasks`) — post-order traversal processes directories after children, reads child `.sum` files via `readSumFile()`, generates AGENTS.md via `writeAgentsMd()`, dependencies array contains child file task IDs
3. Root assembly phase — sequential execution writes CLAUDE.md via `writeClaudeMdPointer()`, imports AGENTS.md tree, preserves user content

**Dependency ordering:** `ExecutionPlan.tasks` array preserves execution sequence by sorting file tasks by depth descending (deepest files first), directory tasks by depth descending (deepest directories first), guaranteeing child completion before parent processing. `ExecutionTask.dependencies` arrays encode child-parent relationships checked by `src/orchestration/runner.ts` before task execution.

## Data Flow

`src/cli/generate.ts` → `GenerationOrchestrator.createPlan()` → `buildExecutionPlan()` → `src/orchestration/runner.ts` → AI service → writer functions → filesystem. `DiscoveryResult` from `src/discovery/run.ts` provides file inventory, `Config` from `src/config/loader.ts` controls concurrency and AI backend, `ITraceWriter` from `src/orchestration/trace.ts` logs pipeline events.

## Behavioral Contracts

**Task ID format:** `file:${relativePath}` for file analysis tasks, `dir:${relativePath}` for directory synthesis tasks — exact string format required by runner's task lookup logic.

**Root depth sentinel:** `getDirectoryDepth('.')` returns `0`, loop terminates when `path.dirname(dir) === dir` (root).

**Skip directory set:** `['node_modules', '.git', '.agents-reverse-engineer', 'vendor', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target', '.cargo', '.gradle']` — exact matches checked via `Set.has()`.

**Output path conventions:** `.sum` files via `${absolutePath}.sum`, AGENTS.md via `path.join(absolutePath, 'AGENTS.md')`, CLAUDE.md at `path.join(projectRoot, 'CLAUDE.md')`.

**Trace event phases:** `'plan-creation'` for orchestrator, `'file-analysis'` and `'directory-synthesis'` for runner phases.

## File Relationships

`orchestrator.ts` imports `buildFilePrompt` from `prompts/index.js` for task creation, `analyzeComplexity` from `complexity.ts` for metrics, `ITraceWriter` from `../orchestration/trace.js` for telemetry. `executor.ts` imports `sumFileExists` from `writers/sum.js` for dependency checking, `GenerationPlan` from `orchestrator.ts` as input. `collector.ts` standalone traversal logic consumed by `src/specify/index.ts` for specification generation. `types.ts` provides `AnalysisResult` interface matching AI response shape in `src/ai/service.ts`, `SummaryOptions` passed from CLI commands.