<!-- Generated by agents-reverse-engineer -->

# src/generation

**Orchestrates the three-phase documentation pipeline: concurrent file analysis generating `.sum` summaries, post-order directory aggregation building `AGENTS.md` from child summaries, and sequential root document synthesis producing platform-specific integration files (`CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`).**

## Contents

### Pipeline Orchestration

**[orchestrator.ts](./orchestrator.ts)** — `GenerationOrchestrator` class with `createPlan()` method coordinates planning workflow: calls `prepareFiles()` to load source file contents via `readFile()`, invokes `analyzeComplexity()` for directory depth calculation, executes `buildProjectStructure()` to generate compact tree listing, constructs file tasks via `createFileTasks()` calling `buildFilePrompt()` with embedded content, constructs directory tasks via `createDirectoryTasks()` grouping by `path.dirname()` with deferred prompt construction, emits `phase:start`/`plan:created`/`phase:end` trace events, zeroes `PreparedFile.content` fields post-prompt-construction for memory optimization (content re-read during execution).

**[executor.ts](./executor.ts)** — `buildExecutionPlan()` transforms `GenerationPlan` into dependency-graphed `ExecutionPlan`: creates file tasks with `id: "file:${path}"` and empty `dependencies[]` for concurrent Phase 1 execution, sorts `fileTasks` by directory depth descending via `getDirectoryDepth()`, builds directory tasks with `id: "dir:${path}"` depending on child file task IDs, sorts `directoryTasks` by depth descending for post-order traversal (deepest first), creates root tasks with `id: "root:CLAUDE.md"` depending on all directory task IDs. `isDirectoryComplete()` verifies all expected files have `.sum` files via `sumFileExists()`, `getReadyDirectories()` filters directories passing completion check, `formatExecutionPlanAsMarkdown()` generates `GENERATION-PLAN.md` with checkbox lists grouped by depth.

**[collector.ts](./collector.ts)** — `collectAgentsDocs()` recursively walks directory tree via nested `walk()` function with `readdir({withFileTypes: true})` for `Dirent` metadata, skips 13 vendor/build directories via `SKIP_DIRS` set (node_modules, .git, dist, vendor, etc.), pushes `AGENTS.md` file content to results array when encountered, returns `AgentsDocs` type (`Array<{relativePath: string, content: string}>`) sorted alphabetically via `localeCompare()`, gracefully handles filesystem errors via empty catch blocks.

### Complexity Analysis

**[complexity.ts](./complexity.ts)** — `analyzeComplexity()` computes `ComplexityMetrics` by calling `calculateDirectoryDepth()` for maximum nesting level via `path.relative().split(path.sep).length - 1` (excludes file basename) and `extractDirectories()` for unique directory set via `path.dirname()` parent walking with dual termination conditions (`dir === '.'` or `parent === dir`), returns `{fileCount, directoryDepth, files, directories}` consumed by executor for ETA calculation and post-order sorting.

### Type Definitions

**[types.ts](./types.ts)** — `AnalysisResult` interface with `summary: string` and `metadata: SummaryMetadata` fields represents Phase 1 file analysis output populated by `AIService.call()` subprocesses; `SummaryMetadata` interface contains `purpose: string`, optional `criticalTodos?: string[]` (security/breaking issues only), optional `relatedFiles?: string[]` (tightly coupled siblings); `SummaryOptions` interface with `targetLength: 'short' | 'standard' | 'detailed'` and `includeCodeSnippets: boolean` controls summary generation format.

### Re-exports

**[index.ts](./index.ts)** — Barrel file exporting `GenerationOrchestrator`, `createOrchestrator`, `GenerationPlan`, `AnalysisTask`, `PreparedFile` from `orchestrator.ts`; `buildExecutionPlan`, `ExecutionPlan`, `ExecutionTask`, `isDirectoryComplete`, `getReadyDirectories` from `executor.ts`; `collectAgentsDocs`, `AgentsDocs` from `collector.ts`; `analyzeComplexity`, `ComplexityMetrics` from `complexity.ts`; `AnalysisResult`, `SummaryMetadata`, `SummaryOptions` from `types.ts`.

## Subdirectories

**[prompts/](./prompts/)** — Constructs AI prompts via `buildFilePrompt()` with `{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}` template substitution and `detectLanguage()` for 26 file extensions, `buildDirectoryPrompt()` aggregating child `.sum` files via `readSumFile()` + `extractDirectoryImports()` with manifest detection (9 types: package.json/Cargo.toml/go.mod/etc.) and user content preservation from `AGENTS.local.md`, `buildRootPrompt()` calling `collectAgentsDocs()` for AGENTS.md corpus synthesis. Enforces density rules (identifier-rich sentences), anchor term preservation (exact symbol names), path accuracy (Import Map constraint), synthesis-only constraints (anti-hallucination).

**[writers/](./writers/)** — `writeSumFile()` generates `.sum` files with YAML frontmatter (`generated_at`, `content_hash`, `purpose`, optional arrays), `readSumFile()` parses via regex `/^---\n([\s\S]*?)\n---\n/` with `parseYamlArray()` supporting inline `[a,b,c]` and multi-line `- item` formats, `getSumPath()` appends `.sum` suffix, `sumFileExists()` checks existence. `writeAgentsMd()` implements three-step user content preservation: detects files missing `GENERATED_MARKER` and renames to `AGENTS.local.md`, reads existing `AGENTS.local.md`, prepends above LLM-generated content.

## Three-Phase Execution Flow

**Phase 1 (Concurrent File Analysis):**
1. `GenerationOrchestrator.createPlan()` calls `prepareFiles()` loading file contents
2. `createFileTasks()` embeds content into file analysis prompts via `buildFilePrompt()`
3. `orchestrator.ts` zeroes `PreparedFile.content` fields post-prompt-construction
4. `executor.ts` creates file tasks with empty `dependencies[]` arrays
5. `src/orchestration/runner.ts` executes via iterator-based worker pool (shared task iterator, N workers)
6. Each worker spawns AI CLI subprocess via `AIService.call()` → `runSubprocess()` → `execFile()`
7. Successful analysis writes `.sum` file via `writeSumFile()` with SHA-256 content hash

**Phase 2 (Post-Order Directory Aggregation):**
1. `executor.ts` sorts directories by depth descending via `getDirectoryDepth()`
2. `isDirectoryComplete()` verifies all child `.sum` files exist via `sumFileExists()`
3. `buildDirectoryPrompt()` aggregates child summaries via `readSumFile(getSumPath())`
4. Embeds `extractDirectoryImports()` + `formatImportMap()` for verified import paths
5. Detects 9 manifest types to identify package roots
6. Preserves user content from `AGENTS.local.md` or non-generated `AGENTS.md`
7. `writeAgentsMd()` writes with `GENERATED_MARKER` comment, renames existing user files

**Phase 3 (Sequential Root Synthesis):**
1. `buildRootPrompt()` calls `collectAgentsDocs()` for recursive AGENTS.md traversal
2. Skips 13 vendor/build directories via `SKIP_DIRS` set
3. Parses root `package.json` for project metadata
4. Enforces synthesis-only constraints: no invented features/patterns
5. Generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` sequentially (concurrency=1)

## Dependency Graph Construction

File tasks have empty `dependencies: []` enabling parallel execution. Directory tasks depend on child file task IDs via `files.map(f => 'file:${f}')` ensuring all `.sum` files complete before AGENTS.md generation. Root tasks depend on all directory task IDs via `allDirTaskIds = Object.keys(directoryFileMap).map(d => 'dir:${d}')` ensuring entire directory tree completes before CLAUDE.md synthesis.

## Memory Management

`GenerationOrchestrator.createPlan()` zeroes `PreparedFile.content` fields after embedding into file analysis prompts. Comment indicates runner re-reads files from disk during execution, eliminating need to hold content in memory during pool execution phase. Prevents memory exhaustion analyzing large codebases with high concurrency.

## Trace Events

`GenerationOrchestrator` emits `phase:start` with `{type: 'phase:start', phase: 'plan-creation', taskCount, concurrency: 1}` before planning, `plan:created` with `{type: 'plan:created', planType: 'generate', fileCount, taskCount}` after task array construction, `phase:end` with `{type: 'phase:end', phase: 'plan-creation', durationMs, tasksCompleted: 1, tasksFailed: 0}` after completion. All emissions conditional on `this.tracer` being defined.

## Integration Points

Consumed by `src/orchestration/runner.ts` for three-phase pipeline execution via `executePhase()`. Calls `src/generation/prompts/builder.ts` for prompt construction with import maps. Uses `src/generation/writers/sum.ts` for `.sum` file I/O and `src/generation/writers/agents-md.ts` for directory-level documentation. Imports `src/discovery/types.ts` for `DiscoveryResult` input schema. References `src/change-detection/detector.ts` for SHA-256 content hashing stored in frontmatter.