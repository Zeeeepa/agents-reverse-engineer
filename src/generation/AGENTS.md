<!-- Generated by agents-reverse-engineer -->

# src/generation

File and directory documentation assembly layer: `collector.ts` recursively gathers `AGENTS.md`/`.annex.sum` artifacts, `complexity.ts` computes `ComplexityMetrics` (fileCount, directoryDepth), `executor.ts` transforms `GenerationPlan` into post-order `ExecutionPlan` with dependency graph (`file:${path}` → `dir:${path}` task IDs), `types.ts` defines `AnalysisResult`/`SummaryMetadata`/`SummaryOptions` contracts, `prompts/` constructs phase-1/phase-2 LLM prompts with adaptive compression directives, `writers/` serializes `.sum` YAML frontmatter, `AGENTS.md` hierarchies, and root `CLAUDE.md` pointers.

## Contents

**[collector.ts](./collector.ts)** — Exports `collectAgentsDocs()` and `collectAnnexFiles()` recursively walking project tree (skipping `SKIP_DIRS` = `node_modules`, `.git`, `.agents-reverse-engineer`, `vendor`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`), returning sorted `Array<{relativePath, content}>` via `relativePath.localeCompare()`. Gracefully handles unreadable directories via try-catch. Consumed by `src/specify/prompts.ts` for specification aggregation and `src/rebuild/spec-reader.ts` for annex constant extraction.

**[complexity.ts](./complexity.ts)** — Exports `analyzeComplexity(files: string[], projectRoot: string): ComplexityMetrics` aggregating `fileCount`, `directoryDepth` via `calculateDirectoryDepth()` (`Math.max(...files.map(f => path.relative().split(path.sep).length - 1))`), `files: string[]`, `directories: Set<string>` via `extractDirectories()` (parent traversal via `path.dirname()` until root).

**[executor.ts](./executor.ts)** — Exports `buildExecutionPlan()` transforming `GenerationPlan` into dependency graph: creates `fileTasks` (`id: "file:${path}"`, `outputPath: "${abs}.sum"`, empty dependencies), creates `directoryTasks` (`id: "dir:${path}"`, `outputPath: "${abs}/AGENTS.md"`, dependencies via `files.map(f => \`file:${f}\`)`), sorts both by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending), returns `ExecutionPlan` with `tasks: [...fileTasks, ...directoryTasks]`, `directoryFileMap: Record<string, string[]>`. Exports `isDirectoryComplete()` checking `sumFileExists()` for all expected files, `getReadyDirectories()` filtering via completion check, `formatExecutionPlanAsMarkdown()` rendering GENERATION-PLAN.md with depth-grouped checkboxes (Phase 1: `- [ ] \`${file}\``, Phase 2: `- [ ] \`${dir}/AGENTS.md\``).

**[types.ts](./types.ts)** — Exports `AnalysisResult` (`summary: string`, `metadata: SummaryMetadata`), `SummaryMetadata` (`purpose: string`, optional `criticalTodos: string[]`, `relatedFiles: string[]`), `SummaryOptions` (`targetLength: {min, max}`, `includeCodeSnippets: boolean`).

## Subdirectories

**[prompts/](./prompts/)** — Prompt construction subsystem: `builder.ts` exports `buildFilePrompt()` (selects `FILE_SYSTEM_PROMPT`/`FILE_UPDATE_SYSTEM_PROMPT`, replaces `{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}`/`{{PROJECT_PLAN_SECTION}}`, injects compression directives when `compressionRatio < 0.5`, appends related files via `context.contextFiles`) and `buildDirectoryPrompt()` (parallel reads child `.sum` via `readSumFile()`, extracts imports via `extractDirectoryImports()`, detects manifests, returns `DIRECTORY_SYSTEM_PROMPT`/`DIRECTORY_UPDATE_SYSTEM_PROMPT`). `templates.ts` defines five prompt constants enforcing density rules (no filler phrases), anchor term preservation (exact casing), behavioral contract extraction (regex verbatim), path accuracy (Import Map only), incremental update preservation (verbatim unchanged sections). `types.ts` exports `PromptContext`, `SUMMARY_GUIDELINES` (`targetLength: {min: 300, max: 500}`).

**[writers/](./writers/)** — Serialization layer: `sum.ts` exports `writeSumFile()` (YAML frontmatter via `formatSumFile()` with adaptive array formatting: inline `[a, b]` if ≤3 items <40 chars, else multi-line), `readSumFile()` (regex parsing via `/^---\n([\s\S]*?)\n---\n/` + dual-array-regex), `writeAnnexFile()` (fenced code block wrapper), `getSumPath()`, `sumFileExists()`. `agents-md.ts` exports `writeAgentsMd()` (four-step: detect `GENERATED_MARKER` → rename to AGENTS.local.md → strip marker → inject `@AGENTS.local.md`), `isGeneratedAgentsMd()`. `claude-md.ts` exports `writeClaudeMdPointer()` (deterministic `@AGENTS.md` import, renames unmarked → CLAUDE.local.md, prepends `@CLAUDE.local.md`). `index.ts` re-exports public API.

## Architecture

### Post-Order Dependency Graph

`buildExecutionPlan()` sorts tasks by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending) to ensure child directories complete before parents, enabling bottom-up `AGENTS.md` aggregation. `fileTasks` sorted first by directory depth, `directoryTasks` sorted identically via pre-sorted `sortedDirs` array. `formatExecutionPlanAsMarkdown()` preserves depth grouping via `dirsByDepth` dictionary with `depths.sort((a, b) => b - a)` output.

### Two-Phase Prompt Strategy

**Phase 1 (File Analysis)**: `buildFilePrompt()` selects `FILE_SYSTEM_PROMPT` (new) vs `FILE_UPDATE_SYSTEM_PROMPT` (incremental), replaces `{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}`/`{{PROJECT_PLAN_SECTION}}` in `FILE_USER_PROMPT`, appends `## Related Files` section via `context.contextFiles.map(f => \`### ${f.path}\n\`\`\`${detectLanguage(f.path)}\n${f.content}\n\`\`\`\`)`. When `compressionRatio < 0.5 && sourceFileSize > 0`, injects `TARGET LENGTH (MANDATORY)` block before `DENSITY RULES` marker with `targetSize = Math.round(sourceFileSize * ratio)`, `maxSize = Math.round(targetSize * 1.2)`. Appends `## Existing Summary (update this...)` + `context.existingSum` for updates.

**Phase 2 (Directory Aggregation)**: `buildDirectoryPrompt()` reads `fileEntries = entries.filter(e => e.isFile() && !e.name.endsWith('.sum') && !e.name.startsWith('.'))`, parallel reads `.sum` files via `readSumFile()`, formats as `### ${entry.name}\n**Purpose:** ${sumContent.metadata.purpose}\n\n${sumContent.summary}`. Reads child `AGENTS.md`, extracts user-authored `AGENTS.local.md` or detects ARE-generated via `GENERATED_MARKER`. Calls `extractDirectoryImports()` for source files matching `/\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, detects manifest files (`manifestNames = ['package.json', 'Cargo.toml', 'go.mod', ...]`). Returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` + existing for updates or `DIRECTORY_SYSTEM_PROMPT` for new.

### User Content Preservation

Both `writeAgentsMd()` and `writeClaudeMdPointer()` follow rename-then-import pattern: check `content.includes(GENERATED_MARKER)`, if absent (user-authored) then `rename()` to `*.local.md`, prepend `@*.local.md` import directive to generated output, write with `GENERATED_MARKER` header.

### Complexity Metrics

`analyzeComplexity()` aggregates `fileCount` (array length), `directoryDepth` via `calculateDirectoryDepth()` (max depth using `path.relative()` + `split(path.sep).length - 1`), `directories: Set<string>` via `extractDirectories()` (parent traversal via `path.dirname()` until root). Used by orchestration layer for progress estimation.

## File Relationships

```
executor.ts → ../orchestration/orchestrator.js (GenerationPlan import)
executor.ts → ./writers/sum.js (sumFileExists import)
types.ts → (no imports, defines shared interfaces)
collector.ts → (no generation imports, pure filesystem traversal)
complexity.ts → (no generation imports, pure metric computation)
prompts/builder.ts → ./types.js (PromptContext import)
prompts/builder.ts → ./writers/sum.js (readSumFile import)
prompts/builder.ts → ../imports/extractor.js (extractDirectoryImports import)
writers/sum.ts → ../types.js (SummaryMetadata import)
writers/agents-md.ts → ./sum.js (GENERATED_MARKER import)
writers/claude-md.ts → ./agents-md.js (GENERATED_MARKER import)
```

## Behavioral Contracts

### Post-Order Sort
```javascript
getDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth
// getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length
```

### Task ID Conventions
```javascript
fileTasks: "file:${relativePath}"
directoryTasks: "dir:${relativePath}"
```

### Compression Injection Condition
```javascript
compressionRatio < 0.5 && sourceFileSize > 0
```

### Compression Calculation
```javascript
targetSize = Math.round(sourceFileSize * compressionRatio)
maxSize = Math.round(targetSize * 1.2)
compressionPercentage = Math.round(compressionRatio * 100)
```

### Directory Entry Filtering
```javascript
fileEntries = entries.filter(e => e.isFile() && !e.name.endsWith('.sum') && !e.name.startsWith('.'))
dirEntries = entries.filter(e => e.isDirectory() && (!knownDirs || knownDirs.has(relativeDir)))
sourceFiles = fileNames.filter(f => /\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/.test(f))
```

### Manifest Detection List
```javascript
manifestNames = ['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']
```

### Generated File Marker
```javascript
GENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'
```

### YAML Frontmatter Extraction
```regex
/^---\n([\s\S]*?)\n---\n/
```

### YAML Array Format Rules
```javascript
// Inline if: items.length <= 3 && items.every(item => item.length < 40)
key: [value1, value2, value3]

// Multi-line otherwise:
key:
  - value1
  - value2
```

### Array Parsing Regex (Inline)
```regex
/key:\s*\[([^\]]*)\]/
```

### Array Parsing Regex (Multi-line)
```regex
/key:\s*\n((?:\s+-\s+.+\n?)+)/m
```

### Skip Directory List
```javascript
SKIP_DIRS = ['node_modules', '.git', '.agents-reverse-engineer', 'vendor', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target', '.cargo', '.gradle']
```

## Integration Points

**Phase 1 (File Analysis)**: `src/orchestration/runner.ts` calls `buildExecutionPlan()` → `runPool()` over `fileTasks` → `AIService.call()` with `buildFilePrompt()` → `writeSumFile()` with `computeContentHash()` in metadata.

**Phase 2 (Directory Aggregation)**: `runner.ts` iterates `directoryTasks` post-order → `getReadyDirectories()` filters complete directories → `buildDirectoryPrompt()` reads child `.sum` via parallel `readSumFile()` → `AIService.call()` → `writeAgentsMd()` → root `writeClaudeMdPointer()`.

**Update Pipeline**: `src/update/orchestrator.ts` calls `readSumFile()` to extract `content_hash` frontmatter, compares against `computeContentHash()`, populates `filesToAnalyze` on mismatch, triggers `buildFilePrompt()` with `existingSum` for incremental updates, calls `getAffectedDirectories()` for post-order `AGENTS.md` regeneration.

**Specification Pipeline**: `src/specify/prompts.ts` calls `collectAgentsDocs()` to aggregate all `AGENTS.md` into project specification prompts. `src/rebuild/spec-reader.ts` calls `collectAnnexFiles()` to extract reproduction-critical constants during reconstruction.