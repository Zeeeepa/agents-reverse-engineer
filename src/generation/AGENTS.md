<!-- Generated by agents-reverse-engineer -->

# generation

**Two-phase documentation generation pipeline: file analysis (parallel .sum generation) followed by post-order directory aggregation (AGENTS.md synthesis), coordinated by `GenerationOrchestrator` and executed via `ExecutionPlan` dependency graphs.**

## Contents

### Core Orchestration

**[orchestrator.ts](./orchestrator.ts)** — `GenerationOrchestrator.createPlan()` builds `GenerationPlan` by reading file contents via `prepareFiles()`, computing `ComplexityMetrics` via `analyzeComplexity()`, constructing project structure listing via `buildProjectStructure()`, generating file analysis tasks via `createFileTasks()` (injects `buildFilePrompt()` results), and creating directory aggregation tasks via `createDirectoryTasks()` (defers prompt construction to execution time). Zeroes `PreparedFile.content` fields post-task creation to free memory.

**[executor.ts](./executor.ts)** — `buildExecutionPlan()` transforms `GenerationPlan` into `ExecutionPlan` with dependency graph: file tasks (`id: 'file:${path}'`, empty `dependencies`) sorted by directory depth descending for parallel execution; directory tasks (`id: 'dir:${path}'`, dependencies containing child file task IDs) sorted by depth descending for post-order traversal. `getReadyDirectories()` filters directories where `isDirectoryComplete()` confirms all `.sum` files exist. `formatExecutionPlanAsMarkdown()` emits checklist for dry-run visualization.

**[collector.ts](./collector.ts)** — `collectAgentsDocs(projectRoot)` recursively walks directory tree filtering `SKIP_DIRS` set (`['node_modules', '.git', '.agents-reverse-engineer', 'vendor', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target', '.cargo', '.gradle']`), collects files named exactly `AGENTS.md`, returns sorted `AgentsDocs` array (`{ relativePath, content }`). `collectAnnexFiles(projectRoot)` mirrors behavior for `.annex.sum` suffix matches.

**[complexity.ts](./complexity.ts)** — `analyzeComplexity(files, projectRoot)` computes `ComplexityMetrics`: `fileCount` via `files.length`, `directoryDepth` via `calculateDirectoryDepth()` splitting `path.relative()` on `path.sep` and subtracting 1, `directories` Set via `extractDirectories()` walking upward with `path.dirname()` until `'.'` or parent-equals-self root sentinel. Used by orchestrator to configure worker pool size and memory estimates.

### Type Contracts

**[types.ts](./types.ts)** — `AnalysisResult` interface (`summary: string`, `metadata: SummaryMetadata`) represents LLM output. `SummaryMetadata` captures `purpose: string`, optional `criticalTodos?: string[]` (security/breaking issues only), optional `relatedFiles?: string[]` (tight coupling only). `SummaryOptions` configures `targetLength: 'short' | 'standard' | 'detailed'` and `includeCodeSnippets: boolean`.

## Architecture

### Execution Flow

1. **Discovery** → `src/discovery/walker.ts` produces `DiscoveryResult` with file paths
2. **Planning** → `GenerationOrchestrator.createPlan()` loads file contents, analyzes complexity, builds prompts, emits `plan:created` event
3. **Graph Construction** → `buildExecutionPlan()` creates dependency graph with post-order sorted directory tasks
4. **File Phase** → Worker pool (`src/orchestration/pool.ts`) executes file tasks in parallel, writes `.sum` files via `src/generation/writers/sum.ts`
5. **Directory Phase** → `src/orchestration/runner.ts` executes directory tasks in depth-descending order after `isDirectoryComplete()` confirms readiness, writes `AGENTS.md` via `src/generation/writers/agents-md.ts`
6. **Root Phase** → Single `writeClaudeMdPointer()` call generates deterministic `CLAUDE.md` entry point

### Post-Order Traversal Mechanism

`getDirectoryDepth(dir)` returns `0` for root `'.'`, else segment count via `dir.split(path.sep).length`. All sorting uses `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending) to ensure deepest directories process first. `fileTasks` sorted by directory depth descending enables locality-aware scheduling. `directoryTasks` sorted by depth descending ensures child `AGENTS.md` exist before parent aggregation via `buildDirectoryPrompt()`.

### Dependency Graph Invariants

- File task `dependencies: []` (parallelizable)
- Directory task dependencies: `files.map(f => 'file:${f}')` (blocked until child `.sum` files exist)
- Task ID format: `file:` prefix for analysis tasks, `dir:` prefix for aggregation tasks
- Output paths: `${absolutePath}.sum` for files, `${dirAbsPath}/AGENTS.md` for directories

## Behavioral Contracts

**Directory filtering regex (collector.ts):** `SKIP_DIRS.has(entry.name)` blocks traversal into vendor/build directories

**Depth calculation formula (complexity.ts):** `path.relative(projectRoot, file).split(path.sep).length - 1`

**Root sentinel pattern (complexity.ts):** `while (dir && dir !== '.') { const parent = path.dirname(dir); if (parent === dir) break; }`

**Post-order sort comparator (executor.ts):** `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)`

**Task ID format (executor.ts):**
- File: `file:${relativePath}`
- Directory: `dir:${relativePath}`

**Memory optimization (orchestrator.ts):** `(file as { content: string }).content = ''` after embedding in prompts

**Task count adjustment (orchestrator.ts):** `plan:created` emits `taskCount: tasks.length + 1` accounting for deferred CLAUDE.md task

**Ready directory predicate (executor.ts):** `missing.length === 0` from `isDirectoryComplete()` checking `sumFileExists()` for all expected files

## Integration Points

- **Prompts**: `buildFilePrompt()` and `buildDirectoryPrompt()` from `src/generation/prompts/builder.ts` inject placeholders, import maps, project structure
- **Writers**: `writeSumFile()`, `writeAgentsMd()`, `writeClaudeMdPointer()` from `src/generation/writers/` serialize LLM output with user content preservation
- **Telemetry**: Emits `phase:start`, `plan:created`, `phase:end` events via `ITraceWriter` to `src/ai/telemetry/run-log.ts`
- **Orchestration**: Consumed by `src/orchestration/runner.ts` invoking `createPlan()` → `buildExecutionPlan()` → worker pool execution
- **Discovery**: Receives `DiscoveryResult` from `src/discovery/run.ts` containing filtered source file paths

## Subdirectories

**[prompts/](./prompts/)** — Template-based prompt construction exposing `buildFilePrompt()` (injects `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}` into `FILE_SYSTEM_PROMPT`/`FILE_USER_PROMPT`) and `buildDirectoryPrompt()` (assembles import maps via `extractDirectoryImports()`, manifest hints, annex listings, user notes from `AGENTS.local.md`, existingAgentsMd for updates). Enforces density rules, anchor term preservation, behavioral contract verbatim requirements, path accuracy mandates via `DIRECTORY_SYSTEM_PROMPT`.

**[writers/](./writers/)** — Filesystem serialization layer exporting `writeSumFile()` (YAML frontmatter + markdown body, SHA-256 `content_hash`), `writeAgentsMd()` (renames user AGENTS.md → AGENTS.local.md, injects `@AGENTS.local.md` import directive, prepends `GENERATED_MARKER`), `writeClaudeMdPointer()` (deterministic CLAUDE.md with `@CLAUDE.local.md` and `@AGENTS.md` directives), `writeAnnexFile()` (fenced code block .annex.sum for reproduction-critical source).