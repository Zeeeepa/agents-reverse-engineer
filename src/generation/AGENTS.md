<!-- Generated by agents-reverse-engineer -->

# src/generation

Orchestrates the three-phase documentation pipeline: file analysis (concurrent .sum generation), directory synthesis (post-order AGENTS.md), and root document aggregation (CLAUDE.md). Builds ExecutionTask dependency graphs enforcing deepest-first traversal, constructs phase-specific prompts with import maps and child documentation, and writes outputs via YAML-frontmatter .sum files and marker-guarded AGENTS.md files.

## Contents

### Orchestration

- [orchestrator.ts](./orchestrator.ts) — `GenerationOrchestrator.createPlan()` prepares PreparedFile array via `readFile()`, analyzes ComplexityMetrics via `analyzeComplexity()`, builds AnalysisTask array for file/directory phases via `createFileTasks()` + `createDirectoryTasks()`, clears PreparedFile.content after embedding in prompts, emits `phase:start` + `plan:created` + `phase:end` trace events
- [executor.ts](./executor.ts) — `buildExecutionPlan()` converts GenerationPlan to ExecutionTask graph with dependencies (directory tasks depend on file task IDs, root tasks depend on directory task IDs), sorts by depth descending (`getDirectoryDepth()`); `isDirectoryComplete()` checks `.sum` existence via `sumFileExists()`; `formatExecutionPlanAsMarkdown()` generates GENERATION-PLAN.md with checkbox task lists grouped by depth
- [types.ts](./types.ts) — `AnalysisResult` interface (summary, metadata), `SummaryMetadata` interface (purpose, criticalTodos, relatedFiles), `SummaryOptions` interface (targetLength, includeCodeSnippets)

### Analysis

- [complexity.ts](./complexity.ts) — `analyzeComplexity()` computes ComplexityMetrics (fileCount, directoryDepth via `calculateDirectoryDepth()`, files array, directories Set via `extractDirectories()`)
- [collector.ts](./collector.ts) — `collectAgentsDocs()` walks tree recursively, filters AGENTS.md files, skips SKIP_DIRS (node_modules, .git, vendor, dist, build), returns AgentsDocs array sorted by relativePath; `collectAnnexFiles()` uses same pattern for `.annex.md` files

## Subdirectories

- [prompts/](./prompts/) — `buildFilePrompt()`, `buildDirectoryPrompt()`, `buildRootPrompt()` embed source content, `.sum` files, import maps (via `extractDirectoryImports`), subdirectory AGENTS.md, and projectStructure into FILE_SYSTEM_PROMPT, DIRECTORY_SYSTEM_PROMPT, ROOT_SYSTEM_PROMPT templates; switch to incremental update prompts (FILE_UPDATE_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT) when existingSum or existingAgentsMd present
- [writers/](./writers/) — `writeSumFile()` serializes AnalysisResult to `.sum` with YAML frontmatter (generated_at, content_hash, purpose, critical_todos, related_files); `writeAgentsMd()` creates AGENTS.md with GENERATED_MARKER, preserves user-authored versions as AGENTS.local.md; `writeAnnexFile()` generates `.annex.md` for reproduction-critical source

## Architecture

### Three-Phase Pipeline

1. **File Analysis (Phase 1)**: `createFileTasks()` builds AnalysisTask array with `buildFilePrompt()` embedding filePath, content, language (`detectLanguage`), projectPlan; tasks eligible for concurrent execution via worker pool
2. **Directory Synthesis (Phase 2)**: `createDirectoryTasks()` creates tasks depending on all file task IDs in directory; `buildDirectoryPrompt()` reads `.sum` files via `readSumFile()`, extracts import map via `extractDirectoryImports()`, collects subdirectory AGENTS.md via filtered relativePath array; `writeAgentsMd()` merges user + LLM content with GENERATED_MARKER
3. **Root Document (Phase 3)**: `buildRootPrompt()` aggregates all AGENTS.md via `collectAgentsDocs()`, parses package.json metadata, embeds output requirements for CLAUDE.md; single task depends on all directory task IDs

### Post-Order Traversal

`buildExecutionPlan()` enforces deepest-first execution by sorting fileTasks and directoryTasks via `getDirectoryDepth()` descending (child directories before parents). Each directoryTask.dependencies contains all file task IDs from its directory. rootTasks depend on all directory task IDs. This guarantees child `.sum` and `AGENTS.md` files exist before parent aggregation.

### Memory Optimization

`GenerationOrchestrator.createPlan()` clears `PreparedFile.content` fields after `createFileTasks()` embeds them in prompts, releasing memory before directory/root phases. Runner re-reads files from disk during execution.

## Data Flow

1. `src/cli/generate.ts` invokes `orchestrator.createPlan(discoveryResult)` → returns GenerationPlan
2. `executor.buildExecutionPlan(plan, projectRoot)` → returns ExecutionPlan with dependency graph
3. `src/orchestration/runner.ts` executes phases: fileTasks via pool → directoryTasks post-order → rootTasks
4. File tasks call `AIService.analyzeFile()` → `writeSumFile()` writes `.sum` with YAML frontmatter
5. Directory tasks call `buildDirectoryPrompt()` reading `.sum` via `readSumFile()` → `writeAgentsMd()` creates AGENTS.md
6. Root tasks call `buildRootPrompt()` aggregating AGENTS.md via `collectAgentsDocs()` → writes CLAUDE.md

## Behavioral Contracts

### Task ID Format
- File tasks: `file:${filePath}` (e.g., `file:src/cli/index.ts`)
- Directory tasks: `dir:${dirPath}` (e.g., `dir:src/cli`)
- Root tasks: `root:CLAUDE.md`

### Directory Exclusion
`SKIP_DIRS`: `['node_modules', '.git', '.agents-reverse-engineer', 'vendor', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target', '.cargo', '.gradle']` (from `collector.ts`)

### Dependency Graph Rules
- Each directory task depends on all file task IDs in its directory (enforced by `buildExecutionPlan()`)
- Root tasks depend on all directory task IDs
- Depth sorting: `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` for descending order (deepest first)

### Prompt Placeholders
- `FILE_USER_PROMPT`: `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}`
- `DIRECTORY_SYSTEM_PROMPT`: injects import map, file summaries, subdirectory AGENTS.md, projectStructure tree
- `ROOT_SYSTEM_PROMPT`: injects all AGENTS.md, package.json metadata (name, version, description)

## Integration Points

- **Import Extraction**: delegates to `extractDirectoryImports()` + `formatImportMap()` from `src/imports/index.ts` to build verified cross-reference map for AGENTS.md
- **Trace Emission**: emits `phase:start`, `plan:created`, `phase:end` via ITraceWriter to `.agents-reverse-engineer/traces/`
- **Sum File I/O**: `writers/sum.ts` provides `writeSumFile()`, `readSumFile()`, `getSumPath()`, `sumFileExists()` for `.sum` lifecycle
- **Runner Execution**: `src/orchestration/runner.ts` consumes ExecutionPlan, invokes pool for file tasks, calls `buildDirectoryPrompt()` + `buildRootPrompt()` at runtime