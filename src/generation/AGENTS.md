<!-- Generated by agents-reverse-engineer -->

# generation

**Orchestrates three-phase documentation generation pipeline: concurrent file analysis via `GenerationOrchestrator.createFileTasks()`, post-order directory synthesis via `buildExecutionPlan()` with depth-sorted traversal, and root document synthesis via `collectAgentsDocs()` aggregation, enforcing dependency graphs through `ExecutionTask.dependencies` arrays and completion predicates via `isDirectoryComplete()`.**

## Contents

### Pipeline Orchestration

**[orchestrator.ts](./orchestrator.ts)** — `GenerationOrchestrator` prepares files via `prepareFiles(discoveryResult)` reading content with `readFile()`, creates file tasks via `createFileTasks(files)` calling `buildFilePrompt()` for each file, creates directory tasks via `createDirectoryTasks(files)` grouping by `path.dirname()`, emits trace events (`phase:start`, `plan:created`, `phase:end`) via `ITraceWriter`, clears `PreparedFile.content` after prompt embedding to free memory, returns `GenerationPlan` with `files`, `tasks`, `complexity` from `analyzeComplexity()`. `buildProjectStructure()` formats directory tree as indented text for AI context.

**[executor.ts](./executor.ts)** — `buildExecutionPlan()` constructs dependency graph from `GenerationPlan`: populates `directoryFileMap` extracting directories via `path.dirname()`, creates file tasks with `id: "file:{path}"`, sorts files by `getDirectoryDepth(path.dirname())` descending (deepest first), sorts directories by depth descending, creates directory tasks with `dependencies: fileTaskIds`, creates root tasks with `dependencies: allDirTaskIds`, returns `ExecutionPlan` with `fileTasks`/`directoryTasks`/`rootTasks` arrays. `isDirectoryComplete()` checks all files have `.sum` outputs via `sumFileExists()`, `getReadyDirectories()` identifies directories eligible for `AGENTS.md` generation, `formatExecutionPlanAsMarkdown()` generates `GENERATION-PLAN.md` with checkbox lists grouped by phase and depth.

**[collector.ts](./collector.ts)** — `collectAgentsDocs()` recursively walks project tree via `readdir(withFileTypes)`, collects files named exactly `AGENTS.md`, skips 13 directories in `SKIP_DIRS` set (`node_modules`, `.git`, `.agents-reverse-engineer`, `vendor`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`), returns `AgentsDocs` array sorted by `relativePath` via `localeCompare()`. `collectAnnexFiles()` uses identical traversal logic for files ending `.annex.md`. Gracefully handles permission-denied via silent exception catch.

**[complexity.ts](./complexity.ts)** — `analyzeComplexity()` computes `ComplexityMetrics` with `fileCount`, `directoryDepth` via `calculateDirectoryDepth()` (splits `path.relative()` by `path.sep`, tracks max), `directories` set via `extractDirectories()` (walks upward via repeated `path.dirname()` until root), `files` array. Consumed by `GenerationOrchestrator.createPlan()` for complexity warnings.

**[types.ts](./types.ts)** — `AnalysisResult` with `summary: string` and `metadata: SummaryMetadata`, `SummaryMetadata` with `purpose`, `criticalTodos`, `relatedFiles`, `SummaryOptions` with `targetLength` discriminant (`'short' | 'standard' | 'detailed'`) and `includeCodeSnippets` boolean. Maps to `.sum` YAML frontmatter schema.

## Subdirectories

**[prompts/](./prompts/)** — Prompt template constants (`FILE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `ROOT_SYSTEM_PROMPT`) with density rules (every sentence references identifiers), filler phrase prohibition (`"this file"`, `"provides"`, `"responsible for"`), behavioral contract extraction (verbatim regex/constants). Builders (`buildFilePrompt`, `buildDirectoryPrompt`, `buildRootPrompt`) substitute placeholders (`{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`), aggregate child `.sum` files via `readSumFile()`, extract import maps via `extractDirectoryImports()`, preserve user content from `AGENTS.local.md`, switch to update prompts (`FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`) when `existingSum`/`existingAgentsMd` present.

**[writers/](./writers/)** — YAML frontmatter serialization (`writeSumFile`, `readSumFile`, `getSumPath`, `sumFileExists`) with SHA-256 hash tracking, inline/multi-line array formatting, annex file generation (`writeAnnexFile`, `getAnnexPath`) for reproduction-critical source content. `writeAgentsMd()` preserves user content via `AGENTS.local.md` rename, marker-based detection (`isGeneratedAgentsMd`), prepends preserved sections with `---` separator.

## Post-Order Traversal

`buildExecutionPlan()` enforces children-before-parents ordering via two sorts:
1. **File tasks**: `getDirectoryDepth(path.dirname(a.path)) - getDirectoryDepth(path.dirname(b.path))` descending (deepest first)
2. **Directory tasks**: `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` descending

Ensures child `AGENTS.md` files exist before parent directory prompts consume them via `collectAgentsDocs()` in `buildDirectoryPrompt()`.

## Dependency Graph

`ExecutionTask.dependencies: string[]` enforces Phase 1 → Phase 2 → Phase 3 sequencing:
- **File tasks**: empty dependencies (parallel eligible)
- **Directory tasks**: depend on all file task IDs in directory (`id: "file:{path}"`)
- **Root tasks**: depend on all directory task IDs (`id: "dir:{path}"`)

`isDirectoryComplete()` verifies all `expectedFiles` have `.sum` outputs before allowing directory task execution.

## Prompt Placeholder Pattern

Directory and root tasks store placeholder prompts (`"Built at runtime by buildDirectoryPrompt()"`) for plan display and dependency tracking. Actual prompts constructed at execution time in `src/orchestration/runner.ts` via `buildDirectoryPrompt()` and `buildRootPrompt()`, consuming child `.sum` files and subdirectory `AGENTS.md` not available during plan creation.

## Trace Events

`GenerationOrchestrator.createPlan()` emits:
- `phase:start` with `{ type: 'phase:start', phase: 'plan-creation', taskCount, concurrency: 1 }`
- `plan:created` with `{ type: 'plan:created', planType: 'generate', fileCount, taskCount: tasks.length + 1 }` (accounting for root task added by `buildExecutionPlan()`)
- `phase:end` with `{ type: 'phase:end', phase: 'plan-creation', durationMs, tasksCompleted: 1, tasksFailed: 0 }`

## Integration Points

Imports `buildFilePrompt` from `./prompts/index.js` for Phase 1 task creation. Imports `sumFileExists` from `./writers/sum.js` for completion checking. Imports `analyzeComplexity` from `./complexity.js` for metrics computation. Imports `ITraceWriter` from `../orchestration/trace.js` for event emission. Imports `Config` from `../config/schema.js` and `DiscoveryResult` from `../types/index.js`.

Consumed by `src/orchestration/runner.ts` which executes `ExecutionPlan` via worker pool, calling `AIService` with runtime-constructed prompts for directory and root tasks.

## Memory Management

After `createFileTasks()` embeds file content into prompts, `createPlan()` clears `PreparedFile.content` via `(file as { content: string }).content = ''` to free memory. Comment notes runner re-reads files from disk during execution.