---
generated_at: 2026-02-09T21:29:19.231Z
content_hash: ce2e011f7fef57965d65e9ef53021b1c55e08a731d46740a22fe9df388a8a907
purpose: executor.ts transforms GenerationPlan into ExecutionPlan with post-order directory traversal, dependency tracking, an...
---
**executor.ts transforms GenerationPlan into ExecutionPlan with post-order directory traversal, dependency tracking, and directory completion predicates.**

## Exported Types

**ExecutionTask** represents a single AI processing unit with fields:
- `id: string` — unique identifier (`file:path`, `dir:path`, `root:docname`)
- `type: 'file' | 'directory' | 'root-doc'` — discriminator for task category
- `path: string` — relative path to file or directory
- `absolutePath: string` — resolved absolute path
- `systemPrompt: string` — AI system message (placeholder for dir/root tasks)
- `userPrompt: string` — AI user message (placeholder for dir/root tasks)
- `dependencies: string[]` — array of task IDs that must complete first
- `outputPath: string` — where to write generated content (`.sum` or `AGENTS.md` or `CLAUDE.md`)
- `metadata: { directoryFiles?: string[], depth?: number, packageRoot?: string }` — tracking data

**ExecutionPlan** contains dependency graph with fields:
- `projectRoot: string` — absolute path to project root
- `tasks: ExecutionTask[]` — all tasks in execution order
- `fileTasks: ExecutionTask[]` — Phase 1 file analysis tasks (parallel eligible)
- `directoryTasks: ExecutionTask[]` — Phase 2 AGENTS.md generation tasks (post-order)
- `rootTasks: ExecutionTask[]` — Phase 3 root document synthesis tasks (sequential)
- `directoryFileMap: Record<string, string[]>` — maps directory paths to contained file relative paths
- `projectStructure?: string` — compact project listing for prompt context

## Core Functions

**buildExecutionPlan(plan: GenerationPlan, projectRoot: string): ExecutionPlan** constructs three-phase task graph:
1. Populates `directoryFileMap` by grouping files via `path.dirname()`
2. Creates file tasks with `id: 'file:${filePath}'`, `dependencies: []`, `outputPath: '${absolutePath}.sum'`
3. Sorts file tasks by directory depth descending via `getDirectoryDepth(path.dirname(path))`
4. Creates directory tasks sorted by depth descending for post-order traversal, each depending on all file tasks in that directory (dependencies populated from `directoryFileMap`)
5. Creates root tasks (`id: 'root:CLAUDE.md'`) depending on all directory task IDs
6. Directory and root task prompts are placeholders (`'Built at runtime by buildRootPrompt()'`) — actual prompts constructed by `runner.ts` Phase 2/3 logic

**isDirectoryComplete(dirPath: string, expectedFiles: string[], projectRoot: string): Promise<{ complete: boolean; missing: string[] }>** checks readiness by calling `sumFileExists()` for each file in `expectedFiles`, returns `{ complete: true, missing: [] }` if all `.sum` files exist.

**getReadyDirectories(executionPlan: ExecutionPlan): Promise<string[]>** filters `directoryFileMap` entries by calling `isDirectoryComplete()` for each directory, returns array of directory paths ready for AGENTS.md generation.

**formatExecutionPlanAsMarkdown(plan: ExecutionPlan): string** generates GENERATION-PLAN.md content:
- Header: `# Documentation Generation Plan` with ISO date and `plan.projectRoot`
- Summary: counts for `tasks.length`, `fileTasks.length`, `directoryTasks.length`, `rootTasks.length`
- Phase 1: groups files by directory using `directoryTasks` order (already post-order), outputs `### Depth N: dir/ (M files)` sections with `- [ ] \`file\`` checklist items
- Phase 2: groups directories by `metadata.depth`, outputs `### Depth N` sections with `- [ ] \`dir/AGENTS.md\`` checklist items in descending depth order
- Phase 3: outputs `- [ ] \`CLAUDE.md\`` checklist item

## Helper Functions

**getDirectoryDepth(dir: string): number** calculates depth by splitting on `path.sep` and counting segments:
- `'.'` → `0` (root special case)
- `'src'` → `1`
- `'src/cli'` → `2`

Used for post-order sorting: deeper directories (higher depth) must complete before shallower parents.

## Integration Points

Consumes `GenerationPlan` from `orchestrator.ts` (contains `tasks[]`, `files[]`, `projectStructure` fields).

Consumed by `runner.ts`:
- `buildExecutionPlan()` called in Phase 1 initialization
- `isDirectoryComplete()` called in Phase 2 to wait for child `.sum` files
- `formatExecutionPlanAsMarkdown()` output written to `GENERATION-PLAN.md` via `PlanTracker`

Calls `sumFileExists()` from `writers/sum.ts` to check `.sum` file presence without parsing YAML frontmatter.

## Post-Order Traversal Strategy

Directory tasks sorted by depth descending (deepest first) ensures child `AGENTS.md` files exist before parent directories attempt aggregation. Sort key: `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending). File tasks similarly sorted to process leaf directories first. Root tasks depend on all directory task IDs, enforcing three-phase waterfall: files → directories → root.