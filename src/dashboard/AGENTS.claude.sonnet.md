<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/dashboard

Telemetry analysis and visualization layer exposing cost/performance/trace data through terminal tables, ASCII Gantt charts, sparklines, and self-contained HTML reports with Chart.js integration.

## Contents

- [`cost-calculator.ts`](./cost-calculator.ts): Maintains model pricing tables (`MODEL_PRICING`: Anthropic claude-opus-4-6/sonnet-4-5/haiku-4-5, OpenAI codex-mini/gpt-5/o3/o4-mini, Gemini 2.5-flash/3.0-flash/2.5-pro with per-million-token rates for input/output/cacheRead/cacheWrite) and exports `computeCost`/`computeRunCost`/`getModelPricing`/`formatCost`/`formatTokens`/`formatDuration`. `getModelPricing` performs bidirectional substring matching, defaults to Sonnet rates (3/15/0.3/3.75). `CostBreakdown` interface holds `inputCost`/`outputCost`/`cacheReadCost`/`cacheWriteCost`/`totalCost`.
- [`html-report.ts`](./html-report.ts): `generateHtmlReport(logs: RunLog[]): string` produces self-contained HTML dashboard embedding Chart.js v4 from CDN, dark theme styles (`#0d1117` background, `#c9d1d9` text), four visualizations (cost breakdown stacked bar, token distribution stacked bar, daily cost trend line with `tension: 0.3`, duration bar), summary table (13 columns: Run/Backend/Model/Cmd/Files/Calls/In Tok/Out Tok/Cache R/Cache W/Duration/Err/Cost), stats cards (total cost/run count/tokens/errors). Aggregates logs by ISO date prefix (`startTime.slice(0, 10)`) for trends.
- [`index.ts`](./index.ts): `dashboardCommand(targetPath, options: DashboardOptions)` routes to views: `--format html` invokes `generateHtmlReport`, `--format json` serializes logs, `--trace` calls `parseTraceFile` + `renderTimeline`, `--run` calls `readRunLog` + `renderEntriesTable`, `--trends` calls `renderTrends`, default `renderSummaryTable`. Exits code 1 if trace/run not found.
- [`log-reader.ts`](./log-reader.ts): `readAllRunLogs` reads `run-*.json` from `.agents-reverse-engineer/logs/`, validates basic shape (`runId`/`entries`/`summary`), sorts descending by `startTime` via `localeCompare`. `readRunLog` finds single log by partial `runId`/`startTime` match. `shortRunId` converts ISO8601 timestamp to `YYYY-MM-DD HH:MM` via regex `/^(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2})/`.
- [`trace-reader.ts`](./trace-reader.ts): `parseTraceFile` streams NDJSON lines via readline, reconstructs `PhaseTimeline`/`WorkerTimeline`/`TaskSpan` hierarchies from flat `TraceEvent` stream by tracking `workerPhase` Map, `pendingTasks` Map (keyed `${workerId}:${taskIndex}`), `workerTasks` Map. Handles `phase:start`/`worker:start`/`task:pickup`/`task:done`/`phase:end` events. `listTraceFiles` returns absolute paths to `trace-*.ndjson` sorted newest-first. `findTraceFile` matches partial timestamp. `shortTraceId` extracts display ID via regex `/trace-(\d{4}-\d{2}-\d{2})T(\d{2})-(\d{2})/` → `YYYY-MM-DD HH:MM`.

## Subdirectories

- [`views/`](./views/): Terminal renderers emitting picocolors-styled tables/charts: `renderSummaryTable` (tabular overview with auto-sizing, cost footer), `renderEntriesTable` (per-file call stats, P90 latency outliers, top-5 slowest calls), `renderTimeline` (ASCII Gantt with 60-char width, U+2593 success/U+2591 failure glyphs, speedup/utilization stats), `renderTrends` (daily cost table, cache savings, cost-per-file, error rate bars U+2588, sparklines U+2581–U+2588).

## Data Flow

`dashboardCommand` calls `findProjectRoot` to locate `.agents-reverse-engineer/`, `readAllRunLogs` to load telemetry, routes to view renderer based on options. `html-report.ts` transforms `RunLog[]` into `tableRows` array (metrics extraction), `dailyData` array (date aggregation via `startTime.slice(0, 10)`), computes `totalCost`/`totalTokens`, injects into template literal with inline Chart.js datasets. `trace-reader.ts` streams NDJSON via `createInterface` + `createReadStream`, emits `ParsedTrace` consumed by `views/timeline.ts` for Gantt rendering. `views/entries.ts` computes P90 latency via `percentile` for outlier highlighting.

## Behavioral Contracts

**Directory Paths**:
- Logs: `.agents-reverse-engineer/logs/`
- Traces: `.agents-reverse-engineer/traces/`

**Filename Patterns**:
- Run logs: `run-*.json`
- Traces: `trace-*.ndjson`

**Chart.js CDN**: `https://cdn.jsdelivr.net/npm/chart.js@4`

**Color Palette** (html-report.ts):
- Chart datasets: `{ blue: '#58a6ff', green: '#3fb950', orange: '#f9826c', purple: '#bc8cff', gray: '#484f58' }`
- Dark theme: background `#0d1117`, text `#c9d1d9`, borders `#21262d`, error `#f85149`, cost `#f9826c`

**Model Pricing Defaults**:
- Unknown models: Sonnet rates (3/15/0.3/3.75 USD per million input/output/cacheRead/cacheWrite tokens)
- Concurrency formula: `min(cores * 5, floor(totalMemGB * 0.5 / 0.512), 20)`

**Timeline Constants**:
- Gantt width: `BAR_WIDTH = 60`
- Success glyph: U+2593 (medium shade)
- Failure glyph: U+2591 (light shade)
- Worker display limit: 10

**Trends Constants**:
- Sparkline range: U+2581 (lower one eighth) to U+2588 (full block)
- Error rate bar width: `(errorRate / 2)` rounded
- Success checkmark: U+2713

**Date Aggregation**: `log.startTime.slice(0, 10)` (ISO date prefix)

**Short ID Regex**:
- Run logs: `/^(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2})/` → `YYYY-MM-DD HH:MM`
- Traces: `/trace-(\d{4}-\d{2}-\d{2})T(\d{2})-(\d{2})/` → `YYYY-MM-DD HH:MM`

**Outlier Detection** (entries.ts):
- P90 latency threshold via `percentile(entries.map(e => e.latencyMs), 0.9)`
- Retry highlight: `entry.retries > 0`
- Error highlight: `entry.error !== undefined`

**Cost Precision**:
- Formatted: 4 decimals if <$0.01, 3 if <$1, 2 otherwise
- Chart datasets: `.toFixed(4)` dollars