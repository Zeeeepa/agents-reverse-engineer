<!-- Generated by agents-reverse-engineer -->

# src

Root source directory implementing the agents-reverse-engineer CLI tool, orchestrating AI-driven codebase documentation generation through eight command entry points (init, discover, generate, update, clean, specify, rebuild, install/uninstall), three-phase AI pipeline with concurrency control, git-based change detection, and multi-backend AI service abstraction.

## Contents

**[version.ts](./version.ts)** — `getVersion()` retrieves package version from `../package.json` via ESM `import.meta.url` resolution, returns `'unknown'` on read/parse failure, supports both development (src/) and production (dist/) module locations.

## Subdirectories

**[cli/](./cli/)** — Command handlers for eight user-facing operations: `initCommand()` bootstraps `.agents-reverse-engineer/config.yaml`, `discoverCommand()` walks file tree with filter chain, `generateCommand()` orchestrates three-phase AI pipeline (file analysis → directory AGENTS.md → root docs) via `CommandRunner.executeGenerate()`, `updateCommand()` runs incremental regeneration via hash-based staleness detection, `cleanCommand()` deletes ARE-generated artifacts with marker-based filtering, `specifyCommand()` synthesizes project specifications from AGENTS.md via AI, `rebuildCommand()` reconstructs projects from specifications with checkpoint resumption, `runInstaller()` manages command template and hook installation for Claude/OpenCode/Gemini runtimes. Entry point `index.ts` parses CLI args, routes to command modules, handles version/help display.

**[ai/](./ai/)** — `AIBackend` abstraction with retry and subprocess execution. `AIService.call()` invokes CLI backends (ClaudeBackend, GeminiBackend, OpenCodeBackend) via `runSubprocess()` → `execFile()`, applies exponential backoff via `withRetry()`, records telemetry to `.agents-reverse-engineer/logs/run-${timestamp}.json`, emits NDJSON trace events. Backend registry supports auto-detection (`resolveBackend()`) and fallback instructions (`getInstallInstructions()`). Subprocess management enforces timeouts with SIGTERM → SIGKILL escalation, attempts process group kill `kill(-pid)` to terminate subprocess trees.

**[config/](./config/)** — Configuration management via Zod schema validation. `loadConfig()` reads `.agents-reverse-engineer/config.yaml`, validates against `ConfigSchema`, returns defaults on ENOENT. `writeDefaultConfig()` generates commented YAML template. `getDefaultConcurrency()` computes subprocess pool size via `clamp(cores * 5, 2, min(memCap, 20))` formula using 50% of system memory with 0.512 GB per subprocess budget. Default exclusions: 20 vendor directories, 28 glob patterns, 25 binary extensions.

**[discovery/](./discovery/)** — File tree traversal with composable filter chain. `discoverFiles()` executes `walkDirectory()` → `applyFilters()` with four-filter sequence (gitignore → vendor → binary → custom), returns `FilterResult` with included/excluded paths. Filters implement `FileFilter` interface with `shouldExclude()` predicate. Concurrency=30 for I/O-bound binary detection via `isBinaryFile()`.

**[generation/](./generation/)** — Three-phase documentation pipeline orchestration. `GenerationOrchestrator.createPlan()` builds dependency graph with file/directory/root tasks sorted by depth descending (post-order traversal). `buildExecutionPlan()` converts to `ExecutionTask[]` with dependencies enforcing child-before-parent execution. File tasks: `buildFilePrompt()` → `AIService.call()` → `writeSumFile()` with YAML frontmatter. Directory tasks: `buildDirectoryPrompt()` reads `.sum` files, extracts import map via `extractDirectoryImports()`, writes `AGENTS.md` with `GENERATED_MARKER`. Root tasks: `buildRootPrompt()` aggregates all AGENTS.md, writes `CLAUDE.md`. Memory optimization: clears `PreparedFile.content` after embedding in prompts.

**[orchestration/](./orchestration/)** — Execution layer with iterator-based concurrency pool. `CommandRunner.executeGenerate()` runs three phases: concurrent file analysis via `runPool()` with shared iterator pattern, post-order directory synthesis grouped by depth, sequential root doc generation. `runPool()` spawns `Math.min(concurrency, tasks.length)` workers pulling from single `tasks.entries()` iterator, supports `failFast` abort-on-error, emits NDJSON trace events (`phase:start`, `worker:start`, `task:pickup`, `task:done`, `phase:end`) to `.agents-reverse-engineer/traces/`. `PlanTracker` serializes checkbox updates to `GENERATION-PLAN.md` via promise-chain write pattern. `ProgressReporter` streams colored console output with ETA calculation using 10-completion moving average. `TraceWriter` appends events with auto-populated `seq`, `ts`, `pid`, `elapsedMs` fields. Quality checks: `checkCodeVsDoc()`, `checkCodeVsCode()`, `checkPhantomPaths()` run post-phase with concurrency=10.

**[change-detection/](./change-detection/)** — Git-based change detection and SHA-256 content hashing. `getChangedFiles()` parses `git diff --name-status -M` output with rename detection, optionally appends uncommitted changes from `git.status()`. `computeContentHash()` generates hex-encoded SHA-256 from disk, `computeContentHashFromString()` from memory. Maps git status codes (`A`, `M`, `D`, `R<percentage>`) to `ChangeType` union.

**[update/](./update/)** — Incremental documentation updates via frontmatter hash comparison. `UpdateOrchestrator.preparePlan()` reads `.sum` files via `readSumFile()`, compares stored `contentHash` against `computeContentHash()`, classifies files as added/modified/unchanged, calls `cleanupOrphans()` for deleted files, sorts affected directories deepest-first for post-order AGENTS.md regeneration. Abandoned git-based diffing in favor of hash comparison for non-git repository support.

**[imports/](./imports/)** — TypeScript/JavaScript import extraction via regex parsing. `extractImports()` uses `IMPORT_REGEX` with five capture groups (type keyword, named symbols, namespace, default, specifier), `extractDirectoryImports()` reads first 100 lines per file and classifies relative imports as internal (`./`) or external (`../`), `formatImportMap()` serializes for LLM prompt injection.

**[generation/prompts/](./prompts/)** — Prompt construction with targeted context injection. `buildFilePrompt()` embeds source content, language, import map. `buildDirectoryPrompt()` reads `.sum` files via `readSumFile()`, extracts import map, collects subdirectory AGENTS.md. `buildRootPrompt()` aggregates all AGENTS.md, parses package.json metadata. Switches to incremental update prompts (FILE_UPDATE_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT) when existingSum or existingAgentsMd present.

**[generation/writers/](./writers/)** — Output serialization with YAML frontmatter. `writeSumFile()` generates `.sum` with `generated_at`, `content_hash`, `purpose`, `critical_todos`, `related_files` metadata. `writeAgentsMd()` creates AGENTS.md with `GENERATED_MARKER`, preserves user-authored versions as AGENTS.local.md. `writeAnnexFile()` extracts reproduction-critical source (prompt templates, regex patterns, magic constants) to `.annex.md` when AI response contains `'## Annex References'`.

**[specify/](./specify/)** — Specification synthesis from AGENTS.md. `buildSpecPrompt()` assembles AGENTS.md content and annex files into structured prompt with 12-section template (Project Overview, Architecture, Public API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts, Test Contracts, Build Plan, Prompt Templates, IDE Integration, File Manifest). `writeSpec()` supports single-file and multi-file output modes via `splitByHeadings()` markdown sectioning with `/^(?=# )/m` regex. Throws `SpecExistsError` on conflict unless `--force` enabled.

**[rebuild/](./rebuild/)** — AI-driven project reconstruction with checkpoint resumption. `executeRebuild()` reads specs via `readSpecFiles()`, partitions into `RebuildUnit` arrays by `order` field, loads `CheckpointManager` for resume state, groups units by order value, runs `runPool()` for concurrent AI calls within each group, accumulates `builtContext` from completed files (truncated to 100,000 chars with 20-line header retention), checkpoints progress after each unit. `parseModuleOutput()` extracts files via delimiter format `===FILE: path===` / `===END_FILE===` with fallback to fenced blocks. `extractFromBuildPlan()` implements targeted context injection by matching phase Defines:/Consumes: keywords against Architecture, API Surface, Data Structures, Behavioral Contracts subsections.

**[installer/](./installer/)** — npx-driven installation workflow. `runInstaller()` parses CLI flags (`--runtime`, `-g`/`-l`, `--force`), dispatches to interactive prompts (arrow-key navigation in TTY mode) or direct execution, copies command templates from `getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()`, registers hooks into `settings.json` with nested `HookEvent.hooks[]` structure for Claude or flat `GeminiHook[]` for Gemini, adds bash permission patterns to `settings.permissions.allow` array, writes VERSION marker file. `uninstallFiles()` removes templates, hooks, plugins, filters hook arrays by pattern matching against current and legacy formats, deletes `ARE_PERMISSIONS` entries, recursively removes empty directories, cleans up `.agents-reverse-engineer` directory for local uninstalls.

**[integration/](./integration/)** — Environment detection and template generation for AI coding assistants. `detectEnvironments()` scans for `.claude/`, `.opencode/`, `.aider/`, `.gemini/` configuration directories, returns `DetectedEnvironment[]` array. `generateIntegrationFiles()` retrieves platform-specific command templates via `getTemplatesForEnvironment()`, writes with skip-if-exists or force-overwrite logic. Claude templates target `.claude/skills/are-{command}/SKILL.md` with `name:` frontmatter. OpenCode templates target `.opencode/commands/are-{command}.md` with `agent: build` frontmatter. Gemini templates target `.gemini/commands/are-{command}.toml` in TOML format. All platforms receive seven commands: init, discover, generate, update, specify, rebuild, clean, help.

**[quality/](./quality/)** — Quality validation detecting inconsistencies between source and documentation. `checkCodeVsDoc()` extracts exports via regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, performs substring matching against `.sum` summaries to detect `missingFromDoc` and `missingFromCode` arrays. `checkCodeVsCode()` builds `Map<exportName, filePaths[]>` per directory, flags duplicate exports. `checkPhantomPaths()` extracts markdown links and backtick paths via three regex patterns, resolves against filesystem with `existsSync()`, filters false positives. `buildInconsistencyReport()` aggregates warnings/errors with run metadata, `formatReportForCli()` renders with `[ERROR]`/`[WARN]`/`[INFO]` tags and indented context.

**[output/](./output/)** — Terminal logging abstraction with optional color support. `createLogger(options)` returns `Logger` interface with six methods: `info()`, `file()`, `excluded()`, `summary()`, `warn()`, `error()`. `file()` renders `green("  +") + " " + path`, `excluded()` renders `dim("  -") + " " + path + dim(" (reason: filter)")`. `createSilentLogger()` provides no-op implementation for test harnesses.

**[types/](./types/)** — Shared TypeScript interfaces for discovery results. `DiscoveryResult` contains `files: string[]` and `excluded: ExcludedFile[]`. `ExcludedFile` captures `path` + `reason` metadata. `DiscoveryStats` aggregates `totalFiles`, `includedFiles`, `excludedFiles`, and `exclusionReasons` map.

## Architecture

### Three-Phase AI Pipeline

1. **Phase 1 (File Analysis)**: Concurrent `.sum` generation via `runPool()` with shared iterator pattern, file tasks execute `buildFilePrompt()` → `aiService.call()` → `writeSumFile()` with YAML frontmatter (generated_at, content_hash, purpose, critical_todos, related_files), concurrency controlled by config or CPU/memory-based formula
2. **Phase 2 (Directory Synthesis)**: Post-order AGENTS.md generation grouped by directory depth descending (deepest-first), directory tasks execute `buildDirectoryPrompt()` reading child `.sum` files + subdirectory AGENTS.md → `aiService.call()` → `writeAgentsMd()` with `GENERATED_MARKER`, preserves user-authored content as AGENTS.local.md
3. **Phase 3 (Root Documentation)**: Sequential root doc generation (concurrency=1), root tasks execute `buildRootPrompt()` aggregating all AGENTS.md + package.json metadata → `aiService.call()` → writes CLAUDE.md/OPENCODE.md/GEMINI.md

### Concurrency Control

Iterator-based pool in `orchestration/pool.ts`: `runPool()` spawns `Math.min(concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator, each worker pulls `[index, task]` pairs in for-of loop, executes task factory, invokes `onComplete?.(result)`, checks `aborted` flag when `failFast` enabled to break on first error. Default concurrency computed via `getDefaultConcurrency()` formula: `clamp(cores * 5, 2, min(floor(totalMemGB * 0.5 / 0.512), 20))` allocating 50% of system memory with 512MB per subprocess budget.

### Backend Abstraction

`AIBackend` interface defines four methods: `isAvailable()` checks CLI presence via `isCommandOnPath()`, `buildArgs()` constructs subprocess argv, `parseResponse()` normalizes stdout to `AIResponse`, `getInstallInstructions()` returns platform-specific setup guide. `BackendRegistry` pre-populated with ClaudeBackend, GeminiBackend, OpenCodeBackend in detection priority order. `resolveBackend()` handles `'auto'` detection or explicit backend selection, throws `AIServiceError('CLI_NOT_FOUND')` with install instructions on unavailable CLI. `AIService.call()` wraps `runSubprocess()` with `withRetry()`, enforces timeout via SIGTERM → SIGKILL escalation, records telemetry via `TelemetryLogger.addEntry()`, emits trace events.

### Change Detection Strategy

Git-based: `getChangedFiles()` parses `git diff --name-status -M baseCommit..HEAD` with 50% rename similarity threshold, optionally appends uncommitted changes from `git.status()` (modified, deleted, not_added, staged arrays), maps status codes (`A` → added, `M` → modified, `D` → deleted, `R<percentage>` → renamed).

Hash-based: `UpdateOrchestrator.preparePlan()` reads `.sum` frontmatter via `readSumFile()`, compares stored `contentHash` against `computeContentHash()` from disk via SHA-256, classifies files as added (no .sum), modified (hash mismatch), or unchanged (hash match), calls `cleanupOrphans()` for deleted files, sorts affected directories deepest-first.

### Trace Event Schema

NDJSON events written to `.agents-reverse-engineer/traces/trace-${timestamp}.ndjson` with auto-populated fields: `seq` (monotonic counter), `ts` (ISO 8601), `pid` (Node.js process.pid), `elapsedMs` (fractional ms since run start via `process.hrtime.bigint()`). Event types: `phase:start`/`phase:end` (phase, taskCount, concurrency, durationMs, tasksCompleted, tasksFailed), `worker:start`/`worker:end` (workerId), `task:pickup`/`task:done` (taskIndex, taskLabel, activeTasks, durationMs, success, error), `subprocess:spawn`/`subprocess:exit` (childPid, command, taskLabel, exitCode, signal, durationMs, timedOut), `retry` (attempt, taskLabel, errorCode), `discovery:start`/`discovery:end`/`filter:applied`/`plan:created`/`config:loaded`.

### Quality Validation Pipeline

Runs during `executeGenerate()` and `executeUpdate()` workflows:

1. **Pre-Phase 1 (cache)**: Reads existing `.sum` files concurrently (concurrency=20) into `oldSumCache` for stale documentation detection, phase label `'pre-phase-1-cache'`
2. **Post-Phase 1 (quality)**: Groups processed files by directory, runs `checkCodeVsDoc()` (old-doc stale + new-doc omission) and `checkCodeVsCode()` per directory group with concurrency=10, phase label `'post-phase-1-quality'`, builds `InconsistencyReport`
3. **Post-Phase 2 (phantom paths)**: Reads all generated `AGENTS.md` files, runs `checkPhantomPaths()` to detect references to non-existent files, phase label `'post-phase-2-phantom'`

## Behavioral Contracts

### CLI Exit Codes

- **0**: Success (all tasks completed without failures)
- **1**: Partial failure (some files/modules failed, but at least one succeeded)
- **2**: Total failure (no files/modules processed AND failures occurred) OR CLI backend not found

### Task ID Format

- File tasks: `file:${filePath}` (e.g., `file:src/cli/index.ts`)
- Directory tasks: `dir:${dirPath}` (e.g., `dir:src/cli`)
- Root tasks: `root:CLAUDE.md`

### Subprocess Timeout Handling

SIGTERM sent at `timeoutMs`, SIGKILL escalation after `timeoutMs + SIGKILL_GRACE_MS` (5000ms). Process group kill `kill(-pid)` attempts to terminate entire subprocess tree, falls back to single process `kill(pid)`.

### Import Detection Regex

`/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` captures TypeScript/JavaScript export identifiers in group 1.

### Phantom Path Extraction Patterns

- Markdown links: `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`
- Backtick paths: `` /`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g ``
- Prose references: `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`

### Preamble Stripping Patterns

**Pattern 1 (separator)**: `'\n---\n'` within first 500 chars, returns content after separator

**Pattern 2 (bold purpose line)**: `/^[\s\S]{0,500}?(\*\*[A-Z])/` finds bold purpose line, strips preceding text if <300 chars and lacks `'##'`

### Configuration Constants

- `CONFIG_DIR = ".agents-reverse-engineer"` — configuration directory name
- `CONFIG_FILE = "config.yaml"` — configuration filename
- `CONCURRENCY_MULTIPLIER = 5` — CPU core scaling factor
- `MIN_CONCURRENCY = 2` — concurrency floor
- `MAX_CONCURRENCY = 20` — concurrency ceiling
- `SUBPROCESS_HEAP_GB = 0.512` — memory budget per subprocess
- `MEMORY_FRACTION = 0.5` — allocates 50% of system memory to subprocess pool
- `DEFAULT_MAX_FILE_SIZE = 1024 * 1024` — 1MB file size threshold
- `SIGKILL_GRACE_MS = 5000` — timeout between SIGTERM and SIGKILL
- `BUILT_CONTEXT_LIMIT = 100000` — max chars for accumulated context in rebuild
- `TRUNCATED_HEAD_LINES = 20` — lines retained when truncating old context

### Retry Configuration

`DEFAULT_RETRY_OPTIONS` provides `maxRetries: 3`, `baseDelayMs: 1000`, `maxDelayMs: 8000`, `multiplier: 2`. Exponential backoff formula: `min(baseDelayMs * multiplier^attempt, maxDelayMs) + jitter` where jitter is `Math.random() * 500`. Rate-limit errors retry up to `maxRetries`, timeout errors do not retry. `RATE_LIMIT_PATTERNS = ['rate limit', '429', 'too many requests', 'overloaded']` matched case-insensitively in stderr.

## File Relationships

- CLI commands (`src/cli/`) invoke `loadConfig()` → `discoverFiles()` → `createOrchestrator().createPlan()` → `buildExecutionPlan()` → `CommandRunner.executeGenerate()` or `CommandRunner.executeUpdate()` → `AIService.call()` → `runSubprocess()` → `writeFile()`/`writeSumFile()`/`writeAgentsMd()`
- Orchestration flow: `runner.ts` calls `runPool()` → worker pulls task → `buildFilePrompt()`/`buildDirectoryPrompt()`/`buildRootPrompt()` → `aiService.call()` → `withRetry()` → `runSubprocess()` → backend's `parseResponse()` → `writeSumFile()` → `PlanTracker.markDone()` → `ProgressReporter.onFileDone()` → `tracer.emit()`
- Quality checks: `executeGenerate()` calls `checkCodeVsDoc()` + `checkCodeVsCode()` post-phase-1 → `checkPhantomPaths()` post-phase-2 → `buildInconsistencyReport()` → `formatReportForCli()` → stderr output
- Update flow: `updateCommand()` calls `createUpdateOrchestrator().preparePlan()` → `getChangedFiles()` + `readSumFile()` + `computeContentHash()` → `cleanupOrphans()` → `getAffectedDirectories()` → `CommandRunner.executeUpdate()` → parallel file analysis → sequential directory regeneration
- Rebuild flow: `rebuildCommand()` calls `readSpecFiles()` → `partitionSpec()` → `CheckpointManager.load()` → `executeRebuild()` groups by order → `runPool()` calls `buildRebuildPrompt()` → `aiService.call()` → `parseModuleOutput()` → `writeFile()` → `checkpoint.markDone()`
- Specify flow: `specifyCommand()` calls `collectAgentsDocs()` + `collectAnnexFiles()` → `buildSpecPrompt()` → `aiService.call()` → `writeSpec()` with single-file or multi-file mode via `splitByHeadings()`