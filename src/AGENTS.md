<!-- Generated by agents-reverse-engineer -->

# src

Core TypeScript source implementing three-phase AI documentation pipeline: concurrent per-file `.sum` analysis via worker pools (Phase 1), post-order `AGENTS.md` directory aggregation (Phase 2), and platform-specific root document synthesis (Phase 3), with gitignore-aware discovery, SHA-256 incremental updates, subprocess orchestration, quality validation, and NDJSON telemetry.

## Modules

**[version.ts](./version.ts)** — `getVersion()` reads `package.json` from parent directory via ES module `import.meta.url` → `fileURLToPath()` → `dirname()` resolution, returns semantic version string (e.g., "0.4.8") or `"unknown"` fallback on ENOENT/parse errors. Consumed by `src/cli/index.ts` for `--version` flag, `hooks/are-check-update.js` for npm registry comparison.

## Subsystems

**[cli/](./cli/)** — Command routing layer parsing `process.argv` via custom `parseArgs()`, dispatching to handlers (`initCommand`, `discoverCommand`, `generateCommand`, `updateCommand`, `specifyCommand`, `cleanCommand`) with backend resolution, dry-run preview, progress logging to `.agents-reverse-engineer/progress.log`, trace emission via `--trace` flag, exit code semantics (0=success, 1=partial failure, 2=total failure/`CLI_NOT_FOUND`). Supports long-running task monitoring via `run_in_background` pattern with periodic `tail -5 progress.log` polling.

**[ai/](./ai/)** — Backend-agnostic AI service layer abstracting Claude Code, Gemini CLI, OpenCode via adapter interfaces. `AIService` spawns subprocesses via `execFile()` with resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`, `--disallowedTools Task`), implements process group killing (`kill(-pid)`) for timeout enforcement (SIGTERM at `timeoutMs`, SIGKILL escalation after 5s), exponential backoff retry on rate limits (stderr patterns: "rate limit", "429", "too many requests"), logs NDJSON telemetry to `.agents-reverse-engineer/logs/run-<timestamp>.json` with token counts/costs/durations/errors, emits `subprocess:spawn/exit` and `retry` trace events.

**[generation/](./generation/)** — Three-phase pipeline orchestration: `buildFilePrompt()` constructs per-file analysis prompts with import maps and stack context, `buildDirectoryPrompt()` aggregates child `.sum` content + subdirectory `AGENTS.md` + manifest detection (9 types: package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile) + verified path constraints from import maps, `buildRootPrompt()` injects all `AGENTS.md` via `collectAgentsDocs()` recursive traversal + root package.json metadata. Execution planner (`executor.ts`) sorts directories by depth descending for post-order traversal. Writers (`writers/`) handle YAML frontmatter with content hashes, user-authored `AGENTS.local.md` preservation, conversational preamble stripping.

**[orchestration/](./orchestration/)** — Iterator-based worker pool (`runPool()`) with shared task queue preventing over-allocation, promise-chain serialization for `GENERATION-PLAN.md` checkbox updates (`PlanTracker`), NDJSON trace emission (`TraceWriter`) with 14 event types (phase/worker/task/subprocess/retry/discovery/planning/config), streaming `ProgressReporter` with ETA calculation via moving-average completion times (sliding window size=10), file-backed `ProgressLog` mirroring console to `.agents-reverse-engineer/progress.log` via ANSI stripping + truncate-mode FileHandle. `CommandRunner` integrates three-phase execution with quality validators, telemetry aggregation, `RunSummary` construction.

**[discovery/](./discovery/)** — Gitignore-aware file walker with composable filter chain: `IgnoreFilter` (parsing via `ignore` library), `BinaryFilter` (extension + content analysis with 1MB threshold), `VendorFilter` (18 default patterns: node_modules/.git/dist/build/target/vendor/pkg/.tox/.gradle/.terraform/bower_components/venv/env/.venv/.env/.cache/.pytest_cache/.mypy_cache/.ruff_cache), `CustomFilter` (user glob patterns from config). `discoverFiles()` returns `DiscoveryResult` with `includedFiles`, `excludedFiles`, `totalScanned`, emits `discovery:start/end` and `filter:applied` trace events. Exports `createFileIterator()` for lazy traversal, `isKnownBinaryExtension()` predicate (26 extensions: png/jpg/gif/pdf/zip/tar/etc).

**[change-detection/](./change-detection/)** — Git diff parsing via `git diff --name-status -M` with rename detection (50% similarity threshold), SHA-256 content hashing via `computeContentHash()` for non-git workflows, `FileChange` objects with status `added`/`modified`/`deleted`/`renamed`. `detectChanges()` optionally merges uncommitted via `--uncommitted` flag (staged + working tree via `git status --porcelain`). `getAffectedDirectories()` walks parent paths from changed file set. Used by `src/update/orchestrator.ts` for incremental regeneration.

**[quality/](./quality/)** — Post-generation validators: `checkCodeVsDoc()` (regex-based export extraction via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, substring search in `.sum` text), `checkCodeVsCode()` (duplicate symbol detection across per-directory file groups), `checkPhantomPaths()` (path extraction via three regex patterns: markdown links, backtick-quoted paths, prose-embedded paths; resolution via `existsSync()` with `.ts`/`.js` fallback). Constructs `InconsistencyReport` discriminated union with metadata (timestamp/projectRoot/filesChecked/durationMs), issues array (CodeDocInconsistency/CodeCodeInconsistency/PhantomPathInconsistency), summary counts by type/severity. Non-throwing design prevents pipeline breakage.

**[update/](./update/)** — Incremental workflow orchestrator: reads `content_hash` from `.sum` YAML frontmatter, computes current SHA-256 via `computeContentHash()`, hash mismatch → add to `filesToAnalyze` as `FileChange`, hash match → add to `filesToSkip`, detect orphans via `.sum` files for deleted sources, call `cleanupOrphans()` + `cleanupEmptyDirectoryDocs()` removing stale artifacts, compute `affectedDirs` via `getAffectedDirectories()`, regenerate `.sum` for `filesToAnalyze` via Phase 1 pool, sequentially regenerate `AGENTS.md` for `affectedDirs` without post-order traversal. Supports `--uncommitted` flag merging working tree changes.

**[config/](./config/)** — YAML config loading with Zod validation (`schema.ts`): exclude patterns (gitignore-style globs), vendorDirs (18 defaults), binaryExtensions (26 types), options (followSymlinks/maxFileSize), output (colors), ai (backend/model/timeoutMs/maxRetries/concurrency/telemetry/pricing). Environment overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`. Detects WSL via `/proc/version` "microsoft" substring, adjusts default concurrency (2 for WSL, 5 elsewhere). Exports `loadConfig()`, `configExists()`, `writeDefaultConfig()`, `Config` type.

**[imports/](./imports/)** — Static import analysis extracting dependency graphs for `AGENTS.md` "Import Map" sections. `extractFileImports()` reads source via `readFile()`, applies regex `/(?:import|export)\s+.*?from\s+['"](\.\.?\/[^'"]+)['"]/g` extracting relative specifiers, resolves via `path.resolve()` checking extension fallbacks (.ts/.js), returns `Map<string, ImportInfo[]>` with `specifier`/`resolvedPath`. `extractDirectoryImports()` aggregates per-directory via file grouping, deduplicates via `Set<string>`, filters paths via `isWithinKnownDirs()` predicate verifying presence in directory plan tasks. Used by `buildDirectoryPrompt()` for verified path constraints.

**[types/](./types/)** — Shared interfaces for discovery results. `DiscoveredFile` carries `path` (absolute) + `type` ('file') + `relativePath` (project-relative), `DiscoveryResult` aggregates `includedFiles`/`excludedFiles`/`totalScanned`. Used by `discoverFiles()` return type, consumed by execution planner for task generation.

**[output/](./output/)** — Terminal logging utilities with picocolors formatting. Exports `logger` singleton with methods: `info()` (white), `success()` (green), `warning()` (yellow), `error()` (red), `file()` (cyan), `excluded()` (dim gray), `highlight()` (bold), `code()` (magenta). Consumed by CLI commands for user-facing messages.

**[installer/](./installer/)** — npx orchestration copying ARE command templates and session lifecycle hooks to runtime-specific directories (`.claude`, `.opencode`, `.gemini`) with interactive prompts (arrow-key TTY selection via raw mode + ANSI cursor control or numbered non-TTY fallback), environment-aware path resolution (`CLAUDE_CONFIG_DIR`/`OPENCODE_CONFIG_DIR`/`GEMINI_CONFIG_DIR` overrides), settings.json hook registration (Claude: `hooks: { SessionStart: HookEvent[], SessionEnd: HookEvent[] }`, Gemini: flatter `hooks: { SessionStart: GeminiHook[], SessionEnd: GeminiHook[] }`), bash command auto-approval (7 patterns: `npx agents-reverse-engineer@latest <cmd>`, `tail -5/.agents-reverse-engineer/progress.log`, `rm -f/.agents-reverse-engineer/progress.log`), reversible uninstallation via hook filtering + empty directory cleanup + legacy format deletion, ARE-VERSION tracking file. Template sources: `src/integration/templates.ts`, bundled hooks: `hooks/dist/` populated by `npm run build:hooks`.

**[integration/](./integration/)** — Platform-specific template generation for Claude Code (`.claude/skills/<name>/SKILL.md` with frontmatter: `name: /<command>`), OpenCode (`.opencode/commands/<name>.md` with frontmatter: `agent: build`), Gemini (`.gemini/commands/<name>.toml` with `description`/`prompt` triple-quoted multiline), Aider (detection-only via `.aider.conf.yml` or `.aider/` directory). Exports `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` returning `TemplateFile[]` with `path`/`content`/`description` for installer consumption. Long-running pattern: remove stale `progress.log`, run with `run_in_background: true`, poll via `tail -5` every 10-15s, check `TaskOutput` with `block: false`, summarize on completion.

**[specify/](./specify/)** — Project specification synthesis from `AGENTS.md` corpus. `buildSpecPrompt()` constructs prompts injecting all `AGENTS.md` via `collectAgentsDocs()` recursive tree traversal, root package.json metadata, synthesis-only constraints (no invention of features/hooks/patterns not in source documents). `writeSpec()` writes single-file output to `specs/SPEC.md` or multi-file split to `specs/<dirname>.md` with overwrite protection throwing `SpecExistsError`. Extends timeout to minimum 10 minutes via `Math.max(config.ai.timeoutMs, 600_000)` for large codebases.

## Architecture Patterns

**Three-Phase Pipeline:** Phase 1 (concurrent file analysis via iterator pool → `.sum` YAML frontmatter with content hashes), Phase 2 (post-order directory aggregation via depth-level batching → `AGENTS.md` with child injection), Phase 3 (sequential root synthesis → `CLAUDE.md`/`GEMINI.md`/`OPENCODE.md` with preamble stripping).

**Iterator-Based Pool:** `runPool()` shares single `tasks.entries()` iterator across N workers, each task executes exactly once, immediate next-task pickup upon completion avoids batch-chunking idle time. Uses `aborted` flag checked before iterator pull for fail-fast behavior.

**Promise-Chain Serialization:** `PlanTracker`, `TraceWriter`, `ProgressLog` use `this.writeQueue = this.writeQueue.then(() => writeFile(...))` pattern ensuring sequential execution despite concurrent pool worker completions, preventing file corruption.

**Backend Abstraction:** `AIService` interface with runtime adapters (ClaudeCodeBackend/GeminiBackend/OpenCodeBackend), `createBackendRegistry()` auto-detection trying executables sequentially, `resolveBackend()` catches `CLI_NOT_FOUND` providing installation instructions.

**Subprocess Resource Management:** Claude CLI mitigation for thread exhaustion (GitHub #5771): `NODE_OPTIONS='--max-old-space-size=512'` (512MB heap limit), `UV_THREADPOOL_SIZE='4'` (4 libuv threads), `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` (no background tasks), `--disallowedTools Task` (no subagents), process group killing (`kill(-pid)`), default concurrency 2 for WSL vs. 5 elsewhere.

**Quality Validation:** Non-throwing post-analysis checks via throttled pool (concurrency=10): code-vs-doc (regex export extraction + substring search), code-vs-code (duplicate symbol detection), phantom paths (regex extraction + `existsSync()` resolution). Constructs `InconsistencyReport` discriminated union logged but not pipeline-breaking.

**Telemetry:** NDJSON run logs (`.agents-reverse-engineer/logs/run-<timestamp>.json`) with per-call token counts/costs/durations/errors, retention via `cleanupOldLogs(keepCount=50)`. NDJSON trace events (`.agents-reverse-engineer/traces/trace-<timestamp>.ndjson`) with 14 event types, auto-populated base fields (seq/ts/pid/elapsedMs), retention via `cleanupOldTraces(keepCount=500)`.

**Incremental Updates:** SHA-256 content hashing comparing `.sum` frontmatter `content_hash` against current file content, hash mismatch → add to `filesToAnalyze`, hash match → skip, orphan detection via `.sum` without source file, `cleanupOrphans()` + `cleanupEmptyDirectoryDocs()` removing stale artifacts, `affectedDirs` computation via parent path walking, Phase 1 re-execution + directory-level `AGENTS.md` regeneration without full post-order traversal.