<!-- Generated by agents-reverse-engineer -->

# src

Root source directory for agents-reverse-engineer (ARE) CLI tool. Implements AI-driven codebase documentation generation via three-phase pipeline: file analysis (concurrent `.sum` generation), directory synthesis (post-order `AGENTS.md` assembly), and root document creation (`CLAUDE.md` pointer files). Orchestrates subprocess-based AI CLI interaction, iterator-based concurrency pooling, git-based change detection, and multi-platform integration (Claude Code, OpenCode, Gemini CLI).

## Contents

### [version.ts](./version.ts)
`getVersion()` reads `../package.json` version field via `readFileSync()` from ESM `import.meta.url` + `fileURLToPath()` resolution, returns `'unknown'` on any error (ENOENT, parse failure, missing field)

## Subdirectories

### [ai/](./ai/)
Subprocess-based AI service layer: `AIService` orchestrates CLI calls via `runSubprocess()` (timeout enforcement with SIGTERM→SIGKILL escalation), `withRetry()` (exponential backoff for rate limits), backend abstraction (`ClaudeBackend`, `GeminiBackend` stub, `OpenCodeBackend` stub), `BackendRegistry` auto-detection, NDJSON telemetry logging to `.agents-reverse-engineer/logs/run-*.json`, trace event emission (`subprocess:spawn/exit`, `retry`), subprocess log serialization, active subprocess tracking via PID map

### [change-detection/](./change-detection/)
Git-based incremental update: `getChangedFiles()` parses `git diff --name-status -M` with rename detection (-M 50% similarity threshold), maps status codes (`A`/`M`/`D`/`R*`) to `ChangeType` union, `computeContentHash()` generates SHA-256 fingerprints for content comparison against `.sum` frontmatter, `isGitRepo()`/`getCurrentCommit()` provide repository state queries

### [cli/](./cli/)
Command entry point and implementations: `main()` parses argv via `parseArgs()` and routes to command modules (init, discover, generate, update, clean, specify, rebuild), handles `--help`/`--version`, installer flag detection, unknown command errors. Commands follow shared patterns: AI backend resolution via `resolveBackend()`, `AIService` instantiation with `effectiveModel` (CLI flag > config), `CommandRunner` execution with concurrency/failFast, telemetry finalization, exit codes (0 success, 1 partial failure, 2 total failure/CLI not found)

### [config/](./config/)
Configuration schema and loader: `ConfigSchema` (exclude/options/output/AI sections) validated via Zod, `loadConfig()` reads `.agents-reverse-engineer/config.yaml` with YAML parsing, returns defaults on ENOENT, throws `ConfigError` on parse/validation failures, emits `config:loaded` trace event. `getDefaultConcurrency()` clamps parallelism between `MIN_CONCURRENCY` (2) and memory capacity (`Math.floor((totalMemGB * 0.5) / 0.512)` to prevent WSL subprocess RAM exhaustion), `DEFAULT_VENDOR_DIRS` (20 directories), `DEFAULT_BINARY_EXTENSIONS` (images/archives/executables), `DEFAULT_EXCLUDE_PATTERNS` (lock files, dotfiles, AI docs)

### [discovery/](./discovery/)
File discovery pipeline: `discoverFiles()` orchestrates `walkDirectory()` (fast-glob `**/*` traversal with `.git` exclusion) and four-filter chain (gitignore, vendor, binary, custom) via `applyFilters()` with short-circuit evaluation and iterator-based pool (concurrency=30). Returns `FilterResult` with `included: string[]` and `excluded: ExcludedFile[]` (path/reason/filter attribution). Vendor filter uses substring matching, binary filter combines extension fast-path + size threshold + `isBinaryFile()` content analysis, custom filter applies user patterns via `ignore` library

### [generation/](./generation/)
Three-phase documentation pipeline: `GenerationOrchestrator.createPlan()` invokes `prepareFiles()` (file content loading) and `analyzeComplexity()` (structural metrics), builds `AnalysisTask[]` via `createFileTasks()`/`createDirectoryTasks()`, emits `phase:start`/`plan:created`/`phase:end` trace events. `buildExecutionPlan()` assigns task IDs (`file:${path}`, `dir:${path}`), sorts by depth descending for post-order traversal, sets `dependencies` arrays on directory tasks. [prompts/](./generation/prompts/) constructs AI prompts via `buildFilePrompt()`/`buildDirectoryPrompt()` replacing `{{PLACEHOLDER}}` tokens in templates, injects import maps via `extractDirectoryImports()`, existing summaries via `readSumFile()`, switches to incremental update templates when `existingSum`/`existingAgentsMd` present. [writers/](./generation/writers/) implements three-tier output: `writeSumFile()` (YAML frontmatter with `generated_at`, `content_hash`, `purpose`), `writeAgentsMd()` (`GENERATED_MARKER` prefix, `.local.md` preservation), `writeClaudeMdPointer()` (`@AGENTS.md` import chain)

### [imports/](./imports/)
Import statement extraction: `extractImports()` parses source via `IMPORT_REGEX` capturing named/default/namespace/type imports, `extractDirectoryImports()` batch-processes files (first 100 lines only for performance), classifies relative imports as internal (`./`) or external (`../`), `formatImportMap()` serializes to indented prompt format. Consumed by `generation/prompts/builder.ts` for LLM context injection

### [installer/](./installer/)
npx installation workflow: `runInstaller()` handles flag parsing (`--runtime`, `-g/-l`, `--force`, `-q`, `-u`), routes to `runInstall()`/`runUninstall()`, delegates to `installFiles()` (writes command templates to `commands/` subdirs), `registerHooks()` (adds SessionStart/SessionEnd entries to `settings.json` via JSONC-aware `jsonc-parser`), `registerPermissions()` (merges `ARE_PERMISSIONS` bash patterns into `permissions.allow`), `verifyInstallation()`. Supports Claude Code (`.claude/`), OpenCode (`.opencode/plugins/`), Gemini CLI (`.gemini/`) with runtime-specific cleanup (`cleanupAreSkillDirs()`, `cleanupLegacyGeminiFiles()`). Interactive TTY mode uses `arrowKeySelect()` with ANSI escape sequences, non-interactive CI mode enforces required flags

### [integration/](./integration/)
Multi-platform AI assistant integration: `detectEnvironments()` scans for `.claude/`, `.opencode/`, `.gemini/`, `.aider/` artifacts, `generateIntegrationFiles()` writes command templates with skip-if-exists semantics, `getTemplatesForRuntime()` maps `EnvironmentType` → platform-specific template generators producing SKILL.md frontmatter (Claude), agent-annotated markdown (OpenCode), TOML documents (Gemini). Embeds eight ARE commands (`generate`, `update`, `init`, `discover`, `clean`, `specify`, `rebuild`, `help`) with `<execution>` blocks and placeholder substitution

### [orchestration/](./orchestration/)
Concurrency and tracing: `runPool()` executes task factories via shared-iterator worker pattern with bounded parallelism, `CommandRunner` orchestrates two-phase generation pipeline via `executeGenerate()` (pre-cache old `.sum` files, Phase 1 file analysis, post-phase-1 quality checks `checkCodeVsDoc`/`checkCodeVsCode`, Phase 2 post-order directory AGENTS.md grouped by depth, phantom path validation `checkPhantomPaths`) and `executeUpdate()` (Phase 1 only with incremental context). `ITraceWriter` interface with `emit()`/`finalize()`, `createTraceWriter()` returns `NullTraceWriter` (zero overhead) or `TraceWriter` (NDJSON to `.agents-reverse-engineer/traces/trace-{ISO}.ndjson`). `TraceEvent` discriminated union includes `phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`, `discovery:start/end`, `filter:applied`, `plan:created`, `config:loaded`. `ProgressReporter` emits one-line-per-event colored console output with ETA from sliding window (last 10 completion times), `ProgressLog` mirrors to `.agents-reverse-engineer/progress.log` via promise-chain serialization for `tail -f` monitoring. `PlanTracker` serializes concurrent checkbox updates to `GENERATION-PLAN.md` via writeQueue promise chain

### [output/](./output/)
Terminal output formatting: `createLogger(options: LoggerOptions)` produces `Logger` instances with color-controlled console output (`info`, `file`, `excluded`, `summary`, `warn`, `error` methods), `createSilentLogger()` for test/programmatic contexts. Color control via `LoggerOptions.colors` binds `ColorFunctions` to picocolors or identity functions

### [quality/](./quality/)
Post-generation validation: `extractExports()` parses source files via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, `checkCodeVsDoc()` compares against `SumFileContent.summary` text for drift detection, `checkCodeVsCode()` builds per-directory export maps to detect duplicate symbols, `checkPhantomPaths()` validates AGENTS.md file references against filesystem via `existsSync()`. `buildInconsistencyReport()` aggregates `Inconsistency[]` by type/severity, `formatReportForCli()` renders plain-text output. [density/](./quality/density/) validates exported symbol presence in parent AGENTS.md (currently stubbed), [inconsistency/](./quality/inconsistency/) implements regex export extraction and substring matching, [phantom-paths/](./quality/phantom-paths/) scans markdown links via `PATH_PATTERNS` regexes

### [rebuild/](./rebuild/)
Specification-driven code reconstruction: `executeRebuild()` sequences spec reading, checkpoint loading, order-based unit grouping, concurrent pool execution with context accumulation. `CheckpointManager` persists per-module completion status and spec file hashes to `{outputDir}/.rebuild-checkpoint` with thread-safe write serialization, drift detection via `computeContentHashFromString()` hash comparison. `readSpecFiles()` loads `.md` files from `specs/`, `partitionSpec()` extracts `RebuildUnit[]` via `extractFromBuildPlan()` (parses `### Phase N:` subsections) or `extractFromTopLevelHeadings()` fallback, implements Change 2 format detection via `/^\*\*Defines:\*\*|^Defines:/m` pattern. `parseModuleOutput()` extracts file paths/contents via delimiter primary format (`===FILE:`, `===END_FILE===` line-anchored) and fenced block fallback (`` ```typescript:path ``). Dependency-aware execution: units with same `order` run concurrently, generated source files read into `builtContext` after each group, context truncation at 100K chars via `/\n\/\/ === /` delimiter splitting

### [specify/](./specify/)
Reverse-engineering project specifications from AGENTS.md: `buildSpecPrompt()` constructs AI prompts from `AgentsDocs` arrays collected by `src/generation/collector.ts`, formats with section headers, appends mandatory 12-section output requirements. `writeSpec()` implements `multiFile` toggle, `splitByHeadings()` partitions on `/^(?=# )/m` regex, `slugify()` derives filenames via lowercase → replace `\s+` with `-` → strip `[^a-z0-9-]` → collapse `-+` → trim. `SpecExistsError` thrown when `force=false` and conflicts detected. `SPEC_SYSTEM_PROMPT` enforces anti-mirroring rule (no directory names as section headings), Build Plan cross-reference (every API Surface symbol must appear in exactly one phase's `Defines:` list), verbatim reproduction of annex content (no summarization/paraphrase), regex preservation in Behavioral Contracts

### [types/](./types/)
Core interfaces: `ExcludedFile` (path + reason), `DiscoveryResult` (files array + excluded array), `DiscoveryStats` (totalFiles, includedFiles, excludedFiles, exclusionReasons map). Consumed by `src/cli/discover.ts` for CLI output formatting, `src/discovery/run.ts` for file traversal results

### [update/](./update/)
Incremental documentation regeneration: `UpdateOrchestrator.preparePlan()` compares `computeContentHash()` output against `contentHash` stored in `.sum` file frontmatter via `readSumFile()`, classifies files into `filesToAnalyze` (hash mismatch or missing .sum), `filesToSkip` (hash match), and cleanup (orphaned .sum files from deleted sources). `cleanupOrphans()` removes .sum/.annex.sum files for deleted/renamed sources via `deleteIfExists()`, `cleanupEmptyDirectoryDocs()` removes AGENTS.md from directories with no remaining source files (filtering hidden files, .sum files, `GENERATED_FILES` Set). `getAffectedDirectories()` walks parent directories via `path.dirname()` loop, returns sorted `affectedDirs` (deepest-first) for AGENTS.md regeneration

## Architecture

**Three-Phase Documentation Pipeline:**
1. File analysis phase (`fileTasks`) — parallel workers process source files via `AIService`, generate `.sum` files via `writeSumFile()`, tasks independent (no dependencies array)
2. Directory synthesis phase (`directoryTasks`) — post-order traversal processes directories after children, reads child `.sum` files via `readSumFile()`, generates AGENTS.md via `writeAgentsMd()`, dependencies array contains child file task IDs
3. Root assembly phase — sequential execution writes CLAUDE.md via `writeClaudeMdPointer()`, imports AGENTS.md tree, preserves user content

**Dependency ordering:** `ExecutionPlan.tasks` array preserves execution sequence by sorting file tasks by depth descending (deepest files first), directory tasks by depth descending (deepest directories first), guaranteeing child completion before parent processing. `ExecutionTask.dependencies` arrays encode child-parent relationships checked by `src/orchestration/runner.ts` before task execution.

**AI Backend Abstraction:** `AIBackend` interface (`name`, `cliCommand`, `isAvailable`, `buildArgs`, `parseResponse`, `getInstallInstructions`) implemented by `ClaudeBackend` (JSON/NDJSON parsing, Zod validation via `ClaudeResponseSchema`), `GeminiBackend` stub, `OpenCodeBackend` stub. `BackendRegistry` stores instances in insertion-order Map, `detectBackend()` iterates calling `backend.isAvailable()`, `resolveBackend()` handles `'auto'` mode or explicit backend name, throws `AIServiceError` with code `CLI_NOT_FOUND` and formatted install instructions if unavailable.

**Subprocess Management:** `runSubprocess()` spawns CLI child processes via `execFile()`, enforces timeout with SIGTERM→SIGKILL escalation after `SIGKILL_GRACE_MS` (5000ms), pipes stdin with EOF signaling, tracks active subprocesses in Map for `getActiveSubprocessCount()`, invokes `onSpawn(pid)` callback for trace emission, resolves with `SubprocessResult` including childPid, never rejects. `withRetry()` applies exponential backoff with jitter: `min(baseDelayMs * multiplier^attempt, maxDelayMs) + Math.random() * 500`, throws immediately if `isRetryable(error)` returns false, calls `onRetry(attempt, error)` before each retry.

**Iterator-Based Concurrency:** `runPool()` creates effectiveConcurrency workers (capped at `Math.min(concurrency, tasks.length)`) pulling from `tasks.entries()` iterator. Workers immediately fetch next task after completing current task, preventing batch idling. `aborted` flag enables fail-fast: workers check before pulling next task, exit early on first failure when `failFast` is true.

**Trace Event Propagation:** `ITraceWriter` threaded through `CommandRunOptions.tracer` → pool workers (`task:pickup/done`, `worker:start/end`, activeTasks snapshot) → `AIService` (`subprocess:spawn/exit`, `retry`) → runner (`phase:start/end`). `TraceEventBase` auto-populates `seq` (monotonic), `ts` (ISO 8601), `pid` (parent process), `elapsedMs` (high-resolution via `process.hrtime.bigint()` / 1_000_000). Promise-chain serialization pattern prevents concurrent write corruption.

**Quality Validation:** Post-phase-1 checks (`checkCodeVsDoc`, `checkCodeVsCode`) detect code-vs-doc drift and duplicate exports, post-phase-2 check (`checkPhantomPaths`) validates AGENTS.md file references, all return `Inconsistency[]` aggregated into `InconsistencyReport` via `buildInconsistencyReport()`, printed via `formatReportForCli()`.

## Behavioral Contracts

**Exit Codes (CLI commands):**
- **0**: Success (all tasks completed or no tasks to process)
- **1**: Partial failure (`filesProcessed > 0 && filesFailed > 0` or conflict detection)
- **2**: Total failure (`filesProcessed === 0 && filesFailed > 0`) or CLI not found (`AIServiceError` with `code === 'CLI_NOT_FOUND'`)

**Rate Limit Patterns (ai/service.ts):**
`['rate limit', '429', 'too many requests', 'overloaded']` (case-insensitive stderr matching)

**SIGKILL Grace Period (ai/subprocess.ts):**
`SIGKILL_GRACE_MS = 5000` (milliseconds after SIGTERM before force-kill)

**Exponential Backoff Formula (ai/retry.ts):**
`min(baseDelayMs * multiplier^attempt, maxDelayMs) + jitter` where `jitter ∈ [0, 500]` ms

**Concurrency Formula (config/defaults.ts):**
```javascript
memCap = Math.floor((os.totalmem() / (1024 ** 3) * 0.5) / 0.512)
concurrency = Math.min(
  MAX_CONCURRENCY,  // 20
  memCap,
  Math.max(
    MIN_CONCURRENCY,  // 2
    os.availableParallelism() * 5  // CONCURRENCY_MULTIPLIER
  )
)
```

**Import Parsing Regex (imports/extractor.ts):**
`/^import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm`

**Export Parsing Regex (quality/inconsistency/code-vs-doc.ts):**
`/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`

**Phantom Path Patterns (quality/phantom-paths/validator.ts):**
- Markdown links: `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`
- Backtick paths: `` /`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g ``
- Prose refs: `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`

**Task ID Format (generation/executor.ts):**
`file:${relativePath}` for file analysis tasks, `dir:${relativePath}` for directory synthesis tasks

**Skip Directory Set (generation/orchestrator.ts):**
`['node_modules', '.git', '.agents-reverse-engineer', 'vendor', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target', '.cargo', '.gradle']`

**Generated File Marker (generation/writers/agents-md.ts):**
`<!-- Generated by agents-reverse-engineer -->`

**Delimiter Format (rebuild/output-parser.ts):**
```
===FILE: path/to/file.ext===
[content]
===END_FILE===
```

**Change 2 Format Detection (rebuild/spec-reader.ts):**
`/^\*\*Defines:\*\*|^Defines:/m`

## File Relationships

`src/cli/index.ts` parses argv and routes to command modules (`generate.ts`, `update.ts`, `init.ts`, `discover.ts`, `clean.ts`, `specify.ts`, `rebuild.ts`). Commands instantiate `AIService` via `resolveBackend()` from `src/ai/registry.ts`, configure `CommandRunner` from `src/orchestration/runner.ts`, and call `executeGenerate()`/`executeUpdate()`. `GenerationOrchestrator` from `src/generation/orchestrator.ts` creates `ExecutionPlan` via `buildExecutionPlan()` from `src/generation/executor.ts`, runner executes tasks via `runPool()` from `src/orchestration/pool.ts`, calling `AIService.call()` which invokes `runSubprocess()` from `src/ai/subprocess.ts` wrapped in `withRetry()` from `src/ai/retry.ts`. File analysis uses `buildFilePrompt()` from `src/generation/prompts/builder.ts` with import maps from `extractDirectoryImports()` in `src/imports/extractor.ts`, directory synthesis uses `buildDirectoryPrompt()` reading `.sum` files via `readSumFile()` from `src/generation/writers/sum.ts`. Update workflow uses `UpdateOrchestrator` from `src/update/orchestrator.ts` comparing content hashes via `computeContentHash()` from `src/change-detection/detector.ts`. Discovery phase calls `discoverFiles()` from `src/discovery/run.ts` applying filter chain from `src/discovery/filters/`. Configuration loaded via `loadConfig()` from `src/config/loader.ts`, validating against `ConfigSchema` from `src/config/schema.ts`. Telemetry written via `TelemetryLogger` from `src/ai/telemetry/logger.ts`, trace events emitted via `ITraceWriter` from `src/orchestration/trace.ts`. Quality checks (`checkCodeVsDoc`, `checkCodeVsCode`, `checkPhantomPaths`) from `src/quality/` aggregated into `InconsistencyReport`. Installer workflow from `src/installer/index.ts` writes templates from `src/integration/templates.ts` via `installFiles()` in `src/installer/operations.ts`. Rebuild workflow from `src/rebuild/orchestrator.ts` reads specs via `readSpecFiles()` from `src/rebuild/spec-reader.ts`, parses output via `parseModuleOutput()` from `src/rebuild/output-parser.ts`, manages checkpoints via `CheckpointManager` from `src/rebuild/checkpoint.ts`. Version extracted via `getVersion()` from `src/version.ts`.