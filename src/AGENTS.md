<!-- Generated by agents-reverse-engineer -->

# src

Core source tree implementing two-phase recursive documentation pipeline: parallel file `.sum` generation via `generation/orchestrator.ts` (spawns AI subprocesses through `ai/service.ts`, writes YAML-frontmatter summaries) followed by post-order directory `AGENTS.md` aggregation (reads child `.sum` files, sorts by depth descending), with CLI command routing (`cli/index.ts`), four-filter discovery chain (`discovery/`), frontmatter-based incremental updates (`update/`), code-vs-doc quality validation (`quality/`), session hooks installation (`installer/`), and AI-driven project reconstruction (`rebuild/`).

## Contents

**[version.ts](./version.ts)** — `getVersion()` reads package version from package.json at runtime using `fileURLToPath(import.meta.url)` → `join(__dirname, '..', 'package.json')` → `readFileSync()` → `JSON.parse()` → `packageJson.version`, returns `"unknown"` on failure. Supports `--version` flag in `cli/index.ts`.

## Subdirectories

**[ai/](./ai/)** — AI service layer implementing backend-agnostic subprocess orchestration with exponential backoff retry, timeout enforcement (SIGTERM→SIGKILL escalation), telemetry recording (per-call tokens/latency/cost), and registry-based runtime selection for Claude/Gemini/OpenCode CLI backends.

**[change-detection/](./change-detection/)** — Git-based staleness detection: `computeContentHash()` generates SHA-256 hex digests for `.sum` frontmatter comparison, `getChangedFiles()` parses `git diff --name-status -M` (rename detection) + `git.status()` (uncommitted changes), returns `FileChange[]` with `status` (`'added'|'modified'|'deleted'|'renamed'`) and optional `oldPath`.

**[cli/](./cli/)** — CLI command handlers for agents-reverse-engineer: init, discover, generate, update, specify, rebuild, and clean operations, with argument parsing, backend resolution, and progress tracking.

**[config/](./config/)** — Configuration system for agents-reverse-engineer: Zod schema validation (`ConfigSchema`), YAML loading with defaults (`loadConfig()`), project root discovery (`findProjectRoot()`), and dynamic concurrency calculation via `getDefaultConcurrency()`.

**[core/](./core/)** — Programmatic API surface: re-exports `discoverFiles()`, `buildFilePrompt()`, `buildDirectoryPrompt()`, `writeSumFile()`, `writeAgentsMd()`, `GenerationOrchestrator`, `UpdateOrchestrator`, `runPool()`, `checkCodeVsDoc()`, `checkPhantomPaths()`, `loadConfig()`, `AIService`, plus 40+ interface types. Status: `@beta` until v1.0.0. Accepts dependency-injected `Logger` (defaults to `nullLogger` for silent library operation).

**[discovery/](./discovery/)** — Four-filter discovery pipeline (`gitignore`, `vendor`, `binary`, `custom`) with `walkDirectory()` traversal, `applyFilters()` concurrent chain execution, and `discoverFiles()` orchestration returning `FilterResult` with included files + exclusion attribution.

**[generation/](./generation/)** — Two-phase documentation pipeline orchestrator: Phase 1 (parallel file `.sum` generation via `GenerationOrchestrator.createFileTasks()` → `buildFilePrompt()` → `AIService.call()` → `writeSumFile()` with SHA-256 `content_hash` frontmatter), Phase 2 (post-order directory `AGENTS.md` aggregation via `createDirectoryTasks()` → dirty-propagation filtering → `buildDirectoryPrompt()` → `writeAgentsMd()` → root `writeClaudeMdPointer()`).

**[imports/](./imports/)** — TypeScript/JavaScript import extraction: `extractImports()` parses single-file imports via regex, `extractDirectoryImports()` runs parallel analysis (reads first 100 lines per file, filters bare specifiers, classifies internal/external via `./` vs `../` prefix), `formatImportMap()` serializes dependency maps for LLM prompt injection during `.sum` generation.

**[installer/](./installer/)** — Interactive installation wizard: `runInstaller()` orchestrates runtime selection (Claude Code/OpenCode/Gemini), location selection (global/local), file templating (`installFiles()` writes command templates + hooks), hook registration (manipulates `settings.json` via jsonc-parser `modify()` + `applyEdits()`), verification (`verifyInstallation()` checks file existence), banner display (`displayBanner()`, `showNextSteps()`). Uninstaller: `uninstallFiles()`, `unregisterHooks()`, `deleteConfigFolder()`, `cleanupEmptyDirs()`.

**[integration/](./integration/)** — Detects AI coding assistant environments (Claude Code, OpenCode, Gemini CLI, Aider) and generates platform-specific command templates with hooks for integrating agents-reverse-engineer workflows.

**[orchestration/](./orchestration/)** — Iterator-based concurrency engine for two-phase AI documentation generation: parallel file analysis via shared-iterator worker pool (`pool.ts` `runPool()`), post-order directory aggregation sorted by depth descending (`runner.ts` `dirsByDepth`), promise-chain serialized progress tracking (`plan-tracker.ts` `PlanTracker`, `progress.ts` `ProgressLog`), and append-only NDJSON trace emission for subprocess/worker/task lifecycle debugging (`trace.ts` `TraceWriter`).

**[output/](./output/)** — Terminal output abstraction: `createLogger()` factory wraps `picocolors` for colored CLI output (`file()`, `excluded()`, `summary()`, `warn()`, `error()`, `info()`), `createSilentLogger()` returns no-op implementation for library usage. `LoggerOptions.colors` controls formatting.

**[quality/](./quality/)** — Quality assurance subsystem detecting documentation drift, duplicate exports, non-existent path references, and identifier density gaps through syntactic analysis and filesystem validation.

**[rebuild/](./rebuild/)** — Project reconstruction pipeline: `readSpecFiles()` loads `.agents-reverse-engineer/specs/*.md`, `partitionSpec()` extracts `RebuildUnit[]` via `## Build Plan` → `### Phase N:` parsing (targeted context injection via `Defines:`/`Consumes:` symbol matching) or top-level `## ` heading fallback. `executeRebuild()` processes phase-ordered groups (concurrent tasks within group via `runPool`, sequential phase execution), accumulates `builtContext` from prior phases (truncates at 100K chars), persists completion state via `CheckpointManager` promise-chain serialization. `parseModuleOutput()` extracts files from AI responses via delimiter format (`===FILE: path===`) or fenced blocks.

**[specify/](./specify/)** — Reverse specification synthesis: `buildSpecPrompt()` constructs 12-section template (Project Overview, Architecture, Public API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts, Test Contracts, Build Plan with Defines:/Consumes: cross-references, Prompt Templates, IDE Integration, File Manifest), injects AGENTS.md hierarchy with section delimiters, optional annex files. `writeSpec()` writes to `specs/SPEC.md` (single-file) or `specs/*.md` (multi-file via heading split), throws `SpecExistsError` when files exist without `--force`.

**[types/](./types/)** — Shared discovery type definitions: `DiscoveryResult` (`files`, `excluded`), `ExcludedFile` (`path`, `reason`), `DiscoveryStats` (`totalFiles`, `includedFiles`, `excludedFiles`, `exclusionReasons` map). Consumed by `discovery/walker.ts`, `discovery/run.ts`, `cli/discover.ts`.

**[update/](./update/)** — Incremental documentation maintenance via content-hash-based staleness detection: compares SHA-256 digests from `.sum` YAML frontmatter against current file hashes, orchestrates selective regeneration of changed files + parent `AGENTS.md`, and prunes orphaned artifacts from deleted/renamed sources.

## Architecture

### Two-Phase Pipeline Flow

**Phase 1 (File Analysis)**: `generation/orchestrator.ts` `createFileTasks()` constructs `GenerationTask[]` with `buildFilePrompt()` (injects import maps, project structure, existing `.sum` for update mode), executes via `orchestration/pool.ts` `runPool()` with configured concurrency, spawns AI subprocesses via `ai/subprocess.ts` `runSubprocess()` (SIGTERM at timeout, SIGKILL at timeout+5s), writes `.sum` files via `generation/writers/sum.ts` `writeSumFile()` with YAML frontmatter (`file_type`, `generated_at`, `content_hash`).

**Phase 2 (Directory Aggregation)**: `createDirectoryTasks()` groups files by `path.dirname()`, sorts by depth descending (`getDirectoryDepth(dirB) - getDirectoryDepth(dirA)`), filters via `isDirectoryComplete()` checking all child `.sum` exist, executes depth-grouped sequential batches with concurrency per group, `buildDirectoryPrompt()` reads child `.sum` via parallel `readSumFile()`, `generation/writers/agents-md.ts` `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` + injects `@AGENTS.local.md` directive, root `generation/writers/claude-md.ts` `writeClaudeMdPointer()` generates `CLAUDE.md` with `@AGENTS.md` import.

### Command Execution Flow

CLI invocation → `cli/index.ts` `parseArgs()` → command dispatch → `createBackendRegistry()` → `resolveBackend()` (throws `AIServiceError` code `CLI_NOT_FOUND` on missing CLI) → `AIService` construction → `CommandRunner` instantiation → five-phase execution (pre-phase-1-cache, phase-1-files, post-phase-1-quality, phase-2-dirs, post-phase-2) → telemetry finalization → exit code emission (0/1/2).

### Concurrency Control

`orchestration/pool.ts` `runPool<T>()` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator. Each worker pulls `[index, task]` pairs until exhausted or `aborted` flag set (`failFast` mode). Maintains full utilization during variable-duration tasks. Optional `onComplete` callback enables serialized `PlanTracker.markDone()` updates via promise chain.

### Update Strategy

`update/orchestrator.ts` `preparePlan()` reads existing `.sum` YAML frontmatter via `readSumFile()`, compares stored `content_hash` against `computeContentHash()` (SHA-256 hex), populates `filesToAnalyze` on mismatch, executes phase-1-files for changed files, calls `getAffectedDirectories()` collecting parent directories sorted by depth descending, sequentially regenerates `AGENTS.md` consuming updated child `.sum`. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for git-deleted files, removes AGENTS.md when no source files remain.

### Quality Validation

`orchestration/runner.ts` executes validation in two stages: post-phase-1-quality (groups files by directory, runs `quality/inconsistency/code-vs-doc.ts` `checkCodeVsDoc()` twice per file [old-doc + new-doc for stale detection], runs `quality/inconsistency/code-vs-code.ts` `checkCodeVsCode()` per group), post-phase-2 (`quality/phantom-paths/validator.ts` `checkPhantomPaths()` validates markdown links). Aggregates via `buildInconsistencyReport()`, formats via `formatReportForCli()`. Wrapped in try-catch to prevent pipeline breakage.

### Telemetry Pipeline

`ai/service.ts` `AIService` wraps `runSubprocess()` in `withRetry()` (exponential backoff: `min(1000 * 2^attempt, 8000) + random(500)` for RATE_LIMIT errors), records `TelemetryEntry` (prompt/response/tokens/latency/cost/retryCount), `tracer.emit()` emits NDJSON events (`subprocess:spawn`, `subprocess:exit`, `retry`, `worker:start`, `task:done`, `phase:start`) to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` when `--trace` flag set. `aiService.finalize()` writes `RunLog` to `.agents-reverse-engineer/logs/run-{timestamp}.json`, calls `cleanupOldLogs()` enforcing `config.ai.telemetry.keepRuns` retention.

### Rebuild Workflow

`rebuild/orchestrator.ts` `executeRebuild()` reads specs from `specs/`, partitions via `## Build Plan` → `### Phase N:` extraction or top-level heading fallback, groups `RebuildUnit[]` by `order` property, executes sequential phase groups (concurrent tasks within group via `runPool`), accumulates `builtContext` from `filesWritten` after each group (truncates older sections at 100K chars), persists completion via `CheckpointManager` promise-chain writes to `.rebuild-checkpoint` JSON, compares `specHashes` via `computeContentHashFromString()` for drift detection (hash mismatch triggers fresh checkpoint).

## Behavioral Contracts

### Concurrency Calculation
```javascript
concurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))
// Constants: SUBPROCESS_HEAP_GB=0.512, MEMORY_FRACTION=0.5, MULTIPLIER=5, MIN=2, MAX=20
```

### Exponential Backoff Formula
```javascript
delay = min(baseDelayMs * multiplier^attempt, maxDelayMs) + random(500)
// Defaults: baseDelayMs=1000, multiplier=2, maxDelayMs=8000, jitter=[0,500ms]
```

### Rate Limit Detection
```javascript
['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))
```

### Timeout Escalation
- SIGTERM at `options.timeoutMs`
- SIGKILL at `options.timeoutMs + 5000ms` via `process.kill(-childPid, 'SIGKILL')` (process group)

### Post-Order Directory Sort
```javascript
getDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth
// getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length
```

### Export Extraction Regex
```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```

### Import Extraction Regex
```regex
/^[ \t]*import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm
```

### Phantom Path Link Pattern
```regex
/\[(?:[^\]]*)\]\((\.[^)]+)\)/g
```

### Content Hash Algorithm
```javascript
crypto.createHash('sha256').update(content).digest('hex')
```

### Exit Code Convention
- **0**: success (all tasks succeeded or no tasks to process)
- **1**: partial failure (some tasks failed but some succeeded)
- **2**: total failure (all tasks failed or CLI not found)

### Generated AGENTS.md Marker
```markdown
<!-- Generated by agents-reverse-engineer -->
```

## Workflow & Conventions

### Git Commit Protocol (CLI Commands)
- NEVER update git config
- NEVER run destructive git commands without user request
- NEVER skip hooks (`--no-verify`, `--no-gpg-sign`)
- NEVER amend commits unless explicitly requested (pre-commit hook failure requires NEW commit)
- Prefer staging specific files by name over `git add .` or `git add -A`
- NEVER commit changes unless user explicitly asks
- Exit codes: 0 (success), 1 (partial failure), 2 (total failure/CLI not found)

### Manifest File Support
LANGUAGES-MANIFEST.md documents 26 language ecosystems with manifest patterns: `package.json` (npm), `Cargo.toml` (cargo), `go.mod` (go modules), `pom.xml` (Maven), `build.gradle` (Gradle), `Gemfile` (Bundler), `composer.json` (Composer), `requirements.txt` (pip), `pyproject.toml` (Poetry), `Pipfile` (Pipenv). `imports/extractor.ts` scans these for dependency context.

### Progress Monitoring
`.agents-reverse-engineer/progress.log` receives mirrored console output via `orchestration/progress.ts` promise-chain serialization. CLI hooks (`hooks/are-session-end.js`) use `tail -f` pattern. Session hooks disabled via `ARE_DISABLE_HOOK=1` environment variable OR `hook_enabled: false` config.

### Version Resolution Priority
1. Project-local: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`
2. Global: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`
3. Fallback: `'0.0.0'`