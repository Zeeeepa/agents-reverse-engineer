<!-- Generated by agents-reverse-engineer -->

# src

Root source directory implementing agents-reverse-engineer CLI: orchestrates three-phase AI-driven documentation pipeline (concurrent `.sum` file analysis, post-order `AGENTS.md` aggregation, platform-specific root synthesis) via worker pools with subprocess resource limits, gitignore-aware discovery, SHA-256 incremental updates, and NDJSON telemetry.

## Contents

**[version.ts](./version.ts)** — `getVersion()` retrieves package version from `package.json` via `import.meta.url` path resolution with `fileURLToPath()`, reads synchronously via `readFileSync()`, parses JSON extracting `version` field, fallback returns `'unknown'` on filesystem/parse errors.

## Subdirectories

**[ai/](./ai/)** — Backend-agnostic AI service layer: `AIService.call()` spawns AI CLI subprocesses (Claude Code, Gemini CLI, OpenCode) via `execFile()` with exponential backoff retry on rate limits, process group killing via `kill(-pid)`, resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`), `BackendRegistry` for auto-detection via `isAvailable()`, `TelemetryLogger.writeRunLog()` serializing token costs to timestamped JSON, `TraceWriter` emitting subprocess lifecycle events (`subprocess:spawn/exit`, `retry`).

**[change-detection/](./change-detection/)** — Git-based change detection: `getChangedFiles()` parses `git diff --name-status -M` with rename detection, merges uncommitted changes via `git.status()` when `includeUncommitted` enabled, `computeContentHash()` generates SHA-256 hex digests, `FileChange` discriminated union with `status: 'added'|'modified'|'deleted'|'renamed'` and conditional `oldPath` for renames.

**[cli/](./cli/)** — Command entry points: `index.ts` routes to `init`/`discover`/`generate`/`update`/`specify`/`clean` via `parseArgs()` flag extraction, `generate.ts` orchestrates three-phase pipeline with `CommandRunner.executeGenerate()`, `update.ts` runs incremental workflow via hash comparison with `preparePlan()`, all commands thread `ITraceWriter` for NDJSON emission and `ProgressLog` for streaming `.agents-reverse-engineer/progress.log`.

**[config/](./config/)** — Zod-validated YAML config: `ConfigSchema` with numeric constraints (concurrency ∈ [1,20], timeoutMs > 0), `loadConfig()` async reader emitting `config:loaded` trace events, `writeDefaultConfig()` generator with inline documentation, `getDefaultConcurrency()` computing worker pool size via CPU cores and memory capacity (`floor(totalMemGB * 0.5 / 0.512)` preventing OOM in WSL).

**[discovery/](./discovery/)** — Gitignore-aware file walker: `walkDirectory()` via `fast-glob('**/*')` with `.git/**` exclusion, `discoverFiles()` composing four-stage filter chain (gitignore, vendor, binary, custom) executing in order with short-circuit rejection, `applyFilters()` using concurrency-bounded pool (30 workers) emitting `filter:applied` trace events, `FilterResult` with `included`/`excluded` arrays.

**[generation/](./generation/)** — Phase orchestration: `GenerationOrchestrator.createFileTasks()` calling `buildFilePrompt()` with import context, `buildExecutionPlan()` sorting directories by depth descending for post-order traversal, `buildDirectoryPrompt()` aggregating child `.sum` files with manifest detection (9 types: package.json, Cargo.toml, go.mod, etc.), `buildRootPrompt()` collecting all `AGENTS.md` via `collectAgentsDocs()`, `writeSumFile()` embedding SHA-256 `content_hash` in YAML frontmatter, `writeAgentsMd()` preserving user content via `AGENTS.local.md` prepending.

**[imports/](./imports/)** — Static import analysis: `extractImports()` applying regex with five capture groups (type keyword, named symbols, namespace imports, default imports, module specifier), `extractDirectoryImports()` reading first 100 lines per file classifying relative imports into `internal` (`./`) and `external` (`../`) arrays, `formatImportMap()` serializing to human-readable text blocks consumed by directory aggregation prompts.

**[installer/](./installer/)** — npx-driven installation: `runInstaller()` parsing flags via `parseInstallerArgs()`, routing to `installFiles()` writing templates from `getTemplatesForRuntime()` to `resolveInstallPath()` with hook registration mutating settings.json via `registerHooks()` (Claude nested format, Gemini flat format, OpenCode plugins), `uninstallFiles()` removing command templates and deregistering via `unregisterHooks()` filtering arrays by command pattern match, `selectRuntime()`/`selectLocation()` providing TTY-aware arrow key selection with `arrowKeySelect()` vs. `numberedSelect()` fallback.

**[integration/](./integration/)** — Platform detection and template generation: `detectEnvironments()` scanning for `.claude/`, `CLAUDE.md`, `.opencode/`, `.aider.conf.yml` markers, `getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()` producing command files with frontmatter-wrapped templates (`.claude/skills/*/SKILL.md`, `.opencode/commands/*.md`, `.gemini/commands/*.toml`), `generateIntegrationFiles()` orchestrating write workflow with `ensureDir()` directory creation and `force`/`dryRun` handling.

**[orchestration/](./orchestration/)** — Concurrency control and progress tracking: `runPool()` shared-iterator pattern executing `Array<() => Promise<T>>` task factories through concurrency-limited pool preventing batch-induced idling, `CommandRunner.executeGenerate()` sequencing Phase 1 concurrent file analysis, Phase 2 post-order directory aggregation grouped by depth, Phase 3 sequential root synthesis, `ProgressReporter` computing ETA via moving averages of last 10 durations, `PlanTracker`/`ProgressLog`/`TraceWriter` using promise-chain serialization (`writeQueue = writeQueue.then(...)`) preventing concurrent write corruption.

**[output/](./output/)** — Terminal formatting: `createLogger()` factory using picocolors for ANSI coloring toggled via `LoggerOptions.colors`, `Logger` interface defining six output methods (`info`, `file`, `excluded`, `summary`, `warn`, `error`), `createSilentLogger()` returning no-op stubs for testing.

**[quality/](./quality/)** — Post-generation validation: `checkCodeVsDoc()` extracting exports via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` verifying presence in `.sum` summaries, `checkCodeVsCode()` aggregating exports into `Map<symbol, string[]>` detecting duplicates, `checkPhantomPaths()` applying three regex patterns (markdown links, backtick-quoted paths, prose-embedded paths) with six SKIP_PATTERNS, resolving candidates relative to AGENTS.md directory with `.js`→`.ts` fallback, `buildInconsistencyReport()` aggregating discriminated union issues with metadata.

**[specify/](./specify/)** — Project specification synthesis: `buildSpecPrompt()` constructing system/user prompt pairs with `SPEC_SYSTEM_PROMPT` enforcing concern-based organization (nine mandatory sections: Project Overview, Architecture, Public API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts, Test Contracts, Build Plan), `writeSpec()` orchestrating single-file (`specs/SPEC.md`) vs. multi-file (`specs/<slug>.md`) output modes splitting on top-level `# ` headings via `/^(?=# )/m` regex, throwing `SpecExistsError` on overwrite protection failures.

**[types/](./types/)** — Shared discovery result definitions: `ExcludedFile` (path + exclusion reason), `DiscoveryResult` (included files array + excluded file metadata), `DiscoveryStats` (metrics with `totalFiles`, `includedFiles`, `excludedFiles`, `exclusionReasons` histogram).

**[update/](./update/)** — Incremental update system: `UpdateOrchestrator.preparePlan()` reading YAML `content_hash` from `.sum` frontmatter via `readSumFile()`, comparing against `computeContentHash()` SHA-256 output, classifying into `filesToAnalyze[]` (hash mismatch/missing) or `filesToSkip[]` (hash match), `cleanupOrphans()` deleting `.sum` files for deleted/renamed sources, `cleanupEmptyDirectoryDocs()` removing `AGENTS.md` from directories with no remaining source files, `getAffectedDirectories()` walking parent directory tree collecting paths requiring regeneration.

## Architecture

### Three-Phase Pipeline

**Phase 1 (Concurrent File Analysis):** `GenerationOrchestrator.prepareFiles()` reads source content, `createFileTasks()` constructs prompts via `buildFilePrompt()` with import context from `extractDirectoryImports()`, `runPool()` executes file tasks through worker pool (default concurrency: 2 for WSL, 5 elsewhere), `writeSumFile()` persists `.sum` with YAML frontmatter containing `generated_at`, `content_hash` (SHA-256), `purpose`, optional `critical_todos`/`related_files`.

**Phase 2 (Post-Order Directory Aggregation):** `buildExecutionPlan()` sorts directories by `getDirectoryDepth()` descending (deepest first), `isDirectoryComplete()` waits for all child `.sum` files via `sumFileExists()` predicate, `buildDirectoryPrompt()` reads child `.sum` files via `readSumFile()` and detects manifests (package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile), `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` if non-generated and prepends user content to LLM output.

**Phase 3 (Root Document Synthesis):** `collectAgentsDocs()` recursively aggregates all `AGENTS.md` files, `buildRootPrompt()` reads root `package.json` for project metadata (`name`, `version`, `description`, `packageManager`, `scripts`), sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` with synthesis-only constraint (no invention/extrapolation, every claim traceable to `AGENTS.md`).

### Iterator-Based Worker Pool

`runPool()` shares single `tasks.entries()` iterator across N workers preventing batch anti-pattern. Workers execute tight loop: pickup task → execute → emit result → pickup next, maintaining full slot utilization. Iterator protocol atomicity ensures each `[index, task]` pair consumed by exactly one worker. Effective concurrency capped at `Math.min(options.concurrency, tasks.length)`.

### Subprocess Resource Management

`runSubprocess()` mitigates Claude CLI thread exhaustion (GitHub #5771: 200 NodeJS instances) via environment variables: `NODE_OPTIONS='--max-old-space-size=512'` limits heap to 512MB per subprocess, `UV_THREADPOOL_SIZE='4'` constrains libuv thread pool to 4 threads, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` prevents background task spawning, `--disallowedTools Task` blocks subagents. Process group killing via `kill(-pid)` terminates subprocess trees. SIGTERM sent at `timeoutMs`, SIGKILL escalation after 5s grace period.

### Incremental Update Strategy

`UpdateOrchestrator.preparePlan()` replaces git-based diffing with SHA-256 content hash comparison: reads `content_hash` from `.sum` YAML frontmatter, computes current hash via `computeContentHash()`, classifies files into `filesToAnalyze` (hash mismatch/missing) or `filesToSkip` (hash match). `cleanupOrphans()` deletes stale `.sum` files for deleted/renamed sources, `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with no remaining source files, `getAffectedDirectories()` walks parent directory tree collecting paths requiring regeneration.

### Telemetry & Tracing

`TelemetryLogger` accumulates `TelemetryEntry` instances with `addEntry()` per subprocess completion, `toRunLog()` assembles complete `RunLog` with shallow-copied entries and `getSummary()` aggregations (total tokens, error counts, unique files), `writeRunLog()` serializes to timestamped JSON (`.agents-reverse-engineer/logs/run-<timestamp>.json`), `cleanupOldLogs()` enforces retention limit (default 50) via lexicographic sort descending. `TraceWriter` emits NDJSON events (`phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`) to `.agents-reverse-engineer/traces/trace-<timestamp>.ndjson` with promise-chain serialization, auto-populated fields (`seq`, `ts`, `pid`, `elapsedMs`), `cleanupOldTraces()` enforcing 500-trace retention.