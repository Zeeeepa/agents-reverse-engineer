<!-- Generated by agents-reverse-engineer -->

# src

**Root source directory implementing ARE's three-phase documentation generation pipeline via TypeScript modules organized into nine functional subsystems: AI service orchestration (subprocess pooling, retry logic, telemetry), file discovery (gitignore-aware filtering, binary detection), change detection (git diff parsing, SHA-256 hashing), generation (concurrent file analysis, post-order directory aggregation, root synthesis), quality validation (code-vs-doc, phantom paths), CLI commands (generate, update, specify, rebuild, clean), configuration (YAML schema, resource-adaptive concurrency), IDE integration (template generation for Claude/OpenCode/Gemini), and installer (npx-driven hook deployment).**

## Contents

**[version.ts](./version.ts)** — Exports `getVersion()` extracting package version from `../package.json` via `fileURLToPath(import.meta.url)` + `dirname()` + `join(__dirname, '..', 'package.json')`, returns `'unknown'` string literal on read/parse failure. Consumed by CLI `--version` flag, session lifecycle hooks for npm version comparison, and telemetry run log metadata.

## Subdirectories

**[ai/](./ai/)** — Backend-agnostic AI CLI orchestration layer with subprocess pooling (10MB maxBuffer, SIGTERM/SIGKILL timeout enforcement, process group termination via `kill(-pid)`), exponential backoff retry detecting rate limits via stderr patterns (`["rate limit", "429", "too many requests", "overloaded"]`), token cost telemetry accumulating `TelemetryEntry[]` with NDJSON persistence to `.agents-reverse-engineer/logs/run-<timestamp>.json`, and trace emission (`subprocess:spawn/exit`, `retry` events). Backends: ClaudeBackend (Zod-validated JSON parsing), GeminiBackend/OpenCodeBackend (stubs throwing `SUBPROCESS_ERROR`). Resource limits: `NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE=4`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS=1`.

**[change-detection/](./change-detection/)** — Git-based delta computation via `git diff --name-status -M` with tab-split parsing extracting status codes (`A`/`M`/`D`/`R<percentage>`) and file paths, SHA-256 content hashing via `createHash('sha256').update(content).digest('hex')`, uncommitted change merging from `git.status()` with linear `Array.some()` deduplication. Exports `getChangedFiles()` returning `ChangeDetectionResult` with `changes[]` discriminated union (`FileChange` with optional `oldPath` for renames).

**[cli/](./cli/)** — Command entry points parsing `process.argv` via `parseArgs()`, routing to `init`/`discover`/`generate`/`update`/`specify`/`rebuild`/`clean` handlers, managing shared flags (`--debug`, `--trace`, `--dry-run`, `--concurrency`, `--model`). Integrates `ProgressLog` streaming to `.agents-reverse-engineer/progress.log`, `TraceWriter` emitting NDJSON to `traces/`, `AIService` backend resolution with `CLI_NOT_FOUND` exit code 2. Model resolution: CLI overrides config, specify/rebuild upgrade sonnet → opus for quality-critical synthesis.

**[config/](./config/)** — YAML configuration loading via `loadConfig()` reading `.agents-reverse-engineer/config.yaml`, Zod validation with `ConfigSchema` applying defaults from `defaults.ts` (18-entry `DEFAULT_VENDOR_DIRS`, 26-entry `DEFAULT_EXCLUDE_PATTERNS`, 26-entry `DEFAULT_BINARY_EXTENSIONS`). Resource-adaptive concurrency formula: `clamp(os.availableParallelism() * 5, 2, min(20, floor(os.totalmem() * 0.5 / 0.512)))` preventing RAM exhaustion on low-memory systems. Environment overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`.

**[discovery/](./discovery/)** — Gitignore-aware file discovery via `discoverFiles()` facade composing `walkDirectory()` (fast-glob with `absolute: true`, `onlyFiles: true`, hardcoded `ignore: ['**/.git/**']`) and four-stage filter chain: `createGitignoreFilter()` (parses `.gitignore` via `ignore` library), `createVendorFilter()` (excludes 10 default directories via Set + path-pattern matching), `createBinaryFilter()` (96-extension allowlist + `isBinaryFile()` content analysis at 1MB threshold), `createCustomFilter()` (user glob patterns). Returns `FilterResult` with `included[]` and `excluded[]` arrays, latter containing `{ file, reason, filter }` objects.

**[generation/](./generation/)** — Orchestrates three-phase pipeline: `GenerationOrchestrator.createPlan()` builds `AnalysisTask[]` via `buildFilePrompt()` with import maps and project structure, clears `PreparedFile.content` after prompt embedding to free heap. `buildExecutionPlan()` constructs dependency-aware `ExecutionPlan` with post-order directory sorting (deepest-first via `getDirectoryDepth()`), `isDirectoryComplete()` predicate polling child `.sum` existence. Phase 1: concurrent file analysis writes `.sum` with SHA-256 `content_hash` frontmatter. Phase 2: directory aggregation via `buildDirectoryPrompt()` reading child `.sum` + manifest detection (9 types) + import maps, writes `AGENTS.md` via `writeAgentsMd()` preserving `AGENTS.local.md` user content. Phase 3: sequential root synthesis via `buildRootPrompt()` consuming all `AGENTS.md`, writes `CLAUDE.md`/`GEMINI.md`/`OPENCODE.md`.

**[imports/](./imports/)** — Extracts TypeScript/JavaScript import statements via `IMPORT_REGEX = /^import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm`, classifies as internal (`.` prefix) or external (`..` prefix), formats as structured import maps via `formatImportMap()` producing `fileName:\n  specifier → symbol1, symbol2 (type)` output. Reads first 100 lines per file assuming imports clustered at top, consumed by `buildFilePrompt()` and `buildDirectoryPrompt()` for LLM prompt context.

**[installer/](./installer/)** — npx-driven installer orchestrating command/hook deployment via interactive prompts (`arrowKeySelect()` with raw mode `\x1b[${n}A` ANSI sequences) or non-interactive mode (requires `--runtime` + `-g/-l` flags). Copies templates from `getTemplatesForRuntime()` to `${basePath}/${relativePath}`, registers hooks with nested `HookEvent.hooks[]` schema (Claude) or flat `GeminiHook[]` (Gemini), adds `ARE_PERMISSIONS` patterns to Claude `settings.json`, writes `ARE-VERSION` from `getPackageVersion()`. Uninstalls via `unregisterClaudeHooks()` filtering by `getHookPatterns()` (matches current + legacy formats), `cleanupEmptyDirs()` recursively.

**[integration/](./integration/)** — Platform-specific integration file generation via `generateIntegrationFiles()` detecting `.claude/`, `.opencode/`, `.aider.conf.yml`, `.gemini/` artifacts. Templates from `getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()` with frontmatter variants (Claude `name:` field, OpenCode `agent: build`, Gemini TOML `description`/`prompt`). Background execution pattern: Read `VERSION_FILE_PATH`, run `npx agents-reverse-engineer@latest {command}` with `run_in_background: true`, poll `.agents-reverse-engineer/progress.log` with `offset` parameter, check `TaskOutput` with `block: false`. Copies bundled hooks from `hooks/dist/` for Claude via `readBundledHook('are-session-end.js')`.

**[orchestration/](./orchestration/)** — Worker pool via `runPool()` sharing single `tasks.entries()` iterator across N workers (atomic `.next()` calls prevent duplicate pickups), fail-fast via shared `aborted` flag. `CommandRunner.executeGenerate()` runs three-phase pipeline with quality validation: pre-phase-1 cache for stale-doc detection, post-phase-1 code-vs-doc/code-vs-code checks via regex export extraction and substring matching, post-phase-2 phantom path resolution via three regex patterns. `ProgressReporter` streams `[X/Y] ANALYZING/DONE/FAIL path` to console + `.agents-reverse-engineer/progress.log`, calculates ETA via moving average of last 10 task durations. `TraceWriter` emits NDJSON with auto-populated `seq`/`ts`/`pid`/`elapsedMs` fields, serializes via promise-chain pattern. `PlanTracker` updates `GENERATION-PLAN.md` checkboxes via regex `/- \[ \] \`${itemPath}\`/` → `/- \[x\] \`${itemPath}\`/`.

**[output/](./output/)** — Terminal logging via `createLogger()` with conditional color mode (picocolors vs identity passthrough). Format rules: file discovery prefixes (`  +` green for included, `  -` dim for excluded), bold summary counts with dim excluded counts, red `Error:` and yellow `Warning:` prefixes. `stripAnsi(str)` removes color codes via `/\x1b\[[0-9;]*m/g` for progress.log persistence.

**[quality/](./quality/)** — Post-generation validation detecting code-vs-doc (exported symbols missing from `.sum`), code-vs-code (duplicate exports within directory), phantom-paths (unresolvable file references in `AGENTS.md`). `extractExports()` via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, `checkCodeVsDoc()` verifies substring presence. `checkPhantomPaths()` extracts paths via three regex patterns (markdown links, backtick paths, prose-embedded src/), resolves via `existsSync()` at `agentsMdDir`/`projectRoot`/.ts fallback locations, filters via `SKIP_PATTERNS` (node_modules, .git, URLs, template syntax). `buildInconsistencyReport()` aggregates `Inconsistency[]` discriminated union into `InconsistencyReport` with severity stratification (`info`/`warning`/`error`).

**[rebuild/](./rebuild/)** — AI-driven project reconstruction from specification documents via `executeRebuild()` executing ordered phase workflow: `partitionSpec()` extracts `RebuildUnit[]` from Build Plan phases (`### Phase N:`), sequential order group processing with concurrent `runPool()` execution per group, progressive context accumulation from generated file exports with LRU truncation at 100k chars. `CheckpointManager` provides session continuity via SHA-256 spec drift detection, per-module status tracking (`pending`/`done`/`failed`), promise-chain write serialization to `.rebuild-checkpoint` JSON. `parseModuleOutput()` extracts file paths via delimiter-based parsing (`===FILE:===` / `===END_FILE===`) with markdown fenced block fallback. Targeted API injection via Defines/Consumes keyword matching filtering subsections with fuzzy matching (substring, word overlap).

**[specify/](./specify/)** — Project specification synthesis via `buildSpecPrompt()` constructing `SpecPrompt` pair with `SPEC_SYSTEM_PROMPT` enforcing 11-section structure (Project Overview, Architecture, Public API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts [Runtime Behavior + Implementation Contracts], Test Contracts, Build Plan, Prompt Templates, IDE Integration). `writeSpec()` writes markdown to `specs/SPEC.md` (single-file) or `specs/<slug>.md` (multi-file via `splitByHeadings` partitioning on `/^(?=# )/m` with slugification transforms), throws `SpecExistsError` on conflicts unless `force=true`.

**[types/](./types/)** — Core TypeScript interfaces for file discovery results: `DiscoveryResult` (`files[]`, `excluded[]`), `ExcludedFile` (`path`, `reason`), `DiscoveryStats` (`totalFiles`, `includedFiles`, `excludedFiles`, `exclusionReasons` histogram). Flows from discovery filters → orchestrator → worker pool → generation writers.

**[update/](./update/)** — Incremental documentation update via `UpdateOrchestrator.preparePlan()` comparing YAML frontmatter `content_hash` against SHA-256 hashes of current content via `computeContentHash()`, segregating into `filesToAnalyze` (added/modified), `filesToSkip` (unchanged), `cleanup` (orphaned). `cleanupOrphans()` deletes `.sum`/`.annex.md` for deleted/renamed files (targeting `oldPath` for renames), `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with no remaining source files. `getAffectedDirectories()` walks parent paths via `path.dirname()` to project root, sorts deepest-first. External caller invokes Phase 1 for `filesToAnalyze`, Phase 2 for `affectedDirs` (skips Phase 3).

## Architecture

### Three-Phase Pipeline Coordination

Phase 1 (`generation/orchestrator.ts`): `createFileTasks()` builds `AnalysisTask[]` with prompts via `buildFilePrompt()` embedding import maps from `imports/extractor.ts`, clears `PreparedFile.content` after prompt construction to free heap. `runPool()` spawns N workers sharing `tasks.entries()` iterator (atomic `.next()` calls), each worker invokes `AIService.call()` → `runSubprocess()` → `execFile()` with resource limits, writes `.sum` with YAML frontmatter (`generated_at`, `content_hash` SHA-256 hex, `purpose`, `critical_todos`, `related_files`).

Phase 2 (`generation/executor.ts`): `buildExecutionPlan()` sorts directories by depth descending via `getDirectoryDepth()` (deepest-first), creates `directoryTasks[]` depending on child file task IDs for post-order traversal. `isDirectoryComplete()` predicate polls child `.sum` existence before processing. `buildDirectoryPrompt()` reads child `.sum` via `readSumFile()`, aggregates subdirectory `AGENTS.md`, extracts imports via `extractDirectoryImports()`, detects manifests (9 types: package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile). `writeAgentsMd()` preserves `AGENTS.local.md` user content above generated sections with `GENERATED_MARKER` injection.

Phase 3 (`generation/orchestrator.ts`): Sequential execution (concurrency=1) via `rootTasks[]` depending on all directory task IDs. `buildRootPrompt()` consumes all `AGENTS.md` via `collectAgentsDocs()`, reads root `package.json`, enforces synthesis-only constraints (no invented features). Strips conversational preamble via markdown start detection (`indexOf('# ')`), writes `CLAUDE.md`/`GEMINI.md`/`OPENCODE.md`.

### Iterator-Based Worker Pool

`orchestration/pool.ts` shares single `tasks.entries()` iterator across N workers via JavaScript iterator protocol guaranteeing atomic `.next()` calls. Workers consume `[index, task]` pairs in `for...of` loop, execute task factory, immediately pull next without batch idle periods. Effective concurrency capped via `Math.min(options.concurrency, tasks.length)`. Fail-fast mode sets shared `aborted` flag, workers check via `if (aborted) break` before pulling next. Results array sparse-populated via `results[index] = result` to preserve task position.

### Promise-Chain Serialization

`PlanTracker.writeQueue`, `ProgressLog.writeQueue`, `TraceWriter.writeQueue` chain writes via `this.writeQueue = this.writeQueue.then(async () => {...}).catch(() => {})` pattern preventing NDJSON corruption and markdown TOCTOU errors from concurrent pool workers. Lazy file handle creation (first write opens file, subsequent writes reuse handle). Write errors silently swallowed (non-critical telemetry loss acceptable).

### Quality Validation Phases

Pre-Phase-1: Throttled read (concurrency=20) of existing `.sum` files into `oldSumCache` for stale-doc detection.

Post-Phase-1: `checkCodeVsDoc()` twice (against `oldSumCache` for stale, against fresh `.sum` for omissions) via regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, substring matching in summary. `checkCodeVsCode()` aggregates exports into `Map<symbol, string[]>` per directory, detects duplicates.

Post-Phase-2: `checkPhantomPaths()` extracts paths via three regex patterns (markdown links: `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`, backtick paths: `` /`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g ``, prose-embedded: `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`), resolves via `existsSync()` at `agentsMdDir`/`projectRoot`/.ts fallback locations, filters via `SKIP_PATTERNS`.

### Incremental Update Strategy

`update/orchestrator.ts` workflow: `preparePlan()` calls `discoverFiles()`, iterates results constructing `.sum` path via `getSumPath()`, calls `readSumFile()` extracting `contentHash` from frontmatter, missing `.sum` adds `{ path, status: 'added' }` to `filesToAnalyze`, existing `.sum` calls `computeContentHash()` comparing hashes, mismatch adds `{ path, status: 'modified' }`, match adds to `filesToSkip`. `cleanupOrphans()` deletes `.sum`/`.annex.md` for deleted/renamed files, `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with no source files. `getAffectedDirectories()` walks parent paths via `path.dirname()` to root, sorts deepest-first. External caller invokes Phase 1 for `filesToAnalyze`, Phase 2 for `affectedDirs` (skips Phase 3).

## Behavioral Contracts

### Default Concurrency Formula (config/defaults.ts)
```typescript
clamp(
  os.availableParallelism() * 5,
  2,
  min(20, floor(os.totalmem() * 0.5 / 0.512))
)
```

### Subprocess Resource Limits (ai/subprocess.ts)
```
NODE_OPTIONS='--max-old-space-size=512'
UV_THREADPOOL_SIZE=4
CLAUDE_CODE_DISABLE_BACKGROUND_TASKS=1
--disallowedTools Task
```

### Process Lifecycle Timeouts (ai/subprocess.ts)
- SIGTERM sent at `timeoutMs` via `killSignal` option
- SIGKILL escalation at `timeoutMs + 5000ms` via unref'd timer
- Process group termination: `kill(-pid, 'SIGKILL')`

### Rate Limit Patterns (ai/service.ts)
```javascript
["rate limit", "429", "too many requests", "overloaded"]
```

### Exponential Backoff Formula (ai/retry.ts)
```typescript
min(baseDelayMs * multiplier^attempt, maxDelayMs) + Math.random() * 500
```

### Default Retry Configuration (ai/retry.ts)
```typescript
{ maxRetries: 3, baseDelayMs: 1000, maxDelayMs: 8000, multiplier: 2 }
```

### Git Diff Format (change-detection/detector.ts)
```
A       → { status: 'added', path }
M       → { status: 'modified', path }
D       → { status: 'deleted', path }
R<pct>  → { status: 'renamed', path: newPath, oldPath }
```

### Binary Extension Set (discovery/filters/binary.ts)
96 extensions including `.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.ico`, `.webp`, `.svg`, `.zip`, `.tar`, `.gz`, `.rar`, `.7z`, `.exe`, `.dll`, `.so`, `.dylib`, `.bin`, `.mp3`, `.mp4`, `.wav`, `.avi`, `.mov`, `.pdf`, `.doc`, `.docx`, `.xls`, `.xlsx`, `.woff`, `.woff2`, `.ttf`, `.eot`, `.class`, `.pyc`, `.o`, `.obj`, `.db`, `.sqlite`, `.wasm`.

### Export Extraction Regex (quality/inconsistency/code-vs-doc.ts)
```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```

### Phantom Path Extraction Patterns (quality/phantom-paths/validator.ts)
```javascript
/\[(?:[^\]]*)\]\((\.[^)]+)\)/g
/`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g
/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi
```

### Import Regex Pattern (imports/extractor.ts)
```regex
/^import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm
```

### Build Plan Phase Extraction (rebuild/spec-reader.ts)
```regex
/^### Phase (\d+):\s*(.+)$/gm
```

### Delimiter Format (rebuild/output-parser.ts)
```regex
/===FILE:\s*(.+?)===\n([\s\S]*?)===END_FILE===/g
```

### Heading Regex (specify/writer.ts)
```regex
/^(?=# )/m
```

### Slugification Transforms (specify/writer.ts)
```typescript
.toLowerCase()
.replace(/\s+/g, '-')
.replace(/[^a-z0-9-]/g, '')
.replace(/-+/g, '-')
.replace(/^-|-$/g, '')
```

## Dependencies

**External**: `fast-glob` (file discovery), `ignore` (gitignore parsing), `isbinaryfile` (binary detection), `simple-git` (change detection), `yaml` (config parsing), `zod` (schema validation), `ora` (spinner UI), `picocolors` (terminal colors).

**Internal**: `node:fs/promises` (async file I/O), `node:fs` (sync file I/O), `node:path` (path manipulation), `node:url` (ES module URL resolution), `node:child_process` (subprocess spawning), `node:os` (system metrics), `node:crypto` (SHA-256 hashing), `node:readline` (interactive prompts).