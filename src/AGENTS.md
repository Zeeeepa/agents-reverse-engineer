<!-- Generated by agents-reverse-engineer -->

# src

Root TypeScript source directory implementing CLI, configuration, discovery, generation, orchestration, AI integration, quality validation, update orchestration, rebuild pipeline, and specification transformation subsystems. Entry point: `cli/index.ts`. Exports programmatic API via `core/index.ts` for embedding in non-CLI contexts.

## Contents

**[version.ts](./version.ts)** — Exports `getVersion()` reading `package.json` from `__dirname/../package.json` via ESM `import.meta.url` resolution (`fileURLToPath()` → `dirname()` → `join()`), returning `version` field or `'unknown'` on error. Used by CLI `--version` flag, telemetry metadata, and installer version file writes.

## Subdirectories

**[ai/](./ai/)** — Multi-backend AI service layer spawning CLI subprocesses (Claude/Gemini/OpenCode) with exponential backoff retry (rate-limit only), SIGTERM/SIGKILL timeout escalation, telemetry accumulation, NDJSON trace emission. Exports `AIService` (orchestrator wrapping providers), `BackendRegistry` (factory mapping backend names to implementations), `createBackendRegistry()` (pre-populates Claude/Gemini/OpenCode), `resolveBackend()` (auto-detection via PATH availability), `withRetry()` (exponential backoff with jitter), `runSubprocess()` (child process spawner), `SubprocessProvider` (AIProvider interface adapter), `ClaudeBackend`/`GeminiBackend`/`OpenCodeBackend` (CLI-specific argument builders), `TelemetryLogger`/`writeRunLog()`/`cleanupOldLogs()` (run log persistence).

**[change-detection/](./change-detection/)** — Git-based change detection subsystem: `isGitRepo()` (repository validation), `getCurrentCommit()` (HEAD hash), `getChangedFiles()` (diff parsing with `--name-status -M` + optional uncommitted merge), `computeContentHash()` (SHA-256 file digest), `computeContentHashFromString()` (in-memory hash). Powers `src/update/orchestrator.ts` staleness detection via frontmatter hash comparison and `hooks/are-session-end.js` execution gating.

**[cli/](./cli/)** — CLI entry point routing eight commands: `init` (config creation + gitignore/VSCode setup), `discover` (four-filter chain + execution plan generation), `generate` (two-phase pipeline: parallel `.sum` + post-order `AGENTS.md`), `update` (frontmatter-based staleness detection + orphan cleanup), `specify` (AGENTS.md → 12-section project spec), `rebuild` (AI-driven project reconstruction from specs), `clean` (marker-based artifact deletion), `install`/`uninstall` (interactive installer). Exports `initCommand()`, `discoverCommand()`, `generateCommand()`, `updateCommand()`, `specifyCommand()`, `rebuildCommand()`, `cleanCommand()`, `runInstaller()`.

**[config/](./config/)** — Configuration management: YAML loading with Zod validation, default computation, file initialization. Exports `loadConfig()` (ENOENT → defaults), `writeDefaultConfig()` (commented template), `findProjectRoot()` (upward traversal), `configExists()`, `ConfigSchema` (Zod schema), `Config` (inferred type), `getDefaultConcurrency()` (memory-aware calculation), `DEFAULT_VENDOR_DIRS`/`DEFAULT_EXCLUDE_PATTERNS`/`DEFAULT_BINARY_EXTENSIONS`.

**[core/](./core/)** — Programmatic API for embedding ARE in non-CLI contexts via `'agents-reverse-engineer/core'` package.json export. Re-exports 60+ symbols: `AIService`, `AIProvider`, `withRetry()`, `discoverFiles()`, `buildFilePrompt()`, `buildDirectoryPrompt()`, `writeSumFile()`, `readSumFile()`, `writeAgentsMd()`, `DocumentationOrchestrator`, `runPool()`, `checkCodeVsDoc()`, `checkCodeVsCode()`, `checkPhantomPaths()`, `computeContentHash()`, `loadConfig()`. Excludes CLI dependencies (`ora`, `picocolors`, `process.exit()`). `@beta` stability.

**[discovery/](./discovery/)** — File discovery pipeline: four-stage filter chain (gitignore → vendor → binary → custom) with `walkDirectory()` (fast-glob wrapper) and `applyFilters()` (30-worker pool, short-circuit evaluation, order-preserving result aggregation). Exports `discoverFiles()` (unified pipeline), `FileFilter` interface, `FilterResult` type. Subdirectory `filters/` contains `createGitignoreFilter()`, `createVendorFilter()`, `createBinaryFilter()`, `createCustomFilter()`.

**[generation/](./generation/)** — Documentation assembly layer: `collector.ts` (recursive AGENTS.md/annex gathering), `complexity.ts` (fileCount/directoryDepth metrics), `executor.ts` (dependency graph builder with post-order sort), `types.ts` (AnalysisResult/SummaryMetadata/SummaryOptions), `prompts/` (LLM prompt templates with compression directives), `writers/` (YAML frontmatter serialization, AGENTS.md/CLAUDE.md generation with user-content preservation).

**[imports/](./imports/)** — Import statement extraction: `extractImports()` (single-file regex parsing), `extractDirectoryImports()` (100-line header scan with `./ `/`../` classification), `formatImportMap()` (prompt serialization). Powers `src/generation/prompts/builder.ts` dependency context injection.

**[installer/](./installer/)** — Interactive installer deploying command templates, session hooks, permissions to `.claude/`/`.opencode/`/`.gemini/` directories. Exports `runInstaller()` (orchestrates install/uninstall with TTY-aware prompts), `installFiles()` (template copier), `registerClaudeHooks()`/`registerGeminiHooks()` (settings.json injection via jsonc-parser), `writeVersionFile()`, `verifyInstallation()`, `uninstallFiles()`, `cleanupOrphans()`.

**[integration/](./integration/)** — Environment detection and command template generation: `detectEnvironments()` (checks `.claude/`/`.opencode/`/`.gemini/`/`.aider/` markers), `generateIntegrationFiles()` (writes runtime-specific templates), `getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()` (platform-specific frontmatter/TOML builders). Command templates implement 4-step background execution pattern (version display → npx invocation → progress polling → result summary).

**[orchestration/](./orchestration/)** — Concurrency primitives and two-phase executor: `pool.ts` (iterator-based worker pool sharing `tasks.entries()` with N workers), `orchestrator.ts` (DocumentationOrchestrator: createPlan/preparePlan with dirty propagation), `runner.ts` (CommandRunner: five-phase executor with quality gates), `progress.ts` (ProgressReporter with ETA calculation, ProgressLog mirror to `.agents-reverse-engineer/progress.log`), `plan-tracker.ts` (serialized GENERATION-PLAN.md checkbox updates), `trace.ts` (NDJSON event emitter with 14 event types).

**[output/](./output/)** — Terminal logging facade: `createLogger()` (conditional picocolors wrapping), `createSilentLogger()` (no-op stubs). Exports `Logger` interface (`info`, `file`, `excluded`, `summary`, `warn`, `error`) consumed by discovery/orchestration subsystems.

**[quality/](./quality/)** — Three-validator quality gate system: `code-vs-doc` (undocumented export detection via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`), `code-vs-code` (duplicate symbol detection), `phantom-paths` (AGENTS.md path validation via markdown links + backtick paths + prose references with dual-resolution strategy + `.js`→`.ts` substitution), `density` (stub awaiting metadata-driven implementation). Exports `checkCodeVsDoc()`, `checkCodeVsCode()`, `checkPhantomPaths()`, `buildInconsistencyReport()`, `formatReportForCli()`.

**[rebuild/](./rebuild/)** — AI-driven project reconstruction: `readSpecFiles()` (discovers `specs/*.md`), `partitionSpec()` (extracts Build Plan phases via regex), `CheckpointManager` (resume state persistence with spec drift detection via SHA-256), `executeRebuild()` (sequential order groups with concurrent pool per group), `parseModuleOutput()` (delimiter format parser with fenced-block fallback), `buildRebuildPrompt()` (context accumulation with 100KB truncation). Exports `RebuildCheckpoint`, `RebuildUnit`, `RebuildPlan`, `RebuildResult`.

**[specify/](./specify/)** — AGENTS.md → project specification transformation: `buildSpecPrompt()` (generates 12-section prompt templates with verbatim reproduction mandates for behavioral contracts), `writeSpec()` (single-file or multi-file with heading-based splitting + slug-based filenames), `SpecExistsError` (conflict exception). Exports `SpecPrompt`, `SPEC_SYSTEM_PROMPT`, `WriteSpecOptions`.

**[types/](./types/)** — Shared discovery pipeline types: `DiscoveryResult` (included/excluded file arrays), `DiscoveryStats` (aggregated counts + exclusion reason histograms), `ExcludedFile` (path/reason pairs). Consumed by walker, CLI, and four-filter chain.

**[update/](./update/)** — Incremental documentation update subsystem: `UpdateOrchestrator` (change detection → staleness check → file regeneration → orphan cleanup → directory aggregation), `cleanupOrphans()` (deletes `.sum`/`.annex.sum` for deleted/renamed files), `cleanupEmptyDirectoryDocs()` (prunes AGENTS.md from empty directories), `getAffectedDirectories()` (parent path collection with depth-descending sort). Exports `UpdatePlan`, `UpdateOptions`, `UpdateResult`, `CleanupResult`.

## Architecture

### Two-Phase Documentation Pipeline

**Phase 1 (File Analysis)**: `generation/orchestrator.ts` `createPlan()` → `prepareFiles()` (reads content, skips EACCES) → `createFileTasks()` (builds prompts via `generation/prompts/builder.ts` `buildFilePrompt()` injecting import maps + project structure, nullifies content after to free memory) → `orchestration/runner.ts` `executeGenerate()` → `orchestration/pool.ts` `runPool()` with user concurrency → `ai/service.ts` `AIService.call()` → `ai/backends/claude.ts` spawns subprocess → `generation/writers/sum.ts` `writeSumFile()` with SHA-256 `content_hash` frontmatter → `orchestration/plan-tracker.ts` `PlanTracker.markDone()` via serialized callback.

**Phase 2 (Directory Aggregation)**: `orchestrator.ts` `createPlan()` → `createDirectoryTasks()` (groups files by `path.dirname()`, creates tasks with `directoryInfo: { sumFiles, fileCount }`) → `executor.ts` `buildExecutionPlan()` sorts by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending) → `runner.ts` groups by depth → sequential depth-level batches with parallel execution within level → `generation/prompts/builder.ts` `buildDirectoryPrompt()` (parallel reads child `.sum` via `readSumFile()`, extracts imports, detects manifests) → `AIService.call()` → `generation/writers/agents-md.ts` `writeAgentsMd()` (renames user AGENTS.md → AGENTS.local.md, injects `@AGENTS.local.md`) → root `generation/writers/claude-md.ts` `writeClaudeMdPointer()`.

### Concurrency Control

`orchestration/pool.ts` `runPool<T>(tasks, options, onComplete?)` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator. Each worker loops `for (const [index, task] of iterator)` pulling next `[index, task]` pair when previous completes. Maintains full utilization during variable-duration tasks. Supports abort-on-error via `aborted` flag. Optional `onComplete` callback enables serialized updates (`PlanTracker.markDone()`, `ProgressLog.write()` via promise-chain pattern).

### Update Strategy

`update/orchestrator.ts` `UpdateOrchestrator.preparePlan()` → `discovery/run.ts` `discoverFiles()` → iterate files reading `.sum` via `generation/writers/sum.ts` `readSumFile()` → compare `sumContent.contentHash` against `change-detection/detector.ts` `computeContentHash()` → populate `filesToAnalyze` on mismatch → `update/orphan-cleaner.ts` `cleanupOrphans()` (deletes `.sum`/`.annex.sum` for git-deleted files) → `runner.ts` executes phase-1 only → `getAffectedDirectories()` sorts by depth descending → caller regenerates `AGENTS.md` sequentially.

### Quality Gates

`orchestration/runner.ts` `CommandRunner.run()` five-phase executor:

1. **Pre-Phase-1 (Cache)**: reads existing `.sum` into `oldSumCache` via `runPool()` concurrency 20
2. **Phase-1 (Files)**: parallel AI calls → `writeSumFile()`/`writeAnnexFile()` → throttled quality checks per directory group
3. **Post-Phase-1 (Quality)**: groups processed files by directory, runs throttled `quality/inconsistency/code-vs-doc.ts` `checkCodeVsDoc()` + `quality/inconsistency/code-vs-code.ts` `checkCodeVsCode()` (concurrency 10 per group), aggregates via `quality/inconsistency/reporter.ts` `buildInconsistencyReport()`
4. **Phase-2 (Directories)**: depth-grouped sequential batches → `writeAgentsMd()` → `writeClaudeMdPointer()`
5. **Post-Phase-2 (Phantom Paths)**: iterates directory tasks, reads generated `AGENTS.md`, runs `quality/phantom-paths/validator.ts` `checkPhantomPaths()`

### Telemetry Pipeline

`ai/service.ts` `AIService` wraps `ai/providers/subprocess.ts` `SubprocessProvider.call()` in `ai/retry.ts` `withRetry()` (exponential backoff: `min(1000 * 2^attempt, 8000) + random(500)` for RATE_LIMIT errors), records `ai/telemetry/run-log.ts` `TelemetryEntry` via `ai/telemetry/logger.ts` `TelemetryLogger.addEntry()` (timestamp/prompt/response/tokens/cache/latency/exitCode/retryCount/thinking/filesRead), optional `orchestration/trace.ts` `TraceWriter` emits NDJSON to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` (14 event types with `seq`/`ts`/`pid`/`elapsedMs`). `AIService.finalize()` writes `ai/telemetry/run-log.ts` `RunLog` to `.agents-reverse-engineer/logs/run-{timestamp}.json`, calls `ai/telemetry/cleanup.ts` `cleanupOldLogs()` enforcing `config.ai.telemetry.keepRuns` retention.

### Rebuild Workflow

`rebuild/spec-reader.ts` `readSpecFiles()` discovers `specs/*.md` → `partitionSpec()` extracts Build Plan phases via `/^### Phase (\d+):\s*(.+)$/gm` → `rebuild/checkpoint.ts` `CheckpointManager.load()` validates `.rebuild-checkpoint` JSON with spec drift detection (SHA-256 hash comparison) → `rebuild/orchestrator.ts` `executeRebuild()` groups `RebuildUnit[]` by `order` → sequential groups with concurrent `runPool()` per group → `rebuild/prompts.ts` `buildRebuildPrompt()` (injects Architecture + targeted subsections from spec, accumulates `builtContext` truncated at 100KB) → `AIService.call()` → `rebuild/output-parser.ts` `parseModuleOutput()` (delimiter format: `===FILE: path===` / `===END_FILE===` with column-0 requirement) → writes files → `CheckpointManager.markDone()` serialized updates.

## Behavioral Contracts

### Concurrency Calculation
```javascript
concurrency = Math.max(MIN_CONCURRENCY, Math.min(cores * CONCURRENCY_MULTIPLIER, memCap, MAX_CONCURRENCY))
memCap = Math.floor(totalMemGB * MEMORY_FRACTION / SUBPROCESS_HEAP_GB)
// Constants: MIN_CONCURRENCY=2, MAX_CONCURRENCY=20, CONCURRENCY_MULTIPLIER=5
// SUBPROCESS_HEAP_GB=0.512, MEMORY_FRACTION=0.5
```

### Exponential Backoff
```javascript
delay = Math.min(baseDelayMs * multiplier^attempt, maxDelayMs) + Math.random() * 500
// Defaults: baseDelayMs=1000, multiplier=2, maxDelayMs=8000, jitter=[0,500ms]
```

### Retry Policy
```javascript
isRetryable: err => err.code === 'RATE_LIMIT'
// Timeouts NOT retried (subprocess overhead on struggling systems)
```

### Timeout Escalation
- SIGTERM at `options.timeoutMs` via `execFile()` timeout option
- SIGKILL at `options.timeoutMs + 5000ms` via `setTimeout(() => process.kill(-childPid, 'SIGKILL'), ...)` targeting process group

### Post-Order Sort
```javascript
getDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth
// getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length
```

### Import Extraction
```regex
/^[ \t]*import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm
```
Captures: group 1 (type keyword), group 2 (named symbols), group 3 (namespace), group 4 (default), group 5 (specifier).

### Export Extraction
```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```
Captures identifier in group 1.

### Rate Limit Detection
```javascript
['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))
```

### Version Resolution Priority
1. Project-local: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`
2. Global: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`
3. Fallback: `'unknown'`

### Exit Codes
- **0**: All tasks succeeded or no tasks to process
- **1**: Partial failure (some tasks failed but some succeeded)
- **2**: Total failure (all tasks failed or CLI not found)

### Generated File Marker
```javascript
GENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'
```

### Compression Injection Condition
```javascript
compressionRatio < 0.5 && sourceFileSize > 0
```

### Compression Calculation
```javascript
targetSize = Math.round(sourceFileSize * compressionRatio)
maxSize = Math.round(targetSize * 1.2)
compressionPercentage = Math.round(compressionRatio * 100)
```

## Stack

- **Runtime**: Node.js >=18.0.0, ES modules (`"type": "module"`)
- **Language**: TypeScript 5.7.3 targeting ES2022 with NodeNext module resolution
- **Concurrency**: Iterator-based worker pool, shared iterator, N workers (orchestration/pool.ts)
- **File Discovery**: fast-glob@3.3.3 with ignore@7.0.3 (gitignore filtering)
- **Git Operations**: simple-git@3.27.0 for change detection (change-detection/detector.ts)
- **Config Parsing**: yaml@2.7.0 + zod@3.24.1 schema validation (config/schema.ts)
- **JSON Editing**: jsonc-parser@3.3.1 for settings.json hook registration (installer/operations.ts)
- **Binary Detection**: isbinaryfile@5.0.4 for `.sum` exclusion (discovery/filters/binary.ts)
- **Terminal UI**: ora@8.1.1 (spinners), picocolors@1.1.1 (colored output)
- **AI Backends**: subprocess spawning (ai/subprocess.ts) targeting `claude`, `gemini`, `opencode` CLIs
- **Build**: tsc (TypeScript compiler), tsx@4.19.2 (dev watch mode)