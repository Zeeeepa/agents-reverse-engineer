<!-- Generated by agents-reverse-engineer -->

# src

**TypeScript source tree containing CLI entry points, three-phase AI orchestration pipeline, file discovery filters, configuration management, subprocess-spawning AI service layer, quality validators, and IDE integration installers for agents-reverse-engineer brownfield documentation generator.**

## Contents

**[version.ts](./version.ts)** — `getVersion()` reads `package.json` from compiled module parent directory (dist/ → project root) via `fileURLToPath(import.meta.url)` → `dirname()` → `join(__dirname, '..', 'package.json')`, parses JSON extracting `version` field, returns `'unknown'` on error (file not found, JSON parse failure, missing field). Called by CLI help text, version flag output, session hooks for npm registry comparison.

## Subdirectories

**[ai/](./ai/)** — Backend-agnostic AI service orchestration: subprocess-spawning adapters (ClaudeBackend with Zod JSON parsing, GeminiBackend/OpenCodeBackend stubs), exponential backoff retry with rate limit detection (['rate limit', '429', 'too many requests', 'overloaded']), timeout enforcement (SIGTERM at timeoutMs, SIGKILL after 5s, process group killing `kill(-pid)`), NDJSON telemetry logging to `.agents-reverse-engineer/logs/run-<timestamp>.json` with token/cost tracking, trace emission (subprocess:spawn/exit/retry).

**[change-detection/](./change-detection/)** — Git-based change detection parsing `git diff --name-status -M` with rename detection, merges uncommitted working tree changes via `status.modified[]`/`deleted[]`/`not_added[]`/`staged[]`, SHA-256 content hashing for `.sum` frontmatter verification, returns `ChangeDetectionResult` with `FileChange[]` array (path/status/oldPath/contentHash), status codes map to `ChangeType` ('added'/'modified'/'deleted'/'renamed').

**[cli/](./cli/)** — Command entry points routing parsed `process.argv` to handlers: `initCommand()` writes config YAML, `cleanCommand()` deletes artifacts with `GENERATED_MARKER` filtering, `discoverCommand()` builds `GENERATION-PLAN.md`, `generateCommand()` orchestrates three-phase pipeline with backend resolution, `updateCommand()` executes incremental hash-based regeneration, `specifyCommand()` synthesizes project specifications from AGENTS.md corpus. Main index parses flags via `parseArgs()` with short flag expansion (`-h` → `help`, `-g` → `global`), dual routing for installer mode vs. command dispatch, exit codes (0=success, 1=partial failure, 2=total failure/CLI not found).

**[config/](./config/)** — Configuration management: `loadConfig()` reads `.agents-reverse-engineer/config.yaml` via YAML parsing and `ConfigSchema.parse()` Zod validation (returns defaults on ENOENT, throws `ConfigError` on ZodError), `writeDefaultConfig()` generates commented template with inline defaults, `getDefaultConcurrency()` computes adaptive worker pool size via `clamp(cores * 5, 2, min(memCap, 20))` where `memCap = floor((totalMemGB * 0.5) / 0.512)`, default exclusions (26 patterns, 18 vendor dirs, 26 binary extensions).

**[discovery/](./discovery/)** — File discovery pipeline: `discoverFiles()` creates four-filter chain (GitignoreFilter → VendorFilter → BinaryFilter → CustomPatternFilter), `walkDirectory()` via `fast-glob` with `{absolute: true, onlyFiles: true, ignore: ['**/.git/**']}`, `applyFilters()` with 30-worker concurrency and short-circuit evaluation, returns `FilterResult` with `included[]`/`excluded[]` attribution. Filters normalize paths via `path.relative(normalizedRoot, absolutePath)` for pattern matching.

**[generation/](./generation/)** — Three-phase orchestration: `GenerationOrchestrator.createPlan()` executes file discovery → `analyzeComplexity()` → `buildFilePrompt()` per file with `projectPlan` injection → groups by `path.dirname()` for directory tasks → `buildExecutionPlan()` post-order traversal (sorted by depth descending) → memory management clears `PreparedFile.content` fields after embedding. `buildDirectoryPrompt()` reads `.sum` frontmatter, child `AGENTS.md`, import maps via `extractDirectoryImports()`, detects 9 manifest types. `buildRootPrompt()` calls `collectAgentsDocs()`, parses root `package.json`, enforces synthesis-only constraints. Writers serialize YAML frontmatter (adaptive array formatting), preserve user content via `AGENTS.local.md` rename pattern.

**[imports/](./imports/)** — Static import analysis: `extractImports()` applies `IMPORT_REGEX` (`/^import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm`) extracting ES module syntax into `ImportEntry[]`, `extractDirectoryImports()` scans first 100 lines per file for optimization, partitions relative imports into `internal` (`./`) and `external` (`../`), filters bare specifiers (`'react'`, `node:*`), `formatImportMap()` serializes into prompt text blocks with `(type)` suffix.

**[installer/](./installer/)** — npx installation orchestrator: `runInstall()` parses CLI args (`-g`/`-l`/`--runtime`/`--force`), interactive prompts via `selectRuntime()`/`selectLocation()` with arrow-key selection in TTY mode, `installFilesForRuntime()` writes command templates from `src/integration/templates.ts` and copies bundled hooks from `hooks/dist/`, registers hooks in `settings.json` via `registerClaudeHooks()`/`registerGeminiHooks()`, writes `ARE-VERSION` file, adds Bash permission patterns to Claude Code allow list. Uninstaller removes files, hook registrations, permissions, cleans empty skill directories via `cleanupAreSkillDirs()`/`cleanupLegacyGeminiFiles()`/`cleanupEmptyDirs()`.

**[integration/](./integration/)** — Platform-specific AI assistant integration: `detectEnvironments()` scans for Claude (`.claude/` or `CLAUDE.md`), OpenCode (`.opencode/`), Aider (`.aider.conf.yml` or `.aider/`) via `existsSync()`, `getTemplatesForRuntime()` generates command files with placeholder substitution for `COMMAND_PREFIX` (`/are-`), `VERSION_FILE_PATH`, `$ARGUMENTS`, embeds background execution pattern with `run_in_background: true`, `TaskOutput` polling, `.agents-reverse-engineer/progress.log` monitoring. `generateIntegrationFiles()` writes templates via `ensureDir()` → `writeFileSync()` chain, copies bundled hooks for Claude.

**[orchestration/](./orchestration/)** — Iterator-based worker pool orchestrating three-phase execution: `runPool()` shares single `tasks.entries()` iterator across N workers preventing idle time, emits `worker:start/end` and `task:pickup/done` trace events, supports `failFast` abort via mutable flag. `CommandRunner.executeGenerate()` runs concurrent file `.sum` generation with stale-doc detection, post-order directory `AGENTS.md` traversal grouped by depth, sequential root document synthesis (`CLAUDE.md`/`GEMINI.md`/`OPENCODE.md`), embeds quality validators post-phase (code-vs-doc, code-vs-code, phantom-paths). `ProgressReporter` streams colored console output with ETA via moving average (last 10 completion times), `ProgressLog` mirrors to `.agents-reverse-engineer/progress.log` via promise-chain serialized writes. `PlanTracker` serializes concurrent checkbox updates (`- [ ] → - [x]`) for `GENERATION-PLAN.md` via promise-chain pattern. `TraceWriter` appends to `.agents-reverse-engineer/traces/trace-<timestamp>.ndjson` with auto-populated `seq`/`ts`/`pid`/`elapsedMs` base fields, `cleanupOldTraces()` enforces 500-file retention.

**[output/](./output/)** — Terminal output formatting: `createLogger()` factory with picocolors-based ANSI formatting when `options.colors` is true, `createSilentLogger()` no-op for tests, `Logger` interface (six methods: `info()`, `file()`, `excluded()`, `summary()`, `warn()`, `error()`), output routing (log/warn/error → stdout/stderr).

**[quality/](./quality/)** — Code-documentation consistency validation: `checkCodeVsDoc()` extracts exports via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` with substring verification against `.sum` content, `checkCodeVsCode()` aggregates exports into `Map<symbol, paths[]>` for duplicate detection, `checkPhantomPaths()` extracts path references via three regex patterns (markdown links, backtick paths, prose references) resolving against `AGENTS.md` directory and project root with `.ts`/`.js` fallback. `buildInconsistencyReport()` merges issues with summary counts by type (`code-vs-doc`/`code-vs-code`/`phantom-path`) and severity (`error`/`warning`/`info`).

**[specify/](./specify/)** — Specification synthesis: `buildSpecPrompt()` constructs system/user prompts enforcing nine-section structure (Overview, Architecture, API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts, Test Contracts, Build Plan) with verbatim regex/format/constant preservation, `writeSpec()` writes single-file or multi-file specifications via heading-based splitting (`splitByHeadings()` partitions on `/^# /m`, `slugify()` sanitizes heading text), throws `SpecExistsError` when targets exist and `force: false`.

**[types/](./types/)** — Shared interfaces for discovery results (`ExcludedFile`, `DiscoveryResult`, `DiscoveryStats` with `exclusionReasons` histogram), consumed by `src/discovery/walker.ts`, `src/cli/discover.ts`, `src/orchestration/runner.ts`.

**[update/](./update/)** — Incremental documentation synchronization: `UpdateOrchestrator.preparePlan()` executes hash-based change detection via `readSumFile()` YAML frontmatter extraction, `computeContentHash()` SHA-256 comparison, produces `UpdatePlan` with `filesToAnalyze[]` (hash mismatch/missing), `filesToSkip[]` (hash match), `cleanup: CleanupResult` (orphaned `.sum` files), `affectedDirs[]` (depth-sorted parent directories). `cleanupOrphans()` deletes `.sum` files for `FileChange` entries with `status === 'deleted'` (uses `change.path`) or `status === 'renamed'` (uses `change.oldPath`). `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories containing only hidden files, `.sum` files, or generated artifacts. `getAffectedDirectories()` walks parent directories via `path.dirname()` excluding deletes.

## Three-Phase Pipeline Architecture

**Phase 1 (File Analysis)** — Concurrent pool execution (default 2 workers for WSL, 5 elsewhere): `GenerationOrchestrator.createFileTasks()` invokes `buildFilePrompt()` per file embedding content + project structure, workers execute via `runPool()` calling `AIService.call()` → `runSubprocess()` → `execFile()` spawning AI CLI subprocesses with resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`, `--disallowedTools Task`). Results written via `writeSumFile()` to `.sum` paths with YAML frontmatter (`generated_at`, `content_hash`, `purpose`, `critical_todos`, `related_files`). Post-phase quality validation: throttled (concurrency=10) `checkCodeVsDoc()` comparing old vs. new `.sum` against source content, `checkCodeVsCode()` for duplicate symbol detection.

**Phase 2 (Directory Aggregation)** — Post-order traversal: `GenerationOrchestrator.createDirectoryTasks()` groups files via `Map<dirname, PreparedFile[]>`, executor sorts tasks by `getDirectoryDepth()` descending (deepest first), waits for child `.sum` files via `isDirectoryComplete()`, constructs prompts via `buildDirectoryPrompt()` consuming `.sum` frontmatter + child `AGENTS.md` + import maps from `extractDirectoryImports()`. Writes via `writeAgentsMd()` preserving user content from `AGENTS.local.md`. Post-phase: runs `checkPhantomPaths()` on each generated `AGENTS.md` (three regex patterns for path extraction), aggregates issues into `phantomReport`.

**Phase 3 (Root Synthesis)** — Sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` via `buildRootPrompt()` aggregating all `AGENTS.md` via `collectAgentsDocs()`, parsing root `package.json`, enforcing synthesis-only constraints (no invention). Strips conversational preamble via pattern matching before writing output.

## Subprocess Resource Management

AI CLI spawning mitigations for Claude #5771 (200 NodeJS instances): `NODE_OPTIONS='--max-old-space-size=512'` limits heap to 512MB per subprocess, `UV_THREADPOOL_SIZE='4'` constrains libuv thread pool to 4 threads, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` prevents background task spawning, `--disallowedTools Task` blocks subagents. Process group killing: `kill(-pid)` terminates entire subprocess tree. Timeout enforcement: SIGTERM sent at `timeoutMs`, SIGKILL escalation after 5s grace period. Default concurrency reduced from 5 → 2 for resource-constrained environments.

## Incremental Update Strategy

`UpdateOrchestrator.preparePlan()` workflow: (1) read `content_hash` from `.sum` YAML frontmatter via `readSumFile()`, (2) compute current SHA-256 via `computeContentHash()`, (3) hash mismatch → add to `filesToAnalyze` as `FileChange` with `status: 'modified'`/`'added'`, (4) hash match → add to `filesToSkip`, (5) detect orphans: `.sum` files for deleted source files or renamed oldPaths, (6) call `cleanupOrphans()` to delete stale `.sum` files, (7) call `cleanupEmptyDirectoryDocs()` to remove `AGENTS.md` from directories with no remaining sources, (8) compute `affectedDirs` via `getAffectedDirectories()` walking parent directories of changed files, (9) regenerate `.sum` for `filesToAnalyze` via Phase 1 pool execution, (10) regenerate `AGENTS.md` for `affectedDirs` sequentially (no Phase 2 post-order traversal required). Git integration: supports committed changes (`git diff <baseCommit>..HEAD`) and uncommitted (`git status --porcelain` merge via `--uncommitted` flag), rename detection via `git diff -M` (50% similarity threshold), fallback to SHA-256 hashing for non-git workflows.

## Behavioral Contracts

**GENERATED_MARKER:** `<!-- Generated by agents-reverse-engineer -->`

**Frontmatter extraction regex:** `/^---\n([\s\S]*?)\n---\n/`

**YAML field patterns:**
```javascript
/generated_at:\s*(.+)/
/content_hash:\s*(.+)/
/purpose:\s*(.+)/
/key:\s*\[([^\]]*)\]/  // Inline arrays
/key:\s*\n((?:\s+-\s+.+\n?)+)/m  // Multi-line arrays
```

**Array formatting heuristic:** Inline if `length <= 3` and all items `< 40` chars, multi-line otherwise.

**Export extraction regex:** `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`

**Path extraction patterns (phantom-paths):**
```javascript
/\[(?:[^\]]*)\]\((\.[^)]+)\)/g              // Markdown: [text](./path)
/`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g  // Backtick: `src/foo.ts`
/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi // Prose: "from src/foo/"
```

**Rate limit detection patterns:** `['rate limit', '429', 'too many requests', 'overloaded'].some(p => stderr.toLowerCase().includes(p))`

**Preamble stripping patterns:**
1. YAML separator: `/\n---\n/` within first 500 chars
2. Bold uppercase start: `/^[\s\S]{0,500}?(\*\*[A-Z])/` matches conversational preamble, strips if <300 chars and no `##` headers

**Skip directories:** `Set(['node_modules', '.git', '.agents-reverse-engineer', 'vendor', 'dist', 'build', '__pycache__', '.next', 'venv', '.venv', 'target', '.cargo', '.gradle'])`

**Manifest detection:** `['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']`