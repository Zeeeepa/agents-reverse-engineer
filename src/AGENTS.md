<!-- Generated by agents-reverse-engineer -->

# src/

Core TypeScript implementation of the agents-reverse-engineer CLI tool, implementing a three-phase Recursive Language Model (RLM) algorithm that orchestrates concurrent file analysis, post-order directory aggregation, and root document synthesis across Claude Code, Gemini CLI, and OpenCode backends.

## Subdirectories

**[cli/](./cli/)** — Command entry points parsing `process.argv` via `parseArgs()`, routing to seven handlers (`init`, `discover`, `generate`, `update`, `specify`, `clean`, install/uninstall) with shared argument parsing for `--debug`, `--trace`, `--concurrency`, `--dry-run`, `--fail-fast` flags. Resolves AI backend via `createBackendRegistry()`, creates `CommandRunner` for pipeline execution, threads `ITraceWriter` through orchestration layers, calls `aiService.finalize()` and `cleanupOldTraces()` before exit, handles `AIServiceError` with `code='CLI_NOT_FOUND'` to display `getInstallInstructions()` and exit with code 2.

**[config/](./config/)** — Configuration loading with YAML parsing and Zod validation. `loadConfig()` reads `.agents-reverse-engineer/config.yaml`, falling back to `DEFAULT_CONFIG` on ENOENT. `ConfigSchema` composes `ExcludeSchema`, `OptionsSchema`, `OutputSchema`, `AISchema` for patterns/vendorDirs/binaryExtensions, followSymlinks/maxFileSize, color output, backend/model/timeoutMs/maxRetries/concurrency/telemetry. `writeDefaultConfig()` generates annotated YAML with six comment sections. `ConfigError` wraps ZodError with bullet-formatted issue list.

**[integration/](./integration/)** — Multi-platform AI assistant integration generating command files and hooks. `detectEnvironments()` scans for `.claude/`, `.opencode/`, `.aider.conf.yml`, `.gemini/` directories. `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` return `IntegrationTemplate[]` with platform-specific frontmatter (YAML for Claude/OpenCode, TOML for Gemini). `generateIntegrationFiles()` writes skills/commands to `.claude/skills/`, `.opencode/commands/`, `.gemini/commands/`, copies bundled `are-session-end.js` for Claude via `readBundledHook()`, returns `IntegrationResult[]` with `filesCreated`/`filesSkipped` arrays.

**[ai/](./ai/)** — Backend-agnostic AI service layer with subprocess management, retry logic, telemetry logging, and trace emission. `AIService` interface defines `call()`, `finalize()`, `setDebug()`, `setSubprocessLogDir()` methods. `createBackendRegistry()` auto-detects Claude/Gemini/OpenCode CLIs via `execFile()`. `runSubprocess()` spawns child processes with `NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`, enforces timeout via SIGTERM→SIGKILL escalation, retries on rate limits via exponential backoff, emits `subprocess:spawn/exit/retry` trace events, logs prompts/responses when debug enabled.

**[discovery/](./discovery/)** — Directory walker with composable filter chain (gitignore, binary, vendor, custom) applying predicates via `filterResults()`. `walkDirectory()` recursively lists files with optional symlink following. Filters: `GitignoreFilter` (parses `.gitignore` via `ignore` library), `BinaryFilter` (extension check + `isBinaryFile()` content analysis), `VendorFilter` (exact match against DEFAULT_VENDOR_DIRS), `CustomPatternFilter` (micromatch glob evaluation). `discoverFiles()` coordinates filters, returns `DiscoveryResult` with `includedFiles`, `excludedFiles`, `categories`, `reasons` for telemetry aggregation.

**[generation/](./generation/)** — Three-phase pipeline orchestration and prompt engineering. `GenerationOrchestrator` builds `GenerationPlan` via `createPlan()`, executes via `CommandRunner.executeGenerate()`. `buildFilePrompt()` includes import map, content, manifest detection. `buildDirectoryPrompt()` aggregates child `.sum` files, subdirectory `AGENTS.md`, user-authored `AGENTS.local.md`. `buildClaudeMdPrompt()`, `buildGeminiMdPrompt()`, `buildOpenCodeMdPrompt()` consume all `AGENTS.md` via `collectAgentsDocs()`. Writers: `writeSumFile()` (YAML frontmatter + markdown), `writeAgentsMd()` (prepends `AGENTS.local.md` above `GENERATED_MARKER`), `writeRootDoc()`.

**[orchestration/](./orchestration/)** — Iterator-based worker pool, progress reporting, trace emission, plan tracking. `WorkerPool` shares single `createIteratorFromArray()` across N workers, executes `taskFn` with `WorkerContext`, aggregates results via `onTaskDone()` callbacks. `ProgressReporter` computes ETA via moving average of last 10 task durations, logs phase headers, file paths, token metrics. `TraceWriter` serializes NDJSON events via promise chain, auto-populates `seq`/`ts`/`pid`/`elapsedMs` fields, calls `cleanupOldTraces()` with keepCount=500. `PlanTracker` serializes writes to `GENERATION-PLAN.md` and `.agents-reverse-engineer/progress.log`.

**[change-detection/](./change-detection/)** — Git-based delta computation and SHA-256 hashing. `detectChanges()` parses `git diff --name-status -M` for added/modified/deleted/renamed files, optionally merges `git status --porceloin` uncommitted changes. `computeContentHash()` returns SHA-256 hex digest. `readSumFile()` extracts `content_hash` from YAML frontmatter. `getAffectedDirectories()` walks parent directories of changed files via `path.dirname()` loop until projectRoot.

**[update/](./update/)** — Incremental update workflow with orphan cleanup. `UpdateOrchestrator.preparePlan()` compares `content_hash` from `.sum` frontmatter against `computeContentHash()`, building `filesToAnalyze` (added/modified), `filesToSkip`, `orphanSums` (deleted source files), `affectedDirs`. `cleanupOrphans()` deletes stale `.sum` files. `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with no remaining sources. Phase 2 regenerates affected directory docs sequentially.

**[quality/](./quality/)** — Post-generation validators with three inconsistency detectors. `validateCodeDocConsistency()` extracts exported symbols via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` regex, verifies presence in `.sum` text via substring search. `validateCodeCodeConsistency()` aggregates exports into `Map<symbol, string[]>`, reports duplicates. `validatePhantomPaths()` extracts paths via three regexes (markdown links, backtick-quoted, prose-embedded), resolves against `AGENTS.md` directory and projectRoot with `.ts`/`.js` fallback, reports unresolved. Returns `InconsistencyReport` with `metadata`/`issues`/`summary`.

**[imports/](./imports/)** — Static import analysis for dependency graphs. `extractImports()` applies regex patterns to source text: ES6 (`/from\s+['"]([^'"]+)['"]/g`), CommonJS (`/require\(["']([^"']+)["']\)/g`), TypeScript path mappings. `resolveImportPath()` normalizes relative paths via `path.resolve()`, distinguishes local vs. external modules. `extractDirectoryImports()` aggregates imports across all files in directory, returns unique sorted list for prompt inclusion.

**[output/](./output/)** — Terminal logging with picocolors formatting. `createLogger()` returns object with `info()`, `warn()`, `error()`, `success()`, `file()`, `excluded()` methods applying ANSI color codes via `pc.green()`, `pc.yellow()`, `pc.red()`, `pc.cyan()`, `pc.dim()`. `ProgressLog` writes streaming output to `.agents-reverse-engineer/progress.log` mirroring console, calls `finalize()` to append summary statistics.

**[specify/](./specify/)** — Project specification synthesis from `AGENTS.md` corpus. `buildSpecPrompt()` aggregates all directory docs via `collectAgentsDocs()`, parses root `package.json` for project metadata, instructs synthesis-only constraints (no invention of features not in source documents). `writeSpec()` handles single-file output to `specs/SPEC.md` or multi-file split to `specs/<dirname>.md`, throws `SpecExistsError` when `force: false` and file exists.

**[types/](./types/)** — Shared TypeScript interfaces for discovery results. `DiscoveredFile` (`path`, `sizeBytes`, `excluded`, `reason`), `DiscoveryResult` (`includedFiles`, `excludedFiles`, `categories`, `reasons`), `FileCategory` union (`'source' | 'config' | 'doc' | 'test' | 'vendor' | 'binary' | 'other'`).

**[installer/](./installer/)** — npx-based command/hook installation for IDE runtimes. `runInstaller()` prompts for runtime (Claude/Gemini/OpenCode) and scope (global/local), resolves config directories via `resolveConfigDirs()` with environment overrides (`CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`), copies skills/commands from `integration/` templates, installs hooks from `hooks/dist/`, registers permissions. `parseInstallerArgs()` extracts `--runtime`, `-g`, `-l` flags from CLI. Supports uninstall mode deleting registered files.