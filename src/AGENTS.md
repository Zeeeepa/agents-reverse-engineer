<!-- Generated by agents-reverse-engineer -->

# src

Root source directory for agents-reverse-engineer (ARE) CLI tool providing AI-driven codebase documentation generation via two-phase pipeline: parallel file analysis producing `.sum` summaries followed by post-order directory aggregation producing `AGENTS.md` hierarchies.

## Contents

### [version.ts](./version.ts)
`getVersion()` reads `version` field from package.json via ESM `import.meta.url` resolution and `fileURLToPath()`, returns `"unknown"` on read/parse failure, consumed by `src/cli/index.ts` for `--version` flag and `src/installer/banner.ts` for installation UI.

## Subdirectories

### [ai/](./ai/)
Multi-backend LLM orchestration layer exposing `AIService` with `call(options)`, `finalize(projectRoot)` methods. Spawns CLI subprocesses (`claude`, `gemini`, `opencode`) via `runSubprocess()` with SIGTERM/SIGKILL timeout escalation, wraps calls in exponential backoff retry logic via `withRetry()` for transient `RATE_LIMIT` errors, records `TelemetryEntry` per-call with token counts and latency, emits subprocess lifecycle events to `ITraceWriter`, persists NDJSON run logs to `.agents-reverse-engineer/logs/`.

### [change-detection/](./change-detection/)
Git-based change detection for incremental updates. `getChangedFiles(projectRoot, baseCommit)` parses `git diff --name-status -M` output into `FileChange[]` with `status: 'added' | 'modified' | 'deleted' | 'renamed'`. `computeContentHash(filePath)` generates SHA-256 hex digests for frontmatter-based staleness detection in `src/update/orchestrator.ts`.

### [cli/](./cli/)
Command-line interface entry point dispatching to eight command modules. `index.ts` routes via `parseArgs()` recognizing `-h`, `--help`, `-V`, `--version`, `--runtime`, `--dry-run`, `--trace`, `--debug` flags. Commands: `initCommand` (writes `.agents-reverse-engineer/config.yaml`, updates `.gitignore`/`.vscode/settings.json`), `discoverCommand` (builds `GENERATION-PLAN.md`), `generateCommand` (executes full pipeline with concurrent pool), `updateCommand` (incremental regeneration via hash comparison), `cleanCommand` (purges `.sum`/`AGENTS.md` artifacts), `specifyCommand` (synthesizes project specs), `rebuildCommand` (reconstructs code from specs). No-args invocation launches interactive installer.

### [config/](./config/)
Configuration subsystem with YAML parsing, Zod validation, and defaults. `loadConfig(root, options)` reads `.agents-reverse-engineer/config.yaml` via `yaml.parse()` → `ConfigSchema.parse()` → merge with defaults from `getDefaultConcurrency()` (dynamic: `os.availableParallelism() * 5` clamped to memory cap), `DEFAULT_VENDOR_DIRS` (18 excluded directories), `DEFAULT_EXCLUDE_PATTERNS` (gitignore-style globs), `DEFAULT_BINARY_EXTENSIONS` (25 file types). `findProjectRoot(startDir)` walks directory tree until `.agents-reverse-engineer/` found.

### [discovery/](./discovery/)
File discovery pipeline orchestrating four-filter chain: gitignore (async `.gitignore` parsing) → vendor (path component matching) → binary (extension + content + size checks) → custom (gitignore-style patterns). `walkDirectory()` delegates to `fast-glob` with `**/*` pattern excluding `.git/`, `applyFilters()` executes bounded-concurrency evaluation (30 workers, shared iterator) with short-circuit semantics, returns `FilterResult` partitioning files into included/excluded arrays.

### [generation/](./generation/)
Two-phase documentation pipeline coordinated by `GenerationOrchestrator`. Phase 1: `createFileTasks()` builds prompts via `buildFilePrompt()` injecting import maps/project structure, parallel AI calls write `.sum` files via `writeSumFile()`. Phase 2: `createDirectoryTasks()` constructs dependency graph sorted by depth descending, post-order traversal executes `buildDirectoryPrompt()` consuming child `.sum` files, writes `AGENTS.md` via `writeAgentsMd()`, root `writeClaudeMdPointer()` generates deterministic entry point.

### [imports/](./imports/)
TypeScript/JavaScript import statement extraction using regex `/^import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm`. `extractDirectoryImports()` reads first 100 lines per file, classifies specifiers as `internal` (`./`) or `external` (`../`), excludes bare specifiers and `node:` built-ins. `formatImportMap()` serializes dependency graphs for LLM prompt context.

### [installer/](./installer/)
Cross-runtime installer copying command templates, hooks, and plugins to `~/.claude`, `~/.config/opencode`, `~/.gemini` directories. `runInstaller(args)` supports `-g`/`--global`, `-l`/`--local`, `--runtime <claude|opencode|gemini|all>`, `--force`, `--uninstall` flags. `installFiles()` writes templates to `commands/are/` subdirectories, registers hooks in settings.json via jsonc-parser, adds bash command permissions. `uninstallFiles()` removes artifacts, cleans empty directories, filters hook arrays via `getHookPatterns()`.

### [integration/](./integration/)
Environment detection and platform-specific template generation. `detectEnvironments(projectRoot)` scans for `.claude/`, `CLAUDE.md`, `.opencode/`, `.aider.conf.yml` using `existsSync()`. `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` return command definitions for `generate`, `update`, `init`, `discover`, `clean`, `specify`, `rebuild` with frontmatter/TOML formatting via `buildTemplate()`. Claude outputs `SKILL.md` in subdirectories, OpenCode/Gemini use flat structure.

### [orchestration/](./orchestration/)
Concurrency control and progress tracking engine. `runPool<T>()` implements iterator-based worker pattern (shared iterator, N workers) preventing batch-idle anti-pattern. `CommandRunner` executes five-phase workflow: pre-phase-1-cache (reads existing `.sum` for quality checks) → phase-1-files (parallel AI calls) → post-phase-1-quality (`checkCodeVsDoc`, `checkCodeVsCode`) → phase-2-dirs (depth-grouped post-order aggregation) → post-phase-2 (`checkPhantomPaths`). `TraceWriter` emits NDJSON events to `.agents-reverse-engineer/traces/`, `ProgressLog` mirrors console output to `progress.log` via promise-chain serialization.

### [output/](./output/)
Terminal presentation layer exporting `Logger` interface with `info`, `file`, `excluded`, `summary`, `warn`, `error` methods. `createLogger(options)` returns picocolors implementation with configurable color support. Discovery phase calls `file(path)` (green `+` prefix), `excluded(path, reason, filter)` (dim `-` prefix), `summary(included, excluded)` (bold counts).

### [quality/](./quality/)
Post-generation validation detecting inconsistencies via static analysis. `checkCodeVsDoc()` uses regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` to find undocumented exports. `checkCodeVsCode()` accumulates `Map<string, string[]>` for duplicate symbols. `checkPhantomPaths()` validates markdown links via `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`, backtick paths `/`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g`, prose references `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi` with multi-strategy resolution. `buildInconsistencyReport()` aggregates findings, `formatReportForCli()` emits severity-tagged output.

### [rebuild/](./rebuild/)
AI-driven project reconstruction from `.agents-reverse-engineer/specs/` markdown. `readSpecFiles()` loads all `.md` from specs directory, `partitionSpec()` extracts ordered `RebuildUnit[]` via Build Plan phase parsing (`### Phase N:` subsections) or top-level heading fallback. `executeRebuild()` processes sequential order groups with concurrent AI calls per group via `runPool()`, accumulates `builtContext` (100k char limit, truncates old files to 20 lines) for cross-phase dependency resolution. `CheckpointManager` persists state to `.rebuild-checkpoint` with drift detection via spec content hashes.

### [specify/](./specify/)
Transforms AGENTS.md documentation into project specification format. `buildSpecPrompt(docs, annexFiles)` injects collected docs with delimiters, mandates 12 sections via `SPEC_SYSTEM_PROMPT` (Overview, Architecture, Public API, Data Structures, Configuration, Dependencies, Behavioral Contracts, Test Contracts, Build Plan with Defines/Consumes cross-references, Prompt Templates verbatim, IDE Integration verbatim, File Manifest). `writeSpec(content, options)` supports single-file or multi-file mode (splits on `/^(?=# )/m`, slugifies headings), throws `SpecExistsError` on collision unless `force=true`.

### [types/](./types/)
Shared interfaces for file discovery: `ExcludedFile` (path + reason), `DiscoveryResult` (files + excluded arrays), `DiscoveryStats` (counts + exclusionReasons map). Contract between discovery filters (`src/discovery/filters/`) and orchestration (`src/discovery/run.ts`, `src/cli/discover.ts`).

### [update/](./update/)
Incremental documentation subsystem using frontmatter-based change detection. `UpdateOrchestrator.preparePlan()` reads stored `contentHash` from `.sum` YAML frontmatter via `readSumFile()`, compares against `computeContentHash()` for current file, populates `filesToAnalyze` on mismatch. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for deleted/renamed files, invokes `cleanupEmptyDirectoryDocs()` to remove AGENTS.md when no source files remain. `getAffectedDirectories()` collects parent directories, sorts by depth descending (`depthB - depthA`) for post-order regeneration.

## Architecture

### Two-Phase Pipeline

**Phase 1 (File Analysis)**: `src/generation/orchestrator.ts` creates file tasks with empty dependencies, `src/orchestration/runner.ts` executes via `runPool()` with user-configured concurrency, LLM calls via `AIService.call()` with `buildFilePrompt()`, writes `.sum` files via `writeSumFile()` including YAML frontmatter with SHA-256 `content_hash`.

**Phase 2 (Directory Aggregation)**: `createDirectoryTasks()` builds dependency graph with child file task IDs, `buildExecutionPlan()` sorts by depth descending for post-order traversal, `getReadyDirectories()` filters where `isDirectoryComplete()` confirms all `.sum` exist, sequential directory groups execute with concurrency per depth level, `buildDirectoryPrompt()` injects import maps + existing AGENTS.md for updates, `writeAgentsMd()` renames user docs → `AGENTS.local.md` and injects `@AGENTS.local.md` directive.

### Concurrency Control

`src/orchestration/pool.ts` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator. Workers pull `[index, task]` pairs until exhausted or `aborted` flag set. Maintains full utilization as tasks complete at different rates. `onComplete?: (result) => void` callback enables serialized `PlanTracker.markDone()` updates to `GENERATION-PLAN.md` checkboxes.

### Configuration Precedence

Effective model: `options.model ?? config.ai.model`. Concurrency: `options.concurrency ?? config.ai.concurrency ?? getDefaultConcurrency()` (dynamic calculation: `os.availableParallelism() * 5` clamped to memory cap). Timeout: `options.timeoutMs ?? config.ai.timeoutMs` with 15-minute minimum for rebuild command.

### Telemetry Pipeline

All commands create `AIService` instance with `TelemetryLogger` tracking per-call `TelemetryEntry` (prompt/response/tokens/latency/retryCount). Optional `TraceWriter` emits NDJSON events (`subprocess:spawn`, `subprocess:exit`, `retry`, `worker:start`, `task:done`, `phase:start`) to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` when `--trace` flag set. `aiService.finalize(projectRoot)` writes `RunLog` to `.agents-reverse-engineer/logs/run-{timestamp}.json`, invokes `cleanupOldLogs()` enforcing retention policies.

### Update Strategy

`src/update/orchestrator.ts` implements frontmatter-based staleness detection: compares `.sum` YAML `content_hash` against `computeContentHash(filePath)`, skips unchanged files, regenerates modified files via phase-1-files pipeline, collects affected directories via `getAffectedDirectories()`, sorts by depth descending, sequentially regenerates `AGENTS.md` consuming updated child `.sum` files.

## Behavioral Contracts

### CLI Argument Parsing

`src/cli/index.ts` `parseArgs()` recognizes short flags `-h`, `-g`, `-l`, `-V` mapping to `help`, `global`, `local`, `version`. Long flags `--help`, `--global`, `--local`, `--version`, `--runtime`, `--dry-run`, `--trace`, `--debug`, `--concurrency`, `--timeout`, `--force`, `--uncommitted`, `--fail-fast`. Flag-value pairs parsed as `--flag value`. First non-flag becomes command, rest populate positional array.

### Exit Codes

- **0**: all tasks succeeded or no tasks to process
- **1**: partial failure (some tasks failed but some succeeded)
- **2**: total failure (all tasks failed or CLI not found)

### Concurrency Calculation Formula

```javascript
concurrency = min(MAX_CONCURRENCY, floor(totalMemGB * 0.5 / 0.512), max(MIN_CONCURRENCY, os.availableParallelism() * 5))
```

Constants: `SUBPROCESS_HEAP_GB = 0.512`, `MEMORY_FRACTION = 0.5`, `CONCURRENCY_MULTIPLIER = 5`, `MIN_CONCURRENCY = 2`, `MAX_CONCURRENCY = 20`.

### Exponential Backoff Formula

```javascript
delay = min(baseDelayMs * multiplier^attempt, maxDelayMs) + Math.random() * 500
```

Defaults: `baseDelayMs: 1000`, `multiplier: 2`, `maxDelayMs: 8000`, jitter: [0, 500ms].

### Rate Limit Detection Patterns

```javascript
['rate limit', '429', 'too many requests', 'overloaded']
```

Matched against `stderr.toLowerCase()` in `isRateLimitStderr()` to distinguish retryable errors from permanent failures.

### Timeout Escalation

SIGTERM at `options.timeoutMs`, SIGKILL at `options.timeoutMs + 5000ms` via `process.kill(-childPid, 'SIGKILL')` targeting process group with fallback to single-process kill.

### Post-Order Sort Comparator

```javascript
getDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth
```

Where `getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length`.

### Import Extraction Regex

```regex
/^[ \t]*import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm
```

Captures: group 1 (`type` keyword), group 2 (named symbols), group 3 (namespace import), group 4 (default import), group 5 (module specifier).

### Export Extraction Regex

```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```

Captures identifier in group 1 after export keyword and declaration type.

## File Relationships

**CLI Commands** (`src/cli/`) import orchestrators from `src/generation/`, `src/update/`, `src/rebuild/`, `src/specify/`, call `AIService` from `src/ai/`, use `discoverFiles()` from `src/discovery/`, pass config from `src/config/`, emit progress via `src/orchestration/`, write artifacts via `src/generation/writers/`.

**Orchestrators** depend on `runPool()` from `src/orchestration/pool.ts` for concurrent execution, `TraceWriter` for telemetry, `ProgressReporter`/`PlanTracker` for user feedback, `computeContentHash()` from `src/change-detection/` for staleness detection.

**AI Service** spawns subprocesses via `src/ai/subprocess.ts`, wraps calls in `src/ai/retry.ts`, accumulates telemetry via `src/ai/telemetry/logger.ts`, resolves backends via `src/ai/registry.ts` dispatching to `src/ai/backends/`.

**Quality Checks** (`src/quality/`) consume `.sum` files via `src/generation/writers/sum.ts`, read AGENTS.md via `src/generation/writers/agents-md.ts`, report findings via `src/quality/inconsistency/reporter.ts`.