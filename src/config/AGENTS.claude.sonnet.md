<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/config/

Configuration management for `.agents-reverse-engineer/config.yaml`: schema validation via Zod, auto-computed concurrency defaults, project root discovery via upward directory walk, and YAML serialization with safe quoting.

## Contents

- [`defaults.ts`](./defaults.ts): Exports `getDefaultConcurrency()` computing concurrency via `clamp(cores * 5, 2, min(memCap, 20))` using `os.availableParallelism()` and `MEMORY_FRACTION = 0.5`. Defines `DEFAULT_VENDOR_DIRS` (20 directories: `node_modules`, `.git`, `dist`, `.next`, `venv`, `target`, `.gradle`, etc.), `DEFAULT_EXCLUDE_PATTERNS` (lock files, dotfiles, AI assistant docs), `DEFAULT_BINARY_EXTENSIONS` (images/archives/executables/media), `DEFAULT_MAX_FILE_SIZE = 1048576`, `DEFAULT_COMPRESSION_RATIO = 0.25`.
- [`loader.ts`](./loader.ts): Exports `loadConfig(root)` reading `${root}/.agents-reverse-engineer/config.yaml` via `yaml.parse()` + `ConfigSchema.parse()`, returns defaults on `ENOENT`, throws `ConfigError` wrapping `ZodError` with formatted issue paths. `findProjectRoot(startDir)` walks up directory tree searching for existing `.agents-reverse-engineer/`. `writeDefaultConfig(root)` creates commented YAML using `yamlScalar()` quoting regex pattern `/[*{}\[\]?,:#&!|>'"%@`]/`. `configExists(root)` checks file presence via `access()`.
- [`schema.ts`](./schema.ts): Exports `ConfigSchema` (root), `ExcludeSchema` (patterns/vendorDirs/binaryExtensions), `OptionsSchema` (followSymlinks/maxFileSize), `OutputSchema` (colors), `GenerationSchema` (compressionRatio 0.1-1.0, activeVariant), `AISchema` (backend enum `['claude'|'codex'|'gemini'|'opencode'|'auto']`, model, timeoutMs, maxRetries, concurrency 1-20, telemetry.keepRuns). All fields default-populated; `Config` type via `z.infer<typeof ConfigSchema>`.

## Configuration Schema

**Root Config Object** (`ConfigSchema`):
- `exclude`: `ExcludeSchema` (patterns, vendorDirs, binaryExtensions)
- `options`: `OptionsSchema` (followSymlinks, maxFileSize)
- `output`: `OutputSchema` (colors)
- `generation`: `GenerationSchema` (compressionRatio, activeVariant)
- `ai`: `AISchema` (backend, model, timeoutMs, maxRetries, concurrency, telemetry)

**AI Config Constraints**:
- `backend`: `'claude'|'codex'|'gemini'|'opencode'|'auto'` (default `'auto'`)
- `concurrency`: 1-20 (default via `getDefaultConcurrency()`)
- `timeoutMs`: positive integer (default 300000)
- `maxRetries`: non-negative (default 3)
- `telemetry.keepRuns`: non-negative (default 50)

**Generation Config Constraints**:
- `compressionRatio`: 0.1-1.0 (default 0.25 for 25% source size)
- `activeVariant`: optional string (set by `--eval` flag)

**File Size Limit**: `maxFileSize` default 1048576 bytes (1MB)

## Project Root Discovery

`findProjectRoot(startDir)` performs upward directory walk via `access(${dir}/.agents-reverse-engineer/, F_OK)` until match or filesystem root, returns containing directory or resolved startDir.

## Error Handling

`ConfigError` extends `Error` with `filePath: string` and optional `cause?: Error`. Thrown when:
- YAML parse fails (wraps original error)
- Zod validation fails (formats `ZodError.issues` as `- {path.join('.')}: {message}`)

`loadConfig()` returns defaults silently on `ENOENT`, rethrows all other errors.

## Behavioral Contracts

**Config Path**: `${root}/.agents-reverse-engineer/config.yaml`

**Concurrency Formula**: `min(cores * 5, floor(totalMemGB * 0.5 / 0.512), 20)` bounded by `[2, 20]`

**YAML Quoting Regex**: `/[*{}\[\]?,:#&!|>'"%@`]/` triggers double-quote wrapping with `\\` → `\\\\`, `"` → `\\"` escaping

**Trace Event**: `{ type: 'config:loaded', configPath: string, model: string, concurrency: number }`

**Debug Log Patterns**:
- `[debug] Config loaded from: {relativePath}`
- `[debug] Model: {model}, Concurrency: {concurrency}`
- `[debug] Config file not found, using defaults`

**ZodError Formatting**: `  - {path.join('.')}: {message}` per issue, newline-separated

**Memory Constants**:
- `SUBPROCESS_HEAP_GB = 0.512` (Node `--max-old-space-size=512`)
- `MEMORY_FRACTION = 0.5` (50% total RAM allocation)

**Default Arrays**:
- `DEFAULT_VENDOR_DIRS` (20 entries): `node_modules`, `vendor`, `.git`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`, `.agents-reverse-engineer`, `.agents`, `.planning`, `.claude`, `.codex`, `.opencode`, `.gemini`, `.pub-cache`
- `DEFAULT_EXCLUDE_PATTERNS` (26 entries): lock files (`*.lock`, `package-lock.json`, `yarn.lock`, `pnpm-lock.yaml`, `bun.lockb`, `Gemfile.lock`, `Cargo.lock`, `poetry.lock`, `composer.lock`, `go.sum`), AI docs (`AGENTS.md`, `AGENTS.override.md`, `CLAUDE.md`, `OPENCODE.md`, `GEMINI.md`, `AGENTS.*.md`, `*.local.md`), dotfiles (`.gitignore`, `.gitattributes`, `.env`, `*.log`, `*.sum`, `SKILL.md`)
- `DEFAULT_BINARY_EXTENSIONS` (30+ entries): images (`.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.ico`, `.webp`), archives (`.zip`, `.tar`, `.gz`, `.rar`, `.7z`), executables (`.exe`, `.dll`, `.so`, `.dylib`), media (`.mp3`, `.mp4`, `.wav`), documents (`.pdf`), fonts (`.woff`, `.woff2`, `.ttf`, `.eot`), compiled (`.class`, `.pyc`)