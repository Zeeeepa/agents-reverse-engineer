<!-- Generated by agents-reverse-engineer -->

# src/config

Configuration system with Zod-validated YAML parsing, resource-aware concurrency computation, and commented starter config generation. Provides `loadConfig()` async loader with trace emission, `configExists()` predicate, `writeDefaultConfig()` generator with inline documentation, and `getDefaultConcurrency()` dynamic defaults based on CPU cores and memory constraints to prevent OOM in WSL environments.

## Contents

### Core Schema & Validation

**[schema.ts](./schema.ts)** — Exports five Zod schemas (`ExcludeSchema`, `OptionsSchema`, `OutputSchema`, `AISchema`, `ConfigSchema`) and corresponding TypeScript types (`ExcludeConfig`, `OptionsConfig`, `OutputConfig`, `AIConfig`, `Config`). Defines validation for `.agents-reverse-engineer/config.yaml` with numeric constraints (`.min(1).max(20)` for concurrency, `.positive()` for timeouts/file sizes), enum validation for AI backend selection (`'claude' | 'gemini' | 'opencode' | 'auto'`), and nested defaults spreading arrays from `defaults.ts`. Passes `getDefaultConcurrency` function reference to `AISchema.concurrency.default()` for dynamic pool sizing.

**[loader.ts](./loader.ts)** — Exports `loadConfig()` async function reading YAML from `path.join(root, '.agents-reverse-engineer', 'config.yaml')`, parsing via `yaml.parse()`, validating via `ConfigSchema.parse()`, emitting `config:loaded` trace events with `configPath`/`model`/`concurrency` fields, returning `DEFAULT_CONFIG` on ENOENT, throwing `ConfigError` with formatted `.issues` on `ZodError`. Exports `configExists()` predicate checking file presence via `access()`. Exports `writeDefaultConfig()` generator creating commented YAML via template literals mapping default arrays to indented list items, applying `yamlScalar()` quoting for glob meta-characters.

**[defaults.ts](./defaults.ts)** — Exports `getDefaultConcurrency()` computing worker pool size via three-way clamping: CPU-scaled (`cores * 5`), memory-capped (`floor(totalMemGB * 0.5 / 0.512)`), and hard-bounded (`MIN_CONCURRENCY=2`, `MAX_CONCURRENCY=20`). Exports frozen constant arrays: `DEFAULT_VENDOR_DIRS` (18 entries: node_modules/.git/dist/venv/__pycache__/.cargo/.planning/.claude), `DEFAULT_EXCLUDE_PATTERNS` (32 globs: AGENTS.md/CLAUDE.md/*.lock/.env/*.log/*.sum/**/SKILL.md), `DEFAULT_BINARY_EXTENSIONS` (26 types: .png/.jpg/.zip/.exe/.dll/.pdf/.woff), `DEFAULT_MAX_FILE_SIZE` (1MB threshold), `DEFAULT_CONFIG` (nested object matching Zod structure). Memory capacity calculation prevents OOM by limiting subprocess heap allocation to 50% of system RAM, aligning `SUBPROCESS_HEAP_GB=0.512` with `NODE_OPTIONS='--max-old-space-size=512'` from `../ai/subprocess.ts`.

## File Relationships

**Schema-to-loader flow:** `schema.ts` exports `ConfigSchema` consumed by `loader.ts` for `parse()` validation. Defaults imported by both: `schema.ts` spreads into `.default()` chains, `loader.ts` uses for `writeDefaultConfig()` template generation and fallback values.

**Concurrency computation:** `defaults.ts` `getDefaultConcurrency()` referenced by `schema.ts` `AISchema.concurrency.default()` as function (lazy evaluation on parse). Result emitted in `loader.ts` `config:loaded` trace event.

**Error propagation:** `loader.ts` catches `ZodError` from `ConfigSchema.parse()`, wraps in `ConfigError` with `filePath`/`cause` properties, formats `.issues` array into human-readable message. YAML parse errors from `yaml.parse()` wrapped similarly.

## Configuration Surface

**Five top-level sections:**
1. `exclude` — File/directory filtering via `patterns` (gitignore globs), `vendorDirs` (third-party paths), `binaryExtensions` (non-text types)
2. `options` — Discovery behavior: `followSymlinks` (boolean), `maxFileSize` (positive number)
3. `output` — Terminal formatting: `colors` (boolean)
4. `ai` — Backend orchestration: `backend` (enum), `model` (string), `timeoutMs`/`maxRetries`/`concurrency` (numbers), `telemetry.keepRuns` (number)
5. (implicit) — Root schema applying `.default({})` to all sections for total defaults on empty input

**Validation constraints:**
- `concurrency` ∈ [1, 20] via `.min(1).max(20)`
- `timeoutMs`, `maxFileSize` > 0 via `.positive()`
- `maxRetries`, `telemetry.keepRuns` ≥ 0 via `.min(0)`
- `backend` ∈ {'claude', 'gemini', 'opencode', 'auto'} via `z.enum()`

## Integration Points

**Consumed by discovery filters:** `defaults.ts` constants (`DEFAULT_VENDOR_DIRS`, `DEFAULT_BINARY_EXTENSIONS`, `DEFAULT_EXCLUDE_PATTERNS`) imported by `../discovery/filters/vendor.ts`, `../discovery/filters/binary.ts`, `../discovery/filters/custom.ts` for filter initialization.

**Consumed by orchestration:** `loader.ts` exports imported by `../cli/` entry points (init.ts/discover.ts/generate.ts/update.ts), `loadConfig()` result threaded through `CommandRunOptions` to worker pool and AI service.

**Trace emission:** `loader.ts` receives `ITraceWriter` from `../orchestration/trace.ts` via `options.tracer`, emits `config:loaded` event with resolved configuration snapshot for observability.

**Subprocess alignment:** `defaults.ts` `SUBPROCESS_HEAP_GB` constant (0.512 GB) matches `NODE_OPTIONS='--max-old-space-size=512'` environment variable set in `../ai/subprocess.ts` `runSubprocess()` function for memory capacity calculation.