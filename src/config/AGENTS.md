<!-- Generated by agents-reverse-engineer -->

# src/config

Zod-validated YAML configuration loader with runtime-computed defaults for worker pool concurrency, file exclusion patterns, and AI backend settings.

## Contents

**[defaults.ts](./defaults.ts)** — Exports `DEFAULT_VENDOR_DIRS` (18 directories), `DEFAULT_EXCLUDE_PATTERNS` (29 gitignore globs), `DEFAULT_BINARY_EXTENSIONS` (26 file types), `DEFAULT_MAX_FILE_SIZE` (1MB), `DEFAULT_CONFIG` (nested object literal), and `getDefaultConcurrency()` computing worker pool size via CPU core count (`os.availableParallelism()`), memory capacity calculation (`totalmem * 0.5 / 512MB`), and formula `max(2, min(cores * 5, memCap, 20))`.

**[schema.ts](./schema.ts)** — Defines `ConfigSchema` (root), `ExcludeSchema` (patterns/vendorDirs/binaryExtensions arrays), `OptionsSchema` (followSymlinks/maxFileSize), `OutputSchema` (colors flag), `AISchema` (backend enum, model string, timeoutMs positive, maxRetries min(0), concurrency min(1).max(20), telemetry.keepRuns). Exports inferred types: `Config`, `ExcludeConfig`, `OptionsConfig`, `OutputConfig`, `AIConfig`. All fields have `.default()` allowing empty object input.

**[loader.ts](./loader.ts)** — Exports `loadConfig()` reading `.agents-reverse-engineer/config.yaml` via `readFile()` + `parse()` + `ConfigSchema.parse()`, returning defaults on ENOENT, throwing `ConfigError` on ZodError with formatted issue paths. Exports `writeDefaultConfig()` generating annotated YAML via `yamlScalar()` quoting, triple-slash comment sections, interpolated `getDefaultConcurrency()` values. Exports `configExists()` checking file presence via `access()`. Emits 'config:loaded' trace event with configPath/model/concurrency.

## Configuration Schema

```yaml
exclude:
  patterns: [29 globs]      # AGENTS.md, lock files, dotfiles, logs
  vendorDirs: [18 names]    # node_modules, dist, .git, venv, target
  binaryExtensions: [26]    # .png, .zip, .exe, .pdf, .woff

options:
  followSymlinks: false     # Discovery behavior
  maxFileSize: 1048576      # Binary detection threshold (1MB)

output:
  colors: true              # ANSI color codes

ai:
  backend: 'auto'           # 'claude' | 'gemini' | 'opencode' | 'auto'
  model: 'sonnet'           # Backend-specific identifier
  timeoutMs: 300000         # Subprocess timeout (5 minutes)
  maxRetries: 3             # Exponential backoff attempts
  concurrency: 2-20         # Computed from CPU/memory
  telemetry:
    keepRuns: 50            # Log retention limit
```

## Default Concurrency Calculation

`getDefaultConcurrency()` implements memory-aware worker pool sizing to prevent RAM exhaustion from subprocess heap allocation (Claude CLI thread spawning issue per GitHub #5771):

1. Detect CPU cores via `os.availableParallelism()` (Node 18+) with `os.cpus().length` fallback
2. Compute memory capacity: `floor((totalmem / 1GB * 0.5) / 0.512)` — allocates 50% of system RAM divided by 512MB subprocess heap budget (`NODE_OPTIONS='--max-old-space-size=512'` from `src/ai/subprocess.ts`)
3. Apply formula: `max(2, min(cores * 5, memCap, 20))` with `MIN_CONCURRENCY=2` (WSL default), `CONCURRENCY_MULTIPLIER=5`, `MAX_CONCURRENCY=20` (matches Zod `.max(20)` constraint)
4. Return integer clamped to [2, 20], constrained by memory when `totalMemGB > 1`

Biases toward CPU cores but caps at physical memory limit to prevent thrashing on low-RAM environments (WSL, small VMs).

## File Relationships

**defaults.ts → schema.ts:** Constants imported into schema default values (`.default(DEFAULT_*)`, `.default(getDefaultConcurrency())`). Function call executes during schema initialization, enabling runtime CPU/memory detection.

**schema.ts → loader.ts:** `ConfigSchema` used for validation via `.parse()` in `loadConfig()`, catching ZodError and transforming to `ConfigError` with formatted issue paths.

**defaults.ts → loader.ts:** Constants imported for YAML template generation in `writeDefaultConfig()`, mapping arrays to commented YAML lists with `yamlScalar()` quoting to prevent alias/anchor misinterpretation.

## Integration Points

- Consumed by `src/cli/index.ts` via `loadConfig(cwd)` to initialize CommandRunOptions
- Default arrays fed to `src/discovery/filters/` modules (vendor.ts, custom.ts, binary.ts)
- `ConfigError` caught in CLI entry point and formatted for user display
- Trace events ('config:loaded') emitted to `ITraceWriter` when `--trace` flag set

## Error Handling

**ENOENT (missing config):** `loadConfig()` returns `ConfigSchema.parse({})` applying all defaults rather than throwing.

**ZodError (invalid YAML):** Constructs `ConfigError` with formatted issue list via `err.issues.map((issue) => '  - ${issue.path.join('.')}: ${issue.message}')`.

**YAML parse errors:** Throws `ConfigError` with wrapped cause, preserving original error stack.

**configExists() failures:** Swallows all `access()` errors and returns `false`.