<!-- Generated by agents-reverse-engineer -->

# src/config

Configuration management for agents-reverse-engineer CLI tool: Zod schema validation for `config.yaml`, default constant definitions (exclusion patterns, binary extensions, vendor directories), concurrency calculation from CPU/memory, and config file loading/initialization with YAML serialization.

## Contents

**[defaults.ts](./defaults.ts)** — Exports `DEFAULT_VENDOR_DIRS` (20 directory names), `DEFAULT_EXCLUDE_PATTERNS` (28 glob patterns), `DEFAULT_BINARY_EXTENSIONS` (25 file extensions), `DEFAULT_MAX_FILE_SIZE` (1MB constant), `DEFAULT_CONFIG` object, and `getDefaultConcurrency()` function computing subprocess concurrency via `clamp(cores * 5, MIN, min(memCap, MAX))` formula using `os.availableParallelism()` and `os.totalmem()`.

**[schema.ts](./schema.ts)** — Defines `ConfigSchema` Zod schema with nested `ExcludeSchema` (patterns, vendorDirs, binaryExtensions), `OptionsSchema` (followSymlinks, maxFileSize), `OutputSchema` (colors), and `AISchema` (backend enum `['claude', 'gemini', 'opencode', 'auto']`, model, timeoutMs, maxRetries, concurrency 1-20, telemetry.keepRuns). Exports inferred types `Config`, `ExcludeConfig`, `OptionsConfig`, `OutputConfig`, `AIConfig`.

**[loader.ts](./loader.ts)** — Implements `loadConfig(root, options)` which reads `.agents-reverse-engineer/config.yaml`, validates via `ConfigSchema.parse()`, emits `config:loaded` trace events, returns defaults on ENOENT, throws `ConfigError` for ZodError. Exports `writeDefaultConfig(root)` generating commented YAML template with section headers and `yamlScalar()` quoting for special characters. Exports `configExists(root)` boolean check and `CONFIG_DIR` (`".agents-reverse-engineer"`), `CONFIG_FILE` (`"config.yaml"`) constants.

## Configuration File Structure

`config.yaml` follows hierarchical structure:
- **exclude**: `patterns` (globs like `AGENTS.md`, `*.lock`, `*.sum`), `vendorDirs` (directories like `node_modules`, `.git`, `dist`), `binaryExtensions` (extensions like `.png`, `.zip`, `.pdf`)
- **options**: `followSymlinks` (boolean), `maxFileSize` (bytes)
- **output**: `colors` (boolean)
- **ai**: `backend` (enum), `model` (string), `timeoutMs` (number), `maxRetries` (number), `concurrency` (1-20), `telemetry.keepRuns` (run log retention count)

## Concurrency Calculation Logic

`getDefaultConcurrency()` applies formula `clamp(cores * CONCURRENCY_MULTIPLIER, MIN_CONCURRENCY, min(memCap, MAX_CONCURRENCY))` where:
- `CONCURRENCY_MULTIPLIER = 5`
- `MIN_CONCURRENCY = 2`
- `MAX_CONCURRENCY = 20`
- `memCap = floor(totalMemGB * MEMORY_FRACTION / SUBPROCESS_HEAP_GB)`
- `MEMORY_FRACTION = 0.5` (50% of system memory)
- `SUBPROCESS_HEAP_GB = 0.512` (mirroring `NODE_OPTIONS='--max-old-space-size=512'` from subprocess management)

## Error Handling

`loadConfig()` returns `ConfigSchema.parse({})` defaults on ENOENT, formats ZodError issues as `"${issue.path.join('.')}: ${issue.message}"` and throws `ConfigError` with `filePath` and optional `cause`, rethrows existing ConfigError, wraps YAML parse errors in ConfigError.

## YAML Serialization

`yamlScalar(value)` applies double-quote escaping for strings matching regex `/[*{}\[\]?,:#&!|>'"%@`]/`, escapes backslashes as `\\\\` and double quotes as `\\"`. `writeDefaultConfig()` uses `yaml.stringify()` from `yaml` package and inserts comment headers for each configuration section.

## Behavioral Contracts

### Regex Patterns

- **YAML special character detection**: `/[*{}\[\]?,:#&!|>'"%@`]/` — triggers double-quote escaping in `yamlScalar()`

### Format Specifications

- **ConfigError message format**: `"${issue.path.join('.')}: ${issue.message}"` for ZodError issues
- **Trace event structure**: `config:loaded` with fields `configPath`, `model`, `concurrency`

### Magic Constants

- `CONFIG_DIR = ".agents-reverse-engineer"` — configuration directory name
- `CONFIG_FILE = "config.yaml"` — configuration filename
- `CONCURRENCY_MULTIPLIER = 5` — CPU core scaling factor
- `MIN_CONCURRENCY = 2` — concurrency floor
- `MAX_CONCURRENCY = 20` — concurrency ceiling
- `SUBPROCESS_HEAP_GB = 0.512` — memory budget per subprocess
- `MEMORY_FRACTION = 0.5` — allocates 50% of system memory to subprocess pool
- `DEFAULT_MAX_FILE_SIZE = 1024 * 1024` — 1MB file size threshold

### Default Exclusion Lists

- **Vendor directories** (20 entries): `node_modules`, `vendor`, `.git`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`, `.agents-reverse-engineer`, `.agents`, `.planning`, `.claude`, `.opencode`, `.gemini`, `.vscode`, `.idea`
- **Exclude patterns** (28 entries): `AGENTS.md`, `CLAUDE.md`, `OPENCODE.md`, `GEMINI.md`, `**/AGENTS.md`, `**/CLAUDE.md`, `**/OPENCODE.md`, `**/GEMINI.md`, `*.lock`, `package-lock.json`, `yarn.lock`, `pnpm-lock.yaml`, `bun.lock`, `bun.lockb`, `Gemfile.lock`, `Cargo.lock`, `poetry.lock`, `composer.lock`, `go.sum`, `.gitignore`, `.gitattributes`, `.gitkeep`, `.env`, `**/.env`, `**/.env.*`, `*.log`, `*.sum`, `**/*.sum`, `**/SKILL.md`
- **Binary extensions** (25 entries): `.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.ico`, `.webp`, `.zip`, `.tar`, `.gz`, `.rar`, `.7z`, `.exe`, `.dll`, `.so`, `.dylib`, `.mp3`, `.mp4`, `.wav`, `.pdf`, `.woff`, `.woff2`, `.ttf`, `.eot`, `.class`, `.pyc`

## Dependencies

defaults.ts imports `os` from `node:os` for `availableParallelism()`, `cpus()`, `totalmem()`. loader.ts imports `readFile`, `writeFile`, `mkdir`, `access` from `node:fs/promises`, `parse` and `stringify` from `yaml`, `ZodError` from `zod`, `pc` from `picocolors`, schema and default modules from same directory, and `ITraceWriter` from [../orchestration/trace.js](../orchestration/trace.ts). schema.ts imports `z` from `zod` and default constants from defaults.ts.