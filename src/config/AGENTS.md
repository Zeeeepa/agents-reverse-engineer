<!-- Generated by agents-reverse-engineer -->

# src/config

Configuration schema, defaults, and loader for `.agents-reverse-engineer/config.yaml`. Defines Zod validation schemas with computed concurrency limits, exclusion lists for vendor directories and binary extensions, and YAML parsing logic with human-readable error formatting.

## Contents

### [defaults.ts](./defaults.ts)
Exports `DEFAULT_VENDOR_DIRS` (20 excluded directories), `DEFAULT_EXCLUDE_PATTERNS` (globs for lock files, dotfiles, AI docs), `DEFAULT_BINARY_EXTENSIONS` (images, archives, executables), `DEFAULT_MAX_FILE_SIZE` (1048576 bytes), `DEFAULT_CONFIG` (nested schema defaults), and `getDefaultConcurrency()` (CPU/memory-aware concurrency calculation).

### [schema.ts](./schema.ts)
Defines `ConfigSchema` (root schema combining exclude, options, output, AI sections), `ExcludeSchema` (patterns/vendorDirs/binaryExtensions arrays), `OptionsSchema` (followSymlinks, maxFileSize), `OutputSchema` (colors boolean), `AISchema` (backend enum, model, timeoutMs, maxRetries, concurrency, telemetry.keepRuns). Exports inferred `Config`, `ExcludeConfig`, `OptionsConfig`, `OutputConfig`, `AIConfig` types.

### [loader.ts](./loader.ts)
Exports `loadConfig()` (reads/parses/validates `config.yaml`, returns defaults on `ENOENT`, throws `ConfigError` on parse/validation failures, emits `config:loaded` trace event), `configExists()` (tests file presence), `writeDefaultConfig()` (creates commented YAML template with defaults), `yamlScalar()` (quotes strings with regex special characters), `ConfigError` class, `CONFIG_DIR` ('.agents-reverse-engineer'), `CONFIG_FILE` ('config.yaml').

## Resource Budgeting

`getDefaultConcurrency()` clamps parallelism between `MIN_CONCURRENCY` (2) and minimum of `MAX_CONCURRENCY` (20) and memory capacity. Memory capacity formula: `Math.floor((totalMemGB * 0.5) / 0.512)` where `SUBPROCESS_HEAP_GB = 0.512` matches `NODE_OPTIONS='--max-old-space-size=512'` environment variable. `MEMORY_FRACTION = 0.5` reserves half system RAM for subprocess pool. `CONCURRENCY_MULTIPLIER = 5` scales CPU cores before clamping. This prevents RAM exhaustion from concurrent Claude CLI subprocess spawning in WSL environments (GitHub issue #5771).

## Schema Coordination

`MAX_CONCURRENCY` (20) enforces `.max(20)` constraint in `AISchema.concurrency`. `DEFAULT_CONFIG` structure mirrors `ConfigSchema` fields for fallback when config file absent or incomplete. All schemas use `.default({})` or `.default([])` for partial configuration validity.

## Trace Events

`loadConfig()` emits `config:loaded` event with `{ type: 'config:loaded', configPath, model, concurrency }` fields via `options.tracer?.emit()`. Event fired both on successful parse and when defaults returned due to missing file (`configPath: '(defaults)'`).

## Error Handling

`loadConfig()` distinguishes three error paths: (1) `ENOENT` caught and converted to default config return, (2) `ZodError` caught and converted to `ConfigError` with formatted validation issues mapping `issue.path.join('.')` and `issue.message`, (3) YAML parse errors wrapped in `ConfigError` with original error message and cause. `yamlScalar()` prevents YAML misinterpretation by quoting patterns matching `/[*{}\[\]?,:#&!|>'"%@`]/`.

## Behavioral Contracts

### Exclusion Patterns
```javascript
// defaults.ts — DEFAULT_EXCLUDE_PATTERNS
['AGENTS.md', 'CLAUDE.md', 'OPENCODE.md', 'GEMINI.md', '**/variants', '*.lock', 
 'package-lock.json', 'yarn.lock', 'pnpm-lock.yaml', 'bun.lock', 'bun.lockb', 
 'Gemfile.lock', 'Cargo.lock', 'poetry.lock', 'composer.lock', 'go.sum', 
 '.gitignore', '.gitattributes', '.gitkeep', '.env', '**/.env', '**/.env.*', 
 '*.log', '*.sum', '**/*.sum', '**/SKILL.md']
```

### Vendor Directories
```javascript
// defaults.ts — DEFAULT_VENDOR_DIRS
['node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__', '.next', 
 'venv', '.venv', 'target', '.cargo', '.gradle', '.agents-reverse-engineer', 
 '.agents', '.planning', '.claude', '.opencode', '.gemini']
```

### Binary Extensions
```javascript
// defaults.ts — DEFAULT_BINARY_EXTENSIONS
['.png', '.jpg', '.jpeg', '.gif', '.bmp', '.ico', '.webp', '.zip', '.tar', 
 '.gz', '.rar', '.7z', '.exe', '.dll', '.so', '.dylib', '.mp3', '.mp4', 
 '.wav', '.pdf', '.woff', '.woff2', '.ttf', '.eot', '.class', '.pyc']
```

### YAML Quoting Trigger
```javascript
// loader.ts — yamlScalar()
/[*{}\[\]?,:#&!|>'"%@`]/
```

### Concurrency Formula
```javascript
// defaults.ts — getDefaultConcurrency()
memCap = Math.floor((os.totalmem() / (1024 ** 3) * 0.5) / 0.512)
concurrency = Math.min(
  MAX_CONCURRENCY,  // 20
  memCap,
  Math.max(
    MIN_CONCURRENCY,  // 2
    os.availableParallelism() * 5  // CONCURRENCY_MULTIPLIER
  )
)
```

## Dependencies

`loader.ts` imports `ConfigSchema`, `Config` from `./schema.js`; defaults from `./defaults.js`; `ITraceWriter` from `../orchestration/trace.js`; `parse`, `stringify` from `yaml`; `ZodError` from `zod`; `pc.dim` from `picocolors`. `schema.ts` imports defaults from `./defaults.js` and `z` from `zod`. `defaults.ts` imports `os` (Node.js stdlib).