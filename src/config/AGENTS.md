<!-- Generated by agents-reverse-engineer -->

# src/config

**Loads, validates, and defaults `.agents-reverse-engineer/config.yaml` configuration via Zod schemas with nested structures for exclusion rules (gitignore patterns/vendor directories/binary extensions), discovery options (symlink following/file size thresholds), output formatting (ANSI colors), and AI service settings (backend/model/timeout/concurrency with dynamic CPU/memory-based defaults).**

## Files

**[defaults.ts](./defaults.ts)** — Exports `DEFAULT_VENDOR_DIRS` (18 entries: node_modules/.git/dist), `DEFAULT_EXCLUDE_PATTERNS` (30 globs: AGENTS.md/lock files/dotfiles), `DEFAULT_BINARY_EXTENSIONS` (26 types: .png/.zip/.exe), `DEFAULT_MAX_FILE_SIZE` (1MB), `DEFAULT_CONFIG` composite object, and `getDefaultConcurrency()` computing `clamp(cores * 5, 2, min(memCap, 20))` where `memCap = floor((totalMemGB * 0.5) / 0.512)` enforces 50% RAM allocation with 512MB subprocess heap matching resource management constraints.

**[schema.ts](./schema.ts)** — Defines `ConfigSchema` (root), `ExcludeSchema` (patterns/vendorDirs/binaryExtensions arrays), `OptionsSchema` (followSymlinks/maxFileSize), `OutputSchema` (colors boolean), `AISchema` (backend enum 'claude'|'gemini'|'opencode'|'auto', model/timeoutMs/maxRetries/concurrency with dynamic default via `getDefaultConcurrency()`, telemetry.keepRuns), exports inferred `Config`, `ExcludeConfig`, `OptionsConfig`, `OutputConfig`, `AIConfig` types.

**[loader.ts](./loader.ts)** — `loadConfig(root, options?)` reads `${CONFIG_DIR}/config.yaml`, parses YAML, validates via `ConfigSchema.parse()`, emits `config:loaded` trace event with configPath/model/concurrency, returns defaults on ENOENT, throws `ConfigError` wrapping ZodError formatted issues; `configExists(root)` checks file presence; `writeDefaultConfig(root)` templates YAML with inline comments documenting each section via 80-character `# ===` separators, quotes special characters via `yamlScalar()` regex `/[*{}\[\]?,:#&!|>'"%@\`]/`.

## Schema Composition Pattern

`ConfigSchema` assembles four nested schemas (`ExcludeSchema`, `OptionsSchema`, `OutputSchema`, `AISchema`) via object field composition, each schema exports standalone for granular validation testing, all schemas chain `.default()` ensuring `ConfigSchema.parse({})` populates full configuration from constants in defaults.ts.

## Dynamic Concurrency Calculation

`getDefaultConcurrency()` uses `os.availableParallelism()` fallback `os.cpus().length` for core count, computes memory cap as `floor((totalMem / 1024^3 * 0.5) / 0.512)` enforcing subprocess heap limit matching `NODE_OPTIONS='--max-old-space-size=512'` from `src/ai/subprocess.ts`, returns `Math.max(2, Math.min(cores * 5, memCap, 20))` clamping between `MIN_CONCURRENCY=2` (WSL default) and `MAX_CONCURRENCY=20` (Zod schema constraint).

## Error Handling Strategy

`loadConfig()` returns defaults silently on ENOENT (file missing), re-throws `ConfigError` as-is, wraps `ZodError` in `ConfigError` with formatted issue list via `err.issues.map(i => '  - ${i.path.join('.')}: ${i.message}').join('\n')`, wraps YAML parse errors in `ConfigError` with original message. `ConfigError` class extends `Error` with `filePath` string, optional `cause` Error, `name = 'ConfigError'`.

## YAML Template Generation

`writeDefaultConfig()` creates config directory via `mkdir(configDir, { recursive: true })`, templates arrays via `.map(item => '    - ${item}').join('\n')` for vendor dirs and binary extensions, applies `yamlScalar()` quoting to exclude patterns detecting special characters, documents dynamic concurrency via inline comment referencing `getDefaultConcurrency()`, writes five comment-delimited sections: FILE & DIRECTORY EXCLUSIONS, DISCOVERY OPTIONS, OUTPUT FORMATTING, AI SERVICE CONFIGURATION, TELEMETRY SETTINGS with 300000ms (5min) timeout default and 50 keepRuns retention.

## Trace Integration

`loadConfig()` emits `config:loaded` event via `options.tracer?.emit()` after successful parse with payload `{ type: 'config:loaded', configPath: string, model: string, concurrency: number }`, emits for both file-based config and defaults fallback (configPath="(defaults)" when ENOENT), trace writer interface from `../orchestration/trace.js`.

## Default Constant Values

`DEFAULT_VENDOR_DIRS`: node_modules, vendor, .git, dist, build, __pycache__, .next, venv, .venv, target, .cargo, .gradle, .agents-reverse-engineer, .agents, .planning, .claude, .opencode, .gemini (18 entries)

`DEFAULT_EXCLUDE_PATTERNS`: AGENTS.md, **/AGENTS.md, CLAUDE.md, OPENCODE.md, GEMINI.md with recursive variants, lock files (*.lock, package-lock.json, yarn.lock, pnpm-lock.yaml, bun.lock, bun.lockb, Gemfile.lock, Cargo.lock, poetry.lock, composer.lock, go.sum), dotfiles (.gitignore, .gitattributes, .gitkeep, .env, **/.env, **/.env.*), artifacts (*.log, *.sum, **/*.sum, **/SKILL.md) (30 entries)

`DEFAULT_BINARY_EXTENSIONS`: .png, .jpg, .jpeg, .gif, .bmp, .ico, .webp, .zip, .tar, .gz, .rar, .7z, .exe, .dll, .so, .dylib, .mp3, .mp4, .wav, .pdf, .woff, .woff2, .ttf, .eot, .class, .pyc (26 entries)

`DEFAULT_MAX_FILE_SIZE`: 1048576 (1MB)