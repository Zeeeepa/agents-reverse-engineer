<!-- Generated by agents-reverse-engineer -->

# config

Exports YAML-based configuration loading with Zod validation, resource-adaptive concurrency calculation, and default constant definitions for gitignore patterns, vendor directories, binary extensions, and AI service parameters.

## Contents

### Core Modules

**[schema.ts](./schema.ts)** — Defines ConfigSchema (Zod) with nested ExcludeSchema (patterns/vendorDirs/binaryExtensions arrays), OptionsSchema (followSymlinks boolean, maxFileSize number), OutputSchema (colors boolean), AISchema (backend enum, model string, timeoutMs/maxRetries/concurrency numbers, telemetry.keepRuns number). Exports Config, ExcludeConfig, OptionsConfig, OutputConfig, AIConfig types. Applies validation constraints: backend restricted to `'claude' | 'gemini' | 'opencode' | 'auto'`, timeoutMs requires positive integer, concurrency clamped to 1-20, maxFileSize requires positive integer, keepRuns requires non-negative integer.

**[loader.ts](./loader.ts)** — Exports loadConfig(root, options?) reading `.agents-reverse-engineer/config.yaml`, parsing YAML, validating via ConfigSchema.parse(), emitting `config:loaded` trace event (configPath/model/concurrency fields), returning validated Config or defaults on ENOENT, wrapping ZodError/parse failures in ConfigError. Exports configExists(root) checking file accessibility via fs.access(). Exports writeDefaultConfig(root) generating commented YAML template with DEFAULT_EXCLUDE_PATTERNS/DEFAULT_VENDOR_DIRS/DEFAULT_BINARY_EXTENSIONS arrays, yamlScalar() escaping special characters.

**[defaults.ts](./defaults.ts)** — Exports getDefaultConcurrency() computing worker pool size via `clamp(os.availableParallelism() * CONCURRENCY_MULTIPLIER, MIN_CONCURRENCY, min(MAX_CONCURRENCY, memCap))` where memCap = `floor(os.totalmem() * MEMORY_FRACTION / SUBPROCESS_HEAP_GB)` with MEMORY_FRACTION=0.5, SUBPROCESS_HEAP_GB=0.512, CONCURRENCY_MULTIPLIER=5, MIN_CONCURRENCY=2, MAX_CONCURRENCY=20. Exports DEFAULT_VENDOR_DIRS (18 directories: node_modules/vendor/.git/dist/build/__pycache__/.next/venv/.venv/target/.cargo/.gradle/.agents-reverse-engineer/.agents/.planning/.claude/.opencode/.gemini), DEFAULT_EXCLUDE_PATTERNS (26 patterns: AGENTS.md/CLAUDE.md/OPENCODE.md/GEMINI.md/lock files/dotfiles/logs/sum files), DEFAULT_BINARY_EXTENSIONS (26 extensions: images/archives/executables/media/documents/fonts/compiled files), DEFAULT_MAX_FILE_SIZE (1MB), DEFAULT_CONFIG (composite object spreading constants).

## Data Flow

1. CLI commands invoke loadConfig(root, { tracer, debug }) from loader.ts
2. loader.ts reads `.agents-reverse-engineer/config.yaml`, parses YAML, validates via ConfigSchema.parse() from schema.ts
3. schema.ts applies defaults from defaults.ts (DEFAULT_VENDOR_DIRS, DEFAULT_EXCLUDE_PATTERNS, DEFAULT_BINARY_EXTENSIONS, DEFAULT_MAX_FILE_SIZE, getDefaultConcurrency())
4. On validation failure, loader.ts extracts ZodError.issues[] and wraps in ConfigError with formatted message
5. On success, loader.ts emits `config:loaded` trace event and returns Config object to CLI orchestrators
6. writeDefaultConfig() generates YAML template by embedding DEFAULT_ constants and calling yamlScalar() for pattern escaping

## Resource Adaptive Concurrency

getDefaultConcurrency() prevents RAM exhaustion by computing memory cap: on 4GB systems, `memCap = floor(4 * 0.5 / 0.512) = 3` limits concurrency to 3 workers despite CPU count * 5 formula suggesting higher values. SUBPROCESS_HEAP_GB synchronizes with `NODE_OPTIONS='--max-old-space-size=512'` environment variable set in `src/ai/subprocess.ts` for subprocess resource limiting. Formula `cores * CONCURRENCY_MULTIPLIER` optimized for I/O-bound AI subprocess workloads with high wait-to-compute ratios.

## Error Handling Strategy

loader.ts distinguishes three error cases: ENOENT errors return `ConfigSchema.parse({})` defaults without throwing, ZodError instances map issues[] to multi-line validation report wrapped in ConfigError, existing ConfigError instances re-thrown without modification. ConfigError extends Error adding filePath: string and optional cause: Error properties for stack trace preservation.

## File System Contracts

- Configuration directory: `.agents-reverse-engineer/`
- Configuration file: `config.yaml` (YAML format with commented sections)
- Telemetry logs: `.agents-reverse-engineer/logs/` (referenced by AISchema.telemetry.keepRuns)
- Trace output: `.agents-reverse-engineer/traces/` (referenced by ITraceWriter interface)

## Behavioral Contracts

**YAML Special Character Escaping:**
yamlScalar() quotes values matching regex `/[*{}\[\]?,:#&!|>'"%@`]/` and escapes `\\` → `\\\\`, `\"` → `\\\"` within quoted strings.

**Default Exclusion Patterns:**
```typescript
DEFAULT_EXCLUDE_PATTERNS = [
  'AGENTS.md', 'CLAUDE.md', 'OPENCODE.md', 'GEMINI.md',
  '**/AGENTS.md', '**/CLAUDE.md', '**/OPENCODE.md', '**/GEMINI.md',
  '*.lock', 'package-lock.json', 'yarn.lock', 'pnpm-lock.yaml',
  'bun.lock', 'bun.lockb', 'Gemfile.lock', 'Cargo.lock',
  'poetry.lock', 'composer.lock', 'go.sum',
  '.gitignore', '.gitattributes', '.gitkeep', '.env', '**/.env', '**/.env.*',
  '*.log', '*.sum', '**/*.sum', '**/SKILL.md'
]
```

**Vendor Directory Exclusions:**
```typescript
DEFAULT_VENDOR_DIRS = [
  'node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__',
  '.next', 'venv', '.venv', 'target', '.cargo', '.gradle',
  '.agents-reverse-engineer', '.agents', '.planning',
  '.claude', '.opencode', '.gemini'
]
```

**Binary Extension Detection:**
```typescript
DEFAULT_BINARY_EXTENSIONS = [
  '.png', '.jpg', '.jpeg', '.gif', '.bmp', '.ico', '.webp',
  '.zip', '.tar', '.gz', '.rar', '.7z',
  '.exe', '.dll', '.so', '.dylib',
  '.mp3', '.mp4', '.wav',
  '.pdf',
  '.woff', '.woff2', '.ttf', '.eot',
  '.class', '.pyc'
]
```

**Concurrency Formula:**
```typescript
clamp(
  os.availableParallelism() * 5,
  2,
  min(20, floor(os.totalmem() * 0.5 / 0.512))
)
```

## Cross-Module Dependencies

- **schema.ts** imports defaults.ts (DEFAULT_EXCLUDE_PATTERNS, DEFAULT_VENDOR_DIRS, DEFAULT_BINARY_EXTENSIONS, DEFAULT_MAX_FILE_SIZE, getDefaultConcurrency)
- **loader.ts** imports schema.ts (ConfigSchema, Config type), defaults.ts (DEFAULT_VENDOR_DIRS, DEFAULT_BINARY_EXTENSIONS, DEFAULT_MAX_FILE_SIZE, DEFAULT_EXCLUDE_PATTERNS, getDefaultConcurrency), `../orchestration/trace.js` (ITraceWriter type)