<!-- Generated by agents-reverse-engineer -->

# src/config

Configuration loading, validation, and default value computation for `.agents-reverse-engineer/config.yaml`, including Zod schema enforcement, platform-adaptive concurrency calculation, and annotated YAML file generation with memory-bounded worker pool sizing.

## Contents

### Schema Definition

**[schema.ts](./schema.ts)** — `ConfigSchema` root validator composed of `ExcludeSchema` (patterns/vendorDirs/binaryExtensions arrays), `OptionsSchema` (followSymlinks/maxFileSize), `OutputSchema` (colors), `AISchema` (backend/model/timeoutMs/maxRetries/concurrency/telemetry). Exports inferred types: `Config`, `ExcludeConfig`, `OptionsConfig`, `OutputConfig`, `AIConfig`. All schemas chain `.default()` enabling partial parse with full default population.

**[defaults.ts](./defaults.ts)** — Exports `DEFAULT_VENDOR_DIRS` (18 directories: node_modules, .git, dist, build, target, .next, __pycache__, venv, .cargo, .gradle, .agents-reverse-engineer, .agents, .planning, .claude, .opencode, .gemini), `DEFAULT_EXCLUDE_PATTERNS` (lock files, dotfiles, logs, AI-generated docs, *.sum files), `DEFAULT_BINARY_EXTENSIONS` (26 extensions: images, archives, executables, media, documents, fonts, bytecode), `DEFAULT_MAX_FILE_SIZE` (1048576 bytes). `getDefaultConcurrency()` computes `clamp(cores × 5, MIN=2, min(memCap, MAX=20))` where `memCap = floor((totalMemGB × 0.5) / 0.512)` enforces memory constraint allocating 50% RAM divided by 512MB subprocess heap limit.

**[loader.ts](./loader.ts)** — `loadConfig(root, options?)` reads `config.yaml` from `.agents-reverse-engineer/`, parses via `yaml.parse()`, validates with `ConfigSchema`, returns defaults on `ENOENT`, throws `ConfigError` wrapping `ZodError` with formatted issue paths. Emits `config:loaded` trace events with configPath/model/concurrency fields. `writeDefaultConfig(root)` creates annotated YAML with five comment-delimited sections (exclusions, discovery options, output formatting, AI service), interpolates defaults via spread operators, quotes patterns containing YAML metacharacters `[*{}\[\]?,:#&!|>'"%@\`]` via `yamlScalar()`, comments out concurrency line showing override syntax.

## Configuration Structure

The config file divides into four sections:

- **exclude**: File/directory exclusion rules with glob patterns, vendor directory names, binary extension list
- **options**: Discovery behavior toggles (followSymlinks) and thresholds (maxFileSize in bytes)
- **output**: Terminal formatting preferences (ANSI colors)
- **ai**: AI service configuration (backend selection, model override, subprocess timeout, retry limits, worker pool concurrency, telemetry retention)

## Memory-Aware Concurrency

`getDefaultConcurrency()` implements memory-bounded worker pool sizing preventing RAM exhaustion where `cores × 5` spawns too many 512MB subprocesses. Computes `memCap = floor((totalMemGB × 0.5) / 0.512)` limiting concurrent subprocesses to fit within 50% memory budget, applies `Math.min(computed, memCap, MAX_CONCURRENCY)` respecting memory constraint alongside schema maximum. Fallback uses `Infinity` memCap when `totalMemGB ≤ 1` to avoid division-by-zero on resource-constrained systems.

## Behavioral Contracts

### Schema Validation Constraints

- AISchema concurrency: `z.number().min(1).max(20)` enforces 1-20 worker pool range
- OptionsSchema maxFileSize: `z.number().positive()` rejects zero/negative thresholds
- AISchema backend: `z.enum(['claude', 'gemini', 'opencode', 'auto'])` limits backend values
- AISchema telemetry.keepRuns: `z.number().min(0)` allows zero for unlimited retention

### YAML Metacharacter Pattern

`yamlScalar()` tests input against `/[*{}\[\]?,:#&!|>'"%@\`]/` pattern, double-quotes and backslash-escapes `\` → `\\`, `"` → `\"` when matched.

### Default Formulas

- Concurrency: `clamp(cores × 5, 2, min(floor((totalMemGB × 0.5) / 0.512), 20))`
- Memory cap: `floor((os.totalmem() / 1024³ × 0.5) / 0.512)` concurrent processes
- Timeout default: `300_000` milliseconds (5 minutes)

### Error Message Format

ConfigError validation failures: `"ai.concurrency: Expected number"` (field path colon-separated from Zod issue message, joined by newlines for multiple issues).

### Trace Event Schema

`config:loaded` payload: `{ type: 'config:loaded', configPath: string, model: string | null, concurrency: number }` emitted twice per `loadConfig()` call (once for file path via `path.relative(root, configPath)`, once for defaults with literal `'(defaults)'`).

## File Relationships

- **schema.ts** → **defaults.ts**: Imports `DEFAULT_VENDOR_DIRS`, `DEFAULT_BINARY_EXTENSIONS`, `DEFAULT_MAX_FILE_SIZE`, `DEFAULT_EXCLUDE_PATTERNS`, `getDefaultConcurrency` for `.default()` chaining
- **loader.ts** → **schema.ts**: Imports `ConfigSchema` for parse, `Config` type for return annotation
- **loader.ts** → **defaults.ts**: Imports all defaults for YAML interpolation in `writeDefaultConfig()`
- **loader.ts** → **../orchestration/trace.ts**: Imports `ITraceWriter` for `config:loaded` event emission