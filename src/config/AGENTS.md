<!-- Generated by agents-reverse-engineer -->

# src/config

Configuration management subsystem: YAML loading with Zod schema validation, default value computation, and config file initialization. Supports all AI backend options, discovery filters, and telemetry settings.

## Contents

**[defaults.ts](./defaults.ts)** — Exports `getDefaultConcurrency()` computing `Math.max(MIN_CONCURRENCY, Math.min(cores * CONCURRENCY_MULTIPLIER, memCap, MAX_CONCURRENCY))` where `memCap = floor(totalMemGB * MEMORY_FRACTION / SUBPROCESS_HEAP_GB)`, constants `DEFAULT_VENDOR_DIRS` (18 paths), `DEFAULT_EXCLUDE_PATTERNS` (29 patterns), `DEFAULT_BINARY_EXTENSIONS` (26 extensions), `DEFAULT_MAX_FILE_SIZE` (1MB), `DEFAULT_COMPRESSION_RATIO` (0.25), and merged `DEFAULT_CONFIG` object.

**[loader.ts](./loader.ts)** — Exports `loadConfig(root, options?)` reading `.agents-reverse-engineer/config.yaml` via `yaml.parse()` + `ConfigSchema.parse()` with ENOENT fallback to defaults, `writeDefaultConfig(root)` generating commented YAML template with inline documentation, `findProjectRoot(startDir)` walking up directories, `configExists(root)` checking file presence, `yamlScalar(value)` quoting strings matching `/[*{}\[\]?,:#&!|>'"%@`]/`, and `ConfigError` thrown on parse/validation failure with `filePath` and optional `cause`.

**[schema.ts](./schema.ts)** — Exports Zod schemas `ExcludeSchema` (`patterns`, `vendorDirs`, `binaryExtensions`), `OptionsSchema` (`followSymlinks`, `maxFileSize`), `OutputSchema` (`colors`), `GenerationSchema` (`compressionRatio` clamped `[0.1, 1.0]`), `AISchema` (`backend: 'claude'|'gemini'|'opencode'|'auto'`, `model`, `timeoutMs`, `maxRetries`, `concurrency` clamped `[1, 20]`, `telemetry.keepRuns`), root `ConfigSchema` combining all sub-schemas with cascading defaults, and inferred types `Config`, `ExcludeConfig`, `OptionsConfig`, `OutputConfig`, `GenerationConfig`, `AIConfig`.

## Architecture

### Load Pipeline

`loadConfig()` → `fs.readFile()` → `yaml.parse()` → `ConfigSchema.parse()` → validated `Config` object. ENOENT returns `ConfigSchema.parse({})` (defaults from schema `.default()` chains). Zod validation errors formatted as `${path.join('.')}: ${message}` multiline string, wrapped in `ConfigError` with `configPath` and `cause`. Emits `config:loaded` trace event with `{configPath, model, concurrency}` payload when `tracer` option provided.

### Default Cascade

All schemas use `.default()` enabling partial overrides: `{ ai: { model: 'opus' } }` inherits default `backend: 'auto'`, `timeoutMs: 300000`, `concurrency` from `getDefaultConcurrency()`. Empty object `{}` yields fully populated config via nested default objects.

### Config File Generation

`writeDefaultConfig()` creates `.agents-reverse-engineer/config.yaml` with five sections: (1) FILE & DIRECTORY EXCLUSIONS, (2) DISCOVERY OPTIONS, (3) OUTPUT FORMATTING, (4) GENERATION SETTINGS (includes ratio explanations: 0.10 = 10%, 0.25 = 25%, 0.50 = 50%), (5) AI SERVICE CONFIGURATION (backend enum values, timeout, retry, concurrency with computed default interpolation `${getDefaultConcurrency()}`). Uses `yamlScalar()` to quote patterns containing YAML special characters.

## Behavioral Contracts

### Concurrency Calculation
```javascript
concurrency = Math.max(MIN_CONCURRENCY, Math.min(cores * CONCURRENCY_MULTIPLIER, memCap, MAX_CONCURRENCY))
memCap = floor(totalMemGB * MEMORY_FRACTION / SUBPROCESS_HEAP_GB)
// Constants: MIN_CONCURRENCY=2, MAX_CONCURRENCY=20, CONCURRENCY_MULTIPLIER=5
// SUBPROCESS_HEAP_GB=0.512, MEMORY_FRACTION=0.5
```

### YAML Quoting Pattern
```regex
/[*{}\[\]?,:#&!|>'"%@`]/
```
Matches characters requiring double-quote escaping in YAML scalar values.

### Compression Ratio Bounds
- Schema enforces `[0.1, 1.0]` via `.min(0.1).max(1.0)`
- Default: `0.25` (target `.sum` size = 25% of source)
- Parse fails for values outside range

### Backend Enum
```typescript
'claude' | 'gemini' | 'opencode' | 'auto'
```
`'auto'` triggers PATH detection in `src/ai/registry.ts`.

### Concurrency Range
```typescript
.min(1).max(20)
```
Config parse rejects concurrency outside `[1, 20]`.

### Default Config Template Section Order
1. exclude.patterns, vendorDirs, binaryExtensions
2. options.followSymlinks, maxFileSize
3. output.colors
4. generation.compressionRatio
5. ai.backend, model, timeoutMs, maxRetries, concurrency, telemetry.keepRuns

### Error Wrapping
- ENOENT → return defaults (no exception)
- ZodError → ConfigError with formatted issues and `cause`
- YAML parse error → ConfigError with original error as `cause`