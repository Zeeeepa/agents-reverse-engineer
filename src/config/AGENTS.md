<!-- Generated by agents-reverse-engineer -->

# config

Configuration loading, schema validation, and default values for agents-reverse-engineer CLI. Provides `loadConfig()` (YAML parsing, Zod validation, defaults), `writeDefaultConfig()` (generates annotated config.yaml), and `findProjectRoot()` (walks directory tree to locate `.agents-reverse-engineer/`).

## Contents

### [defaults.ts](./defaults.ts)
Exports `getDefaultConcurrency()` (dynamic concurrency calculation: `os.availableParallelism() * 5` clamped to 2-20 and memory cap), `DEFAULT_VENDOR_DIRS` (18 excluded directories: `node_modules`, `.git`, `dist`, etc.), `DEFAULT_EXCLUDE_PATTERNS` (gitignore-style globs for `AGENTS.md`, lock files, dotfiles), `DEFAULT_BINARY_EXTENSIONS` (25 binary file extensions: `.png`, `.zip`, `.exe`, etc.), `DEFAULT_MAX_FILE_SIZE` (1MB threshold).

### [loader.ts](./loader.ts)
Exports `loadConfig(root, options?)` (reads `.agents-reverse-engineer/config.yaml`, parses with `yaml.parse()`, validates via `ConfigSchema.parse()`, emits `config:loaded` trace events, returns defaults on ENOENT), `writeDefaultConfig(root)` (generates annotated YAML with comment sections, creates `.agents-reverse-engineer/` directory), `findProjectRoot(startDir)` (walks up directories until CONFIG_DIR found), `configExists(root)` (checks config.yaml presence), `yamlScalar(value)` (escapes YAML special characters). Exports `ConfigError` class (stores `filePath` and optional `cause`, thrown on ZodError or parse failure).

### [schema.ts](./schema.ts)
Exports `ConfigSchema` (root Zod object with nested `exclude`, `options`, `output`, `ai` schemas), `ExcludeSchema` (validates `patterns`, `vendorDirs`, `binaryExtensions` arrays), `OptionsSchema` (validates `followSymlinks` boolean and `maxFileSize` positive number), `OutputSchema` (validates `colors` boolean), `AISchema` (validates `backend` enum `'claude' | 'gemini' | 'opencode' | 'auto'`, `model` string, `timeoutMs` positive number, `maxRetries` ≥0, `concurrency` 1-20, nested `telemetry.keepRuns` ≥0). Exports inferred types `Config`, `ExcludeConfig`, `OptionsConfig`, `OutputConfig`, `AIConfig`.

## Data Flow

1. **Config Loading**: `loadConfig()` reads `.agents-reverse-engineer/config.yaml` → `yaml.parse()` → `ConfigSchema.parse()` → merges with defaults from `defaults.ts` → emits `config:loaded` trace event → returns `Config` object
2. **Config Initialization**: `writeDefaultConfig()` calls `getDefaultConcurrency()` → generates YAML string with `DEFAULT_*` constants → creates `.agents-reverse-engineer/` directory → writes `config.yaml`
3. **Project Root Discovery**: `findProjectRoot(startDir)` walks up directories via `path.dirname()` until `.agents-reverse-engineer/` found or root reached

## Concurrency Calculation

`getDefaultConcurrency()` computes: `min(MAX_CONCURRENCY, floor(totalMemGB * 0.5 / 0.512), max(MIN_CONCURRENCY, os.availableParallelism() * 5))` where `SUBPROCESS_HEAP_GB = 0.512` (NODE_OPTIONS `--max-old-space-size=512`), `MEMORY_FRACTION = 0.5` (50% of system RAM), `CONCURRENCY_MULTIPLIER = 5`, `MIN_CONCURRENCY = 2`, `MAX_CONCURRENCY = 20` (aligned with `AISchema` `.max(20)` constraint).

## Error Handling

`loadConfig()` catches ENOENT errors (missing config.yaml) → returns `ConfigSchema.parse({})` with all defaults populated. Catches ZodError → formats `issue.path.join('.')`: `issue.message` → throws `ConfigError` with formatted messages. Catches YAML parse errors → throws `ConfigError` with original error as `cause`. `ConfigError` constructor accepts `message`, `filePath`, optional `cause` parameter for error chaining.

## Behavioral Contracts

### Exclude Patterns (defaults.ts)
`DEFAULT_EXCLUDE_PATTERNS` array contains gitignore-style globs:
- AI documentation: `AGENTS.md`, `CLAUDE.md`, `OPENCODE.md`, `GEMINI.md`, `**/AGENTS.md`, `**/CLAUDE.md`, `**/OPENCODE.md`, `**/GEMINI.md`
- Lock files: `*.lock`, `package-lock.json`, `yarn.lock`, `pnpm-lock.yaml`, `bun.lock`, `bun.lockb`, `Gemfile.lock`, `Cargo.lock`, `poetry.lock`, `composer.lock`, `go.sum`
- Dotfiles: `.gitignore`, `.gitattributes`, `.gitkeep`, `.env`, `**/.env`, `**/.env.*`
- Generated artifacts: `*.log`, `*.sum`, `**/*.sum`, `**/SKILL.md`

### YAML Escaping (loader.ts)
`yamlScalar(value)` escapes strings matching regex `/[*{}\[\]?,:#&!|>'"%@`]/`, doubles backslashes (`\\`), escapes double-quotes (`\"`), wraps in double-quotes.

### AI Backend Enum (schema.ts)
`AISchema.backend` validates enum: `'claude' | 'gemini' | 'opencode' | 'auto'` (default `'auto'`).

### Concurrency Constraints (schema.ts)
`AISchema.concurrency` validates `.int().min(1).max(20)` with default from `getDefaultConcurrency()`.