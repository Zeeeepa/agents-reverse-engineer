<!-- Generated by agents-reverse-engineer v0.8.2 -->

# src/config

Zod-based configuration loading and validation for `.agents-reverse-engineer/config.yaml` with computed concurrency defaults and comprehensive fallback values.

## Contents

**[defaults.ts](./defaults.ts)** — Exports `getDefaultConcurrency()` computing `Math.max(MIN_CONCURRENCY, Math.min(cores * CONCURRENCY_MULTIPLIER, memCap, MAX_CONCURRENCY))` where `memCap = floor(totalMemGB * MEMORY_FRACTION / SUBPROCESS_HEAP_GB)`. Defines `DEFAULT_VENDOR_DIRS` (18 paths: `node_modules`, `dist`, `.git`, etc.), `DEFAULT_EXCLUDE_PATTERNS` (29 globs: `AGENTS.md`, `*.lock`, `.env`), `DEFAULT_BINARY_EXTENSIONS` (26 extensions: `.png`, `.exe`, `.pdf`), `DEFAULT_MAX_FILE_SIZE` (1MB), `DEFAULT_COMPRESSION_RATIO` (0.25), `DEFAULT_CONFIG` merging all into schema structure.

**[loader.ts](./loader.ts)** — `loadConfig(root, options?)` reads `${root}/.agents-reverse-engineer/config.yaml` via `yaml.parse()` and `ConfigSchema.parse()`, returns defaults on ENOENT, throws `ConfigError` on ZodError/parse failure. `findProjectRoot(startDir)` walks up seeking `.agents-reverse-engineer/` directory. `writeDefaultConfig(root)` emits commented YAML template via `yamlScalar()` quoting strings matching `/[*{}\[\]?,:#&!|>'"%@`]/`. Emits `config:loaded` trace event with `{configPath, model, concurrency}` payload.

**[schema.ts](./schema.ts)** — `ConfigSchema` (Zod) validates `exclude` (`patterns`, `vendorDirs`, `binaryExtensions`), `options` (`followSymlinks`, `maxFileSize`), `output` (`colors`), `generation` (`compressionRatio` clamped `[0.1, 1.0]`), `ai` (`backend: 'claude'|'gemini'|'opencode'|'auto'`, `model`, `timeoutMs`, `maxRetries`, `concurrency` clamped `[1, 20]`, `telemetry.keepRuns`). All sub-schemas default to `{}` enabling partial overrides. Exports inferred types `Config`, `ExcludeConfig`, `OptionsConfig`, `OutputConfig`, `GenerationConfig`, `AIConfig`.

## Architecture

### Config Resolution

`loadConfig()` performs three-stage resolution: (1) YAML parsing via `yaml.parse()`, (2) Zod validation via `ConfigSchema.parse()`, (3) default injection through `.default()` transformations on each sub-schema. Empty object `{}` yields fully populated config. Partial configs merge with defaults (e.g., `{ ai: { model: 'opus' } }` retains default `backend: 'auto'`, `timeoutMs: 300000`).

### Default Cascade

`ConfigSchema` embeds `.default({})` on `exclude`, `options`, `output`, `generation`, `ai` properties. Each sub-schema chains `.default()` on primitives: `ExcludeSchema` defaults `patterns` to `DEFAULT_EXCLUDE_PATTERNS`, `vendorDirs` to `DEFAULT_VENDOR_DIRS`, `binaryExtensions` to `DEFAULT_BINARY_EXTENSIONS`. `AISchema` defaults `concurrency` to `getDefaultConcurrency()` (computed at parse-time), `backend` to `'auto'`, `model` to `'sonnet'`. Enables minimal config files overriding only necessary fields.

### Error Propagation

`ConfigError` wraps ZodError formatting issues as `${issue.path.join('.')}: ${issue.message}` multiline string, preserves `filePath` and `cause` for diagnostics. YAML parse errors wrapped similarly. ENOENT silently returns defaults (no error throw). ConfigError rethrown as-is to preserve call stack for caller-side handling.

### Concurrency Calculation

`getDefaultConcurrency()` computes `min(MAX_CONCURRENCY, floor(totalMemGB * MEMORY_FRACTION / SUBPROCESS_HEAP_GB), max(MIN_CONCURRENCY, os.availableParallelism() * CONCURRENCY_MULTIPLIER))`. Fallback to `os.cpus().length` if `availableParallelism()` unavailable (Node.js <18). Constants: `SUBPROCESS_HEAP_GB=0.512`, `MEMORY_FRACTION=0.5`, `MULTIPLIER=5`, `MIN=2`, `MAX=20`. Memory cap prevents OOM when spawning AI subprocesses (each subprocess uses `--max-old-space-size=512`).

### YAML Template Generation

`writeDefaultConfig()` emits inline-documented template via section ordering: (1) FILE & DIRECTORY EXCLUSIONS, (2) DISCOVERY OPTIONS, (3) OUTPUT FORMATTING, (4) GENERATION SETTINGS (with 0.10/0.25/0.50 ratio examples), (5) AI SERVICE CONFIGURATION. `yamlScalar()` helper detects special characters via `/[*{}\[\]?,:#&!|>'"%@`]/`, applies double-quote escaping for safe YAML output.

## Behavioral Contracts

**Concurrency calculation**:
```javascript
concurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))
// Constants: SUBPROCESS_HEAP_GB=0.512, MEMORY_FRACTION=0.5, MULTIPLIER=5, MIN=2, MAX=20
```

**Compression ratio bounds**: `[0.1, 1.0]` via `ConfigSchema.shape.generation.shape.compressionRatio.min(0.1).max(1.0)`.

**Concurrency bounds**: `[1, 20]` via `ConfigSchema.shape.ai.shape.concurrency.min(1).max(20)`.

**Backend enum**: `['claude', 'gemini', 'opencode', 'auto']` via `z.enum()`.

**YAML quoting regex**: `/[*{}\[\]?,:#&!|>'"%@`]/` triggers double-quote escaping in `yamlScalar()`.

**Config directory constant**: `CONFIG_DIR = '.agents-reverse-engineer'`, `CONFIG_FILE = 'config.yaml'`.

**Default vendor dirs** (18 entries): `node_modules`, `vendor`, `.git`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`, `.agents-reverse-engineer`, `.agents`, `.planning`, `.claude`, `.opencode`, `.gemini`.

**Default exclude patterns** (29 entries): `AGENTS.md`, `CLAUDE.md`, `OPENCODE.md`, `GEMINI.md`, `*.local.md`, `package-lock.json`, `yarn.lock`, `pnpm-lock.yaml`, `Cargo.lock`, `go.sum`, `.env`, `.gitignore`, `*.log`, `*.sum`, `SKILL.md`, plus others.

**Default binary extensions** (26 entries): `.png`, `.jpg`, `.jpeg`, `.gif`, `.bmp`, `.svg`, `.ico`, `.webp`, `.zip`, `.tar`, `.gz`, `.rar`, `.7z`, `.exe`, `.dll`, `.so`, `.dylib`, `.bin`, `.mp3`, `.mp4`, `.avi`, `.mov`, `.woff`, `.woff2`, `.ttf`, `.eot`, `.class`, `.pyc`, `.pdf`.

**Default max file size**: `1024 * 1024` (1MB).

**Default compression ratio**: `0.25` (target `.sum` size = 25% of source file size).

**Telemetry retention**: `ai.telemetry.keepRuns` defaults to `50` run logs, enforced via `src/ai/telemetry/cleanup.ts`.