<!-- Generated by agents-reverse-engineer -->

# src/config

Configuration system for agents-reverse-engineer: Zod schema validation (`ConfigSchema`), YAML loading with defaults (`loadConfig()`), project root discovery (`findProjectRoot()`), and dynamic concurrency calculation via `getDefaultConcurrency()`.

## Contents

**[defaults.ts](./defaults.ts)** — Exports `getDefaultConcurrency()` computing parallelism as `os.availableParallelism() * 5` clamped between 2 and `min(20, floor(totalMemGB * 0.5 / 0.512))`, and readonly constants `DEFAULT_VENDOR_DIRS` (18 excluded directories), `DEFAULT_EXCLUDE_PATTERNS` (gitignore globs for `.sum`, lock files, dotfiles), `DEFAULT_BINARY_EXTENSIONS` (25 image/archive/media extensions), `DEFAULT_MAX_FILE_SIZE` (1MB), `DEFAULT_CONFIG` (merged defaults object).

**[schema.ts](./schema.ts)** — Defines `ConfigSchema` Zod schema with four sections: `ExcludeSchema` (patterns/vendorDirs/binaryExtensions), `OptionsSchema` (followSymlinks/maxFileSize), `OutputSchema` (colors), `AISchema` (backend enum 'claude'|'gemini'|'opencode'|'auto', model, timeoutMs, maxRetries, concurrency 1-20, telemetry.keepRuns). Exports inferred `Config`, `ExcludeConfig`, `OptionsConfig`, `OutputConfig`, `AIConfig` types.

**[loader.ts](./loader.ts)** — Implements `loadConfig(root)` reading `.agents-reverse-engineer/config.yaml`, parsing YAML, validating via `ConfigSchema.parse()`, returning defaults on ENOENT, emitting `config:loaded` trace events. `writeDefaultConfig(root)` generates annotated YAML with inline documentation. `findProjectRoot(startDir)` walks up directories until locating `CONFIG_DIR` ('.agents-reverse-engineer'). `ConfigError` class stores filePath/cause for parse/validation failures.

## Configuration Flow

1. **Discovery**: `findProjectRoot(cwd)` walks up via `path.dirname()` until `access(CONFIG_DIR)` succeeds
2. **Loading**: `loadConfig(root)` reads `config.yaml`, parses with `yaml.parse()`, validates with `ConfigSchema.parse()`, catches ENOENT to return defaults, wraps ZodError in `ConfigError` with formatted issues
3. **Validation**: Zod schemas enforce constraints (concurrency 1-20, maxRetries ≥0, timeoutMs positive, backend enum), populate defaults via `.default()` chaining
4. **Initialization**: `writeDefaultConfig(root)` creates `.agents-reverse-engineer/` directory, generates YAML with comment sections ("FILE & DIRECTORY EXCLUSIONS", "AI SERVICE CONFIGURATION"), uses `yamlScalar()` to escape regex metacharacters

## Concurrency Calculation

`getDefaultConcurrency()` computes: `min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))`

**Constants**:
- `CONCURRENCY_MULTIPLIER`: 5
- `MIN_CONCURRENCY`: 2
- `MAX_CONCURRENCY`: 20
- `SUBPROCESS_HEAP_GB`: 0.512 (matches `NODE_OPTIONS --max-old-space-size=512`)
- `MEMORY_FRACTION`: 0.5 (caps subprocess RAM at 50% of system total)

Memory cap: `floor(os.totalmem() / 1024^3 * 0.5 / 0.512)` ensures subprocesses consume ≤50% RAM.

## Behavioral Contracts

### Config File Path
```javascript
path.join(root, '.agents-reverse-engineer', 'config.yaml')
```

### YAML Escaping
```javascript
yamlScalar(value: string): /[*{}\[\]?,:#&!|>'"%@`]/.test(value) ? `"${value.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"` : value
```

### ZodError Formatting
```javascript
err.issues.map(issue => `${issue.path.join('.')}: ${issue.message}`).join('\n')
```

### Trace Event Schema
```json
{
  "type": "config:loaded",
  "configPath": "relative/path/to/config.yaml",
  "model": "sonnet",
  "concurrency": 10
}
```

### Backend Resolution Priority
1. `config.ai.backend` explicit value ('claude' | 'gemini' | 'opencode')
2. `'auto'` default (runtime detection via `src/ai/registry.ts`)

### Default Exclusions
- **Patterns**: `['AGENTS.md', 'CLAUDE.md', '**/AGENTS.md', '*.lock', '**/.env', '*.log', '**/*.sum']`
- **Vendor Dirs**: `['node_modules', 'vendor', '.git', 'dist', 'build', '__pycache__', '.next', 'venv', 'target', '.cargo', '.agents-reverse-engineer']`
- **Binary Extensions**: `['.png', '.jpg', '.zip', '.tar', '.exe', '.dll', '.mp3', '.pdf', '.woff', '.class']`

## Integration Points

- **src/discovery/filters/**: Consumes `config.exclude.*` for file/directory filtering via `VendorFilter`, `BinaryFilter`, `CustomFilter`
- **src/orchestration/runner.ts**: Passes `config.ai.concurrency` to `runPool()` for worker count
- **src/ai/service.ts**: Uses `config.ai.backend`, `config.ai.model`, `config.ai.timeoutMs`, `config.ai.maxRetries` for subprocess spawning and retry logic
- **src/ai/telemetry/cleanup.ts**: Enforces `config.ai.telemetry.keepRuns` log retention policy
- **src/orchestration/trace.ts**: Emits `config:loaded` events consumed by `TraceWriter`

## Error Handling

`ConfigError` thrown for:
1. YAML parse failures (syntax errors)
2. Zod validation failures (type mismatches, constraint violations)
3. File read errors (non-ENOENT codes)

ENOENT silently returns defaults via `ConfigSchema.parse({})`. ZodError converted to `ConfigError` with formatted issues. Cause chain preserved via `cause?: Error` field.