---
generated_at: 2026-02-09T13:18:24.012Z
content_hash: d15f013ef871184f35cfb6eec1cafa2f80579e733b84a6bccca716e04710547e
purpose: loader.ts loads, validates, and writes YAML configuration files for the agents-reverse-engineer CLI tool.
---
**loader.ts loads, validates, and writes YAML configuration files for the agents-reverse-engineer CLI tool.**

## Exported Functions

`loadConfig(root: string, options?: { tracer?: ITraceWriter; debug?: boolean }): Promise<Config>` reads `config.yaml` from `.agents-reverse-engineer/` directory, parses YAML via `parse()` from yaml package, validates with `ConfigSchema.parse()` from Zod, and returns validated `Config` object with defaults applied. Returns default `Config` when file doesn't exist (ENOENT). Throws `ConfigError` on ZodError with formatted issue paths and messages. Emits `config:loaded` trace event with `configPath`, `model`, and `concurrency` fields. Outputs debug logs via `pc.dim()` when `options.debug` is true.

`configExists(root: string): Promise<boolean>` checks for configuration file presence using `access()` with `constants.F_OK` flag, returning true if `.agents-reverse-engineer/config.yaml` exists.

`writeDefaultConfig(root: string): Promise<void>` creates `.agents-reverse-engineer/` directory via `mkdir()` with `recursive: true`, then writes annotated YAML file with comments explaining each option. Uses `DEFAULT_VENDOR_DIRS`, `DEFAULT_BINARY_EXTENSIONS`, `DEFAULT_MAX_FILE_SIZE`, and `DEFAULT_EXCLUDE_PATTERNS` imported from `./defaults.js` to populate default arrays.

## Exported Classes

`ConfigError extends Error` represents configuration parsing or validation failures. Constructor accepts `message: string`, `filePath: string`, and optional `cause?: Error`. Sets `name` property to `'ConfigError'`.

## Exported Constants

`CONFIG_DIR = '.agents-reverse-engineer'` defines the configuration directory name.

`CONFIG_FILE = 'config.yaml'` defines the configuration filename.

## Helper Functions

`yamlScalar(value: string): string` quotes string values containing special YAML characters (`*{}\[\]?,:#&!|>'"%@` backtick) by wrapping in double quotes and escaping backslashes and internal quotes. Used by `writeDefaultConfig()` to safely serialize glob patterns in `exclude.patterns` array.

## Dependencies

Imports `readFile`, `writeFile`, `mkdir`, `access` from node:fs/promises and `constants` from node:fs for file I/O. Uses `parse` and `stringify` from yaml package for YAML serialization. Imports `ZodError` from zod for validation error handling. Uses `picocolors` (aliased as `pc`) for colored debug output. Imports `ConfigSchema` and `Config` type from `./schema.js`, default constants from `./defaults.js`, and `ITraceWriter` from `../orchestration/trace.js`.

## Error Handling Strategy

Catches ENOENT errors to return defaults silently. Catches `ZodError` to format validation issues as bullet list with `issue.path.join('.')` and `issue.message`, wrapping in `ConfigError`. Re-throws existing `ConfigError` instances unchanged. Wraps YAML parse errors in `ConfigError` with original error as cause.

## Configuration File Format

Generated YAML includes six sections with comment headers: FILE & DIRECTORY EXCLUSIONS (exclude.patterns, exclude.vendorDirs, exclude.binaryExtensions), DISCOVERY OPTIONS (options.followSymlinks, options.maxFileSize), OUTPUT FORMATTING (output.colors), AI SERVICE CONFIGURATION (ai.backend, ai.model, ai.timeoutMs, ai.maxRetries, ai.concurrency, ai.telemetry.keepRuns). Backend options documented as 'claude', 'gemini', 'opencode', 'auto'. Concurrency range documented as 1-10 with default 5, recommending lower values (2-3) for WSL environments, machines with <16GB RAM, or slow network connections.