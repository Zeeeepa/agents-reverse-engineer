---
generated_at: 2026-02-09T21:28:57.768Z
content_hash: b88ba8e0344a276d9eebeb8fef362508e570ea4c538f1d6a2af9a3ef507b8340
purpose: loadConfig() orchestrates YAML configuration parsing from `.agents-reverse-engineer/config.yaml` with Zod schema vali...
---
**loadConfig() orchestrates YAML configuration parsing from `.agents-reverse-engineer/config.yaml` with Zod schema validation, ConfigError-wrapped failure reporting, default fallback, and optional trace emission via ITraceWriter.**

## Exported Functions

**loadConfig(root: string, options?: { tracer?: ITraceWriter; debug?: boolean }): Promise<Config>**
Loads configuration from `{root}/.agents-reverse-engineer/config.yaml` by reading file content, parsing YAML via `parse()`, validating against ConfigSchema via `ConfigSchema.parse(raw)`, and returning validated Config object. On ENOENT error, returns default Config from `ConfigSchema.parse({})`. On ZodError, extracts `issue.path` and `issue.message` fields to construct multi-line error report wrapped in ConfigError. Emits `'config:loaded'` trace event with `configPath`, `model`, `concurrency` fields when tracer provided. Logs debug output with `pc.dim()` formatting when `options.debug` enabled.

**configExists(root: string): Promise<boolean>**
Checks existence of configuration file at `{root}/.agents-reverse-engineer/config.yaml` via `access(configPath, constants.F_OK)`. Returns true if file accessible, false if ENOENT caught.

**writeDefaultConfig(root: string): Promise<void>**
Creates `.agents-reverse-engineer/` directory via `mkdir(configDir, { recursive: true })` and writes `config.yaml` with commented YAML template. Content includes sections for `exclude.patterns`, `exclude.vendorDirs`, `exclude.binaryExtensions`, `options.followSymlinks`, `options.maxFileSize`, `output.colors`, `ai.backend`, `ai.model`, `ai.timeoutMs`, `ai.maxRetries`, `ai.concurrency`, `ai.telemetry.keepRuns`. Applies DEFAULT_EXCLUDE_PATTERNS, DEFAULT_VENDOR_DIRS, DEFAULT_BINARY_EXTENSIONS, DEFAULT_MAX_FILE_SIZE constants from defaults module. Calls `yamlScalar()` on pattern values to escape YAML special characters.

**yamlScalar(value: string): string**
Quotes string values containing YAML special characters matching regex `/[*{}\[\]?,:#&!|>'"%@`]/`. Escapes backslashes (`\\`) and double-quotes (`\"`) when quoting applied. Returns unmodified value when no special characters detected.

## ConfigError Class

**ConfigError extends Error** with additional properties `filePath: string` and `cause?: Error`. Constructor accepts `message`, `filePath`, optional `cause`. Sets `name` property to `'ConfigError'`.

## Constants

**CONFIG_DIR = '.agents-reverse-engineer'** — Directory name for configuration storage.

**CONFIG_FILE = 'config.yaml'** — Configuration filename.

## Dependencies

Imports `readFile`, `writeFile`, `mkdir`, `access` from `node:fs/promises` for file I/O. Imports `constants` from `node:fs` for F_OK flag. Imports `parse` and `stringify` from `yaml` library. Imports ZodError from `zod` for validation error handling. Imports `pc` from `picocolors` for terminal formatting. Imports ConfigSchema and Config type from `./schema.js`. Imports DEFAULT_VENDOR_DIRS, DEFAULT_BINARY_EXTENSIONS, DEFAULT_MAX_FILE_SIZE, DEFAULT_EXCLUDE_PATTERNS, getDefaultConcurrency from `./defaults.js`. Imports ITraceWriter from `../orchestration/trace.js`.

## Error Handling Strategy

loadConfig() distinguishes three error cases via instanceof checks and `(err as NodeJS.ErrnoException).code` inspection:
1. ENOENT errors trigger default config return via `ConfigSchema.parse({})`
2. ZodError instances map `err.issues[]` to formatted validation report and wrap in ConfigError
3. Existing ConfigError instances re-thrown without modification
4. All other errors wrapped in ConfigError with YAML parse failure message

## Trace Event Contract

Emits trace event with type `'config:loaded'` containing fields:
- `configPath: string` — Relative path from root or literal `'(defaults)'`
- `model: string` — Value from `config.ai.model`
- `concurrency: number` — Value from `config.ai.concurrency`

## Template Generation Pattern

writeDefaultConfig() constructs YAML content via template literals with embedded array mapping:
```typescript
vendorDirs:
${DEFAULT_VENDOR_DIRS.map((dir) => `    - ${dir}`).join('\n')}
```
Produces indented YAML list items with 4-space prefix. Uses `yamlScalar()` wrapper for patterns array to escape glob special characters like `*`.