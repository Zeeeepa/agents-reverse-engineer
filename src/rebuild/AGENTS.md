<!-- Generated by agents-reverse-engineer -->

# rebuild

Implements AI-driven project reconstruction from specification documents via ordered phase execution with checkpoint-based resumability, concurrent file generation within dependency groups, and progressive context accumulation from previously built modules.

## Contents

### Pipeline Orchestration

**[orchestrator.ts](./orchestrator.ts)** — Executes three-stage rebuild workflow: spec partitioning into `RebuildUnit[]` via `partitionSpec()`, sequential order group processing with concurrent AI calls per group via `runPool()`, and progressive context accumulation from generated file exports with LRU truncation at 100k chars.

**[checkpoint.ts](./checkpoint.ts)** — Provides session continuity via `CheckpointManager` class with SHA-256 spec drift detection, per-module status tracking (`pending`/`done`/`failed`), and promise-chain write serialization to `.rebuild-checkpoint` JSON file.

### Specification Processing

**[spec-reader.ts](./spec-reader.ts)** — Reads markdown files from `specs/` directory via `readSpecFiles()`, partitions content into `RebuildUnit[]` via Build Plan phase extraction (`### Phase N:`) or top-level heading fallback, injects targeted context (Architecture, filtered API subsections, Data Structures, Behavioral Contracts) based on Defines/Consumes keyword matching.

**[output-parser.ts](./output-parser.ts)** — Extracts file paths and contents from AI responses using delimiter-based parsing (`===FILE:===` / `===END_FILE===`) with markdown fenced block fallback (```` ```language:path ````), returning `Map<string, string>` for filesystem writes.

### Prompt Engineering

**[prompts.ts](./prompts.ts)** — Defines `REBUILD_SYSTEM_PROMPT` enforcing delimiter format, exact spec compliance (no synonym substitution), and production code constraints (no tests/stubs/placeholders), plus `buildRebuildPrompt()` constructing per-unit prompts with full spec, phase-specific content, and accumulated built context.

### Type System

**[types.ts](./types.ts)** — Exports `RebuildCheckpointSchema` Zod validator with `specHashes`/`modules` fields, `RebuildUnit` interface with `name`/`specContent`/`order`, `RebuildPlan` with `units[]`/`outputDir`, and `RebuildResult` with token counts and `filesWritten[]`.

**[index.ts](./index.ts)** — Barrel export re-exporting all public types, schemas (`RebuildCheckpointSchema`), functions (`readSpecFiles`, `partitionSpec`, `parseModuleOutput`, `buildRebuildPrompt`, `executeRebuild`), classes (`CheckpointManager`), and constants (`REBUILD_SYSTEM_PROMPT`).

## Architecture

### Sequential Order Groups with Concurrent Execution

`executeRebuild()` groups `RebuildUnit[]` by `order` field into `Map<number, RebuildUnit[]>`, processes order values sequentially (ascending), executes units within each group concurrently via `runPool()` with configurable concurrency. Accumulates exported symbols from completed groups into `builtContext` string for injection into subsequent groups as "Already Built" context, enabling correct import resolution across phases.

### Checkpoint-Based Resume Workflow

`CheckpointManager.load()` compares SHA-256 hashes of current spec files against `checkpoint.specHashes`, returns `isResume: false` if hash count differs or any individual hash mismatches (drift detected). Filters `pendingUnits[]` via `checkpoint.isDone(unitName)` predicate, increments `modulesSkipped` counter for already-complete work. Workers call `checkpoint.markDone(unitName, filesWritten)` or `checkpoint.markFailed(unitName, errorMsg)` on completion, serializing writes via promise chain to prevent corruption.

### Context Accumulation with LRU Truncation

After each order group completes, `orchestrator.ts` reads all `filesWrittenInGroup` via `readFile()`, filters out non-source files (`.md`/`.json`/`.yml`), appends to `builtContext` with `// === ${filePath} ===` delimiters. When `builtContext.length > BUILT_CONTEXT_LIMIT` (100,000 chars), splits on delimiter pattern, preserves recent files in full, truncates older files to first `TRUNCATED_HEAD_LINES` (20 lines) with `// ... (truncated)` marker.

### Targeted API Injection (Change 2 Format)

`extractFromBuildPlan()` detects `/^\*\*Defines:\*\*|^Defines:/m` pattern in phase content, extracts keywords from Defines/Consumes lists and file path references, calls `findRelevantSubsections()` with fuzzy matching (substring, word overlap) to filter API/Data/Behavioral subsections. Injects matched subsections under `## Interfaces for This Phase`, `## Data Structures for This Phase`, `## Behavioral Contracts for This Phase` headings. Falls back to full `## Public API Surface` inclusion for legacy specs without Defines/Consumes (graceful degradation).

## Behavioral Contracts

**Delimiter format (primary output parsing):** `/===FILE:\s*(.+?)===\n([\s\S]*?)===END_FILE===/g`

**Fenced block format (fallback):** `/```\w*:([^\n]+)\n([\s\S]*?)```/g`

**Build Plan phase extraction:** `/^### Phase (\d+):\s*(.+)$/gm`

**Change 2 format detection:** `/^\*\*Defines:\*\*|^Defines:/m`

**Section heading pattern:** `/^## (?:\d+\.\s*)?${sectionName}\s*$/m`

**Subsection heading pattern:** `/^### (.+)$/gm`

**File path extraction:** `/\b(?:src\/[\w\-./]+|[\w-]+\.(?:ts|js|py|rs|go))\b/g`

**Context delimiter format:** `// === ${filePath} ===` (used for splitting truncated context)

## Integration Points

Invoked by `src/cli/rebuild.ts` command handler. Consumes `../ai/index.js` `AIService` for subprocess spawning, `../orchestration/index.js` `runPool`/`ProgressReporter`/`ITraceWriter` for concurrency control, `../change-detection/index.js` `computeContentHashFromString` for drift detection. Writes checkpoint to `<outputDir>/.rebuild-checkpoint` JSON, generated source files to `<outputDir>/<relativePath>` as specified in parsed AI responses.