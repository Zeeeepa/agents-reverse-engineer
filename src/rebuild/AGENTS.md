<!-- Generated by agents-reverse-engineer -->

# rebuild

Implements the `are rebuild` workflow: reconstructs source code from specification documents using AI-driven incremental code generation with checkpoint-based resumption and dependency-aware execution ordering.

## Contents

### Core Orchestration

**[orchestrator.ts](./orchestrator.ts)** — `executeRebuild()` entry point that sequences spec reading, checkpoint loading, order-based unit grouping, concurrent pool execution with context accumulation, and progress tracking. Coordinates `RebuildExecutionOptions` (outputDir, concurrency, failFast, force, debug, tracer, progressLog) through ten pipeline phases.

**[checkpoint.ts](./checkpoint.ts)** — `CheckpointManager` persists per-module completion status and spec file hashes to `{outputDir}/.rebuild-checkpoint` with thread-safe write serialization. Factory methods `load()` and `createFresh()` handle drift detection via `computeContentHashFromString()` hash comparison. Mutation methods `markDone()`, `markFailed()` update state and queue writes.

**[spec-reader.ts](./spec-reader.ts)** — `readSpecFiles()` loads `.md` files from `specs/` directory; `partitionSpec()` extracts `RebuildUnit[]` using `extractFromBuildPlan()` (parses `### Phase N:` subsections) or `extractFromTopLevelHeadings()` fallback. Implements Change 2 format detection via `/^\*\*Defines:\*\*|^Defines:/m` pattern, calls `findRelevantSubsections()` for targeted Architecture/API/Data/Behavioral context injection and `extractManifestEntriesForPhase()` for per-phase file lists.

### AI Interface

**[prompts.ts](./prompts.ts)** — `REBUILD_SYSTEM_PROMPT` constant defines delimiter format rules and quality mandates (exact symbol names, compilable code, no stubs). `buildRebuildPrompt()` assembles user prompt sections: Full Specification, Current Phase, Already Built context, Output Format reminder.

**[output-parser.ts](./output-parser.ts)** — `parseModuleOutput()` extracts file paths and contents from AI responses using delimiter primary format (`parseDelimiterFormat()` with `/^===FILE:\s*(.+?)===$/` and `/^===END_FILE===$/` line-anchored patterns) and fenced block fallback (`parseFencedBlockFormat()` with `/```\w*:([^\n]+)\n([\s\S]*?)```/g`).

### Data Structures

**[types.ts](./types.ts)** — `RebuildCheckpointSchema` validates checkpoint JSON (version, createdAt, updatedAt, outputDir, specHashes, modules). `RebuildUnit` represents atomic generation task (name, specContent, order). `RebuildResult` captures execution outcome with token metrics and filesWritten paths.

**[index.ts](./index.ts)** — Barrel export consolidating `RebuildCheckpoint`, `RebuildUnit`, `RebuildPlan`, `RebuildResult` types, `RebuildCheckpointSchema`, `readSpecFiles`, `partitionSpec`, `parseModuleOutput`, `buildRebuildPrompt`, `REBUILD_SYSTEM_PROMPT`, `executeRebuild`, `CheckpointManager`.

## Architecture

### Dependency-Aware Execution

Units sharing the same `order` value run concurrently via `runPool()`. After each order group completes, generated source files (excluding `.md`, `.json`, `.yml`) are read from `outputDir` and concatenated into `builtContext` string passed to subsequent groups via `buildRebuildPrompt()`. Context truncation activates when `builtContext.length > BUILT_CONTEXT_LIMIT` (100,000 characters): splits on `/\n\/\/ === /` delimiter, truncates older sections to `TRUNCATED_HEAD_LINES` (20 lines), preserves recent half of sections in full.

### Checkpoint Resumption

`CheckpointManager.load()` performs spec drift detection by comparing `checkpoint.specHashes` against current spec file hashes computed via `computeContentHashFromString()`. Returns `isResume: true` only when checkpoint exists, parses successfully, and all hashes match exactly. `getPendingUnits()` filters units where `modules[name].status` is `'pending'` or `'failed'`. Write serialization uses `writeQueue: Promise<void>` promise-chain pattern identical to `PlanTracker` and `TraceWriter`.

### Spec Partitioning Strategies

`extractFromBuildPlan()` matches `/^### Phase (\d+):\s*(.+)$/gm` to extract numbered phases. Detects Change 2 format via `/^\*\*Defines:\*\*|^Defines:/m` presence in build plan section. When detected, calls `findRelevantSubsections()` to match phase symbols against Architecture/API/Data/Behavioral subsections using case-insensitive fuzzy word matching, and `extractManifestEntriesForPhase()` to filter File Manifest entries by Defines list. Fallback `extractFromTopLevelHeadings()` splits on `/^## (.+)$/gm` for older spec formats.

## Behavioral Contracts

### Delimiter Format (Primary)
```
===FILE: path/to/file.ext===
[content]
===END_FILE===
```
Delimiters anchored to column 0 via `/^===FILE:\s*(.+?)===$/` and `/^===END_FILE===$/`. State machine in `parseDelimiterFormat()` accumulates lines between delimiters, handles unclosed blocks at EOF.

### Fenced Block Format (Fallback)
```
```typescript:src/foo.ts
content
```
```
Pattern: `/```\w*:([^\n]+)\n([\s\S]*?)```/g` where group 1 is file path, group 2 is content.

### Change 2 Format Detection
Detection pattern: `/^\*\*Defines:\*\*|^Defines:/m` in build plan section  
Symbol extraction: `/(?:\*\*Defines:\*\*|^Defines:)\s*(.+)/m` and `/(?:\*\*Consumes:\*\*|^Consumes:)\s*(.+)/m` with `[,;]` splitting  
File path matching: `/\b(?:src\/[\w\-./]+|[\w-]+\.(?:ts|js|py|rs|go))\b/g`

### Error Messages
- No specs: `"No spec files found in specs/. Run \"are specify\" first."`
- Invalid format: `'Could not extract rebuild units from spec files. Expected either a "## Build Plan" section with "### Phase N:" subsections, or top-level "## " headings. Check your spec file format.'`
- Empty AI output: `'AI produced no files for unit "${unit.name}". Response may have used unexpected format.'`

## Integration Points

**Consumed by:** `src/cli/rebuild.ts` calls `executeRebuild()` with `AIService` from `src/ai/index.js`

**Consumes:**
- `src/ai/index.js` → `AIService`, `AIResponse`
- `src/orchestration/index.js` → `runPool`, `ProgressReporter`, `ProgressLog`, `ITraceWriter`
- `src/change-detection/index.js` → `computeContentHashFromString`
- `src/version.js` → `getVersion`