<!-- Generated by agents-reverse-engineer -->

# src/rebuild

Orchestrates AI-driven project reconstruction from `.agents-reverse-engineer/specs/` markdown documents. Reads specification files via `readSpecFiles()`, partitions into ordered `RebuildUnit` instances grouped by `order` property, executes concurrent AI calls per group via `runPool()`, accumulates generated file content into `builtContext` for subsequent groups, and persists checkpoint state to `.rebuild-checkpoint` for resumability.

## Contents

### Core Orchestration

- **[orchestrator.ts](./orchestrator.ts)** — `executeRebuild()` main entry point processing units in sequential order groups (concurrent within group), accumulating built context after each group via `builtContext` string (truncated at 100k chars), managing `CheckpointManager` state, returning summary counts
- **[checkpoint.ts](./checkpoint.ts)** — `CheckpointManager` class with static factories `load()` (drift detection via spec hash comparison) and `createFresh()`, state mutation via `markDone()`/`markFailed()`, write serialization via promise-chain `queueWrite()` pattern, persists JSON to `{outputDir}/.rebuild-checkpoint`

### Specification Processing

- **[spec-reader.ts](./spec-reader.ts)** — `readSpecFiles()` reads all `.md` from `specs/` directory, `partitionSpec()` extracts `RebuildUnit[]` via `extractFromBuildPlan()` (parses `### Phase N:` subsections) or falls back to `extractFromTopLevelHeadings()`, performs targeted context injection matching symbols from `Defines:`/`Consumes:` lists to API subsections
- **[types.ts](./types.ts)** — `RebuildCheckpointSchema` Zod validator, `RebuildCheckpoint` type inferred from schema, `RebuildUnit` interface with `name`/`specContent`/`order` properties, `RebuildPlan` grouping spec files with units, `RebuildResult` capturing AI call outcome with token counts and file paths

### AI Integration

- **[prompts.ts](./prompts.ts)** — `buildRebuildPrompt()` constructs system/user prompt pair combining full specification, phase-specific content from `unit.specContent`, optional `builtContext` with prior module signatures, mandates delimiter format via `REBUILD_SYSTEM_PROMPT` constant
- **[output-parser.ts](./output-parser.ts)** — `parseModuleOutput()` extracts file content from AI response via `parseDelimiterFormat()` (state machine matching `===FILE: path===` at column 0) or `parseFencedBlockFormat()` (markdown fence pattern `/```\w*:([^\n]+)\n([\s\S]*?)```/g`), returns `Map<string, string>`

### Public API

- **[index.ts](./index.ts)** — Barrel re-export of `RebuildCheckpoint`, `RebuildUnit`, `RebuildPlan`, `RebuildResult` types, `RebuildCheckpointSchema`, `readSpecFiles()`, `partitionSpec()`, `parseModuleOutput()`, `buildRebuildPrompt()`, `executeRebuild()`, `CheckpointManager` class, `REBUILD_SYSTEM_PROMPT` constant

## Architecture

### Pipeline Flow

1. `readSpecFiles()` reads markdown from `specs/` directory
2. `partitionSpec()` extracts ordered `RebuildUnit[]` grouped by Build Plan phase number
3. `CheckpointManager.load()` restores session state or creates fresh checkpoint
4. `executeRebuild()` processes units in sequential order groups:
   - Within each group: concurrent AI calls via `runPool()`
   - After each group: accumulate generated file content into `builtContext`
   - Between groups: `builtContext` provides module signatures to next group
5. `CheckpointManager.markDone()` updates `.rebuild-checkpoint` after each unit completes
6. `CheckpointManager.flush()` ensures final state persisted

### Context Accumulation Strategy

`builtContext` string grows by appending full file content with delimiter `\n// === ${filePath} ===\n${content}\n` after each order group completes. When length exceeds `BUILT_CONTEXT_LIMIT` (100,000 characters), older file sections truncate to first `TRUNCATED_HEAD_LINES` (20 lines) while recent sections remain full. Files ending `.md`/`.json`/`.yml` skipped.

### Checkpoint Resumability

`CheckpointManager.load()` computes content hashes via `computeContentHashFromString()` for drift detection. Returns `{ manager, isResume: true }` only when checkpoint file exists, parses successfully, and all spec hashes match current content. `getPendingUnits()` filters modules with `status === 'pending' || status === 'failed'`. Resume skips completed modules and increments `modulesSkipped` counter.

## Behavioral Contracts

### Delimiter Format (from output-parser.ts)

Primary format requires `===FILE: path===` and `===END_FILE===` at start of line (column 0). Regex patterns:

- Start: `/^===FILE:\s*(.+?)===$/` (trimmed path in capture group 1)
- End: `/^===END_FILE===$/`

State machine in `parseDelimiterFormat()` uses `currentPath` variable and `contentLines` accumulator, handles unclosed blocks by flushing at EOF.

### Build Plan Phase Pattern (from spec-reader.ts)

`extractFromBuildPlan()` matches:

- Section header: `/^(## (?:\d+\.\s*)?Build Plan)\s*$/m`
- Phase subsections: `/^### Phase (\d+):\s*(.+)$/gm`

Change 2 format detection: `/^\*\*Defines:\*\*|^Defines:/m`

File path extraction: `/\b(?:src\/[\w\-./]+|[\w-]+\.(?:ts|js|py|rs|go))\b/g`

## File Relationships

- **orchestrator.ts** depends on checkpoint.ts (`CheckpointManager`), spec-reader.ts (`readSpecFiles`, `partitionSpec`), output-parser.ts (`parseModuleOutput`), prompts.ts (`buildRebuildPrompt`)
- **checkpoint.ts** imports `computeContentHashFromString` from `../change-detection/index.js`, `getVersion` from `../version.js`
- **spec-reader.ts** produces `RebuildUnit[]` consumed by orchestrator.ts
- **output-parser.ts** parses AI responses generated from prompts.ts templates
- **index.ts** re-exports public surface for consumption by `src/cli/rebuild.ts`

## Integration Points

- Reads specification files produced by `src/specify/` module
- Consumes `AIService` from `src/ai/index.js` for LLM-based code generation
- Uses `runPool()` from `src/orchestration/pool.js` for concurrent execution with shared iterator
- Writes reconstructed source files to `outputDir` (typically project root or temporary directory)
- Persists checkpoint to `.rebuild-checkpoint` JSON file for crash recovery

## Annex References

Full prompt template text: [index.annex.sum](./index.annex.sum)