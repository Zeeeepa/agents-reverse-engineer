<!-- Generated by agents-reverse-engineer v1.1.0 -->

# rebuild

Orchestrates checkpoint-resumable project reconstruction from specification documents via LLM-driven code generation with dependency-ordered execution and context accumulation.

## Contents

- [checkpoint.ts](./checkpoint.ts): `CheckpointManager` persists rebuild state to `.rebuild-checkpoint` with JSON schema validation. Static factories `load(outputDir, specFiles, unitNames)` and `createFresh(outputDir, specFiles, unitNames)` detect spec drift via `computeContentHashFromString` comparison. Instance methods `markDone(unitName, filesWritten)`, `markFailed(unitName, error)`, `getPendingUnits()` manage per-module status (`'pending'|'done'|'failed'`). Write serialization via promise-chain pattern prevents concurrent file corruption. Non-critical writes silently catch errors.
- [index.ts](./index.ts): Barrel export re-exporting `RebuildCheckpoint`, `RebuildUnit`, `RebuildPlan`, `RebuildResult`, `RebuildCheckpointSchema`, `readSpecFiles`, `partitionSpec`, `parseModuleOutput`, `buildRebuildPrompt`, `executeRebuild`, `CheckpointManager`, `REBUILD_SYSTEM_PROMPT` from types/spec-reader/output-parser/checkpoint/prompts/orchestrator modules.
- [orchestrator.ts](./orchestrator.ts): `executeRebuild(aiService, projectRoot, options)` invokes `readSpecFiles`, `partitionSpec`, groups `RebuildUnit[]` by `order` field, processes each group concurrently via `runPool` with `buildRebuildPrompt` → `aiService.call` → `parseModuleOutput` → `writeFile` flow. Accumulates `builtContext` from generated source files (delimiter `\n// === ${filePath} ===\n${content}\n`) for subsequent groups, truncates at `BUILT_CONTEXT_LIMIT` (100000 chars). Manages `CheckpointManager.load` resumption, emits `phase:start`/`phase:end` trace events. Returns `{modulesProcessed, modulesFailed, modulesSkipped}`.
- [output-parser.ts](./output-parser.ts): `parseModuleOutput(responseText)` parses LLM responses via delimiter format (`START_RE = /^===FILE:\s*(.+?)===$/`, `END_RE = /^===END_FILE===$/` anchored at column 0) or markdown fenced blocks (`/\`\`\`\w*:([^\n]+)\n([\s\S]*?)\`\`\`/g`). Returns `Map<string, string>` of file paths to content. Handles unclosed blocks, preserves indentation.
- [prompts.ts](./prompts.ts): `REBUILD_SYSTEM_PROMPT` constant (350 lines) instructs LLM to emit production code via `===FILE: path===`/`===END_FILE===` delimiters, prohibits stubs/tests, mandates identifier compliance. `buildRebuildPrompt(unit, fullSpec, builtContext)` constructs `{system, user}` pair injecting Full Specification, Current Phase (unit.specContent), Already Built (builtContext from prior groups), Output Format reminder.
- [spec-reader.ts](./spec-reader.ts): `readSpecFiles(projectRoot)` reads `specs/*.md` sorted alphabetically, throws `"No spec files found in specs/. Run "are specify" first."` if empty. `partitionSpec(specFiles)` extracts `RebuildUnit[]` via Build Plan strategy (parses `### Phase N:` subsections, injects Architecture + targeted API/Data/Behavioral subsections via `findRelevantSubsections` fuzzy matching against `Defines:`/`Consumes:` keywords) or top-level heading fallback. `extractManifestEntriesForPhase` filters File Manifest by Defines symbols. Returns units sorted by `order`.
- [types.ts](./types.ts): `RebuildCheckpointSchema` validates checkpoint structure with `modules` record mapping unit names to `{status: 'pending'|'done'|'failed', completedAt?, error?, filesWritten: string[]}`. `RebuildUnit` interface contains `name`, `specContent`, `order`. `RebuildPlan` aggregates `specFiles`, `units`, `outputDir`. `RebuildResult` tracks `success`, `filesWritten`, token metrics, `durationMs`, `model`, `error`.

## Execution Flow

`executeRebuild` invokes `readSpecFiles` → `partitionSpec` → `CheckpointManager.load` (resume or fresh) → group units by `order` → sequential group processing (concurrent within group via `runPool`) → accumulate `builtContext` from generated files → `checkpoint.markDone`/`markFailed` → return aggregate metrics. Each unit executes: `buildRebuildPrompt` (injecting full spec + already-built context) → `aiService.call` → `parseModuleOutput` (delimiter/fenced format) → `writeFile` to `outputDir`.

## Context Injection Strategy

Build Plan extraction via `spec-reader.ts` always injects Architecture section. When `Defines:`/`Consumes:` detected (regex `/^\*\*Defines:\*\*|^Defines:/m`), performs targeted injection: extracts keywords from Defines/Consumes lines, fuzzy matches against Public API Surface/Data Models/Behavioral Contracts subsection headings (case-insensitive, word length >3), concatenates matched subsections. Fallback to full Public API Surface for legacy specs. `extractManifestEntriesForPhase` filters File Manifest by symbols in Defines list.

Built context accumulation (post-group): reads generated source files (skips `.md`/`.json`/`.yml`), appends content with delimiter. Truncation when exceeds `BUILT_CONTEXT_LIMIT`: splits on `/\n\/\/ === /`, keeps recent half of sections full, truncates older sections to first `TRUNCATED_HEAD_LINES` (20 lines), formats as `\n// === ${head}\n// ... (truncated)\n`.

## Checkpoint Resumption

`CheckpointManager.load` computes `computeContentHashFromString` for each spec file content, compares against stored `checkpoint.specHashes`. Returns `isResume: false` (creates fresh checkpoint) if hash count differs (files added/removed) or any individual hash mismatches. `orchestrator.ts` filters units via `checkpoint.isDone`, processes only pending/failed modules. `checkpoint.flush()` ensures all queued writes complete before exit.

## Behavioral Contracts

Delimiter format (verbatim, column 0):
```
===FILE: relative/path/to/file.ext===
[file content]
===END_FILE===
```

Fenced block pattern: `/\`\`\`\w*:([^\n]+)\n([\s\S]*?)\`\`\`/g`

Build Plan section patterns:
- `/^(## (?:\d+\.\s*)?Build Plan)\s*$/m` (numbered or plain)
- `/^### Phase (\d+):\s*(.+)$/gm` (phase subsections)

Defines/Consumes detection: `/^\*\*Defines:\*\*|^Defines:/m`

File path extraction: `/\b(?:src\/[\w\-./]+|[\w-]+\.(?:ts|js|py|rs|go))\b/g`

Checkpoint file: `{outputDir}/.rebuild-checkpoint` (JSON, 2-space indent)

Context delimiter: `\n// === ${filePath} ===\n${content}\n`

Truncation constants: `BUILT_CONTEXT_LIMIT = 100_000`, `TRUNCATED_HEAD_LINES = 20`

Section split pattern: `/\n\/\/ === /`

Error messages:
- `"No spec files found in specs/. Run "are specify" first."` (readSpecFiles)
- `'Could not extract rebuild units from spec files. Expected either a "## Build Plan" section with "### Phase N:" subsections, or top-level "## " headings. Check your spec file format.'` (partitionSpec)

Warning format: `[warn] Skipping empty spec section: "${unit.name}"`