<!-- Generated by agents-reverse-engineer v1.0.1 -->

# rebuild/
The `rebuild/` directory orchestrates the project reconstruction pipeline using AI, managing session continuity via checkpoints, parsing AI-generated code, and structuring prompts for effective code generation from spec files.

## Contents
- [checkpoint.ts](./checkpoint.ts): `CheckpointManager` manages rebuild session continuity, persisting module completion status and spec file hashes.
- [index.ts](./index.ts): Barrel exports `RebuildCheckpoint`, `RebuildUnit`, `RebuildPlan`, `RebuildResult`, `RebuildCheckpointSchema`, `readSpecFiles`, `partitionSpec`, `parseModuleOutput`, `CheckpointManager`, `REBUILD_SYSTEM_PROMPT`, `buildRebuildPrompt`, `executeRebuild`, `RebuildExecutionOptions`.
- [orchestrator.ts](./orchestrator.ts): Orchestrates the rebuild pipeline, reading specs, managing checkpoints, invoking AI services, running tasks concurrently, and accumulating context from generated files.
- [output-parser.ts](./output-parser.ts): Parses multi-file AI output into a `Map<string, string>` from custom delimiters or markdown fenced code blocks.
- [prompts.ts](./prompts.ts): Defines AI prompt templates and builders (`REBUILD_SYSTEM_PROMPT`, `buildRebuildPrompt`) for project reconstruction.
- [spec-reader.ts](./spec-reader.ts): Reads and partitions spec files into `RebuildUnit`s, facilitating the 'rebuild' module's operations.
- [types.ts](./types.ts): Defines `Zod` schema and TypeScript interfaces (`RebuildCheckpointSchema`, `RebuildCheckpoint`, `RebuildUnit`, `RebuildPlan`, `RebuildResult`) for the rebuild module's checkpoint state, execution plan, individual processing units, and results.

## API Surface
- `executeRebuild(aiService: AIService, projectRoot: string, options: RebuildExecutionOptions)`: Executes the rebuild pipeline, processes `RebuildUnit`s, and returns a summary of processed modules.
- `CheckpointManager`: Provides static factory methods (`load`, `createFresh`) and instance methods (`markDone`, `markFailed`, `getPendingUnits`, `isDone`, `flush`, `initialize`, `getData`) for managing rebuild state.
- `parseModuleOutput(responseText: string)`: Parses AI-generated `responseText` into a `Map<string, string>` of file paths to content.
- `readSpecFiles(projectRoot: string)`: Reads and returns sorted `.md` spec files from `specs/` within `projectRoot`.
- `partitionSpec(specFiles: Array<{ relativePath: string; content: string }> )`: Partitions concatenated `specFiles` content into ordered `RebuildUnit[]`.
- `buildRebuildPrompt(unit: RebuildUnit, fullSpec: string, builtContext: string | undefined)`: Constructs the prompt pair for a rebuild unit.
- `REBUILD_SYSTEM_PROMPT`: A constant string defining the system prompt for AI.
- `RebuildExecutionOptions`: An interface defining `outputDir`, `concurrency`, `failFast`, `force`, `debug`, `tracer`, and `progressLog` for `executeRebuild`.
- `RebuildCheckpoint`: Type for the rebuild session checkpoint data.
- `RebuildUnit`: Interface defining `name`, `specContent`, and `order` for a single AI call.
- `RebuildPlan`: Interface describing the rebuild plan with `specFiles`, `units`, and `outputDir`.
- `RebuildResult`: Interface detailing a unit's execution outcome with `unitName`, `success`, `filesWritten`, `tokensIn`, `tokensOut`, `cacheReadTokens`, `cacheCreationTokens`, `durationMs`, `model`, and optional `error`.
- `RebuildCheckpointSchema`: Zod object schema for validating `RebuildCheckpoint` data.

## Architecture / Data Flow
The `orchestrator.ts`'s `executeRebuild` function orchestrates the rebuild process. It starts by calling `readSpecFiles` and `partitionSpec` from `spec-reader.ts` to prepare `RebuildUnit`s from project `specs/` files. `CheckpointManager.load` (from `checkpoint.ts`) manages persistent state for rebuild session continuity. `RebuildUnit`s are processed concurrently using `runPool` (from `../orchestration/index.js`), where each unit involves generating a prompt via `buildRebuildPrompt` (from `prompts.ts`), invoking an `AIService` call (from `../ai/index.js`), parsing AI output with `parseModuleOutput` (from `output-parser.ts`), and writing files, with `CheckpointManager` updating the unit's status. Context from generated files is accumulated for subsequent units.

## Configuration
- `BUILT_CONTEXT_LIMIT = 100_000`: Specifies the default character limit for truncating older group context in `orchestrator.ts`.
- `TRUNCATED_HEAD_LINES = 20`: Defines the number of lines to retain from the head of truncated files when context exceeds `BUILT_CONTEXT_LIMIT` in `orchestrator.ts`.

## Data Structures / Schemas
- `RebuildCheckpoint`: The core data structure from `checkpoint.ts` for storing rebuild state, including `specHashes` for spec file integrity and `modules` status (`pending`, `done`, `failed`).
- `RebuildCheckpointSchema`: A Zod object schema from `types.ts` that defines and validates the structure of `RebuildCheckpoint` files.
- `RebuildUnit`: An interface from `types.ts` defining a single AI call with `name: string`, `specContent: string`, and `order: number`.
- `RebuildPlan`: An interface from `types.ts` describing the overall rebuild plan, including `specFiles`, `units`, and `outputDir`.
- `RebuildResult`: An interface from `types.ts` detailing the outcome of a `RebuildUnit`'s execution.

## Behavioral Contracts
- Checkpoint file name: `checkpoint.ts` always uses `.rebuild-checkpoint` in the output directory.
- Checkpoint file content: `checkpoint.ts` writes JSON formatted with 2-space indentation.
- Module statuses: `checkpoint.ts` defines valid states for `modules` as 'pending', 'done', 'failed'.
- Delimiter format (for AI output parsing): `output-parser.ts` uses `START_RE` (`/^===FILE:\s*(.+?)===$/`) and `END_RE` (`/^===END_FILE===$/`) at column 0.
- Fenced block format (for AI output parsing): `output-parser.ts` uses `pattern` (`/\`\`\`\w*:([^\n]+)\n([\s\S]*?)\`\`\`/g`) to capture `filePath` and `content`.
- `REBUILD_SYSTEM_PROMPT` (from `prompts.ts`): Mandates exact file delimiters (`===FILE: relative/path.ext===`, `===END_FILE===`), code quality rules (compileable, production-ready), strict compliance with spec names and context awareness rules (import and use exported symbols from "Already Built" context).
- Error messages (from `spec-reader.ts`): `'No spec files found in specs/. Run "are specify" first.'` for missing spec files; `'Could not extract rebuild units from spec files. Expected either a "## Build Plan" section with "### Phase N:" subsections, or top-level "## " headings. Check your spec file format.'` for parsing failure.
- `buildPlanMatch` pattern (from `spec-reader.ts`): `^(## (?:\\d+\\.\\s*)?Build Plan)\\s*$` matches "Build Plan" sections.
- `phasePattern` pattern (from `spec-reader.ts`): `^### Phase (\\d+):\\s*(.+)$` matches phase subsections within "Build Plan".
- `headingPattern` pattern (from `spec-reader.ts`): `^## (.+)$` matches top-level headings.
- `extractSubsections` pattern (from `spec-reader.ts`): `^### (.+)$` matches subsections within a section.
- `definesMatch` / `consumesMatch` pattern (from `spec-reader.ts`): `(?:\*\*Defines:\*\*|^Defines:)\\s*(.+)\n` extracts symbols from `Defines:` or `Consumes:` lines.
- `pathRefs` pattern (from `spec-reader.ts`): `\\b(?:src/[\\w\\-./]+|[\\w-]+\\.(?:ts|js|py|rs|go))\\b` extracts file paths and module-like references.
- `extractSection` pattern (dynamic, from `spec-reader.ts`): `^## (?:\\d+\\.\\s*)?${sectionName}\\s*` matches sections by name.
- Console warning (from `spec-reader.ts`): `console.error` logs `[warn] Skipping empty spec section: "${unit.name}"` for empty `RebuildUnit.specContent`.

## Workflow & Conventions
- `spec-reader.ts` expects spec `.md` files to reside in the `specs/` directory at `projectRoot`.
- Spec content parsing in `spec-reader.ts` prioritizes the `## Build Plan` section structure, specifically `### Phase N:`.
- `RebuildUnit.order` property (from `spec-reader.ts` and `types.ts`) determines the processing sequence of partitioned units.

## File Relationships
- `checkpoint.ts` depends on `../change-detection/index.js` for `computeContentHashFromString`, `../version.js` for `getVersion`, and `./types.ts` for `RebuildCheckpointSchema` and `RebuildCheckpoint`. It also uses `node:fs/promises` and `node:path`.
- `orchestrator.ts` integrates with `../ai/index.js` for `AIService` and `../ai/types.js` for `AIResponse`. It uses `../orchestration/index.js` for `runPool`, `ProgressReporter`, `ProgressLog`, and `ITraceWriter`.
- `spec-reader.ts` and `orchestrator.ts` rely on `types.ts` for `RebuildUnit`.
- `index.ts` re-exports symbols from `checkpoint.ts`, `orchestrator.ts`, `output-parser.ts`, `prompts.ts`, `spec-reader.ts`, and `types.ts`.

## Reproduction-Critical Constants
- `REBUILD_SYSTEM_PROMPT` â€” AI system prompt for project reconstruction (27 lines)