<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src

The src directory is the root of the agents-reverse-engineer library, exporting `getVersion()` for runtime version string retrieval and aggregating 11 feature modules (ai, change-detection, cli, config, core, discovery, generation, imports, installer, integration, orchestration, output, quality, rebuild, specify, types, update) that collectively provide file discovery, AI-powered documentation generation, incremental updates, specification synthesis, and project reconstruction with integrated telemetry and quality validation.

## Contents

### Version Module
[version.ts](./version.ts) — Exports `getVersion(): string` via ESM introspection (`import.meta.url` → `fileURLToPath()` → `dirname()` to resolve `__dirname`), reads package.json from parent directory, returns `version` field or 'unknown' sentinel on fs/parse errors; silent error handling ensures return type always string.

## Subdirectories

### [ai/](./ai/)
Unified AI backend orchestration layer providing `AIService` (orchestrator wrapping any provider with retry/timeout/telemetry), `BackendRegistry` (backend enumeration with Claude/Codex/Gemini/OpenCode priority order), `SubprocessProvider` (CLI subprocess adapter), and `TelemetryLogger` (call/token/duration tracking with `.agents-reverse-engineer/logs/run-*.json` persistence). Handles polymorphic JSON/NDJSON response parsing, rate-limit detection, exponential backoff retry (3 attempts, 1–8s delay with jitter), subprocess timeout escalation (SIGTERM → SIGKILL after 5s grace), and structured trace events (subprocess:spawn, subprocess:exit, retry attempts).

### [change-detection/](./change-detection/)
Git-based file modification tracking via `getChangedFiles()` (parses `git diff --name-status -M` with rename detection, optional uncommitted tracking), `computeContentHash()` (SHA-256 hex digest for cache validation), and `isGitRepo()` / `getCurrentCommit()` for repo state checks. Supports incremental updates by detecting added/modified/deleted/renamed files with deduplication across staged/working/untracked changes.

### [cli/](./cli/)
Command-line interface routing eight commands (init, discover, generate, update, specify, rebuild, clean, install) plus auto-detected installer mode. Entry point `main()` parses POSIX arguments, resolves project root, loads config, orchestrates backend detection, manages dry-run/eval variants, handles trace/subprocess logging, and exits 0/1/2 based on success/failure. Embedded workflows: init creates config + .gitignore entry + VS Code exclude; discover builds GENERATION-PLAN.md; generate runs two-phase AI analysis; update processes changed files with hash-based change detection; specify synthesizes docs→spec with auto-generation fallback; rebuild reconstructs from specs with resumable checkpoints; clean removes artifacts with user-content preservation via marker prefix.

### [config/](./config/)
Configuration management with schema validation, defaults, and runtime loading. `loadConfig()` reads `.agents-reverse-engineer/config.yaml` with Zod validation, applies defaults (concurrency auto-detect: cores × 5 clamped to 2–20 based on memory, backend enum, timeoutMs=300s, maxRetries=3, telemetry.keepRuns=50, compressionRatio 0.1–1.0). `findProjectRoot()` locates `.agents-reverse-engineer/` directory. `getDefaultConcurrency()` calculates based on CPU count and available memory (0.512 GB per subprocess).

### [core/](./core/)
Unified public API aggregating 40+ exports across logging (Logger interface + nullLogger/consoleLogger implementations), AI services (AIService, withRetry, SubprocessProvider), discovery (discoverFiles, walkDirectory, applyFilters), prompts (buildFilePrompt, buildDirectoryPrompt, detectLanguage), writers (writeSumFile, readSumFile, writeAgentsMd), orchestration (GenerationOrchestrator, buildExecutionPlan), quality checks (extractExports, checkCodeVsDoc, checkPhantomPaths), change detection (computeContentHash, getChangedFiles), config (loadConfig, findProjectRoot), imports (extractImports, formatImportMap). Dependency injection (Logger parameter) decouples output behavior; marked @beta until v1.0.0.

### [discovery/](./discovery/)
File enumeration with composable filter chain: `walkDirectory()` (fast-glob with `.git/**` exclusion, symlink safe), then `applyFilters()` chains gitignore → vendor → binary → custom filters (bounded concurrency 30). `discoverFiles()` orchestrates pipeline, returns `FilterResult` with included/excluded files and filter attribution. Binary filter combines extension Set (O(1) lookup) + content analysis via `isBinaryFile`. Gitignore/custom filters use `ignore` library with pattern normalization. Trace events per-filter with match counts.

### [generation/](./generation/)
Documentation generation pipeline combining file discovery, complexity analysis, and plan execution. `collectAgentsDocs()` recursively walks for AGENTS.md; `analyzeComplexity()` computes fileCount/directoryDepth/ancestors; `buildExecutionPlan()` creates post-order sorted directory tasks (deepest first) for parallel file analysis + aggregated directory synthesis. `buildFilePrompt()` handles compression injection (ratio < 0.5), language detection, template substitution. `buildDirectoryPrompt()` orchestrates multi-step synthesis: reads .sum files, extracts imports, detects manifest files (package.json, Cargo.toml, etc.), preserves user content via `GENERATED_MARKER_PREFIX` detection. Variant support (e.g., "claude.haiku") propagates through path/naming. YAML-frontmatter .sum files track SHA-256 contentHash for change detection.

### [imports/](./imports/)
Import statement extraction via IMPORT_REGEX (global multiline, captures type keyword, named/namespace/default imports, module specifier); `extractImports()` per-file, `extractDirectoryImports()` first 100 lines per file (performance optimization). `formatImportMap()` outputs structured text with specifier → symbols grouping and (type) tags. Internal vs. external classification: `.` / `..` specifiers classified internal; others (npm, node:) excluded.

### [installer/](./installer/)
Interactive and automated installation across Claude Code, Codex, OpenCode, Gemini runtimes. `parseInstallerArgs()` extracts CLI flags (--runtime, -g/--local, --force, -q/--quiet, --help). `runInstaller()` orchestrates mode-selection (location, runtime), template generation per environment, hook registration in settings.json, permission registration (Claude Bash allow-list, Codex rules file `are.rules`, Gemini simplified hooks), ARE-VERSION tracking. `uninstallFiles()` / `unregisterHooks()` reverses all steps: removes templates, hook files, plugins, Codex rules, unregisters in settings.json. Cross-platform path resolution via `getRuntimePaths()` (Claude .claude, Codex .agents/.codex, OpenCode .opencode, Gemini .gemini). Dry-run mode skips writes but returns `InstallerResult` for preview.

### [integration/](./integration/)
Environment detection and command template generation. `detectEnvironments()` scans for `.claude/`, `.opencode/`, `.aider/`, `.gemini/` config directories. `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` return platform-specific IntegrationTemplate[] with markdown/TOML frontmatter. `generateIntegrationFiles()` creates command files per environment, copies bundled `are-session-end.js` hook for Claude. Placeholder substitution: COMMAND_PREFIX → `/are-`, VERSION_FILE_PATH (platform-specific), BACKEND_FLAG → `--backend {claude|opencode|gemini}`. Command lifecycle: display version, delete stale progress.log, spawn background ARE task with `run_in_background: true`, poll progress.log every 15s, summarize output on completion. `discover` command auto-classifies files (test/spec, CI/CD, tool configs, migrations, fixtures, type declarations, Docker/infra) with multi-select exclusion suggestions.

### [orchestration/](./orchestration/)
Multi-phase AI-driven documentation generation and incremental updates. `DocumentationOrchestrator` unifies generation (createPlan, prepareFiles, analyzeComplexity, buildProjectStructure, createFileTasks, createDirectoryTasks) and update (checkPrerequisites, discoverFiles, content-hash-based change detection, orphan cleanup, getAffectedDirectories) workflows. `CommandRunner` executes two-phase generation: Phase 1 concurrent file analysis (runPool with configurable concurrency, post-phase-1 quality checks: checkCodeVsDoc, checkCodeVsCode, checkPhantomPaths); Phase 2 post-order directory aggregation (depth descending ensures children complete before parents). `runPool()` executes async tasks with bounded concurrency, sparse result array, failFast abort. `ProgressReporter` streams to `.agents-reverse-engineer/progress.log` with moving-average ETA (format: `[X/Y] ANALYZING path`, `[X/Y] DONE Xs in/out tok model ~ETA`, `[X/Y] FAIL path error`). `PlanTracker` serializes checkbox updates to GENERATION-PLAN.md via promise-chain queue. `ITraceWriter` appends NDJSON trace events to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` with auto-populated seq, ts, pid, elapsedMs. Variant mode (eval) outputs to `.${backend}.${model}` suffixed paths, triggers writeAgentsMdHub aggregation. Subprocess logging (when --trace enabled) via `setSubprocessLogDir()` captures backend CLI stderr/stdout. Token accounting separates input/cache-read/cache-creation tokens; stored in RunSummary.

### [output/](./output/)
CLI output abstraction with colorized logging. `Logger` interface (6 methods: info, file, excluded, summary, warn, error) with `createLogger(options)` returning picocolors-formatted output (controlled by `colors` boolean flag) and `createSilentLogger()` no-op implementation. File method formats as green `"  +"` prefix; excluded as dim `"  -"` prefix with reason/filter suffix; summary as bold included count + dim exclusion count.

### [quality/](./quality/)
Inconsistency detection across code-vs-documentation and phantom path references. `extractExports()` regex heuristic (pattern: `^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)`, gm flags) parses TypeScript/JavaScript exports. `checkCodeVsDoc()` substring matching for extracted exports in sum content; `checkCodeVsCode()` detects duplicate exports across files. `checkPhantomPaths()` validates AGENTS.md path references via three RegExp patterns (markdown links, backtick paths, prose references) with `.js`→`.ts` fallback. `buildInconsistencyReport()` aggregates issues by type/severity with ISO 8601 timestamp, projectRoot, filesChecked, durationMs. `formatReportForCli()` outputs plain text with `[ERROR]`/`[WARN]`/`[INFO]` tags; `formatReportAsMarkdown()` generates GitHub table. Skip patterns (node_modules, .git, http:, {{, ${, *, glob patterns).

### [rebuild/](./rebuild/)
Project reconstruction from AI-readable specifications with resumable checkpoints. `readSpecFiles()` reads `.md` files from `specs/`; `partitionSpec()` extracts RebuildUnit[] from `## Build Plan` sections with `### Phase N:` subsections, injects contextual sections (Architecture, API Surface, Behavioral Contracts, File Manifest) when "Defines:"/"Consumes:" metadata present. `executeRebuild()` groups units by order field, processes sequentially, runs concurrent units within each group via runPool, accumulates exported symbols as context (builtContext) for downstream groups. `CheckpointManager` persists status and content hashes to `.rebuild-checkpoint` with three-stage drift detection (file exists, schema valid, hashes match). `parseModuleOutput()` extracts Map<filePath, content> from AI responses using `===FILE: path===` / `===END_FILE===` delimiters (primary) or markdown fence format (fallback). `buildRebuildPrompt()` combines system prompt, spec content, phase details, and built context. REBUILD_SYSTEM_PROMPT enforces compilable source, strict naming, no tests/stubs, production-ready code. Built context truncation at 100,000 chars splits on section markers, keeps recent half-groups in full, truncates older sections to 20-line heads with ellipsis. Checkpoint filename: `.rebuild-checkpoint` in output directory.

### [specify/](./specify/)
Specification synthesis from AGENTS.md documentation with conflict detection and multi-file splitting. `buildSpecPrompt()` constructs system + user prompt from AgentsDocs (from ../generation/collector), injects optional annex files, returns SpecPrompt. SPEC_SYSTEM_PROMPT mandates 12-section schema: Project Overview, Architecture, Public API Surface, Data Structures & State, Configuration, Dependencies, Behavioral Contracts (verbatim regex/format strings), Test Contracts, Build Plan (with "Defines:"/"Consumes:" cross-references to API Surface), Prompt Templates & System Instructions (annex reproduction), IDE Integration & Installer (verbatim command templates), File Manifest (exhaustive source file list with module/exports). `writeSpec()` writes markdown to disk; single-file mode directly to outputPath; multi-file mode splits on `^# ` regex (preamble → 00-preamble.md, each section → [slug].md via lowercase/whitespace→hyphen slugification). Conflict detection checks all target paths before writes (atomic validation); throws SpecExistsError on conflicts unless force=true. Parent directories created via `mkdir(..., { recursive: true })` with UTF-8 encoding.

### [types/](./types.ts)
Centralized discovery metadata: `ExcludedFile` (path, reason: "gitignore pattern" | "binary file" | "vendor directory"), `DiscoveryResult` (files[], excluded[]), `DiscoveryStats` (totalFiles, includedFiles, excludedFiles, exclusionReasons breakdown).

### [update/](./update/)
Incremental documentation regeneration orchestrated by change detection. `cleanupOrphans()` deletes .sum/.annex.sum for deleted/renamed sources; `cleanupEmptyDirectoryDocs()` removes AGENTS.md if no source files remain (GENERATED_FILES=['AGENTS.md', 'CLAUDE.md'] excluded from count). `getAffectedDirectories()` identifies all parent paths (up to root) requiring AGENTS.md regeneration. Progress tracked via UpdateProgress callbacks: onFileStart, onFileDone, onCleanup (for .sum/.agents-md deletions), onDirRegenerate (for AGENTS.md updates). UpdateResult aggregates analyzedFiles[], skippedFiles[], CleanupResult (deletedSumFiles[], deletedAgentsMd[]), regeneratedDirs[], git state (baseCommit, currentCommit), dryRun flag. Variant support propagates through per-variant .sum and AGENTS.md files.

## Module Dependencies (Import Map)

```
src/version → (none; standalone)
src/ai → backend vendors (claude CLI, codex CLI, etc); simple-git; node:child_process; node:crypto; picocolors
src/change-detection → simple-git; node:crypto; node:fs/promises
src/cli → all sibling modules; node:process; node:path; jsonc-parser
src/config → zod; yaml; node:fs; node:path; node:os
src/core → all sibling modules (ai, discovery, generation, orchestration, quality, change-detection, config, imports, output)
src/discovery → fast-glob; ignore; node:fs; node:path; identify-languages; binary-file
src/generation → all analysis/writing deps; node:path; node:fs; compression metrics
src/imports → node:fs; node:path
src/installer → node:fs; node:path; picocolors; interactive TTY handling
src/integration → node:fs; node:path; bundled hooks (hooks/dist/are-*.js)
src/orchestration → all sibling modules; picocolors; promise-chain queue pattern
src/output → picocolors; node:path
src/quality → node:fs; node:path; node:crypto
src/rebuild → node:fs; node:path; zod; promise-chain queue pattern
src/specify → node:fs; node:path
src/types → (types-only; no dependencies)
src/update → node:fs; node:path
```