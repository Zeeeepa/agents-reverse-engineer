---
generated_at: 2026-02-09T14:08:55.803Z
content_hash: b5b20a83f1fe73aea8e05063d8242f06c7f80b130820584ddee3aac3c07959d9
purpose: updateCommand orchestrates incremental documentation regeneration by detecting file changes via content-hash comparis...
---
**updateCommand orchestrates incremental documentation regeneration by detecting file changes via content-hash comparison, analyzing modified files through CommandRunner, regenerating AGENTS.md for affected directories, and managing telemetry/trace output.**

## Exported Interface

```typescript
export interface UpdateCommandOptions {
  uncommitted?: boolean;    // Include staged + working directory changes
  dryRun?: boolean;         // Show plan without writing files
  concurrency?: number;     // Override worker pool size
  failFast?: boolean;       // Abort on first analysis failure
  debug?: boolean;          // Enable verbose AI service logging
  trace?: boolean;          // Enable NDJSON trace emission
}

export async function updateCommand(
  targetPath: string,
  options: UpdateCommandOptions
): Promise<void>
```

## Execution Flow

updateCommand performs six sequential phases:

1. **Configuration Loading**: Loads config via loadConfig with tracer passed through for early trace event emission
2. **Plan Preparation**: Calls createUpdateOrchestrator().preparePlan() to detect file changes, compute affected directories, and identify orphaned .sum files
3. **Backend Resolution**: Uses resolveBackend() from createBackendRegistry() to detect available AI CLI (claude/gemini/opencode), exits with code 2 and getInstallInstructions() message if none found
4. **File Analysis**: Instantiates AIService, CommandRunner with progressLog parameter, executes runner.executeUpdate() for concurrent .sum generation
5. **Directory Regeneration**: Sequentially regenerates AGENTS.md for plan.affectedDirs by calling buildDirectoryPrompt() and writeAgentsMd() with manual task:start/task:done trace emission
6. **Finalization**: Calls aiService.finalize(), progressLog.finalize(), tracer.finalize(), cleanupOldTraces(), orchestrator.recordRun()

## Change Detection Strategy

UpdatePlan (from createUpdateOrchestrator) contains:
- `filesToAnalyze: FileChange[]` with status: 'added' | 'modified' | 'renamed'
- `filesToSkip: string[]` for hash-matched files
- `affectedDirs: string[]` computed via getAffectedDirectories() walking parent paths
- `cleanup.deletedSumFiles: string[]` and `cleanup.deletedAgentsMd: string[]` for orphan removal
- `isFirstRun: boolean` detecting missing baseline state
- `currentCommit: string` tracking git HEAD or synthetic hash

## Progress Monitoring

ProgressLog.create() writes to `.agents-reverse-engineer/progress.log` for tail -f monitoring. Writes header with timestamp, file counts, and directory counts before runner.executeUpdate(). ProgressReporter handles directory-level updates with onDirectoryStart()/onDirectoryDone() emitting token counts and durations.

## Trace Event Emission

Phase 2 (directory regeneration) manually emits trace events since it bypasses CommandRunner:
- `phase:start` with taskCount = plan.affectedDirs.length, concurrency = 1
- `task:start` per directory with taskLabel = dir || '.'
- `task:done` with success boolean, durationMs, optional error message
- `phase:end` with tasksCompleted/tasksFailed counters

## Exit Code Semantics

- **0**: All files succeeded or no files to process
- **1**: Partial failure (some files processed, some failed)
- **2**: Total failure (no files processed and failures occurred) or CLI_NOT_FOUND error from resolveBackend

## Subprocess Logging Integration

When options.trace is true, calls aiService.setSubprocessLogDir() with timestamped path under `.agents-reverse-engineer/subprocess-logs/` to capture stdout/stderr from execFile() spawns. Logs directory path via pc.dim() before execution.

## Dependencies

Imports createUpdateOrchestrator from '../update/index.js', writeAgentsMd and buildDirectoryPrompt from '../generation/', AIService/AIServiceError/createBackendRegistry/resolveBackend/getInstallInstructions from '../ai/', CommandRunner/ProgressReporter/ProgressLog/createTraceWriter/cleanupOldTraces from '../orchestration/'.

## Plan Formatting

formatPlan() displays:
- Current commit hash (first 7 chars via .slice(0, 7))
- File counts with pc.cyan() for analyze count, pc.dim() for skip count
- Status markers: pc.green('+') for added, pc.blue('R') for renamed, pc.yellow('M') for modified
- Rename annotations: `(was: ${file.oldPath})` in pc.dim()
- formatCleanup() helper lists deletedSumFiles and deletedAgentsMd with pc.red('-') markers