---
generated_at: 2026-02-09T16:10:20.904Z
content_hash: 51393074cfc44dc242f45c53188fb0f3513f9e01643ea37b0548f4c31f4691f3
purpose: update.ts implements the incremental documentation update CLI command, detecting changed files via SHA-256 hash compa...
---
**update.ts implements the incremental documentation update CLI command, detecting changed files via SHA-256 hash comparison, spawning concurrent AI analysis via CommandRunner, regenerating AGENTS.md for affected directories, and writing telemetry/trace logs with exit code 0/1/2 for success/partial/total failure.**

## Exported Function

`updateCommand(targetPath: string, options: UpdateCommandOptions): Promise<void>` — Main entry point for the `are update` CLI command. Orchestrates seven-step workflow: (1) loads config via `loadConfig()`, (2) creates `UpdateOrchestrator` via `createUpdateOrchestrator()`, (3) generates `UpdatePlan` via `orchestrator.preparePlan()` with `includeUncommitted`/`dryRun` flags, (4) resolves AI backend via `resolveBackend()` and instantiates `AIService`, (5) executes Phase 1 file analysis via `runner.executeUpdate()` with configured concurrency, (6) executes Phase 2 AGENTS.md regeneration for `plan.affectedDirs` sequentially (concurrency=1), (7) finalizes telemetry via `aiService.finalize()` and records run state via `orchestrator.recordRun()`. Exits with code 0 (all success), 1 (partial failure with `summary.filesFailed > 0`), or 2 (total failure or CLI not found).

## Exported Interface

`UpdateCommandOptions` — Configuration for `updateCommand()` with fields:
- `uncommitted?: boolean` — Include staged + working directory changes in change detection
- `dryRun?: boolean` — Display plan without writing files
- `concurrency?: number` — Override config worker pool size
- `failFast?: boolean` — Abort on first file analysis error
- `debug?: boolean` — Enable verbose subprocess logging with heap/RSS metrics
- `trace?: boolean` — Emit NDJSON trace events to `.agents-reverse-engineer/traces/`

## AI Service Integration

Backend resolution follows pattern: `createBackendRegistry()` → `resolveBackend(registry, config.ai.backend)` → catch `AIServiceError` with `code === 'CLI_NOT_FOUND'` → print `getInstallInstructions(registry)` → `process.exit(2)`. Creates `AIService` instance with timeout/retry/model from config, enables debug mode via `aiService.setDebug(true)` if `options.debug`, configures subprocess log directory via `aiService.setSubprocessLogDir(logDir)` if `options.trace` (path pattern: `.agents-reverse-engineer/subprocess-logs/<ISO-timestamp>/`).

## Update Plan Display

`formatPlan(plan: UpdatePlan): string` — Renders plan summary with sections: baseline commit hash (7-char abbreviated), file counts (`analyzeCount`, `skipCount`, `cleanupCount`), file list with status markers (`+` for added via `pc.green()`, `R` for renamed via `pc.blue()`, `M` for modified via `pc.yellow()`, `=` for unchanged via `pc.dim()`), cleanup actions via `formatCleanup()`, affected directories for AGENTS.md regeneration. Returns early with message "No changes detected since last run." if all counts are zero.

`formatCleanup(plan: UpdatePlan): string[]` — Formats `plan.cleanup.deletedSumFiles` and `plan.cleanup.deletedAgentsMd` arrays with `pc.red('-')` markers under `pc.yellow()` headers "Cleanup (deleted .sum files):" and "Cleanup (deleted AGENTS.md from empty dirs):".

## Phase Execution

**Phase 1 (File Analysis):** Invokes `runner.executeUpdate(plan.filesToAnalyze, absolutePath, config)` with `CommandRunner` configured with `concurrency` from options/config. Returns `summary` object with `filesProcessed`/`filesFailed` counts. Writes progress to `ProgressLog` instance created via `ProgressLog.create(absolutePath)` with initial metadata: `=== ARE Update (<ISO-timestamp>) ===`, `Project: <absolutePath>`, `Files to analyze: <count> | Directories: <count>`.

**Phase 2 (Directory Regeneration):** Iterates `plan.affectedDirs` sequentially (no worker pool). For each directory: (1) reads existing `AGENTS.md` via `readFile()` and checks for `GENERATED_MARKER`, stores as `existingAgentsMd` context, (2) builds prompt via `buildDirectoryPrompt(dirPath, absolutePath, debug, knownDirs, undefined, existingAgentsMd)` where `knownDirs = new Set(plan.affectedDirs)`, (3) calls `aiService.call()` with prompt, (4) writes output via `writeAgentsMd()`, (5) emits trace events `task:start`/`task:done` with `phase: 'update-phase-dir-regen'`. Emits phase-level events `phase:start`/`phase:end` with `phase: 'update-phase-dir-regen'`, `taskCount`, `tasksCompleted`, `tasksFailed`. Updates `ProgressReporter` via `onDirectoryStart()`/`onDirectoryDone()` with token counts and duration. Catches errors and logs via `pc.yellow('WARN')` without aborting loop (continues to next directory).

## Trace Integration

Creates `TraceWriter` via `createTraceWriter(absolutePath, options.trace ?? false)` before config loading (used in `loadConfig()` and `createUpdateOrchestrator()` options). Passes `tracer` to `CommandRunner` constructor for worker/task event emission. Phase 2 manually emits events with `type: 'phase:start'/'phase:end'/'task:start'/'task:done'`, `phase: 'update-phase-dir-regen'`. Finalizes trace via `tracer.finalize()` and cleans old traces via `cleanupOldTraces(absolutePath)` if `options.trace`. Logs trace file path to stderr via `pc.dim('[trace] Writing to <path>')`.

## Progress Logging

Creates `ProgressLog` instance with header lines: `=== ARE Update (<ISO-timestamp>) ===`, `Project: <absolutePath>`, `Files to analyze: <count> | Directories: <count>`, empty line. Passes `progressLog` to `CommandRunner` and `ProgressReporter` for real-time streaming output. Finalizes via `progressLog.finalize()` after Phase 2 completion. Designed for tail -f monitoring pattern.

## First Run Handling

Checks `plan.isFirstRun` flag after `orchestrator.preparePlan()`. Prints `pc.yellow()` message: "First run detected. Use 'are generate' for initial documentation." followed by "Hint: Run 'are generate' first to create initial documentation. Then run 'are update' after making changes." Returns early without backend resolution or execution phases.

## No-Change Handling

After first run check, verifies `plan.filesToAnalyze.length === 0 && plan.cleanup.deletedSumFiles.length === 0 && plan.cleanup.deletedAgentsMd.length === 0`. Prints `pc.green('All files are up to date.')` and returns early.

## Exit Code Strategy

After telemetry finalization and run state recording:
- `process.exit(2)` if `summary.filesProcessed === 0 && summary.filesFailed > 0` (total failure)
- `process.exit(1)` if `summary.filesFailed > 0` (partial failure)
- Implicit exit code 0 if all files succeeded or no files to process

Also uses `process.exit(2)` during backend resolution if `AIServiceError` with `code === 'CLI_NOT_FOUND'` caught.

## Dry Run Mode

If `options.dryRun` is true, displays plan via `console.log(formatPlan(plan))` then logs "Dry run complete. No files written." and returns early before backend resolution phase. Does not create AI service or execute Phase 1/Phase 2.

## State Recording

Calls `orchestrator.recordRun(plan.currentCommit, summary.filesProcessed, filesSkipped)` after telemetry finalization where `filesSkipped = plan.filesToSkip.length`. Comment indicates this is "no-op in frontmatter mode, kept for API compatibility" (legacy from state file approach before SHA-256 hash migration).

## Dependencies

Imports: `path` (Node.js), `readFile` from `node:fs/promises`, `pc` (picocolors), `loadConfig` from `../config/loader.js`, `createLogger` from `../output/logger.js`, `createUpdateOrchestrator`/`UpdatePlan` from `../update/index.js`, `writeAgentsMd`/`GENERATED_MARKER` from `../generation/writers/agents-md.js`, `buildDirectoryPrompt` from `../generation/prompts/index.js`, `AIService`/`AIServiceError`/`createBackendRegistry`/`resolveBackend`/`getInstallInstructions` from `../ai/index.js`, `CommandRunner`/`ProgressReporter`/`ProgressLog`/`createTraceWriter`/`cleanupOldTraces` from `../orchestration/index.js`.