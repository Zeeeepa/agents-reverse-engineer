---
generated_at: 2026-02-09T17:45:04.766Z
content_hash: 51393074cfc44dc242f45c53188fb0f3513f9e01643ea37b0548f4c31f4691f3
purpose: `update.ts` implements the CLI entry point for incremental documentation updates via `updateCommand()`, detecting cha...
---
**`update.ts` implements the CLI entry point for incremental documentation updates via `updateCommand()`, detecting changed files through SHA-256 hash comparison, cleaning orphaned artifacts, resolving AI backends, executing concurrent file analysis via `CommandRunner`, and regenerating `AGENTS.md` for affected directories.**

## Exported Interface

`updateCommand(targetPath: string, options: UpdateCommandOptions): Promise<void>` — main entry point for the `are update` CLI command, orchestrates the incremental update workflow including plan preparation, backend resolution, AI service initialization, concurrent file analysis, and directory-level documentation regeneration. Exit codes: 0 (all success), 1 (partial failure), 2 (total failure/no CLI found).

`UpdateCommandOptions` — configuration interface with fields:
- `uncommitted?: boolean` — include staged + working directory changes via `git status --porcelain`
- `dryRun?: boolean` — display update plan without writing files
- `concurrency?: number` — override worker pool size (1-10, default from config)
- `failFast?: boolean` — abort on first task failure
- `debug?: boolean` — enable verbose subprocess logging with heap/RSS metrics
- `trace?: boolean` — emit NDJSON trace events to `.agents-reverse-engineer/traces/`

## Update Workflow

`updateCommand()` executes a six-phase incremental workflow:

1. **Trace initialization**: `createTraceWriter()` before config loading to enable tracing throughout orchestrator
2. **Plan preparation**: `orchestrator.preparePlan({ includeUncommitted, dryRun })` returns `UpdatePlan` with `filesToAnalyze`, `filesToSkip`, `cleanup` (deleted `.sum` files, deleted `AGENTS.md`), `affectedDirs`, `currentCommit`, `isFirstRun`
3. **Backend resolution**: `resolveBackend(registry, config.ai.backend)` with error handling for `CLI_NOT_FOUND` (prints install instructions, exits with code 2)
4. **AI service setup**: instantiates `AIService` with timeout/retry config, enables debug mode if `--debug`, sets subprocess log directory if `--trace` (creates timestamped subdirectory in `.agents-reverse-engineer/subprocess-logs/`)
5. **File analysis**: `runner.executeUpdate(plan.filesToAnalyze, absolutePath, config)` processes changed files concurrently, returns `summary` with `filesProcessed`, `filesFailed`
6. **Directory regeneration**: iterates `plan.affectedDirs` sequentially (concurrency=1), reads existing `AGENTS.md` via `readFile()` checking for `GENERATED_MARKER`, calls `buildDirectoryPrompt()` with `existingAgentsMd` parameter for incremental context, invokes `aiService.call()`, writes via `writeAgentsMd()`

## Display Formatting

`formatPlan(plan: UpdatePlan): string` — renders update plan with status markers:
- File statuses: `+` (added, green), `R` (renamed, blue), `M` (modified, yellow), `=` (unchanged, dim)
- Displays `currentCommit` (7-char truncation), file counts (analyze/skip/cleanup), renamed file oldPath with `(was: ...)` annotation
- Special case: first run detection via `plan.isFirstRun` → suggests `are generate` for initial documentation
- Empty plan detection: all counts zero → "No changes detected since last run"

`formatCleanup(plan: UpdatePlan): string[]` — renders cleanup actions:
- `cleanup.deletedSumFiles` — orphaned `.sum` files (deleted/renamed sources)
- `cleanup.deletedAgentsMd` — `AGENTS.md` removed from empty directories

## Phase 2: Directory Regeneration

Sequential iteration over `plan.affectedDirs` with:
- `knownDirs` set prevents phantom path validation errors by passing to `buildDirectoryPrompt()`
- Reads existing `AGENTS.md` via `readFile()`, checks for `GENERATED_MARKER` substring (user-authored files skipped)
- Passes `existingAgentsMd` to `buildDirectoryPrompt()` for incremental update context (preserves user annotations)
- Emits trace events: `phase:start` (phase: `'update-phase-dir-regen'`), `task:start`/`task:done` for each directory
- Uses `ProgressReporter.onDirectoryStart()`/`onDirectoryDone()` for console/log output with token counts
- Error handling: logs `WARN` without aborting, increments `dirsFailed` counter

## Telemetry and State Management

After phase completion:
- `aiService.finalize(absolutePath)` writes run log to `.agents-reverse-engineer/logs/run-<timestamp>.json`
- `progressLog.finalize()` flushes human-readable `.agents-reverse-engineer/progress.log`
- `tracer.finalize()` writes buffered NDJSON trace events via promise-chain serialization
- `cleanupOldTraces(absolutePath)` if `--trace` enabled, retains 500 most recent trace files
- `orchestrator.recordRun(currentCommit, filesProcessed, filesSkipped)` — no-op in frontmatter mode (SHA-256 hashing), kept for API compatibility with legacy metadata tracking

## Progress Monitoring

`ProgressLog.create(absolutePath)` creates `.agents-reverse-engineer/progress.log` for real-time monitoring:
- Writes session header with ISO 8601 timestamp, project path, file/directory counts
- `progressLog.write()` called for each directory start/done event
- Enables `tail -f .agents-reverse-engineer/progress.log` pattern for long-running updates

## Exit Code Strategy

Determines exit code based on `summary.filesProcessed` and `summary.filesFailed`:
- Code 2: total failure (zero files processed, nonzero failed) or CLI not found
- Code 1: partial failure (some files processed, some failed)
- Code 0: all success (zero failures) or no files to process (no-op update)