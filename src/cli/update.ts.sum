---
generated_at: 2026-02-09T21:29:08.389Z
content_hash: f72387ba7fbe9c2ed2f2c101b3dd29830e879245ca679a4130bafe66b3b00a85
purpose: update.ts implements the incremental documentation update CLI command that detects changed files via hash comparison,...
---
**update.ts implements the incremental documentation update CLI command that detects changed files via hash comparison, cleans up orphaned artifacts, analyzes modified files concurrently via CommandRunner, and regenerates AGENTS.md for affected directories.**

## Exported Interface

**updateCommand(targetPath: string, options: UpdateCommandOptions): Promise<void>** — Main entry point for `are update` CLI command. Loads config, creates UpdateOrchestrator, prepares UpdatePlan, resolves AI backend, analyzes changed files via CommandRunner (Phase 1), regenerates AGENTS.md for affectedDirs (Phase 2), finalizes telemetry/tracing, and exits with status codes: 0=success, 1=partial failure, 2=total failure/no CLI.

**UpdateCommandOptions** — Interface with optional fields: `uncommitted?: boolean` (include staged+working changes), `dryRun?: boolean` (show plan without writes), `concurrency?: number` (worker pool size), `failFast?: boolean` (abort on first failure), `debug?: boolean` (show prompts/backend info), `trace?: boolean` (emit NDJSON to `.agents-reverse-engineer/traces/`), `model?: string` (override AI model).

## Workflow Steps

1. **Plan Preparation**: Calls `orchestrator.preparePlan({ includeUncommitted, dryRun })` returning UpdatePlan with `filesToAnalyze[]`, `filesToSkip[]`, `cleanup.deletedSumFiles[]`, `cleanup.deletedAgentsMd[]`, `affectedDirs[]`, `currentCommit`, `isFirstRun`.

2. **First Run Detection**: If `plan.isFirstRun === true`, prints hint to run `are generate` first and exits without processing.

3. **No Changes**: If `filesToAnalyze.length === 0` and cleanup arrays empty, prints "All files are up to date" and exits.

4. **Backend Resolution**: Creates `BackendRegistry`, calls `resolveBackend(registry, config.ai.backend)`. On `CLI_NOT_FOUND` error, prints `getInstallInstructions(registry)` and exits with code 2.

5. **AI Service Setup**: Instantiates `AIService(backend, { timeoutMs, maxRetries, model, telemetry })`. If `options.trace`, calls `aiService.setSubprocessLogDir(logDir)` to write subprocess stdout/stderr to timestamped directory.

6. **Phase 1 (File Analysis)**: Creates `CommandRunner(aiService, { concurrency, failFast, debug, tracer, progressLog })`, calls `runner.executeUpdate(plan.filesToAnalyze, absolutePath, config)` returning `summary` with `filesProcessed`, `filesFailed`.

7. **Phase 2 (Directory Regeneration)**: Iterates `plan.affectedDirs[]` sequentially (concurrency=1). For each dir, calls `buildDirectoryPrompt(dirPath, absolutePath, debug, knownDirs, undefined, existingAgentsMd)` passing existing AGENTS.md content if it contains `GENERATED_MARKER`. Calls `aiService.call({ prompt, systemPrompt })` and `writeAgentsMd(dirPath, absolutePath, response.text)`. Emits trace events: `phase:start`, `task:start`, `task:done`, `phase:end` with `phase='update-phase-dir-regen'`.

8. **Finalization**: Calls `aiService.finalize(absolutePath)` for telemetry, `progressLog.finalize()`, `tracer.finalize()`, `cleanupOldTraces(absolutePath)` if tracing enabled, `orchestrator.recordRun(commit, filesProcessed, filesSkipped)`.

## Plan Display

**formatPlan(plan: UpdatePlan): string** — Formats UpdatePlan into multi-line string with sections: header, baseline commit (first 7 chars), summary counts (analyze/skip/cleanup), file list with status markers (`+`=added, `M`=modified, `R`=renamed), cleanup actions, affected directories. Uses picocolors: `pc.cyan()` for file counts, `pc.green('+')`, `pc.yellow('M')`, `pc.blue('R')` for status, `pc.dim()` for unchanged files.

**formatCleanup(plan: UpdatePlan): string[]** — Returns array of formatted lines for `cleanup.deletedSumFiles[]` (yellow "Cleanup (deleted .sum files):" header, red `-` prefix) and `cleanup.deletedAgentsMd[]` (yellow "Cleanup (deleted AGENTS.md from empty dirs):" header).

## Exit Code Strategy

- **0**: All files succeeded or no files to process
- **1**: Partial failure (`summary.filesProcessed > 0 && summary.filesFailed > 0`)
- **2**: Total failure (`summary.filesProcessed === 0 && summary.filesFailed > 0`) or no AI CLI found

## Dependencies

Imports `loadConfig` from `../config/loader.js`, `createUpdateOrchestrator` + `UpdatePlan` from `../update/index.js`, `writeAgentsMd` + `GENERATED_MARKER` from `../generation/writers/agents-md.js`, `buildDirectoryPrompt` from `../generation/prompts/index.js`, `AIService` + `AIServiceError` + `createBackendRegistry` + `resolveBackend` + `getInstallInstructions` from `../ai/index.js`, `CommandRunner` + `ProgressReporter` + `ProgressLog` + `createTraceWriter` + `cleanupOldTraces` from `../orchestration/index.js`.

## Progress Logging

Creates `ProgressLog.create(absolutePath)` writing to `.agents-reverse-engineer/progress.log`. Writes header with ISO timestamp, project path, counts (files to analyze, directories). Passes to `CommandRunner` and `ProgressReporter.onDirectoryStart/Done()` for streaming ETA-enabled output. Calls `progressLog.finalize()` before exit.

## Trace Integration

If `options.trace === true`, creates `TraceWriter` via `createTraceWriter(absolutePath, true)`, prints trace file path to stderr with `pc.dim()`, threads `tracer` through `loadConfig()`, `createUpdateOrchestrator()`, `CommandRunner()`. Phase 2 manually emits events: `phase:start` with `taskCount=plan.affectedDirs.length`, `task:start/done` for each directory, `phase:end` with `durationMs`, `tasksCompleted`, `tasksFailed`.

## Incremental Update Context

Reads existing AGENTS.md via `readFile(path.join(dirPath, 'AGENTS.md'), 'utf-8')`. If content includes `GENERATED_MARKER`, passes as `existingAgentsMd` parameter to `buildDirectoryPrompt()` for incremental update context (LLM receives previous output to preserve user annotations). Skips if file missing (catch block sets `existingAgentsMd = undefined`).