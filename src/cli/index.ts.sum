---
generated_at: 2026-02-09T13:42:51.349Z
content_hash: 924c8a4758909171acb5565d1b6c72af498814466ed294a727bdb53b5e657129
purpose: CLI entry point dispatching commands (`init`, `discover`, `generate`, `update`, `specify`, `clean`, `install`, `unins...
---
**CLI entry point dispatching commands (`init`, `discover`, `generate`, `update`, `specify`, `clean`, `install`, `uninstall`) to their respective handlers with argument parsing, version display, and installer invocation.**

## Exported Functions

- `main(): Promise<void>` — Primary entry point parsing `process.argv.slice(2)` via `parseArgs()`, routing to command handlers, catching uncaught errors to log and `process.exit(1)`

## Imported Command Handlers

- `initCommand(path: string)` from `./init.js` — Creates `.agents-reverse-engineer/config.yaml` with defaults
- `discoverCommand(path: string, options: {})` from `./discover.js` — Discovers files and writes `GENERATION-PLAN.md`
- `generateCommand(path: string, options: GenerateOptions)` from `./generate.js` — Executes three-phase documentation pipeline
- `updateCommand(path: string, options: UpdateCommandOptions)` from `./update.js` — Incremental update via hash-based change detection
- `cleanCommand(path: string, options: CleanOptions)` from `./clean.js` — Removes `.sum`, `AGENTS.md`, `CLAUDE.md`, `GENERATION-PLAN.md`
- `specifyCommand(path: string, options: SpecifyOptions)` from `./specify.js` — Synthesizes `specs/SPEC.md` from `AGENTS.md` corpus
- `runInstaller(args: InstallerArgs)` from `../installer/index.js` — Installs/uninstalls commands and hooks to IDE config directories
- `parseInstallerArgs(args: string[]): InstallerArgs` from `../installer/index.js` — Parses installer-specific flags (`--runtime`, `-g`, `-l`, `--force`, `--help`, `--quiet`)

## Command Options Types

**GenerateOptions:**
- `dryRun?: boolean` — Preview plan without writing files
- `concurrency?: number` — Worker pool size override (1-10)
- `failFast?: boolean` — Abort on first task failure
- `debug?: boolean` — Show AI prompts and subprocess details
- `trace?: boolean` — Emit NDJSON trace events to `.agents-reverse-engineer/traces/`

**UpdateCommandOptions:**
- `uncommitted?: boolean` — Include working tree changes via `git status --porcelain`
- `dryRun?: boolean`
- `concurrency?: number`
- `failFast?: boolean`
- `debug?: boolean`
- `trace?: boolean`

**CleanOptions:**
- `dryRun?: boolean`

**SpecifyOptions:**
- `output?: string` — Custom output path (default: `specs/SPEC.md`)
- `force?: boolean` — Overwrite existing files
- `dryRun?: boolean`
- `multiFile?: boolean` — Split into `specs/<dirname>.md` per directory
- `debug?: boolean`
- `trace?: boolean`

## Argument Parsing Strategy

`parseArgs(args: string[])` returns `{ command, positional, flags, values }`:
- Extracts first non-flag argument as `command`
- Collects `--key value` pairs into `values: Map<string, string>`
- Boolean flags (`--dry-run`, `--debug`) stored in `flags: Set<string>`
- Short flag expansion: `-h` → `help`, `-g` → `global`, `-l` → `local`, `-V` → `version`
- Remaining non-flag arguments become `positional[]` (e.g., path arguments)

## Command Routing Logic

1. **Version flag (`--version`, `-V`)**: Calls `showVersion()` → logs `agents-reverse-engineer v${VERSION}` → `process.exit(0)`
2. **Help flag (`--help`, `-h`)**: Calls `showHelp()` if no command and no installer flags → logs `USAGE` → `process.exit(0)`
3. **No arguments**: Invokes `runInstaller()` with interactive mode (all flags `false`)
4. **Installer flags without command** (`--runtime`, `-g`, `-l`): Detected via `hasInstallerFlags()` → calls `runInstaller()` directly (supports `npx agents-reverse-engineer --runtime claude -g`)
5. **`install` command**: Re-parses args via `parseInstallerArgs()` → `runInstaller()`
6. **`uninstall` command**: Re-parses args, forces `uninstall: true`, calls `runInstaller()`
7. **Other commands**: Switch statement routes to command handlers with `positional[0] || '.'` as path default

## Version Resolution

`getVersion()` reads `package.json` from `../../package.json` relative to `dist/cli/index.js`:
- Uses `fileURLToPath(import.meta.url)` → `dirname()` → `join(__dirname, '..', '..', 'package.json')`
- Parses JSON, returns `version` field or `'unknown'` on error
- `VERSION` constant initialized at module load for `showVersion()` and `showVersionBanner()`

## Error Handling

- `main()` wrapped in `.catch()` logging `err.message` and exiting with code 1
- Unknown commands trigger `showUnknownCommand()` → stderr message → `process.exit(1)`
- Invalid arguments silently ignored in short flag parsing (unknown chars skipped)

## Usage Text

`USAGE` constant defines help text with:
- Command list (`install`, `uninstall`, `init`, `discover`, `generate`, `update`, `specify`, `clean`)
- Installer options (`--runtime`, `-g`, `-l`, `--force`)
- General options (`--debug`, `--trace`, `--dry-run`, `--output`, `--multi-file`, `--concurrency`, `--fail-fast`, `--uncommitted`)
- Example invocations showing runtime selection, global/local install, dry-run, concurrency override

## Concurrency Override

`values.get('concurrency')` parsed via `parseInt(..., 10)` for `GenerateOptions.concurrency` and `UpdateCommandOptions.concurrency` (1-10 range enforced downstream by pool executor)

## Shebang

`#!/usr/bin/env node` enables direct execution as `are` or `agents-reverse-engineer` binary via npm `bin` field in `package.json`