<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/cli

This directory exports the command-line interface for agents-reverse-engineer, providing eight CLI commands (install, init, discover, generate, update, specify, rebuild, clean) that coordinate with AI backends, file discovery, config management, and documentation generation pipelines.

## Contents

### Entry Point & Routing

- [**index.ts**](./index.ts) — `main()` entry point parsing POSIX arguments via `parseArgs()`, routing to command handlers (`initCommand`, `discoverCommand`, `generateCommand`, `updateCommand`, `cleanCommand`, `specifyCommand`, `rebuildCommand`), detecting installer mode via `hasInstallerFlags()`, and outputting help/version. Handles 8 explicit commands plus auto-detected installer via flag combination (`--global`/`--local`/`--force`/`--runtime`).

### Command Implementations

- [**init.ts**](./init.ts) — `initCommand()` creates `.agents-reverse/config.yaml`, updates `.gitignore` to append `*.sum` under `# agents-reverse-engineer` section via `ensureGitignoreEntry()`, configures VS Code via `ensureVscodeExclude()` (using `jsonc-parser` for surgical edits to preserve comments/formatting).

- [**discover.ts**](./discover.ts) — `discoverCommand()` orchestrates file discovery via `discoverFiles()`, loads filter rules via `loadConfig()`, emits trace events (`discovery:start`, `discovery:end`), calls `createOrchestrator().createPlan()` and `buildExecutionPlan()` to partition files, logs results (included/excluded), and writes `.agents-reverse-engineer/GENERATION-PLAN.md` via `formatExecutionPlanAsMarkdown()`.

- [**generate.ts**](./generate.ts) — `generateCommand()` executes full documentation generation: discovers files, creates analysis plan, resolves AI backend via `resolveBackend()`, initializes `AIService` with configurable timeouts/retries/model, runs two-phase `CommandRunner.executeGenerate()` pipeline (file analysis + directory AGENTS.md generation), handles dry-run via `dryRunVariant`, supports eval mode (namespace output by `${backend}.${model}`), writes telemetry/traces, exits 0/1/2.

- [**update.ts**](./update.ts) — `updateCommand()` detects changed files via content-hash (git diff + uncommitted flag), resolves backend, executes `CommandRunner.executeUpdate()` for concurrent file analysis, regenerates AGENTS.md per affected directory by `buildDirectoryPrompt()` + AI call + `writeAgentsMd()`, handles variant mode and cleanup of deleted `.sum`/`AGENTS.md` files, exits 0/1/2 based on success/failure counts.

- [**specify.ts**](./specify.ts) — `specifyCommand()` synthesizes AGENTS.md into project specification: checks conflicts via spec file existence, auto-triggers `generateCommand()` if no docs exist, collects docs via `collectAgentsDocs()` + annex files via `collectAnnexFiles()`, builds prompt via `buildSpecPrompt()`, calls `AIService` (model upgraded to opus), writes output (single or multi-file) via `writeSpec()`, traces phase lifecycle with `createTraceWriter()`.

- [**rebuild.ts**](./rebuild.ts) — `rebuildCommand()` reconstructs projects from specs: reads spec files via `readSpecFiles()`, partitions into units via `partitionSpec()`, loads checkpoint state via `CheckpointManager.load()` for resumable builds, resolves backend, executes `executeRebuild()` with 15min+ timeout (AI model upgraded to opus), writes progress via `ProgressLog`, exits 0/1/2.

- [**clean.ts**](./clean.ts) — `cleanCommand()` deletes generated artifacts: removes all `*.sum` files via glob, filters `AGENTS.md`/`CLAUDE.md` by marker prefix (`GENERATED_MARKER_PREFIX`) to preserve user-authored files, deletes `.agents-reverse-engineer/GENERATION-PLAN.md`, restores `.AGENTS.local.md` → `AGENTS.md` and `.CLAUDE.local.md` → `CLAUDE.md` via rename, logs operations (dry-run mode available via `dryRun: true`).

## Behavioral Contracts

**CLI Argument Parsing** (`parseArgs`): POSIX-style flags (short `-h`, `-g`, `-l`, `-V`; long `--flag` or `--flag value`); stops at first non-flag positional arg (command name); returns `{command, positional, flags, values}` structure. Version string formatted as `agents-reverse-engineer v${VERSION}`.

**Exit Codes**: 0 on help/version/success, 1 on partial failure (filesProcessed > 0 && filesFailed > 0) or conflict, 2 on total failure (filesProcessed === 0 && filesFailed > 0) or backend CLI not found (`AIServiceError` code `'CLI_NOT_FOUND'`).

**Trace Events**: Commands emit `discovery:start(targetPath)`, `discovery:end(filesIncluded, filesExcluded, durationMs)`, `phase:start(phase, taskCount, concurrency)`, `phase:end(phase, durationMs, success)`, `task:start/done(taskLabel, durationMs, success)` via `ITraceWriter.emit()` interface; events written to `.agents-reverse-engineer/traces/${ISO}.json` when `--trace` enabled.

**Model Cascade**: CLI flag (`--model`) > config file (`config.ai.model`) > command default (e.g., "opus" for specify/rebuild; varies for others). Sonnet auto-upgraded to opus for specify/rebuild.

**Backend Provisioning**: `createBackendRegistry()` enumerates available backends; `resolveBackend(registry, backendName)` validates CLI availability (throws `AIServiceError` code `'CLI_NOT_FOUND'` if missing); `backend.ensureProjectConfig?.(path)` idempotent provisioning (e.g., OpenCode agent config).

**Dry-Run & Eval Modes**: `--dry-run` prints execution plan (file counts, directories, estimated AI calls) without AI invocations or writes. `--eval` namespaces output (`*.${backend}.${model}.sum`, `AGENTS.${variant}.md`) for A/B comparison; logs `[eval] Variant: ${variant}`.

**Subprocess Logging**: When `--trace` enabled, `setSubprocessLogDir(`.agents-reverse-engineer/subprocess-logs/${ISO-timestamp}/)` captures backend CLI stderr/stdout; ISO timestamp formatted with hyphens replacing colons/periods for filesystem safety.

**Config Loading**: All commands call `loadConfig(absolutePath, {tracer, debug})` which reads `.agents-reverse/config.yaml` via `configExists()`, applies defaults, and surfaces `config.ai.{backend, model, concurrency, timeoutMs, maxRetries, telemetry.keepRuns}`.

**Progress Logging**: `ProgressLog.create(absolutePath)` writes to `.agents-reverse-engineer/progress.log` with timestamped header, status lines, file counts; `finalize()` on command exit.

**Error Messages**: Permission denied (EACCES/EPERM) exit 1 with helpful message; unknown commands trigger `showUnknownCommand(command)` then exit 1; install instructions printed on backend CLI not found via `getInstallInstructions(registry)`.

## Workflow & Conventions

**Installer Integration**: Commands `install` and `uninstall` delegate to `runInstaller(args)` which re-parses via `parseInstallerArgs()` for install-specific options (`--runtime`, `--global`, `--local`, `--force`). Empty args launches interactive installer. Other commands use extracted CLI flags/values directly.

**File Path Resolution**: All commands resolve targetPath to project root via `findProjectRoot(targetPath)` before proceeding; default path is `.` (current directory) if positional arg omitted.

**Conflict Detection**: `specify` checks `specs/SPEC.md` (or `options.output`) for existence unless `--force`; scans output directory in multi-file mode; exits code 1 on conflict. `init` warns if config exists unless `--force`.

**Auto-Generation Trigger**: `specify` automatically runs `generateCommand()` if `collectAgentsDocs()` returns empty (no AGENTS.md found); re-collects after generation; exits code 1 if still empty.

**Variant (Eval) Output**: When `--eval` flag set, variant computed as `${backend.name}.${effectiveModel}`; output files prefixed (e.g., `*.claude.opus.sum`); hub index written via `writeAgentsMdHub()` for variant aggregation.

**Timeout Escalation**: Specify and rebuild commands enforce minimum timeouts (900_000ms = 15min) via `Math.max(config.ai.timeoutMs, 900_000)` to handle complex AI workloads.