---
generated_at: 2026-02-09T16:09:51.805Z
content_hash: 6632cd3ce8671181e7aecae242f25345ffa0351e4e81efefd82c9b04a55865c9
purpose: cleanCommand() deletes generated ARE documentation artifacts (.sum files, AGENTS.md with marker, CLAUDE.md, GENERATIO...
---
**cleanCommand() deletes generated ARE documentation artifacts (.sum files, AGENTS.md with marker, CLAUDE.md, GENERATION-PLAN.md) while preserving user-authored AGENTS.md and restoring AGENTS.local.md backups.**

## Exported Interface

**CleanOptions** interface with:
- `dryRun: boolean` — Preview deletions without modifying filesystem (default: false)

**cleanCommand(targetPath: string, options: CleanOptions): Promise<void>** — Entry point for `are clean` command, resolves targetPath to absolute directory, discovers artifacts via fast-glob, filters AGENTS.md by `GENERATED_MARKER` presence, deletes generated files, restores AGENTS.local.md → AGENTS.md.

## Discovery Strategy

Uses `fast-glob` with three parallel glob calls:
- `**/*.sum` — All summary files
- `**/AGENTS.md` — Directory documentation (requires marker filtering)
- `**/AGENTS.local.md` — User-authored backups to restore

All globs use `{ cwd: resolvedPath, absolute: true, onlyFiles: true, dot: true, ignore: ['**/node_modules/**', '**/.git/**'] }` options.

Single-file checks via `access(filePath, constants.F_OK)` for:
- `CLAUDE.md` at project root
- `.agents-reverse-engineer/GENERATION-PLAN.md`

## User Content Preservation

**Generated vs. User-Authored Distinction:**
- Reads each `AGENTS.md` file with `readFile(file, 'utf-8')`
- Checks for substring `GENERATED_MARKER` (imported from `src/generation/writers/agents-md.js`)
- Marker present → add to `generatedAgentsFiles[]` for deletion
- Marker absent → add to `skippedAgentsFiles[]`, log preservation message
- Pattern prevents deletion of SDK documentation or manually written AGENTS.md files

**AGENTS.local.md Restoration:**
- `rename(localFile, agentsPath)` moves AGENTS.local.md → AGENTS.md
- Reverses the backup operation performed during generation phase
- Tracked separately in `restored` counter

## Error Handling

**Directory access validation:**
- `access(resolvedPath, constants.R_OK)` before operation
- `ENOENT` → log error, `process.exit(1)`
- `EACCES`/`EPERM` → log error, `process.exit(1)`
- Other errors → re-throw

**Per-file deletion:**
- Wraps `unlink()` and `rename()` in try-catch
- Logs failure message with `relativePath()` and error message
- Continues processing remaining files (no fail-fast)

## Output Format

**Discovery summary:**
```
Files that would be deleted: (if dryRun)
  path/to/file.sum
  path/to/AGENTS.md

Preserving user-authored AGENTS.md:
  docs/AGENTS.md

Files that would be restored: (if dryRun)
  path/AGENTS.local.md → path/AGENTS.md

N .sum file(s), M AGENTS.md file(s), P root doc(s), Q AGENTS.local.md to restore
```

**Completion message:**
- Dry run: `Dry run — no files were changed.` (yellow)
- Success: `Deleted N file(s), restored M AGENTS.local.md file(s).` (green)
- Failure messages logged individually per file

## Integration Points

**Imports:**
- `GENERATED_MARKER` from `src/generation/writers/agents-md.js` — HTML comment string for filtering
- `createLogger({ colors: true })` from `src/output/logger.js` — Terminal output with picocolors
- `fast-glob` — Artifact discovery with ignore patterns
- Node.js `fs/promises`: `access`, `readFile`, `rename`, `unlink`

**Invoked by:** `src/cli/index.ts` command dispatcher for `/are-clean` skill and `are clean` CLI command.