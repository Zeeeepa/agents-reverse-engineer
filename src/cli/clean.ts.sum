---
generated_at: 2026-02-09T21:28:44.765Z
content_hash: fb82f6dc396438418f253a67a108c8f9f8fe500665af1038dcc51aa018db3298
purpose: cleanCommand removes all generated documentation artifacts (.sum, .annex.md, AGENTS.md, CLAUDE.md, GENERATION-PLAN.md...
---
**cleanCommand removes all generated documentation artifacts (.sum, .annex.md, AGENTS.md, CLAUDE.md, GENERATION-PLAN.md) with marker-based filtering to preserve user-authored files and restoration of AGENTS.local.md backups.**

## Exported Interface

**cleanCommand(targetPath: string, options: CleanOptions): Promise<void>**
Executes artifact deletion workflow with dry-run support, selective AGENTS.md filtering via `GENERATED_MARKER` substring search, and AGENTS.local.md → AGENTS.md restoration.

**CleanOptions**
```typescript
interface CleanOptions {
  dryRun: boolean; // Preview deletions without filesystem modifications
}
```

## Artifact Discovery Strategy

Uses `fast-glob` with parallel Promise.all execution to discover four artifact classes:
- `**/*.sum` — file-level summaries with YAML frontmatter
- `**/*.annex.md` — companion files for reproduction-critical constants
- `**/AGENTS.md` — directory-level aggregated documentation
- `**/AGENTS.local.md` — user-authored backups created during generation

All globs exclude `**/node_modules/**` and `**/.git/**`, enable `dot: true` for hidden directories, use `absolute: true` paths for unlink operations.

## AGENTS.md Filtering Protocol

Reads each AGENTS.md file via `readFile(file, 'utf-8')`, performs substring search for `GENERATED_MARKER` (imported from `generation/writers/agents-md.ts`). Files containing marker added to `generatedAgentsFiles[]` for deletion, others added to `skippedAgentsFiles[]` and preserved. Prevents deletion of user-authored AGENTS.md (SDK documentation, project guides). Read errors silently skip file (no throw, no log).

## Single-File Cleanup Targets

Checks existence via `access(filePath, constants.F_OK)` for:
- `CLAUDE.md` at project root (path.join(resolvedPath, 'CLAUDE.md'))
- `.agents-reverse-engineer/GENERATION-PLAN.md` (path.join(resolvedPath, '.agents-reverse-engineer', 'GENERATION-PLAN.md'))

Non-existent files skipped without error. All single files added to `singleFiles[]` array merged with glob results.

## Restoration Workflow

For each AGENTS.local.md file, computes restoration target via `path.join(path.dirname(localFile), 'AGENTS.md')`. In dry-run mode, logs `would be restored` preview. In execution mode, calls `rename(localFile, agentsPath)` to undo the backup rename performed during generation. Tracks success count in `restored` variable, reports errors individually without aborting.

## Deletion Loop

Iterates `allFiles` array containing `.sum`, `.annex.md`, generated `AGENTS.md`, and single-file targets. Calls `unlink(file)` for each, increments `deleted` counter on success, logs error message with relative path on failure. Does not throw or exit on individual file deletion errors.

## Output Formatting

Uses `createLogger({ colors: true })` for terminal output with picocolors styling. Relative paths computed via `path.relative(resolvedPath, absPath)` for user-friendly display. Summary line formats counts with `pc.bold()` wrappers: `${pc.bold(String(sumFiles.length))} .sum file(s)`. Dry-run mode prints yellow warning via `pc.yellow('Dry run — no files were changed.')`. Success message uses `pc.green()` wrapper.

## Error Handling

Verifies target directory existence/permissions via `access(resolvedPath, constants.R_OK)`. Catches ENOENT (not found), EACCES/EPERM (permission denied), logs error and exits with code 1. Other errors rethrown. Individual file operation failures logged but do not abort command execution.

## Dependencies

- `fast-glob` — parallel artifact discovery with glob patterns
- `picocolors` — ANSI color formatting for terminal output
- `createLogger` from `output/logger.ts` — console logging abstraction
- `GENERATED_MARKER` from `generation/writers/agents-md.ts` — sentinel string for ARE-generated files
- `node:fs/promises` — async file operations (access, readFile, rename, unlink)
- `node:fs` constants — permission flags (R_OK, F_OK)
- `node:path` — path resolution and relative path computation