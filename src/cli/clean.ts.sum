---
generated_at: 2026-02-09T17:44:44.457Z
content_hash: fb82f6dc396438418f253a67a108c8f9f8fe500665af1038dcc51aa018db3298
purpose: `src/cli/clean.ts` implements the `are clean` command to delete all generated documentation artifacts (.sum files, AG...
---
**`src/cli/clean.ts` implements the `are clean` command to delete all generated documentation artifacts (.sum files, AGENTS.md, CLAUDE.md, GENERATION-PLAN.md) while preserving user-authored AGENTS.md and restoring AGENTS.local.md files.**

## Exported Interface

### CleanOptions
```typescript
interface CleanOptions {
  dryRun: boolean;  // Preview deletions without executing
}
```

### cleanCommand
```typescript
async function cleanCommand(
  targetPath: string,
  options: CleanOptions
): Promise<void>
```

Orchestrates deletion workflow: validates target path exists with read permissions, discovers artifacts via `fast-glob`, filters generated vs. user-authored AGENTS.md via `GENERATED_MARKER` substring search, displays deletion preview, deletes files via `unlink()`, restores AGENTS.local.md → AGENTS.md via `rename()`.

## Artifact Discovery Strategy

Uses parallel `fg.glob()` calls with shared ignore patterns `['**/node_modules/**', '**/.git/**']` to find:
- `**/*.sum` — per-file summaries
- `**/*.annex.md` — reproduction-critical constant annexes
- `**/AGENTS.md` — directory-level aggregations (requires marker filtering)
- `**/AGENTS.local.md` — user-authored files renamed during generation

Single-file existence checks via `access()` for:
- `CLAUDE.md` at project root
- `.agents-reverse-engineer/GENERATION-PLAN.md`

## Generated vs. User-Authored AGENTS.md Detection

Reads each discovered AGENTS.md file, checks for `GENERATED_MARKER` constant (`<!-- Generated by agents-reverse-engineer -->`) via `content.includes()`. Files without marker added to `skippedAgentsFiles[]` and excluded from deletion. Prevents accidental removal of SDK documentation or manually maintained AGENTS.md files.

## Deletion Workflow

**Dry-run mode (`options.dryRun: true`):**
- Displays all files that would be deleted/restored
- Logs preservation of user-authored AGENTS.md
- Exits without filesystem modifications
- Emits yellow warning: `'Dry run — no files were changed.'`

**Execution mode:**
- Iterates `allFiles = [...sumFiles, ...annexFiles, ...generatedAgentsFiles, ...singleFiles]`
- Deletes each via `unlink()`, increments `deleted` counter, logs errors without aborting
- Iterates `localAgentsFiles`, restores via `rename(localFile, 'AGENTS.md')`, increments `restored` counter
- Emits green summary: `'Deleted N file(s), restored M AGENTS.local.md file(s).'`

## Error Handling

**Path validation:**
- `ENOENT` → logs `'Directory not found'`, exits with code 1
- `EACCES`/`EPERM` → logs `'Permission denied'`, exits with code 1
- Other errors rethrown

**File operations:**
- `unlink()` failures logged as `'Failed to delete <path>: <message>'` without aborting
- `rename()` failures logged as `'Failed to restore <path>: <message>'` without aborting
- `readFile()` failures during marker detection silently skip file (no log entry)

## Dependencies

- `fast-glob` — parallel artifact discovery with glob patterns
- `picocolors` — terminal formatting for dry-run warnings and success messages
- `src/output/logger.js` → `createLogger()` for structured logging
- `src/generation/writers/agents-md.js` → `GENERATED_MARKER` constant for detection logic

## Output Format

Displays relative paths via `path.relative(resolvedPath, absPath)` for readability. Summary line uses `pc.bold()` for file counts:
```
<count> .sum file(s), <count> .annex.md file(s), <count> AGENTS.md file(s), <count> root doc(s), <count> AGENTS.local.md to restore
```