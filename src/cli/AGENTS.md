<!-- Generated by agents-reverse-engineer -->

# cli

Command-line interface layer routing user-invoked commands (init, discover, generate, update, specify, clean) to orchestrator functions with argument parsing, backend resolution, dry-run preview, and process exit code management.

## Commands

**[index.ts](./index.ts)** — Entry point parsing `process.argv` via `parseArgs()`, routing to command handlers, launching interactive installer when invoked with no arguments, and catching uncaught errors to exit with status code 1. Handles short flags (`-h` → `help`, `-g` → `global`, `-V` → `version`) and long flags with optional values (`--concurrency 3`). Calls `hasInstallerFlags()` to detect direct installer invocation (`npx agents-reverse-engineer --runtime claude -g`). Exports `main()`, `parseArgs()`, `showVersion()`, `showHelp()`, `showUnknownCommand()`.

**[init.ts](./init.ts)** — Creates `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()` from `src/config/loader.js` with `--force` flag to overwrite existing configuration. Calls `configExists()` to check for existing configuration, logs warning with `configPath` location and suggests manual editing when file exists without force flag. Catches `EACCES`/`EPERM` errors during file creation, logs permission denial message, provides remediation hint, exits with status code 1.

**[discover.ts](./discover.ts)** — Scans directories via `discoverFiles()` from `src/discovery/run.js` applying filter chain (gitignore, vendor, binary, custom patterns), generates `GENERATION-PLAN.md` via `buildExecutionPlan()` from `src/generation/executor.js` with post-order directory traversal execution strategy. Emits `discovery:start`/`discovery:end` trace events with nanosecond hrtime conversion to milliseconds. Logs included files via `logger.file()`, excluded files via `logger.excluded()`, writes real-time progress to `.agents-reverse-engineer/progress.log` via `ProgressLog`. Exits with code 1 on plan write failure or directory access errors (`ENOENT`/`EACCES`/`EPERM`).

**[generate.ts](./generate.ts)** — Orchestrates three-phase pipeline: file discovery via `discoverFiles()`, planning via `createOrchestrator().createPlan()`, backend resolution via `resolveBackend()` from `createBackendRegistry()`, concurrent AI analysis via `CommandRunner.executeGenerate()`, and telemetry finalization via `aiService.finalize()`. Supports `--dry-run` flag bypassing AI calls, `--concurrency` override for worker pool size, `--fail-fast` abort on first task failure, `--debug` verbose subprocess logging, `--trace` NDJSON trace emission. Exits with code 2 if zero files succeeded with failures (`CLI_NOT_FOUND`), 1 if partial failures, 0 if all succeeded. Creates `TraceWriter` via `createTraceWriter()`, calls `cleanupOldTraces()` enforcing retention policy (500 most recent traces).

**[update.ts](./update.ts)** — Performs incremental documentation regeneration via content-hash comparison: calls `createUpdateOrchestrator().preparePlan()` detecting `FileChange` objects with status `added`/`modified`/`renamed`, computes `affectedDirs` via `getAffectedDirectories()` walking parent paths, executes `runner.executeUpdate()` for concurrent `.sum` generation, sequentially regenerates `AGENTS.md` for affected directories via `buildDirectoryPrompt()` and `writeAgentsMd()` with manual `task:start`/`task:done` trace emission. Supports `--uncommitted` flag merging staged + working directory changes, `--dry-run` preview showing plan without file writes, exit code semantics: 0 (success), 1 (partial failure), 2 (total failure or `CLI_NOT_FOUND`). Writes progress to `.agents-reverse-engineer/progress.log` via `ProgressLog.create()`, emits phase-level trace events for directory regeneration (bypasses `CommandRunner`), calls `cleanupOldTraces()` after finalization.

**[specify.ts](./specify.ts)** — Synthesizes project specifications from `AGENTS.md` documentation via `collectAgentsDocs()` recursive traversal, optionally auto-generates missing documentation via `generateCommand()` fallback when `docs.length === 0`, resolves AI backend via `resolveBackend()`, calls `AIService.call()` with prompts from `buildSpecPrompt()`, writes results via `writeSpec()` catching `SpecExistsError` for overwrite protection. Supports `--output` custom path (defaults to `specs/SPEC.md`), `--force` overwrite without prompting, `--dry-run` preview with token estimation (`totalChars / 4 / 1000`), `--multi-file` split output into per-directory specification files. Extends timeout to minimum 10 minutes via `Math.max(config.ai.timeoutMs, 600_000)`, finalizes telemetry via `aiService.finalize()` returning `summary` with `totalInputTokens`/`totalOutputTokens`/`totalDurationMs`. Exits with code 1 on file conflicts or post-generation validation failure, code 2 on backend resolution failure.

**[clean.ts](./clean.ts)** — Deletes generated documentation artifacts (`.sum`, `AGENTS.md`, `CLAUDE.md`, `GENERATION-PLAN.md`) via five-stage pipeline: validates `targetPath` via `access()` with `constants.R_OK`, discovers artifacts via three parallel `fg.glob()` calls for `**/*.sum`, `**/AGENTS.md`, `**/AGENTS.local.md` patterns with `node_modules`/`.git` exclusions, filters `AGENTS.md` files by reading content and checking for `GENERATED_MARKER` presence (imported from `src/generation/writers/agents-md.ts`) to distinguish ARE-generated docs from user-authored SDK documentation, checks single-file artifacts (`CLAUDE.md`, `.agents-reverse-engineer/GENERATION-PLAN.md`) via `access()` with `constants.F_OK`, executes deletion via `unlink()` and restoration via `rename()` for `AGENTS.local.md → AGENTS.md` mappings. Supports `--dry-run` flag displaying matched files with relative path formatting via `path.relative()` but skipping file operations. Logs user-authored files lacking marker in `skippedAgentsFiles[]` array, emits multi-line summary with bold counts via `pc.bold()`, final success message combining deletion and restoration counts via `pc.green()`.

## Command Options

**GenerateOptions** (`generate.ts`): `dryRun`, `concurrency` (1-10), `failFast`, `debug`, `trace` flags controlling worker pool size, subprocess verbosity, NDJSON trace emission, and execution halt behavior.

**UpdateCommandOptions** (`update.ts`): `uncommitted` (merge working tree changes), `dryRun`, `concurrency`, `failFast`, `debug`, `trace` flags with identical semantics to GenerateOptions.

**SpecifyOptions** (`specify.ts`): `output` (custom path), `force` (overwrite), `dryRun`, `multiFile` (split output), `debug`, `trace` flags with token estimation preview and auto-generation fallback.

**CleanOptions** (`clean.ts`): `dryRun` flag for preview-only mode without file deletion or restoration.

## Architecture Patterns

**Sequential command routing**: `index.ts` dispatches to handler functions (`initCommand`, `discoverCommand`, `generateCommand`, `updateCommand`, `specifyCommand`, `cleanCommand`) via switch statement on command name extracted by `parseArgs()`.

**Backend resolution pattern**: `generate.ts`, `update.ts`, `specify.ts` call `resolveBackend()` from `createBackendRegistry()`, catch `AIServiceError` with code `CLI_NOT_FOUND`, display installation instructions via `getInstallInstructions()`, exit with code 2 to distinguish from partial failures.

**Dry-run fork pattern**: `generate.ts`, `update.ts`, `specify.ts` compute execution plans via `buildExecutionPlan()` or `preparePlan()`, format via `formatPlan()` or `formatExecutionPlanAsMarkdown()`, print summary with `picocolors`, exit before AI calls when `options.dryRun === true`.

**Progress logging pattern**: Commands create `ProgressLog.create(absolutePath)` writing to `.agents-reverse-engineer/progress.log`, write headers with ISO 8601 timestamp and project path, finalize via `await progressLog.finalize()` ensuring file closure, support real-time monitoring via `tail -f .agents-reverse-engineer/progress.log`.

**Trace emission pattern**: Commands create `TraceWriter` via `createTraceWriter(absolutePath, options.trace ?? false)`, pass `tracer` parameter through orchestration stack (`CommandRunner`, `AIService`, `discoverFiles`), finalize via `tracer.finalize()`, call `cleanupOldTraces()` enforcing retention policy (500 most recent traces).

**Exit code semantics**: 0 (success), 1 (partial failure or file conflicts), 2 (total failure or `CLI_NOT_FOUND` error distinguishing installation issues from execution failures).