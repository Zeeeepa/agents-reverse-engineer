<!-- Generated by agents-reverse-engineer -->

# src/cli

CLI command entry points for the agents-reverse-engineer tool, routing parsed arguments to specialized command handlers and orchestrating multi-phase documentation generation workflows.

## Contents

### [clean.ts](./clean.ts)
`cleanCommand()` deletes generated artifacts (`.sum`, `AGENTS.md` with marker, `CLAUDE.md`, `GENERATION-PLAN.md`) via `fast-glob` discovery, filters `AGENTS.md` by `GENERATED_MARKER` presence, restores `AGENTS.local.md` backups, preserves user-authored files.

### [discover.ts](./discover.ts)
`discoverCommand()` executes file discovery via `discoverFiles()` filter chain, builds `GenerationPlan` via `createOrchestrator().createPlan()`, transforms via `buildExecutionPlan()` post-order traversal, writes markdown to `GENERATION-PLAN.md`, emits `discovery:start/end` trace events with `filesIncluded/filesExcluded/durationMs` metrics.

### [generate.ts](./generate.ts)
`generateCommand()` orchestrates three-phase pipeline: resolves AI backend via `resolveBackend()`, instantiates `AIService` with timeout/retry/model config, executes `runner.executeGenerate()` for concurrent file analysis → directory aggregation → root synthesis, writes telemetry/traces, exits with status 0/1/2 for success/partial/total failure.

### [index.ts](./index.ts)
Main entry point (`#!/usr/bin/env node`) parses `process.argv` via `parseArgs()`, routes to command handlers (`initCommand`, `cleanCommand`, `discoverCommand`, `generateCommand`, `updateCommand`, `specifyCommand`), invokes `runInstaller()` for install/uninstall/interactive modes, prints version via `getVersion()` and usage via `USAGE` constant.

### [init.ts](./init.ts)
`initCommand()` creates `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()`, checks existence via `configExists()`, warns on `force: false` when config exists, exits on `EACCES/EPERM` errors, logs guidance referencing `exclude.patterns`, `ai.concurrency`, `ai.backend`.

### [specify.ts](./specify.ts)
`specifyCommand()` synthesizes project specifications from `AGENTS.md` corpus: collects docs via `collectAgentsDocs()`, auto-invokes `generateCommand()` if no docs exist, resolves backend via `resolveBackend()`, constructs prompt via `buildSpecPrompt()`, calls `AIService.call()` with extended timeout (≥600,000ms), writes output via `writeSpec()`, logs telemetry with token/duration summary.

### [update.ts](./update.ts)
`updateCommand()` executes incremental update workflow: generates `UpdatePlan` via `createUpdateOrchestrator().preparePlan()` with SHA-256 hash comparison, spawns concurrent AI analysis via `runner.executeUpdate()` for `filesToAnalyze`, regenerates `AGENTS.md` sequentially for `affectedDirs`, finalizes telemetry via `aiService.finalize()`, exits with code 0/1/2 for success/partial/total failure.

## Command Routing Logic

`index.ts` implements dual argument parsing paths: (1) interactive installer mode when `args.length === 0`, (2) explicit command routing when first non-flag arg matches `install|uninstall|init|clean|discover|generate|update|specify`. Installer flags (`--global/-g`, `--local/-l`, `--runtime`, `--force`) trigger `runInstaller()` with `parseInstallerArgs()`. Short flags (`-h`, `-g`, `-l`, `-V`) mapped to long forms (`help`, `global`, `local`, `version`) via inline switch statement. Flags parsed into `Set<string>` for boolean presence checks, `Map<string, string>` for key-value pairs (`--concurrency 3`, `--output ./path`). Positional args extracted after command via filter for non-flag strings (missing leading `--` or `-`).

## Shared Options Pattern

`GenerateOptions` interface defines six fields: `dryRun`, `concurrency`, `failFast`, `debug`, `trace`, reused by `generate.ts`/`update.ts`. `UpdateCommandOptions` extends with `uncommitted` boolean for working tree inclusion. `SpecifyOptions` adds `output` string, `force` boolean, `multiFile` boolean for directory-split output. `CleanOptions` contains only `dryRun`. Option construction in `index.ts` uses `flags.has()` for boolean checks, `values.get()` with `parseInt()` for numeric coercion, `values.get()` for string paths.

## Progress Logging Strategy

`discover.ts`, `generate.ts`, `update.ts`, `specify.ts` create `ProgressLog` instances via `ProgressLog.create(absolutePath)` writing to `.agents-reverse-engineer/progress.log` with ISO 8601 timestamp headers (`=== ARE <Command> (${new Date().toISOString()}) ===`), project path, file counts, phase summaries. `CommandRunner` receives `progressLog` in constructor, streams task pickup/completion events with ETA calculations. Finalized via `progressLog.finalize()` before exit. Designed for `tail -f` monitoring pattern (documented in CLAUDE.md "Progress log" section).

## Trace Integration

`generate.ts`, `update.ts`, `discover.ts` support `--trace` flag enabling NDJSON trace emission via `createTraceWriter(absolutePath, options.trace ?? false)` called before config loading. Tracer passed to `loadConfig()`, `createUpdateOrchestrator()`, `CommandRunner`, `discoverFiles()` as `options.tracer`. Events include `phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`, `discovery:start/end`. Finalized via `tracer.finalize()` followed by `cleanupOldTraces(absolutePath)` enforcing 500-file retention limit. Trace paths logged to stderr via `pc.dim('[trace] Writing to <path>')`.

## Backend Resolution Workflow

`generate.ts`, `update.ts`, `specify.ts` resolve AI backend via four-step pattern: (1) create registry via `createBackendRegistry()`, (2) call `resolveBackend(registry, config.ai.backend)` returning first available CLI (Claude/Gemini/OpenCode) or throwing `AIServiceError` with `code: 'CLI_NOT_FOUND'`, (3) catch error and print installation instructions via `getInstallInstructions(registry)` to stderr, (4) call `process.exit(2)` on CLI absence. Instantiate `AIService` with backend and config options `{ timeoutMs, maxRetries, model, telemetry }`, enable debug mode via `aiService.setDebug(true)` if `options.debug`, configure subprocess log directory via `aiService.setSubprocessLogDir(logDir)` if `options.trace`.

## Exit Code Strategy

Commands use three exit codes consistently: **0** for success (all files succeeded or no files to process), **1** for partial failure (`summary.filesFailed > 0 && summary.filesProcessed > 0`), **2** for total failure (`summary.filesProcessed === 0 && summary.filesFailed > 0`) or CLI not found during backend resolution. `update.ts` exits early with implicit code 0 on first run detection (`plan.isFirstRun`) or no changes (`filesToAnalyze.length === 0 && cleanup counts === 0`). `specify.ts` exits with code 1 on `SpecExistsError` during `writeSpec()`, code 2 on `AIServiceError` with `CLI_NOT_FOUND`. `init.ts` exits with code 1 on `EACCES/EPERM` during `writeDefaultConfig()`.

## Dry-Run Mode Handling

`generate.ts` shows plan summary via `formatPlan()` and task breakdown via `buildExecutionPlan()` without backend resolution when `options.dryRun === true`. `update.ts` displays plan via `formatPlan(plan)` including baseline commit, file statuses (`+` added, `R` renamed, `M` modified, `=` unchanged), cleanup actions, affected directories, exits before AI service instantiation. `specify.ts` computes `estimatedTokensK = Math.ceil(totalChars / 4) / 1000`, prints doc count/token estimate/output path/mode table, warns if exceeds 150K tokens. `clean.ts` enumerates artifacts to delete with `pc.dim()` paths, skips `unlink()`/`rename()` calls, prints `Dry run — no files were changed.` in yellow.

## Telemetry Finalization

`generate.ts`, `update.ts`, `specify.ts` finalize telemetry via `aiService.finalize(absolutePath)` returning `summary` with fields `totalInputTokens`, `totalOutputTokens`, `totalDurationMs`, `filesRead[]`. Log summary line formatted as `Tokens: ${totalInputTokens} in / ${totalOutputTokens} out | Duration: ${(totalDurationMs / 1000).toFixed(1)}s | Output: ${outputPath}`. `update.ts` records run state via `orchestrator.recordRun(currentCommit, filesProcessed, filesSkipped)` after finalization (legacy no-op since frontmatter hash migration).

## Auto-Generation Fallback

`specify.ts` checks `docs.length === 0` after `collectAgentsDocs()`, invokes `generateCommand(targetPath, { debug, trace })` when no AGENTS.md files exist and not in dry-run mode, re-collects docs after generation, exits with code 1 if still zero. Prints `No AGENTS.md files found after generation. Cannot proceed.` in red. Prevents specification synthesis with empty corpus.