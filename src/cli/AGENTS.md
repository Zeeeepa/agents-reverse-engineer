<!-- Generated by agents-reverse-engineer -->

# cli

Command-line interface layer parsing `process.argv`, routing to command handlers, managing shared flags (--debug, --trace, --dry-run, --concurrency, --model), and integrating ProgressLog/TraceWriter/AIService across init/discover/generate/update/specify/rebuild/clean workflows.

## Command Entry Points

**[index.ts](./index.ts)** — Main router parsing args via `parseArgs()`, dispatching to command handlers, handling `--version`/`--help` flags, launching interactive installer when invoked with no arguments or installer-specific flags (--runtime, -g, -l).

**[init.ts](./init.ts)** — `initCommand(root, { force? })` creates `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()`, exits with warning if config exists without `--force`, catches `EACCES`/`EPERM` with `process.exit(1)`.

**[discover.ts](./discover.ts)** — `discoverCommand(targetPath, { tracer?, debug? })` runs file discovery via `discoverFiles()`, writes included/excluded files to console and `.agents-reverse-engineer/GENERATION-PLAN.md` via `formatExecutionPlanAsMarkdown()`, emits `discovery:start/end` trace events.

**[generate.ts](./generate.ts)** — `generateCommand(targetPath, GenerateOptions)` orchestrates three-phase pipeline: discovers files → creates GenerationPlan via `createOrchestrator().createPlan()` → resolves AI backend → builds ExecutionPlan → executes via `CommandRunner.executeGenerate()` → finalizes telemetry/trace/progress, exits with codes 0 (success), 1 (partial failure), 2 (total failure/no CLI).

**[update.ts](./update.ts)** — `updateCommand(targetPath, UpdateCommandOptions)` prepares UpdatePlan via hash comparison, cleans orphaned `.sum`/`AGENTS.md` artifacts, analyzes changed files (Phase 1), regenerates `AGENTS.md` for `affectedDirs` (Phase 2), finalizes telemetry, exits with codes 0/1/2.

**[specify.ts](./specify.ts)** — `specifyCommand(targetPath, SpecifyOptions)` synthesizes project spec from `AGENTS.md` corpus via AI, auto-invokes `generateCommand()` if docs missing, supports single/multi-file output (`--multi-file`), enforces 15min timeout and opus model default, exits with code 1 on `SpecExistsError` (conflicts), 2 on `CLI_NOT_FOUND`.

**[rebuild.ts](./rebuild.ts)** — `rebuildCommand(targetPath, RebuildOptions)` reconstructs project from specs via `partitionSpec()` + `executeRebuild()`, enforces 15min timeout and opus default, supports checkpoint-based resumption via `CheckpointManager.load()`, writes generated code to `rebuild/` (or custom `--output`), exits with codes 0/1/2.

**[clean.ts](./clean.ts)** — `cleanCommand(targetPath, { dryRun })` removes `.sum`, `.annex.md`, generated `AGENTS.md` (via `GENERATED_MARKER` detection), `CLAUDE.md`, `GENERATION-PLAN.md`, restores `AGENTS.local.md` → `AGENTS.md`, logs deletion counts with picocolors formatting.

## Shared Option Types

**GenerateOptions** (`generate.ts`, `rebuild.ts` reuses subset):
```typescript
{
  dryRun?: boolean;       // Show plan without AI calls
  concurrency?: number;   // Worker pool size (1-10)
  failFast?: boolean;     // Abort on first failure
  debug?: boolean;        // Verbose subprocess logging
  trace?: boolean;        // NDJSON trace emission
  model?: string;         // Override AI model
}
```

**UpdateCommandOptions** (`update.ts`):
```typescript
{
  uncommitted?: boolean;  // Include staged+working changes
  dryRun?: boolean;
  concurrency?: number;
  failFast?: boolean;
  debug?: boolean;
  trace?: boolean;
  model?: string;
}
```

**SpecifyOptions** (`specify.ts`):
```typescript
{
  output?: string;        // Custom spec file path (default: specs/SPEC.md)
  force?: boolean;        // Overwrite existing files
  dryRun?: boolean;
  multiFile?: boolean;    // Split into per-directory specs
  debug?: boolean;
  trace?: boolean;
  model?: string;
}
```

**RebuildOptions** (`rebuild.ts`):
```typescript
{
  output?: string;        // Custom output directory (default: rebuild/)
  force?: boolean;        // Wipe output dir and restart
  dryRun?: boolean;
  concurrency?: number;
  failFast?: boolean;
  debug?: boolean;
  trace?: boolean;
  model?: string;
}
```

**CleanOptions** (`clean.ts`):
```typescript
{
  dryRun?: boolean;       // Preview deletions without filesystem writes
}
```

## Argument Parsing Protocol

`parseArgs(args: string[])` in `index.ts` returns `{ command, positional, flags, values }`:
- **Long flags**: `--key value` → `values['key'] = 'value'`, `--flag` → `flags.add('flag')`
- **Short flags**: `-V` → `flags.add('version')`, `-h` → `flags.add('help')`, `-g` → `flags.add('global')`, `-l` → `flags.add('local')`
- **Command**: First non-flag argument
- **Positional**: Subsequent non-flag arguments after command
- **Values map**: `--concurrency 3`, `--output ./spec.md`, `--model sonnet`, `--runtime claude`
- **Installer detection**: `hasInstallerFlags(flags, values)` checks for `global`, `local`, `force`, or `runtime` value

## Model Resolution Strategy

**generate/update**: `options.model ?? config.ai.model` — CLI flag overrides config, no hardcoded default.

**specify/rebuild**: `options.model ?? (config.ai.model === 'sonnet' ? 'opus' : config.ai.model)` — upgrades sonnet → opus for quality-critical synthesis, respects explicit opus/haiku config.

## Progress Tracking Infrastructure

All commands (except `init`, `clean`) create `ProgressLog.create(absolutePath)` writing to `.agents-reverse-engineer/progress.log`:
- **Header format**: `=== ARE <Command> (${ISO-8601}) ===\nProject: ${absolutePath}\n...`
- **Real-time monitoring**: `tail -f .agents-reverse-engineer/progress.log`
- **Phase boundaries**: `=== Phase 1: File Analysis ===`, `=== Phase 2: Directory AGENTS.md ===`
- **Task progress**: `[worker-0] Analyzing src/foo.ts (ETA: 2m 15s)`
- **Summary line**: `Tokens: 12345 in / 6789 out | Duration: 45s | Exit: 0`
- **Finalization**: `await progressLog.finalize()` before exit

## Trace Integration

When `--trace` flag present:
- `createTraceWriter(absolutePath, true)` creates `.agents-reverse-engineer/traces/trace-<ISO-timestamp>.ndjson` writer
- Threads `tracer` through `loadConfig()`, `discoverFiles()`, `createOrchestrator()`, `CommandRunner()`, `AIService()`
- Emits events: `phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`
- Auto-populated fields: `seq` (monotonic), `ts` (ISO 8601), `pid`, `elapsedMs`
- Finalization: `await tracer.finalize()` + `cleanupOldTraces(absolutePath)` keeps 500 most recent traces

## Backend Resolution Flow

All commands except `init`, `discover`, `clean`:
1. `createBackendRegistry()` → enumerates installed CLIs (Claude, Gemini, OpenCode)
2. `resolveBackend(registry, config.ai.backend)` → throws `AIServiceError` with `code: 'CLI_NOT_FOUND'` if none found
3. Catch block → `getInstallInstructions(registry)` prints installation commands, `process.exit(2)` (distinct from task failure code 1)

## AIService Configuration

Instantiation pattern (from `generate.ts`, `update.ts`, `specify.ts`, `rebuild.ts`):
```typescript
const aiService = new AIService(backend, {
  timeoutMs: Math.max(config.ai.timeoutMs, 900_000), // 15min min for specify/rebuild
  maxRetries: config.ai.maxRetries,
  model: effectiveModel,
  telemetry: { keepRuns: config.ai.telemetry.keepRuns }
});

if (options.debug) {
  aiService.setDebug(true);
  console.error(pc.dim(`[debug] Backend: ${backend.name}`));
  console.error(pc.dim(`[debug] Model: ${effectiveModel}`));
}

if (options.trace) {
  const logDir = path.join(absolutePath, '.agents-reverse-engineer', 'subprocess-logs', timestamp);
  aiService.setSubprocessLogDir(logDir);
  console.error(pc.dim(`[debug] Subprocess logs: ${logDir}`));
}
```

## Finalization Sequence

Standard cleanup before exit (from `generate.ts`, `update.ts`, `specify.ts`, `rebuild.ts`):
```typescript
await aiService.finalize(absolutePath);  // Write run log, enforce retention
await progressLog.finalize();            // Close progress.log stream
await tracer.finalize();                 // Close trace NDJSON stream
if (options.trace) {
  cleanupOldTraces(absolutePath);        // Keep 500 most recent traces
}
```

## Exit Code Conventions

- **0**: Success (all tasks completed or no tasks to process)
- **1**: Partial failure (some tasks succeeded, some failed) OR file conflict (specify/clean) OR first-run detection (update)
- **2**: Total failure (no tasks succeeded, only failures) OR AI CLI not found

## Dry-Run Behavior

**generate.ts**: Builds `ExecutionPlan` via `buildExecutionPlan()`, logs file/directory/root task counts, returns without AI backend resolution.

**update.ts**: Prepares `UpdatePlan` via `orchestrator.preparePlan({ includeUncommitted, dryRun: true })`, logs changed files with status markers (M=modified, +=added, R=renamed), cleanup actions (deleted `.sum`, empty dir `AGENTS.md`), affected directories, returns without AI calls.

**specify.ts**: Collects `AGENTS.md` + annex files, estimates tokens via `totalChars / 4 / 1000`, logs counts with cyan styling, warns if input exceeds 150K tokens or docs missing, returns without backend resolution.

**rebuild.ts**: Reads specs via `readSpecFiles()`, partitions via `partitionSpec()`, loads checkpoint via `CheckpointManager.load()`, logs unit count and checkpoint status (completed vs. pending modules), returns without AIService instantiation.

**clean.ts**: Discovers artifacts via `fast-glob` (`.sum`, `.annex.md`, `AGENTS.md`, `AGENTS.local.md`), filters via `GENERATED_MARKER` substring search, logs deletion preview with picocolors formatting (yellow warning "Dry run — no files were changed"), returns without `unlink()` calls.

## Error Handling Patterns

**Directory access errors** (all commands):
```typescript
await access(resolvedPath, constants.R_OK);
// Catches ENOENT → 'Directory not found: ${path}', exit 1
// Catches EACCES/EPERM → 'Permission denied: ${path}', exit 1
```

**Config load errors** (all commands except `init`):
```typescript
const config = await loadConfig(absolutePath, { tracer, debug });
// Throws on invalid YAML or schema validation failure
// Caught by top-level try/catch in index.ts main()
```

**Backend resolution errors** (generate/update/specify/rebuild):
```typescript
try {
  backend = resolveBackend(registry, config.ai.backend);
} catch (err) {
  if (err instanceof AIServiceError && err.code === 'CLI_NOT_FOUND') {
    console.error(pc.red('No AI CLI found...'));
    console.error(getInstallInstructions(registry));
    process.exit(2);
  }
  throw err;
}
```

**File conflict errors** (specify):
```typescript
try {
  await writeSpec(...);
} catch (err) {
  if (err instanceof SpecExistsError) {
    await progressLog.finalize();
    console.error(pc.red(err.message));
    process.exit(1);
  }
  throw err;
}
```

## Dependencies

**External**: `picocolors` (as `pc`), `node:path`, `node:fs/promises` (`access`, `readFile`, `rename`, `unlink`, `mkdir`, `readdir`), `node:fs` (`constants.F_OK/R_OK`).

**Internal**:
- **Config**: `src/config/loader.ts` (loadConfig, configExists, writeDefaultConfig, CONFIG_DIR, CONFIG_FILE)
- **Discovery**: `src/discovery/run.ts` (discoverFiles)
- **Generation**: `src/generation/orchestrator.ts` (createOrchestrator, GenerationPlan), `src/generation/executor.ts` (buildExecutionPlan, formatExecutionPlanAsMarkdown), `src/generation/collector.ts` (collectAgentsDocs, collectAnnexFiles), `src/generation/writers/agents-md.ts` (writeAgentsMd, GENERATED_MARKER), `src/generation/prompts/index.ts` (buildDirectoryPrompt)
- **AI**: `src/ai/index.ts` (AIService, AIServiceError, createBackendRegistry, resolveBackend, getInstallInstructions)
- **Orchestration**: `src/orchestration/index.ts` (CommandRunner, ProgressLog, ProgressReporter, createTraceWriter, cleanupOldTraces), `src/orchestration/trace.ts` (ITraceWriter)
- **Update**: `src/update/index.ts` (createUpdateOrchestrator, UpdatePlan)
- **Specify**: `src/specify/index.ts` (buildSpecPrompt, writeSpec, SpecExistsError)
- **Rebuild**: `src/rebuild/index.ts` (readSpecFiles, partitionSpec, CheckpointManager, executeRebuild)
- **Installer**: `src/installer/index.ts` (runInstaller, parseInstallerArgs)
- **Output**: `src/output/logger.ts` (createLogger)
- **Version**: `src/version.ts` (getVersion)
- **Types**: `src/types/index.ts` (DiscoveryResult)