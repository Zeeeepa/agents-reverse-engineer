<!-- Generated by agents-reverse-engineer -->

# src/cli/

CLI command entry points for the `are` binary, dispatching seven commands (init, discover, generate, update, specify, clean, install/uninstall) with argument parsing, AI backend resolution, three-phase pipeline orchestration, and telemetry finalization.

## Command Implementations

**[index.ts](./index.ts)** — Shebang entry point (`#!/usr/bin/env node`) parsing `process.argv` via `parseArgs()`, extracting command/positional/flags/values from `--key value` syntax, routing to command handlers via switch statement, detecting installer mode via `hasInstallerFlags()` (supports `npx agents-reverse-engineer --runtime claude -g`), displaying version via `getVersion()` reading `../../package.json` from `fileURLToPath(import.meta.url)`, handling `--help`/`-h` with `showHelp()`, exiting with code 1 on unknown commands.

**[init.ts](./init.ts)** — `initCommand(root)` creates `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()`, warns if `configExists()` returns true, logs customizable fields (`exclude.patterns`, `ai.concurrency`, `ai.timeoutMs`, `ai.backend`), catches EACCES/EPERM errors to log permission-denied messages and exit with code 1.

**[discover.ts](./discover.ts)** — `discoverCommand(targetPath, {tracer, debug})` verifies directory access via `access()` with `constants.R_OK`, calls `discoverFiles()` with gitignore/vendor/binary filters, emits `discovery:start`/`discovery:end` trace events with `filesIncluded`/`filesExcluded`/`durationMs`, creates orchestrator via `createOrchestrator()`, builds execution plan via `buildExecutionPlan()` with post-order traversal, formats markdown via `formatExecutionPlanAsMarkdown()`, writes `GENERATION-PLAN.md`, logs file paths via `logger.file()`/`logger.excluded()`, mirrors output to `ProgressLog.write()`.

**[generate.ts](./generate.ts)** — `generateCommand(targetPath, {dryRun, concurrency, failFast, debug, trace})` orchestrates five-step pipeline: loads config via `loadConfig()`, discovers files via `discoverFiles()`, creates `GenerationPlan` via `createOrchestrator().createPlan()`, resolves backend via `resolveBackend(createBackendRegistry(), config.ai.backend)`, executes via `CommandRunner.executeGenerate(buildExecutionPlan())`, threads `tracer` from `createTraceWriter()` through all operations, shows plan summary in dry-run mode via `formatPlan()`, catches `AIServiceError` with `code='CLI_NOT_FOUND'` to display `getInstallInstructions()` and exit with code 2, calls `aiService.finalize()`/`progressLog.finalize()`/`tracer.finalize()`/`cleanupOldTraces()`, exits with code 2 on total failure, code 1 on partial failure, code 0 on success.

**[update.ts](./update.ts)** — `updateCommand(targetPath, {uncommitted, dryRun, concurrency, failFast, debug, trace})` implements incremental workflow: creates `UpdateOrchestrator` via `createUpdateOrchestrator()`, prepares `UpdatePlan` via `orchestrator.preparePlan()`, analyzes changed files via `runner.executeUpdate()` in Phase 1, regenerates AGENTS.md for `plan.affectedDirs` sequentially in Phase 2 via loop calling `buildDirectoryPrompt()`/`writeAgentsMd()`, emits `phase:start`/`task:start`/`task:done`/`phase:end` trace events, logs cleanup actions via `formatCleanup()`, displays `'First run detected. Use "are generate"'` when `plan.isFirstRun === true`, creates `ProgressReporter` with `new ProgressReporter(0, plan.affectedDirs.length)` for Phase 2, calls `dirReporter.onDirectoryStart()`/`dirReporter.onDirectoryDone()` with token metrics, enables subprocess logging via `aiService.setSubprocessLogDir()` when trace is enabled.

**[specify.ts](./specify.ts)** — `specifyCommand(targetPath, {output, force, dryRun, multiFile, debug, trace})` executes five-phase synthesis: loads config via `loadConfig()`, collects AGENTS.md via `collectAgentsDocs()`, auto-generates missing docs via `generateCommand()` when `docs.length === 0`, resolves backend via `createBackendRegistry()`/`resolveBackend()`, invokes `aiService.call()` with `buildSpecPrompt()` output, writes results via `writeSpec()` which throws `SpecExistsError` when force=false and file exists, uses extended timeout via `Math.max(config.ai.timeoutMs, 600_000)`, displays dry-run summary with estimated tokens (`chars/4/1000`), warns when `docs.length === 0` or `estimatedTokensK > 150`, defaults output to `specs/SPEC.md`, catches `SpecExistsError` to exit with code 1.

**[clean.ts](./clean.ts)** — `cleanCommand(targetPath, {dryRun})` discovers artifacts in parallel via `Promise.all([fg.glob('**/*.sum'), fg.glob('**/AGENTS.md'), fg.glob('**/AGENTS.local.md')])`, filters generated AGENTS.md via substring search for `GENERATED_MARKER`, preserves user-authored files in `skippedAgentsFiles`, checks single-file artifacts (CLAUDE.md, GENERATION-PLAN.md) via `access()` with `constants.F_OK`, executes `unlink()` on `allFiles` array in non-dry-run mode, restores AGENTS.local.md via `rename()` to `AGENTS.md`, handles ENOENT/EACCES/EPERM errors to exit with code 1, displays summary with `pc.bold()` counts and `pc.green()`/`pc.yellow()` status messages.

## Options Interface

```typescript
interface GenerateOptions {
  dryRun?: boolean;
  concurrency?: number;
  failFast?: boolean;
  debug?: boolean;
  trace?: boolean;
}

interface UpdateCommandOptions {
  uncommitted?: boolean;
  dryRun?: boolean;
  concurrency?: number;
  failFast?: boolean;
  debug?: boolean;
  trace?: boolean;
}

interface SpecifyOptions {
  output?: string;
  force?: boolean;
  dryRun?: boolean;
  multiFile?: boolean;
  debug?: boolean;
  trace?: boolean;
}

interface CleanOptions {
  dryRun?: boolean;
}
```

## Argument Parsing Strategy

`parseArgs(args)` in index.ts extracts first non-flag as `command`, collects `--key value` pairs into `values: Map<string, string>`, stores boolean flags in `flags: Set<string>`, expands short flags (`-h` → `help`, `-g` → `global`, `-l` → `local`, `-V` → `version`), returns `{command, positional, flags, values}`.

## CLI Routing Logic

Version flag (`--version`, `-V`) calls `showVersion()` → logs `agents-reverse-engineer v${VERSION}` → `process.exit(0)`. Help flag (`--help`, `-h`) calls `showHelp()` → logs `USAGE` → `process.exit(0)`. No arguments invokes `runInstaller()` with interactive mode. Installer flags without command (`--runtime`, `-g`, `-l`) detected via `hasInstallerFlags()` → calls `runInstaller()` directly. Install/uninstall commands re-parse via `parseInstallerArgs()` → `runInstaller()`. Other commands route via switch statement with `positional[0] || '.'` as path default.

## Backend Resolution and Exit Codes

All commands except init/clean/discover resolve AI backend via `createBackendRegistry()`/`resolveBackend()`, catching `AIServiceError` with `code='CLI_NOT_FOUND'` to display `getInstallInstructions()` and exit with code 2. Exit code 1 on partial failure (`summary.filesFailed > 0`). Exit code 2 on total failure (`summary.filesProcessed === 0 && summary.filesFailed > 0`). Exit code 0 on success.

## Progress and Telemetry

All commands except init/clean create `ProgressLog.create(absolutePath)` writing to `.agents-reverse-engineer/progress.log` for `tail -f` monitoring, calling `progressLog.finalize()` before exit. Generate/update/specify commands call `aiService.finalize(absolutePath)` to write telemetry run log, `tracer.finalize()`, `cleanupOldTraces(absolutePath)` when trace is enabled.

## Debug and Trace Modes

Debug mode (`--debug`) logs backend name/CLI command/model via `pc.dim()`, calls `aiService.setDebug(true)` to enable subprocess prompt/response logging, threads `debug: true` to `loadConfig()`/`discoverFiles()`/`createOrchestrator()`. Trace mode (`--trace`) creates `ITraceWriter` via `createTraceWriter(absolutePath, true)`, threads through all operations, emits NDJSON events (`phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`) to `.agents-reverse-engineer/traces/trace-<timestamp>.ndjson`, enables subprocess output logging via `aiService.setSubprocessLogDir()`.

## Dependencies

Imports from `../config/loader.js` (loadConfig, configExists, writeDefaultConfig, CONFIG_DIR, CONFIG_FILE), `../output/logger.js` (createLogger), `../discovery/run.js` (discoverFiles), `../generation/orchestrator.js` (createOrchestrator), `../generation/executor.js` (buildExecutionPlan, formatExecutionPlanAsMarkdown), `../generation/prompts/index.js` (buildDirectoryPrompt), `../generation/writers/agents-md.js` (writeAgentsMd, GENERATED_MARKER), `../generation/collector.js` (collectAgentsDocs), `../ai/index.js` (AIService, AIServiceError, createBackendRegistry, resolveBackend, getInstallInstructions), `../orchestration/index.js` (CommandRunner, ProgressReporter, ProgressLog, createTraceWriter, cleanupOldTraces), `../update/index.js` (createUpdateOrchestrator, UpdatePlan), `../specify/index.js` (buildSpecPrompt, writeSpec, SpecExistsError), `../installer/index.js` (runInstaller, parseInstallerArgs).