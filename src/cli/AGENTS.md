<!-- Generated by agents-reverse-engineer -->

# src/cli

Command-line interface entry point and command implementations for agents-reverse-engineer (ARE) CLI. Parses argv, dispatches to command modules (init, discover, generate, update, clean, specify, rebuild), and manages installer routing.

## Contents

### Command Entry Point

**[index.ts](./index.ts)** — `main()` parses `process.argv` via `parseArgs()` and routes to command functions. Handles `--help`, `--version`, installer flag detection (`hasInstallerFlags()`), and unknown command errors. Defines `GenerateOptions`, `UpdateCommandOptions`, `CleanOptions`, `SpecifyOptions`, `RebuildOptions` type exports.

### Core Commands

**[init.ts](./init.ts)** — `initCommand()` creates `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()`, adds `*.sum` to `.gitignore` via `ensureGitignoreEntry()`, and configures `.vscode/settings.json` `files.exclude` via `ensureVscodeExclude()` using `jsonc-parser` for comment-preserving edits. Checks `configExists()` before creation unless `options.force` is true.

**[discover.ts](./discover.ts)** — `discoverCommand()` loads config via `loadConfig()`, discovers files via `discoverFiles()`, creates `GenerationPlan` via `createOrchestrator().createPlan()`, formats plan via `formatExecutionPlanAsMarkdown()`, writes `GENERATION-PLAN.md`, and logs files to `ProgressLog`. Emits `discovery:start` and `discovery:end` trace events.

**[generate.ts](./generate.ts)** — `generateCommand()` orchestrates three-phase documentation generation: file analysis → directory AGENTS.md → root docs. Resolves AI backend via `resolveBackend()`, creates `AIService` with `effectiveModel` (CLI flag > config, defaults to sonnet), instantiates `CommandRunner` with concurrency/failFast options, executes `runner.executeGenerate()`, writes telemetry via `aiService.finalize()`, and exits with code 0/1/2 based on `RunSummary`. Dry-run mode prints plan via `formatPlan()` without AI calls.

**[update.ts](./update.ts)** — `updateCommand()` implements incremental update via `createUpdateOrchestrator().preparePlan()` for git-based change detection, `CommandRunner.executeUpdate()` for concurrent file analysis, and sequential directory AGENTS.md regeneration via `buildDirectoryPrompt()`/`writeAgentsMd()`. Displays plan via `formatPlan()` with commit baseline and status markers (`+` added, `M` modified, `R` renamed, `=` unchanged). If `plan.isFirstRun`, prints hint and returns early. Exits with code 0/1/2 based on partial/total failure thresholds.

**[clean.ts](./clean.ts)** — `cleanCommand()` deletes ARE-generated artifacts (`*.sum`, `**/*.annex.sum`, marker-verified `AGENTS.md`/`CLAUDE.md`, `GENERATION-PLAN.md`) and restores `.local.md` files. Uses `fg.glob()` with five parallel searches, reads each `AGENTS.md`/`CLAUDE.md` to check `GENERATED_MARKER`, and calls `unlink()`/`rename()` for deletion/restoration. Dry-run mode lists files without mutations.

**[specify.ts](./specify.ts)** — `specifyCommand()` collects `AGENTS.md` via `collectAgentsDocs()`, gathers annex files via `collectAnnexFiles()`, constructs specification prompts via `buildSpecPrompt()`, calls `aiService.call()` with task label `'specify'`, and writes output via `writeSpec()` (single-file or multi-file mode). If no docs found, auto-invokes `generateCommand()` before retrying. Upgrades default sonnet to opus via `effectiveModel` resolution. Exits with code 1 on `SpecExistsError` or conflict detection, code 2 on CLI not found.

**[rebuild.ts](./rebuild.ts)** — `rebuildCommand()` reconstructs project from specs via `readSpecFiles()`/`partitionSpec()` for unit ordering, `CheckpointManager.load()` for session continuity, and `executeRebuild()` for concurrent module generation. Resolves `outputDir` from `options.output` or `rebuild/`, upgrades sonnet to opus, sets 15-minute minimum timeout via `Math.max(config.ai.timeoutMs, 900_000)`, and exits with code 0/1/2 based on `modulesProcessed`/`modulesFailed` counts. Dry-run mode prints unit listing and checkpoint state. Force mode prints yellow warning before wiping output directory.

## Command Execution Flow

1. **Argument Parsing** — `parseArgs()` returns `{ command, positional, flags, values }` with short flag expansion (`-h` → `help`, `-V` → `version`).
2. **Global Flags** — `--version`/`-V` triggers `showVersion()`, `--help`/`-h` triggers `showHelp()`, installer flags (`--global`, `--local`, `--runtime`, `--force`) route to `runInstaller()`.
3. **Command Dispatch** — Routes string command to corresponding module function with options object constructed from flags/values maps.
4. **Error Handling** — Top-level `.catch()` in `main()` logs error message and exits with code 1. Individual commands exit with codes 0 (success), 1 (partial failure), 2 (total failure/CLI not found).

## Shared Patterns

### AI Backend Resolution
All AI-calling commands (generate, update, specify, rebuild) follow this pattern:
```typescript
const registry = createBackendRegistry();
const backend = resolveBackend(registry, config.ai.backend); // throws AIServiceError
const effectiveModel = options.model ?? config.ai.model; // CLI flag overrides config
const aiService = new AIService(backend, { timeoutMs, maxRetries, model: effectiveModel, telemetry });
```
Catches `AIServiceError` with `code === 'CLI_NOT_FOUND'`, prints `getInstallInstructions(registry)`, exits with code 2.

### Progress and Trace Integration
```typescript
const tracer = createTraceWriter(absolutePath, options.trace ?? false);
const progressLog = ProgressLog.create(absolutePath); // writes to .agents-reverse-engineer/progress.log
progressLog.write(`=== ARE ${Command} (${new Date().toISOString()}) ===`);
// ... execution
aiService.finalize(absolutePath); // writes telemetry run log
progressLog.finalize();
tracer.finalize();
if (options.trace) cleanupOldTraces(absolutePath);
```

### Dry-Run Mode
Commands print execution plan with file counts, token estimates, and task listings without mutating filesystem or calling AI. Estimate tokens via `chars / 4 / 1000` for K-token display. Warn if estimated tokens > 150K.

### Model Upgrade Strategy
Specify and rebuild commands upgrade default sonnet to opus via:
```typescript
const effectiveModel = options.model ?? (config.ai.model === 'sonnet' ? 'opus' : config.ai.model);
```
This ensures high-quality synthesis for specification/reconstruction tasks while respecting explicit model overrides.

## Behavioral Contracts

### Exit Codes
- **0**: Success (all tasks completed or no tasks to process)
- **1**: Partial failure (`filesProcessed > 0 && filesFailed > 0` or conflict detection)
- **2**: Total failure (`filesProcessed === 0 && filesFailed > 0`) or CLI not found (`AIServiceError` with `code === 'CLI_NOT_FOUND'`)

### File Marker Detection (clean.ts)
`GENERATED_MARKER` from `../generation/writers/agents-md.js` used to distinguish ARE-generated docs from user-authored docs. Regex pattern: `<!-- Generated by agents-reverse-engineer -->` (see [../generation/writers/agents-md.ts](../generation/writers/agents-md.ts) for exact string).

### Glob Patterns (clean.ts)
- `**/*.sum` matches both `.sum` and `.annex.sum` extensions
- Ignore patterns: `['**/node_modules/**', '**/.git/**']`
- Options: `{cwd, absolute: true, onlyFiles: true, dot: true}`

### Git Integration (init.ts)
- **Gitignore Section**: `# agents-reverse-engineer` header with `*.sum` pattern
- **VS Code Exclude**: `files.exclude["**/*.sum"] = true` via `jsonc-parser` edits with `formattingOptions: { tabSize: 1, insertSpaces: false }`

### Update Status Markers (update.ts)
- `+` (green): added file
- `M` (yellow): modified file
- `R` (blue): renamed file
- `=` (dim): unchanged file
- `-` (red): cleanup action (orphaned .sum or empty AGENTS.md)

### Timeout Thresholds
- **Specify**: `Math.max(config.ai.timeoutMs, 900_000)` (15-minute minimum for long synthesis)
- **Rebuild**: `Math.max(config.ai.timeoutMs, 900_000)` (15-minute minimum for large modules)
- **Generate/Update**: Uses `config.ai.timeoutMs` without override