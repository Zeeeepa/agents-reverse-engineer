<!-- Generated by agents-reverse-engineer -->

# cli

**Command-line interface entry points and argument routing for ARE's seven operations: init (config creation), discover (file scanning with GENERATION-PLAN.md output), generate (three-phase AI-driven documentation), update (incremental hash-based regeneration), specify (project specification synthesis), clean (artifact deletion with user-authored content restoration), and install/uninstall (IDE hook integration).**

## Contents

### Entry Point

**[index.ts](./index.ts)** — Argument parser via `parseArgs()` extracting command string, positional args, flag Set (`--debug`, `--trace`, `--dry-run`, `--force`, `--fail-fast`, `--uncommitted`), and key-value Map (`--concurrency`, `--output`, `--runtime`). Routes to command handlers via switch statement on `command` field. Handles installer invocations through three paths: explicit `install`/`uninstall` commands, `hasInstallerFlags()` detection triggering direct installer launch (`npx agents-reverse-engineer --runtime claude -g`), and zero-argument interactive mode. Global flags include `--version` (prints `agents-reverse-engineer v${VERSION}` via `showVersion()`), `--help` (displays `USAGE` constant multi-line documentation via `showHelp()`), `--debug` (enables verbose subprocess logging passed to generate/update/specify), `--trace` (emits NDJSON events to `.agents-reverse-engineer/traces/`).

### Command Implementations

**[init.ts](./init.ts)** — Exports `initCommand(root, options)` creating `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()` after checking `configExists()`. When config exists without `--force`, logs warning with `configPath` location and exits. Catches `EACCES`/`EPERM` errors with permission denial message and remediation hint. Exits with code 1 on errors.

**[discover.ts](./discover.ts)** — Exports `discoverCommand(targetPath, options)` invoking `discoverFiles()` with filter chain (gitignore, vendor, binary, custom) to produce `DiscoveryResult` with included/excluded file arrays. Emits `discovery:start`/`discovery:end` trace events with `filesIncluded`/`filesExcluded` counts and duration computed via `hrtime.bigint()`. Calls `createOrchestrator().createPlan()` returning `GenerationPlan`, computes `ExecutionPlan` via `buildExecutionPlan()` with post-order directory traversal (deepest-first), formats as markdown via `formatExecutionPlanAsMarkdown()`, writes to `.agents-reverse-engineer/GENERATION-PLAN.md`. Exits with code 1 on `ENOENT`/`EACCES` directory access failures or plan write errors. Streams progress to `.agents-reverse-engineer/progress.log` via `ProgressLog.create()`.

**[generate.ts](./generate.ts)** — Exports `generateCommand(targetPath, options)` orchestrating three-phase pipeline: (1) calls `discoverFiles()` producing `FilterResult`, (2) calls `createOrchestrator().createPlan()` generating `GenerationPlan` with task arrays and complexity metrics, (3) resolves backend via `resolveBackend()` from `createBackendRegistry()` exiting with code 2 on `CLI_NOT_FOUND`, (4) instantiates `AIService` with extended timeout/retry config and subprocess log directory when `trace=true`, (5) creates `CommandRunner` with concurrency pool, (6) calls `runner.executeGenerate(executionPlan)` executing file analysis (concurrent via iterator-based pool), directory aggregation (sequential post-order), root synthesis (sequential), (7) finalizes telemetry via `aiService.finalize()` writing run log, `progressLog.finalize()`, `tracer.finalize()`, `cleanupOldTraces()`. Dry-run mode computes phase breakdown via `buildExecutionPlan()`, formats plan summary via `formatPlan()`, exits without AI calls. Exit codes: 0 (all succeeded), 1 (partial failures), 2 (zero succeeded with failures or backend not found).

**[update.ts](./update.ts)** — Exports `updateCommand(targetPath, options)` performing incremental regeneration via six-phase workflow: (1) loads config via `loadConfig()`, (2) calls `createUpdateOrchestrator().preparePlan()` computing `UpdatePlan` with `filesToAnalyze` (hash mismatches), `filesToSkip` (hash matches), `affectedDirs` (parent paths), `cleanup.deletedSumFiles`/`cleanup.deletedAgentsMd` (orphans), (3) resolves backend via `resolveBackend()` exiting with code 2 on `CLI_NOT_FOUND`, (4) instantiates `AIService` and `CommandRunner`, executes `runner.executeUpdate()` for concurrent `.sum` regeneration, (5) sequentially regenerates `AGENTS.md` for `affectedDirs` via `buildDirectoryPrompt()` and `writeAgentsMd()` with manual `phase:start`/`task:start`/`task:done`/`phase:end` trace emission (concurrency=1), (6) finalizes telemetry via `aiService.finalize()`, `progressLog.finalize()`, `tracer.finalize()`, `cleanupOldTraces()`, `orchestrator.recordRun()`. Dry-run mode calls `formatPlan()` displaying commit hash (first 7 chars), file counts with status markers (`pc.green('+')` for added, `pc.blue('R')` for renamed, `pc.yellow('M')` for modified), cleanup lists with `pc.red('-')` markers. Subprocess logging enabled via `aiService.setSubprocessLogDir()` when `trace=true`.

**[specify.ts](./specify.ts)** — Exports `specifyCommand(targetPath, options)` synthesizing project specifications from `AGENTS.md` corpus via: (1) collects docs via `collectAgentsDocs()` recursive tree traversal, (2) auto-generation fallback: if `docs.length === 0`, logs warning with `pc.yellow()`, invokes `generateCommand(targetPath, { debug, trace })`, re-collects docs, exits with code 1 if still empty, (3) dry-run mode computes token estimate via `totalChars / 4 / 1000`, displays summary with file count and warnings for zero docs or >150K tokens, exits without AI calls, (4) resolves backend via `resolveBackend()` exiting with code 2 on `CLI_NOT_FOUND`, (5) constructs `AIService` with extended timeout `Math.max(config.ai.timeoutMs, 600_000)` (10-minute minimum), builds prompts via `buildSpecPrompt(docs)` returning `{ system, user }`, calls `aiService.call({ prompt, systemPrompt, taskLabel: 'specify' })`, (6) writes output via `writeSpec(response.text, { outputPath, force, multiFile })` returning `string[]` of written paths, catches `SpecExistsError` logging to progress log and console before exiting with code 1, (7) finalizes telemetry via `aiService.finalize()`, computes summary with `totalInputTokens`, `totalOutputTokens`, `totalDurationMs / 1000`. Debug mode logs backend diagnostics (name, CLI command, model) and prompt character counts via `pc.dim()` to stderr.

**[clean.ts](./clean.ts)** — Exports `cleanCommand(targetPath, options)` orchestrating five-stage cleanup: (1) validates `targetPath` via `access()` with `constants.R_OK`, (2) discovers artifacts via three parallel `fg.glob()` calls for `**/*.sum`, `**/AGENTS.md`, `**/AGENTS.local.md` with `node_modules`/`.git` exclusions, (3) filters `AGENTS.md` via `readFile()` checking for `GENERATED_MARKER` presence (from `src/generation/writers/agents-md.ts`) to distinguish ARE-generated docs from user-authored SDK documentation, (4) checks single-file artifacts (`CLAUDE.md` at project root, `.agents-reverse-engineer/GENERATION-PLAN.md`) via `access()` with `constants.F_OK`, (5) executes deletion via `unlink()` and restoration via `rename()` for `AGENTS.local.md → AGENTS.md` mappings. Dry-run mode displays matched files with `path.relative()` formatting but skips `unlink()`/`rename()`, emits `pc.yellow('Dry run — no files were changed.')`. Console output: multi-line summary with `pc.bold()` counts (`X .sum file(s), Y AGENTS.md file(s), Z root doc(s), W AGENTS.local.md to restore`), final success message `pc.green(\`Deleted ${deleted} file(s), restored ${restored} AGENTS.local.md file(s).\`)`. Catches `ENOENT`/`EACCES`/`EPERM` during initial access check, logs via `logger.error()`, exits with code 1. Per-file deletion/restoration failures log errors but continue processing remaining files.

## Flag Semantics

**Global Flags:**
- `--debug` — Passed to generate/update/specify commands enabling verbose subprocess logging with heap/RSS metrics via `aiService.setDebug(true)`
- `--trace` — Passed to generate/update/specify enabling NDJSON trace emission to `.agents-reverse-engineer/traces/` via `createTraceWriter()`
- `--dry-run` — Preview mode for generate/update/specify/clean displaying plan without file writes or AI calls
- `--version` (`-V`) — Prints `agents-reverse-engineer v${VERSION}` via `getVersion()` reading `package.json`, exits with code 0
- `--help` (`-h`) — Displays `USAGE` constant with command syntax/examples, exits with code 0

**Command-Specific Flags:**
- `--concurrency <n>` — Overrides worker pool size (1-10 range) for generate/update commands via `values.get('concurrency')` parsed to integer
- `--fail-fast` — Aborts generate/update on first task failure propagated to `CommandRunner`
- `--uncommitted` — Includes working tree changes in update command git diff analysis via `git status --porcelain`
- `--output <path>` — Overrides default `specs/SPEC.md` location for specify command
- `--multi-file` — Splits specify output into per-directory files (`specs/<dirname>.md`)
- `--force` — Overwrites existing files for init/specify commands, replaces hooks for installer
- `--runtime <name>` — Selects AI backend (`claude`|`gemini`|`opencode`) for installer
- `--global` (`-g`) — Installs hooks to `~/.claude` or equivalent global config directory
- `--local` (`-l`) — Installs hooks to project-local `.claude` directory

## Installer Integration

**Direct invocation pattern:** `hasInstallerFlags()` detects `global`/`local`/`force` flags or `runtime` value, triggers `parseInstallerArgs()` → `runInstaller()` without explicit `install` command, supporting syntax `npx agents-reverse-engineer --runtime claude -g`.

**Interactive mode:** Zero-argument invocation (`args.length === 0`) bypasses command routing, calls `runInstaller({ global: false, local: false, uninstall: false, force: false, help: false, quiet: false })` launching prompts for runtime selection and installation scope.

**Explicit commands:** `install` and `uninstall` commands call `parseInstallerArgs()` then `runInstaller()` with `installerArgs.uninstall` toggled for hook/command removal.

## Trace Event Patterns

**discover.ts events:**
- `discovery:start` — Emitted before `discoverFiles()` with `targetPath` field, timestamp via `process.hrtime.bigint()`
- `discovery:end` — Emitted after `discoverFiles()` with `filesIncluded`/`filesExcluded` counts, `durationMs` computed via bigint subtraction divided by 1_000_000

**update.ts Phase 2 events (directory regeneration):**
- `phase:start` — Emitted before directory loop with `taskCount = plan.affectedDirs.length`, `concurrency = 1`
- `task:start` — Emitted per directory with `taskLabel = dir || '.'`
- `task:done` — Emitted after `writeAgentsMd()` with `success` boolean, `durationMs`, optional `error` message
- `phase:end` — Emitted after directory loop with `tasksCompleted`/`tasksFailed` counters

## Exit Code Conventions

**Code 0:** All tasks succeeded or no tasks to process (generate/update), configuration created successfully (init), artifacts deleted (clean), specification written (specify), discovery completed (discover)

**Code 1:** Partial failure with some tasks succeeded (generate/update), configuration exists without `--force` (init), specification file exists without `--force` (specify), directory access denied (discover), plan write failed (discover), zero docs after auto-generation (specify)

**Code 2:** Total failure with zero tasks succeeded (generate/update), backend not found via `resolveBackend()` with `CLI_NOT_FOUND` error (generate/update/specify)