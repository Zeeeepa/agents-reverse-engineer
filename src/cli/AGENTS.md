<!-- Generated by agents-reverse-engineer -->

# src/cli

CLI command handlers for agents-reverse-engineer: init, discover, generate, update, specify, rebuild, and clean operations, with argument parsing, backend resolution, and progress tracking.

## Contents

### Command Handlers

**[clean.ts](./clean.ts)** — `cleanCommand(targetPath, { dryRun })` deletes generated artifacts (`.sum`, `AGENTS.md`, `CLAUDE.md`, `GENERATION-PLAN.md`) while preserving user-authored files detected via `GENERATED_MARKER` check, restores `.local.md` backups via `rename()`, uses fast-glob patterns `**/*.sum`, `**/AGENTS.md`, `**/CLAUDE.md` with gitignore filtering.

**[discover.ts](./discover.ts)** — `discoverCommand(targetPath, { tracer, debug, showExcluded })` executes four-filter chain (gitignore, vendor, binary, custom) via `discoverFiles()`, builds `GenerationPlan` through `createOrchestrator().createPlan()`, writes `GENERATION-PLAN.md` to `.agents-reverse-engineer/`, emits `discovery:start` and `discovery:end` trace events with file counts and duration.

**[generate.ts](./generate.ts)** — `generateCommand(targetPath, GenerateOptions)` orchestrates two-phase pipeline: resolves backend via `createBackendRegistry()` → `resolveBackend()`, constructs `AIService` with effective model (`options.model ?? config.ai.model`), creates `CommandRunner` with concurrency settings, calls `runner.executeGenerate(executionPlan)` for parallel file `.sum` generation followed by post-order directory `AGENTS.md` aggregation, handles exit codes (0 = success, 1 = partial failure, 2 = total failure/CLI not found).

**[index.ts](./index.ts)** — CLI entry point with `#!/usr/bin/env node` shebang, routes commands via `parseArgs()` to handlers (init, discover, generate, update, specify, rebuild, clean, install, uninstall), maps short flags (`-h` → help, `-g` → global, `-l` → local, `-V` → version), handles special invocation modes (no args → interactive installer, `--version` → version display, installer flags → direct installer).

**[init.ts](./init.ts)** — `initCommand(root, { force })` writes `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()`, adds `*.sum` to `.gitignore` via `ensureGitignoreEntry()` with section header `"# agents-reverse-engineer"`, surgically edits `.vscode/settings.json` via jsonc-parser `modify()` + `applyEdits()` to add `"files.exclude": { "**/*.sum": true }` while preserving comments, logs setup guidance for `exclude.patterns`, `ai.concurrency`, `ai.timeoutMs`, `ai.backend`.

**[rebuild.ts](./rebuild.ts)** — `rebuildCommand(targetPath, RebuildOptions)` reads spec files from `specs/` directory, partitions into rebuild units via `partitionSpec()`, resolves backend, upgrades default model from sonnet to opus, constructs `AIService` with 15-minute minimum timeout (`Math.max(config.ai.timeoutMs, 900_000)`), executes via `executeRebuild()` with checkpoint-based resumption, writes output to `rebuild/` directory (or `options.output`), returns exit code 2 for total failure, 1 for partial failure, 0 for success.

**[specify.ts](./specify.ts)** — `specifyCommand(targetPath, SpecifyOptions)` collects `AGENTS.md` and `.annex.sum` files via `collectAgentsDocs()` + `collectAnnexFiles()`, auto-generates missing docs via `generateCommand()` fallback, synthesizes project specification via `buildSpecPrompt()` → `aiService.call()` with opus model (upgrades sonnet → opus), writes to `specs/SPEC.md` (single-file mode) or `specs/*.md` (multi-file mode) via `writeSpec()`, implements conflict pre-check exiting before AI call when files exist without `--force`, dry-run mode estimates tokens as `Math.ceil(totalChars / 4) / 1000`.

**[update.ts](./update.ts)** — `updateCommand(targetPath, UpdateCommandOptions)` performs incremental regeneration: calls `createUpdateOrchestrator().preparePlan({ includeUncommitted })` for change detection via `content_hash` frontmatter comparison, executes `runner.executeUpdate(plan.filesToAnalyze)` for concurrent file analysis, iterates `plan.affectedDirs` sequentially calling `buildDirectoryPrompt()` with existing `AGENTS.md` context, regenerates via `writeAgentsMd()` + `writeClaudeMdPointer()`, emits trace events with phase `'update-phase-dir-regen'`, formats plan via `formatPlan()` with status markers (`+` added, `R` renamed, `M` modified, `=` unchanged), handles first-run detection printing hint to run `are generate` first.

## Architecture

### Command Routing

`index.ts` `parseArgs()` extracts `{ command, positional, flags, values }` from process arguments, maps short flags to long names, populates `values` map from `--key value` pairs. `main()` dispatches to imported command functions based on parsed `command` string. Special cases: no args launches interactive installer via `runInstaller()`, `--version` flag calls `showVersion()` and exits, `--help` without command calls `showHelp()` and exits, installer flags (`global`, `local`, `force`, `runtime` value) detected via `hasInstallerFlags()` trigger direct installer invocation.

### Option Interfaces

All commands accept structured options objects:
- `GenerateOptions`: `{ dryRun?, concurrency?, failFast?, debug?, trace?, model? }`
- `UpdateCommandOptions`: `{ uncommitted?, dryRun?, concurrency?, failFast?, debug?, trace?, model? }`
- `CleanOptions`: `{ dryRun? }`
- `SpecifyOptions`: `{ output?, force?, dryRun?, multiFile?, debug?, trace?, model? }`
- `RebuildOptions`: `{ output?, force?, dryRun?, concurrency?, failFast?, debug?, trace?, model? }`

Concurrency parsed via `parseInt(values.get('concurrency')!, 10)`, boolean flags checked via `flags.has('key')`, string values extracted via `values.get('key')`.

### Exit Code Convention

- **0**: success (all tasks succeeded or no tasks to process)
- **1**: partial failure (some tasks failed but some succeeded)
- **2**: total failure (all tasks failed or CLI not found via `AIServiceError` with code `'CLI_NOT_FOUND'`)

### Backend Resolution Pattern

Commands requiring AI (generate, update, specify, rebuild) follow common pattern:
1. `createBackendRegistry()` produces registry with claude/gemini/opencode backends
2. `resolveBackend(registry, config.ai.backend)` searches PATH for CLI commands
3. Catch `AIServiceError` with code `'CLI_NOT_FOUND'`, print `getInstallInstructions()`, exit with code 2
4. Construct `AIService` with resolved backend, effective model, timeout, retries, telemetry settings
5. Pass AIService to executor (CommandRunner, executeRebuild, aiService.call)

### Model Selection Strategy

**Default model**: config.ai.model (from `.agents-reverse-engineer/config.yaml`)

**Override precedence**: `options.model ?? config.ai.model`

**Opus upgrade logic** (specify, rebuild): `options.model ?? (config.ai.model === 'sonnet' ? 'opus' : config.ai.model)` upgrades sonnet to opus for higher-quality tasks.

**Timeout adjustment** (rebuild, specify): `Math.max(config.ai.timeoutMs, 900_000)` enforces 15-minute minimum for large modules.

### Telemetry and Observability

All AI-invoking commands create `ProgressLog` via `ProgressLog.create(absolutePath)` writing to `.agents-reverse-engineer/progress.log` with ISO timestamp header, project path, task counts. `progressLog.finalize()` writes completion status. When `options.trace` is true, `createTraceWriter(absolutePath, true)` enables NDJSON emission to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson`, `aiService.setSubprocessLogDir()` writes subprocess output to `.agents-reverse-engineer/subprocess-logs/{timestamp}/`, `cleanupOldTraces(absolutePath)` removes old traces after finalization. `aiService.finalize(absolutePath)` writes run log to `.agents-reverse-engineer/logs/run-{timestamp}.json` with token counts, durations, retry counts.

### Debug Mode

`options.debug` enables verbose logging: prints backend name, CLI command path, effective model to console via `pc.dim()` prefix `[debug]`, calls `aiService.setDebug(true)`, passes `debug: true` to config loaders, discovery, orchestrators, runners.

## Behavioral Contracts

### Argument Parsing

```javascript
// Short flag mapping
'-h' → 'help'
'-g' → 'global'
'-l' → 'local'
'-V' → 'version'

// Flag-value extraction
'--model sonnet' → values.set('model', 'sonnet')
'--concurrency 10' → values.set('concurrency', '10')
```

### Exit Code Rules

```javascript
// generate.ts, update.ts
if (summary.filesProcessed === 0 && summary.filesFailed > 0) process.exit(2);  // Total failure
if (summary.filesFailed > 0) process.exit(1);  // Partial failure
process.exit(0);  // Success

// rebuild.ts
if (modulesProcessed === 0 && modulesFailed > 0) process.exit(2);
if (modulesFailed > 0) process.exit(1);
```

### Gitignore Section Format

```
# agents-reverse-engineer
*.sum
```

Insertion logic: if section header exists, insert `*.sum` after header line; otherwise append with separator (`\n\n` if no trailing newline, single `\n` if trailing newline exists, empty string for new file).

### VS Code Settings Surgery

```jsonc
{
  "files.exclude": {
    "**/*.sum": true
  }
}
```

Applied via jsonc-parser `modify(content, ["files.exclude", "**/*.sum"], true, { formattingOptions: { tabSize: 1, insertSpaces: false } })` + `applyEdits()`, preserves comments and formatting.

### Update Plan Status Markers

```
+ (added, green)
R (renamed, blue)
M (modified, yellow)
= (unchanged, dim)
```

Displayed via `formatPlan()` with commit hash `plan.currentCommit.slice(0, 7)`.

### Dry-Run Token Estimation

```javascript
estimatedTokensK = Math.ceil(totalChars / 4) / 1000
```

Warns if exceeds 150K tokens in specify.ts dry-run mode.

### Opus Upgrade Condition

```javascript
effectiveModel = options.model ?? (config.ai.model === 'sonnet' ? 'opus' : config.ai.model)
```

Applied in specify.ts and rebuild.ts for higher-quality tasks.

### Minimum Timeout Enforcement

```javascript
timeoutMs = Math.max(config.ai.timeoutMs, 900_000)  // 15 minutes
```

Applied in rebuild.ts and specify.ts for large modules.

### CLI Not Found Detection

```javascript
try {
  backend = resolveBackend(registry, config.ai.backend);
} catch (err) {
  if (err instanceof AIServiceError && err.code === 'CLI_NOT_FOUND') {
    console.error(getInstallInstructions(config.ai.backend));
    process.exit(2);
  }
  throw err;
}
```