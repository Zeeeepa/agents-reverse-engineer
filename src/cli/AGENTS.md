<!-- Generated by agents-reverse-engineer -->

# cli

Command entry points implementing CLI argument parsing, command routing, and orchestration of AI-driven documentation generation workflows (init, discover, generate, update, clean, specify) via backend abstraction, concurrent execution pools, and incremental hash-based updates.

## Commands

### [clean.ts](./clean.ts)
`cleanCommand(targetPath, {dryRun})` deletes `.sum`, `.annex.md`, `AGENTS.md` (marker-filtered), `CLAUDE.md`, `GENERATION-PLAN.md` via parallel `fast-glob` discovery, restores `AGENTS.local.md` → `AGENTS.md`, logs deletions/skips.

### [discover.ts](./discover.ts)
`discoverCommand(targetPath, {tracer, debug})` walks directory via `discoverFiles()` filter chain, writes file list to `progress.log`, generates `GENERATION-PLAN.md` via `buildExecutionPlan()` post-order traversal, emits `discovery:start`/`discovery:end` trace events.

### [generate.ts](./generate.ts)
`generateCommand(targetPath, {dryRun, concurrency, failFast, debug, trace})` orchestrates three-phase pipeline: concurrent `.sum` file analysis via `CommandRunner.executeGenerate()`, directory `AGENTS.md` aggregation, root document synthesis (`CLAUDE.md`/`GEMINI.md`/`OPENCODE.md`), exits with codes 0 (success), 1 (partial failure), 2 (total failure).

### [index.ts](./index.ts)
CLI entry point with shebang `#!/usr/bin/env node`, implements `parseArgs()` flag parser supporting `--dry-run`, `--concurrency <n>`, `--fail-fast`, `--debug`, `--trace`, `--uncommitted`, `--force`, `--multi-file`, routes to command modules, triggers `runInstaller()` on install/uninstall/installer flags.

### [init.ts](./init.ts)
`initCommand(root, {force})` creates `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()`, checks `configExists()` to prevent overwrites unless `force` enabled, exits with code 1 on `EACCES`/`EPERM` permission errors.

### [specify.ts](./specify.ts)
`specifyCommand(targetPath, {output, force, dryRun, multiFile, debug, trace})` synthesizes project specs from `AGENTS.md` corpus via `collectAgentsDocs()`, auto-generates missing docs via `generateCommand()`, invokes `AIService.call()` with 600s minimum timeout, writes via `writeSpec()` to `specs/SPEC.md` or custom path.

### [update.ts](./update.ts)
`updateCommand(targetPath, {uncommitted, dryRun, concurrency, failFast, debug, trace})` computes delta via SHA-256 hash comparison in `preparePlan()`, cleans orphaned artifacts, regenerates `.sum` for changed files via `runner.executeUpdate()`, rebuilds `AGENTS.md` for `affectedDirs` sequentially, logs to `progress.log`.

## Execution Patterns

**Dry-run mode** (`--dry-run`): clean/generate/update/specify commands display plans without filesystem writes or AI calls. generate shows file/directory/root counts with `buildExecutionPlan()`, specify estimates tokens via `Math.ceil(totalChars / 4) / 1000`.

**Progress monitoring**: generate/update/specify create `ProgressLog.create(absolutePath)` writing to `.agents-reverse-engineer/progress.log` with ISO timestamps, file counts, task status. Enables `tail -f` real-time monitoring.

**Trace emission** (`--trace`): generate/update/specify instantiate `createTraceWriter()` before config loading, pass `tracer` to all orchestrator calls, emit NDJSON events (`phase:start`/`end`, `worker:start`/`end`, `task:pickup`/`done`, `subprocess:spawn`/`exit`, `retry`), call `cleanupOldTraces()` after `tracer.finalize()`.

**Backend resolution**: generate/update/specify call `createBackendRegistry()`, `resolveBackend(registry, config.ai.backend)`, catch `AIServiceError` with `code === 'CLI_NOT_FOUND'`, print `getInstallInstructions(registry)`, exit with code 2.

**AI service lifecycle**: generate/update/specify instantiate `AIService(backend, {timeoutMs, maxRetries, model, telemetry.keepRuns})`, call `setDebug(true)` if `--debug`, call `setSubprocessLogDir()` if `--trace`, invoke via `aiService.call()` or `runner.executeGenerate()`/`runner.executeUpdate()`, finalize via `aiService.finalize(absolutePath)` writing run logs to `.agents-reverse-engineer/logs/`.

**Installer routing**: index.ts triggers `runInstaller()` on three conditions: (1) zero args (interactive mode), (2) installer flags (`--global`, `--local`, `--runtime`, `--force`) without command, (3) explicit `install`/`uninstall` command. Passes `parseInstallerArgs(args)` with `uninstall: true` for uninstall command.

## Exit Code Strategy

**generate/update**:
- Code 2: total failure (`filesProcessed === 0 && filesFailed > 0`) or CLI not found
- Code 1: partial failure (`filesFailed > 0` with some success)
- Code 0: full success (`filesFailed === 0`)

**specify**:
- Code 2: `CLI_NOT_FOUND` error from `resolveBackend()`
- Code 1: `SpecExistsError` (output exists without `--force`) or empty docs after auto-generation
- Code 0: successful write

**init**:
- Code 1: `EACCES`/`EPERM` permission error or write failure
- Code 0: config created successfully

**clean**: No explicit exit codes (relies on thrown errors).

## File Relationships

- index.ts imports all command modules, routes via switch statement on `command` string
- generate.ts imports `discoverFiles()` from `../discovery/run.js`, `createOrchestrator()` from `../generation/orchestrator.js`, `buildExecutionPlan()` from `../generation/executor.js`, `AIService` from `../ai/index.js`, `CommandRunner` from `../orchestration/index.js`
- update.ts imports `createUpdateOrchestrator()` from `../update/index.js`, `buildDirectoryPrompt()` from `../generation/prompts/index.js`, `writeAgentsMd()` from `../generation/writers/agents-md.js`
- specify.ts imports `collectAgentsDocs()` from `../generation/collector.js`, `buildSpecPrompt()` from `../specify/index.js`, calls `generateCommand()` from `./generate.js` for auto-generation fallback
- clean.ts imports `GENERATED_MARKER` from `../generation/writers/agents-md.js` for user-authored AGENTS.md detection
- discover.ts imports `formatExecutionPlanAsMarkdown()` from `../generation/executor.js` for `GENERATION-PLAN.md` rendering
- init.ts imports `configExists()`, `writeDefaultConfig()` from `../config/loader.js`

## Behavioral Contracts

**Argument parsing** (index.ts `parseArgs()`):
- Flags starting with `--` populate `flags: Set<string>` or `values: Map<string, string>` if next arg lacks `--` prefix
- Short flags expanded: `-h` → `help`, `-g` → `global`, `-l` → `local`, `-V` → `version`
- First non-flag arg becomes `command`, subsequent populate `positional: string[]`

**Token estimation** (specify.ts dry-run):
```typescript
estimatedTokensK = Math.ceil(totalChars / 4) / 1000
```

**Plan formatting** (update.ts `formatPlan()`):
- Status markers: `+` (added, green), `R` (renamed, blue), `M` (modified, yellow), `=` (unchanged, dim)
- First run: `plan.isFirstRun === true` → suggests `are generate`
- Empty plan: all counts zero → "No changes detected since last run"

**Cleanup patterns** (clean.ts):
- Parallel `fast-glob` with patterns: `**/*.sum`, `**/*.annex.md`, `**/AGENTS.md`, `**/AGENTS.local.md`
- Ignore patterns: `['**/node_modules/**', '**/.git/**']`
- Marker detection: `content.includes(GENERATED_MARKER)` where `GENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'`

**Telemetry summary** (specify.ts):
```typescript
summaryLine = `Tokens: ${totalInputTokens} in / ${totalOutputTokens} out | Duration: ${(totalDurationMs/1000).toFixed(1)}s | Output: ${outputPath}`
```

**Subprocess timeout override** (specify.ts):
```typescript
timeoutMs = Math.max(config.ai.timeoutMs, 600_000) // minimum 10 minutes
```