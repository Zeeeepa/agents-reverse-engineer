<!-- Generated by agents-reverse-engineer -->

# cli

Command-line interface entry point and command handlers for the agents-reverse-engineer (ARE) tool. index.ts dispatches to eight command modules (init, discover, generate, update, clean, specify, rebuild, and installer integration) based on parsed CLI arguments. Each command orchestrates a distinct workflow: init bootstraps configuration, discover builds GENERATION-PLAN.md, generate executes two-phase documentation pipeline, update performs incremental regeneration, clean purges artifacts, specify synthesizes project specs, and rebuild reconstructs projects from specifications.

## Commands

- [clean.ts](./clean.ts) — **cleanCommand** deletes `.sum`, `AGENTS.md`, `CLAUDE.md`, `GENERATION-PLAN.md` artifacts via marker-based filtering (GENERATED_MARKER check), preserves user-authored files, restores `.local.md` backups, supports dry-run mode
- [discover.ts](./discover.ts) — **discoverCommand** runs `discoverFiles()` pipeline (gitignore, vendor, binary, custom filters), creates `DiscoveryResult`, calls `createOrchestrator().createPlan()`, writes GENERATION-PLAN.md to `.agents-reverse-engineer/`, emits `discovery:start` and `discovery:end` trace events
- [generate.ts](./generate.ts) — **generateCommand** orchestrates `discoverFiles()`, `createOrchestrator().createPlan()`, `buildExecutionPlan()`, resolves AIService backend via `resolveBackend(createBackendRegistry())`, launches `CommandRunner.executeGenerate()` for concurrent file analysis + post-order AGENTS.md generation, writes NDJSON telemetry via `aiService.finalize()`
- [index.ts](./index.ts) — CLI entry point with shebang, `main()` calls `parseArgs()` (handles `-h`/`--help`, `-V`/`--version`, long/short flags, flag-value pairs), routes to command handlers, special cases: no args launches installer, `hasInstallerFlags()` enables direct installer invocation
- [init.ts](./init.ts) — **initCommand** calls `writeDefaultConfig()` to create `.agents-reverse-engineer/config.yaml`, `ensureGitignoreEntry()` adds `*.sum` under `# agents-reverse-engineer` section, `ensureVscodeExclude()` uses `jsonc-parser` (parse/modify/applyEdits) to set `"files.exclude": { "**/*.sum": true }`, logs customization options (exclude.patterns, ai.concurrency, ai.timeoutMs, ai.backend)
- [rebuild.ts](./rebuild.ts) — **rebuildCommand** reads specs via `readSpecFiles()`, partitions via `partitionSpec()`, resolves AIService with opus default and 15-minute timeout minimum, calls `executeRebuild()` with checkpoint-based resumption (`CheckpointManager.load()`), outputs to `rebuild/` directory, exits with code 2 on total failure
- [specify.ts](./specify.ts) — **specifyCommand** collects AGENTS.md docs via `collectAgentsDocs()`, builds prompt via `buildSpecPrompt(docs, annexFiles)`, auto-generates via `generateCommand()` if empty, calls AIService with opus model upgrade (sonnet → opus), writes via `writeSpec()` with multi-file support, pre-checks conflicts before AI invocation, exits with code 1 on SpecExistsError
- [update.ts](./update.ts) — **updateCommand** creates `UpdateOrchestrator`, calls `preparePlan({ includeUncommitted, dryRun })` to compute UpdatePlan with `filesToAnalyze`, `affectedDirs`, `cleanup` arrays, executes `runner.executeUpdate()` for file analysis, iterates `affectedDirs` sequentially calling `buildDirectoryPrompt()` with existing AGENTS.md context, emits `phase:start`/`phase:end` trace events for `'update-phase-dir-regen'`, calls `orchestrator.recordRun()` after finalization

## Architecture

### Command Orchestration Pattern

All commands follow a five-phase pattern: (1) resolve project root via `findProjectRoot()`, (2) load config via `loadConfig()` with tracer/debug options, (3) resolve AIService backend via `createBackendRegistry()` + `resolveBackend()`, (4) execute workflow with `ProgressLog` and optional trace writer, (5) finalize telemetry via `aiService.finalize()`, `progressLog.finalize()`, `tracer.finalize()`.

### Backend Resolution

generate.ts, update.ts, specify.ts, rebuild.ts call `resolveBackend(createBackendRegistry(), config.ai.backend)`, catch `AIServiceError` with `code === 'CLI_NOT_FOUND'`, print `getInstallInstructions()`, exit with code 2.

### Progress Tracking

Commands create `ProgressLog.create(absolutePath)` for tail-followable output at `.agents-reverse-engineer/progress.log`, write headers with ISO timestamps, project paths, task counts. Finalize via `progressLog.finalize()` appends success/failure summaries.

### Tracing

When `options.trace` is true, commands call `createTraceWriter(absolutePath, true)` for NDJSON tracing, set subprocess log directory via `aiService.setSubprocessLogDir()`, cleanup old traces via `cleanupOldTraces(absolutePath)`.

### Exit Codes

- **0**: all tasks succeeded or no tasks to process
- **1**: partial failure (some tasks failed but some succeeded)
- **2**: total failure (all tasks failed or CLI not found)

### Model Selection Precedence

Effective model resolved as `options.model ?? config.ai.model`. specify.ts and rebuild.ts upgrade default "sonnet" to "opus" for quality. generate.ts and update.ts respect config defaults.

### Dry-Run Behavior

discover.ts, generate.ts, update.ts, clean.ts, specify.ts, rebuild.ts support `--dry-run`: print execution plan, token estimates, or file lists without executing AI calls, unlink operations, or spec writes.

## Configuration Integration

All commands import `loadConfig` and `findProjectRoot` from `../config/loader.js`. init.ts imports `configExists`, `writeDefaultConfig`, `CONFIG_DIR`, `CONFIG_FILE` for setup. Commands pass `debug` and `tracer` to loadConfig() for verbose logging and trace event emission.

## Installer Integration

index.ts imports `runInstaller` and `parseInstallerArgs` from `../installer/index.js`. Special invocation modes: (1) no args launches interactive installer, (2) `hasInstallerFlags(flags, values)` checks for `global`, `local`, `force` flags or `runtime` value, routes to installer without command.

## Argument Parsing

`parseArgs(args: string[])` returns `{ command?, positional, flags: Set<string>, values: Map<string, string> }`. Short flag mapping: `-h` → `help`, `-g` → `global`, `-l` → `local`, `-V` → `version`. Flag-value pairs parsed as `--flag value`. First non-flag becomes command, rest go to positional array.

## Dependencies

clean.ts: `../config/loader.js` (findProjectRoot), `../output/logger.js` (createLogger), `../generation/writers/agents-md.js` (GENERATED_MARKER), fast-glob, picocolors  
discover.ts: `../config/loader.js` (loadConfig, findProjectRoot), `../discovery/run.js` (discoverFiles), `../generation/orchestrator.js` (createOrchestrator), `../generation/executor.js` (buildExecutionPlan, formatExecutionPlanAsMarkdown), `../orchestration/index.js` (ProgressLog)  
generate.ts: `../config/loader.js`, `../discovery/run.js`, `../generation/orchestrator.js`, `../generation/executor.js`, `../ai/index.js` (AIService, AIServiceError, createBackendRegistry, resolveBackend, getInstallInstructions), `../orchestration/index.js` (CommandRunner, ProgressLog, createTraceWriter, cleanupOldTraces)  
index.ts: `../installer/index.js` (runInstaller, parseInstallerArgs), `../version.js` (getVersion)  
init.ts: `../config/loader.js` (configExists, writeDefaultConfig, CONFIG_DIR, CONFIG_FILE), `../output/logger.js`, jsonc-parser  
rebuild.ts: `../config/loader.js`, `../ai/index.js`, `../orchestration/index.js`, `../rebuild/index.js` (readSpecFiles, partitionSpec, CheckpointManager, executeRebuild), picocolors  
specify.ts: `../config/loader.js`, `../generation/collector.js` (collectAgentsDocs, collectAnnexFiles), `../specify/index.js` (buildSpecPrompt, writeSpec, SpecExistsError), `../ai/index.js`, `../orchestration/index.js`, `./generate.js` (generateCommand)  
update.ts: `../config/loader.js`, `../output/logger.js`, `../update/index.js` (createUpdateOrchestrator, UpdatePlan), `../generation/writers/agents-md.js` (writeAgentsMd, GENERATED_MARKER), `../generation/writers/claude-md.js` (writeClaudeMdPointer), `../generation/prompts/index.js` (buildDirectoryPrompt), `../ai/index.js`, `../orchestration/index.js` (CommandRunner, ProgressReporter, ProgressLog, createTraceWriter, cleanupOldTraces)

## Behavioral Contracts

### SUM_PATTERN (clean.ts, init.ts)
`"*.sum"` — gitignore pattern covering both .sum and .annex.sum files

### GITIGNORE_SECTION (init.ts)
`"# agents-reverse-engineer"` — section header for ensureGitignoreEntry insertion logic

### VS Code Exclusion Path (init.ts)
`["files.exclude", "**/*.sum"]` — JSONC path for jsonc-parser modify operation, formattingOptions: `{ tabSize: 1, insertSpaces: false }`

### Progress Log Header Format (update.ts)
`"=== ARE Update (${new Date().toISOString()}) ==="` — timestamp format for ProgressLog header

### Trace Phase Label (update.ts)
`'update-phase-dir-regen'` — phase identifier for directory regeneration trace events with `workerId: 0`

### File Status Markers (update.ts formatPlan)
- `+` (added, green), `R` (renamed, blue), `M` (modified, yellow), `=` (unchanged, dim)

### Short Flag Mapping (index.ts parseArgs)
`-h` → `help`, `-g` → `global`, `-l` → `local`, `-V` → `version`