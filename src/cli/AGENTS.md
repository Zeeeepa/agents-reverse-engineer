<!-- Generated by agents-reverse-engineer -->

# cli

CLI command entry point and router implementing eight top-level commands (init, discover, generate, update, specify, rebuild, clean, install/uninstall) with flag parsing, version/help handling, and interactive installer fallback.

## Contents

### Core Commands

**[generate.ts](./generate.ts)** — Implements `are generate`: discovers files via four-filter chain, creates `GenerationPlan` with phase-1 file tasks (parallel `.sum` generation via `AIService.call()`) and phase-2 directory tasks (post-order `AGENTS.md` aggregation), resolves AI backend via `resolveBackend(registry, config.ai.backend)` (exits code 2 on CLI_NOT_FOUND), spawns `CommandRunner.executeGenerate()` with concurrency control, writes telemetry/traces, exits 0/1/2 based on success counts. Exposes `GenerateOptions` (`force`, `dryRun`, `concurrency`, `failFast`, `debug`, `trace`, `model`) and `formatPlan()` for task count display.

**[update.ts](./update.ts)** — Implements `are update`: detects changed files via `createUpdateOrchestrator().preparePlan()` (SHA-256 content-hash comparison from `.sum` frontmatter), executes phase-1 file re-analysis with `CommandRunner.executeUpdate()`, regenerates `AGENTS.md` for `plan.affectedDirs` sequentially via post-order directory iteration (reads existing generated AGENTS.md for incremental context), cleans orphaned `.sum`/AGENTS.md artifacts via `UpdateOrchestrator.cleanupOrphans()`, exits 0/1/2 based on partial/total success. Exposes `UpdateCommandOptions` (`uncommitted`, `dryRun`, `concurrency`, `failFast`, `debug`, `trace`, `model`) and `formatPlan()` with status markers (`+` added, `M` modified, `R` renamed, `=` unchanged).

**[discover.ts](./discover.ts)** — Implements `are discover`: applies four-filter chain (gitignore→vendor→binary→custom) via `discoverFiles(resolvedPath, config)`, emits `discovery:start`/`discovery:end` trace events with `filesIncluded`/`filesExcluded` counts, logs included/excluded files to stdout and `.agents-reverse-engineer/progress.log`, generates post-order execution plan via `buildExecutionPlan()` → `formatExecutionPlanAsMarkdown()`, writes `GENERATION-PLAN.md` with task dependency tree. Exposes `DiscoverOptions` (`tracer`, `debug`, `showExcluded`).

**[init.ts](./init.ts)** — Implements `are init`: creates `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()` (warns if exists unless `force: true`), orchestrates `ensureGitignoreEntry()` (adds `*.sum` pattern within `# agents-reverse-engineer` section marker), `ensureVscodeExclude()` (sets `files.exclude["**/*.sum"]` via `jsonc-parser` surgical edits preserving comments), exits code 1 on EACCES/EPERM errors. Exposes `ensureGitignoreEntry()`, `ensureVscodeExclude()` returning boolean modified flags.

**[clean.ts](./clean.ts)** — Implements `are clean`: discovers artifacts via five parallel `fg.glob()` calls (`**/*.sum`, `AGENTS.md`, `AGENTS.local.md`, `CLAUDE.md`, `CLAUDE.local.md`), marker-filters via `content.includes(GENERATED_MARKER)` (preserves user-authored files), deletes via `unlink()`, restores `.local.md` files via `rename()` (`AGENTS.local.md` → `AGENTS.md`, `CLAUDE.local.md` → `CLAUDE.md`), reports deletion/preservation/restoration counts. Exposes `CleanOptions` (`dryRun`).

**[specify.ts](./specify.ts)** — Implements `are specify`: collects `AGENTS.md` docs via `collectAgentsDocs()` and `.annex.sum` files via `collectAnnexFiles()`, auto-generates via `generateCommand()` if `docs.length === 0`, resolves AI backend with CLI_NOT_FOUND error handling, constructs prompt via `buildSpecPrompt()`, invokes `AIService.call()` with extended timeout (`Math.max(config.ai.timeoutMs, 900_000)` for 15-min minimum), writes single/multi-file output via `writeSpec()` to `specs/SPEC.md`, catches `SpecExistsError` (exits code 1 without `--force`), finalizes telemetry/traces. Exposes `SpecifyOptions` (`output`, `force`, `dryRun`, `multiFile`, `debug`, `trace`, `model` defaulting to `'opus'`).

**[rebuild.ts](./rebuild.ts)** — Implements `are rebuild`: reads spec files via `readSpecFiles()`, partitions into ordered `RebuildUnit[]` via `partitionSpec()`, resolves AI backend with CLI_NOT_FOUND error handling, executes incremental rebuild via `executeRebuild(aiService, absolutePath, {...})` with `CheckpointManager.load()` resume logic, writes generated files to `rebuild/` output directory (or custom `--output` path), finalizes telemetry/traces, exits 0/1/2 based on `modulesProcessed`/`modulesFailed` counters. Exposes `RebuildOptions` (`output`, `force` for wipe, `dryRun`, `concurrency`, `failFast`, `debug`, `trace`, `model` defaulting to `'opus'`).

### Entry Point

**[index.ts](./index.ts)** — Executable CLI router (`#!/usr/bin/env node`) parsing commands via `parseArgs()` (extracts command name, positional paths, boolean flags `--debug`/`--dry-run`/`--force`/`--fail-fast`/`--trace`/`--show-excluded`/`--uncommitted`/`--multi-file`/`--global`/`--local`, key-value pairs `--concurrency <n>`/`--model <name>`/`--output <path>`/`--runtime <name>`), dispatches to command functions (`initCommand`, `discoverCommand`, `generateCommand`, `updateCommand`, `specifyCommand`, `rebuildCommand`, `cleanCommand`, `runInstaller()`), handles `--version`/`-V` (prints `agents-reverse-engineer v${VERSION}`), `--help`/`-h` (displays `USAGE` string), zero-argument invocation (triggers interactive `runInstaller()`), unknown command errors (exits code 1), uncaught exceptions (logs `Error: ${err.message}`, exits code 1).

## Command Routing

### Argument Parsing
`parseArgs(args: string[])` returns `{ command, positional, flags, values }` by iterating `args` array, detecting command as first non-flag arg, accumulating `--long-flag` in `flags` set, storing `--key value` pairs in `values` map, handling short flags (`-h` → `help`, `-g` → `global`, `-l` → `local`, `-V` → `version`). Long flags with subsequent non-flag args stored as key-value; standalone flags added to flags set.

### Default Path Fallback
All commands receive `positional[0] || '.'` as target path, defaulting to current directory when no path argument provided.

### Interactive Installer Trigger
Zero-argument invocation (`args.length === 0`) routes to `runInstaller()` with default options. Direct installer flags without command (`!command && hasInstallerFlags()`) enable `npx agents-reverse-engineer --runtime claude -g` shorthand.

### Command Dispatch Table
- `install` → `runInstaller(installerArgs)`
- `uninstall` → `runInstaller({ ...installerArgs, uninstall: true })`
- `init` → `initCommand(path, { force })`
- `discover` → `discoverCommand(path, { showExcluded })`
- `generate` → `generateCommand(path, { force, dryRun, concurrency, failFast, debug, trace, model })`
- `update` → `updateCommand(path, { uncommitted, dryRun, concurrency, failFast, debug, trace, model })`
- `specify` → `specifyCommand(path, { output, force, dryRun, multiFile, debug, trace, model })`
- `rebuild` → `rebuildCommand(path, { output, force, dryRun, concurrency, failFast, debug, trace, model })`
- `clean` → `cleanCommand(path, { dryRun })`

## Exit Codes

- **0**: Success (all tasks succeeded, no files to process, or help/version display)
- **1**: Partial failure (some tasks failed, permission errors, unknown command, SpecExistsError, ENOENT/EACCES on project root)
- **2**: Total failure (all tasks failed, CLI_NOT_FOUND backend error)

## Integration Points

Commands delegate to subsystems via exact import paths:
- **Config**: `../config/loader.js` (`loadConfig`, `findProjectRoot`, `configExists`, `writeDefaultConfig`)
- **Discovery**: `../discovery/run.js` (`discoverFiles`)
- **Orchestration**: `../orchestration/orchestrator.js` (`createOrchestrator`, `createUpdateOrchestrator`), `../orchestration/index.js` (`CommandRunner`, `ProgressLog`, `ProgressReporter`, `createTraceWriter`, `cleanupOldTraces`)
- **AI**: `../ai/index.js` (`AIService`, `AIServiceError`, `createBackendRegistry`, `resolveBackend`, `getInstallInstructions`)
- **Generation**: `../generation/executor.js` (`buildExecutionPlan`, `formatExecutionPlanAsMarkdown`), `../generation/collector.js` (`collectAgentsDocs`, `collectAnnexFiles`), `../generation/prompts/index.js` (`buildDirectoryPrompt`), `../generation/writers/agents-md.js` (`writeAgentsMd`, `GENERATED_MARKER`), `../generation/writers/claude-md.js` (`writeClaudeMdPointer`), `../generation/writers/sum.js` (`writeSumFile`, `readSumFile`)
- **Rebuild**: `../rebuild/index.js` (`readSpecFiles`, `partitionSpec`, `CheckpointManager`, `executeRebuild`)
- **Specify**: `../specify/index.js` (`buildSpecPrompt`, `writeSpec`, `SpecExistsError`)
- **Installer**: `../installer/index.js` (`runInstaller`, `parseInstallerArgs`)
- **Output**: `../output/logger.js` (`createLogger`), `../core/logger.js` (`consoleLogger`)
- **Version**: `../version.js` (`getVersion`)

## Behavioral Contracts

### Installer Flags Detection
```javascript
flags.has('global') || flags.has('local') || flags.has('force') || values.has('runtime')
```
Used to distinguish direct installer invocation (`are --runtime claude -g`) from help display (`are --help`).

### Concurrency Parsing
```javascript
values.has('concurrency') ? parseInt(values.get('concurrency')!, 10) : undefined
```
Undefined concurrency delegates to auto-calculation in orchestrator (`os.availableParallelism() * 5` clamped to memory cap).

### Model Override Priority
```javascript
options.model ?? config.ai.model  // generate.ts, update.ts
options.model ?? (config.ai.model === 'sonnet' ? 'opus' : config.ai.model)  // specify.ts, rebuild.ts
```
CLI `--model` flag overrides config. Specify/rebuild commands upgrade config `'sonnet'` to `'opus'` for higher-quality long-form synthesis.

### Extended Timeout (specify/rebuild)
```javascript
timeoutMs: Math.max(config.ai.timeoutMs, 900_000)
```
15-minute minimum regardless of config for spec generation/project reconstruction.

### Marker-Based File Protection (clean)
```javascript
content.includes(GENERATED_MARKER)  // Only delete if true
```
User-authored `AGENTS.md`/`CLAUDE.md` files lacking marker preserved silently.

### Short Flag Mapping (index)
```javascript
case 'h': flags.add('help'); break;
case 'g': flags.add('global'); break;
case 'l': flags.add('local'); break;
case 'V': flags.add('version'); break;
```

### File Discovery Patterns (clean)
- `.sum` glob: `**/*.sum` (catches both `.sum` and `.annex.sum` via single pattern)
- Ignore patterns: `['**/node_modules/**', '**/.git/**']`
- All globs use `{ absolute: true, onlyFiles: true, dot: true }`

### Post-Order Directory Sort (update)
```javascript
getDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth
```
Ensures child directories processed before parents during AGENTS.md regeneration.

### Status Markers (update)
- `pc.green('+')` — added
- `pc.blue('R')` — renamed (with `(was: {oldPath})` suffix)
- `pc.yellow('M')` — modified
- `pc.dim('=')` — unchanged

### Git Change Detection (update)
```javascript
execSync('git status --porcelain', { encoding: 'utf-8' })
```
Detects staged + working directory changes for `--uncommitted` flag.

### First Run Detection (update)
```javascript
plan.isFirstRun  // True when no .sum files exist
```
Triggers early exit with yellow hint: `Run "are generate" first to create initial documentation.`

### Auto-Generation Trigger (specify)
```javascript
if (docs.length === 0) {
  await generateCommand(targetPath, { debug, trace });
  docs = await collectAgentsDocs(absolutePath);
  annexFiles = await collectAnnexFiles(absolutePath);
}
```
Automatically invokes full generation pipeline when no AGENTS.md files found (skipped in dry-run mode).

### Conflict Detection (specify multiFile)
```javascript
const entries = await readdir(outputDir);
for (const entry of entries) {
  if (entry.endsWith('.md')) {
    conflicts.push(path.join(outputDir, entry));
  }
}
```
Treats any existing `*.md` file in output directory as conflict when `--multi-file` specified.

### Dry-Run Token Estimation (specify)
```javascript
estimatedTokensK = Math.ceil(totalChars / 4) / 1000
```
Approximates token count as `chars / 4`, rounds up, converts to thousands. Warns when `estimatedTokensK > 150`.

### Subprocess Log Path Format
```javascript
`.agents-reverse-engineer/subprocess-logs/${new Date().toISOString().replace(/[:.]/g, '-')}`
```
Timestamp format replaces colons and dots with hyphens for filesystem compatibility (used in generate/update/specify/rebuild when `--trace` enabled).