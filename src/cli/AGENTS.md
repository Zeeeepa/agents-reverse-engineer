<!-- Generated by agents-reverse-engineer -->

# src/cli

Command-line interface entry point and command handlers for the agents-reverse-engineer (ARE) CLI tool. Routes user commands to specialized handlers that orchestrate file discovery, AI-driven documentation generation, incremental updates, cleanup, and project specification synthesis.

## Contents

### Entry Point and Routing

**[index.ts](./index.ts)** — CLI bootstrap and command dispatcher. Exports `main()` which parses `process.argv` via `parseArgs()` and routes to six command handlers: `initCommand`, `discoverCommand`, `generateCommand`, `updateCommand`, `cleanCommand`, `specifyCommand`. Supports interactive installer invocation via `runInstaller()` with `parseInstallerArgs()`. Defines `GenerateOptions`, `UpdateCommandOptions`, `CleanOptions`, `SpecifyOptions` types. Implements global flags: `--help`, `--version`, `--debug`, `--trace`, `--dry-run`, `--concurrency`, `--fail-fast`. Reads VERSION from package.json via `getVersion()`, displays USAGE constant via `showHelp()`.

### Command Implementations

**[init.ts](./init.ts)** — Configuration initialization command. Exports `initCommand(root: string)` which creates `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()` if not present (checked via `configExists()`), logs guidance about `exclude.patterns`, `ai.concurrency` (1-10, default 5), `ai.timeoutMs`, `ai.backend` (claude/gemini/opencode/auto). Handles EACCES/EPERM errors with exit code 1.

**[discover.ts](./discover.ts)** — File discovery and generation plan creation. Exports `discoverCommand(targetPath: string, options: DiscoverOptions)` with `tracer?: ITraceWriter` and `debug?: boolean`. Calls `discoverFiles()` from `../discovery/run.js`, writes NDJSON progress to `ProgressLog.create()`, emits `discovery:start`/`discovery:end` trace events with filesIncluded/filesExcluded counts, generates GENERATION-PLAN.md via `createOrchestrator().createPlan()` → `buildExecutionPlan()` → `formatExecutionPlanAsMarkdown()`.

**[generate.ts](./generate.ts)** — Full documentation generation orchestrator. Exports `generateCommand(targetPath: string, options: GenerateOptions)` with `dryRun`, `concurrency`, `failFast`, `debug`, `trace` fields. Executes five-step pipeline: `loadConfig()` → `discoverFiles()` → `createOrchestrator().createPlan()` → `resolveBackend(createBackendRegistry())` → `CommandRunner.executeGenerate(buildExecutionPlan())`. Threads `createTraceWriter()` output through all operations via `CommandRunOptions.tracer`. Dry-run mode displays `GenerationPlan` stats (filesIncluded, tasksTotal, complexity metrics) via `formatPlan()`. Exits with code 2 on CLI_NOT_FOUND (prints `getInstallInstructions()`), code 1 on partial failure, code 0 on success. Finalizes via `aiService.finalize()`, `progressLog.finalize()`, `tracer.finalize()`, `cleanupOldTraces()`.

**[update.ts](./update.ts)** — Incremental documentation update orchestrator. Exports `updateCommand(targetPath: string, options: UpdateCommandOptions)` with `uncommitted`, `dryRun`, `concurrency`, `failFast`, `debug`, `trace` fields. Two-phase execution: Phase 1 analyzes `UpdatePlan.filesToAnalyze` via `CommandRunner.executeUpdate()` with worker pool, Phase 2 regenerates AGENTS.md for `UpdatePlan.affectedDirs` via sequential `buildDirectoryPrompt()` + `writeAgentsMd()` calls. Creates `UpdateOrchestrator` via `createUpdateOrchestrator()`, prepares `UpdatePlan` via `orchestrator.preparePlan()`, resolves backend via `resolveBackend(createBackendRegistry())`, records run state via `orchestrator.recordRun()`. Exports `formatPlan(plan: UpdatePlan)` helper showing git changes with status markers (`+` added, `R` renamed, `M` modified), `formatCleanup()` for deleted artifacts. Creates `ProgressReporter` for Phase 2 with `onDirectoryStart()`/`onDirectoryDone()` callbacks. Exit codes match generate.ts (0/1/2).

**[specify.ts](./specify.ts)** — Project specification synthesis from AGENTS.md corpus. Exports `specifyCommand(targetPath: string, options: SpecifyOptions)` with `output`, `force`, `dryRun`, `multiFile`, `debug`, `trace` fields. Five-phase pipeline: `loadConfig()` → `collectAgentsDocs()` → auto-generation via `generateCommand()` if docs.length === 0 → `resolveBackend()` → `aiService.call(buildSpecPrompt())` → `writeSpec()`. Extends AIService timeout to `Math.max(config.ai.timeoutMs, 600_000)` for long-running synthesis. Dry-run mode displays docs.length, estimated tokens (chars/4/1000), outputPath, multiFile status, warns if docs.length === 0 or estimatedTokensK > 150. Catches `SpecExistsError` from `writeSpec()` when force=false, exits with code 1.

**[clean.ts](./clean.ts)** — Artifact deletion and AGENTS.local.md restoration. Exports `cleanCommand(targetPath: string, options: CleanOptions)` with `dryRun` field. Discovers files via `fg.glob()` across three patterns: `**/*.sum`, `**/AGENTS.md`, `**/AGENTS.local.md` (ignores node_modules, .git). Filters AGENTS.md files via GENERATED_MARKER from `../generation/writers/agents-md.js` to prevent user-authored file deletion. Adds CLAUDE.md and GENERATION-PLAN.md via `access()` + F_OK check. Non-dry-run mode calls `unlink()` on all discovered files, restores AGENTS.local.md via `rename()` to AGENTS.md. Validates targetPath via `access()` + R_OK, exits with code 1 on ENOENT/EACCES/EPERM.

## Cross-Module Integration

All command handlers import `loadConfig` from `../config/loader.js` for YAML schema validation via Zod, `createLogger` from `../output/logger.js` for colored console output (logger.info/warn/error/file/excluded/summary). Five commands (discover, generate, update, specify, clean) create `ProgressLog` instances via `ProgressLog.create()` from `../orchestration/index.js` to write runtime events to `.agents-reverse-engineer/progress.log` for `tail -f` monitoring. Four commands (generate, update, specify, discover) support `--trace` flag which creates `ITraceWriter` via `createTraceWriter()` and enables NDJSON event logging to `.agents-reverse-engineer/traces/`.

Backend resolution follows identical pattern in generate.ts, update.ts, specify.ts: import `createBackendRegistry`, `resolveBackend`, `getInstallInstructions`, `AIServiceError` from `../ai/index.js`, catch AIServiceError with code='CLI_NOT_FOUND', print installation instructions, exit with code 2. AIService instantiation passes `config.ai.timeoutMs`, `config.ai.maxRetries`, `config.ai.model`, `config.ai.telemetry.keepRuns`, and calls `setDebug(true)` when `options.debug` is true.

Discovery phase (used by generate.ts and update.ts) imports `discoverFiles` from `../discovery/run.js`, passing loaded config and trace writer. Generation orchestration imports `createOrchestrator` from `../generation/orchestrator.js`, `buildExecutionPlan` and `formatExecutionPlanAsMarkdown` from `../generation/executor.js`, and `CommandRunner` from `../orchestration/index.js` to execute three-phase pipeline (file analysis → directory AGENTS.md → root documents).

Update workflow imports `createUpdateOrchestrator` and `UpdatePlan` type from `../update/index.js`, regenerates AGENTS.md via `writeAgentsMd` from `../generation/writers/agents-md.js`, builds prompts via `buildDirectoryPrompt` from `../generation/prompts/index.js`. Specification workflow imports `collectAgentsDocs` from `../generation/collector.js`, `buildSpecPrompt`, `writeSpec`, `SpecExistsError` from `../specify/index.js`.

## Resource Management Pattern

All long-running commands (generate, update, specify) follow identical finalization sequence: (1) `aiService.finalize(absolutePath)` writes NDJSON telemetry run log to `.agents-reverse-engineer/logs/<timestamp>.ndjson`, (2) `progressLog.finalize()` closes progress.log stream, (3) `tracer.finalize()` closes trace NDJSON stream, (4) `cleanupOldTraces(absolutePath)` purges traces older than retention threshold when `options.trace` is true. This sequence executes before exit code determination to ensure logs are flushed even on partial failure.