<!-- Generated by agents-reverse-engineer -->

# src/cli

Command-line interface entry point and command handlers for the agents-reverse-engineer tool. Implements eight commands: `init` (bootstrap config), `discover` (file tree walk + filter), `generate` (three-phase AI documentation pipeline), `update` (incremental regeneration via git/hash comparison), `clean` (artifact deletion with marker-based filtering), `specify` (project spec synthesis from AGENTS.md), `rebuild` (checkpoint-based project reconstruction), and installer operations (`install`/`uninstall` for CLI hooks).

## Contents

### Entry Point

**[index.ts](./index.ts)** — Executable entry point (`#!/usr/bin/env node`) with `parseArgs()` router dispatching to command modules. Handles short flags (`-h`, `-g`, `-l`, `-V`), long flags (`--dry-run`, `--force`, `--debug`, `--trace`, `--fail-fast`, `--uncommitted`, `--multi-file`), valued options (`--output`, `--model`, `--concurrency`, `--runtime`). Special invocation modes: `hasInstallerFlags()` for direct installer access, interactive installer when `args.length === 0`. Version/help commands exit with code 0, unknown commands exit with code 1.

### Commands

**[init.ts](./init.ts)** — `initCommand(root, { force })` bootstraps `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()`. Checks `configExists()` before writing, warns on existing config unless `force` enabled. Exits with code 1 on EACCES/EPERM permission errors.

**[discover.ts](./discover.ts)** — `discoverCommand(targetPath, { tracer, debug })` executes file discovery pipeline: `loadConfig()` → `discoverFiles()` with gitignore/vendor/binary/custom filters → writes included/excluded file lists to console + `.agents-reverse-engineer/progress.log` → generates `GENERATION-PLAN.md` via `createOrchestrator().createPlan()` + `buildExecutionPlan()` + `formatExecutionPlanAsMarkdown()`. Emits `discovery:start` and `discovery:end` trace events with `filesIncluded`, `filesExcluded`, `durationMs` via `ITraceWriter`.

**[generate.ts](./generate.ts)** — `generateCommand(targetPath, GenerateOptions)` orchestrates three-phase AI pipeline: file discovery → `buildExecutionPlan(fileTasks, directoryTasks, rootTasks)` → `CommandRunner.executeGenerate()` with pool-based concurrency for file phase, post-order AGENTS.md generation, sequential root docs. Resolves backend via `resolveBackend(createBackendRegistry(), config.ai.backend)`, exits with code 2 on `AIServiceError` with `code === 'CLI_NOT_FOUND'`. Dry-run mode (`options.dryRun`) displays plan summary without AI calls. Model resolution: `options.model ?? config.ai.model`. Tracing via `createTraceWriter()` writes NDJSON to `.agents-reverse-engineer/traces/`, subprocess stdout/stderr to `.agents-reverse-engineer/subprocess-logs/` when `options.trace` enabled. Exit codes: 0 (success), 1 (partial failure), 2 (total failure/no CLI).

**[update.ts](./update.ts)** — `updateCommand(targetPath, UpdateCommandOptions)` implements incremental regeneration: `createUpdateOrchestrator().preparePlan({ includeUncommitted, dryRun })` returns `UpdatePlan` with `filesToAnalyze`, `filesToSkip`, `cleanup`, `affectedDirs`, `currentCommit`, `isFirstRun` → `CommandRunner.executeUpdate(filesToAnalyze)` concurrent file analysis → sequential AGENTS.md regeneration for `affectedDirs` via `buildDirectoryPrompt(existingAgentsMd)` + `aiService.call()` + `writeAgentsMd()`. Emits `update-phase-dir-regen` trace events. Cleanup actions (`deletedSumFiles`, `deletedAgentsMd`) formatted via `formatCleanup()` with red `-` markers. Model override: `options.model ?? config.ai.model`. Exit codes: 2 (all failed), 1 (partial failure), 0 (success).

**[clean.ts](./clean.ts)** — `cleanCommand(targetPath, { dryRun })` deletes ARE-generated artifacts via `fast-glob` parallel discovery: `**/*.sum`, `**/*.annex.md`, `**/AGENTS.md`, `**/AGENTS.local.md`, `CLAUDE.md`, `.agents-reverse-engineer/GENERATION-PLAN.md`. Marker-based filtering: reads `**/AGENTS.md`, checks for `GENERATED_MARKER` presence (imported from `src/generation/writers/agents-md.js`), preserves user-authored files without marker. Restores `AGENTS.local.md` → `AGENTS.md` via `rename()`. Dry-run mode displays paths without `unlink()`. Exits with code 1 on ENOENT/EACCES/EPERM directory access failures.

**[specify.ts](./specify.ts)** — `specifyCommand(targetPath, SpecifyOptions)` synthesizes project specification from AGENTS.md: `collectAgentsDocs()` + `collectAnnexFiles()` → auto-generation fallback via `generateCommand()` if `docs.length === 0` → backend resolution → `buildSpecPrompt(docs, annexFiles)` → `aiService.call()` → `writeSpec(outputPath, { force, multiFile })`. Model upgrade: `options.model ?? (config.ai.model === 'sonnet' ? 'opus' : config.ai.model)` promotes sonnet → opus. Extended timeout: `Math.max(config.ai.timeoutMs, 900_000)` (15min minimum). Dry-run mode computes `estimatedTokensK` via `Math.ceil(totalChars / 4) / 1000`, warns if `estimatedTokensK > 150`. Exits with code 1 on `SpecExistsError` without `--force`, code 2 on CLI not found.

**[rebuild.ts](./rebuild.ts)** — `rebuildCommand(targetPath, RebuildOptions)` orchestrates checkpoint-based reconstruction: `loadConfig()` → `readSpecFiles()` → `partitionSpec()` into rebuild units → `CheckpointManager.load()` for resume state → dry-run short-circuit displays unit count/order → `resolveBackend()` → `executeRebuild(aiService, units, outputDir, tracer, progressLog)`. Model upgrade: `options.model ?? (config.ai.model === 'sonnet' ? 'opus' : config.ai.model)`. Extended timeout: `Math.max(config.ai.timeoutMs, 900_000)`. Exits with code 2 (no modules processed), 1 (partial failure), 0 (success).

## Command Routing Pattern

`index.ts` parses CLI args into `{ command, positional, flags, options }`, routes to command modules with resolved `targetPath` (first positional arg or `'.'`) and merged options from flags/values. Installer commands (`install`/`uninstall`) delegate to `runInstaller(parseInstallerArgs(args))` from `src/installer/index.ts`.

## Shared Dependencies

All commands import `loadConfig()` from `src/config/loader.ts` for `.agents-reverse-engineer/config.yaml` loading, `createLogger()` from `src/output/logger.ts` for colored console output (`logger.info()`, `logger.error()`, `logger.file()`, `logger.excluded()`), `createTraceWriter()` from `src/orchestration/index.ts` for NDJSON event logging to `.agents-reverse-engineer/traces/`, `AIService` + `createBackendRegistry()` + `resolveBackend()` + `getInstallInstructions()` from `src/ai/index.ts` for backend CLI resolution and subprocess management.

## AI Backend Resolution

Commands invoking AI (`generate`, `update`, `specify`, `rebuild`) follow consistent backend resolution: `createBackendRegistry()` → `resolveBackend(registry, config.ai.backend)` → catch `AIServiceError` with `code === 'CLI_NOT_FOUND'` → `getInstallInstructions(registry)` → `process.exit(2)`. Effective model resolved via `options.model ?? config.ai.model` (CLI flag takes precedence). Specification and rebuild commands upgrade sonnet → opus via `config.ai.model === 'sonnet' ? 'opus' : config.ai.model` for quality-critical workloads.

## Tracing Integration

Commands accepting `--trace` flag create `ITraceWriter` via `createTraceWriter(absolutePath, options.trace ?? false)`, thread tracer through `loadConfig({ tracer })`, `CommandRunner({ tracer })`, `aiService.setTracer(tracer)`, emit phase-specific events (`discovery:start`, `phase:start`, `task:start`, `subprocess:spawn`, `task:done`, `phase:end`). When `options.trace` enabled, `aiService.setSubprocessLogDir()` captures per-subprocess stdout/stderr to `.agents-reverse-engineer/subprocess-logs/{ISO-timestamp}/`. All commands call `tracer.finalize()` and conditionally `cleanupOldTraces(absolutePath)` before exit.

## Progress Logging

Commands with long-running operations (`discover`, `generate`, `update`, `specify`, `rebuild`) create `ProgressLog.create(absolutePath)` to write human-readable progress to `.agents-reverse-engineer/progress.log` for `tail -f` monitoring. Header lines include ISO timestamp, project path, task counts. `progressLog.write()` appends events, `progressLog.finalize()` closes stream.

## Exit Code Conventions

- **0**: Success (all tasks completed without failures)
- **1**: Partial failure (some files/modules failed, but at least one succeeded)
- **2**: Total failure (no files/modules processed AND failures occurred) OR CLI backend not found

## Dry-Run Behavior

Commands supporting `--dry-run` flag (`clean`, `discover`, `generate`, `update`, `specify`, `rebuild`) display execution plan, file lists, token estimates, and cleanup actions without writing files or invoking AI. `clean` uses yellow `'Dry run — no files were changed.'` message. `generate`, `specify`, `rebuild` compute token estimates via `Math.ceil(totalChars / 4) / 1000` and warn if exceeding thresholds.