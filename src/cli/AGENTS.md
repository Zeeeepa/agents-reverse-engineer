<!-- Generated by agents-reverse-engineer v0.8.2 -->

# src/cli

Command-line interface routing layer implementing eight subcommands (`init`, `discover`, `generate`, `update`, `specify`, `rebuild`, `clean`, `install`/`uninstall`) with argument parsing, interactive installer fallback, and lifecycle hooks for two-phase AI documentation generation, incremental updates, specification synthesis, and artifact cleanup.

## Contents

**[index.ts](./index.ts)** — Executable entry point (shebang `#!/usr/bin/env node`) routing commands via `parseArgs()` to handler functions, maps short flags (`-h`→`help`, `-g`→`global`, `-l`→`local`, `-V`→`version`), triggers interactive installer on zero-argument invocation or standalone installer flags (`--runtime`, `--global`, `--local`), displays version banner via `getVersion()`, exits code 1 on unknown commands.

**[init.ts](./init.ts)** — `initCommand()` creates `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()`, calls `ensureGitignoreEntry()` (adds `*.sum` to `.gitignore` within marker section, idempotent), `ensureVscodeExclude()` (sets `files.exclude["**/*.sum"]=true` in `.vscode/settings.json` via `jsonc-parser` surgical edits preserving comments/formatting), exits code 1 on EACCES/EPERM.

**[discover.ts](./discover.ts)** — `discoverCommand()` executes four-filter chain (gitignore→vendor→binary→custom) via `discoverFiles()`, writes relative paths to stdout + `.agents-reverse-engineer/progress.log`, generates `GENERATION-PLAN.md` via `createOrchestrator().createPlan()` + `formatExecutionPlanAsMarkdown()`, emits `discovery:start`/`discovery:end` trace events, exits code 1 on ENOENT/EACCES/plan write failure.

**[generate.ts](./generate.ts)** — `generateCommand()` orchestrates two-phase pipeline: discovers files via `discoverFiles()`, creates `GenerationPlan` with skip counts, resolves AI backend via `resolveBackend()` (exits code 2 on CLI_NOT_FOUND), spawns concurrent `AIService` calls via `CommandRunner.executeGenerate()` (phase-1 `.sum` generation), sequentially aggregates `AGENTS.md` (phase-2 post-order directory merge), writes telemetry to `logs/run-{timestamp}.json`, exits with codes 0 (all success), 1 (partial), 2 (total failure).

**[update.ts](./update.ts)** — `updateCommand()` performs incremental regeneration: `createUpdateOrchestrator().preparePlan()` detects changed files via `content_hash` comparison, executes phase-1 file analysis via `CommandRunner.executeUpdate()` for modified files, sequentially regenerates AGENTS.md for `plan.affectedDirs` (depth-sorted parent directories) injecting existing generated doc via `buildDirectoryPrompt(existingAgentsMd)` for incremental context, calls `cleanupOrphans()` deleting `.sum` for git-deleted files, exits code 0/1/2 based on success/partial/total failure.

**[specify.ts](./specify.ts)** — `specifyCommand()` synthesizes AGENTS.md corpus into 12-section spec: collects docs via `collectAgentsDocs()` + annexes via `collectAnnexFiles()`, auto-generates via `generateCommand()` fallback if `docs.length === 0`, creates `AIService` with 15-minute timeout (`Math.max(config.ai.timeoutMs, 900_000)`), upgrades model to opus (`config.ai.model === 'sonnet' ? 'opus' : config.ai.model`), invokes `aiService.call()` with `buildSpecPrompt()`, writes single/multi-file output via `writeSpec()`, exits code 1 on conflicts without `--force` or CLI_NOT_FOUND.

**[rebuild.ts](./rebuild.ts)** — `rebuildCommand()` reconstructs project from spec: reads `specs/*.md` via `readSpecFiles()`, partitions into `RebuildUnit[]` via `partitionSpec()`, loads `CheckpointManager` for resume logic, executes concurrent `executeRebuild()` with 15-minute timeout, parses module output via delimiter format (`===FILE: path===`/`===END_FILE===`), writes files to `rebuild/` (default) or `--output` path, finalizes telemetry/trace/progress, exits code 0 (success), 1 (partial), 2 (total failure).

**[clean.ts](./clean.ts)** — `cleanCommand()` deletes artifacts: discovers `.sum`/`AGENTS.md`/`CLAUDE.md`/`GENERATION-PLAN.md` via parallel `fg.glob()` calls, marker-filters via `GENERATED_MARKER_PREFIX` check (skips user-authored files), deletes via `unlink()`, restores `.local.md` backups via `rename()`, reports counts with `pc.bold()` numeric highlights, supports `--dry-run` preview mode.

## Command Flow

**Argument Parsing**: `parseArgs(args)` extracts command name, positional args (paths defaulting to `'.'`), boolean flags (`--debug`, `--dry-run`, `--force`, `--fail-fast`, `--trace`, `--show-excluded`, `--uncommitted`, `--multi-file`, `--global`, `--local`), key-value pairs (`--concurrency <n>`, `--model <name>`, `--output <path>`, `--runtime <name>`).

**Zero-Arg Installer**: `args.length === 0 || (!command && hasInstallerFlags())` triggers `runInstaller()` with default options, enabling `npx agents-reverse-engineer --runtime claude -g` shorthand without explicit `install` command.

**Help/Version**: `--help`/`-h` displays `USAGE` string, exits 0; `--version`/`-V` prints `agents-reverse-engineer v${VERSION}`, exits 0.

**Command Dispatch**: Maps command strings to handler functions with parsed options, each resolving project root via `findProjectRoot(path.resolve(targetPath || '.'))`, loading config via `loadConfig(absolutePath, { debug })`, creating `TraceWriter` when `--trace` enabled, writing `ProgressLog` at `.agents-reverse-engineer/progress.log`.

## Shared Behavioral Contracts

### Exit Codes
```javascript
// Success: all tasks succeeded or no tasks to process
0

// Partial failure: some tasks failed but some succeeded
summary.filesProcessed > 0 && summary.filesFailed > 0  // → 1

// Total failure: all tasks failed or CLI not found
summary.filesProcessed === 0 && summary.filesFailed > 0  // → 2
error.code === 'CLI_NOT_FOUND'  // → 2
```

### Default Path Resolution
```javascript
positional[0] || '.'  // All commands default to current directory
```

### Concurrency Parsing
```javascript
values.has('concurrency') ? parseInt(values.get('concurrency')!, 10) : undefined
// Undefined delegates to orchestrator auto-calculation
```

### Model Override Priority
```javascript
effectiveModel = options.model ?? config.ai.model
// CLI --model flag overrides config
```

### Extended Timeout (specify/rebuild)
```javascript
timeoutMs: Math.max(config.ai.timeoutMs, 900_000)
// 15-minute minimum for long spec synthesis/module generation
```

### Opus Upgrade (specify/rebuild)
```javascript
options.model ?? (config.ai.model === 'sonnet' ? 'opus' : config.ai.model)
// Upgrades default sonnet to opus for quality-critical tasks
```

### Installer Flag Detection
```javascript
flags.has('global') || flags.has('local') || flags.has('force') || values.has('runtime')
```

### Version Banner
```javascript
// Suppressed in zero-arg installer mode, shown before all other commands
showVersionBanner()  // prints `agents-reverse-engineer v${VERSION}`
```

### Short Flag Mapping
```javascript
'-h' → 'help'
'-g' → 'global'
'-l' → 'local'
'-V' → 'version'
```

### Subprocess Log Path
```javascript
`.agents-reverse-engineer/subprocess-logs/${new Date().toISOString().replace(/[:.]/g, '-')}`
// When --trace enabled, logs AI subprocess stdout/stderr
```

## Integration Points

Commands import from sibling modules: `../config/loader.js` (`loadConfig`, `findProjectRoot`, `writeDefaultConfig`, `configExists`), `../discovery/run.js` (`discoverFiles`), `../orchestration/orchestrator.js` (`createOrchestrator`, `createUpdateOrchestrator`), `../orchestration/index.js` (`CommandRunner`, `ProgressLog`, `ProgressReporter`, `createTraceWriter`, `cleanupOldTraces`), `../ai/index.js` (`AIService`, `AIServiceError`, `createBackendRegistry`, `resolveBackend`, `getInstallInstructions`), `../generation/executor.js` (`buildExecutionPlan`, `formatExecutionPlanAsMarkdown`), `../generation/prompts/index.js` (`buildDirectoryPrompt`), `../generation/writers/agents-md.js` (`writeAgentsMd`, `GENERATED_MARKER_PREFIX`), `../generation/writers/claude-md.js` (`writeClaudeMdPointer`), `../generation/writers/sum.js` (`writeSumFile`, `readSumFile`), `../generation/collector.js` (`collectAgentsDocs`, `collectAnnexFiles`), `../specify/index.js` (`buildSpecPrompt`, `writeSpec`, `SpecExistsError`), `../rebuild/index.js` (`readSpecFiles`, `partitionSpec`, `CheckpointManager`, `executeRebuild`), `../installer/index.js` (`runInstaller`, `parseInstallerArgs`), `../output/logger.js` (`createLogger`), `../core/logger.js` (`consoleLogger`), `../version.js` (`getVersion`). Uses `fast-glob@3.3.3` for artifact discovery in `clean.ts`, `jsonc-parser@3.3.1` for `.vscode/settings.json` editing in `init.ts`, `picocolors@1.1.1` for colored output across all commands.