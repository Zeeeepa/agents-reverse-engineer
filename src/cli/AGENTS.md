<!-- Generated by agents-reverse-engineer -->

# src/cli/

Command entry points exposing `are` CLI interface: parses flags via `parseArgs()`, routes to init/discover/generate/update/specify/clean via command-specific async handlers, integrates `AIService` subprocess orchestration, `ProgressLog` streaming, `TraceWriter` NDJSON emission, and installer detection for global/local hook registration.

## Contents

### [clean.ts](./clean.ts)
Implements `are clean` command deleting `.sum` files, generated `AGENTS.md` (via `GENERATED_MARKER` filtering), root integration docs (`CLAUDE.md`/`GEMINI.md`/`OPENCODE.md`), and `GENERATION-PLAN.md`. Discovers artifacts via parallel `fast-glob` queries (`**/*.sum`, `**/AGENTS.md`, `**/AGENTS.local.md`), preserves user-authored files, restores `AGENTS.local.md` → `AGENTS.md` via `rename()`. Supports `--dry-run` for deletion preview without filesystem mutations.

### [discover.ts](./discover.ts)
Implements `are discover` command executing file discovery pipeline via `discoverFiles()` with gitignore/vendor/binary/custom filters, writing `GENERATION-PLAN.md` with post-order directory traversal via `buildExecutionPlan()`. Emits `discovery:start/end` trace events with `filesIncluded/filesExcluded/durationMs` metadata, logs included/excluded files to `.agents-reverse-engineer/progress.log` for tail monitoring.

### [generate.ts](./generate.ts)
Implements `are generate` command orchestrating three-phase documentation pipeline: resolves AI backend via `createBackendRegistry()` + `resolveBackend()`, executes `CommandRunner.executeGenerate()` with concurrent file analysis (Phase 1) producing `.sum` files, post-order directory aggregation (Phase 2) generating `AGENTS.md`, sequential root document synthesis (Phase 3) creating `CLAUDE.md`/`GEMINI.md`/`OPENCODE.md`. Supports `--dry-run` for execution plan preview, `--concurrency N` for worker pool override, `--debug` for subprocess heap/RSS metrics, `--trace` for NDJSON event emission. Exit codes: 0 (success), 1 (partial failure), 2 (total failure).

### [index.ts](./index.ts)
CLI router parsing arguments via `parseArgs()` extracting command/flags/values, handling global flags (`--version`, `--help`), detecting installer invocation via `hasInstallerFlags()`, routing to `initCommand`, `discoverCommand`, `generateCommand`, `updateCommand`, `specifyCommand`, `cleanCommand` via switch statement. Maps flags to options: `--dry-run` → `dryRun`, `--concurrency N` → `concurrency`, `--fail-fast` → `failFast`, `--debug` → `debug`, `--trace` → `trace`, `--uncommitted` → `uncommitted`, `--output <path>` → `output`, `--force` → `force`, `--multi-file` → `multiFile`. Displays `USAGE` string via `showHelp()`, prints version via `showVersion()`.

### [init.ts](./init.ts)
Implements `are init` command creating `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig()` from `src/config/loader.ts`. Checks existing config via `configExists()`, warns unless `--force` flag provided, logs customization guidance referencing `exclude.patterns`, `ai.concurrency`, `ai.timeoutMs`, `ai.backend`. Exits with code 1 on permission errors (`EACCES`/`EPERM`), re-throws other errors.

### [specify.ts](./specify.ts)
Implements `are specify` command synthesizing project specifications from `AGENTS.md` corpus via `collectAgentsDocs()`, invoking `AIService.call()` with extended timeout (10-minute minimum via `Math.max(config.ai.timeoutMs, 600_000)`), writing output to `specs/SPEC.md` via `writeSpec()`. Supports `--multi-file` for split specs (`specs/<dirname>.md`), `--dry-run` for token estimation, `--force` for overwrite, auto-generates documentation via `generateCommand()` if `docs.length === 0`. Exits with code 1 on `SpecExistsError`, code 2 on `CLI_NOT_FOUND`.

### [update.ts](./update.ts)
Implements `are update` command executing incremental workflow: calls `createUpdateOrchestrator().preparePlan()` for git-based change detection with SHA-256 hash comparison, regenerates `.sum` via `CommandRunner.executeUpdate()` for `filesToAnalyze: FileChange[]`, regenerates `AGENTS.md` sequentially for `affectedDirs` via `buildDirectoryPrompt()` + `writeAgentsMd()`, cleans orphaned artifacts via `cleanup.deletedSumFiles/deletedAgentsMd`. Emits Phase 1 (`update-phase-1-files`) and Phase 2 (`update-phase-dir-regen`) trace events with `task:pickup/done` per file, `task:start/done` per directory. Supports `--uncommitted` for working tree changes, displays plan via `formatPlan()` with status markers (`+` green added, `R` blue renamed, `M` yellow modified). Exit codes: 0 (success), 1 (partial failure), 2 (total failure).

## Command Lifecycle

All command handlers follow shared execution pattern: resolve `targetPath` to absolute path via `path.resolve()`, load config via `loadConfig(absolutePath, { tracer, debug })`, create `ProgressLog.create(absolutePath)` for streaming `.agents-reverse-engineer/progress.log`, resolve backend via `createBackendRegistry()` + `resolveBackend()`, instantiate `AIService(backend, { timeoutMs, maxRetries, model, telemetry })`, create `CommandRunner` with concurrency/failFast/tracer/progressLog options, finalize telemetry via `aiService.finalize(absolutePath)`, call `progressLog.finalize()` to flush buffered writes.

## Argument Parsing

`parseArgs(args: string[])` in `index.ts` iterates `process.argv.slice(2)`, extracts `--flag` → `flags` Set, `--key value` → `values` Map, expands short flags (`-h` → `help`, `-g` → `global`, `-l` → `local`, `-V` → `version`), captures first non-flag arg as `command`, collects remaining non-flags into `positional[]` array. Returns `{ command, positional, flags, values }` for command-specific option mapping.

## Error Exit Codes

- **0**: All tasks succeeded or no files to process
- **1**: Partial failure (`summary.filesFailed > 0` and `summary.filesProcessed > 0`), `SpecExistsError` without `--force`, permission denied (`EACCES`/`EPERM`)
- **2**: Total failure (`summary.filesProcessed === 0` and `summary.filesFailed > 0`), `AIServiceError.code === 'CLI_NOT_FOUND'` (no backend available)

## Backend Resolution

All commands except `init`, `clean`, `discover` call `createBackendRegistry()` from `../ai/index.js` to detect installed CLI tools (Claude Code, Gemini CLI, OpenCode), resolve via `resolveBackend(registry, config.ai.backend)` with `'auto'` fallback, catch `AIServiceError` with `code: 'CLI_NOT_FOUND'`, display `getInstallInstructions(registry)` with installation commands, exit with code 2.

## Progress Monitoring

Commands write session header to `ProgressLog` with ISO 8601 timestamp, project path, file/directory counts, ETA via moving average of last 10 task durations. Real-time monitoring pattern: `tail -f .agents-reverse-engineer/progress.log`. Finalizes via `progressLog.finalize()` after all phases complete.

## Trace Integration

When `--trace` flag present, calls `createTraceWriter(absolutePath, true)` from `../orchestration/trace.js`, threads `tracer: ITraceWriter` through `loadConfig()`, `discoverFiles()`, `createOrchestrator()`, `CommandRunner`, emits NDJSON events (`phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`) to `.agents-reverse-engineer/traces/trace-<timestamp>.ndjson`, displays trace path via `pc.dim('[trace] Writing to ${tracer.filePath}')`, cleans old traces via `cleanupOldTraces(absolutePath)` after execution (500-trace retention limit).

## Installer Detection

`index.ts` calls `hasInstallerFlags(flags, values)` checking for `global`/`local`/`force` flags or `runtime` value key, enables pattern `npx agents-reverse-engineer --runtime claude -g` without explicit `install` command, delegates to `runInstaller(parseInstallerArgs())` from `../installer/index.js`.