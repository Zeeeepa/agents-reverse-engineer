<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/cli

The `src/cli` directory implements all CLI command entry points for the `agents-reverse-engineer` tool, routing user commands (init, discover, generate, update, specify, rebuild, clean) to their orchestration logic, argument parsing, backend resolution, and telemetry/tracing infrastructure.

## Contents

- [`clean.ts`](./clean.ts): `cleanCommand(targetPath, { dryRun })` deletes ARE-generated artifacts (`.sum`, `.annex.sum`, marker-prefixed `AGENTS.md`/`AGENTS.*.md`/`CLAUDE.md`, `GENERATION-PLAN.md`) via `fast-glob` + `GENERATED_MARKER_PREFIX` validation, restores `.local.md` files by renaming, exits 1 on permission/not-found errors.
- [`discover.ts`](./discover.ts): `discoverCommand(targetPath, { tracer, debug, showExcluded })` invokes `discoverFiles` to identify eligible source files, builds post-order execution plan via `createOrchestrator().createPlan()` + `buildExecutionPlan()`, writes `.agents-reverse-engineer/GENERATION-PLAN.md` via `formatExecutionPlanAsMarkdown`, emits `discovery:start/end` trace events.
- [`generate.ts`](./generate.ts): `generateCommand(targetPath, GenerateOptions)` orchestrates two-phase pipeline (file analysis → directory rollup): discovers files, builds `GenerationPlan` via `createOrchestrator`, resolves AI backend via `resolveBackend`, creates `AIService`, executes via `CommandRunner.executeGenerate`, handles eval mode (`--eval` namespaces output as `*.${backend.model}.sum`), finalizes telemetry/traces, exits 0/1/2 based on failure counts.
- [`index.ts`](./index.ts): `main()` entry point routes commands via `parseArgs(args)` to `initCommand`, `discoverCommand`, `generateCommand`, `updateCommand`, `specifyCommand`, `rebuildCommand`, `cleanCommand`, `runInstaller`/`parseInstallerArgs`; maps short flags (`-h` → `help`, `-g` → `global`, `-l` → `local`, `-V` → `version`), handles `--help`/`--version`, unknown commands via `showUnknownCommand()`, uncaught errors exit 1.
- [`init.ts`](./init.ts): `initCommand(root, { force })` creates `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig`, appends `*.sum` to `.gitignore` under `# agents-reverse-engineer` section via `ensureGitignoreEntry`, adds `files.exclude["**/*.sum"]: true` to `.vscode/settings.json` via `ensureVscodeExclude` using `jsonc-parser` for JSONC-preserving edits, logs customization guidance.
- [`rebuild.ts`](./rebuild.ts): `rebuildCommand(targetPath, RebuildOptions)` reconstructs projects from `specs/` files: reads specs via `readSpecFiles`, partitions via `partitionSpec`, resolves backend via `resolveBackend`, upgrades `"sonnet"` → `"opus"` for model, creates `AIService` with 15min timeout minimum, loads `CheckpointManager` for resume, executes via `executeRebuild`, finalizes telemetry, exits 0/1/2 based on failure counts.
- [`specify.ts`](./specify.ts): `specifyCommand(targetPath, SpecifyOptions)` synthesizes `AGENTS.md` files into `specs/SPEC.md` (or multi-file): collects docs via `collectAgentsDocs`/`collectAnnexFiles`, auto-generates if missing via `generateCommand`, resolves backend, upgrades `"sonnet"` → `"opus"` for specify, builds prompt via `buildSpecPrompt`, calls `aiService.call`, writes output via `writeSpec`, handles `SpecExistsError`, exits 1/2 on conflicts/CLI-not-found.
- [`update.ts`](./update.ts): `updateCommand(targetPath, UpdateOptions)` incrementally regenerates docs for git-detected changes: creates `UpdatePlan` via `createUpdateOrchestrator`, resolves backend/model, creates `AIService`, runs `CommandRunner.executeUpdate` for file analysis phase, regenerates `AGENTS.md` for `plan.affectedDirs` via `buildDirectoryPrompt` + `writeAgentsMd`/`writeAgentsMdHub`, records run state via `orchestrator.recordRun`, supports eval mode, exits 0/1/2 based on failure counts.

## Architecture

Commands follow a common orchestration pattern: (1) resolve `targetPath` to project root via `findProjectRoot`, (2) load config via `loadConfig`, (3) create domain-specific orchestrator (`createOrchestrator`/`createUpdateOrchestrator`) or plan builder (`readSpecFiles` + `partitionSpec` for rebuild, `collectAgentsDocs`/`buildSpecPrompt` for specify), (4) resolve AI backend via `resolveBackend(createBackendRegistry(), backendName)` from CLI flags or config, (5) provision backend resources via `backend.ensureProjectConfig?.(absolutePath)`, (6) create `AIService` with timeout/retries/model/telemetry from config, (7) execute via `CommandRunner` or direct `aiService.call`, (8) finalize telemetry via `aiService.finalize`, (9) cleanup traces via `cleanupOldTraces`, (10) exit with status code (0 = success, 1 = partial failure, 2 = total failure or CLI not found).

## Backend Resolution & Error Handling

All AI-dependent commands (`generate`, `update`, `specify`, `rebuild`) follow the same backend resolution flow: `resolveBackend(createBackendRegistry(), options.backend ?? config.ai.backend)` throws `AIServiceError` with `code: 'CLI_NOT_FOUND'` if no CLI binary is available; commands catch this error, call `getInstallInstructions(registry)` to print install guidance, and exit with code 2. Model resolution applies command-specific overrides: `specify` and `rebuild` upgrade `config.ai.model === 'sonnet'` to `'opus'` for better synthesis quality; `options.model` CLI flag takes highest precedence.

## Telemetry & Tracing

Commands use `createTraceWriter(absolutePath, options.trace)` for optional NDJSON event logging to `.agents-reverse-engineer/traces/<ISO-timestamp>.ndjson`; `ProgressLog.create(absolutePath)` writes incremental progress to `.agents-reverse-engineer/progress.log` for `tail -f` monitoring; `aiService.setSubprocessLogDir(logDir)` enables subprocess stderr capture to `.agents-reverse-engineer/subprocess-logs/<ISO-timestamp>/` when `options.trace` is enabled; `aiService.finalize(absolutePath)` writes run telemetry summary; `cleanupOldTraces(absolutePath)` prunes stale trace files based on `config.ai.telemetry.keepRuns`.

## Eval Mode

`generate` and `update` support `--eval` flag: computes `variant = "${backend.name}.${effectiveModel}"` (e.g., `"claude.sonnet"`, `"opencode.opus"`), namespaces output files as `*.${variant}.sum`, `AGENTS.${variant}.md` to enable A/B testing of different AI backends/models without overwriting each other's outputs; variant is computed twice (preliminary variant from config defaults for plan creation, final variant after backend/model resolution for execution).

## Exit Codes

All commands follow exit code convention: 0 = full success or no-op, 1 = partial failure (some tasks succeeded but at least one failed), 2 = total failure (no tasks succeeded) or critical error (CLI not found, permission denied, spec conflict without `--force`).

## File Relationships

`index.ts` imports all command modules and delegates to their exported functions; `generate.ts`/`update.ts`/`specify.ts`/`rebuild.ts` share backend resolution logic via `resolveBackend(createBackendRegistry(), ...)`, `AIService` creation, telemetry/trace finalization via `aiService.finalize`/`cleanupOldTraces`; `specify.ts` calls `generateCommand` if no `AGENTS.md` files exist; `clean.ts` uses `GENERATED_MARKER_PREFIX` from `../generation/writers/agents-md.js` to validate marker-prefixed files before deletion.

## Behavioral Contracts

- Gitignore section header: `# agents-reverse-engineer`
- Gitignore pattern: `*.sum`
- VSCode exclude key: `files.exclude["**/*.sum"]`
- Config path: `.agents-reverse-engineer/config.yaml`
- Generation plan path: `.agents-reverse-engineer/GENERATION-PLAN.md`
- Progress log path: `.agents-reverse-engineer/progress.log`
- Trace log path: `.agents-reverse-engineer/traces/<ISO-timestamp>.ndjson`
- Subprocess log dir: `.agents-reverse-engineer/subprocess-logs/<ISO-timestamp>/`
- Default specify/rebuild model upgrade: `config.ai.model === 'sonnet'` → `'opus'`
- Minimum timeout for specify/rebuild: `Math.max(config.ai.timeoutMs, 900_000)` (15 minutes)
- Token estimate formula: `Math.ceil(totalChars / 4) / 1000` (chars → tokens → K tokens)
- Eval variant format: `${backend.name}.${effectiveModel}` (e.g., `claude.sonnet`)
- Eval output suffix: `*.${variant}.sum`, `AGENTS.${variant}.md`
- Short flag mappings: `-h` → `help`, `-g` → `global`, `-l` → `local`, `-V` → `version`
- Default path for all commands: `'.'`
- Exit codes: 0 (success/no-op), 1 (partial failure), 2 (total failure/CLI not found/permission denied)

## Workflow & Conventions

Commands prioritize CLI flags over config values for `backend`, `model`, `concurrency`; `dryRun` mode prints plan summary without executing AI calls or writes; `force` flag bypasses conflict checks (`init` overwrites existing config, `specify`/`rebuild` overwrite existing specs/output); `debug` flag logs prompts, backend details, subprocess stderr; `trace` flag enables NDJSON event logging + subprocess log capture; `failFast` flag halts execution on first error (default: continue processing); `uncommitted` flag (update only) includes staged/working directory changes in addition to committed changes since last run.