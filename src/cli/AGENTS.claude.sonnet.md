<!-- Generated by agents-reverse-engineer v1.1.0 -->

# cli

Command-line entry point dispatching user arguments to eight core workflows: interactive installer, config initialization, file discovery, AI-driven documentation generation, incremental git-based updates, specification synthesis, project reconstruction, artifact cleanup, and telemetry dashboard.

## Contents

### Commands

- [`clean.ts`](./clean.ts): Implements `/are-clean` command via `cleanCommand(targetPath, options)`. Discovers artifacts (`**/*.sum`, `**/AGENTS.md`, `**/AGENTS.*.md`, `**/CLAUDE.md`) via `fast-glob`, filters by `GENERATED_MARKER_PREFIX` sentinel to preserve user-authored files, deletes generated docs, restores `.local.md` overrides to canonical names via `fs.rename`.
- [`discover.ts`](./discover.ts): Implements `/are-discover` command via `discoverCommand(targetPath, options)`. Invokes `discoverFiles` from `discovery/run.ts` to execute filter chain (gitignore→vendor→binary→custom), writes `GENERATION-PLAN.md` to `.agents-reverse-engineer/` via `buildExecutionPlan` + `formatExecutionPlanAsMarkdown`, logs included/excluded files to `progress.log`.
- [`generate.ts`](./generate.ts): Implements `/are-generate` command via `generateCommand(targetPath, options)`. Orchestrates two-phase pipeline: Phase 1 executes `CommandRunner.executeGenerate` for concurrent file analysis (prompts built via `buildFilePrompt`, outputs written via `sum.ts`), Phase 2 performs post-order directory traversal calling `buildDirectoryPrompt` and `writeAgentsMd`. Resolves backend via `resolveBackend`, spawns `AIService` with timeout/retry config, writes telemetry to `.agents-reverse-engineer/logs/`, traces to `.agents-reverse-engineer/traces/`. Exits code 0 (success), 1 (partial failure), 2 (total failure or CLI not found).
- [`index.ts`](./index.ts): Hashbang entry point parsing CLI args via `parseArgs(args)` (extracts command, positional args, flags set, values map). Routes to `initCommand`, `discoverCommand`, `generateCommand`, `updateCommand`, `specifyCommand`, `rebuildCommand`, `cleanCommand`, `dashboardCommand`, `runInstaller`. Detects installer invocation via `hasInstallerFlags` (checks `--global`, `--local`, `--force`, `--runtime`). Displays version via `getVersion`, help via `USAGE` constant. Defaults path to `'.'` for all commands.
- [`init.ts`](./init.ts): Implements `/are-init` command via `initCommand(root, options)`. Writes default config to `.agents-reverse-engineer/config.yaml` via `writeDefaultConfig`, appends `*.sum` to `.gitignore` under `# agents-reverse-engineer` section (idempotent via `ensureGitignoreEntry`), sets `files.exclude["**/*.sum"] = true` in `.vscode/settings.json` via `jsonc-parser` (preserves comments via `modify`/`applyEdits`).
- [`rebuild.ts`](./rebuild.ts): Implements `/are-rebuild` command via `rebuildCommand(targetPath, options)`. Reads spec files via `readSpecFiles`, partitions into rebuild units via `partitionSpec`, loads checkpoint via `CheckpointManager.load`, executes via `executeRebuild` with dependency-ordered module execution, writes files via `output-parser.ts` delimiter parsing (`===FILE: path===` ... `===END_FILE===`). Defaults model to `"opus"`, upgrades from `"sonnet"`, enforces 15min minimum timeout via `Math.max(config.ai.timeoutMs, 900_000)`. Exits 2 (all failed), 1 (partial), 0 (success).
- [`specify.ts`](./specify.ts): Implements `/are-specify` command via `specifyCommand(targetPath, options)`. Collects docs via `collectAgentsDocs`/`collectAnnexFiles`, builds prompt via `buildSpecPrompt`, invokes AI backend with extended timeout, writes output via `writeSpec` (single `specs/SPEC.md` or multi-file split). Checks conflicts (existing `.md` in `outputDir` for multiFile mode), auto-generates missing `AGENTS.md` via `generateCommand` if `docs.length === 0`, upgrades model from `"sonnet"` to `"opus"`. Dry-run estimates tokens (`totalChars / 4 / 1000`), warns if >150K.
- [`update.ts`](./update.ts): Implements `/are-update` command via `updateCommand(targetPath, options)`. Creates `UpdateOrchestrator`, computes `UpdatePlan` via `preparePlan` (git diff + content-hash comparison against `.sum` frontmatter, cleanup tasks for orphaned artifacts, affected directories via `getAffectedDirectories`). Executes Phase 1 (file analysis via `CommandRunner.executeUpdate`), Phase 2 (directory regeneration: reads existing `AGENTS.md` for incremental context if `GENERATED_MARKER_PREFIX` present, calls `buildDirectoryPrompt` with `existingAgentsMd`, writes via `writeAgentsMd`). Exits 0 (success), 1 (partial if `filesFailed > 0`), 2 (total failure or CLI not found).

## Option Types

**`GenerateOptions`** (from `generate.ts`): `force` (skip existing `.sum`), `dryRun` (show plan without AI), `concurrency` (override pool size), `failFast` (abort on first failure), `debug` (log prompts/backend), `trace` (enable NDJSON traces), `model` (override AI model), `backend` (override AI backend: `claude|codex|opencode|gemini`), `eval` (namespace output by `backend.model`).

**`UpdateOptions`** (from `update.ts`): extends `GenerateOptions` with `uncommitted` (include staged/working changes).

**`CleanOptions`** (from `clean.ts`): `dryRun` (preview without deletion).

**`SpecifyOptions`** (from `specify.ts`): `output` (default `specs/SPEC.md`), `force` (overwrite), `dryRun` (skip AI), `multiFile` (split output), `debug`, `trace`, `model` (default `opus`), `backend`.

**`RebuildOptions`** (from `rebuild.ts`): `output` (default `rebuild/`), `force` (wipe output dir), `dryRun`, `concurrency`, `failFast`, `debug`, `trace`, `model` (default `opus`), `backend`.

**`DashboardOptions`** (from `index.ts`): `run` (filter by run ID), `trace` (filter by trace ID), `format` (`html|json|text`), `trends` (show cost trends).

## Workflow

**Installation Detection**: `index.ts:main()` invokes `runInstaller(parseInstallerArgs(args))` if no command provided or `hasInstallerFlags` returns true (detects `--global`, `--local`, `--force`, `--runtime`). Installer writes command templates to `.claude/`, `.agents/`, `.opencode/`, `.gemini/`, registers hooks (`are-check-update.js`, `are-context-loader.js`), updates settings.json permissions.

**Generation Pipeline**: `/are-init` creates config → `/are-discover` scans files, writes plan → `/are-generate` runs Phase 1 (concurrent file analysis via `CommandRunner` + worker pool) + Phase 2 (post-order directory synthesis) → artifacts written to `.sum`/`AGENTS.md`, telemetry logged to `.agents-reverse-engineer/logs/`, traces to `.agents-reverse-engineer/traces/`.

**Incremental Updates**: `/are-update` computes git diff via `UpdateOrchestrator.preparePlan`, filters via content-hash comparison, regenerates `.sum` for changed files (Phase 1), rebuilds `AGENTS.md` for affected directories with incremental context from existing docs (Phase 2), cleans orphaned artifacts.

**Specification Workflow**: `/are-specify` collects `AGENTS.md` + annex files, builds 12-section synthesis prompt via `buildSpecPrompt`, invokes AI backend with 15min timeout, writes `specs/SPEC.md` (single file) or multi-file tree via `writeSpec`.

**Rebuild Workflow**: `/are-rebuild` reads `specs/*.md`, partitions into dependency-ordered units, loads checkpoint, executes modules sequentially with context injection from prior groups, parses LLM output via delimiter format, writes files, updates checkpoint per module.

**Artifact Cleanup**: `/are-clean` discovers via six parallel globs (`**/*.sum`, `**/AGENTS.md`, `**/AGENTS.*.md`, `**/AGENTS.local.md`, `**/CLAUDE.md`, `**/CLAUDE.local.md`), filters by `GENERATED_MARKER_PREFIX` sentinel, deletes generated files, renames `.local.md` → canonical via `fs.rename`.

## Path Resolution

All commands resolve `targetPath` via `findProjectRoot(targetPath)` from `config/loader.ts` (walks upward to git root or first `.agents-reverse-engineer/` dir). Default path: `'.'` (current directory).

## Backend Resolution

`generate.ts`, `update.ts`, `specify.ts`, `rebuild.ts` resolve backend via:
1. Create registry via `createBackendRegistry()` (auto-detects CLIs via `which` lookup: Claude→Codex→Gemini→OpenCode priority).
2. Resolve via `resolveBackend(registry, options.backend ?? config.ai.backend)`.
3. Call `backend.ensureProjectConfig?.(absolutePath)` for OpenCode agent provisioning.
4. Compute `effectiveModel = options.model ?? config.ai.model`.
5. Upgrade model: `specify.ts` and `rebuild.ts` default to `"opus"`, upgrade from `"sonnet"` via `effectiveModel = options.model ?? (config.ai.model === 'sonnet' ? 'opus' : config.ai.model)`.
6. Spawn `AIService(backend, { timeoutMs, maxRetries, model: effectiveModel, ... })`.

## Eval Mode

When `options.eval` is true:
- Variant computed as `${backend.name}.${effectiveModel}` (e.g., `claude.opus`).
- Outputs namespaced: `*.sum` → `*.${variant}.sum`, `AGENTS.md` → `AGENTS.${variant}.md`.
- Logged via `[eval] Variant: ...`, `[eval] Output files: ...`.

## Behavioral Contracts

**Exit Codes**:
- `0`: Success or no-op (no changes, dry-run, all files succeeded).
- `1`: Partial failure (some files failed, conflicts without `--force`).
- `2`: Total failure (all files failed, CLI not found).

**Default Paths**:
- Config: `.agents-reverse-engineer/config.yaml`.
- Progress log: `.agents-reverse-engineer/progress.log`.
- Traces: `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson`.
- Telemetry: `.agents-reverse-engineer/logs/run-{command}-{backend}-{model}-{timestamp}.json`.
- Subprocess logs: `.agents-reverse-engineer/subprocess-logs/{ISO8601}/`.
- Specify output: `specs/SPEC.md`.
- Rebuild output: `rebuild/`.

**Timeout Overrides**:
- `specify.ts`: `Math.max(config.ai.timeoutMs, 900_000)` (15min minimum).
- `rebuild.ts`: `Math.max(config.ai.timeoutMs, 900_000)` (15min minimum).

**Model Upgrades**:
- `specify.ts`: `effectiveModel = options.model ?? (config.ai.model === 'sonnet' ? 'opus' : config.ai.model)`.
- `rebuild.ts`: `effectiveModel = options.model ?? (config.ai.model === 'sonnet' ? 'opus' : config.ai.model)`.

**Sentinel Markers**:
- `GENERATED_MARKER_PREFIX` (from `generation/writers/agents-md.ts`) marks AI-generated `AGENTS.md`/`CLAUDE.md` files. `clean.ts` uses `content.includes(GENERATED_MARKER_PREFIX)` to filter artifacts. `update.ts` uses same check to detect generated docs for incremental context injection.

**Trace Events** (from `update.ts`, `generate.ts`):
- `phase:start` — `{ phase, taskCount, concurrency }`.
- `task:start` — `{ taskLabel, phase }`.
- `task:done` — `{ workerId, taskIndex, taskLabel, durationMs, success, error?, activeTasks }`.
- `phase:end` — `{ phase, durationMs, tasksCompleted, tasksFailed }`.

**Argument Parsing** (from `index.ts:parseArgs`):
- Short flags: `-h` (help), `-g` (global), `-l` (local), `-V` (version).
- Long flags with values: `--model sonnet` → `values.get('model') === 'sonnet'`.
- Boolean flags: `--dry-run` → `flags.has('dry-run')`.
- Command extraction: first non-flag arg.
- Positional args: subsequent non-flag args.

**VSCode Integration** (from `init.ts`):
- Path: `.vscode/settings.json`.
- Exclusion key: `["files.exclude", "**/*.sum"]`.
- Value: `true`.
- Formatting: `{ tabSize: 1, insertSpaces: false }`.

**Gitignore Integration** (from `init.ts`):
- Section marker: `# agents-reverse-engineer`.
- Pattern: `*.sum`.
- Idempotency: checks `lines.some(l => l.trim() === '*.sum')` before insertion.

**Conflict Detection** (from `specify.ts`):
- Single-file mode: checks `fs.access(outputPath)`, exits 1 if exists without `--force`.
- Multi-file mode: reads `outputDir`, exits 1 if any `.md` file exists without `--force`.

**Dry-Run Behavior**:
- `discover.ts`: shows plan summary, no file writes.
- `generate.ts`: shows plan summary, skips AI calls.
- `update.ts`: shows plan summary, skips AI calls.
- `specify.ts`: shows doc count, token estimate, skips AI call.
- `rebuild.ts`: shows spec count, unit count, checkpoint status, skips AI calls.
- `clean.ts`: shows deletion lists, no file operations.