---
generated_at: 2026-02-09T21:28:42.085Z
content_hash: 79c56b266e6a9cedc43be6fe15516e276874c36636d49eae53f0a6b6db41a2ca
purpose: Command entry point for `are discover` — walks directory tree with gitignore/vendor/binary/custom filters, writes dis...
---
**Command entry point for `are discover` — walks directory tree with gitignore/vendor/binary/custom filters, writes discovered file list to console and `.agents-reverse-engineer/GENERATION-PLAN.md` with three-phase execution plan.**

## Exported Interface

**discoverCommand(targetPath: string, options: DiscoverOptions): Promise<void>**
Resolves `targetPath` to absolute path (defaults to `process.cwd()`), loads config via `loadConfig()`, verifies path accessibility with `access(R_OK)`, runs `discoverFiles()` discovery pipeline, emits trace events (`discovery:start/end` with `filesIncluded`, `filesExcluded`, `durationMs`), logs included/excluded files to console via `createLogger()` and `ProgressLog.create()`, creates `GenerationPlan` via `createOrchestrator().createPlan()`, builds `ExecutionPlan` via `buildExecutionPlan()` with post-order traversal, formats as markdown via `formatExecutionPlanAsMarkdown()`, writes to `.agents-reverse-engineer/GENERATION-PLAN.md`, exits with code 1 on `ENOENT`/`EACCES`/`EPERM` errors or plan write failure.

**DiscoverOptions**
Interface with `tracer?: ITraceWriter` for trace emission, `debug?: boolean` for verbose output (defaults false).

## Trace Events

Emits `discovery:start` with `targetPath` at start, `discovery:end` with `filesIncluded`, `filesExcluded`, `durationMs` computed via `process.hrtime.bigint()` delta at completion.

## Progress Logging

Creates `ProgressLog` instance via `ProgressLog.create(resolvedPath)`, writes header `=== ARE Discover (${new Date().toISOString()}) ===`, logs each included file as `+ ${relativePath}`, each excluded file as `- ${relativePath} (${reason}: ${filter})`, summary `Discovered ${count} files (${excluded} excluded)`, plan creation status, finalizes with `await progressLog.finalize()`.

## Output Format

Console output via `createLogger()`:
- `logger.file(relativePath)` for included files
- `logger.excluded(relativePath, reason, filter)` for excluded files with reason/filter context
- `logger.summary(includedCount, excludedCount)` for aggregate counts
- `logger.info()` for status messages
- `logger.error()` for fatal errors before `process.exit(1)`

Debug output via `pc.dim()` when `options.debug` is true, writes `[debug] Discovering files in: ${path}` at start, `[debug] Discovery complete: ${included} included, ${excluded} excluded` at end.

## Plan Generation Flow

Constructs `DiscoveryResult` object with `files: result.included`, `excluded: result.excluded.map(e => ({ path, reason }))`, passes to `createOrchestrator(config, resolvedPath).createPlan()` yielding `GenerationPlan`, transforms via `buildExecutionPlan(generationPlan, resolvedPath)` to `ExecutionPlan`, formats via `formatExecutionPlanAsMarkdown()`, writes to `path.join(resolvedPath, '.agents-reverse-engineer', 'GENERATION-PLAN.md')` after `mkdir(configDir, { recursive: true })`.

## Error Handling

Catches `access()` errors: `ENOENT` → `logger.error('Directory not found')` + exit 1, `EACCES`/`EPERM` → `logger.error('Permission denied')` + exit 1, re-throws other errors. Catches plan write errors: logs `Failed to write plan: ${msg}`, writes to progress log, finalizes, exits with code 1.

## Dependencies

Imports `loadConfig` from `../config/loader.js`, `discoverFiles` from `../discovery/run.js`, `createLogger` from `../output/logger.js`, `createOrchestrator` from `../generation/orchestrator.js`, `buildExecutionPlan`, `formatExecutionPlanAsMarkdown` from `../generation/executor.js`, `ProgressLog` from `../orchestration/index.js`, `DiscoveryResult` type from `../types/index.js`, `ITraceWriter` type from `../orchestration/trace.js`, `picocolors` as `pc`.