---
generated_at: 2026-02-09T14:08:55.996Z
content_hash: 79c56b266e6a9cedc43be6fe15516e276874c36636d49eae53f0a6b6db41a2ca
purpose: discover.ts implements the `are discover` command, scanning directories with filter chains (gitignore, vendor, binary...
---
**discover.ts implements the `are discover` command, scanning directories with filter chains (gitignore, vendor, binary, custom) to identify analyzable files and generating GENERATION-PLAN.md with post-order directory traversal execution strategy.**

## Exported Interface

**discoverCommand(targetPath: string, options: DiscoverOptions): Promise<void>**
- Resolves targetPath to absolute path via `path.resolve()` defaulting to `process.cwd()`
- Loads configuration via `loadConfig(resolvedPath)` applying defaults if absent
- Verifies directory accessibility with `fs.access(resolvedPath, constants.R_OK)`, exits on ENOENT/EACCES/EPERM
- Creates `ProgressLog` instance via `ProgressLog.create(resolvedPath)` for real-time monitoring
- Emits `discovery:start` trace event with targetPath before scanning
- Executes `discoverFiles(resolvedPath, config, {tracer, debug})` applying filter pipeline
- Emits `discovery:end` trace event with filesIncluded/filesExcluded counts and durationMs (nanosecond hrtime converted to milliseconds)
- Logs included files via `logger.file(relativePath)` and excluded files via `logger.excluded(relativePath, reason, filter)`
- Creates `DiscoveryResult` object mapping included/excluded arrays for orchestrator consumption
- Invokes `createOrchestrator(config, resolvedPath).createPlan(discoveryResult)` returning GenerationPlan
- Calls `buildExecutionPlan(generationPlan, resolvedPath)` to compute post-order directory traversal
- Formats plan via `formatExecutionPlanAsMarkdown(executionPlan)` and writes to `.agents-reverse-engineer/GENERATION-PLAN.md`
- Exits with code 1 on plan write failure after finalizing progress log

**DiscoverOptions**
- `tracer?: ITraceWriter` — Optional trace event emitter for discovery lifecycle
- `debug?: boolean` — Enables verbose stderr output with picocolors dim formatting (default false)

## Dependencies

**Core Node.js APIs:**
- `node:path` — Absolute path resolution, relative path formatting for cleaner output
- `node:fs/promises` — `access()` for read permission verification, `mkdir({recursive:true})` for config directory creation, `writeFile()` for plan output
- `node:fs` — `constants.R_OK` flag for access check

**External Libraries:**
- `picocolors` — Terminal color formatting for debug messages via `pc.dim()`

**Internal Modules:**
- `../config/loader.js` — `loadConfig()` returns validated Config schema with defaults merged
- `../discovery/run.js` — `discoverFiles()` orchestrates walker + filter chain
- `../output/logger.js` — `createLogger()` returns ILogger with file/excluded/summary/info/error methods
- `../generation/orchestrator.js` — `createOrchestrator()` returns IOrchestrator with createPlan method
- `../generation/executor.js` — `buildExecutionPlan()` computes post-order directory traversal, `formatExecutionPlanAsMarkdown()` renders phase breakdown
- `../orchestration/index.js` — `ProgressLog` class with create/write/finalize methods for `.agents-reverse-engineer/progress.log` streaming
- `../types/index.js` — `DiscoveryResult` interface with `files: string[]` and `excluded: {path, reason}[]`
- `../orchestration/trace.js` — `ITraceWriter` interface for event emission

## Trace Events

**discovery:start**
- Fields: `type: 'discovery:start'`, `targetPath: string`
- Emitted before `discoverFiles()` invocation with `process.hrtime.bigint()` timestamp capture

**discovery:end**
- Fields: `type: 'discovery:end'`, `filesIncluded: number`, `filesExcluded: number`, `durationMs: number`
- Emitted after `discoverFiles()` completion with duration computed via bigint subtraction divided by 1_000_000

## Error Handling

**Directory Access:**
- ENOENT → logs `Directory not found: ${resolvedPath}` and exits with code 1
- EACCES/EPERM → logs `Permission denied: ${resolvedPath}` and exits with code 1
- Other errors → re-thrown to caller

**Plan Write Failure:**
- Catches writeFile errors, logs `Failed to write plan: ${message}`, writes to progress log, finalizes log, exits with code 1

## Output Destinations

**Console (via logger):**
- `logger.info()` — Discovery start message, plan generation message
- `logger.file()` — Each included file relative path
- `logger.excluded()` — Each excluded file with reason and filter name
- `logger.summary()` — Aggregated counts for included/excluded files
- `logger.error()` — Access failures and plan write errors

**Progress Log (`.agents-reverse-engineer/progress.log`):**
- Session header with ISO 8601 timestamp and project path
- Real-time included/excluded file listing with +/- prefixes
- Summary line with total counts
- Plan creation confirmation or error message
- Finalized via `progressLog.finalize()` before command exit

**GENERATION-PLAN.md (`.agents-reverse-engineer/GENERATION-PLAN.md`):**
- Created via `mkdir(configDir, {recursive:true})` ensuring parent directory exists
- Contains markdown-formatted execution plan with phase breakdown (Phase 1: file analysis, Phase 2: directory aggregation, Phase 3: root synthesis)
- Written with UTF-8 encoding via `writeFile(planPath, markdown, 'utf8')`

## Orchestration Integration

**GenerationPlan Creation:**
- `createOrchestrator(config, resolvedPath)` returns orchestrator instance with backend selection and concurrency configuration
- `orchestrator.createPlan(discoveryResult)` analyzes file tree, identifies directories, assigns tasks to phases
- Returns GenerationPlan with sourceFiles[], agentsMdDirs[], rootDocs[] arrays

**ExecutionPlan Computation:**
- `buildExecutionPlan(generationPlan, resolvedPath)` sorts directories by depth descending via `path.relative().split(path.sep).length`
- Implements post-order traversal ensuring child directories processed before parents
- Returns ExecutionPlan with phase1Tasks[], phase2Tasks[], phase3Tasks[] arrays containing file paths and directory metadata

**Markdown Formatting:**
- `formatExecutionPlanAsMarkdown(executionPlan)` generates three-section document with task counts, file listings, directory hierarchy
- Includes project statistics: total files to analyze, directories to document, root synthesis targets