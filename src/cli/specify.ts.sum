---
generated_at: 2026-02-09T15:06:52.134Z
content_hash: 6fdb25334ecd939dd02edcd5c18dee77450cfb0834cbe23ea6d4f2ebb01fc696
purpose: specifyCommand orchestrates project specification synthesis by collecting AGENTS.md documentation, invoking AI backen...
---
**specifyCommand orchestrates project specification synthesis by collecting AGENTS.md documentation, invoking AI backend with extended timeout, and writing single or multi-file output to specs/ directory.**

## Exported Interface

```typescript
interface SpecifyOptions {
  output?: string;        // Custom output path (default: specs/SPEC.md)
  force?: boolean;        // Overwrite existing specs
  dryRun?: boolean;       // Show plan without calling AI
  multiFile?: boolean;    // Split output into multiple files
  debug?: boolean;        // Show verbose debug info
  trace?: boolean;        // Enable tracing
}

async function specifyCommand(
  targetPath: string,
  options: SpecifyOptions
): Promise<void>
```

## Execution Flow

specifyCommand resolves `targetPath` to absolute path, computes default `outputPath` as `specs/SPEC.md`, calls `loadConfig()` for configuration, then `collectAgentsDocs()` to gather documentation.

### Dry-Run Mode

When `options.dryRun` is true, calculates `totalChars` across `docs[]`, estimates tokens via division by 4, displays summary without AI calls, warns if `docs.length === 0` (suggesting `are generate` first) or `estimatedTokensK > 150` (context window warning), then returns early.

### Auto-Generation Fallback

If `docs.length === 0` and not dry-run, calls `generateCommand(targetPath, { debug, trace })` to populate AGENTS.md files, re-collects via `collectAgentsDocs()`, exits with code 1 if still empty.

## Backend Resolution

Creates `BackendRegistry` via `createBackendRegistry()`, resolves backend via `resolveBackend(registry, config.ai.backend)`, catches `AIServiceError` with `code === 'CLI_NOT_FOUND'`, displays `getInstallInstructions(registry)` and exits with code 2.

Logs backend metadata in debug mode: `backend.name`, `backend.cliCommand`, `config.ai.model`.

## AI Service Configuration

Instantiates `AIService(backend, options)` with extended timeout via `Math.max(config.ai.timeoutMs, 600_000)` (10 minute minimum for large specification generation), passes `maxRetries`, `model`, and `telemetry.keepRuns` from config.

Enables debug mode via `aiService.setDebug(true)` if `options.debug` is true.

## Prompt Construction and Execution

Builds prompt via `buildSpecPrompt(docs)` returning object with `system` and `user` properties. Logs character counts in debug mode.

Creates `ProgressLog` at `absolutePath`, writes header with ISO timestamp, project path, and `docs.length` count, then calls `aiService.call({ prompt, systemPrompt, taskLabel: 'specify' })`.

## Output Writing

Calls `writeSpec(response.text, { outputPath, force, multiFile })` which returns `writtenFiles[]`. Catches `SpecExistsError`, logs to `progressLog`, displays error message via `pc.red()`, and exits with code 1.

Iterates `writtenFiles` to log each path via `pc.green()` and write to `progressLog`.

## Telemetry Finalization

Calls `aiService.finalize(absolutePath)` to retrieve `summary` containing `totalInputTokens`, `totalOutputTokens`, `totalDurationMs`. Constructs summary line with token counts, duration in seconds (1 decimal), and output path. Writes to console via `pc.dim()` and `progressLog`, finalizes log via `progressLog.finalize()`.

## Dependencies

Imports `loadConfig` from `../config/loader.js`, `collectAgentsDocs` from `../generation/collector.js`, `buildSpecPrompt`/`writeSpec`/`SpecExistsError` from `../specify/index.js`, `AIService`/`AIServiceError`/`createBackendRegistry`/`resolveBackend`/`getInstallInstructions` from `../ai/index.js`, `ProgressLog` from `../orchestration/index.js`, `generateCommand` from `./generate.js`, uses `picocolors` (aliased as `pc`) for terminal formatting, `node:path` for file resolution.

## Error Handling

Exits with code 1 for `SpecExistsError` (file exists without `--force` flag) and post-generation empty docs. Exits with code 2 for `CLI_NOT_FOUND` (no AI backend available). Displays installation instructions via `getInstallInstructions()` when backend resolution fails.