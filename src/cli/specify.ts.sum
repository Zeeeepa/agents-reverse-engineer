---
generated_at: 2026-02-09T17:44:57.443Z
content_hash: a551ee6493032b07070c3250040b701a722af8fa540dd96f2e6ceadaa92b19f7
purpose: specify.ts implements the `are specify` CLI command that synthesizes project specifications from AGENTS.md documentat...
---
**specify.ts implements the `are specify` CLI command that synthesizes project specifications from AGENTS.md documentation via AI backend calls with auto-generation fallback, dry-run preview, and single/multi-file output modes.**

## Exported Interface

**specifyCommand(targetPath: string, options: SpecifyOptions): Promise<void>** — Main entry point that orchestrates specification generation by loading config, collecting AGENTS.md/annex files, optionally auto-generating missing docs, building synthesis prompt, resolving AI backend, invoking AI service with extended timeout (600s minimum), writing output via `writeSpec()`, and finalizing telemetry.

**SpecifyOptions** — Configuration interface with fields:
- `output?: string` — Custom output path (default: `specs/SPEC.md`)
- `force?: boolean` — Overwrite existing specs
- `dryRun?: boolean` — Show statistics without AI calls
- `multiFile?: boolean` — Split output into multiple files
- `debug?: boolean` — Enable verbose logging
- `trace?: boolean` — Enable trace emission

## Command Workflow

### Phase 1: Collection and Validation
Calls `collectAgentsDocs(absolutePath)` and `collectAnnexFiles(absolutePath)` to gather input corpus. If `docs.length === 0` and not `dryRun`, invokes `generateCommand(targetPath, {debug, trace})` to auto-generate AGENTS.md files. Exits with code 1 if docs still empty after generation.

### Phase 2: Dry-Run Mode
When `options.dryRun === true`, computes `totalChars` from `docs` and `annexFiles` content lengths, estimates tokens via `Math.ceil(totalChars / 4) / 1000`, prints summary showing AGENTS.md count, annex count, token estimate, output path, and mode (single/multi-file). Warns if no docs found or if `estimatedTokensK > 150`. Returns without AI calls.

### Phase 3: Backend Resolution
Creates `BackendRegistry` via `createBackendRegistry()`, resolves backend via `resolveBackend(registry, config.ai.backend)`. Catches `AIServiceError` with `code === 'CLI_NOT_FOUND'`, prints `getInstallInstructions(registry)`, exits with code 2. Logs backend name, `cliCommand`, model if `debug === true`.

### Phase 4: AI Synthesis
Instantiates `AIService` with extended timeout `Math.max(config.ai.timeoutMs, 600_000)` (minimum 10 minutes). Calls `buildSpecPrompt(docs, annexFiles.length > 0 ? annexFiles : undefined)` to construct system/user prompt pair. Creates `ProgressLog` via `ProgressLog.create(absolutePath)`, writes header with ISO timestamp, project path, doc counts. Invokes `aiService.call({prompt: prompt.user, systemPrompt: prompt.system, taskLabel: 'specify'})` and awaits response.

### Phase 5: Output Writing
Calls `writeSpec(response.text, {outputPath, force, multiFile})` which returns `writtenFiles: string[]`. Catches `SpecExistsError`, logs error message, finalizes progress log, exits with code 1. Prints green success message listing all written paths.

### Phase 6: Telemetry Finalization
Calls `aiService.finalize(absolutePath)` to flush telemetry, extracts `summary` with `totalInputTokens`, `totalOutputTokens`, `totalDurationMs`. Constructs `summaryLine` string showing token counts, duration in seconds (1 decimal place), and output path. Logs summary and writes to progress log before calling `progressLog.finalize()`.

## Dependencies

Imports `loadConfig` from `../config/loader.js`, `collectAgentsDocs` and `collectAnnexFiles` from `../generation/collector.js`, `buildSpecPrompt`, `writeSpec`, and `SpecExistsError` from `../specify/index.js`. Imports `AIService`, `AIServiceError`, `createBackendRegistry`, `resolveBackend`, `getInstallInstructions` from `../ai/index.js`. Imports `ProgressLog` from `../orchestration/index.js`. Imports `generateCommand` from `./generate.js` for auto-generation fallback.

## Error Handling

- **CLI_NOT_FOUND**: Catches `AIServiceError` with code `'CLI_NOT_FOUND'`, prints red error message, calls `getInstallInstructions(registry)`, exits with code 2
- **SpecExistsError**: Catches error from `writeSpec()` when output exists without `force` flag, logs to progress log, prints red error message, exits with code 1
- **Empty docs after generation**: Prints red error message "No AGENTS.md files found after generation. Cannot proceed.", exits with code 1

## Behavioral Contracts

**Output path resolution**: `options.output` resolves via `path.resolve(options.output)`, defaults to `path.join(absolutePath, 'specs', 'SPEC.md')` if undefined.

**Token estimation**: Computes `estimatedTokensK = Math.ceil(totalChars / 4) / 1000` assuming 4 characters per token.

**High-context warning threshold**: Warns in dry-run mode if `estimatedTokensK > 150`.

**Timeout override**: Uses `Math.max(config.ai.timeoutMs, 600_000)` ensuring minimum 10-minute timeout regardless of config value.

**Summary format**: `"Tokens: {totalInputTokens} in / {totalOutputTokens} out | Duration: {totalDurationMs/1000:.1f}s | Output: {outputPath}"`.