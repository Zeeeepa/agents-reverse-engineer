<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/cli
`src/cli` implements the command-line interface for the `agents-reverse-engineer` tool, providing subcommands such as `cleanCommand`, `discoverCommand`, `generateCommand`, `initCommand`, `rebuildCommand`, `specifyCommand`, and `updateCommand` to manage documentation generation, project analysis, and AI interaction.

## Contents
*   [`clean.ts`](./clean.ts): implements the `are clean` CLI command, removing generated documentation artifacts and restoring user-authored `.local.md` files.
*   [`discover.ts`](./discover.ts): executes the `are discover` command, performing file discovery, filtering, and generating an `executionPlan`.
*   [`index.ts`](./index.ts): serves as the command-line interface entry point, parsing arguments and routing to specific sub-commands.
*   [`init.ts`](./init.ts): initializes the project by creating default configuration, `.gitignore`, and `.vscode/settings.json` entries.
*   [`rebuild.ts`](./rebuild.ts): implements the CLI `rebuild` command, orchestrating AI-driven code generation from specification files.
*   [`specify.ts`](./specify.ts): orchestrates the `specify` CLI command, generating project specifications from `AGENTS.md` documentation.
*   [`update.ts`](./update.ts): defines the CLI `update` command for incrementally updating documentation based on Git changes using AI file analysis.

## API Surface
`CleanOptions` defines configuration for `cleanCommand`. `cleanCommand(targetPath: string, options: CleanOptions)` executes the `are clean` command. `DiscoverOptions` defines options for `discoverCommand`. `discoverCommand(targetPath: string, options: DiscoverOptions)` discovers files and generates a `GENERATION-PLAN.md`. `initCommand(root: string, options?: { force?: boolean })` initializes project configuration and files. `RebuildOptions` defines options for `rebuildCommand`. `rebuildCommand(targetPath: string, options: RebuildOptions)` reconstructs a project from `specs/`. `SpecifyOptions` defines options for `specifyCommand`. `specifyCommand(targetPath: string, options: SpecifyOptions)` generates a project specification for `targetPath`. `UpdateOptions` configures `updateCommand`. `updateCommand(targetPath: string, options: UpdateOptions)` orchestrates documentation updates based on Git changes. `generateCommand` creates a documentation plan using `GenerateOptions`. `runInstaller` executes installation/uninstallation routines, while `parseInstallerArgs` processes installer-specific command-line arguments. `getVersion` retrieves the current tool `VERSION`.

## Architecture / Data Flow
The `main` function in `src/cli/index.ts` processes `string[]` command-line arguments using `parseArgs`, then dispatches to sub-command handlers like `cleanCommand`, `discoverCommand`, `generateCommand`, `initCommand`, `rebuildCommand`, `specifyCommand`, and `updateCommand` based on the parsed `command: string | undefined`. This central `main` function also handles `flags.has('version')` to `showVersion()` and `flags.has('help')` to `showHelp()`.

## Integration Points
`cleanCommand`, `discoverCommand`, `initCommand`, `rebuildCommand`, `specifyCommand`, `updateCommand` utilize `findProjectRoot`, `loadConfig`, `configExists`, `writeDefaultConfig`, `CONFIG_DIR`, and `CONFIG_FILE` from `../config/loader.js` for project configuration and root discovery. Logging functionality is provided by `createLogger` and `consoleLogger` from `../output/logger.js` and `../core/logger.js`. `cleanCommand` checks `GENERATED_MARKER_PREFIX` from `../generation/writers/agents-md.js`, which `updateCommand` also uses when calling `writeAgentsMd` and `writeAgentsMdHub`. `discoverCommand` uses `discoverFiles` from `../discovery/run.js` for file system traversal and filtering. Orchestration and plan generation are managed by `createOrchestrator` (used by `discoverCommand` for `GenerationPlan`) and `createUpdateOrchestrator` (used by `updateCommand` for `UpdatePlan`) from `../orchestration/orchestrator.js`. `discoverCommand` employs `buildExecutionPlan` and `formatExecutionPlanAsMarkdown` from `../generation/executor.js`. AI service interactions, including `AIService`, `AIServiceError`, `createBackendRegistry`, `resolveBackend`, and `getInstallInstructions`, are handled through `../ai/index.js` by `rebuildCommand`, `specifyCommand`, and `updateCommand`. `ProgressLog`, `CommandRunner`, `createTraceWriter`, `cleanupOldTraces`, and `ProgressReporter` from `../orchestration/index.js` provide progress reporting, concurrent execution, and tracing. `rebuildCommand` utilizes `readSpecFiles`, `partitionSpec`, `CheckpointManager`, and `executeRebuild` from `../rebuild/index.js` for core rebuild logic. `specifyCommand` integrates with `collectAgentsDocs` and `collectAnnexFiles` from `../generation/collector.js`, and `buildSpecPrompt`, `writeSpec`, and `SpecExistsError` from `../specify/index.js`. `index.ts` uses `runInstaller` and `parseInstallerArgs` from `../installer/index.js` and `getVersion` from `../version.js`. `updateCommand` calls `writeClaudeMdPointer` from `../generation/writers/claude-md.js` and `buildDirectoryPrompt` from `../generation/prompts/index.js`.

## Behavioral Contracts
`cleanCommand` error handling includes exiting on `ENOENT` if `resolvedPath` is not found, and `EACCES` or `EPERM` for permission denials. `GENERATED_MARKER_PREFIX` from `../generation/writers/agents-md.js` is the sentinel for AI-generated `AGENTS.md` or `CLAUDE.md` files. File restoration in `cleanCommand` renames `AGENTS.local.md` to `AGENTS.md` and `CLAUDE.local.md` to `CLAUDE.md`. `initCommand` exits with `process.exit(1)` for `EACCES`, `EPERM`, or other errors. The `GITIGNORE_SECTION` is `# agents-reverse-engineer`, and `SUM_PATTERN` is `*.sum`. VS Code exclusion is defined as `files.exclude["**/*.sum"] = true`. The `USAGE` string constant in `index.ts` defines the complete CLI interaction surface. `index.ts` displays `Unknown command: ${command}` and `Error: ${err.message}` for errors, using `process.exit(0)` for success and `process.exit(1)` for errors. `rebuildCommand` defaults its output directory to `path.join(absolutePath, 'rebuild')`. The AI `model` for `rebuildCommand` and `specifyCommand` defaults to "opus", upgrading "sonnet" to "opus". `AIService` minimum `timeoutMs` is `900_000` ms (15 minutes) for `rebuildCommand` and `specifyCommand`. Subprocess logs are written to `.agents-reverse-engineer/subprocess-logs/${ISO_TIMESTAMP}`. `rebuildCommand` exits with `process.exit(2)` on `AIServiceError('CLI_NOT_FOUND')` or if `modulesProcessed === 0 && modulesFailed > 0`, and `process.exit(1)` if `modulesFailed > 0`. `specifyCommand` defaults its output path to `specs/SPEC.md`. `specifyCommand` issues a warning and exits if output `.md` files exist without `--force`. `specifyCommand` has a dry run warning threshold of `150K tokens` for input size. `updateCommand` exit codes are `0` for success, `1` for partial failure, and `2` for total failure. Trace files are generated in `.agents-reverse-engineer/traces/`. Eval mode file naming follows `AGENTS.${variant}.md` and `*.${variant}.sum`.

## Workflow & Conventions
The `hasInstallerFlags` function in `index.ts` detects direct installer invocation based on `--global`, `--local`, `--force` flags or a `--runtime` value. `index.ts` parses command options into `flags: Set<string>` for boolean flags and `values: Map<string, string>` for flags with associated values. `rebuildCommand`'s `dryRun` option provides an execution plan without modifying files or invoking AI, while `force` warns the user about wiping the `outputDir`. `CheckpointManager` in `rebuildCommand` supports checkpoint-based resume functionality. `ProgressLog` and `createTraceWriter` in `rebuildCommand`, `specifyCommand`, and `updateCommand` enable execution tracking and detailed tracing. `updateCommand`'s `dryRun` shows a plan without modifications, and its `eval` mode appends a `variant` string (`${backend.name}.${effectiveModel}`) to output filenames.