---
generated_at: 2026-02-09T17:44:57.770Z
content_hash: 787eac676eca6402f9981c174edd6821e9ff2bae0ed51b3970dc7018800513b7
purpose: generateCommand orchestrates three-phase AI-driven documentation generation with concurrent file analysis, directory ...
---
**generateCommand orchestrates three-phase AI-driven documentation generation with concurrent file analysis, directory aggregation, and root document synthesis via CommandRunner execution of GenerationPlan tasks.**

## Exported Interface

**generateCommand(targetPath: string, options: GenerateOptions): Promise<void>** — CLI entry point that discovers files, builds GenerationPlan via createOrchestrator, resolves AI backend, and executes three-phase pipeline through CommandRunner.executeGenerate.

**GenerateOptions** — Configuration interface with fields:
- `dryRun?: boolean` — Show execution plan without AI calls
- `concurrency?: number` — Override worker pool size (1-10)
- `failFast?: boolean` — Abort on first task failure
- `debug?: boolean` — Enable subprocess logging with heap/RSS metrics
- `trace?: boolean` — Emit NDJSON events to `.agents-reverse-engineer/traces/`

**formatPlan(plan: GenerationPlan): string** — Formats GenerationPlan summary showing file count, task count, complexity metrics (fileCount, directoryDepth).

## Execution Flow

**generateCommand** coordinates six sequential phases:

1. **Configuration Loading**: Calls loadConfig with tracer and debug options, returns Config with ai.backend, ai.concurrency, ai.timeoutMs, exclude patterns.

2. **File Discovery**: Invokes discoverFiles with absolutePath and config, applies gitignore/binary/vendor filters, returns FilterResult with included/excluded arrays. Creates DiscoveryResult for orchestrator by mapping FilterResult.excluded to `{path, reason}` tuples.

3. **Plan Creation**: Instantiates createOrchestrator with config and absolutePath, calls orchestrator.createPlan(discoveryResult) returning GenerationPlan with files[], tasks[], complexity. Logs formatPlan output showing file count, task count, complexity.fileCount, complexity.directoryDepth.

4. **Dry-Run Bailout** (conditional): If options.dryRun, calls buildExecutionPlan(plan, absolutePath) returning ExecutionPlan with fileTasks[], directoryTasks[], rootTasks[], directoryFileMap. Logs summary: file count (executionPlan.fileTasks.length), directory count (Object.keys(executionPlan.directoryFileMap).length), root document count (executionPlan.rootTasks.length), estimated AI calls (executionPlan.tasks.length). Prints each fileTasks[].path via pc.dim, exits without AI calls.

5. **Backend Resolution**: Calls createBackendRegistry() returning BackendRegistry, resolveBackend(registry, config.ai.backend) returning Backend. Catches AIServiceError with code 'CLI_NOT_FOUND', logs getInstallInstructions(registry), exits with code 2. If options.debug, logs backend.name, backend.cliCommand, config.ai.model.

6. **AI Service Execution**: Instantiates AIService(backend, {timeoutMs, maxRetries, model, telemetry.keepRuns}). Calls aiService.setDebug(true) if options.debug. If options.trace, calls aiService.setSubprocessLogDir with path `.agents-reverse-engineer/subprocess-logs/<timestamp>`. Builds executionPlan via buildExecutionPlan. Creates ProgressLog.create(absolutePath), writes header with ISO timestamp, project path, file/directory counts. Instantiates CommandRunner(aiService, {concurrency, failFast, debug, tracer, progressLog}). Calls runner.executeGenerate(executionPlan) returning RunSummary. Calls aiService.finalize(absolutePath) for telemetry, progressLog.finalize(), tracer.finalize(), cleanupOldTraces(absolutePath) if options.trace.

## Exit Code Strategy

Derived from RunSummary fields (filesProcessed, filesFailed):
- `process.exit(2)` — Total failure: filesProcessed === 0 && filesFailed > 0
- `process.exit(1)` — Partial failure: filesFailed > 0 (but some files succeeded)
- `process.exit(0)` — Success: filesFailed === 0 (implicit default)

## Trace and Telemetry Integration

**createTraceWriter** invoked with absolutePath and options.trace before loadConfig/discoverFiles to thread tracer through all subsystems. If options.trace && tracer.filePath, logs trace file path via pc.dim. Tracer passed to loadConfig, discoverFiles, createOrchestrator, CommandRunner constructor. cleanupOldTraces(absolutePath) called after tracer.finalize() to enforce retention limit (500 traces).

**ProgressLog.create** instantiated with absolutePath, writes human-readable log to `.agents-reverse-engineer/progress.log` with header showing ISO timestamp, project path, file count (executionPlan.fileTasks.length), directory count (executionPlan.directoryTasks.length). Passed to CommandRunner for streaming updates. Finalized after runner.executeGenerate completes.

**AIService.setSubprocessLogDir** called when options.trace enabled, writes per-subprocess stdout/stderr to `.agents-reverse-engineer/subprocess-logs/<timestamp>/<taskId>.log`. Logs directory path via pc.dim.

## Concurrency Configuration

Determines worker pool size via `options.concurrency ?? config.ai.concurrency`. Config default: 2 for WSL environments (resource-constrained), 5 elsewhere. Passed to CommandRunner constructor as concurrency option.

## Dependencies

- `loadConfig` (src/config/loader.ts) — YAML config parsing with Zod validation
- `discoverFiles` (src/discovery/run.ts) — Gitignore-aware file walking returning FilterResult
- `createOrchestrator` (src/generation/orchestrator.ts) — Builds GenerationPlan with file/directory/root tasks
- `buildExecutionPlan` (src/generation/executor.ts) — Transforms GenerationPlan into ExecutionPlan with phase breakdown
- `AIService` (src/ai/service.ts) — Backend-agnostic AI service with subprocess management, retry logic, telemetry
- `resolveBackend`, `createBackendRegistry`, `getInstallInstructions` (src/ai/index.ts) — Backend detection and CLI installation messaging
- `CommandRunner` (src/orchestration/runner.ts) — Executes ExecutionPlan via worker pool with progress reporting
- `createTraceWriter`, `cleanupOldTraces` (src/orchestration/trace.ts) — NDJSON trace emission and retention management
- `ProgressLog` (src/orchestration/progress.ts) — Human-readable streaming log for tail -f monitoring
- `createLogger` (src/output/logger.ts) — Picocolors-formatted console output

## Error Handling

AIServiceError with code 'CLI_NOT_FOUND' caught during resolveBackend: logs error message via pc.red, calls getInstallInstructions(registry) to show installation commands for Claude Code/Gemini/OpenCode, exits with code 2.