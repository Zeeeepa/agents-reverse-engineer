---
generated_at: 2026-02-09T16:10:12.931Z
content_hash: 787eac676eca6402f9981c174edd6821e9ff2bae0ed51b3970dc7018800513b7
purpose: generateCommand() orchestrates full three-phase documentation pipeline: discovers files via discoverFiles(), builds G...
---
**generateCommand() orchestrates full three-phase documentation pipeline: discovers files via discoverFiles(), builds GenerationPlan via createOrchestrator().createPlan(), resolves AI backend via resolveBackend(), creates AIService and CommandRunner, executes concurrent file analysis → directory aggregation → root synthesis via runner.executeGenerate(), writes telemetry/traces, exits with status codes (0=success, 1=partial failure, 2=total failure).**

## Exported Interface

```typescript
interface GenerateOptions {
  dryRun?: boolean;        // Show plan without AI calls
  concurrency?: number;    // Worker pool size override
  failFast?: boolean;      // Abort on first failure
  debug?: boolean;         // Log AI prompts/backend details
  trace?: boolean;         // Emit NDJSON trace events
}

async function generateCommand(
  targetPath: string,
  options: GenerateOptions
): Promise<void>
```

## Execution Flow

generateCommand() executes seven sequential phases:

1. **Path resolution**: `path.resolve(targetPath)` converts relative to absolute path
2. **Trace initialization**: `createTraceWriter(absolutePath, options.trace ?? false)` creates NDJSON tracer before config/discovery
3. **Config loading**: `loadConfig(absolutePath, { tracer, debug })` reads `.agents-reverse-engineer/config.yaml` with Zod validation
4. **File discovery**: `discoverFiles(absolutePath, config, { tracer, debug })` applies filter chain (gitignore/binary/vendor/custom) producing `{ included, excluded }`
5. **Plan creation**: `createOrchestrator(config, absolutePath, { tracer, debug }).createPlan(discoveryResult)` returns GenerationPlan with `files[]`, `tasks[]`, `complexity`
6. **Backend resolution**: `resolveBackend(createBackendRegistry(), config.ai.backend)` auto-detects Claude/Gemini/OpenCode CLI availability, throws `AIServiceError` with `code: 'CLI_NOT_FOUND'` if none found, logs `getInstallInstructions(registry)` on stderr
7. **Pipeline execution**: `buildExecutionPlan(plan, absolutePath)` splits tasks into `fileTasks`/`directoryTasks`/`rootTasks`, `new CommandRunner(aiService, { concurrency, failFast, debug, tracer, progressLog }).executeGenerate(executionPlan)` runs three-phase pool concurrency

## Dry-Run Mode

When `options.dryRun === true`, formatPlan() displays plan summary and buildExecutionPlan() shows task breakdown without calling AIService:

```
--- Dry Run Summary ---
Files to analyze:     <fileTasks.length>
Directories:          <directoryFileMap keys>
Root documents:       <rootTasks.length>
Estimated AI calls:   <total tasks.length>
```

Exits without backend resolution or AIService instantiation.

## AI Service Configuration

AIService instantiated with backend-specific options merged from config and CLI:

```typescript
const aiService = new AIService(backend, {
  timeoutMs: config.ai.timeoutMs,           // SIGTERM timeout (default 120000ms)
  maxRetries: config.ai.maxRetries,         // Exponential backoff retries (default 3)
  model: config.ai.model,                   // Override backend default
  telemetry: { keepRuns: config.ai.telemetry.keepRuns }  // Retention limit (default 50)
});
```

If `options.debug === true`, calls `aiService.setDebug(true)` enabling subprocess stdout/stderr logging.

If `options.trace === true`, calls `aiService.setSubprocessLogDir(logDir)` where `logDir = path.join(absolutePath, '.agents-reverse-engineer', 'subprocess-logs', <ISO timestamp>)` to capture per-call output files.

## Progress Logging

ProgressLog.create() writes human-readable streaming log to `.agents-reverse-engineer/progress.log`:

```typescript
const progressLog = ProgressLog.create(absolutePath);
progressLog.write(`=== ARE Generate (${new Date().toISOString()}) ===`);
progressLog.write(`Project: ${absolutePath}`);
progressLog.write(`Files: ${fileTasks.length} | Directories: ${directoryTasks.length}`);
```

Passed to CommandRunner constructor, receives task pickup/completion events with ETA calculations. Finalized via `progressLog.finalize()` before exit.

## Exit Codes

Process exit status determined by RunSummary from runner.executeGenerate():

- **0**: `summary.filesFailed === 0` (all files succeeded or no files to process)
- **1**: `summary.filesFailed > 0 && summary.filesProcessed > 0` (partial failure)
- **2**: `summary.filesProcessed === 0 && summary.filesFailed > 0` (total failure, no progress)
- **2** (CLI not found): `AIServiceError.code === 'CLI_NOT_FOUND'` triggers stderr instructions via `getInstallInstructions(registry)`, calls `process.exit(2)` before pipeline execution

## Trace Cleanup

When `options.trace === true`, calls `cleanupOldTraces(absolutePath)` after `tracer.finalize()` to enforce retention limit (default 500 trace files) via mtime-based pruning.

## Dependencies

- **loadConfig**: Zod-validated config loading from `.agents-reverse-engineer/config.yaml`
- **discoverFiles**: Filter chain execution returning `{ included, excluded }` discovery result
- **createOrchestrator**: Factory producing orchestrator with `createPlan()` method
- **buildExecutionPlan**: Splits GenerationPlan into phase-specific task groups (`fileTasks`/`directoryTasks`/`rootTasks`)
- **resolveBackend**: Auto-detects first available AI CLI (Claude/Gemini/OpenCode) via sequential `isAvailable()` checks
- **AIService**: Subprocess manager with exponential backoff retry, telemetry logging, resource limits (`NODE_OPTIONS`, `UV_THREADPOOL_SIZE`)
- **CommandRunner**: Worker pool executor with three-phase dispatch (`executeGenerate()`), progress reporting, trace emission
- **ProgressLog**: Streaming append-only log writer for `tail -f` monitoring
- **createTraceWriter**: NDJSON trace event emitter with promise-chain serialization
- **cleanupOldTraces**: Mtime-based retention enforcement for `.agents-reverse-engineer/traces/` directory