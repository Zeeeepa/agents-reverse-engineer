---
generated_at: 2026-02-09T21:29:05.828Z
content_hash: a5a1264704c80d65f8fe2e2a95bfafd69712f290a360d3d55beaff90ac600c24
purpose: generateCommand orchestrates the three-phase ARE documentation pipeline by discovering files, resolving an AI backend...
---
**generateCommand orchestrates the three-phase ARE documentation pipeline by discovering files, resolving an AI backend, building an execution plan, and running concurrent analysis via CommandRunner to produce .sum files, AGENTS.md per directory, and root integration documents.**

## Exported Interface

**generateCommand(targetPath: string, options: GenerateOptions): Promise<void>**
- Main CLI entry point resolving `targetPath` to absolute path
- Loads config via `loadConfig()`, discovers files via `discoverFiles()`, creates generation plan via `createOrchestrator().createPlan()`
- Dry-run mode displays execution plan summary without AI calls
- Normal mode resolves backend via `resolveBackend()`, creates `AIService`, builds `executionPlan` via `buildExecutionPlan()`, executes via `CommandRunner.executeGenerate()`
- Finalizes telemetry via `aiService.finalize()`, progress log via `ProgressLog.finalize()`, trace via `tracer.finalize()`, cleans up old traces via `cleanupOldTraces()`
- Exit codes: 0 (all succeeded), 1 (partial failure), 2 (total failure)

**GenerateOptions interface**
- `dryRun?: boolean` — display plan without AI calls
- `concurrency?: number` — override worker pool size (1-10)
- `failFast?: boolean` — abort on first task failure
- `debug?: boolean` — enable subprocess logging with heap/RSS metrics
- `trace?: boolean` — emit NDJSON events to `.agents-reverse-engineer/traces/`
- `model?: string` — override AI model (e.g., "sonnet", "opus")

## Execution Flow

1. **Initialization**: Resolves `targetPath` to absolute, creates `createLogger()`, creates `createTraceWriter()` (early to thread through config/discovery)
2. **Configuration**: Calls `loadConfig(absolutePath, { tracer, debug })` loading `.agents-reverse-engineer/config.yaml` with Zod validation
3. **Discovery**: Calls `discoverFiles(absolutePath, config, { tracer, debug })` returning `FilterResult` with `included`/`excluded` arrays
4. **Planning**: Creates `createOrchestrator()`, calls `orchestrator.createPlan(discoveryResult)` producing `GenerationPlan` with `files`, `tasks`, `complexity`
5. **Dry-run branch**: If `options.dryRun`, calls `buildExecutionPlan()`, logs summary with `fileTasks.length`, `directoryTasks.length`, `rootTasks.length`, exits without AI calls
6. **Backend resolution**: Calls `createBackendRegistry()`, `resolveBackend(registry, config.ai.backend)` throwing `AIServiceError` with code `'CLI_NOT_FOUND'` on failure
7. **AI service creation**: Instantiates `AIService(backend, { timeoutMs, maxRetries, model, telemetry })`, calls `aiService.setDebug(true)` if debug enabled, calls `aiService.setSubprocessLogDir()` if trace enabled
8. **Execution**: Builds `executionPlan` via `buildExecutionPlan(plan, absolutePath)`, determines concurrency from `options.concurrency ?? config.ai.concurrency`, creates `ProgressLog.create(absolutePath)`, creates `CommandRunner(aiService, { concurrency, failFast, debug, tracer, progressLog })`, executes via `runner.executeGenerate(executionPlan)` returning `RunSummary`
9. **Finalization**: Calls `aiService.finalize(absolutePath)` writing telemetry run log, `progressLog.finalize()`, `tracer.finalize()`, `cleanupOldTraces(absolutePath)` retaining 500 most recent traces

## Error Handling

- `resolveBackend()` throws `AIServiceError` with `code: 'CLI_NOT_FOUND'` when no AI CLI detected, caught and logged via `getInstallInstructions(registry)`, exits with code 2
- `CommandRunner.executeGenerate()` returns `RunSummary` with `filesProcessed`, `filesFailed` counts determining exit code without throwing

## Progress Reporting

**formatPlan(plan: GenerationPlan): string**
- Returns formatted string with `plan.files.length`, `plan.tasks.length`, `plan.complexity.fileCount`, `plan.complexity.directoryDepth`

**ProgressLog integration**
- Creates via `ProgressLog.create(absolutePath)` writing to `.agents-reverse-engineer/progress.log`
- Writes header with ISO 8601 timestamp, project path, file/directory counts
- Passes to `CommandRunner` constructor for streaming updates during execution
- Enables real-time monitoring via `tail -f .agents-reverse-engineer/progress.log`

## Trace Integration

- Creates `createTraceWriter(absolutePath, options.trace ?? false)` before config loading to thread through all operations
- Logs trace file path via `pc.dim()` if `options.trace && tracer.filePath`
- Threads `tracer` through `loadConfig()`, `discoverFiles()`, `createOrchestrator()`, `CommandRunner` constructor
- Calls `cleanupOldTraces(absolutePath)` after finalization retaining 500 most recent trace files

## Subprocess Logging

- When `options.trace` enabled, calls `aiService.setSubprocessLogDir(logDir)` with timestamp-based path under `.agents-reverse-engineer/subprocess-logs/`
- Logs subprocess output directory via `pc.dim()` for debugging concurrent AI calls

## Model Resolution

- Effective model determined by `options.model ?? config.ai.model` (CLI flag overrides config)
- Passed to `AIService` constructor via `model` option
- Debug mode logs backend name, CLI command, effective model via `pc.dim()`

## Dependencies

- **Node.js path**: `path.resolve()` for absolute path conversion
- **picocolors**: `pc.red()`, `pc.cyan()`, `pc.bold()`, `pc.dim()` for terminal formatting
- **Config**: `loadConfig()` from `src/config/loader.ts`
- **Output**: `createLogger()` from `src/output/logger.ts`
- **Discovery**: `discoverFiles()` from `src/discovery/run.ts`
- **Generation**: `createOrchestrator()`, `buildExecutionPlan()` from `src/generation/`
- **AI**: `AIService`, `AIServiceError`, `createBackendRegistry()`, `resolveBackend()`, `getInstallInstructions()` from `src/ai/`
- **Orchestration**: `CommandRunner`, `ProgressLog`, `createTraceWriter()`, `cleanupOldTraces()` from `src/orchestration/`