<!-- Generated by agents-reverse-engineer -->

# src/update

**Incremental documentation update system comparing SHA-256 content hashes from `.sum` frontmatter against current file content, regenerating only modified files and affected `AGENTS.md` directories while cleaning orphaned artifacts from deletions and renames.**

## Contents

### Core Orchestration

**[index.ts](./index.ts)** — Barrel export exposing `UpdateOrchestrator`, `createUpdateOrchestrator()`, cleanup utilities (`cleanupOrphans`, `cleanupEmptyDirectoryDocs`, `getAffectedDirectories`), and type definitions (`UpdatePlan`, `UpdateOptions`, `UpdateResult`, `UpdateProgress`, `CleanupResult`) for incremental update workflow coordination.

**[orchestrator.ts](./orchestrator.ts)** — `UpdateOrchestrator` class implementing frontmatter-based change detection via `preparePlan()`: reads YAML `content_hash` from `.sum` files via `readSumFile()`, compares against `computeContentHash()` SHA-256 output, classifies files into `filesToAnalyze[]` (hash mismatch/missing) or `filesToSkip[]` (hash match), calls `cleanupOrphans()` for stale artifacts, invokes `getAffectedDirectories()` for directory regeneration scope, emits `phase:start/end` trace events with plan metadata.

**[orphan-cleaner.ts](./orphan-cleaner.ts)** — `cleanupOrphans()` deletes `.sum` files for deleted/renamed sources via `deleteIfExists()`, `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with no remaining source files (filters out hidden files, `.sum` suffixes, `GENERATED_FILES` Set), `getAffectedDirectories()` walks parent directory tree collecting paths requiring `AGENTS.md` regeneration, returns `CleanupResult` with `deletedSumFiles[]` and `deletedAgentsMd[]` arrays.

**[types.ts](./types.ts)** — `UpdateOptions` interface with `includeUncommitted` and `dryRun` flags, `UpdateResult` containing `analyzedFiles[]`, `skippedFiles[]`, `cleanup`, `regeneratedDirs[]`, commit SHAs, `UpdateProgress` callback interface with `onFileStart/Done/Cleanup/DirRegenerate` hooks, `CleanupResult` with deletion arrays.

## Architecture

### Hash-Based Change Detection

Replaces git-based diffing with SHA-256 content hash comparison stored in `.sum` YAML frontmatter. `UpdateOrchestrator.preparePlan()` iterates `discoverFiles()` output, reads each `.sum` file's `contentHash` field, computes current hash via `computeContentHash()`, pushes to `filesToAnalyze` with `status: 'modified'` on mismatch or `status: 'added'` when `.sum` missing, pushes to `filesToSkip` on hash match. No external state database — hash embedded in frontmatter enables stateless operation.

### Orphan Management

`cleanupOrphans()` accepts `FileChange[]` array with discriminated `status` field: iterates changes filtering `status === 'deleted'` or `status === 'renamed'`, deletes `.sum` at original path (using `oldPath` for renames), collects affected directories via `path.dirname()`, calls `cleanupEmptyDirectoryDocs()` for each directory. Empty directory check scans `readdir()` filtering hidden files (`.` prefix), `.sum` suffixes, `GENERATED_FILES` Set (`AGENTS.md`, `CLAUDE.md`), deletes `AGENTS.md` when no source files remain.

### Affected Directory Propagation

`getAffectedDirectories()` walks parent directory tree for each non-deleted `FileChange`: iterates `path.dirname()` until reaching `.` or absolute path, adds all parent paths including root to `Set<string>`. Returns unique directory paths requiring `AGENTS.md` regeneration. Orchestrator sorts by depth descending via `split(path.sep).length` to ensure post-order traversal (children before parents).

## File Relationships

**index.ts** re-exports `UpdateOrchestrator` and `createUpdateOrchestrator()` from orchestrator.ts, cleanup functions from orphan-cleaner.ts, types from types.ts — consumed by `src/cli/update.ts` command handler.

**orchestrator.ts** imports `readSumFile()` and `getSumPath()` from `src/generation/writers/sum.ts` for YAML frontmatter parsing, `computeContentHash()` from `src/change-detection/index.ts` for SHA-256 hashing, `cleanupOrphans()` and `getAffectedDirectories()` from orphan-cleaner.ts for stale artifact removal, `discoverFiles()` from `src/discovery/run.ts` for gitignore-aware file walking, emits trace events via `ITraceWriter` from `src/orchestration/trace.ts`.

**orphan-cleaner.ts** accepts `FileChange` from `src/change-detection/types.ts` with `status`/`oldPath` fields, returns `CleanupResult` from types.ts, uses `fs.stat()/unlink()/readdir()` for filesystem operations with `dryRun` preview support.

**types.ts** defines workflow contracts — `UpdateOptions` configures execution, `UpdateResult` captures outcome with file arrays and commit SHAs, `UpdateProgress` provides streaming callback hooks, `CleanupResult` summarizes deletion operations.

## Integration Points

Consumed by `src/cli/update.ts`: instantiates `UpdateOrchestrator` via `createUpdateOrchestrator()`, calls `preparePlan()` to compute `UpdatePlan`, passes `filesToAnalyze` to Phase 1 file analysis pool from `src/orchestration/pool.ts`, passes `affectedDirs` to Phase 2 directory aggregation from `src/generation/orchestrator.ts`, reports progress via `src/orchestration/progress.ts`, logs telemetry via `src/ai/telemetry/logger.ts`.

Depends on `src/generation/writers/sum.ts` for `.sum` file format knowledge (YAML frontmatter with `content_hash` field), `src/change-detection/detector.ts` for `computeContentHash()` SHA-256 implementation, `src/discovery/run.ts` for file discovery with gitignore/binary/vendor filters.