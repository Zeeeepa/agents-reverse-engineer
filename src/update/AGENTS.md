<!-- Generated by agents-reverse-engineer -->

# src/update

Incremental documentation update workflow coordinating SHA-256 hash-based change detection, orphaned artifact cleanup, and selective `.sum` + `AGENTS.md` regeneration for modified files and affected directories.

## Contents

**[index.ts](./index.ts)** — Barrel export exposing UpdateOrchestrator, createUpdateOrchestrator, cleanupOrphans, cleanupEmptyDirectoryDocs, getAffectedDirectories, UpdatePlan, UpdateOptions, UpdateResult, UpdateProgress, CleanupResult types.

**[orchestrator.ts](./orchestrator.ts)** — UpdateOrchestrator compares YAML frontmatter `content_hash` fields from existing `.sum` files against SHA-256 hashes of current file content via computeContentHash(), generates UpdatePlan segregating files into `filesToAnalyze` (added/modified), `filesToSkip` (unchanged), and `cleanup` (orphaned), computes `affectedDirs` requiring `AGENTS.md` regeneration sorted deepest-first. Factory createUpdateOrchestrator() constructs instances with optional ITraceWriter injection.

**[orphan-cleaner.ts](./orphan-cleaner.ts)** — cleanupOrphans() deletes `.sum` and `.annex.md` files for deleted/renamed source files (targeting `oldPath` for renames), invokes cleanupEmptyDirectoryDocs() removing `AGENTS.md` from directories with no remaining source files (excludes hidden files, `GENERATED_FILES` set, `.sum`/`.annex.md` from emptiness check). getAffectedDirectories() walks parent directories of non-deleted FileChange entries via path.dirname() to project root.

**[types.ts](./types.ts)** — Defines CleanupResult (`deletedSumFiles[]`, `deletedAgentsMd[]`), UpdateOptions (`includeUncommitted`, `dryRun` flags), UpdateResult (execution summary with `analyzedFiles`, `skippedFiles`, `cleanup`, `regeneratedDirs`, `baseCommit`, `currentCommit`), UpdateProgress (event callbacks: `onFileStart`, `onFileDone`, `onCleanup`, `onDirRegenerate`).

## Workflow

1. **Prerequisites** — UpdateOrchestrator.checkPrerequisites() validates git repository via isGitRepo(), throws Error if not a git repo
2. **Plan Creation** — preparePlan() calls discoverFiles(), iterates results:
   - Constructs `.sum` path via getSumPath()
   - Calls readSumFile() extracting `contentHash` from frontmatter
   - Missing `.sum`: adds `{ path, status: 'added' }` to `filesToAnalyze`
   - Existing `.sum`: calls computeContentHash(), compares hashes
   - Hash mismatch: adds `{ path, status: 'modified' }` to `filesToAnalyze`
   - Hash match: adds path to `filesToSkip`
3. **Orphan Cleanup** — cleanupOrphans() deletes `.sum`/`.annex.md` for deleted/renamed files, cleanupEmptyDirectoryDocs() removes `AGENTS.md` from directories with no source files
4. **Affected Directories** — getAffectedDirectories() computes parent paths of changed files, sorts by depth descending (deepest-first processing)
5. **Regeneration** — External caller (src/cli/update.ts) invokes Phase 1 pool execution for `filesToAnalyze`, Phase 2 sequential directory aggregation for `affectedDirs` (skips Phase 3 root synthesis)

## Integration

**Upstream callers**: src/cli/update.ts constructs UpdateOrchestrator via createUpdateOrchestrator(), calls preparePlan() returning UpdatePlan, passes `filesToAnalyze` to src/generation/executor.ts Phase 1 file analysis pool, passes `affectedDirs` to Phase 2 directory aggregation.

**Dependencies**: src/change-detection/detector.ts (computeContentHash, isGitRepo, getCurrentCommit), src/generation/writers/sum.ts (readSumFile, getSumPath), src/discovery/run.ts (discoverFiles), src/orchestration/trace.ts (ITraceWriter).

## Trace Events

UpdateOrchestrator emits via optional ITraceWriter:

- `phase:start` at plan creation with `phase: 'update-plan-creation'`, `taskCount: 0`, `concurrency: 1`
- `plan:created` after plan construction with `planType: 'update'`, `fileCount: filesToAnalyze.length`, `taskCount: filesToAnalyze.length + affectedDirs.length`
- `phase:end` after completion with `durationMs` computed via process.hrtime.bigint() delta

## Frontmatter Mode

No-op methods (recordFileAnalyzed, removeFileState, recordRun, getLastRun) retain signatures for API compatibility with hypothetical database-backed change detection but perform no operations. Content hash storage delegated to `.sum` file YAML frontmatter written by writeSumFile(). Run history tracking unavailable (getLastRun() returns undefined, recordRun() returns 0).

## Dry-Run Support

When `UpdateOptions.dryRun === true`, orphan-cleaner skips unlink() calls but executes stat() checks, returning would-be deletions in CleanupResult. Used for preview mode in src/cli/update.ts.