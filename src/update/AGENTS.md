<!-- Generated by agents-reverse-engineer -->

# src/update

Incremental documentation update workflow that compares stored content hashes in .sum frontmatter against current file state, regenerates changed summaries, removes orphaned artifacts when source files are deleted or renamed, and rebuilds affected AGENTS.md files.

## Contents

### Core Orchestration

**[orchestrator.ts](./orchestrator.ts)** — `UpdateOrchestrator` class and `createUpdateOrchestrator()` factory coordinate incremental updates by reading `content_hash` from each .sum file's YAML frontmatter via `readSumFile()`, computing current hash via `computeContentHash()`, flagging mismatches as `filesToAnalyze`, and returning `UpdatePlan` with `filesToSkip`, `cleanup: CleanupResult`, and `affectedDirs` for AGENTS.md regeneration. Method `preparePlan()` orchestrates discovery via `runDiscovery()`, hash comparison, orphan cleanup via `cleanupOrphans()`, and affected directory computation via `getAffectedDirectories()`. Emits trace events `phase:start`, `plan:created`, `phase:end` through `ITraceWriter`.

**[orphan-cleaner.ts](./orphan-cleaner.ts)** — `cleanupOrphans()` deletes `<path>.sum` for `FileChange` items with `status === 'deleted'` or `<oldPath>.sum` for `status === 'renamed'`, then calls `cleanupEmptyDirectoryDocs()` on affected parent directories. Function `cleanupEmptyDirectoryDocs()` removes AGENTS.md from directories with no remaining source files (filters out entries starting with `.`, ending with `.sum`, or in `GENERATED_FILES` Set). Function `getAffectedDirectories()` walks parent directories from non-deleted `FileChange` items, returning Set of directories requiring AGENTS.md regeneration.

**[types.ts](./types.ts)** — `UpdateOptions` interface with `includeUncommitted?: boolean`, `dryRun?: boolean`; `UpdateResult` interface with `analyzedFiles`, `skippedFiles`, `cleanup: CleanupResult`, `regeneratedDirs`, `baseCommit`, `currentCommit`; `CleanupResult` interface with `deletedSumFiles`, `deletedAgentsMd`; `UpdateProgress` interface with callbacks `onFileStart`, `onFileDone`, `onCleanup`, `onDirRegenerate`.

**[index.ts](./index.ts)** — Barrel export re-exporting `UpdateOrchestrator`, `createUpdateOrchestrator`, `UpdatePlan` from `./orchestrator.js`; `cleanupOrphans`, `cleanupEmptyDirectoryDocs`, `getAffectedDirectories` from `./orphan-cleaner.js`; `UpdateOptions`, `UpdateResult`, `UpdateProgress`, `CleanupResult` from `./types.js`.

## Change Detection Strategy

Uses frontmatter-based detection rather than git diff. Reads `content_hash` from `.sum` YAML frontmatter via `readSumFile()` from `../generation/writers/sum.js`, computes current content hash via `computeContentHash()` from `../change-detection/index.js`, flags files with mismatched hashes as `filesToAnalyze` with `FileChange` objects (`status: 'added' | 'modified'`). Tracks seen .sum files in `seenSumFiles` Set to identify orphans. Works independently of git history.

## Data Flow

1. `UpdateOrchestrator.preparePlan()` calls `runDiscovery()` from `../discovery/run.js` to find source files
2. For each file, calls `getSumPath()` and `readSumFile()` to retrieve `sumContent.contentHash`
3. Calls `computeContentHash()` on current file content, compares against stored hash
4. Hash mismatch → add to `filesToAnalyze` as `FileChange` with `status: 'modified'` or `status: 'added'`
5. Hash match → add to `filesToSkip`
6. Calls `cleanupOrphans()` with discovered `FileChange` items to delete `.sum` for deleted/renamed files
7. Calls `cleanupEmptyDirectoryDocs()` on parent directories to remove AGENTS.md from emptied directories
8. Calls `getAffectedDirectories()` to compute Set of directories needing AGENTS.md regeneration
9. Returns `UpdatePlan` with `filesToAnalyze`, `filesToSkip`, `cleanup`, `affectedDirs`, `isFirstRun`

## Integration Points

Called by `src/cli/update.ts` which instantiates `UpdateOrchestrator` via `createUpdateOrchestrator()`, calls `preparePlan()` to generate `UpdatePlan`, passes `filesToAnalyze` to `src/generation/orchestrator.ts` for re-analysis, passes `affectedDirs` to `src/generation/writers/agents-md.ts` for directory doc regeneration, and reports results via `UpdateResult`.

Imports `Config` from `../config/schema.js`, `isGitRepo`, `getCurrentCommit`, `computeContentHash`, `FileChange` from `../change-detection/index.js`, `readSumFile`, `getSumPath` from `../generation/writers/sum.js`, `discoverFiles` from `../discovery/run.js`, `ITraceWriter` from `../orchestration/trace.js`.