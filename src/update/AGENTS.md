<!-- Generated by agents-reverse-engineer -->

# src/update

Incremental documentation update subsystem that detects file changes via YAML frontmatter content hashes, removes orphaned artifacts, and orchestrates selective AGENTS.md regeneration.

## Contents

### [index.ts](./index.ts)
Barrel export aggregating `UpdateOrchestrator`, `createUpdateOrchestrator`, `UpdatePlan` from `orchestrator.js`, `cleanupOrphans`, `cleanupEmptyDirectoryDocs`, `getAffectedDirectories` from `orphan-cleaner.js`, and type definitions from `types.js`. Invoked by `src/cli/update.ts` for `are-update` command.

### [orchestrator.ts](./orchestrator.ts)
`UpdateOrchestrator` class implements `preparePlan(options: UpdateOptions): Promise<UpdatePlan>` using frontmatter-based change detection: reads stored `contentHash` from `.sum` file YAML frontmatter via `readSumFile()`, compares against `computeContentHash()` for current file, populates `filesToAnalyze` on hash mismatch and `filesToSkip` on match. Invokes `cleanupOrphans()` for deleted files, `getAffectedDirectories()` for changed files, sorts affected directories by depth descending (`depthB - depthA`) for post-order AGENTS.md regeneration. Factory function `createUpdateOrchestrator()` returns configured instance. Emits `phase:start`, `plan:created`, `phase:end` trace events via `ITraceWriter`.

### [orphan-cleaner.ts](./orphan-cleaner.ts)
`cleanupOrphans(projectRoot, changes, dryRun): Promise<CleanupResult>` deletes `.sum` and `.annex.sum` files for `FileChange` with `status === 'deleted'` or `status === 'renamed'` (using `oldPath`). Calls `cleanupEmptyDirectoryDocs(dirPath, dryRun): Promise<boolean>` to remove AGENTS.md from directories with no source files (excluding `.`, `*.sum`, `GENERATED_FILES` set). `getAffectedDirectories(changes): Set<string>` collects parent directories of changed files via `path.dirname()` recursion to root `'.'`.

### [types.ts](./types.ts)
`UpdateOptions` specifies `includeUncommitted?: boolean`, `dryRun?: boolean`. `UpdateResult` contains `analyzedFiles`, `skippedFiles`, `cleanup: CleanupResult`, `regeneratedDirs`, `baseCommit`, `currentCommit`, `dryRun`. `CleanupResult` holds `deletedSumFiles: string[]`, `deletedAgentsMd: string[]`. `UpdateProgress` defines optional callbacks: `onFileStart`, `onFileDone`, `onCleanup`, `onDirRegenerate`.

## Architecture

### Frontmatter-Based Change Detection
`UpdateOrchestrator.preparePlan()` implements hash comparison algorithm:
1. `discoverFiles()` yields all source file paths
2. For each file, `getSumPath(filePath)` + `readSumFile(sumPath)` retrieves YAML frontmatter
3. `computeContentHash(filePath)` compares against `sumContent.contentHash`
4. Hash mismatch → `filesToAnalyze` (status: `'added'` | `'modified'`)
5. Hash match → `filesToSkip`
6. No `.sum` file → treated as new file (`'added'`)

### Depth-First Directory Processing
`affectedDirs` sorted by `depthB - depthA` where `depth = dir === '.' ? 0 : dir.split(path.sep).length` ensures deepest directories process first during AGENTS.md regeneration, enabling parent directories to consume child AGENTS.md references.

### Orphan Lifecycle
`cleanupOrphans()` processes `FileChange` with `status === 'deleted' | 'renamed'`:
- Deletes `.sum` at `${change.path}.sum` or `${change.oldPath}.sum`
- Deletes `.annex.sum` using `${parsed.name}.annex.sum` glob pattern
- Collects affected directories via `path.dirname()` for each cleaned path
- Invokes `cleanupEmptyDirectoryDocs()` to remove AGENTS.md when no source files remain

### No-op Database Methods
`UpdateOrchestrator` provides API-compatible methods that are no-ops in frontmatter mode: `close()`, `recordFileAnalyzed()`, `removeFileState()`, `recordRun()`, `getLastRun()`. Content hash storage delegated to `.sum` file YAML frontmatter during write phase.

## Integration Points

- **Input**: `src/cli/update.ts` invokes `createUpdateOrchestrator()` → `preparePlan()`
- **Dependencies**: 
  - `../change-detection/` for `isGitRepo`, `getCurrentCommit`, `computeContentHash`, `FileChange`
  - `../generation/writers/sum.js` for `readSumFile`, `getSumPath` (frontmatter extraction)
  - `../discovery/run.js` for `discoverFiles` (with filter application)
  - `../orchestration/trace.js` for `ITraceWriter` event emission
- **Telemetry**: Emits `phase:start`/`phase:end` with `phase: 'update-plan-creation'`, `plan:created` with `planType: 'update'` and `taskCount`

## Behavioral Contracts

### Depth Calculation
```javascript
depth = dir === '.' ? 0 : dir.split(path.sep).length
```

### Sort Comparator
```javascript
depthB - depthA  // Descending order (deepest first)
```

### Git Repository Validation Error Message
```
'Not a git repository: ${projectRoot}\nThe update command requires a git repository for change detection.'
```

### Generated Files Exclusion Set
```javascript
GENERATED_FILES = Set(['AGENTS.md', 'CLAUDIA.md'])
```

### Debug Log Format
```
pc.dim('[debug] Creating update plan with change detection...')
pc.dim('[debug] Git commit: ${currentCommit.slice(0, 7)}')
pc.dim('[debug] Discovering files...')
pc.dim('[debug] Change detection: ${filesToAnalyze.length} changed, ${filesToSkip.length} unchanged, ${cleanup.deletedSumFiles.length} orphaned')
pc.dim('[debug] Affected directories: ${affectedDirs.length}')
```