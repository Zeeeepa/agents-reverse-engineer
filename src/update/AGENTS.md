<!-- Generated by agents-reverse-engineer -->

# src/update

Coordinates incremental documentation regeneration by comparing content hashes stored in `.sum` file frontmatter against current file content, removing orphaned artifacts when source files are deleted or renamed, and tracking affected directories for AGENTS.md regeneration in post-order (deepest-first).

## Contents

### [index.ts](./index.ts)
Barrel export aggregating UpdateOrchestrator (workflow coordinator), createUpdateOrchestrator (factory), UpdatePlan (planned operations), cleanupOrphans (orphan removal), cleanupEmptyDirectoryDocs (empty directory cleanup), getAffectedDirectories (impact analysis), and type definitions (UpdateOptions, UpdateResult, UpdateProgress, CleanupResult).

### [orchestrator.ts](./orchestrator.ts)
UpdateOrchestrator implements frontmatter-based change detection via preparePlan(), comparing computeContentHash() output against contentHash stored in .sum files by readSumFile(), classifying files into filesToAnalyze (hash mismatch or missing .sum), filesToSkip (hash match), and cleanup (orphaned .sum files from deleted sources), then sorting affectedDirs by depth descending for post-order AGENTS.md regeneration.

### [orphan-cleaner.ts](./orphan-cleaner.ts)
cleanupOrphans() removes .sum and .annex.sum files for deleted/renamed sources via deleteIfExists(), cleanupEmptyDirectoryDocs() removes AGENTS.md from directories with no remaining source files (filtering out hidden files, .sum files, and GENERATED_FILES Set containing 'AGENTS.md' and 'CLAUDE.md'), and getAffectedDirectories() walks parent directories of changed files up to project root using path.dirname() loop.

### [types.ts](./types.ts)
Type definitions: UpdateOptions (includeUncommitted, dryRun flags), UpdateResult (analyzedFiles, skippedFiles, cleanup, regeneratedDirs, baseCommit, currentCommit, dryRun), UpdateProgress (lifecycle hooks onFileStart, onFileDone, onCleanup, onDirRegenerate), and CleanupResult (deletedSumFiles, deletedAgentsMd arrays).

## Data Flow

1. **Change Detection**: orchestrator.ts preparePlan() calls computeContentHash() from ../change-detection/index.js for each discovered file, retrieves contentHash from .sum frontmatter via readSumFile() from ../generation/writers/sum.js, compares hashes to classify files into filesToAnalyze (status: 'added' or 'modified') or filesToSkip
2. **Orphan Cleanup**: preparePlan() invokes cleanupOrphans() from orphan-cleaner.ts with deleted/renamed FileChange entries, which deletes .sum/.annex.sum via deleteIfExists() and records deletedSumFiles in CleanupResult
3. **Impact Analysis**: cleanupOrphans() extracts path.dirname() for each cleaned path, filters out '.', stores in affectedDirs Set; preparePlan() merges with getAffectedDirectories() output (parent directories of non-deleted changes) and sorts by depth descending
4. **Directory Cleanup**: cleanupOrphans() calls cleanupEmptyDirectoryDocs() for each affected directory, removing AGENTS.md if no source files remain after filtering hidden files, .sum files, and GENERATED_FILES
5. **Plan Output**: preparePlan() returns UpdatePlan with filesToAnalyze, filesToSkip, cleanup (CleanupResult), affectedDirs (sorted deepest-first), baseCommit, currentCommit, isFirstRun

## Trace Events

- `phase:start` with `phase: 'update-plan-creation'` at preparePlan() entry
- `plan:created` with `planType: 'update'`, `fileCount`, `taskCount` (files + dirs) after plan construction
- `phase:end` with `durationMs`, `tasksCompleted: 1`, `tasksFailed: 0` at preparePlan() exit

## Behavioral Contracts

### File Status Classification
Files with missing .sum or contentHash mismatch → status 'added' (no prior .sum) or 'modified' (hash change)  
Files with contentHash match → filesToSkip (silent success)  
File read errors → silently added to filesToSkip (no exception thrown)

### Orphan Detection Rules
FileChange with `status: 'deleted'` → clean change.path  
FileChange with `status: 'renamed'` and change.oldPath → clean change.oldPath  
For each cleaned path: delete `${relativePath}.sum` and `${parsedPath.name}.annex.sum` in parsedPath.dir

### Directory Cleanup Criteria
Directory is empty if readdir() results contain no entries after excluding:
- Hidden files (basename starts with '.')
- .sum files (basename ends with '.sum', includes '.annex.sum')
- GENERATED_FILES ('AGENTS.md', 'CLAUDE.md')

### Affected Directory Traversal
For non-deleted FileChange entries, walk parent directories via path.dirname() loop until reaching '.' or absolute path, accumulate all parents including root ('.'), return Set<string> for AGENTS.md regeneration.

## Dependencies

Consumes computeContentHash(), isGitRepo(), getCurrentCommit(), FileChange from ../change-detection/, readSumFile(), getSumPath() from ../generation/writers/sum.js, discoverFiles() from ../discovery/run.js, and ITraceWriter from ../orchestration/trace.js. Integrates with cli/update.ts via exported UpdateOrchestrator and type definitions.