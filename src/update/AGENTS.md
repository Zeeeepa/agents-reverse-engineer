<!-- Generated by agents-reverse-engineer -->

# src/update

Incremental documentation update subsystem detecting changed files via `src/change-detection/detector.ts`, regenerating stale `.sum` files, deleting orphaned artifacts, and rebuilding affected `AGENTS.md` hierarchies.

## Contents

**[index.ts](./index.ts)** — Barrel export re-exposing `UpdateOrchestrator` (aliased `DocumentationOrchestrator`), `createUpdateOrchestrator` factory, `UpdatePlan`, `cleanupOrphans`, `cleanupEmptyDirectoryDocs`, `getAffectedDirectories`, and type definitions (`UpdateOptions`, `UpdateResult`, `UpdateProgress`, `CleanupResult`).

**[orphan-cleaner.ts](./orphan-cleaner.ts)** — Deletion module removing stale `.sum`/`.annex.sum` for deleted/renamed files via `cleanupOrphans()` (iterates `FileChange[]`, constructs `${relativePath}.sum` + `${parsed.name}.annex.sum` paths, calls `deleteIfExists()`), pruning `AGENTS.md` from empty directories via `cleanupEmptyDirectoryDocs()` (checks `hasSourceFiles` excluding `GENERATED_FILES: Set(['AGENTS.md', 'CLAUDE.md'])`), and `getAffectedDirectories()` collecting parent paths sorted by depth descending.

**[types.ts](./types.ts)** — Interface definitions: `UpdateOptions` (`includeUncommitted?: boolean`, `dryRun?: boolean`), `UpdateResult` (`analyzedFiles`, `skippedFiles`, `cleanup: CleanupResult`, `regeneratedDirs`, `baseCommit`, `currentCommit`, `dryRun`), `UpdateProgress` (`onFileStart?`, `onFileDone?`, `onCleanup?`, `onDirRegenerate?`), `CleanupResult` (`deletedSumFiles: string[]`, `deletedAgentsMd: string[]`).

## Architecture

### Update Workflow

1. **Change Detection**: `UpdateOrchestrator` invokes `src/change-detection/detector.ts` `getChangedFiles()` comparing git commits or detecting uncommitted modifications, producing `FileChange[]` with `status: 'added' | 'modified' | 'deleted' | 'renamed'`.

2. **Staleness Check**: reads existing `.sum` YAML frontmatter via `src/generation/writers/sum.ts` `readSumFile()`, compares `content_hash` against `src/change-detection/detector.ts` `computeContentHash()` (SHA-256 hex digest), populates `filesToAnalyze` on mismatch.

3. **File Regeneration**: executes `src/orchestration/runner.ts` phase-1-files pipeline for changed files, spawning `AIService.call()` subprocesses with user-configured concurrency, writing updated `.sum` via `writeSumFile()`.

4. **Orphan Cleanup**: invokes `cleanupOrphans()` with `FileChange[]`, deleting `.sum`/`.annex.sum` for `status === 'deleted'` or `status === 'renamed'` (uses `oldPath`), calling `cleanupEmptyDirectoryDocs()` on affected parent directories, accumulating results in `CleanupResult`.

5. **Directory Aggregation**: invokes `getAffectedDirectories()` collecting parent directories of non-deleted files, sorts by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending), sequentially regenerates `AGENTS.md` for each directory via `src/orchestration/runner.ts` phase-2-dirs logic.

### Dry Run Mode

When `UpdateOptions.dryRun === true`, `deleteIfExists()` checks file existence via `fs.stat()` but skips `fs.unlink()`, returning true if file exists (simulates deletion). Orchestrator logs intended actions without modifying filesystem, enabling preview of update scope.

## Integration Points

- **Invoked by**: `src/cli/update.ts` command handler after parsing `--include-uncommitted` and `--dry-run` flags
- **Consumes**: `FileChange[]` from `src/change-detection/detector.ts`, config from `src/config/loader.ts`
- **Delegates to**: `src/orchestration/runner.ts` for phase-1/phase-2 execution, `src/generation/writers/sum.ts` for frontmatter I/O, `src/generation/writers/agents-md.ts` for directory doc writes
- **Emits**: progress callbacks via `UpdateProgress` interface, deletion logs via `src/output/logger.ts`

## Behavioral Contracts

### Empty Directory Detection
```typescript
hasSourceFiles = entries.some(entry =>
  !entry.startsWith('.') &&
  !entry.endsWith('.sum') &&
  !GENERATED_FILES.has(entry)
)
```
When `hasSourceFiles === false`, `cleanupEmptyDirectoryDocs()` deletes `AGENTS.md`.

### Rename Handling
```typescript
// orphan-cleaner.ts line ~40
if (change.status === 'renamed') {
  pathToClean = change.oldPath; // Use old path, not current path
}
```

### Directory Traversal
```typescript
// getAffectedDirectories() walks parents until root
let current = path.dirname(relativePath);
while (current !== '.' && current !== '') {
  dirs.add(current);
  current = path.dirname(current);
}
dirs.add('.'); // Always includes root
```