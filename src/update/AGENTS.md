<!-- Generated by agents-reverse-engineer -->

# src/update/

Incremental documentation synchronization via frontmatter SHA-256 hash comparison, orphaned artifact cleanup, and targeted directory regeneration.

## Contents

### Core Orchestration

**[index.ts](./index.ts)** — Barrel export aggregating `UpdateOrchestrator` class, `createUpdateOrchestrator()` factory, cleanup functions (`cleanupOrphans`, `cleanupEmptyDirectoryDocs`, `getAffectedDirectories`), and type interfaces (`UpdateOptions`, `UpdateResult`, `UpdateProgress`, `CleanupResult`).

**[orchestrator.ts](./orchestrator.ts)** — `UpdateOrchestrator` class executing hash-based change detection via `preparePlan()`: discovers files through `runDiscovery()`, reads `.sum` YAML frontmatter via `readSumFile()` to extract `contentHash`, computes current SHA-256 via `computeContentHash()`, produces `UpdatePlan` with `filesToAnalyze[]` (hash mismatch/missing), `filesToSkip[]` (hash match), `cleanup: CleanupResult` (orphaned `.sum` files), `affectedDirs[]` (depth-sorted parent directories). Emits trace events (`phase:start`, `plan:created`, `phase:end`) via `ITraceWriter`. No-op methods (`close()`, `recordFileAnalyzed()`, `removeFileState()`, `recordRun()`, `getLastRun()`) preserved for API compatibility after SQLite state manager removal.

**[orphan-cleaner.ts](./orphan-cleaner.ts)** — `cleanupOrphans()` deletes `.sum` files for `FileChange` entries with `status === 'deleted'` (uses `change.path`) or `status === 'renamed'` (uses `change.oldPath`), returns `CleanupResult` with `deletedSumFiles[]` and `deletedAgentsMd[]`. `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories containing only hidden files (`.` prefix), `.sum` files, or `GENERATED_FILES` set members. `getAffectedDirectories()` walks parent directories via `path.dirname()` for non-deleted `FileChange` entries, excludes `status === 'deleted'`, always includes `'.'` root.

**[types.ts](./types.ts)** — `UpdateOptions` interface with `includeUncommitted?: boolean` (merges `git status --porcelain` into change set) and `dryRun?: boolean` (preview-only). `UpdateResult` interface with `analyzedFiles[]`, `skippedFiles[]`, `cleanup`, `regeneratedDirs[]`, `baseCommit`, `currentCommit`, `dryRun` fields. `UpdateProgress` callback interface with `onFileStart()`, `onFileDone()`, `onCleanup()`, `onDirRegenerate()` hooks. `CleanupResult` interface with `deletedSumFiles[]`, `deletedAgentsMd[]` arrays. Re-exports `FileChange` from `../change-detection/types.js`.

## Update Algorithm

**Hash-Based Change Detection** (orchestrator.ts `preparePlan()` method):
1. `checkPrerequisites()` verifies git repository via `isGitRepo()`
2. `getCurrentCommit()` retrieves HEAD commit SHA
3. `discoverFiles()` wraps `runDiscovery()` from `../discovery/run.js`, converts absolute paths to relative via `path.relative()`
4. For each file: `getSumPath()` locates `.sum` file, `readSumFile()` extracts `contentHash` from YAML frontmatter, `computeContentHash()` computes current SHA-256
5. Hash mismatch or missing `.sum` → `FileChange` with `status: 'added'|'modified'` added to `filesToAnalyze[]`
6. Hash match → path added to `filesToSkip[]`
7. `cleanupOrphans()` deletes `.sum` files for deleted/renamed sources
8. `getAffectedDirectories()` computes unique parent directory set from `filesToAnalyze[]`
9. `affectedDirs[]` sorted by depth descending via `split(path.sep).length` (deepest-first for bottom-up regeneration)

**Orphan Cleanup** (orphan-cleaner.ts):
- Deleted files: Appends `.sum` to `change.path`, calls `deleteIfExists()`
- Renamed files: Appends `.sum` to `change.oldPath`, calls `deleteIfExists()`
- Empty directories: `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` if directory contains no source files (excludes hidden files, `.sum` files, `AGENTS.md`, `CLAUDE.md`)
- `deleteIfExists()` internal helper: `stat()` existence check, `unlink()` delete (skipped if `dryRun === true`), returns boolean

## Integration Points

**Upstream Dependencies:**
- `../change-detection/index.js` — `isGitRepo()`, `getCurrentCommit()`, `computeContentHash()`, `FileChange` type
- `../generation/writers/sum.js` — `readSumFile()` (parses YAML frontmatter), `getSumPath()` (resolves `.sum` path)
- `../discovery/run.js` — `discoverFiles()` wrapping `runDiscovery()` for file scanning
- `../config/schema.js` — `Config` type with exclude patterns and concurrency settings
- `../orchestration/trace.js` — `ITraceWriter` interface for NDJSON trace emission

**Downstream Consumers:**
- `../cli/update.ts` — CLI entry point invoking `createUpdateOrchestrator()` with parsed options
- `hooks/are-session-end.js` — Session hook spawning `npx agents-reverse-engineer@latest update --quiet` on uncommitted changes

## API Compatibility Pattern

orchestrator.ts no-op methods preserve interface contract for consumers expecting SQLite-based state management (removed in frontmatter migration):
- `close()` — No database resources to clean
- `recordFileAnalyzed()` — Hash now stored in `.sum` YAML frontmatter
- `removeFileState()` — Cleanup handled by `cleanupOrphans()`
- `recordRun()` — Returns `0` (no run history tracking)
- `getLastRun()` — Returns `undefined` (no historical run data)

## Trace Events

orchestrator.ts emits via `ITraceWriter`:
- `{ type: 'phase:start', phase: 'update-plan-creation' }` — Start of `preparePlan()`
- `{ type: 'plan:created', planType: 'update', fileCount, taskCount }` — Plan finalized
- `{ type: 'phase:end', phase: 'update-plan-creation', durationMs, tasksCompleted: 1, tasksFailed: 0 }` — Plan complete

## Debug Logging

orchestrator.ts stderr output (when `debug: true`):
- `'[debug] Creating update plan with change detection...'` — Start signal
- `'[debug] Git commit: <hash>'` — First 7 characters of commit SHA
- `'[debug] Discovering files...'` — Before discovery phase
- `'[debug] Change detection: <changed> changed, <unchanged> unchanged, <orphaned> orphaned'` — After hash comparison
- `'[debug] Affected directories: <count>'` — Directory regeneration scope