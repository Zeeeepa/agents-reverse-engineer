<!-- Generated by agents-reverse-engineer -->

# src/update

Coordinates incremental documentation updates by detecting content changes through frontmatter-stored hashes, removing orphaned artifacts, and regenerating AGENTS.md files for affected directories.

## Contents

### [index.ts](./index.ts)
Barrel export for UpdateOrchestrator, cleanupOrphans, cleanupEmptyDirectoryDocs, getAffectedDirectories, and shared types (UpdateOptions, UpdateResult, UpdateProgress, CleanupResult).

### [orchestrator.ts](./orchestrator.ts)
`UpdateOrchestrator` class implements `preparePlan()` which builds `UpdatePlan` by: invoking `runDiscovery()` from `../discovery/run.js`, reading `.sum` frontmatter via `readSumFile()`, comparing stored `contentHash` against `computeContentHash()` from `../change-detection/index.js`, classifying files as `'added'`/`'modified'`/`'unchanged'`, calling `cleanupOrphans()` for deleted files, then sorting affected directories deepest-first for post-order AGENTS.md regeneration. `createUpdateOrchestrator()` factory constructs instances with Config and optional ITraceWriter.

### [orphan-cleaner.ts](./orphan-cleaner.ts)
`cleanupOrphans()` deletes `.sum` and `.annex.md` files for FileChange entries with `status === 'deleted'` or `status === 'renamed'`, then removes AGENTS.md from emptied directories. `getAffectedDirectories()` traverses parent directories of non-deleted changes up to `'.'` root. `cleanupEmptyDirectoryDocs()` uses `readdir()` filtering against GENERATED_FILES Set to detect source-empty directories.

### [types.ts](./types.ts)
UpdateOptions (`includeUncommitted?: boolean`, `dryRun?: boolean`), UpdateResult (`analyzedFiles: string[]`, `skippedFiles: string[]`, `cleanup: CleanupResult`, `regeneratedDirs: string[]`, `baseCommit: string`, `currentCommit: string`, `dryRun: boolean`), UpdateProgress (callbacks: `onFileStart`, `onFileDone`, `onCleanup`, `onDirRegenerate`), CleanupResult (`deletedSumFiles: string[]`, `deletedAgentsMd: string[]`).

## Change Detection Strategy

UpdateOrchestrator abandoned git-based diffing in favor of frontmatter hash comparison: `getSumPath()` locates `.sum` file, `readSumFile()` extracts stored `contentHash`, `computeContentHash()` computes current hash via `crypto.createHash('sha256')`. Hash mismatch triggers `'modified'` classification. Missing `.sum` file triggers `'added'` classification. Hash match adds file to `filesToSkip` array. This approach supports non-git repositories and avoids git history traversal overhead.

## Directory Regeneration Order

`preparePlan()` sorts `affectedDirs` by `path.normalize(d).split(path.sep).length` descending, ensuring child directories process before parents. Root directory `'.'` included via `getAffectedDirectories()` unconditional insertion. This post-order traversal matches `../generation/orchestrator.ts` directory phase execution pattern.

## Trace Event Schema

`preparePlan()` emits `{ type: 'phase:start', phase: 'update-plan-creation', taskCount: 0, concurrency: 1 }`, `{ type: 'plan:created', planType: 'update', fileCount: filesToAnalyze.length, taskCount: filesToAnalyze.length + affectedDirs.length }`, and `{ type: 'phase:end', phase: 'update-plan-creation', durationMs, tasksCompleted: 1, tasksFailed: 0 }`. Duration computed via `process.hrtime.bigint()` delta converted to milliseconds.

## Behavioral Contracts

### Hash Comparison Logic
```typescript
// orchestrator.ts preparePlan()
if (!sumContent) {
  // No .sum file → added
  filesToAnalyze.push({ path: relativePath, status: 'added' });
} else if (sumContent.contentHash !== currentHash) {
  // Hash mismatch → modified
  filesToAnalyze.push({ path: relativePath, status: 'modified', oldPath: relativePath });
} else {
  // Hash match → skip
  filesToSkip.push(relativePath);
}
```

### Orphan Cleanup Filter
```typescript
// orphan-cleaner.ts cleanupEmptyDirectoryDocs()
const entries = await readdir(dirPath, { withFileTypes: true });
const sourceFiles = entries.filter(e =>
  e.isFile() &&
  !e.name.startsWith('.') &&
  !e.name.endsWith('.sum') &&
  !e.name.endsWith('.annex.md') &&
  !GENERATED_FILES.has(e.name)
);
// If sourceFiles.length === 0, delete AGENTS.md
```

### Directory Traversal Termination
```typescript
// orphan-cleaner.ts getAffectedDirectories()
let current = path.dirname(change.path);
while (current !== '.' && !path.isAbsolute(current)) {
  affected.add(current);
  current = path.dirname(current);
}
affected.add('.'); // Root always included
```