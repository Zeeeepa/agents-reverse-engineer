<!-- Generated by agents-reverse-engineer -->

# src/update

Orchestrates incremental documentation updates via SHA-256 content hash comparison against `.sum` YAML frontmatter, deleting orphaned artifacts and computing affected directory sets without requiring git diff parsing.

## Contents

**[index.ts](./index.ts)** — Barrel module exporting `UpdateOrchestrator` class, factory `createUpdateOrchestrator()`, cleanup utilities `cleanupOrphans()`, `cleanupEmptyDirectoryDocs()`, `getAffectedDirectories()`, and interfaces `UpdatePlan`, `UpdateOptions`, `UpdateResult`, `UpdateProgress`, `CleanupResult`.

**[orchestrator.ts](./orchestrator.ts)** — `UpdateOrchestrator` class coordinates change detection by reading stored `content_hash` from `.sum` frontmatter via `readSumFile()`, comparing against `computeContentHash()` output, returning `UpdatePlan` with `filesToAnalyze` (hash mismatch), `filesToSkip` (match), `cleanup` (orphans), `affectedDirs` (sorted depth descending). Methods: `preparePlan()`, `checkPrerequisites()`, `isFirstRun()`. Emits `plan:created` trace events.

**[orphan-cleaner.ts](./orphan-cleaner.ts)** — `cleanupOrphans()` deletes stale `.sum`/`.annex.md` files for deleted/renamed sources via `deleteIfExists()`, `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with zero source files (excludes `GENERATED_FILES` set and dotfiles), `getAffectedDirectories()` walks parent directories via `path.dirname()` until `.` or absolute path, returning `Set<string>` of directories requiring regeneration.

**[types.ts](./types.ts)** — Interfaces: `CleanupResult` (`deletedSumFiles`, `deletedAgentsMd` arrays), `UpdateOptions` (`includeUncommitted`, `dryRun` flags), `UpdateResult` (`analyzedFiles`, `skippedFiles`, `cleanup`, `regeneratedDirs`, `baseCommit`, `currentCommit`, `dryRun`), `UpdateProgress` callbacks (`onFileStart`, `onFileDone`, `onCleanup`, `onDirRegenerate`).

## Update Workflow

1. **Change Detection:** `preparePlan()` discovers files via `runDiscovery()` from `src/discovery/`, reads `.sum` frontmatter via `readSumFile()` from `src/generation/writers/sum.js`, compares `content_hash` against `computeContentHash()` from `src/change-detection/`, populates `filesToAnalyze` (added/modified) and `filesToSkip` (unchanged).

2. **Orphan Cleanup:** `cleanupOrphans()` processes `FileChange[]` with `status: 'deleted' | 'renamed'`, extracts `path` (deleted) or `oldPath` (renamed), constructs `.sum` and `.annex.md` paths, deletes via `unlink()` unless `dryRun: true`.

3. **Affected Directories:** `getAffectedDirectories()` walks parent chains for all changed files, returns `Set<string>` sorted by `path.sep` depth descending (deepest first), ensuring `AGENTS.md` regeneration propagates upward.

4. **Empty Directory Cleanup:** `cleanupEmptyDirectoryDocs()` filters directory entries excluding dotfiles, `.sum`/`.annex.md` extensions, `GENERATED_FILES` set (`['AGENTS.md', 'CLAUDE.md']`), deletes `AGENTS.md` if zero source files remain.

5. **Execution:** `src/cli/update.ts` invokes `preparePlan()`, executes Phase 1 pool for `filesToAnalyze` via `src/generation/executor.ts`, regenerates `AGENTS.md` sequentially for `affectedDirs` (no post-order traversal required).

## Trace Emissions

`preparePlan()` emits:
- `phase:start` with `phase: 'update-plan-creation'`, `taskCount: 0`, `concurrency: 1`
- `plan:created` with `planType: 'update'`, `fileCount: filesToAnalyze.length`, `taskCount: filesToAnalyze.length + affectedDirs.length`
- `phase:end` with `durationMs` computed via `process.hrtime.bigint()` delta

## Behavioral Contracts

**Depth-descending sort:** `affectedDirs` sorted via `path.relative().split(path.sep).length` comparator (deepest first) ensuring child directories process before parents.

**Orphan path construction:** `.sum` path = `path.join(projectRoot, \`${relativePath}.sum\`)`, `.annex.md` path = `path.join(projectRoot, \`${relativePath}.annex.md\`)`.

**Directory emptiness filter:** Exclude entries matching `entry.startsWith('.')` OR `entry.endsWith('.sum')` OR `entry.endsWith('.annex.md')` OR `GENERATED_FILES.has(entry)`.

**Upward traversal terminator:** `getAffectedDirectories()` stops when `dir === '.'` OR `path.isAbsolute(dir) === true`.

## API Compatibility No-Ops

Methods retained for backward compatibility but perform no operations in frontmatter-based mode:
- `recordFileAnalyzed()` — hash stored in `.sum` YAML frontmatter by generation phase
- `removeFileState()` — `.sum` file cleanup handled by `cleanupOrphans()`
- `recordRun()` — returns `0`, no run history database in frontmatter mode
- `getLastRun()` — returns `undefined`, no run history available
- `close()` — no resources to dispose