<!-- Generated by agents-reverse-engineer v1.1.0 -->

# src/update

Implements incremental documentation updates by removing orphaned `.sum`/`AGENTS.md` artifacts after file deletions/renames and identifying parent directories requiring regeneration based on git-tracked file changes.

## Contents

- **[index.ts](./index.ts)**: Barrel export aliasing `DocumentationOrchestrator` as `UpdateOrchestrator`, re-exporting `createUpdateOrchestrator` (from `../orchestration/orchestrator.js`), `cleanupOrphans`, `cleanupEmptyDirectoryDocs`, `getAffectedDirectories` (from `orphan-cleaner.ts`), and types `UpdatePlanOptions`, `UpdateResult`, `UpdateProgress`, `CleanupResult`, `UpdatePlan`.
- **[orphan-cleaner.ts](./orphan-cleaner.ts)**: Defines `cleanupOrphans` (deletes `.sum`/`.annex.sum` via `getSumPath`/`getAnnexPath` for deleted/renamed changes, removes `AGENTS.md` from empty directories), `getAffectedDirectories` (collects parent directory set from non-deleted changes), `cleanupEmptyDirectoryDocs` (stats directory entries, deletes `agentsFilename` if no source files remain after excluding hidden files, `.sum`, `GENERATED_FILES` set `['AGENTS.md', 'CLAUDE.md']`, `AGENTS.*.md` patterns).
- **[types.ts](./types.ts)**: Exports `CleanupResult` (`deletedSumFiles`/`deletedAgentsMd` arrays), `UpdatePlanOptions` (`includeUncommitted`/`dryRun`/`variant` flags), `UpdateResult` (`analyzedFiles`/`skippedFiles`/`cleanup`/`regeneratedDirs`/`baseCommit`/`currentCommit`/`dryRun`), `UpdateProgress` callbacks (`onFileStart`/`onFileDone`/`onCleanup`/`onDirRegenerate`).

## Orchestration Integration

The `src/update/` module does NOT implement the full update orchestration â€” it provides cleanup and affected-directory primitives consumed by `DocumentationOrchestrator` in `src/orchestration/orchestrator.ts`. The CLI command `src/cli/update.ts` invokes:
1. Change detection (`src/change-detection/detector.ts`) to compute git-based `FileChange[]`
2. `cleanupOrphans` to delete stale artifacts
3. `getAffectedDirectories` to identify regeneration targets
4. `DocumentationOrchestrator.updateFiles` (from `src/orchestration/`) to regenerate `.sum`/`AGENTS.md` for modified subtrees

## Behavioral Contracts

**Orphan Patterns**:
- `.sum` file for deleted source: `${dirPath}/${baseName}.sum`
- Annex file for deleted source: `${dirPath}/${baseName}.annex.sum`
- Renamed file cleanup: uses `change.oldPath` (not `change.path`)

**Empty Directory Condition**: Directory qualifies for `AGENTS.md` deletion if no files exist matching ALL criteria:
- NOT hidden (excludes `entry.startsWith('.')`)
- NOT `.sum` file (excludes `entry.endsWith('.sum')`)
- NOT in `GENERATED_FILES` set (`['AGENTS.md', 'CLAUDE.md']`)
- NOT matching `AGENTS.*.md` pattern

**Variant Support**: When `variant` provided, uses `AGENTS.${variant}.md` filename (e.g., `AGENTS.claude.sonnet.md` for `variant: 'claude.sonnet'`).

**Affected Directory Traversal**: For path `a/b/c.ts`, collects `['a/b', 'a', '.']` (stops at project root `.`).