<!-- Generated by agents-reverse-engineer v1.0.1 -->

# src/update

The `src/update` directory handles incremental documentation updates by orchestrating regeneration of changed files, cleaning up orphaned `.sum` files, and identifying affected directories for `AGENTS.md` regeneration.

## Contents

- [`index.ts`](./index.ts): Re-exports `UpdateOrchestrator` (alias for `DocumentationOrchestrator`), `createUpdateOrchestrator` factory, `cleanupOrphans`, `cleanupEmptyDirectoryDocs`, and `getAffectedDirectories` from orchestration and cleanup modules.
- [`orphan-cleaner.ts`](./orphan-cleaner.ts): Exports `cleanupOrphans` to delete `.sum`/`.annex.sum` files for deleted/renamed sources via `getSumPath`/`getAnnexPath`, removes `AGENTS.md` from empty directories, and `getAffectedDirectories` to collect parent directories for regeneration.
- [`types.ts`](./types.ts): Defines `CleanupResult` (tracks `deletedSumFiles`, `deletedAgentsMd`), `UpdatePlanOptions` (`includeUncommitted`, `dryRun`, `variant`), `UpdateResult` (`analyzedFiles`, `skippedFiles`, `cleanup`, `regeneratedDirs`, `baseCommit`, `currentCommit`), and `UpdateProgress` callbacks.

## Architecture

The update workflow operates in phases: (1) detect file changes via `../change-detection/`, (2) delegate `.sum` regeneration to `UpdateOrchestrator` from `../orchestration/orchestrator.js`, (3) call `cleanupOrphans` to remove stale `.sum` files and empty directory `AGENTS.md`, (4) call `getAffectedDirectories` to compute directories requiring `AGENTS.md` regeneration.

## API Surface

- `UpdateOrchestrator` (re-exported from `../orchestration/orchestrator.js`) — orchestrates `.sum` file generation for changed files
- `createUpdateOrchestrator(config, options)` — factory for `UpdateOrchestrator` instances
- `cleanupOrphans(projectRoot, changes, dryRun, variant)` — deletes orphaned `.sum`/`.annex.sum` files and empty `AGENTS.md`, returns `CleanupResult`
- `cleanupEmptyDirectoryDocs(dirPath, dryRun, agentsFilename)` — removes `AGENTS.md` if directory contains no source files
- `getAffectedDirectories(changes)` — returns `Set<string>` of parent directories up to root (`.`)

## File Relationships

`orphan-cleaner.ts` imports `FileChange` from `../change-detection/types.js` and `getSumPath`/`getAnnexPath` from `../generation/writers/sum.js` to compute `.sum` file paths for cleanup. `types.ts` imports `FileChange` to type `UpdateResult` fields. `index.ts` re-exports `DocumentationOrchestrator` from `../orchestration/orchestrator.js` as `UpdateOrchestrator` and `cleanupOrphans`/`getAffectedDirectories` from `orphan-cleaner.ts`.

## Behavioral Contracts

- `cleanupOrphans` uses `getSumPath(filePath, projectRoot, variant)` and `getAnnexPath(filePath, projectRoot, variant)` to resolve `.sum`/`.annex.sum` paths, handling renamed files via `change.oldPath`.
- `cleanupEmptyDirectoryDocs` excludes files matching `GENERATED_FILES` set (`'AGENTS.md'`, `'CLAUDE.md'`), `.sum` extensions, and `AGENTS.*.md` patterns when determining directory emptiness.
- `getAffectedDirectories` traverses parent directories up to `.` for all `change.type !== 'deleted'` entries.
- Variant-specific cleanup uses `AGENTS.${variant}.md` filename pattern.