<!-- Generated by agents-reverse-engineer v1.0.1 -->

# update
The `update` directory manages the incremental documentation update workflow, providing core interfaces like `UpdatePlan`, `UpdateResult`, and `UpdateProgress` through `types.ts`, orchestrating file cleanup of orphaned `.sum` and `AGENTS.md` files via `orphan-cleaner.ts`, and re-exporting these capabilities through its main `index.ts`.

## Contents
*   [index.ts](./index.ts): Re-exports `UpdateOrchestrator`, `createUpdateOrchestrator`, `UpdatePlan`, `cleanupOrphans`, `cleanupEmptyDirectoryDocs`, `getAffectedDirectories`, `UpdatePlanOptions`, `UpdateResult`, `UpdateProgress`, `CleanupResult` for comprehensive documentation update management.
*   [orphan-cleaner.ts](./orphan-cleaner.ts): Manages the cleanup of orphaned `.sum` and `AGENTS.md` files after source file modifications, employing `cleanupOrphans`, `cleanupEmptyDirectoryDocs`, and `getAffectedDirectories` to identify and remove outdated documentation.
*   [types.ts](./types.ts): Defines essential interfaces including `CleanupResult`, `UpdatePlanOptions`, `UpdateResult`, and `UpdateProgress` to structure the incremental update workflow data within the `update` process.

## API Surface
The directory exports `UpdateOrchestrator`, `createUpdateOrchestrator`, `UpdatePlan`, `cleanupOrphans`, `cleanupEmptyDirectoryDocs`, `getAffectedDirectories`, `UpdatePlanOptions`, `UpdateResult`, `UpdateProgress`, and `CleanupResult`.
*   `cleanupOrphans(projectRoot: string, changes: FileChange[], dryRun: boolean = false, variant?: string): Promise<CleanupResult>`: Deletes `.sum`/`.annex.sum` for `deleted`/`renamed` sources and `AGENTS.md` from empty source directories.
*   `cleanupEmptyDirectoryDocs(dirPath: string, dryRun: boolean = false, agentsFilename: string = 'AGENTS.md'): Promise<boolean>`: Removes `agentsFilename` if `dirPath` lacks source files.
*   `getAffectedDirectories(changes: FileChange[]): Set<string>`: Returns relative parent directories of non-deleted `FileChange`s.
*   `CleanupResult`: Defines `{ deletedSumFiles: string[]; deletedAgentsMd: string[]; }`.
*   `UpdatePlanOptions`: Defines `{ includeUncommitted?: boolean; dryRun?: boolean; variant?: string; }`.
*   `UpdateResult`: Defines `{ analyzedFiles: string[]; skippedFiles: string[]; cleanup: CleanupResult; regeneratedDirs: string[]; baseCommit: string; currentCommit: string; dryRun: boolean; }`.
*   `UpdateProgress`: Defines `{ onFileStart?: (path: string, status: 'analyzing' | 'skipping') => void; onFileDone?: (path: string, status: 'analyzed' | 'skipped' | 'error') => void; onCleanup?: (path: string, type: 'sum' | 'agents-md') => void; onDirRegenerate?: (path: string) => void; }`.

## Behavioral Contracts
*   `GENERATED_FILES: Set<string>`: Designates `AGENTS.md` and `CLAUDE.md` as non-source files, influencing `cleanupEmptyDirectoryDocs` behavior.
*   `deleteIfExists(filePath: string, dryRun: boolean): Promise<boolean>`: Executes file deletion based on `filePath`, simulating the action when `dryRun` is `true`.
*   Source file detection by `cleanupEmptyDirectoryDocs`: Excludes hidden files, `.sum`-suffixed files, members of `GENERATED_FILES`, or `AGENTS.{variant}.md` when identifying source files.
*   `dryRun` parameter: In `cleanupOrphans`, `cleanupEmptyDirectoryDocs`, and `deleteIfExists`, `dryRun` set to `true` simulates file operations without actual modification.

## File Relationships
*   `index.ts` serves as the entry point, re-exporting symbols from `orphan-cleaner.ts` and `types.ts`.
*   `orphan-cleaner.ts` utilizes `node:fs/promises` and `node:path` for file system operations.
*   `orphan-cleaner.ts` depends on `getSumPath` and `getAnnexPath` from `../generation/writers/sum.js` for sum file path derivation.
*   `orphan-cleaner.ts` and `types.ts` both depend on the `FileChange` type from `../change-detection/types.js`.
*   `orphan-cleaner.ts` also depends on `CleanupResult` from `../update/types.js`.