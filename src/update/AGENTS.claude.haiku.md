<!-- Generated by agents-reverse-engineer v0.9.10 -->

# src/update

The update directory orchestrates incremental documentation regeneration by detecting file changes, managing affected directories, and cleaning up orphaned .sum and AGENTS.md files from deleted or renamed sources.

## Contents

**Orchestration & Types**
- [index.ts](./index.ts) — Re-exports `DocumentationOrchestrator` / `UpdateOrchestrator`, `createUpdateOrchestrator()`, cleanup utilities, and type contracts for plan configuration and execution results.
- [types.ts](./types.ts) — Defines `CleanupResult`, `UpdatePlanOptions`, `UpdateResult`, `UpdateProgress` callback interface for progress instrumentation during incremental updates.

**Cleanup & Detection**
- [orphan-cleaner.ts](./orphan-cleaner.ts) — Implements `cleanupOrphans()`, `cleanupEmptyDirectoryDocs()`, `getAffectedDirectories()` to remove stale .sum/.annex.sum files and AGENTS.md when sources are deleted/renamed.

## Update Workflow

Incremental updates follow a three-phase pattern:

1. **Change Detection**: Correlates file deletions/renames with their documentation via `FileChange` from `../change-detection/types.js`.
2. **Orphan Cleanup**: `cleanupOrphans()` deletes .sum/.annex.sum for deleted/renamed sources; `cleanupEmptyDirectoryDocs()` removes AGENTS.md if no source files remain in a directory.
3. **Affected Path Computation**: `getAffectedDirectories()` identifies all parent directory paths (up to root) requiring AGENTS.md regeneration.

Progress is tracked via `UpdateProgress` callbacks: `onFileStart`, `onFileDone`, `onCleanup` (for .sum/.agents-md deletions), `onDirRegenerate` (for AGENTS.md regeneration).

## Cleanup Semantics

**GENERATED_FILES Set**: `['AGENTS.md', 'CLAUDE.md']` — constant excluded from source file counting; directory is "empty" only when no non-generated source files remain.

**Source Detection**: A file counts as a source if not hidden (no leading dot), not a `.sum` file, not in GENERATED_FILES, and does not match AGENTS.*.md pattern.

**Dry-run Mode**: When `dryRun=true`, `cleanupEmptyDirectoryDocs()` skips filesystem mutations but returns `true` to indicate what would be deleted; `cleanupOrphans()` tracks all would-be deletions in `CleanupResult` without writing to disk.

**Variant Support**: Both cleanup and orchestration accept optional `variant` parameter (e.g., "v2") to handle per-variant .sum and AGENTS.md files simultaneously.

## Type Contracts

**UpdateResult** aggregates outcomes: `analyzedFiles[]`, `skippedFiles[]`, `cleanup: CleanupResult`, `regeneratedDirs[]`, git state via `baseCommit`, `currentCommit`, and `dryRun` flag.

**UpdatePlanOptions** configures scope: `includeUncommitted` (track uncommitted changes), `dryRun`, `variant`.

**CleanupResult** tracks deletion artifacts: `deletedSumFiles[]`, `deletedAgentsMd[]`.