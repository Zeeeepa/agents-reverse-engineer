---
generated_at: 2026-02-09T17:46:19.129Z
content_hash: e12473df086ec99a89ddbef7f84ffa9766f5e35ded335bfdc318fd153d1fb24b
purpose: UpdateOrchestrator coordinates incremental documentation updates via SHA-256 content hash comparison stored in .sum f...
---
**UpdateOrchestrator coordinates incremental documentation updates via SHA-256 content hash comparison stored in .sum file YAML frontmatter, orchestrating file change detection, orphan cleanup, and affected directory tracking without requiring git diff parsing.**

## Exported Interface

**UpdateOrchestrator** class constructor accepts `Config`, `projectRoot: string`, `options?: { tracer?: ITraceWriter; debug?: boolean }`. Exposes methods:

- `checkPrerequisites(): Promise<void>` — throws if `projectRoot` is not a git repository via `isGitRepo()`
- `preparePlan(options?: UpdateOptions): Promise<UpdatePlan>` — discovers all source files via `runDiscovery()`, reads existing `.sum` files via `readSumFile()`, compares stored `content_hash` from YAML frontmatter against `computeContentHash()` output, returns `UpdatePlan` with `filesToAnalyze` (added/modified), `filesToSkip` (unchanged hashes), `cleanup` (orphaned `.sum` files), `affectedDirs` (sorted by depth descending), `currentCommit`, `isFirstRun` flag
- `recordFileAnalyzed(relativePath: string, contentHash: string, currentCommit: string): Promise<void>` — no-op, kept for API compatibility (hash stored in `.sum` frontmatter)
- `removeFileState(relativePath: string): Promise<void>` — no-op, kept for API compatibility
- `recordRun(commitHash: string, filesAnalyzed: number, filesSkipped: number): Promise<number>` — no-op returning `0`, kept for API compatibility
- `getLastRun(): Promise<undefined>` — returns `undefined` (no run history in frontmatter mode), kept for API compatibility
- `isFirstRun(): Promise<boolean>` — checks if any `.sum` files exist by calling `preparePlan({ dryRun: true })`
- `close(): void` — no-op, kept for API compatibility

**createUpdateOrchestrator** factory function returns new `UpdateOrchestrator` instance.

## UpdatePlan Structure

`UpdatePlan` interface defines:
- `filesToAnalyze: FileChange[]` — files with hash mismatches or missing `.sum` files, status `'added'` or `'modified'`
- `filesToSkip: string[]` — relative paths where stored hash matches current `computeContentHash()` result
- `cleanup: CleanupResult` — output from `cleanupOrphans()` with `.sum` files to delete
- `affectedDirs: string[]` — unique directories needing `AGENTS.md` regeneration via `getAffectedDirectories()`, sorted by `path.sep` depth descending (deepest first)
- `baseCommit: string` — not used in frontmatter mode, kept for compatibility, set to `currentCommit`
- `currentCommit: string` — SHA from `getCurrentCommit()`
- `isFirstRun: boolean` — true when `filesToSkip.length === 0 && filesToAnalyze.length > 0`

## Change Detection Algorithm

`preparePlan()` executes:

1. Calls `checkPrerequisites()` to verify git repository
2. Obtains `currentCommit` via `getCurrentCommit(projectRoot)`
3. Discovers all source files via `runDiscovery()`, converts absolute paths to relative via `path.relative(projectRoot, f)`
4. Iterates each file:
   - Computes `sumPath` via `getSumPath(filePath)`
   - Adds `sumPath` to `seenSumFiles` set for orphan detection
   - Calls `readSumFile(sumPath)` returning `SumFileContent | null`
   - If no `.sum` exists, adds to `filesToAnalyze` with `status: 'added'`
   - If `.sum` exists, calls `computeContentHash(filePath)` and compares against `sumContent.contentHash`
   - Hash mismatch or missing hash → adds to `filesToAnalyze` with `status: 'modified'`
   - Hash match → adds to `filesToSkip`
5. Calls `cleanupOrphans(projectRoot, deletedOrRenamed, options.dryRun ?? false)` returning `CleanupResult`
6. Calls `getAffectedDirectories(filesToAnalyze)` returning `Set<string>`, converts to sorted array via depth descending comparator
7. Emits `plan:created` trace event with `fileCount`, `taskCount: filesToAnalyze.length + affectedDirs.length`

## Trace Event Emissions

`preparePlan()` emits:
- `phase:start` with `phase: 'update-plan-creation'`, `taskCount: 0`, `concurrency: 1`
- `plan:created` with `planType: 'update'`, `fileCount: filesToAnalyze.length`, `taskCount: filesToAnalyze.length + affectedDirs.length`
- `phase:end` with `phase: 'update-plan-creation'`, `durationMs` computed via `process.hrtime.bigint()` delta, `tasksCompleted: 1`, `tasksFailed: 0`

## Integration Points

Depends on:
- `discoverFiles` from `../discovery/run.js` returning `FilterResult` with `.included: string[]` absolute paths
- `readSumFile` from `../generation/writers/sum.js` parsing YAML frontmatter, returning `SumFileContent` with `contentHash: string`
- `getSumPath` from `../generation/writers/sum.js` computing `.sum` file path from source file path
- `computeContentHash` from `../change-detection/index.js` returning SHA-256 hex string
- `cleanupOrphans` from `./orphan-cleaner.js` accepting `projectRoot`, `deletedOrRenamed: FileChange[]`, `dryRun: boolean`, returning `CleanupResult`
- `getAffectedDirectories` from `./orphan-cleaner.js` returning `Set<string>` of unique parent directories

## Debug Logging

When `debug: true`, writes to `console.error` via `pc.dim()`:
- `[debug] Creating update plan with change detection...`
- `[debug] Git commit: <currentCommit.slice(0, 7)>`
- `[debug] Discovering files...`
- `[debug] Change detection: N changed, N unchanged, N orphaned`
- `[debug] Affected directories: N`

## API Compatibility No-Ops

Methods retained for backward compatibility but perform no operations in frontmatter-based mode:
- `recordFileAnalyzed` — hash stored in `.sum` YAML frontmatter by generation phase
- `removeFileState` — `.sum` file cleanup handled by `cleanupOrphans()`
- `recordRun` — no run history database in frontmatter mode
- `getLastRun` — returns `undefined`, no run history available
- `close` — no resources to dispose

## Error Handling

`checkPrerequisites()` throws `Error` with message `'Not a git repository: <projectRoot>\nThe update command requires a git repository for change detection.'` when `isGitRepo()` returns `false`.

File iteration in `preparePlan()` catches exceptions from `readSumFile()` or `computeContentHash()` and adds file to `filesToSkip` on error.