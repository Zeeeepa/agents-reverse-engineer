---
generated_at: 2026-02-09T16:11:35.254Z
content_hash: e12473df086ec99a89ddbef7f84ffa9766f5e35ded335bfdc318fd153d1fb24b
purpose: UpdateOrchestrator coordinates frontmatter-based incremental documentation updates by comparing SHA-256 content hashe...
---
**UpdateOrchestrator coordinates frontmatter-based incremental documentation updates by comparing SHA-256 content hashes in `.sum` file YAML frontmatter against current file content, cleaning orphaned artifacts, and tracking affected directories for `AGENTS.md` regeneration.**

## Exported Symbols

**UpdateOrchestrator** — Class managing incremental update workflow with methods:
- `constructor(config: Config, projectRoot: string, options?: { tracer?: ITraceWriter; debug?: boolean })`
- `close(): void` — No-op for API compatibility (no database resources to clean)
- `checkPrerequisites(): Promise<void>` — Throws if `projectRoot` is not a git repository via `isGitRepo()`
- `preparePlan(options?: UpdateOptions): Promise<UpdatePlan>` — Computes which files need re-analysis by hash comparison
- `recordFileAnalyzed(_relativePath: string, _contentHash: string, _currentCommit: string): Promise<void>` — No-op (hash stored in frontmatter)
- `removeFileState(_relativePath: string): Promise<void>` — No-op for API compatibility
- `recordRun(_commitHash: string, _filesAnalyzed: number, _filesSkipped: number): Promise<number>` — No-op returning 0
- `getLastRun(): Promise<undefined>` — No-op returning undefined (no run history in frontmatter mode)
- `isFirstRun(): Promise<boolean>` — Returns true if no `.sum` files exist

**createUpdateOrchestrator**(config: Config, projectRoot: string, options?: { tracer?: ITraceWriter; debug?: boolean }): UpdateOrchestrator — Factory function instantiating UpdateOrchestrator.

**UpdatePlan** — Interface defining update strategy:
```typescript
{
  filesToAnalyze: FileChange[];    // Added/modified files needing re-analysis
  filesToSkip: string[];            // Unchanged files (hash match)
  cleanup: CleanupResult;           // Orphaned .sum files to delete
  affectedDirs: string[];           // Directories needing AGENTS.md regeneration
  baseCommit: string;               // Current commit (not used, kept for compatibility)
  currentCommit: string;            // Current commit SHA
  isFirstRun: boolean;              // True if no .sum files exist
}
```

## Hash-Based Change Detection Algorithm

**preparePlan()** executes frontmatter-based change detection:
1. Calls `checkPrerequisites()` to verify git repository exists
2. Calls `getCurrentCommit()` to retrieve HEAD commit SHA
3. Invokes `discoverFiles()` which wraps `runDiscovery()` from `discovery/run.js`, converting absolute paths to relative via `path.relative()`
4. For each discovered file, calls `getSumPath()` to locate corresponding `.sum` file
5. Reads `.sum` frontmatter via `readSumFile()` to extract `contentHash` field
6. Computes current file hash via `computeContentHash()` (SHA-256)
7. Hash mismatch or missing `.sum` → adds `FileChange` with `status: 'added'` or `'modified'` to `filesToAnalyze`
8. Hash match → adds path to `filesToSkip`
9. Calls `cleanupOrphans()` to delete `.sum` files for non-existent source files
10. Calls `getAffectedDirectories()` to compute directory set from `filesToAnalyze`
11. Sorts `affectedDirs` by depth descending via `split(path.sep).length` comparison (deepest first for bottom-up regeneration)

## Trace Event Emission

Emits trace events via `ITraceWriter` interface:
- `phase:start` with `phase: 'update-plan-creation'` at start of `preparePlan()`
- `plan:created` with `planType: 'update'`, `fileCount: filesToAnalyze.length`, `taskCount: filesToAnalyze.length + affectedDirs.length`
- `phase:end` with `phase: 'update-plan-creation'`, `durationMs` computed via `process.hrtime.bigint()` delta, `tasksCompleted: 1`, `tasksFailed: 0`

## Debug Logging

When `debug: true` passed to constructor, emits `picocolors.dim()` formatted messages to stderr:
- `'[debug] Creating update plan with change detection...'` at start
- `'[debug] Git commit: <hash>'` showing first 7 characters of commit SHA
- `'[debug] Discovering files...'` before discovery phase
- `'[debug] Change detection: <changed> changed, <unchanged> unchanged, <orphaned> orphaned'` after comparison
- `'[debug] Affected directories: <count>'` showing directory regeneration scope

## Integration Points

- **change-detection/index.js** — Imports `isGitRepo()`, `getCurrentCommit()`, `computeContentHash()`, `FileChange` type
- **generation/writers/sum.js** — Imports `readSumFile()`, `getSumPath()` for frontmatter parsing and path resolution
- **update/orphan-cleaner.js** — Imports `cleanupOrphans()`, `getAffectedDirectories()` for artifact cleanup and directory tracking
- **discovery/run.js** — Imports `discoverFiles()` wrapping `runDiscovery()` for file scanning
- **config/schema.js** — Accepts `Config` type defining exclude patterns and concurrency settings
- **orchestration/trace.js** — Optional `ITraceWriter` dependency for NDJSON event emission

## API Compatibility Pattern

Several methods are no-ops with comment `// Kept for API compatibility`:
- `close()` — No database resources in frontmatter mode (previous SQLite implementation removed)
- `recordFileAnalyzed()` — Hash now stored in `.sum` YAML frontmatter instead of database
- `removeFileState()` — `.sum` file cleanup handled by `cleanupOrphans()`
- `recordRun()` — No run history tracking in frontmatter mode
- `getLastRun()` — Returns undefined (no historical run data)

These preserve interface contract for consumers expecting SQLite-based state management from earlier versions.

## First Run Detection

`isFirstRun()` calls `preparePlan({ dryRun: true })` and checks if `filesToSkip.length === 0 && filesToAnalyze.length > 0`, indicating no existing `.sum` files with valid hashes.