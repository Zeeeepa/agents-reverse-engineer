---
generated_at: 2026-02-09T14:10:11.291Z
content_hash: e12473df086ec99a89ddbef7f84ffa9766f5e35ded335bfdc318fd153d1fb24b
purpose: UpdateOrchestrator coordinates incremental documentation updates by comparing SHA-256 content hashes from `.sum` file...
---
**UpdateOrchestrator coordinates incremental documentation updates by comparing SHA-256 content hashes from `.sum` file YAML frontmatter against current file content, detecting changes without git diff, and tracking affected directories for `AGENTS.md` regeneration.**

## Exported Interface

**`UpdateOrchestrator`** class orchestrates frontmatter-based change detection with constructor signature `(config: Config, projectRoot: string, options?: { tracer?: ITraceWriter; debug?: boolean })`. Exposes methods:
- `checkPrerequisites(): Promise<void>` — validates git repository existence via `isGitRepo()`
- `preparePlan(options?: UpdateOptions): Promise<UpdatePlan>` — discovers files, compares `content_hash` frontmatter against `computeContentHash()`, returns `UpdatePlan` with `filesToAnalyze: FileChange[]`, `filesToSkip: string[]`, `cleanup: CleanupResult`, `affectedDirs: string[]` sorted by depth descending
- `close(): void` — no-op API compatibility stub (no database in frontmatter mode)
- `recordFileAnalyzed()`, `removeFileState()`, `recordRun()`, `getLastRun()`, `isFirstRun()` — no-op/stub methods preserved for API compatibility with previous git-diff-based implementation

**`createUpdateOrchestrator(config, projectRoot, options?)`** factory function instantiates `UpdateOrchestrator`.

**`UpdatePlan`** interface contains `filesToAnalyze: FileChange[]` (added/modified files), `filesToSkip: string[]` (unchanged via hash match), `cleanup: CleanupResult` (orphaned `.sum` files from `cleanupOrphans()`), `affectedDirs: string[]` (directories needing `AGENTS.md` regeneration), `baseCommit/currentCommit: string`, `isFirstRun: boolean` (true when `filesToSkip.length === 0`).

## Change Detection Algorithm

**Hash-based comparison** replaces git diff: `readSumFile(sumPath)` extracts `contentHash` from YAML frontmatter, `computeContentHash(filePath)` calculates current SHA-256, mismatch triggers `filesToAnalyze.push({ path, status: 'modified' })`. Missing `.sum` files produce `status: 'added'`. Hash match adds file to `filesToSkip[]`.

**Orphan cleanup** via `cleanupOrphans(projectRoot, deletedOrRenamed, dryRun)` removes `.sum` files for non-existent source files. Tracks `seenSumFiles` Set during discovery to identify stale artifacts.

**Affected directories** computed via `getAffectedDirectories(filesToAnalyze)`, sorted by `split(path.sep).length` descending (deepest-first post-order traversal) for `AGENTS.md` regeneration from children to parents.

## Trace Instrumentation

Emits `phase:start` event with `phase: 'update-plan-creation'` at `preparePlan()` entry, `plan:created` event with `planType: 'update'`, `fileCount`, `taskCount` (files + directories) after plan construction, `phase:end` event with `durationMs` from `process.hrtime.bigint()` nanosecond delta. Uses optional `ITraceWriter` from constructor options.

## File Discovery Integration

Calls `runDiscovery(projectRoot, config, { tracer, debug })` from `src/discovery/run.ts`, converts absolute paths to relative via `path.relative(projectRoot, f)` for consistent hash storage and comparison.

## Git Prerequisite

`checkPrerequisites()` throws `Error` if `isGitRepo()` returns false, despite frontmatter mode not requiring git for hash comparison. Requirement exists for `getCurrentCommit()` call that populates `UpdatePlan.currentCommit` (legacy compatibility field).

## Debug Logging

Conditional `console.error(pc.dim(...))` calls when `this.debug === true` report plan creation start, git commit SHA (7-char prefix), file discovery, change detection counts (`changed/unchanged/orphaned`), affected directory count.

## API Compatibility Stubs

Multiple no-op methods (`recordFileAnalyzed`, `removeFileState`, `recordRun`, `getLastRun`) preserved from previous database-backed implementation. Comments indicate "no-op in frontmatter mode" and "kept for API compatibility". `close()` method exists but performs no cleanup.