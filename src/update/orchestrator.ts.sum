---
generated_at: 2026-02-09T15:08:32.027Z
content_hash: e12473df086ec99a89ddbef7f84ffa9766f5e35ded335bfdc318fd153d1fb24b
purpose: UpdateOrchestrator coordinates incremental documentation updates via frontmatter-based SHA-256 content hash compariso...
---
**UpdateOrchestrator coordinates incremental documentation updates via frontmatter-based SHA-256 content hash comparison, skipping unchanged files and regenerating only modified `.sum` files and affected `AGENTS.md` directories.**

## Exported Types and Interfaces

`UpdatePlan` interface defines the shape of update preparation results:
- `filesToAnalyze: FileChange[]` — files with hash mismatches or missing `.sum` files
- `filesToSkip: string[]` — files with matching content hashes
- `cleanup: CleanupResult` — orphaned `.sum` files to delete
- `affectedDirs: string[]` — directories needing `AGENTS.md` regeneration (sorted by depth descending)
- `baseCommit: string` — current commit (unused in frontmatter mode, kept for compatibility)
- `currentCommit: string` — HEAD commit hash
- `isFirstRun: boolean` — true when no `.sum` files exist

## Primary Export

`UpdateOrchestrator` class constructor accepts `config: Config`, `projectRoot: string`, and optional `{ tracer?: ITraceWriter; debug?: boolean }`. Stores references in private fields for use across methods.

`createUpdateOrchestrator()` factory function instantiates `UpdateOrchestrator` with same parameters.

## Core Workflow Method

`preparePlan(options?: UpdateOptions): Promise<UpdatePlan>` executes frontmatter-based change detection:
1. Emits `phase:start` trace event with `phase: 'update-plan-creation'`
2. Calls `checkPrerequisites()` to verify git repository via `isGitRepo()`
3. Invokes `getCurrentCommit()` to capture HEAD commit hash
4. Calls `discoverFiles()` to get all source files via `runDiscovery()`, converting absolute paths to relative
5. Iterates discovered files, for each:
   - Calls `getSumPath()` to compute `.sum` file path
   - Invokes `readSumFile()` to parse YAML frontmatter
   - Calls `computeContentHash()` to hash current file content
   - Compares `sumContent.contentHash` against current hash
   - Pushes to `filesToAnalyze` with `status: 'added'` if no `.sum` exists
   - Pushes to `filesToAnalyze` with `status: 'modified'` if hash mismatch
   - Pushes to `filesToSkip` if hashes match
6. Invokes `cleanupOrphans()` with empty `deletedOrRenamed` array (orphan detection via filesystem scan)
7. Calls `getAffectedDirectories()` on `filesToAnalyze` to compute directory set
8. Sorts `affectedDirs` by depth descending via `split(path.sep).length` comparison
9. Emits `plan:created` trace event with `fileCount` and `taskCount` (files + directories)
10. Emits `phase:end` trace event with duration computed via `hrtime.bigint()`
11. Returns `UpdatePlan` with `isFirstRun` set when `filesToSkip.length === 0`

## Supporting Methods

`checkPrerequisites()` async method throws `Error` if `isGitRepo()` returns false, blocking update workflow for non-git projects.

`discoverFiles()` private async method calls `runDiscovery()` with `this.projectRoot`, `this.config`, and `{ tracer, debug }` options, then maps absolute paths to relative via `path.relative()`.

`close()` no-op method exists for API compatibility (no database in frontmatter mode).

`recordFileAnalyzed()`, `removeFileState()`, `recordRun()` async methods are no-ops (hash stored in `.sum` frontmatter, not external state).

`getLastRun()` async method returns `undefined` (no run history in frontmatter mode).

`isFirstRun()` async method calls `preparePlan({ dryRun: true })` and returns `plan.isFirstRun`.

## Dependencies and Integration

Imports `isGitRepo`, `getCurrentCommit`, `computeContentHash`, `FileChange` from `../change-detection/index.js` for git operations and SHA-256 hashing.

Imports `cleanupOrphans`, `getAffectedDirectories` from `./orphan-cleaner.js` for stale `.sum` file deletion and directory dependency tracking.

Imports `readSumFile`, `getSumPath` from `../generation/writers/sum.js` for YAML frontmatter parsing and path computation.

Imports `discoverFiles as runDiscovery` from `../discovery/run.js` for gitignore-aware file walking.

Imports `Config` from `../config/schema.js`, `ITraceWriter` from `../orchestration/trace.js`, `UpdateOptions`, `CleanupResult` from `./types.js`.

Uses `picocolors` (`pc.dim()`) for debug logging when `this.debug === true`.

## Trace Events

Emits `phase:start` with `type: 'update-plan-creation'`, `taskCount: 0`, `concurrency: 1` at plan start.

Emits `plan:created` with `planType: 'update'`, `fileCount`, `taskCount` (sum of files and directories) after plan computation.

Emits `phase:end` with `phase: 'update-plan-creation'`, `durationMs`, `tasksCompleted: 1`, `tasksFailed: 0` after plan finalization.

## Algorithm Details

Change detection uses SHA-256 content hashing: reads `content_hash` from `.sum` YAML frontmatter, compares against `computeContentHash()` output. Hash mismatch triggers re-analysis. Missing `.sum` files treated as new files with `status: 'added'`.

Affected directory computation walks parent directories of each changed file via `getAffectedDirectories()`, returning set of unique directory paths. Depth-descending sort ensures child directories processed before parents during `AGENTS.md` regeneration (post-order traversal pattern).

First-run detection heuristic: if `filesToSkip.length === 0` and `filesToAnalyze.length > 0`, no existing `.sum` files exist, signaling initial generation workflow.