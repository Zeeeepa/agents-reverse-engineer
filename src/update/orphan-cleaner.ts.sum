---
generated_at: 2026-02-09T16:11:24.470Z
content_hash: c0b2afdea7b5cf019d45bff398962317566ac087fde3ddfa890cd2f97b14adb5
purpose: orphan-cleaner.ts deletes stale `.sum` files and `AGENTS.md` files for deleted/renamed source files and empty directo...
---
**orphan-cleaner.ts deletes stale `.sum` files and `AGENTS.md` files for deleted/renamed source files and empty directories.**

## Exported Functions

**`cleanupOrphans(projectRoot: string, changes: FileChange[], dryRun?: boolean): Promise<CleanupResult>`** orchestrates cleanup by extracting paths from `FileChange[]` where `status === 'deleted'` or `status === 'renamed'` (using `oldPath` for renames), deleting corresponding `.sum` files via `deleteIfExists()`, collecting affected directories via `path.dirname()`, and delegating empty directory cleanup to `cleanupEmptyDirectoryDocs()`. Returns `CleanupResult` with `deletedSumFiles[]` and `deletedAgentsMd[]` arrays.

**`cleanupEmptyDirectoryDocs(dirPath: string, dryRun?: boolean): Promise<boolean>`** reads directory via `readdir()`, filters entries to detect source files (excluding hidden files starting with `.`, `.sum` extensions, and `GENERATED_FILES` set members `'AGENTS.md'` and `'CLAUDE.md'`), and deletes `AGENTS.md` via `deleteIfExists()` if no source files remain. Returns `true` if `AGENTS.md` was deleted.

**`getAffectedDirectories(changes: FileChange[]): Set<string>`** extracts unique parent directories from non-deleted `FileChange` entries by walking up directory tree via `path.dirname()` until reaching `.` (root). Skips files with `status === 'deleted'` since deleted files don't affect directory documentation. Always includes `'.'` as root directory in returned set.

## Cleanup Logic

**Orphan detection** operates on two categories: `.sum` files at old paths for deleted source files (appends `.sum` to `change.path`), and `.sum` files at `oldPath` for renames (appends `.sum` to `change.oldPath`). Directory cleanup targets directories where all remaining entries are hidden files, `.sum` files, or members of `GENERATED_FILES` constant.

**`deleteIfExists(filePath: string, dryRun: boolean): Promise<boolean>`** internal helper calls `stat()` to check existence, `unlink()` to delete (unless `dryRun === true`), returns `true` if file existed (or would be deleted in dry run), returns `false` if `stat()` throws.

## Integration Points

Consumes `FileChange` from `src/change-detection/types.ts` with discriminated `status` field (`'added' | 'modified' | 'deleted' | 'renamed'`) and optional `oldPath` string for renames. Returns `CleanupResult` from `src/update/types.ts` with relative path arrays for deleted artifacts. Called by `orchestrateUpdate()` in `src/update/orchestrator.ts` after change detection and before Phase 2 directory aggregation.