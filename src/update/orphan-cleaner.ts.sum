---
generated_at: 2026-02-09T21:30:32.448Z
content_hash: ca54d510ba9e5a5a6c0918f7fc45a080d51cfb24c929540b6f38fa342fa6a753
purpose: orphan-cleaner.ts deletes stale `.sum` files, `.annex.md` files, and `AGENTS.md` files when source files are deleted ...
---
**orphan-cleaner.ts deletes stale `.sum` files, `.annex.md` files, and `AGENTS.md` files when source files are deleted or renamed, ensuring documentation artifacts match the current codebase structure.**

## Exported Functions

**`cleanupOrphans(projectRoot: string, changes: FileChange[], dryRun: boolean = false): Promise<CleanupResult>`** — Deletes `.sum` and `.annex.md` files for deleted or renamed source files, then removes `AGENTS.md` from directories that no longer contain source files. Processes `FileChange` entries with `status === 'deleted'` or `status === 'renamed'`, adding their paths (or `oldPath` for renames) to cleanup queue. Returns `CleanupResult` containing `deletedSumFiles[]` and `deletedAgentsMd[]` arrays with relative paths of removed files.

**`cleanupEmptyDirectoryDocs(dirPath: string, dryRun: boolean = false): Promise<boolean>`** — Checks if directory contains any source files by reading entries via `readdir()`, filtering out hidden files (starting with `.`), `.sum` files, `.annex.md` files, and entries in `GENERATED_FILES` set. Returns `true` if `AGENTS.md` was deleted, `false` otherwise. Used to remove directory-level documentation when no source files remain.

**`getAffectedDirectories(changes: FileChange[]): Set<string>`** — Extracts parent directory paths from non-deleted `FileChange` entries by walking up via `path.dirname()` until reaching root (`.`). Skips changes with `status === 'deleted'` since deleted files don't require directory doc regeneration. Returns `Set<string>` of relative directory paths that need `AGENTS.md` regeneration during incremental updates.

## Private Implementation

**`deleteIfExists(filePath: string, dryRun: boolean): Promise<boolean>`** — Calls `stat()` to check file existence, then `unlink()` if not in dry-run mode. Returns `true` if file existed (regardless of actual deletion), `false` if `stat()` throws. Swallows all errors via empty catch block.

**`GENERATED_FILES`** — `Set` containing `'AGENTS.md'` and `'CLAUDE.md'`, used by `cleanupEmptyDirectoryDocs()` to distinguish generated documentation from source files during directory emptiness checks.

## Cleanup Logic

**Deletion triggers:** For each `FileChange` with `status === 'deleted'`, constructs `.sum` and `.annex.md` paths via `path.join(projectRoot, \`${relativePath}.sum\`)`. For `status === 'renamed'` changes, targets `oldPath` instead of `path` to remove artifacts at previous location.

**Directory cleanup strategy:** Collects affected directories via `path.dirname()` of each cleaned path, skipping root directory (`.`). For each affected directory, calls `cleanupEmptyDirectoryDocs()` to remove `AGENTS.md` if no source files remain. Source file detection excludes hidden files (`entry.startsWith('.')`) + `.sum` + `.annex.md` + `GENERATED_FILES` entries.

**Dry-run support:** When `dryRun === true`, skips `unlink()` calls but still executes `stat()` checks and returns `true` for would-be deletions. Used for preview mode in update workflow.

## Integration Context

Invoked by `src/update/orchestrator.ts` after change detection to remove stale artifacts before regenerating modified files. Paired with `getAffectedDirectories()` to compute which directories need `AGENTS.md` regeneration during Phase 2 of incremental update workflow. Return value `CleanupResult` logged to `.agents-reverse-engineer/progress.log` for user visibility into cleanup operations.