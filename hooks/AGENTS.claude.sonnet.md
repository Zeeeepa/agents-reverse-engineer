<!-- Generated by agents-reverse-engineer v1.1.0 -->

# hooks

Runtime hook extensions for AI coding assistants (Claude Code, OpenCode) that provide background version checking and automatic context injection via `PostToolUse` events and `session.created` handlers.

## Contents

### Version Checking

- [`are-check-update.js`](./are-check-update.js): Claude Code hook spawning detached `spawn(process.execPath, ['-e', inlineScript])` subprocess on session start to fetch `npm view agents-reverse-engineer version` (10s timeout), cache `{update_available, installed, latest, checked}` JSON to `~/.claude/cache/are-update-check.json`. Reads installed version from `.claude/ARE-VERSION` (local) → `~/.claude/ARE-VERSION` (global) → `'0.0.0'`.
- [`opencode-are-check-update.js`](./opencode-are-check-update.js): OpenCode `session.created` event handler exporting `AreCheckUpdate(ctx)` factory, spawns same detached process pattern writing cache to `~/.config/opencode/cache/are-update-check.json`. Resolves version from `.opencode/ARE-VERSION` (local) → `~/.config/opencode/ARE-VERSION` (global).

### Context Injection

- [`are-context-loader.js`](./are-context-loader.js): `PostToolUse` hook parsing `tool_input.file_path` from Read tool calls, walks parent directories from file location to `data.cwd`, collects unseen `AGENTS.md` files (sentinel: `content.includes('Generated by agents-reverse-engineer')`), emits `hookSpecificOutput.additionalContext` with `## ARE Context: {relDir}/AGENTS.md` sections. Deduplicates via `{os.tmpdir()}/are-context-loader/{session_id}.json`, skips project root (assumes `CLAUDE.md → @AGENTS.md` already loaded).

## Architecture

**Version Checking Workflow**: Hooks triggered on session start (`session.created` for OpenCode, implicit for Claude Code) spawn non-blocking Node.js processes via `spawn` with `{stdio: 'ignore', detached: true, windowsHide: true}`, call `child.unref()` for fire-and-forget execution. Version resolution uses fallback chain (local config → global config → `'0.0.0'`), executes `npm view` via `execSync` with 10s timeout, writes JSON cache with Unix timestamp (`Math.floor(Date.now() / 1000)`).

**Context Injection Workflow**: `are-context-loader.js` listens for `PostToolUse` events, parses stdin JSON, extracts `tool_input.file_path`, performs parent directory traversal via repeated `path.dirname()` until reaching `data.cwd`. For each directory, reads `AGENTS.md` if exists, checks ARE sentinel, deduplicates against session-scoped temp file. Outputs structured JSON with `suppressOutput: false` and `hookSpecificOutput.additionalContext` containing markdown sections in root-to-leaf order.

## Behavioral Contracts

**Cache Paths**:
- Claude Code: `~/.claude/cache/are-update-check.json`, `~/.claude/cache/npm-cache/`
- OpenCode: `~/.config/opencode/cache/are-update-check.json`, `~/.config/opencode/cache/npm-cache/`
- Context loader dedup: `{os.tmpdir()}/are-context-loader/{session_id}.json`

**Version File Paths**:
- Claude Code local: `.claude/ARE-VERSION`
- Claude Code global: `~/.claude/ARE-VERSION`
- OpenCode local: `.opencode/ARE-VERSION`
- OpenCode global: `~/.config/opencode/ARE-VERSION`

**Cache Schema** (`are-update-check.json`):
```json
{
  "update_available": boolean,
  "installed": string,
  "latest": string,
  "checked": number
}
```

**ARE Sentinel**: `content.includes('Generated by agents-reverse-engineer')` (version-agnostic)

**Subprocess Options**:
```javascript
{
  stdio: 'ignore',
  detached: true,
  windowsHide: true
}
```

**NPM Command**: `execSync('npm view agents-reverse-engineer version', {timeout: 10000})`

**Context Loader Output**:
```javascript
{
  suppressOutput: false,
  hookSpecificOutput: {
    hookEventName: 'PostToolUse',
    additionalContext: string
  }
}
```

**Skip Conditions** (context loader):
- `!filePath.startsWith(projectRoot)`
- `startDir === projectRoot`