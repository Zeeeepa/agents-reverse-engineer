<!-- Generated by agents-reverse-engineer v1.0.1 -->

# hooks

The `hooks` directory provides runtime extensions for AI coding assistant integrations, implementing background update checks and lazy-loading context injection for `agents-reverse-engineer`.

## Contents

- [`are-check-update.js`](./are-check-update.js): Spawns detached Node process on session start to compare installed vs latest npm package version via `npm view agents-reverse-engineer version`, caches result to `~/.claude/cache/are-update-check.json` with schema `{update_available, installed, latest, checked}`.
- [`are-context-loader.js`](./are-context-loader.js): PostToolUse hook listening on stdin for Read tool events, walks parent directories from `file_path` to `projectRoot`, injects `AGENTS.md` files containing sentinel `"Generated by agents-reverse-engineer"` as `additionalContext`, deduplicates per session via `os.tmpdir()/are-context-loader/{session_id}.json`.
- [`opencode-are-check-update.js`](./opencode-are-check-update.js): OpenCode integration exporting `AreCheckUpdate({event})` handler, spawns detached process on `session.created`, reads version from `.opencode/ARE-VERSION`, writes cache to `~/.config/opencode/cache/are-update-check.json`.

## Architecture

Hooks operate as independent processes communicating via JSON over stdio (for `are-context-loader.js`) or as fire-and-forget background jobs (update checkers). `are-check-update.js` and `opencode-are-check-update.js` share version-checking logic but differ in config paths: Claude Code uses `~/.claude/`, OpenCode uses `~/.config/opencode/`. Context loader implements session-scoped deduplication by maintaining visited directory state in temp files keyed by `session_id`.

## Execution Model

Update checkers invoke `spawn(process.execPath, ['-e', inlineScript])` with `{stdio: 'ignore', detached: true, windowsHide: true}` followed by `child.unref()` for true background execution. Context loader runs synchronously within Claude Code's PostToolUse lifecycle, emitting `{hookSpecificOutput: {hookEventName: "PostToolUse", additionalContext}}` to stdout.

## Version Resolution

Checks local `.claude/ARE-VERSION` or `.opencode/ARE-VERSION` in `process.cwd()` (project install), falls back to global `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`, defaults to `'0.0.0'`. Fetches latest via `execSync('npm view agents-reverse-engineer version')` with 10s timeout.

## Context Injection Strategy

From Read tool `file_path`, `are-context-loader.js` traverses parent directories bottom-up, collects unvisited dirs containing `AGENTS.md` with generation sentinel, reverses to root-to-leaf order, concatenates as `"## ARE Context: {relDir}/AGENTS.md\n\n{content}"`. Skips `projectRoot` to avoid duplication with `CLAUDE.md â†’ @AGENTS.md` indirection.

## Behavioral Contracts

- Cache file schema: `{update_available: boolean, installed: string, latest: string, checked: number}` (POSIX timestamp)
- Sentinel detection: `content.includes('Generated by agents-reverse-engineer')`
- Context header format: `"## ARE Context: " + relDir + "/AGENTS.md\n\n" + content`
- Dedup state path: `path.join(os.tmpdir(), 'are-context-loader', sessionId + '.json')`
- Spawn options: `{stdio: 'ignore', detached: true, windowsHide: true}` + `child.unref()`
- Default version fallback: `'0.0.0'` (installed), `'unknown'` (latest)
- npm command: `npm view agents-reverse-engineer version --registry=https://registry.npmjs.org/ --cache=${npmCache} --prefer-online`
- Cache directories: `~/.claude/cache/npm-cache/` (Claude Code), `~/.config/opencode/cache/npm-cache/` (OpenCode)