---
generated_at: 2026-02-09T15:08:35.213Z
content_hash: b6592de50e518a82f7185d14f371f7ccfff18a4569aa6e6fdf3d18d40b9f4d83
purpose: opencode-are-check-update.js exports AreCheckUpdate factory for OpenCode session lifecycle integration, spawning deta...
---
**opencode-are-check-update.js exports AreCheckUpdate factory for OpenCode session lifecycle integration, spawning detached background processes that compare installed ARE version against npm registry and cache results to ~/.config/opencode/cache/are-update-check.json.**

## Exported Interface

**AreCheckUpdate()** — Async factory function (default export) returning OpenCode plugin object with event handlers.

Returns object shape:
```javascript
{
  event: {
    'session.created': async () => void
  }
}
```

## Session Hook Behavior

**'session.created' handler** executes on OpenCode session start:
1. Resolves cache directory path via `join(homedir(), '.config', 'opencode', 'cache')`
2. Creates cache directory via `mkdirSync(cacheDir, { recursive: true })` if missing
3. Checks for ARE-VERSION file in two locations (project-first precedence):
   - Local: `join(cwd, '.opencode', 'ARE-VERSION')`
   - Global: `join(homedir(), '.config', 'opencode', 'ARE-VERSION')`
4. Spawns detached background Node.js process via `spawn(process.execPath, ['-e', scriptString], { stdio: 'ignore', detached: true, windowsHide: true })`
5. Background process reads installed version from ARE-VERSION file (project before global)
6. Background process queries latest version via `execSync('npm view agents-reverse-engineer version', { timeout: 10000 })`
7. Writes cache file `are-update-check.json` with structure:
   ```json
   {
     "update_available": boolean,
     "installed": string,
     "latest": string,
     "checked": number (Unix timestamp)
   }
   ```
8. Calls `child.unref()` to allow parent process termination without waiting

## Background Process Pattern

Inline script string passed to `spawn()` uses synchronous Node.js APIs (`fs.readFileSync`, `execSync`) to avoid async coordination in detached subprocess. Script re-requires `fs` and `child_process` modules via `require()` since string evaluation occurs in fresh V8 context.

Version file fallback chain: project `.opencode/ARE-VERSION` → global `~/.config/opencode/ARE-VERSION` → default `'0.0.0'`.

Network timeout of 10000ms (10 seconds) enforced on `npm view` command via `execSync` options. Errors during version check write `"unknown"` to `latest` field and set `update_available: false`.

## Integration Points

Designed for OpenCode plugin system expecting async factory functions that return event handler registrations. Mirrors functionality of `are-check-update.js` (Claude/Gemini SessionStart hook) but uses OpenCode-specific event names and directory conventions.

Cache file consumed by OpenCode UI or ARE commands to display update notifications without blocking session initialization.