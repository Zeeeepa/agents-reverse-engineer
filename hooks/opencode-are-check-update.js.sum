---
generated_at: 2026-02-09T16:11:37.260Z
content_hash: b6592de50e518a82f7185d14f371f7ccfff18a4569aa6e6fdf3d18d40b9f4d83
purpose: opencode-are-check-update.js spawns detached background process checking npm registry for agents-reverse-engineer ver...
---
**opencode-are-check-update.js spawns detached background process checking npm registry for agents-reverse-engineer version updates on OpenCode session creation, writes comparison result to `~/.config/opencode/cache/are-update-check.json`.**

## Exported Interface

- `AreCheckUpdate()` â€” Async factory returning OpenCode plugin object with `event['session.created']` handler

## Plugin Lifecycle Hook

`AreCheckUpdate()` returns plugin object with `event: { 'session.created': async () => {...} }` structure. OpenCode invokes handler when new session starts.

## Version File Resolution Strategy

Checks two locations in priority order:
1. Project-local: `<cwd>/.opencode/ARE-VERSION`
2. Global: `~/.config/opencode/ARE-VERSION`

Reads first existing file to determine installed version, defaults to `'0.0.0'` if neither exists.

## Cache Directory Creation

Constructs cache path: `join(homedir(), '.config', 'opencode', 'cache', 'are-update-check.json')`. Calls `mkdirSync(cacheDir, { recursive: true })` if directory missing via `!existsSync(cacheDir)` check.

## Detached Subprocess Pattern

Spawns background process using `spawn(process.execPath, ['-e', scriptString], { stdio: 'ignore', detached: true, windowsHide: true })`. Calls `child.unref()` to allow parent process exit without waiting. Subprocess runs Node.js inline script via `-e` flag.

## Inline Script Execution

Subprocess script uses synchronous Node.js APIs:
- `fs.readFileSync(projectVersionFile, 'utf8')` or `fs.readFileSync(globalVersionFile, 'utf8')` for installed version
- `execSync('npm view agents-reverse-engineer version', { encoding: 'utf8', timeout: 10000, windowsHide: true })` for latest registry version
- `fs.writeFileSync(cacheFile, JSON.stringify(result))` for cache persistence

## Cache Schema

Writes JSON object with shape:
```javascript
{
  update_available: boolean,  // true when latest !== installed
  installed: string,          // version from ARE-VERSION file
  latest: string,             // npm registry version or 'unknown'
  checked: number             // Unix timestamp (seconds)
}
```

## Error Handling

Try-catch blocks around `fs.readFileSync()` (version file read) and `execSync()` (npm query) prevent subprocess crash. Failed version read defaults installed to `'0.0.0'`, failed npm query sets latest to `null` (serialized as `'unknown'`).

## Platform-Specific Configuration

Uses OpenCode conventional paths:
- Config directory: `~/.config/opencode/` (not overridable by environment)
- Cache subdirectory: `.config/opencode/cache/`
- Version file: `.config/opencode/ARE-VERSION`

Contrasts with Claude (`~/.claude/`) and Gemini (`~/.gemini/`) paths in sibling hook files.

## Integration with ARE Installer

Installer writes `ARE-VERSION` file during setup (see `src/installer/operations.ts`). Hook reads this sentinel to compare against npm registry. Version file absence triggers `'0.0.0'` default, causing `update_available: true` for any published version.