---
generated_at: 2026-02-09T21:30:38.630Z
content_hash: b6592de50e518a82f7185d14f371f7ccfff18a4569aa6e6fdf3d18d40b9f4d83
purpose: OpenCode plugin factory exporting `AreCheckUpdate()` async function that returns `session.created` event handler for ...
---
**OpenCode plugin factory exporting `AreCheckUpdate()` async function that returns `session.created` event handler for background version check spawning detached Node.js subprocess writing update availability to `~/.config/opencode/cache/are-update-check.json`.**

## Exported Interface

**`AreCheckUpdate()`** — Async factory function returning plugin object with event handlers. Returns `Promise<{ event: { 'session.created': AsyncFunction } }>`.

## Event Handler Contract

The `session.created` handler executes synchronously at OpenCode session start without blocking. Implements detached background spawn pattern via `spawn(process.execPath, ['-e', scriptString], { stdio: 'ignore', detached: true, windowsHide: true }).unref()`.

## Version File Resolution

Checks two locations in priority order:
1. Project-local: `<cwd>/.opencode/ARE-VERSION`
2. Global: `~/.config/opencode/ARE-VERSION`

Reads first existing file via `readFileSync()`, defaults to `'0.0.0'` if neither exists.

## Cache File Structure

Writes JSON object to `~/.config/opencode/cache/are-update-check.json`:
```json
{
  "update_available": boolean,
  "installed": string,
  "latest": string,
  "checked": number
}
```

The `update_available` field compares `installed !== latest` after trimming whitespace. The `checked` field stores Unix timestamp via `Math.floor(Date.now() / 1000)`. The `latest` field defaults to `'unknown'` on `npm view` failure.

## NPM Registry Query

Spawned subprocess executes `npm view agents-reverse-engineer version` with `execSync()` options:
- `encoding: 'utf8'`
- `timeout: 10000` (10s)
- `windowsHide: true`

Wraps in try-catch; network/timeout failures set `latest = null` → `'unknown'` in cache output.

## Cache Directory Creation

Ensures `~/.config/opencode/cache/` exists via `mkdirSync(cacheDir, { recursive: true })` before spawning background process. Parent directories created automatically.

## Subprocess Detachment Pattern

Background script injected as inline Node.js string via `-e` flag. Uses `JSON.stringify()` to pass file path constants (`cacheFile`, `projectVersionFile`, `globalVersionFile`) from parent scope into subprocess. The `child.unref()` call allows parent process to exit without waiting for background check completion.