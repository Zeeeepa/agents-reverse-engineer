---
generated_at: 2026-02-09T14:10:06.217Z
content_hash: b6592de50e518a82f7185d14f371f7ccfff18a4569aa6e6fdf3d18d40b9f4d83
purpose: opencode-are-check-update.js exports AreCheckUpdate() async factory function that returns an OpenCode plugin for back...
---
**opencode-are-check-update.js exports AreCheckUpdate() async factory function that returns an OpenCode plugin for background version checking on session creation, writing comparison results to ~/.config/opencode/cache/are-update-check.json.**

## Exported Interface

**AreCheckUpdate()**: Async factory function returning OpenCode plugin object with event handlers.
- **Returns**: `Promise<{ event: { 'session.created': () => Promise<void> } }>`
- **Event hook**: `'session.created'` triggers background version check subprocess

## Version Check Strategy

**Version file resolution order**:
1. Project-local: `${cwd}/.opencode/ARE-VERSION`
2. Global fallback: `${homeDir}/.config/opencode/ARE-VERSION`

**Detached subprocess pattern**: `spawn(process.execPath, ['-e', scriptString], { stdio: 'ignore', detached: true, windowsHide: true }).unref()` ensures non-blocking execution.

**Subprocess logic** (inline string passed to `-e`):
- Reads installed version from ARE-VERSION via `readFileSync()` with project precedence
- Queries npm registry via `execSync('npm view agents-reverse-engineer version', { timeout: 10000 })` for latest version
- Writes cache JSON via `writeFileSync(cacheFile, JSON.stringify(result))`

**Cache schema** (are-update-check.json):
```typescript
{
  update_available: boolean,  // installed !== latest comparison
  installed: string,          // semver from ARE-VERSION or '0.0.0' default
  latest: string,             // npm registry version or 'unknown' on fetch error
  checked: number            // Unix timestamp (seconds)
}
```

## File System Operations

**Dependencies**: `fs.existsSync`, `fs.mkdirSync`, `fs.readFileSync`, `fs.writeFileSync` from 'fs'; `os.homedir`; `path.join`; `child_process.spawn`.

**Cache directory creation**: `mkdirSync(cacheDir, { recursive: true })` ensures `~/.config/opencode/cache/` exists before subprocess writes.

**Error handling**: Subprocess try-catch blocks swallow exceptions, defaulting `installed` to '0.0.0' and `latest` to null on failure.

## OpenCode Plugin Contract

**Event system**: Plugin object returns event handlers keyed by OpenCode lifecycle events ('session.created', 'session.deleted', etc.).

**Async event handler**: `'session.created'` handler is async but does not await subprocess completionâ€”spawns detached process and immediately returns.

**Runtime isolation**: Subprocess executes via `process.execPath` with `-e` flag (eval mode) running CommonJS require() context (not ES module imports).