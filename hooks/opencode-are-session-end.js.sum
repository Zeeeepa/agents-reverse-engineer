---
generated_at: 2026-02-09T17:46:14.965Z
content_hash: d96faaf817c7bc9d8b5ab3bd189a658f76e658213df6079f0cd895abe010f30c
purpose: opencode-are-session-end.js exports `AreSessionEnd` async factory returning an OpenCode plugin that triggers `npx age...
---
**opencode-are-session-end.js exports `AreSessionEnd` async factory returning an OpenCode plugin that triggers `npx agents-reverse-engineer@latest update --quiet` as a detached background process when `'session.deleted'` events fire, conditional on git working tree changes detected via `git status --porcelain`.**

## Exported API

`AreSessionEnd` â€” async factory function returning OpenCode plugin object with `event['session.deleted']` handler. No parameters. Returns `Promise<{ event: { 'session.deleted': () => Promise<void> } }>`.

## Event Handler Logic

Handler checks two disable mechanisms before executing update:
- Environment variable: exits if `process.env.ARE_DISABLE_HOOK === '1'`
- Config file: reads `.agents-reverse-engineer.yaml` via `existsSync` + `readFileSync`, exits if `config.includes('hook_enabled: false')` (substring search, no YAML parser)

Git change detection via `execSync('git status --porcelain', { encoding: 'utf-8' })` wrapped in try-catch. Returns early if `status.trim()` empty or if `execSync` throws (non-git repo or missing git binary).

## Background Process Spawning

Spawns `npx agents-reverse-engineer@latest update --quiet` via `spawn()` with detached process pattern:
```javascript
spawn('npx', ['agents-reverse-engineer@latest', 'update', '--quiet'], {
  stdio: 'ignore',
  detached: true,
})
```
Calls `.unref()` on child to allow parent process exit without waiting for completion. Prevents blocking OpenCode session close.

## OpenCode Plugin Contract

OpenCode plugins export async factory functions returning objects with `event` property mapping event names to async handlers. This module implements `'session.deleted'` lifecycle hook, equivalent to Claude/Gemini `SessionEnd` hook but using OpenCode's plugin system conventions.

## Dependencies

Imports `execSync`, `spawn` from `child_process`, `existsSync`, `readFileSync` from `fs`. No external npm dependencies.