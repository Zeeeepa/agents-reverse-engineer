---
generated_at: 2026-02-09T15:08:29.045Z
content_hash: d96faaf817c7bc9d8b5ab3bd189a658f76e658213df6079f0cd895abe010f30c
purpose: opencode-are-session-end.js exports AreSessionEnd async factory function returning OpenCode plugin that triggers `are...
---
**opencode-are-session-end.js exports AreSessionEnd async factory function returning OpenCode plugin that triggers `are update` command on session deletion when uncommitted git changes exist.**

## Exported Interface

```javascript
export const AreSessionEnd: () => Promise<{
  event: {
    'session.deleted': () => Promise<void>
  }
}>
```

AreSessionEnd returns plugin object with `event['session.deleted']` handler conforming to OpenCode plugin lifecycle API.

## Hook Lifecycle

Handler executes when OpenCode session terminates. Checks three conditions before spawning update:
1. Environment variable `ARE_DISABLE_HOOK !== '1'`
2. Config file `.agents-reverse-engineer.yaml` lacks `hook_enabled: false` substring (no YAML parser)
3. `git status --porcelain` returns non-empty output (uncommitted changes present)

Silent early return on any condition failure or git command exception (non-git repos).

## Background Execution

Spawns detached subprocess via `spawn('npx', ['agents-reverse-engineer@latest', 'update', '--quiet'], {stdio: 'ignore', detached: true})` followed by `child.unref()`. Prevents blocking session close while allowing update to persist after parent process exit.

## Dependencies

- `child_process.execSync` — synchronous git status check
- `child_process.spawn` — detached background process creation
- `fs.existsSync/readFileSync` — config file detection and substring search

## Related Hooks

Parallel implementation to are-session-end.js (Claude/Gemini SessionEnd hook) with identical disable mechanisms and git detection logic. Differs only in export pattern: async factory returning plugin object vs direct Node.js script execution.