---
generated_at: 2026-02-09T21:30:41.764Z
content_hash: d96faaf817c7bc9d8b5ab3bd189a658f76e658213df6079f0cd895abe010f30c
purpose: opencode-are-session-end.js exports `AreSessionEnd` async factory returning OpenCode plugin that triggers `npx agents...
---
**opencode-are-session-end.js exports `AreSessionEnd` async factory returning OpenCode plugin that triggers `npx agents-reverse-engineer@latest update --quiet` as detached background process when `session.deleted` event fires if git working tree has uncommitted changes.**

## Exported Interface

`AreSessionEnd` â€” Async function returning plugin object with shape `{ event: { 'session.deleted': AsyncFunction } }`. No parameters. Plugin conforms to OpenCode event handler contract.

## Event Hook Behavior

`event['session.deleted']` handler executes four-stage gate sequence:

1. Environment gate: Returns early if `process.env.ARE_DISABLE_HOOK === '1'`
2. Config file gate: Reads `.agents-reverse-engineer.yaml` via `existsSync()` + `readFileSync()`, returns early if content `includes('hook_enabled: false')` (substring search, no YAML parser)
3. Git status gate: Executes `execSync('git status --porcelain', { encoding: 'utf-8' })`, returns early if output `trim()` is empty string, catches and returns on error (non-git repo)
4. Background spawn: Launches `spawn('npx', ['agents-reverse-engineer@latest', 'update', '--quiet'], { stdio: 'ignore', detached: true })`, calls `child.unref()` to prevent blocking Node.js exit

## Process Lifecycle Pattern

Detached spawn pattern prevents session close blocking. `stdio: 'ignore'` suppresses output streams. `detached: true` creates independent process group. `unref()` allows parent process termination without waiting for child completion.

## Disable Mechanisms

- **Environment**: `ARE_DISABLE_HOOK=1` environment variable
- **Config**: `hook_enabled: false` anywhere in `.agents-reverse-engineer.yaml` content (not YAML-parsed, simple string inclusion check)

## Platform Context

OpenCode plugin system equivalent to Claude/Gemini SessionEnd hooks (`are-session-end.js`). Event name `session.deleted` maps to OpenCode lifecycle, whereas Claude/Gemini use `SessionEnd` trigger. Identical git change detection and background spawn logic across all three platform variants.

## Installation Path

Installed to `~/.config/opencode/plugins/` (or `$OPENCODE_CONFIG_DIR/plugins/`) via `src/installer/operations.ts` when user runs `npx agents-reverse-engineer --runtime opencode -g`.