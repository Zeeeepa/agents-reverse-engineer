---
generated_at: 2026-02-09T14:10:04.714Z
content_hash: 34836e7b21ee372f71361b50aaa9e8e19948e339aef640a828b1d1257beac09a
purpose: are-session-end.js spawns a detached background subprocess executing `npx agents-reverse-engineer@latest update --qui...
---
**are-session-end.js spawns a detached background subprocess executing `npx agents-reverse-engineer@latest update --quiet` when the AI session ends and git working tree contains uncommitted changes.**

## Exported Interface

None. Invoked as standalone script via Node.js shebang (`#!/usr/bin/env node`).

## Execution Flow

1. Checks `process.env.ARE_DISABLE_HOOK === '1'` → exits immediately if set
2. Reads `.agents-reverse-engineer.yaml` via `existsSync()` + `readFileSync()` → exits if file contains substring `'hook_enabled: false'` (no YAML parser)
3. Executes `execSync('git status --porcelain', { encoding: 'utf-8' })` → exits silently if output empty (no changes) or command fails (non-git repo)
4. Spawns detached child process via `spawn('npx', ['agents-reverse-engineer@latest', 'update', '--quiet'], { stdio: 'ignore', detached: true })` followed by `child.unref()` to allow parent process termination

## Integration Pattern

- **IDE hooks**: Registered as SessionEnd hook in `~/.claude/hooks/` for Claude Code, equivalent OpenCode plugin location `~/.config/opencode/plugins/`
- **Detached spawn**: Uses `detached: true` + `unref()` pattern to prevent blocking session close; subprocess outlives parent
- **Silent failures**: All error conditions (`git` unavailable, config read failure, no changes) exit with code 0 to avoid hook failure alerts

## Disable Mechanisms

- **Environment**: `ARE_DISABLE_HOOK=1` checked before any file I/O
- **Config file**: Substring search for `'hook_enabled: false'` in `.agents-reverse-engineer.yaml` (intentionally avoids YAML parser dependency)
- **No changes**: Exits before spawn if `git status --porcelain` returns empty output

## Resource Management

- **stdio: 'ignore'**: Suppresses subprocess stdout/stderr to prevent tty attachment
- **detached: true**: Creates new process group (allows `kill(-pid)` semantics in child)
- **child.unref()**: Removes subprocess from Node.js event loop reference count, allowing parent exit
- **No timeout**: Subprocess runs indefinitely; relies on ARE's internal timeout mechanisms (`timeoutMs` in config)

## Related Files

- `are-check-update.js`: SessionStart hook checking for ARE version updates
- `opencode-are-session-end.js`: OpenCode plugin adapter exporting `AreSessionEnd()` factory
- `src/cli/update.ts`: Incremental update command invoked by this hook
- `src/update/orchestrator.ts`: Update workflow orchestrator with git diff integration