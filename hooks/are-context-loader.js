#!/usr/bin/env node

/**
 * ARE Context Loader Hook (PostToolUse → Read)
 *
 * Fires after every Read tool call. When the read file's directory contains
 * an AGENTS.md generated by ARE, and it hasn't been loaded yet this session,
 * outputs its content as additionalContext for Claude.
 *
 * Deduplicates per session via temp file keyed by session_id.
 * Skips the project root (already loaded via CLAUDE.md → @AGENTS.md).
 */

import fs from 'node:fs';
import path from 'node:path';
import os from 'node:os';

let input = '';
process.stdin.setEncoding('utf8');
process.stdin.on('data', (chunk) => { input += chunk; });
process.stdin.on('end', () => {
  try {
    main(JSON.parse(input));
  } catch {
    // Malformed input — exit silently
  }
});

function main(data) {
  const filePath = data.tool_input && data.tool_input.file_path;
  if (!filePath) return;

  const projectRoot = data.cwd || '';

  // Only trigger for files within the project
  if (projectRoot && !filePath.startsWith(projectRoot)) return;

  const dir = path.dirname(path.resolve(filePath));

  // Skip project root — already loaded via CLAUDE.md → @AGENTS.md
  if (dir === projectRoot) return;

  const agentsMd = path.join(dir, 'AGENTS.md');
  if (!fs.existsSync(agentsMd)) return;

  // Verify it's an ARE-generated file (not a user-authored one)
  let content;
  try {
    content = fs.readFileSync(agentsMd, 'utf8');
  } catch {
    return;
  }
  if (!content.includes('Generated by agents-reverse-engineer')) return;

  // Deduplicate per session
  const sessionId = data.session_id || 'default';
  const dedupeDir = path.join(os.tmpdir(), 'are-context-loader');
  const dedupeFile = path.join(dedupeDir, sessionId + '.json');

  let seen = {};
  try {
    if (fs.existsSync(dedupeFile)) {
      seen = JSON.parse(fs.readFileSync(dedupeFile, 'utf8'));
    }
  } catch {}

  if (seen[dir]) return;

  // Mark directory as seen
  seen[dir] = true;
  try {
    fs.mkdirSync(dedupeDir, { recursive: true });
    fs.writeFileSync(dedupeFile, JSON.stringify(seen));
  } catch {}

  // Compute relative path for display
  const relDir = projectRoot ? path.relative(projectRoot, dir) : dir;

  // Output structured JSON — additionalContext is injected into Claude's conversation
  process.stdout.write(JSON.stringify({
    suppressOutput: false,
    hookSpecificOutput: {
      hookEventName: 'PostToolUse',
      additionalContext: '## ARE Context: ' + relDir + '/AGENTS.md\n\n' + content,
    },
  }));
}
