<!-- Generated by agents-reverse-engineer -->

# hooks

Session lifecycle automation implementing SessionStart version checks and SessionEnd incremental documentation updates via detached background subprocesses for Claude Code and OpenCode runtimes.

## Contents

**[are-check-update.js](./are-check-update.js)** — Claude Code SessionStart hook spawning detached `npm view agents-reverse-engineer version` subprocess via `spawn(process.execPath, ['-e', inlineScript], {detached: true})` with `child.unref()`, writing `~/.claude/cache/are-update-check.json` containing `{update_available, installed, latest, checked}` fields. Version resolution: `.claude/ARE-VERSION` (project) → `~/.claude/ARE-VERSION` (global) → `'0.0.0'` fallback.

**[are-session-end.js](./are-session-end.js)** — Claude Code SessionEnd hook triggering detached `npx agents-reverse-engineer@latest update --quiet` via `spawn()` + `unref()` when `git status --porcelain` returns non-empty output. Gates: `ARE_DISABLE_HOOK=1` env var or `hook_enabled: false` in `.agents-reverse-engineer.yaml` trigger `process.exit(0)`. Exits silently on non-git-repo exception.

**[opencode-are-check-update.js](./opencode-are-check-update.js)** — OpenCode plugin exporting `AreCheckUpdate` factory with `event['session.created']` handler. Spawns detached npm registry check writing `~/.config/opencode/cache/are-update-check.json`. Version priority: `.opencode/ARE-VERSION` → `~/.config/opencode/ARE-VERSION` → `'0.0.0'`. Executes `execSync('npm view agents-reverse-engineer version', {timeout: 10000, windowsHide: true})` in detached child.

**[opencode-are-session-end.js](./opencode-are-session-end.js)** — OpenCode plugin exporting `AreSessionEnd` with `event['session.deleted']` handler executing detached `npx agents-reverse-engineer@latest update --quiet`. Shares disable gates (`ARE_DISABLE_HOOK=1`, `hook_enabled: false`) and git change detection (`git status --porcelain`) with Claude Code equivalent.

## Architecture

### Runtime-Specific Hook Variants

Two implementation pairs targeting different AI assistant runtimes:

1. **Claude Code hooks** (`are-*.js`): Standalone executable scripts registered via `~/.claude/settings.json` `hooks.session.start/end` arrays, consuming `~/.claude/ARE-VERSION` and writing `~/.claude/cache/are-update-check.json`.

2. **OpenCode hooks** (`opencode-*.js`): ES module plugins exporting factory functions returning `{event: {[hookName]: handler}}` objects, consuming `~/.config/opencode/ARE-VERSION` and writing `~/.config/opencode/cache/are-update-check.json`.

Installed via `../src/installer/operations.ts` `registerSessionHook()` (Claude Code JSONC injection) and `installHookFile()` (OpenCode symlink/copy), uninstalled via `unregisterSessionHook()` and `uninstallHookFile()`.

### Detached Subprocess Pattern

All hooks use `spawn(command, args, {stdio: 'ignore', detached: true, windowsHide: true})` followed by `child.unref()` to prevent blocking session lifecycle. Parent process exits immediately; child executes asynchronously.

**SessionStart hooks**: inline JavaScript string passed to `spawn(process.execPath, ['-e', script])` executes npm registry fetch + file write in background. Failures silently ignored.

**SessionEnd hooks**: `spawn('npx', ['agents-reverse-engineer@latest', 'update', '--quiet'])` triggers incremental `../src/update/orchestrator.ts` execution after session close, independent of parent process lifetime.

### Shared Disable Mechanisms

SessionEnd hooks implement identical gating logic:

1. Check `process.env.ARE_DISABLE_HOOK === '1'` → exit
2. Read `.agents-reverse-engineer.yaml` via `readFileSync()`, check `config.includes('hook_enabled: false')` → exit  
3. Execute `git status --porcelain` → exit if `status.trim() === ''` or exception thrown

Prevents redundant updates when no changes exist or user explicitly disables automation.

## Behavioral Contracts

### Version Resolution Priority

Claude Code: `.claude/ARE-VERSION` (cwd) → `~/.claude/ARE-VERSION` → `'0.0.0'`  
OpenCode: `.opencode/ARE-VERSION` (cwd) → `~/.config/opencode/ARE-VERSION` → `'0.0.0'`

### Update Check Cache Schema

```json
{
  "update_available": boolean,
  "installed": "0.0.0",
  "latest": "0.8.0",
  "checked": 1738416000
}
```

### npm Registry Command

```javascript
execSync('npm view agents-reverse-engineer version', {encoding: 'utf8', timeout: 10000, windowsHide: true})
```

### Git Change Detection

```javascript
execSync('git status --porcelain', {encoding: 'utf-8'})
```
Exit if `status.trim() === ''` or exception thrown (not git repo).

### Spawn Options

```javascript
{stdio: 'ignore', detached: true, windowsHide: true}
```

### Disable Gates

- Environment: `process.env.ARE_DISABLE_HOOK === '1'`
- Config: `.agents-reverse-engineer.yaml` contains substring `hook_enabled: false`

## File Operations

**SessionStart hooks**:  
`mkdirSync(cacheDir, {recursive: true})` ensures cache directory existence before atomic `writeFileSync(cacheFile, JSON.stringify(result))` write.

**SessionEnd hooks**:  
No file I/O in hook script; delegates to `npx agents-reverse-engineer@latest update --quiet` subprocess executing `../src/update/orchestrator.ts` pipeline.