<!-- Generated by agents-reverse-engineer -->

# hooks/

SessionStart and SessionEnd lifecycle hooks for Claude Code, Gemini, and OpenCode that enable background version checking and automatic documentation updates when AI sessions close.

## Contents

### Claude/Gemini Hooks

**[are-check-update.js](./are-check-update.js)** — SessionStart hook spawning detached subprocess that queries `npm view agents-reverse-engineer version`, compares against `ARE-VERSION` files (project-local `.claude/ARE-VERSION` or global `~/.claude/ARE-VERSION`), writes `~/.claude/cache/are-update-check.json` with `{ update_available, installed, latest, checked }` schema.

**[are-session-end.js](./are-session-end.js)** — SessionEnd hook executing `git status --porcelain` and spawning `npx agents-reverse-engineer@latest update --quiet` as detached background process when uncommitted changes exist. Exits early if `ARE_DISABLE_HOOK=1` environment variable set or `.agents-reverse-engineer.yaml` contains substring `'hook_enabled: false'`.

### OpenCode Plugin Adapters

**[opencode-are-check-update.js](./opencode-are-check-update.js)** — Exports `AreCheckUpdate()` async factory returning OpenCode plugin with `event['session.created']` handler. Spawns detached version check subprocess writing `~/.config/opencode/cache/are-update-check.json`. Checks `.opencode/ARE-VERSION` (project-local) and `~/.config/opencode/ARE-VERSION` (global).

**[opencode-are-session-end.js](./opencode-are-session-end.js)** — Exports `AreSessionEnd()` async factory returning OpenCode plugin with `event['session.deleted']` handler. Spawns `npx agents-reverse-engineer@latest update --quiet` when `git status --porcelain` returns non-empty output. Respects `ARE_DISABLE_HOOK` and `hook_enabled: false` disable mechanisms.

## Architecture

### Detached Spawn Pattern

All hooks use identical background process spawning strategy:
```javascript
spawn(process.execPath, ['-e', scriptString], {
  stdio: 'ignore',
  detached: true,
  windowsHide: true
}).unref()
```
This pattern ensures:
- `detached: true` creates independent process group
- `stdio: 'ignore'` suppresses stdout/stderr to prevent tty attachment
- `.unref()` removes subprocess from Node.js event loop reference count, allowing parent exit
- `windowsHide: true` prevents console window flash on Windows

### Version File Resolution Priority

Version checking follows two-tier strategy:
1. **Project-local**: `<cwd>/.claude/ARE-VERSION` or `<cwd>/.opencode/ARE-VERSION`
2. **Global fallback**: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`

Falls back to `'0.0.0'` default when neither file exists.

### Disable Mechanisms

Hooks exit early when:
- **Environment**: `process.env.ARE_DISABLE_HOOK === '1'`
- **Config file**: `.agents-reverse-engineer.yaml` contains substring `'hook_enabled: false'` (intentionally avoids YAML parser)
- **No changes** (session-end only): `git status --porcelain` returns empty output

### OpenCode Plugin Contract

OpenCode adapters export async factory functions returning plugin objects:
```typescript
{
  event: {
    'session.created': async () => void,
    'session.deleted': async () => void
  }
}
```
Handlers spawn detached processes without awaiting completion—return immediately after spawn.

## Installation

Hooks installed via `src/installer/operations.ts` to platform-specific paths:
- **Claude/Gemini**: `~/.claude/hooks/` (detected via `CLAUDE_CONFIG_DIR`)
- **OpenCode**: `~/.config/opencode/plugins/` (detected via `OPENCODE_CONFIG_DIR`)

Build process copies `hooks/*.js` → `hooks/dist/*.js` via `scripts/build-hooks.js` before npm publish.

## Related Components

- `src/installer/operations.ts` — Hook registration during `npx agents-reverse-engineer --runtime <platform> -g` install
- `src/cli/update.ts` — Incremental update command invoked by session-end hooks
- `src/change-detection/detector.ts` — Git diff parsing backing `--uncommitted` flag logic