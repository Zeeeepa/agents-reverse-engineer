<!-- Generated by agents-reverse-engineer -->

# hooks

Session lifecycle automation for Claude Code and OpenCode IDE: detached background processes checking npm registry updates on session start and triggering incremental documentation updates on session end when git changes detected.

## Contents

**[are-check-update.js](./are-check-update.js)** — SessionStart hook spawning detached `node -e` subprocess to fetch `npm view agents-reverse-engineer version`, compare against `.claude/ARE-VERSION` (project-local) or `~/.claude/ARE-VERSION` (global), write `{ update_available, installed, latest, checked }` JSON to `~/.claude/cache/are-update-check.json`.

**[are-session-end.js](./are-session-end.js)** — SessionEnd hook executing `npx agents-reverse-engineer@latest update --quiet` via detached `spawn()` when `git status --porcelain` returns non-empty output, gated by `ARE_DISABLE_HOOK !== '1'` and absence of `hook_enabled: false` in `.agents-reverse-engineer.yaml`.

**[opencode-are-check-update.js](./opencode-are-check-update.js)** — OpenCode IDE `session.created` event handler exporting `AreCheckUpdate` async function, mirrors `are-check-update.js` behavior using `.opencode/ARE-VERSION` paths and `~/.config/opencode/cache/are-update-check.json` cache file.

**[opencode-are-session-end.js](./opencode-are-session-end.js)** — OpenCode IDE `session.deleted` event handler exporting `AreSessionEnd` async function, mirrors `are-session-end.js` behavior with identical git change detection and disable gate logic.

## Architecture

### Runtime Lifecycle Integration

Claude Code hooks installed to `~/.claude/hooks/` by `src/installer/operations.ts`, registered in `~/.claude/settings.json` via `jsonc-parser` edit. OpenCode hooks installed to `~/.config/opencode/hooks/` with equivalent registration. Hooks execute via IDE event system without requiring package installation in target project.

### Version Resolution Priority

1. **Project-local**: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION` in `process.cwd()`
2. **Global**: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION` in `os.homedir()`
3. **Fallback**: `'0.0.0'` when no version file exists

### Detached Process Pattern

All hooks use `spawn()` with `{ stdio: 'ignore', detached: true, windowsHide: true }` followed by `child.unref()` to prevent blocking session lifecycle events. Update check spawns inline Node.js script via `process.execPath -e "${inlineCode}"`. Session-end hooks spawn `npx agents-reverse-engineer@latest update --quiet` with npm resolution.

### Disable Mechanism Hierarchy

Session-end hooks check three gates in order:
1. `process.env.ARE_DISABLE_HOOK === '1'` — environment variable override
2. `.agents-reverse-engineer.yaml` contains literal string `'hook_enabled: false'` — per-project config (read via `readFileSync` + `String.includes()`)
3. `git status --porcelain` returns empty string — no uncommitted changes (checked via `execSync`)

### Cache Schema

Update check writes JSON object to `~/.claude/cache/are-update-check.json` or `~/.config/opencode/cache/are-update-check.json`:
```javascript
{
  update_available: boolean,  // installed !== latest
  installed: string,          // from ARE-VERSION files
  latest: string,            // from npm view or 'unknown'
  checked: number            // Math.floor(Date.now() / 1000)
}
```

Cache directory created via `mkdirSync(cacheDir, { recursive: true })` if `existsSync(cacheDir)` returns false.

## Behavioral Contracts

### npm Registry Query
```javascript
execSync('npm view agents-reverse-engineer version', { 
  encoding: 'utf8', 
  timeout: 10000, 
  windowsHide: true 
})
```
Falls back to `latest: 'unknown'` on timeout or error.

### Git Change Detection
```javascript
execSync('git status --porcelain', { encoding: 'utf-8' })
```
Exits silently when `status.trim() === ''` or command throws (non-git directory).

### Detached Spawn
```javascript
const child = spawn(cmd, args, { 
  stdio: 'ignore', 
  detached: true, 
  windowsHide: true 
});
child.unref();
```

### OpenCode Event Subscription
```javascript
export async function AreCheckUpdate() {
  return {
    event: {
      'session.created': async () => { /* handler */ }
    }
  };
}
```