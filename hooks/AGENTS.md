<!-- Generated by agents-reverse-engineer -->

# hooks

Session lifecycle hooks for Claude Code, Gemini, and OpenCode that enable automatic background version checking and documentation updates. Spawns detached processes via `spawn()` + `child.unref()` to prevent blocking IDE initialization or session close.

## Contents

### Claude/Gemini Hooks

**[are-check-update.js](./are-check-update.js)** — SessionStart hook that spawns detached background process to query `npm view agents-reverse-engineer version`, compares against `~/.claude/ARE-VERSION` or `.claude/ARE-VERSION`, and caches `{ update_available, installed, latest, checked }` to `~/.claude/cache/are-update-check.json`. Silent failure on npm errors or missing version files.

**[are-session-end.js](./are-session-end.js)** — SessionEnd hook that runs `git status --porcelain` to detect uncommitted changes, then spawns `npx agents-reverse-engineer@latest update --quiet` as detached background process if changes exist. Respects `ARE_DISABLE_HOOK` env var and `hook_enabled: false` in `.agents-reverse-engineer.yaml`.

### OpenCode Hooks

**[opencode-are-check-update.js](./opencode-are-check-update.js)** — Exports `AreCheckUpdate()` async factory returning plugin with `event['session.created']` handler. Identical version check logic to `are-check-update.js`, but resolves version files from `.opencode/ARE-VERSION` paths and caches results to `~/.config/opencode/cache/are-update-check.json`.

**[opencode-are-session-end.js](./opencode-are-session-end.js)** — Exports `AreSessionEnd()` async factory returning plugin with `event['session.deleted']` handler. Mirrors `are-session-end.js` session-end update logic for OpenCode plugin system with identical disable gates and `git status` change detection.

## Background Process Pattern

All hooks use identical detached spawn pattern: `spawn(process.execPath, ['-e', scriptString], { stdio: 'ignore', detached: true, windowsHide: true })` followed by `child.unref()` to allow parent IDE process to exit without waiting. Background scripts execute independently and write results to cache files.

## Version File Resolution Strategy

Check hooks read installed version from project-local paths (`.claude/ARE-VERSION`, `.opencode/ARE-VERSION`) first, then fall back to global paths (`~/.claude/ARE-VERSION`, `~/.config/opencode/ARE-VERSION`). Defaults to `'0.0.0'` if all paths missing. Session-end hooks do not read version files, only spawn update commands.

## Cache Schema

Version check hooks write JSON objects with properties: `update_available` (boolean, computed as `latest && installed !== latest`), `installed` (string version or `'0.0.0'`), `latest` (string version or `'unknown'`), `checked` (Unix timestamp from `Math.floor(Date.now() / 1000)`). Parent process reads cache synchronously on next session start.

## Disable Mechanisms

Session-end hooks implement two-gate disable logic: check `process.env.ARE_DISABLE_HOOK === '1'` first, then check if `.agents-reverse-engineer.yaml` contains substring `hook_enabled: false` via synchronous `existsSync()` + `readFileSync()` + string search (no YAML parser). Either gate returns early without spawning update process.

## Integration Context

These hooks integrate with IDE session lifecycles via executable scripts (Claude/Gemini) or async plugin factories (OpenCode). Built by `scripts/build-hooks.js` and installed to IDE-specific hook directories by `src/installer/operations.ts`. Enables zero-friction documentation maintenance during normal coding workflows.