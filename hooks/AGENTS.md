<!-- Generated by agents-reverse-engineer -->

# hooks

**IDE session lifecycle hooks for automatic ARE version checking and documentation updates, implemented as detached background processes for Claude Code, Gemini CLI, and OpenCode runtimes.**

## Contents

### Session Lifecycle Hooks

**[are-check-update.js](./are-check-update.js)** — SessionStart hook spawning detached background process querying npm registry via `npm view agents-reverse-engineer version`, comparing against local/global `~/.claude/ARE-VERSION`, caching results to `~/.claude/cache/are-update-check.json` with timestamp + version metadata. 10s timeout enforced. Graceful degradation on network/git failures (sets `latest: 'unknown'`).

**[are-session-end.js](./are-session-end.js)** — SessionEnd hook executing `npx agents-reverse-engineer@latest update --quiet` as detached background process when git working tree changes detected via `git status --porcelain`. Honors disable flags: `ARE_DISABLE_HOOK=1` environment variable or `hook_enabled: false` in `.agents-reverse-engineer.yaml` (substring search, no parser). Silent exit on no changes.

### OpenCode Plugin Wrappers

**[opencode-are-check-update.js](./opencode-are-check-update.js)** — `AreCheckUpdate()` async factory returning OpenCode plugin with `event['session.created']` handler. Equivalent logic to `are-check-update.js` but adapted to OpenCode plugin system. Checks `~/.config/opencode/ARE-VERSION` (project-local `.opencode/ARE-VERSION` first), writes cache to `~/.config/opencode/cache/are-update-check.json`.

**[opencode-are-session-end.js](./opencode-are-session-end.js)** — `AreSessionEnd()` async factory returning OpenCode plugin with `event['session.deleted']` handler. Equivalent logic to `are-session-end.js` wrapped in plugin interface contract. Same disable mechanisms + git change detection + detached `npx` spawn pattern.

## Architecture

### Detached Background Process Pattern

All hooks use identical spawn pattern to prevent blocking IDE session lifecycle:

```javascript
spawn(process.execPath, ['-e', scriptString], {
  stdio: 'ignore',      // discard stdout/stderr/stdin
  detached: true,       // separate process group, survives parent exit
  windowsHide: true     // suppress console window on Windows
})
child.unref()           // allow Node.js event loop exit without waiting
```

Serialized script strings injected via `-e` flag contain inline logic (version checks, npm queries, cache writes). Parent process exits immediately after spawn, background child completes asynchronously.

### Version File Resolution Priority

Both check hooks follow precedence order:
1. **Project-local**: `<cwd>/.claude/ARE-VERSION` or `<cwd>/.opencode/ARE-VERSION`
2. **Global install**: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`
3. **Default fallback**: `'0.0.0'` if neither exists

### Cache File Format (JSON)

Written by check hooks to `~/.{claude,opencode}/cache/are-update-check.json`:

```json
{
  "update_available": true,
  "installed": "0.5.2",
  "latest": "0.6.0",
  "checked": 1738886400
}
```

Keys: `update_available` (boolean via `installed !== latest`), `installed` (string from ARE-VERSION or `'0.0.0'`), `latest` (string from `npm view` or `'unknown'` on timeout), `checked` (Unix epoch seconds).

### Disable Mechanisms

Session-end hooks check two flags before execution:

1. **Environment variable**: `process.env.ARE_DISABLE_HOOK === '1'`
2. **Config file substring**: `.agents-reverse-engineer.yaml` contains `'hook_enabled: false'` (raw `readFileSync()` + `String.includes()`, no YAML parser)

Both checks trigger silent exit (code 0) to prevent observable failures when user disables hooks.

## Integration Points

**Installed by**: `src/installer/operations.ts` copies files from `hooks/` → `~/.claude/hooks/` or `~/.config/opencode/plugins/` during `are --runtime <platform> -g` command execution.

**Built by**: `scripts/build-hooks.js` duplicates `hooks/*.js` → `hooks/dist/*.js` for npm tarball inclusion during `npm run build:hooks` (invoked by `prepublishOnly`).

**Consumed by**: IDE runtimes invoke hooks automatically on session lifecycle events:
- Claude Code: calls `~/.claude/hooks/session-start/are-check-update.js`, `~/.claude/hooks/session-end/are-session-end.js`
- Gemini CLI: equivalent paths under `~/.gemini/hooks/`
- OpenCode: loads plugins from `~/.config/opencode/plugins/`, invokes `event['session.created']` / `event['session.deleted']` handlers

## Behavioral Contracts

### npm Registry Query Command

```javascript
execSync('npm view agents-reverse-engineer version', { 
  encoding: 'utf8', 
  timeout: 10000, 
  windowsHide: true 
})
```

Returns latest published version string (e.g., `"0.6.5\n"`). Timeout 10000ms enforced to prevent indefinite hangs. Throws on network failures, caught by hooks to set `latest: 'unknown'`.

### Git Change Detection Command

```javascript
execSync('git status --porcelain', { encoding: 'utf-8' })
```

Returns empty string when working tree clean, non-empty on uncommitted changes. Throws when not git repo or git unavailable, caught by session-end hooks to skip update spawn.

### npx Update Invocation Command

```bash
npx agents-reverse-engineer@latest update --quiet
```

`@latest` specifier forces npm registry fetch, bypassing local cache. `--quiet` flag suppresses terminal output (logs to `.agents-reverse-engineer/progress.log` only). Spawned as detached child to prevent blocking IDE session close.

## Platform Compatibility

**Path resolution**: Uses `os.homedir()` + `path.join()` for cross-platform directory construction (`~/.claude`, `~/.config/opencode`, `~/.gemini`).

**Windows-specific flags**: `windowsHide: true` in `spawn()` and `execSync()` suppresses console window creation.

**Node.js compatibility**: `#!/usr/bin/env node` shebang enables direct execution without explicit interpreter invocation. Requires Node.js ≥18.0.0 (same as ARE runtime requirement).

## Dependencies

All four hooks use identical Node.js built-in module subset:
- `child_process`: `spawn`, `execSync`
- `fs`: `existsSync`, `mkdirSync`, `readFileSync`, `writeFileSync`
- `os`: `homedir`
- `path`: `join`

No external npm dependencies — statically analyzable, zero-install executable scripts.