<!-- Generated by agents-reverse-engineer v0.8.12 -->

# hooks

Session lifecycle automation: detached background subprocess spawning for SessionStart npm registry update checks (Claude Code + OpenCode) and SessionEnd incremental documentation regeneration (Claude Code only), with disable gates via `ARE_DISABLE_HOOK=1` environment variable or `hook_enabled: false` YAML config.

## Contents

**[are-check-update.js](./are-check-update.js)** — Claude Code SessionStart hook. Spawns detached `node -e` subprocess executing inline npm registry check via `execSync('npm view agents-reverse-engineer version', {timeout: 10000})`. Reads installed version from `.claude/ARE-VERSION` (project) or `~/.claude/ARE-VERSION` (global) fallback `'0.0.0'`, writes `{update_available, installed, latest, checked}` JSON to `~/.claude/cache/are-update-check.json`. Ensures `~/.claude/cache/` via `mkdirSync({recursive: true})`. Calls `child.unref()` for fire-and-forget execution, parent exits immediately, child failures silently ignored.

**[are-context-loader.js](./are-context-loader.js)** — PostToolUse hook injecting ARE-generated AGENTS.md from file's parent directories into Claude context after Read tool calls. Fires when `tool_input.file_path` exists, resolves within project root, not already in root (CLAUDE.md covers that). Walks from `path.dirname(path.resolve(filePath))` up to project root via `path.dirname(dir)` until reaching project root or filesystem root, collecting unseen AGENTS.md files containing `'Generated by agents-reverse-engineer'` marker. Tracks loaded directories in `os.tmpdir()/are-context-loader/{session_id}.json` (defaults `'default'`), marks `seen[dir] = true` before injection. Reverses output for root-to-leaf order. Returns `{suppressOutput: false, hookSpecificOutput: {hookEventName: "PostToolUse", additionalContext: "## ARE Context: {relDir}/AGENTS.md\n\n{content}"}}`. Silently exits on malformed stdin JSON, missing `file_path`, file outside project, unreadable AGENTS.md, deduplication I/O failures.

**[are-session-end.js](./are-session-end.js)** — Claude Code SessionEnd hook. Disable gates: `process.env.ARE_DISABLE_HOOK === '1'` exits, `.agents-reverse-engineer.yaml` containing `hook_enabled: false` exits. Git change detection: `execSync('git status --porcelain', {encoding: 'utf-8'})` exits if empty or throws (non-git-repo). Spawns detached `npx agents-reverse-engineer@latest update --quiet` via `spawn()` with `stdio: 'ignore'`, calls `child.unref()`.

**[opencode-are-check-update.js](./opencode-are-check-update.js)** — OpenCode SessionStart hook. Exports `AreCheckUpdate` async factory returning plugin object with `event['session.created']` handler. Ensures `~/.config/opencode/cache/` via `mkdirSync({recursive: true})`, spawns detached npm registry check, reads version from `.opencode/ARE-VERSION` (project) or `~/.config/opencode/ARE-VERSION` (global) fallback `'0.0.0'`, writes `{update_available, installed, latest, checked}` JSON to `~/.config/opencode/cache/are-update-check.json`, calls `child.unref()`.

## Behavioral Contracts

**Detached spawn pattern**:
```javascript
spawn(command, args, { stdio: 'ignore', detached: true, windowsHide: true })
child.unref()
```

**npm registry command**:
```javascript
execSync('npm view agents-reverse-engineer version', { encoding: 'utf8', timeout: 10000, windowsHide: true })
```

**Git change detection**:
```javascript
execSync('git status --porcelain', { encoding: 'utf-8' })
// Exit if status.trim() === '' or command throws
```

**Disable gates**:
```javascript
process.env.ARE_DISABLE_HOOK === '1'
// OR
configFileContent.includes('hook_enabled: false')
```

**Version resolution priority**:
1. Project-local: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`
2. Global: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`
3. Fallback: `'0.0.0'`

**Update check cache schema**:
```json
{
  "update_available": boolean,
  "installed": "0.0.0",
  "latest": "0.8.0" | "unknown",
  "checked": 1738416000
}
```

**Cache file paths**:
- Claude Code: `~/.claude/cache/are-update-check.json`
- OpenCode: `~/.config/opencode/cache/are-update-check.json`

**Context loader deduplication schema**:
```json
{
  "/path/to/dir": true
}
```
Written to `os.tmpdir()/are-context-loader/{session_id}.json`.

**Context loader output format**:
```json
{
  "suppressOutput": false,
  "hookSpecificOutput": {
    "hookEventName": "PostToolUse",
    "additionalContext": "## ARE Context: {relDir}/AGENTS.md\n\n{content}"
  }
}
```

## Integration

Copied from `hooks/*.js` to `hooks/dist/` by `scripts/build-hooks.js` during `npm run build:hooks` / `prepublishOnly`. Installed by `src/installer/operations.ts` `installSessionHooks()` via `settings.json` registration with `fs.copyFileSync()` to runtime-specific hook directories.