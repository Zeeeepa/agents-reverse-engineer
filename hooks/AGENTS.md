<!-- Generated by agents-reverse-engineer v0.8.2 -->

# hooks

Session lifecycle automation for Claude Code and OpenCode: detached background subprocess spawning for SessionStart npm registry update checks and SessionEnd incremental documentation regeneration, with disable gates via `ARE_DISABLE_HOOK=1` environment variable or `hook_enabled: false` YAML config.

## Contents

**[are-check-update.js](./are-check-update.js)** — Claude Code SessionStart hook. Spawns detached `node -e` subprocess executing inline npm registry check via `execSync('npm view agents-reverse-engineer version', {timeout: 10000})`. Reads installed version from `.claude/ARE-VERSION` (project) or `~/.claude/ARE-VERSION` (global) fallback `'0.0.0'`, writes `{update_available, installed, latest, checked}` JSON to `~/.claude/cache/are-update-check.json`. Ensures `~/.claude/cache/` via `mkdirSync({recursive: true})`. Calls `child.unref()` for fire-and-forget execution, parent exits immediately, child failures silently ignored.

**[are-session-end.js](./are-session-end.js)** — Claude Code SessionEnd hook. Disable gates: `process.env.ARE_DISABLE_HOOK === '1'` exits, `.agents-reverse-engineer.yaml` containing `hook_enabled: false` exits. Git change detection: `execSync('git status --porcelain', {encoding: 'utf-8'})` exits if empty or throws (non-git-repo). Spawns detached `npx agents-reverse-engineer@latest update --quiet` via `spawn()` with `stdio: 'ignore'`, calls `child.unref()`.

**[opencode-are-check-update.js](./opencode-are-check-update.js)** — OpenCode SessionStart hook. Exports `AreCheckUpdate` async factory returning plugin object with `event['session.created']` handler. Ensures `~/.config/opencode/cache/` via `mkdirSync({recursive: true})`, spawns detached npm registry check, reads version from `.opencode/ARE-VERSION` (project) or `~/.config/opencode/ARE-VERSION` (global) fallback `'0.0.0'`, writes `{update_available, installed, latest, checked}` JSON to `~/.config/opencode/cache/are-update-check.json`, calls `child.unref()`.

## Behavioral Contracts

**Detached spawn pattern**:
```javascript
spawn(command, args, { stdio: 'ignore', detached: true, windowsHide: true })
child.unref()
```

**npm registry command**:
```javascript
execSync('npm view agents-reverse-engineer version', { encoding: 'utf8', timeout: 10000, windowsHide: true })
```

**Git change detection**:
```javascript
execSync('git status --porcelain', { encoding: 'utf-8' })
// Exit if status.trim() === '' or command throws
```

**Disable gates**:
```javascript
process.env.ARE_DISABLE_HOOK === '1'
// OR
configFileContent.includes('hook_enabled: false')
```

**Version resolution priority**:
1. Project-local: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`
2. Global: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`
3. Fallback: `'0.0.0'`

**Update check cache schema**:
```json
{
  "update_available": boolean,
  "installed": "0.0.0",
  "latest": "0.8.0" | "unknown",
  "checked": 1738416000
}
```

**Cache file paths**:
- Claude Code: `~/.claude/cache/are-update-check.json`
- OpenCode: `~/.config/opencode/cache/are-update-check.json`

## Integration

Copied from `hooks/*.js` to `hooks/dist/` by `scripts/build-hooks.js` during `npm run build:hooks` / `prepublishOnly`. Installed by `src/installer/operations.ts` `installSessionHooks()` via `settings.json` registration with `fs.copyFileSync()` to runtime-specific hook directories.