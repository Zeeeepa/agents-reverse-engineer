<!-- Generated by agents-reverse-engineer -->

# hooks/

**Session lifecycle hooks for Claude Code, Gemini CLI, and OpenCode runtimes that execute version checking on session start and incremental documentation updates on session end via detached background processes.**

## Contents

### Session Start Hooks

**[are-check-update.js](./are-check-update.js)** — Claude/Gemini SessionStart hook spawning detached `npm view agents-reverse-engineer version` subprocess, comparing against local `ARE-VERSION` file (project `.claude/ARE-VERSION` before global `~/.claude/ARE-VERSION`), writing comparison result to `~/.claude/cache/are-update-check.json` with schema `{ update_available, installed, latest, checked }`.

**[opencode-are-check-update.js](./opencode-are-check-update.js)** — OpenCode plugin exporting `AreCheckUpdate()` async factory returning `event['session.created']` handler that spawns detached npm version check subprocess, writes cache to `~/.config/opencode/cache/are-update-check.json`.

### Session End Hooks

**[are-session-end.js](./are-session-end.js)** — Claude/Gemini SessionEnd hook executing `git status --porcelain` change detection, spawning detached `npx agents-reverse-engineer@latest update --quiet` subprocess if uncommitted changes detected, exits silently if `ARE_DISABLE_HOOK=1` or config contains `hook_enabled: false` substring.

**[opencode-are-session-end.js](./opencode-are-session-end.js)** — OpenCode plugin exporting `AreSessionEnd()` async factory returning `event['session.deleted']` handler that executes identical git status check and detached update spawn as Claude/Gemini variant.

## Architecture

### Detached Subprocess Pattern

All hooks use identical background process spawning pattern:
```javascript
spawn(process.execPath, ['-e', scriptString], { 
  stdio: 'ignore', 
  detached: true, 
  windowsHide: true 
}).unref()
```

Inline script via `-e` flag executes synchronous Node.js APIs (`execSync`, `readFileSync`, `writeFileSync`) in isolated process that survives parent termination. `stdio: 'ignore'` prevents output blocking session lifecycle, `unref()` allows parent exit without waiting for completion.

### Version File Resolution

Check update hooks read sentinel `ARE-VERSION` file in priority order:
1. Project-local: `<cwd>/.{claude,opencode}/ARE-VERSION`
2. Global: `~/{.claude,.config/opencode}/ARE-VERSION`

Falls back to `'0.0.0'` if neither exists. Installer writes this file during setup (`src/installer/operations.ts`).

### Cache Schema

Version check subprocess writes JSON to platform-specific cache:
- Claude/Gemini: `~/.claude/cache/are-update-check.json`
- OpenCode: `~/.config/opencode/cache/are-update-check.json`

**Format:**
```json
{
  "update_available": boolean,
  "installed": "semver-string",
  "latest": "semver-string" | "unknown",
  "checked": 1234567890
}
```

### Disable Mechanisms

Session-end hooks exit silently when:
- `process.env.ARE_DISABLE_HOOK === '1'`
- `.agents-reverse-engineer.yaml` exists and contains substring `'hook_enabled: false'` (no YAML parser)

### Change Detection

Session-end hooks execute `execSync('git status --porcelain', { encoding: 'utf-8' })` and exit silently if output is empty (no uncommitted changes) or if command throws (non-git repo).

## File Relationships

**Hook installation:** `src/installer/operations.ts` copies hooks to platform-specific directories and writes `ARE-VERSION` sentinel file.

**Build process:** `scripts/build-hooks.js` copies hook files to `hooks/dist/` directory for npm tarball inclusion before publish.

**Session-end update invocation:** Spawns `npx agents-reverse-engineer@latest update --quiet` which executes `src/cli/update.ts` orchestrator with hash-based change detection and incremental regeneration.

**Platform path resolution:** `src/installer/paths.ts` provides platform-specific config directory lookup respecting environment overrides (`CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`).

## Behavioral Contracts

**Git status command:** `'git status --porcelain'` with `{ encoding: 'utf-8' }` — detects uncommitted changes (modified/staged/untracked files).

**npm version query:** `'npm view agents-reverse-engineer version'` with `{ encoding: 'utf8', timeout: 10000, windowsHide: true }` — queries registry for latest published version.

**Update invocation:** `['npx', 'agents-reverse-engineer@latest', 'update', '--quiet']` — spawns latest published version with `--quiet` flag suppressing terminal output.

**Config disable check pattern:** `readFileSync('.agents-reverse-engineer.yaml', 'utf-8').includes('hook_enabled: false')` — substring match without YAML parsing for fast disable detection.

**Cache directory creation:** `mkdirSync(cacheDir, { recursive: true })` — ensures `~/{.claude,.config/opencode}/cache/` exists before subprocess spawn.