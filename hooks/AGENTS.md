<!-- Generated by agents-reverse-engineer -->

# hooks

This directory contains Node.js hook scripts for Claude CLI and OpenCode that enable automatic background update checks and incremental documentation regeneration when sessions start or end.

## Contents

### Claude CLI Hooks

[are-check-update.js](./are-check-update.js) — Spawns detached background process on session start to check npm registry for `agents-reverse-engineer` version updates, writing cache to `~/.claude/cache/are-update-check.json`. Detects installed version from `.claude/ARE-VERSION` (project-local) or `~/.claude/ARE-VERSION` (global), queries `npm view agents-reverse-engineer version` with 10-second timeout, compares versions, and writes JSON schema `{ update_available: boolean, installed: string, latest: string, checked: number }`.

[are-session-end.js](./are-session-end.js) — Triggers `npx agents-reverse-engineer@latest update --quiet` in detached background process when session ends if `git status --porcelain` reports uncommitted changes. Exits early if `ARE_DISABLE_HOOK=1` environment variable set or `.agents-reverse-engineer.yaml` contains `hook_enabled: false` string (naive substring match, not YAML parsing).

### OpenCode Hooks

[opencode-are-check-update.js](./opencode-are-check-update.js) — Exports `AreCheckUpdate` async function returning `{ event: { 'session.created': handler } }` plugin object for OpenCode session start hook. Spawns detached version check process writing to `~/.config/opencode/cache/are-update-check.json`, reading version from `~/.opencode/ARE-VERSION` (project) or `~/.config/opencode/ARE-VERSION` (global).

[opencode-are-session-end.js](./opencode-are-session-end.js) — Exports `AreSessionEnd` async function returning `{ event: { 'session.deleted': handler } }` plugin object for OpenCode session end hook. Spawns background `npx agents-reverse-engineer@latest update --quiet` if git working tree dirty, using identical disablement logic to `are-session-end.js`.

## Background Process Pattern

All hooks use `spawn(process.execPath, ['-e', inlineCode])` or `spawn('npx', ...)` with:
- `detached: true` — allows subprocess to outlive parent session
- `stdio: 'ignore'` — suppresses all subprocess I/O
- `windowsHide: true` — prevents console window flash on Windows
- `child.unref()` — prevents subprocess from blocking parent exit

## Cache Locations

**Claude CLI:**
- Update check cache: `~/.claude/cache/are-update-check.json`
- Version files: `.claude/ARE-VERSION` (project), `~/.claude/ARE-VERSION` (global)

**OpenCode:**
- Update check cache: `~/.config/opencode/cache/are-update-check.json`
- Version files: `.opencode/ARE-VERSION` (project), `~/.config/opencode/ARE-VERSION` (global)

## Disablement Mechanisms

Both session-end hooks support two opt-out methods:
1. `ARE_DISABLE_HOOK=1` environment variable
2. `hook_enabled: false` in `.agents-reverse-engineer.yaml` (detected via naive `config.includes('hook_enabled: false')` check)

## Integration Points

- **Update check logic:** Inline JavaScript injected into `spawn('-e', ...)` via template literals, using `JSON.stringify` to serialize file paths into spawned subprocess code
- **Incremental updates:** Delegates to `npx agents-reverse-engineer@latest update --quiet` command (see [../src/cli/update.ts](../src/cli/update.ts))
- **Git change detection:** Executes `git status --porcelain` via `execSync` with `encoding: 'utf-8'`, treating empty output or exceptions as "no changes"

## Behavioral Contracts

**Version file precedence:**
- Claude CLI: `<cwd>/.claude/ARE-VERSION` → `~/.claude/ARE-VERSION` → `'0.0.0'`
- OpenCode: `<cwd>/.opencode/ARE-VERSION` → `~/.config/opencode/ARE-VERSION` → `'0.0.0'`

**npm view timeout:** `execSync('npm view agents-reverse-engineer version', { timeout: 10000 })` — 10-second hard limit

**Git status exit conditions:**
- `execSync('git status --porcelain', { encoding: 'utf-8' })` returns truthy string → trigger update
- Exception thrown (non-git repo, missing git) → silent exit
- Empty string → silent exit