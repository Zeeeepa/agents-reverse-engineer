<!-- Generated by agents-reverse-engineer -->

# hooks

**Session lifecycle automation scripts for IDE integration: background version checking at session start and automatic documentation updates at session end across Claude Code, Gemini CLI, and OpenCode platforms via detached subprocess spawning with git-based change detection.**

## Contents

### Platform-Agnostic Scripts

**[are-check-update.js](./are-check-update.js)** — SessionStart hook spawning detached `npm view` query comparing registry version against local ARE-VERSION files, writing availability status to `~/.claude/cache/are-update-check.json` with schema `{ update_available, installed, latest, checked }`. Prioritizes `.claude/ARE-VERSION` over `~/.claude/ARE-VERSION`, defaults to `'0.0.0'` if missing. Executes via shebang `#!/usr/bin/env node`.

**[are-session-end.js](./are-session-end.js)** — SessionEnd hook executing `npx agents-reverse-engineer@latest update --quiet` as detached process when `git status --porcelain` detects uncommitted changes. Exits early if `ARE_DISABLE_HOOK=1` environment variable set or `.agents-reverse-engineer.yaml` contains `hook_enabled: false` substring. ES module using `import` syntax.

### OpenCode Plugin Wrappers

**[opencode-are-check-update.js](./opencode-are-check-update.js)** — Exports `AreCheckUpdate()` async factory returning `{ event: { 'session.created': AsyncFunction } }` plugin object. Handler spawns detached Node.js subprocess writing to `~/.config/opencode/cache/are-update-check.json`. Reads version from `.opencode/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`, queries npm registry with 10s timeout, creates cache directory via `mkdirSync(cacheDir, { recursive: true })`.

**[opencode-are-session-end.js](./opencode-are-session-end.js)** — Exports `AreSessionEnd()` async factory returning `{ event: { 'session.deleted': AsyncFunction } }` plugin object. Implements four-stage gate: environment check (`ARE_DISABLE_HOOK`), config substring search (`hook_enabled: false`), git status parsing, detached `npx` spawn with `stdio: 'ignore'` and `child.unref()`.

## Architecture

### Detached Background Execution Pattern

All hooks use identical spawn pattern to prevent blocking IDE session lifecycle:

```javascript
spawn(process.execPath, ['-e', scriptString], {
  stdio: 'ignore',
  detached: true,
  windowsHide: true
}).unref()
```

Inline script injection via `-e` flag avoids filesystem dependencies. `stdio: 'ignore'` suppresses output streams. `detached: true` creates independent process group. `unref()` allows parent process termination without waiting for child completion. `windowsHide: true` prevents console window flash on Windows.

### Version File Resolution Priority

Check hooks prioritize project-local over global version files:

1. **Claude/Gemini**: `.claude/ARE-VERSION` → `~/.claude/ARE-VERSION`
2. **OpenCode**: `.opencode/ARE-VERSION` → `~/.config/opencode/ARE-VERSION`

Resolution via `existsSync()` + `readFileSync()` with `'0.0.0'` fallback when neither exists.

### Cache File Schema

Update check hooks write JSON with four-field schema:

```json
{
  "update_available": boolean,  // installed !== latest (whitespace-trimmed)
  "installed": string,          // version from ARE-VERSION or '0.0.0'
  "latest": string,             // npm registry response or 'unknown' on error
  "checked": number             // Unix timestamp via Math.floor(Date.now() / 1000)
}
```

Cache locations:
- **Claude/Gemini**: `~/.claude/cache/are-update-check.json`
- **OpenCode**: `~/.config/opencode/cache/are-update-check.json`

Directory creation via `mkdirSync(cacheDir, { recursive: true })` before write.

### Disable Mechanisms

Session-end hooks implement two gates:

1. **Environment**: Exit if `process.env.ARE_DISABLE_HOOK === '1'`
2. **Config file**: Exit if `.agents-reverse-engineer.yaml` exists and `readFileSync().includes('hook_enabled: false')` (substring search, no YAML parser)

Both gates return silently without error signaling.

## Platform Integration

### Claude Code / Gemini CLI

Platform-agnostic scripts installed via `src/installer/operations.ts`:
- Check hook: `~/.claude/hooks/are-check-update.js` or `~/.gemini/hooks/are-check-update.js`
- End hook: `~/.claude/hooks/are-session-end.js` or `~/.gemini/hooks/are-session-end.js`

Runtime invocation via SessionStart/SessionEnd trigger names.

### OpenCode

Plugin factories installed to `~/.config/opencode/plugins/` or `$OPENCODE_CONFIG_DIR/plugins/`. Event handler contracts:
- `AreCheckUpdate()` → `event['session.created']`
- `AreSessionEnd()` → `event['session.deleted']`

Plugin objects returned from async factories conform to OpenCode event system shape `{ event: { [eventName]: AsyncFunction } }`.

## npm Registry Query

All check hooks execute `npm view agents-reverse-engineer version` via `execSync()` with options:
- `encoding: 'utf8'` for string output
- `timeout: 10000` (10 second limit)
- `windowsHide: true` to suppress console window on Windows

Try-catch wrapper sets `latest = 'unknown'` on network/timeout errors without propagating exceptions.

## Git Change Detection

Session-end hooks invoke `execSync('git status --porcelain', { encoding: 'utf-8' })` to detect uncommitted changes. Exit early if:
- `status.trim()` returns empty string (clean working tree)
- `execSync()` throws error (non-git repo or git unavailable)

No error logging — silent exit on all failure modes.

## File System Operations

**Shared imports across all hooks:**
- `fs`: `existsSync`, `mkdirSync`, `readFileSync`, `writeFileSync`
- `child_process`: `spawn`, `execSync`
- `path`: `join`
- `os`: `homedir`

**Module types:**
- `are-session-end.js`: ES module (`import` syntax)
- `are-check-update.js`, `opencode-*`: CommonJS-compatible (`#!/usr/bin/env node` shebang)

## Build Integration

Hooks copied to distribution via `scripts/build-hooks.js` during `npm run build:hooks` (invoked by `prepublishOnly`). No TypeScript compilation — plain JavaScript for direct execution in IDE runtime environments.