<!-- Generated by agents-reverse-engineer -->

# hooks

Claude Code, OpenCode, and Gemini Code integration hooks that automate ARE documentation updates on session lifecycle events and provide background version checking.

## Contents

### Session Lifecycle Hooks

**[are-session-end.js](./are-session-end.js)** — Claude Code SessionEnd hook. Spawns detached `npx agents-reverse-engineer@latest update --quiet` background process when session closes if `git status --porcelain` reports uncommitted changes. Disabled via `ARE_DISABLE_HOOK=1` environment variable or `hook_enabled: false` in `.agents-reverse-engineer.yaml`.

**[opencode-are-session-end.js](./opencode-are-session-end.js)** — OpenCode plugin exporting `AreSessionEnd` async function with `event['session.deleted']` handler. Mirrors `are-session-end.js` behavior but uses OpenCode plugin event system.

### Update Check Hooks

**[are-check-update.js](./are-check-update.js)** — Claude Code SessionStart background checker. Spawns detached Node.js child executing `npm view agents-reverse-engineer version` via `execSync`, writes JSON cache to `~/.claude/cache/are-update-check.json` with fields `update_available`, `installed` (from `.claude/ARE-VERSION` or `~/.claude/ARE-VERSION`), `latest`, `checked` (Unix timestamp).

**[opencode-are-check-update.js](./opencode-are-check-update.js)** — OpenCode plugin exporting `AreCheckUpdate` with `event['session.created']` handler. Checks `${cwd}/.opencode/ARE-VERSION` then `~/.config/opencode/ARE-VERSION` for installed version, writes cache to `~/.config/opencode/cache/are-update-check.json`.

## Integration Architecture

Hook scripts installed to `~/.claude/hooks/`, `~/.config/opencode/plugins/`, or `~/.config/gemini-code/hooks/` by `src/installer/operations.ts`. Built via `scripts/build-hooks.js` (replaces `__VERSION__` placeholder with `src/version.ts` export).

SessionEnd hooks execute `are update --quiet` only when:
1. Config check: `existsSync('.agents-reverse-engineer.yaml')` && file content excludes `'hook_enabled: false'`
2. Git dirty state: `execSync('git status --porcelain')` returns non-empty trimmed output
3. Override disabled: `process.env.ARE_DISABLE_HOOK !== '1'`

Update check hooks run once per session start, spawn detached background process via `spawn(process.execPath, ['-e', inlineScript], { stdio: 'ignore', detached: true, windowsHide: true })` followed by `child.unref()` to prevent parent blocking.

## Behavioral Contracts

### Process Detachment Pattern
```javascript
spawn(process.execPath, ['-e', inlineScript], { stdio: 'ignore', detached: true, windowsHide: true })
child.unref()
```

### Version File Resolution Order
1. Project-local: `.claude/ARE-VERSION` (Claude) or `${cwd}/.opencode/ARE-VERSION` (OpenCode)
2. Global fallback: `~/.claude/ARE-VERSION` (Claude) or `~/.config/opencode/ARE-VERSION` (OpenCode)
3. Default: `'0.0.0'` on `readFileSync` failure

### Git Status Check
```javascript
execSync('git status --porcelain', { encoding: 'utf-8' })
```
Exits early if output trimmed to empty string or command throws.

### npm Registry Query
```javascript
execSync('npm view agents-reverse-engineer version', { encoding: 'utf8', timeout: 10000, windowsHide: true })
```
Sets `latest: 'unknown'` on timeout/network failure.

### Cache File Schema
```json
{
  "update_available": boolean,
  "installed": string,
  "latest": string,
  "checked": number
}
```

## File Relationships

**are-session-end.js** and **opencode-are-session-end.js** share identical disable logic (env var + config file check) and git status detection but differ in export format (script vs plugin function).

**are-check-update.js** and **opencode-are-check-update.js** implement identical version comparison algorithm but target different cache directories (`~/.claude/cache/` vs `~/.config/opencode/cache/`) and version file paths.

Build script **scripts/build-hooks.js** preprocesses all four hooks by replacing `__VERSION__` placeholder with runtime version from **src/version.ts**.