<!-- Generated by agents-reverse-engineer v0.8.2 -->

# test/ai/backends

Test suite validating OpenCodeBackend NDJSON parsing, multi-turn token aggregation, cost calculation, and error handling.

## Contents

**[opencode.test.ts](./opencode.test.ts)** — Validates `OpenCodeBackend.parseResponse()` via 10 parsing tests (single-turn extraction, multi-turn aggregation, cost fallback, empty output errors, malformed line resilience, real-world fixture validation) and 3 `buildArgs()` tests (default args, model injection, unsupported option filtering). Exports `ndjson()` helper constructing test fixtures via JSON-stringified event arrays.

## Test Coverage

### parseResponse() Validation

`testNormalSingleTurn()` extracts text "2 + 2 = 4" from `step_start` → `text` → `step_finish` NDJSON sequence, verifies `inputTokens: 2`, `outputTokens: 13`, `cacheCreationTokens: 17100`, `durationMs: 5000`, `exitCode: 0`.

`testMultiTurnAggregation()` concatenates "First part. Second part." across two turns, aggregates `inputTokens: 15`, `outputTokens: 150`, `cacheReadTokens: 70`, `cacheCreationTokens: 70`, stores `raw.numTurns: 2`, `raw.reasoningTokens: 10`.

`testCostCalculationFallback()` applies formula when provider returns `cost: 0`: `(inputTokens / 1e6) * 15 + (outputTokens / 1e6) * 75 + (cacheReadTokens / 1e6) * 1.5 + (cacheCreationTokens / 1e6) * 18.75` → `raw.calculatedCost: 15` for 1M input tokens.

`testCostFromProvider()` passes through non-zero provider cost: `cost: 0.50` → `raw.calculatedCost: 0.50`.

`testEmptyOutput()` asserts `AIServiceError` with `code: "PARSE_ERROR"` for empty stdout.

`testNoTextEvents()` asserts `AIServiceError` with message "No text content" when NDJSON lacks `type: "text"` events.

`testMalformedLines()` skips unparseable lines "not json at all" / "{broken json", extracts valid `type: "text"` event with text "Good", aggregates tokens from valid `step_finish`.

`testEmptyLinesSkipped()` confirms empty lines ignored during NDJSON parsing.

`testMissingTokensField()` returns zero tokens when `step_finish.part.tokens` absent.

`testRealWorldOutput()` validates against actual `opencode run --format json` output (three 180-character NDJSON lines with sessionID/messageID metadata).

### buildArgs() Validation

`testBuildArgsBasic()` verifies default args: `['run', '--format', 'json']` for `{prompt: 'Hello'}`.

`testBuildArgsWithModel()` appends `['--model', 'anthropic/claude-sonnet-4-5']` when model specified.

`testBuildArgsIgnoresUnsupported()` confirms silent filtering of `systemPrompt` / `maxTurns` (OpenCode CLI limitations).

## Behavioral Contracts

### NDJSON Event Schema
```typescript
{type: 'step_start', part: {type: 'step-start', snapshot: string}}
{type: 'text', part: {type: 'text', text: string, time: {start: number, end: number}}}
{type: 'step_finish', part: {
  type: 'step-finish', reason: string, cost: number,
  tokens: {total: number, input: number, output: number, reasoning: number, cache: {read: number, write: number}}
}}
```

### Cost Calculation Formula
```typescript
(inputTokens / 1_000_000) * 15 + (outputTokens / 1_000_000) * 75 + (cacheReadTokens / 1_000_000) * 1.5 + (cacheCreationTokens / 1_000_000) * 18.75
// Rates: input $15/MTok, output $75/MTok, cache-read $1.5/MTok, cache-write $18.75/MTok
```

### Multi-Turn Aggregation
Text concatenation with space preservation. Token summation: `total.input += turn.tokens.input`, `total.output += turn.tokens.output`, `total.cache.read += turn.tokens.cache.read`, `total.cache.write += turn.tokens.cache.write`, `total.reasoning += turn.tokens.reasoning`.

## Dependencies

Imports `OpenCodeBackend` from `../../../src/ai/backends/opencode.js`, `AIServiceError` from `../../../src/ai/types.js`, uses `node:assert/strict` for assertions.