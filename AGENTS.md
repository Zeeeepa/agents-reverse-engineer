<!-- Generated by agents-reverse-engineer -->

# agents-reverse-engineer

**CLI tool implementing Recursive Language Model (RLM) algorithm for AI-driven codebase documentation via three-phase pipeline: concurrent `.sum` file generation with subprocess pools, post-order `AGENTS.md` directory aggregation, and platform-specific root synthesis (`CLAUDE.md`/`GEMINI.md`/`OPENCODE.md`) with gitignore-aware discovery, SHA-256 incremental updates, and NDJSON telemetry.**

## Contents

### Configuration & Metadata

**[package.json](./package.json)** — Defines npm package identity (`agents-reverse-engineer@0.7.1`, MIT license), binary entry points (`are`, `agents-reverse-engineer` → `dist/cli/index.js`), dependencies (`fast-glob`, `ignore`, `isbinaryfile`, `simple-git`, `yaml`, `zod`, `ora`, `picocolors`), build scripts (`tsc`, `build-hooks.js`), and distribution whitelist (`["dist", "hooks/dist", "README.md", "LICENSE"]`).

**[tsconfig.json](./tsconfig.json)** — TypeScript compiler targeting ES2022 with NodeNext module resolution, strict type-checking, declaration/source map generation, compiling `src/**/*` → `dist/` with JSON module support for `package.json` version extraction.

**[LICENSE](./LICENSE)** — MIT License granting unrestricted use/modification/distribution rights with liability disclaimer, copyright held by GeoloeG-IsT (2026).

### Documentation

**[README.md](./README.md)** — User-facing installation guide (interactive `npx` installer with `--runtime`/`-g`/`-l` flags), command reference (`are init/discover/generate/update/specify/clean`, `/are-*` AI skills), configuration schema (`.agents-reverse-engineer/config.yaml` with `exclude.patterns`, `ai.backend`, `ai.concurrency`), generated artifact formats (`.sum` YAML frontmatter with `content_hash`, `AGENTS.md` directory overviews, root platform documents), workflow sequences (init → discover → generate → update), and concurrency tuning recommendations (1-10 range, default 2 for WSL/5 elsewhere).

**[LANGUAGES-MANIFEST.md](./LANGUAGES-MANIFEST.md)** — Reference table mapping 25 programming language ecosystems to manifest file patterns (`package.json`, `Cargo.toml`, `go.mod`, `pyproject.toml`, `pom.xml`, `build.gradle`, `Gemfile`, `composer.json`, `CMakeLists.txt`) with `✓` marks indicating detection support in Phase 2 directory aggregation via `detectManifestFiles()` (9 active patterns: JavaScript/Python/Go/Rust/Java/Ruby/PHP/C/C++).

## Subdirectories

**[.github/workflows/](./github/workflows/)** — CI/CD automation for npm publishing with Sigstore-signed provenance attestation via `actions/setup-node@v4` and `npm publish --provenance --access public` on `release[published]` events.

**[docs/](./docs/)** — Original vision document (`INPUT.md`) defining RLM algorithm with post-order traversal methodology, directory documentation schema (9 supplementary doc types: ARCHITECTURE.md, STACK.md, PATTERNS.md), multi-platform requirements (Claude/OpenCode/Gemini), and research references (GSD, BMAD, SpecKit).

**[hooks/](./hooks/)** — Session lifecycle automation scripts: `are-check-update.js` (SessionStart hook spawning detached `npm view` query with cache to `~/.claude/cache/are-update-check.json`), `are-session-end.js` (SessionEnd hook triggering `npx agents-reverse-engineer@latest update --quiet` on git changes), `opencode-are-check-update.js`/`opencode-are-session-end.js` (plugin wrappers exporting `event['session.created']`/`event['session.deleted']` handlers).

**[scripts/](./scripts/)** — Build automation via `build-hooks.js` copying `.js` files from `hooks/` → `hooks/dist/` during `prepublishOnly` lifecycle for npm tarball inclusion.

**[src/](./src/)** — TypeScript source tree implementing nine functional subsystems: `ai/` (subprocess pooling with retry/telemetry), `change-detection/` (git diff + SHA-256 hashing), `cli/` (command entry points with `parseArgs()` routing), `config/` (YAML schema validation with resource-adaptive concurrency), `discovery/` (gitignore-aware filtering with binary detection), `generation/` (three-phase orchestrator with prompt builders), `imports/` (regex-based import extraction), `installer/` (npx-driven hook deployment), `integration/` (platform-specific template generation), `orchestration/` (iterator-based worker pool with progress/trace/plan tracking), `output/` (picocolors terminal logging), `quality/` (code-vs-doc/code-vs-code/phantom-paths validation), `rebuild/` (AI-driven project reconstruction from specs), `specify/` (11-section spec synthesis from `AGENTS.md` corpus), `types/` (shared discovery result interfaces), `update/` (incremental regeneration with orphan cleanup).

## Architecture

### Three-Phase Generation Pipeline

**Phase 1 (Concurrent File Analysis)**: Iterator-based worker pool shares `tasks.entries()` across N workers via atomic `.next()` calls. Each worker invokes `AIService.call()` → `runSubprocess()` → `execFile()` spawning AI CLI subprocesses with resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE=4`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS=1`). Writes `.sum` files with YAML frontmatter containing SHA-256 `content_hash` for incremental update detection.

**Phase 2 (Post-Order Directory Aggregation)**: Sorts directories by depth descending via `path.relative().split(path.sep).length`. `isDirectoryComplete()` predicate polls child `.sum` existence before processing directory. `buildDirectoryPrompt()` aggregates child summaries via `readSumFile()`, subdirectory `AGENTS.md` files, import maps via `extractDirectoryImports()`, and manifest detection (9 types). Writes `AGENTS.md` preserving `AGENTS.local.md` user content above generated sections.

**Phase 3 (Root Document Synthesis)**: Sequential execution (concurrency=1) generates `CLAUDE.md`/`GEMINI.md`/`OPENCODE.md` consuming all `AGENTS.md` via `collectAgentsDocs()` recursive traversal, parsing root `package.json` for project metadata, enforcing synthesis-only constraints (no feature invention).

### Resource Management

**Subprocess limits**: 512MB heap (`--max-old-space-size`), 4 libuv threads (`UV_THREADPOOL_SIZE`), process group killing (`kill(-pid)`) on timeout. SIGTERM sent at `timeoutMs`, SIGKILL escalation after 5s grace period. Exponential backoff retry on rate limits (stderr patterns: `["rate limit", "429", "too many requests", "overloaded"]`).

**Concurrency formula**: `clamp(os.availableParallelism() * 5, 2, min(20, floor(os.totalmem() * 0.5 / 0.512)))` prevents RAM exhaustion in WSL/low-memory environments.

### Incremental Update Strategy

Hash-based change detection via `.sum` frontmatter `content_hash` comparison against SHA-256 of current content. Segregates files into `filesToAnalyze` (added/modified), `filesToSkip` (unchanged), `cleanup` (orphaned). `cleanupOrphans()` deletes `.sum`/`.annex.md` for deleted/renamed sources. `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with no remaining files. `getAffectedDirectories()` walks parent paths to root, sorts deepest-first. Regenerates Phase 1 for changed files, Phase 2 for affected directories (skips Phase 3).

### Quality Validation

**Code-vs-Doc**: Extracts exported symbols via regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, verifies substring presence in `.sum` summaries.

**Code-vs-Code**: Aggregates exports into `Map<symbol, string[]>` per directory, reports duplicates.

**Phantom Paths**: Extracts file references via three patterns (markdown links, backtick paths, prose-embedded `src/` mentions), resolves via `existsSync()` at `agentsMdDir`/`projectRoot`/.ts fallback locations, filters via `SKIP_PATTERNS` (node_modules, .git, URLs, template syntax).

### Telemetry & Tracing

**Run logs** (`.agents-reverse-engineer/logs/run-<timestamp>.json`): Aggregates token counts, costs, durations, errors per AI call. Tracks `filesRead[]` with `path`, `sizeBytes`, `linesRead`. Enforces retention via `cleanupOldLogs(keepCount)`.

**Trace events** (`.agents-reverse-engineer/traces/trace-<timestamp>.ndjson`): Emits `phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry` events with auto-populated `seq`/`ts`/`pid`/`elapsedMs` fields. Promise-chain serialization ensures NDJSON line order.

**Progress log** (`.agents-reverse-engineer/progress.log`): Streams `[X/Y] ANALYZING/DONE/FAIL path` with ETA calculation via moving average of last 10 task durations.

## Workflows

### Installation

Interactive installer via `npx agents-reverse-engineer@latest` prompts for runtime (`claude`, `opencode`, `gemini`, `all`) and location (`-g` global, `-l` local). Non-interactive mode uses `--runtime <rt>` with `-g`/`-l` flags. Installs commands to `~/.claude/commands/`, hooks to `~/.claude/hooks/`, registers ARE permissions in `settings.json`, writes `ARE-VERSION` file.

### Documentation Generation

1. **Initialize**: `are init` → creates `.agents-reverse-engineer/config.yaml`
2. **Discover**: `are discover --plan` → writes `GENERATION-PLAN.md` with post-order traversal plan
3. **Generate**: `are generate` → Phase 1 (`.sum`), Phase 2 (`AGENTS.md`), Phase 3 (root docs)
4. **Update**: `are update --uncommitted` → incremental regeneration for changed files only
5. **Clean**: `are clean` → removes `.sum`, generated `AGENTS.md`, root docs

### Project Specification Synthesis

`are specify` aggregates all `AGENTS.md` into `specs/SPEC.md` with 11-section structure: Project Overview, Architecture, Public API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts (Runtime Behavior + Implementation Contracts), Test Contracts, Build Plan, Prompt Templates, IDE Integration. Use `--multi-file` for split specs (`specs/<slug>.md`), `--dry-run` for preview.

## Behavioral Contracts

### Subprocess Resource Limits
```
NODE_OPTIONS='--max-old-space-size=512'
UV_THREADPOOL_SIZE=4
CLAUDE_CODE_DISABLE_BACKGROUND_TASKS=1
--disallowedTools Task
```

### Process Lifecycle Timeouts
- SIGTERM at `timeoutMs`
- SIGKILL at `timeoutMs + 5000ms`
- Process group kill: `kill(-pid, 'SIGKILL')`

### Rate Limit Detection Patterns
```javascript
["rate limit", "429", "too many requests", "overloaded"]
```

### Exponential Backoff Formula
```typescript
min(baseDelayMs * multiplier^attempt, maxDelayMs) + Math.random() * 500
// Default: { maxRetries: 3, baseDelayMs: 1000, maxDelayMs: 8000, multiplier: 2 }
```

### Export Extraction Regex
```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```

### Import Extraction Regex
```regex
/^import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm
```

### Phantom Path Extraction Patterns
```javascript
/\[(?:[^\]]*)\]\((\.[^)]+)\)/g                          // Markdown links
/`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g              // Backtick paths
/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi     // Prose-embedded paths
```

### Git Diff Format
```
A       → { status: 'added', path }
M       → { status: 'modified', path }
D       → { status: 'deleted', path }
R<pct>  → { status: 'renamed', path: newPath, oldPath }
```

## IDE Integration

Commands installed via `npx agents-reverse-engineer@latest --runtime <rt> -g`:

- `/are-init` — Create `.agents-reverse-engineer/config.yaml`
- `/are-discover` — Preview generation plan
- `/are-generate` — Full documentation generation (long-running: use `run_in_background: true`, poll `progress.log` with `tail -5`)
- `/are-update` — Incremental update
- `/are-specify` — Synthesize project specification
- `/are-clean` — Remove generated artifacts

Session hooks:
- **SessionStart**: `are-check-update.js` (version check with cache)
- **SessionEnd**: `are-session-end.js` (auto-update on git changes)

Disable hooks: `ARE_DISABLE_HOOK=1` or `hook_enabled: false` in config.

## Dependencies

**Runtime**: Node.js ≥18.0.0 (ES modules)

**Core**: `fast-glob` (file discovery), `ignore` (gitignore parsing), `isbinaryfile` (binary detection), `simple-git` (git diff), `yaml` (config parsing), `zod` (schema validation)

**UI**: `ora` (spinners), `picocolors` (ANSI colors)

**Build**: TypeScript 5.7.3 (ES2022 target, NodeNext resolution, strict mode), `tsx` (dev watch mode)