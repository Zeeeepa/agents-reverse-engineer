<!-- Generated by agents-reverse-engineer -->

# agents-reverse-engineer

**AI-driven codebase documentation generator executing Recursive Language Model (RLM) algorithm: concurrent per-file `.sum` analysis via subprocess pools, post-order directory `AGENTS.md` aggregation, and platform-specific root synthesis (`CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`) with gitignore-aware discovery, SHA-256 incremental updates, and session lifecycle hooks.**

## Contents

### Core Files

**[package.json](./package.json)** — npm manifest defining agents-reverse-engineer v0.6.3 with dual binary entry points (`are`, `agents-reverse-engineer` → `dist/cli/index.js`), 8 runtime dependencies (fast-glob, ignore, isbinaryfile, ora, picocolors, simple-git, yaml, zod), TypeScript build scripts (`build` → `tsc`, `build:hooks` → `node scripts/build-hooks.js`), `prepublishOnly` lifecycle hook executing sequential compilation + hook file copying, Node.js ≥18.0.0 engine requirement, MIT license, ES module type, distribution files array (dist, hooks/dist, README.md, LICENSE).

**[tsconfig.json](./tsconfig.json)** — TypeScript compiler configuration targeting ES2022 output with NodeNext module resolution, strict type checking (`strict: true`, `forceConsistentCasingInFileNames: true`, `isolatedModules: true`), build pipeline settings (`outDir: "dist"`, `rootDir: "src"`, `declaration: true`, `declarationMap: true`, `sourceMap: true`), JSON module imports via `resolveJsonModule: true`, CommonJS interop via `esModuleInterop: true`, compilation scope (`include: ["src/**/*"]`, `exclude: ["node_modules", "dist"]`).

**[README.md](./README.md)** — User onboarding guide documenting installation workflows (interactive `npx agents-reverse-engineer@latest`, non-interactive `--runtime <rt> {-g|-l}`, uninstall protocol), CLI command reference (init/discover/generate/update/specify/clean), AI assistant slash commands (9 IDE integrations: `/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`), configuration schema (`.agents-reverse-engineer/config.yaml` with 13 documented fields: exclude patterns/vendorDirs/binaryExtensions, ai.backend/model/timeoutMs/maxRetries/concurrency/telemetry/pricing), generated documentation formats (`.sum` YAML frontmatter, `AGENTS.md` directory overviews, `CLAUDE.md`/`GEMINI.md`/`OPENCODE.md` root integration docs), three-phase pipeline execution (Phase 1: file analysis concurrent, Phase 2: directory aggregation post-order, Phase 3: root synthesis sequential), incremental update strategy (SHA-256 content hashing, orphan cleanup via `cleanupOrphans()`/`cleanupEmptyDirectoryDocs()`, affected directory computation via `getAffectedDirectories()`), session hooks (Claude/Gemini auto-update on session end), resource constraints (WSL concurrency default 2 vs. 5 elsewhere).

**[LICENSE](./LICENSE)** — MIT License granting unrestricted commercial use, modification, distribution, sublicensing without warranty, copyright holder GeoloeG-IsT (2026), requires copyright notice preservation in all copies, disclaims liabilities for SOFTWARE PROVIDED "AS IS".

**[LANGUAGES-MANIFEST.md](./LANGUAGES-MANIFEST.md)** — Package manager manifest file reference matrix documenting 24 programming language ecosystems with columns `Language`, `Manifest File(s)`, `Package Manager`, `Supported` (checkmark indicates ARE's `detectManifests()` in `src/generation/prompts/builder.ts` actively checks for these files). Supported entries (4 ecosystems): JavaScript/TypeScript `package.json`, Python `requirements.txt`/`pyproject.toml`/`setup.py`/`Pipfile`, Go `go.mod`, Rust `Cargo.toml`. Unsupported entries (20 ecosystems): Ruby `Gemfile`, Java `pom.xml`/`build.gradle`, Kotlin `build.gradle.kts`, C# `*.csproj`, PHP `composer.json`, Swift `Package.swift`, Elixir `mix.exs`, Erlang `rebar.config`, Scala `build.sbt`, Clojure `deps.edn`/`project.clj`, Haskell `package.yaml`/`*.cabal`, Dart `pubspec.yaml`, Lua `*.rockspec`, R `DESCRIPTION`, Julia `Project.toml`, Zig `build.zig.zon`, Nim `*.nimble`, OCaml `dune-project`/`*.opam`, C/C++ `CMakeLists.txt`/`conanfile.txt`/`vcpkg.json`. Used by directory aggregation prompts to infer dependency structure.

## Subsystems

**[src/](./src/)** — Core TypeScript implementation of three-phase AI pipeline: concurrent file analysis via iterator-based worker pool (`orchestration/pool.ts`) spawning AI CLI subprocesses (`ai/subprocess.ts`) with resource limits (512MB heap, 4 libuv threads, process group killing via `kill(-pid)`, SIGTERM/SIGKILL timeout enforcement, exponential backoff retry on rate limits), generating `.sum` files with YAML frontmatter (`generation/writers/sum.ts`) containing SHA-256 content hashes (`change-detection/hash.ts`) and markdown summaries; post-order directory aggregation (`generation/executor.ts`) sorting by depth descending, waiting for child completion via `isDirectoryComplete()`, injecting subdirectory `AGENTS.md` + import maps (`imports/analyzer.ts`) + manifest detection (9 types: package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile); sequential root synthesis (`generation/prompts/builder.ts`) consuming `collectAgentsDocs()` recursive traversal + root package.json metadata, stripping conversational preamble before writing (`generation/writers/root.ts`). Includes gitignore-aware discovery (`discovery/walker.ts`) with composable filter chain (IgnoreFilter/BinaryFilter/VendorFilter/CustomFilter), quality validation (`quality/`) detecting code-vs-doc inconsistencies via regex export extraction + substring search, code-vs-code duplicate symbols, phantom path references via `existsSync()` resolution, incremental update orchestration (`update/orchestrator.ts`) using content hash comparison + orphan cleanup + affected directory computation, NDJSON telemetry logging (`ai/telemetry.ts`) with token cost tracking + retention management (50 runs, 500 traces), npx installer (`installer/orchestrator.ts`) with interactive runtime selection + settings.json hook registration + bash command auto-approval, platform-specific template generation (`integration/`) for Claude Code/OpenCode/Gemini with long-running task patterns.

**[hooks/](./hooks/)** — Session lifecycle automation scripts installed by npx to runtime-specific directories (`~/.claude/hooks`, `~/.gemini/hooks`, `~/.config/opencode/plugins`). `are-check-update.js` spawns detached background process on SessionStart querying `npm view agents-reverse-engineer version`, compares against `~/.claude/ARE-VERSION`, caches result to `~/.claude/cache/are-update-check.json` with 24-hour TTL. `are-session-end.js` runs `git status --porcelain` on SessionEnd, spawns `npx agents-reverse-engineer@latest update --quiet` as detached process if changes detected. OpenCode variants (`opencode-are-check-update.js`, `opencode-are-session-end.js`) export async factories returning plugins with `event['session.created']`/`event['session.deleted']` handlers. Detached spawn pattern uses `stdio: 'ignore'`, `detached: true`, `windowsHide: true`, `.unref()`. Disable mechanisms: `ARE_DISABLE_HOOK=1` environment variable or `hook_enabled: false` in `.agents-reverse-engineer.yaml` (substring search).

**[scripts/](./scripts/)** — Build automation scripts executed by npm lifecycle hooks. `build-hooks.js` copies `hooks/` directory to `hooks/dist/` via recursive file operations, invoked by `npm run build:hooks` during `prepublishOnly` lifecycle, ensures session hook files bundled in npm tarball via `files: ["dist", "hooks/dist", ...]` in package.json.

**[docs/](./docs/)** — Original vision document defining RLM algorithm and architectural requirements (`INPUT.md`), serves as historical reference for design decisions predating implementation.

**[.github/workflows/](./.github/workflows/)** — CI/CD automation: npm publish workflow with provenance attestation, runs `npm run build && npm publish` on release tags, authenticates via `NPM_TOKEN` secret, uploads build artifacts with signed provenance linking published package to source commit.

## Architecture

### Three-Phase Generation Pipeline

**Phase 1 (Concurrent File Analysis):** Iterator-based worker pool (`src/orchestration/pool.ts`) shares single `tasks.entries()` iterator across N workers, each calling `AIService.call()` → `runSubprocess()` → `execFile()` spawning AI CLI subprocess with resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`, `--disallowedTools Task`). Process group killing via `kill(-pid)` terminates subprocess trees on timeout (SIGTERM at `timeoutMs`, SIGKILL escalation after 5s grace period). Exponential backoff retry on rate limits (stderr patterns: "rate limit", "429", "too many requests"). Writes `.sum` files with YAML frontmatter containing `generated_at`, `content_hash` (SHA-256 hex), `purpose`, `critical_todos`, `related_files`, followed by markdown summary content.

**Phase 2 (Post-Order Directory Aggregation):** Sorts directories by depth descending via `path.relative().split(path.sep).length` (deepest first). Waits for all child `.sum` files via `isDirectoryComplete()` predicate before processing directory. Prompts include aggregated child `.sum` content via `readSumFile()`, subdirectory `AGENTS.md` files via recursive traversal, import maps via `extractDirectoryImports()` with verified path constraints, manifest detection (9 types: package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile). User-authored `AGENTS.md` renamed to `AGENTS.local.md` and prepended above generated content. Writes `AGENTS.md` with `<!-- Generated by agents-reverse-engineer -->` marker.

**Phase 3 (Root Document Synthesis):** Sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`. Prompts consume all `AGENTS.md` files via `collectAgentsDocs()` recursive tree traversal, parse root `package.json` for project metadata, enforce synthesis-only constraints (no invention of features/hooks/patterns not in source documents). Strips conversational preamble via pattern matching before writing output.

### Subprocess Resource Management

Mitigates Claude CLI thread exhaustion (GitHub #5771: 200 NodeJS instances reported) via environment variables passed to `execFile()`: `NODE_OPTIONS='--max-old-space-size=512'` limits heap to 512MB per subprocess, `UV_THREADPOOL_SIZE='4'` constrains libuv thread pool to 4 threads, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` prevents background task spawning, `--disallowedTools Task` blocks subagent spawning. Process group killing via `kill(-pid)` terminates entire subprocess tree. Default concurrency reduced from 5 → 2 for WSL environments (detected via `/proc/version` "microsoft" substring).

### Incremental Update Strategy

`src/update/orchestrator.ts` implements hash-based delta regeneration: reads `content_hash` from each `.sum` file's YAML frontmatter via `readSumFile()`, computes current file content hash via `computeContentHash()` (SHA-256), hash mismatch → add to `filesToAnalyze` as `FileChange` with `status: 'modified'` or `'added'`, hash match → add to `filesToSkip`. Detects orphans (`.sum` files for deleted source files or renamed oldPaths), calls `cleanupOrphans()` to delete stale `.sum` files, calls `cleanupEmptyDirectoryDocs()` to remove `AGENTS.md` from directories with no remaining sources. Computes `affectedDirs` via `getAffectedDirectories()` by walking parent directories of changed files. Regenerates `.sum` for `filesToAnalyze` via Phase 1 pool execution, regenerates `AGENTS.md` for `affectedDirs` sequentially without full post-order traversal.

### Quality Validation

Post-generation validators (`src/quality/`) execute via throttled pool (concurrency=10) without blocking pipeline: `checkCodeVsDoc()` extracts exported symbols via regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, verifies all exports appear in `.sum` summary text via substring search, reports `CodeDocInconsistency` with `missingFromDoc` arrays. `checkCodeVsCode()` aggregates exports across per-directory file groups into `Map<symbol, string[]>`, reports `CodeCodeInconsistency` for symbols appearing in multiple files (pattern: `'duplicate-export'`). `checkPhantomPaths()` extracts path-like strings from `AGENTS.md` via three regex patterns (markdown link targets, backtick-quoted paths, prose-embedded paths), resolves against AGENTS.md directory and project root with `.ts`/`.js` fallback, reports `PhantomPathInconsistency` for unresolved references. Constructs `InconsistencyReport` with `metadata` (timestamp/projectRoot/filesChecked/durationMs), `issues[]` discriminated union, `summary` counts by type/severity.

### Telemetry & Tracing

**Run logs** (`.agents-reverse-engineer/logs/run-<timestamp>.json`): Aggregates per-call token counts, costs, durations, errors via `src/ai/telemetry.ts`, tracks `filesRead[]` metadata with `path`, `sizeBytes`, `linesRead`, computes summary `totalInputTokens`, `totalCacheReadTokens`, `errorCount`, `uniqueFilesRead`, enforces retention via `cleanupOldLogs(keepCount=50)` after each run.

**Trace events** (`.agents-reverse-engineer/traces/trace-<timestamp>.ndjson`): Enabled via `--trace` flag, emits NDJSON events via `src/orchestration/trace.ts` with 14 event types (`phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`, `discovery:start/end`, `planning:start/end`, `config:loaded`), auto-populated base fields (`seq` monotonic, `ts` ISO 8601, `pid`, `elapsedMs` high-resolution delta), promise-chain serialization ensures line order matches emission order despite concurrent workers, retention via `cleanupOldTraces(keepCount=500)`.

**Progress log** (`.agents-reverse-engineer/progress.log`): Human-readable streaming output mirroring console via `src/orchestration/progress.ts`, ETA calculation via moving average of last 10 task durations, quality metrics (code-vs-doc/code-vs-code inconsistencies, phantom path counts), real-time monitoring via `tail -f .agents-reverse-engineer/progress.log`.

## Stack

**Runtime:** Node.js ≥18.0.0, ES modules (`"type": "module"`), TypeScript 5.7.3 (ES2022 target, NodeNext module resolution, strict mode)

**Core Dependencies:** fast-glob (file discovery), ignore (gitignore parsing), isbinaryfile (binary detection), simple-git (git diff change detection), yaml (config parsing), zod (schema validation), ora (spinner UI), picocolors (terminal colors)

**AI Backends:** Claude Code (`@anthropic-ai/claude-code`), Gemini CLI (stub via `src/ai/backends/gemini.ts`, awaits JSON output stability), OpenCode CLI (stub via `src/ai/backends/opencode.ts`, awaits JSONL parsing)

**Build:** `npm run build` → `tsc` (src/ → dist/), `npm run build:hooks` → `node scripts/build-hooks.js` (hooks/ → hooks/dist/), `npm run prepublishOnly` → sequential execution

**Distribution:** Binary entry points (`are`, `agents-reverse-engineer` → `dist/cli/index.js`), npm package tarball includes `["dist", "hooks/dist", "README.md", "LICENSE"]`

## Configuration

**Config file:** `.agents-reverse-engineer/config.yaml`

**Schema sections:**
- `exclude.patterns` — Gitignore-style globs (e.g., `"*.log"`, `"**/*.test.ts"`)
- `exclude.vendorDirs` — Third-party directories to skip (default: node_modules, .git, dist, 15 others)
- `exclude.binaryExtensions` — Non-text file extensions (default: .png, .jpg, .zip, 23 others)
- `options.followSymlinks` — Boolean, default `false`
- `options.maxFileSize` — Binary detection threshold (1MB default)
- `output.colors` — Enable ANSI color codes in CLI output
- `ai.backend` — Backend selector: `'claude'` | `'gemini'` | `'opencode'` | `'auto'`
- `ai.model` — Override backend default model
- `ai.timeoutMs` — Subprocess timeout (120000ms default)
- `ai.maxRetries` — Exponential backoff retry attempts (3 default)
- `ai.concurrency` — Worker pool size (1-10, default 2 for WSL, 5 elsewhere)
- `ai.telemetry.enabled` — Write run logs to `.agents-reverse-engineer/logs/`
- `ai.telemetry.keepRuns` — Retention limit (50 default)
- `ai.telemetry.costThresholdUsd` — Warning threshold (10.0 default)
- `ai.pricing` — Per-backend token cost configuration (input/output/cacheRead/cacheWrite)

**Environment overrides:** `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`, `ARE_DISABLE_HOOK`

## IDE Integration

**Install commands/hooks:**
- Claude Code: `npx agents-reverse-engineer --runtime claude -g` → `~/.claude/commands/` + `~/.claude/hooks/`
- OpenCode: `npx agents-reverse-engineer --runtime opencode -g` → `~/.config/opencode/commands/` + `~/.config/opencode/plugins/`
- Gemini: `npx agents-reverse-engineer --runtime gemini -g` → `~/.gemini/commands/` (TOML format)

**Available commands:** `/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`, `/are-help`

**Session hooks:** `are-check-update.js` (SessionStart: npm version check), `are-session-end.js` (SessionEnd: auto-update on uncommitted changes)

**Long-running pattern:** Remove stale `progress.log`, run with `run_in_background: true`, poll via `tail -5` every 10-15s, check `TaskOutput` with `block: false`, summarize on completion