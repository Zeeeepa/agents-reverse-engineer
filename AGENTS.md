<!-- Generated by agents-reverse-engineer v0.8.2 -->

# agents-reverse-engineer

CLI tool for generating AI-friendly codebase documentation via recursive post-order traversal: parallel `.sum` file analysis followed by hierarchical `AGENTS.md` aggregation, with session hooks for incremental updates and cross-runtime support (Claude Code, Gemini CLI, OpenCode).

## Contents

### Documentation

**[CONTRIBUTING.md](./CONTRIBUTING.md)** — Developer onboarding: `npm install` → `npm run dev` (tsx watch) → `npm run build` (tsc → dist/). Six core directories: `src/cli/` (command handlers), `src/config/` (YAML/Zod validation), `src/discovery/` (four-filter chain), `src/generation/` (AI-driven docs), `src/orchestration/` (worker pool, tracing), `src/ai/` (subprocess management). Fork-based contribution process with PR requirements: `npm run build` succeeds, reproduction steps for bugs, use case descriptions for features.

**[LANGUAGES-MANIFEST.md](./LANGUAGES-MANIFEST.md)** — Maps 26 ecosystems to manifest patterns: JavaScript/TypeScript (`package.json`, npm/yarn/pnpm, ✓), Python (`requirements.txt`/`pyproject.toml`/`setup.py`/`Pipfile`, pip/poetry/pipenv, ✓), Go (`go.mod`, go modules, ✓), Rust (`Cargo.toml`, cargo, ✓), Ruby (`Gemfile`, bundler), Java (`pom.xml`/`build.gradle`, Maven/Gradle), C# (`*.csproj`/`packages.config`, NuGet), PHP (`composer.json`, Composer), Swift (`Package.swift`), Dart (`pubspec.yaml`, pub), Haskell (`package.yaml`/`*.cabal`/`stack.yaml`), C/C++ (`CMakeLists.txt`/`conanfile.txt`/`vcpkg.json`), plus 14 others. Informs `src/discovery/walker.ts` file discovery and `src/imports/extractor.ts` dependency extraction.

**[LICENSE](./LICENSE)** — MIT License (GeoloeG-IsT, 2026) granting unrestricted usage, modification, distribution with warranty disclaimer. Copyright notice + permission notice required in all copies/substantial portions. Applies to source tree (`src/`, `hooks/`, `dist/`) and compiled binaries per `package.json` `files` array.

**[README.md](./README.md)** — Installation: `npx agents-reverse-engineer@latest` (interactive) or `--runtime <rt> -g|-l` (non-interactive). Eight commands: `init` (config), `discover` (scan → GENERATION-PLAN.md), `generate` (two-phase pipeline), `update` (incremental regeneration), `specify` (AGENTS.md → specs/SPEC.md with `--multi-file` or `--dry-run`), `clean` (artifact deletion), `rebuild` (AI-driven reconstruction from specs with delimiter format `===FILE: path===` / `===END_FILE===`), `install`/`uninstall` (slash commands + session hooks). Artifact formats: `.sum` (YAML frontmatter + markdown sections), `AGENTS.md` (directory aggregates), `CLAUDE.md`/`GEMINI.md`/`OPENCODE.md` (runtime pointers). Config schema: `.agents-reverse-engineer/config.yaml` with exclude patterns, AI backend, concurrency, telemetry retention. Runtime support: Claude Code (full), Gemini CLI (full), OpenCode (AGENTS.md only).

### Configuration

**[package.json](./package.json)** — npm manifest v0.8.2: binaries `agents-reverse-engineer`/`are` → `dist/cli/index.js`. Dual exports: `./` (CLI), `./core` (@beta library API). Scripts: `build` (tsc), `build:hooks` (node scripts/build-hooks.js), `prepack` (rm -f LICENSE.sum README.md.sum), `prepublishOnly` (build + build:hooks), `dev` (tsx watch). Dependencies: fast-glob@3.3.3, ignore@7.0.3, isbinaryfile@5.0.4, jsonc-parser@3.3.1, ora@8.1.1, picocolors@1.1.1, simple-git@3.27.0, yaml@2.7.0, zod@3.24.1. Node.js >=18.0.0. Distribution: `dist/`, `hooks/dist/`, `README.md`, `LICENSE`.

**[tsconfig.json](./tsconfig.json)** — TypeScript config: ES2022 target, NodeNext module/moduleResolution (ESM via package.json `"type": "module"`), `outDir: "dist"`, `rootDir: "src"`. Emits `.d.ts` declarations with sourcemaps. Strict type-checking enabled. `resolveJsonModule: true` (JSON imports), `isolatedModules: true` (ts-loader/tsx compatibility). Includes `src/**/*`, excludes `node_modules`/`dist`.

## Subdirectories

**[docs/](./docs/)** — RLM algorithm specification defining post-order traversal (file `.sum` → leaf-complete `AGENTS.md` → recursive parent aggregation), slash command interface, session-end hooks, brownfield research directives (GSD workflow patterns, BMAD method, SpecKit structure). Contains INPUT.md with optional reference documents (ARCHITECTURE.md, STRUCTURE.md, STACK.md, INTEGRATIONS.md, INFRASTRUCTURE.md, CONVENTIONS.md, TESTING.md, PATTERNS.md, CONCERNS.md).

**[hooks/](./hooks/)** — Session lifecycle automation: `are-check-update.js` / `opencode-are-check-update.js` (SessionStart detached npm registry check → `~/.claude/cache/are-update-check.json` or `~/.config/opencode/cache/are-update-check.json`), `are-session-end.js` (SessionEnd detached `npx agents-reverse-engineer@latest update --quiet` on git change detection). Disable gates: `ARE_DISABLE_HOOK=1` env var, `hook_enabled: false` in `.agents-reverse-engineer.yaml`. Detached spawn pattern: `spawn(command, args, {stdio: 'ignore', detached: true, windowsHide: true})` + `child.unref()`. Version resolution priority: project-local `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`, global `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`, fallback `'0.0.0'`.

**[scripts/](./scripts/)** — Build automation: `build-hooks.js` copies `hooks/*.js` → `hooks/dist/` via `copyFileSync()` during `npm run build:hooks` / `prepublishOnly`. Creates destination with `mkdirSync({recursive: true})`, logs copied count. Ensures session hooks bundled in published package for `src/installer/operations.ts` `installSessionHooks()`.

**[src/](./src/)** — TypeScript source tree implementing CLI, configuration, discovery, generation, orchestration, AI integration, quality validation, update orchestration, rebuild pipeline, specification transformation. Entry point: `cli/index.ts`. Programmatic API: `core/index.ts` exports 60+ symbols via `'agents-reverse-engineer/core'` package.json export (@beta stability). Subsystems: `cli/` (command routing), `config/` (YAML/Zod validation), `discovery/` (four-filter chain), `generation/` (two-phase orchestration + prompt templates), `orchestration/` (iterator-based worker pool, NDJSON trace emission, serialized progress logging), `ai/` (multi-backend subprocess spawning with exponential backoff retry, telemetry, SIGTERM/SIGKILL timeout escalation), `update/` (frontmatter-based staleness detection + orphan cleanup), `quality/` (code-vs-doc/code-vs-code/phantom-paths validation), `rebuild/` (AI-driven reconstruction with checkpoint management), `specify/` (AGENTS.md → 12-section project spec), `imports/` (import/export extraction), `installer/` (interactive runtime integration), `integration/` (environment detection + command templates), `change-detection/` (git-based hash comparison).

**[.github/workflows/](../.github/workflows/)** — GitHub Actions CI/CD automation.

## Architecture

### Two-Phase Pipeline

**Phase 1 (File Analysis)**: `src/generation/orchestrator.ts` `createFileTasks()` builds `GenerationTask[]` with `buildFilePrompt()` (injects import maps, project structure, compression directives), executes via `src/orchestration/runner.ts` `runPool()` with user-configured concurrency (default: `os.availableParallelism() * 5` clamped to memory cap), spawns LLM subprocesses via `src/ai/subprocess.ts` `runSubprocess()` (SIGTERM at timeout, SIGKILL at timeout+5s), writes `.sum` files via `src/generation/writers/sum.ts` `writeSumFile()` with YAML frontmatter (`file_type`, `generated_at`, `content_hash`). Nullifies task content after prompt building to free memory.

**Phase 2 (Directory Aggregation)**: `createDirectoryTasks()` constructs dependency graph (child file task IDs), sorts by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending), groups by depth, executes depth-grouped sequential batches with parallel concurrency per group, `buildDirectoryPrompt()` reads child `.sum` via parallel `readSumFile()`, `src/generation/writers/agents-md.ts` `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` + injects `@AGENTS.local.md` directive, root `src/generation/writers/claude-md.ts` `writeClaudeMdPointer()` generates deterministic `CLAUDE.md` import.

### Concurrency Control

`src/orchestration/pool.ts` `runPool<T>()` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator. Each worker pulls `[index, task]` pairs until exhausted or `aborted` flag set. Maintains full utilization during variable-duration tasks. Optional `onComplete?: (result) => void` callback enables serialized `src/orchestration/plan-tracker.ts` `PlanTracker.markDone()` updates to `GENERATION-PLAN.md` checkboxes via promise-chain pattern. Calculation: `concurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))`.

### Update Strategy

`src/update/orchestrator.ts` `UpdateOrchestrator.preparePlan()` reads existing `.sum` YAML frontmatter via `src/generation/writers/sum.ts` `readSumFile()`, compares stored `content_hash` against `src/change-detection/detector.ts` `computeContentHash()` (SHA-256 hex digest), populates `filesToAnalyze` on mismatch, executes phase-1-files pipeline for changed files, invokes `getAffectedDirectories()` collecting parent directories sorted by depth descending, sequentially regenerates `AGENTS.md` consuming updated child `.sum`. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for git-deleted files, removes AGENTS.md when no source files remain.

### Telemetry Pipeline

`src/ai/service.ts` `AIService` wraps `runSubprocess()` in `src/ai/retry.ts` `withRetry()` (exponential backoff: `min(1000 * 2^attempt, 8000) + random(500)` for RATE_LIMIT errors only, timeouts NOT retried), records `src/ai/telemetry/run-log.ts` `TelemetryEntry` (prompt/response/tokens/cache/latency/exitCode/retryCount/thinking/filesRead), optional `src/orchestration/trace.ts` `TraceWriter` emits NDJSON events (`subprocess:spawn`, `subprocess:exit`, `retry`, `worker:start`, `task:done`, `phase:start`) to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` when `--trace` flag set. `aiService.finalize(projectRoot)` writes `RunLog` to `.agents-reverse-engineer/logs/run-{timestamp}.json`, calls `src/ai/telemetry/cleanup.ts` `cleanupOldLogs()` enforcing `config.ai.telemetry.keepRuns` retention.

### Quality Gates

`src/orchestration/runner.ts` `CommandRunner.run()` executes five phases: **pre-phase-1-cache** (reads existing `.sum` for baseline via `runPool()` concurrency 20), **phase-1-files** (parallel AI calls), **post-phase-1-quality** (throttled directory group checks: `src/quality/inconsistency/code-vs-doc.ts` `checkCodeVsDoc()` detects undocumented exports via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, `src/quality/inconsistency/code-vs-code.ts` `checkCodeVsCode()` finds duplicate symbols, concurrency 10 per group), **phase-2-dirs** (post-order aggregation), **post-phase-2** (`src/quality/phantom-paths/validator.ts` `checkPhantomPaths()` validates markdown links via `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g` + backtick paths + prose references with dual-resolution strategy + `.js`→`.ts` substitution). Aggregates findings via `src/quality/inconsistency/reporter.ts` `buildInconsistencyReport()`, emits severity-tagged CLI output via `formatReportForCli()`.

### Rebuild Workflow

`src/rebuild/spec-reader.ts` `readSpecFiles()` discovers `specs/*.md` → `partitionSpec()` extracts Build Plan phases via `/^### Phase (\d+):\s*(.+)$/gm` → `src/rebuild/checkpoint.ts` `CheckpointManager.load()` validates `.rebuild-checkpoint` JSON with spec drift detection (SHA-256 hash comparison) → `src/rebuild/orchestrator.ts` `executeRebuild()` groups `RebuildUnit[]` by `order` → sequential groups with concurrent `runPool()` per group → `src/rebuild/prompts.ts` `buildRebuildPrompt()` (injects Architecture + targeted subsections, accumulates `builtContext` truncated at 100KB) → `AIService.call()` → `src/rebuild/output-parser.ts` `parseModuleOutput()` (delimiter format: `===FILE: path===` / `===END_FILE===` with column-0 requirement, fallback to fenced-block parser) → writes files → `CheckpointManager.markDone()` serialized updates.

## Behavioral Contracts

### Exit Codes
- **0**: All tasks succeeded or no tasks to process
- **1**: Partial failure (some tasks failed but some succeeded)
- **2**: Total failure (all tasks failed or CLI not found)

### Concurrency Calculation
```javascript
concurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))
// Constants: SUBPROCESS_HEAP_GB=0.512, MEMORY_FRACTION=0.5, MULTIPLIER=5, MIN=2, MAX=20
```

### Exponential Backoff
```javascript
delay = min(1000 * 2^attempt, 8000) + Math.random() * 500
// Defaults: baseDelayMs=1000, multiplier=2, maxDelayMs=8000, jitter=[0,500ms]
```

### Retry Policy
```javascript
isRetryable: err => err.code === 'RATE_LIMIT'
// Timeouts NOT retried (subprocess overhead on struggling systems)
```

### Rate Limit Detection
```javascript
['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))
```

### Timeout Escalation
- SIGTERM at `options.timeoutMs` via `execFile()` timeout option
- SIGKILL at `options.timeoutMs + 5000ms` via `setTimeout(() => process.kill(-childPid, 'SIGKILL'), ...)` (process group)

### Post-Order Sort
```javascript
getDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth
// getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length
```

### Import Extraction
```regex
/^[ \t]*import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm
```
Captures: group 1 (type keyword), group 2 (named symbols), group 3 (namespace import), group 4 (default import), group 5 (module specifier).

### Export Extraction
```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```
Captures identifier in group 1 after export keyword and declaration type.

### Hook Disable Mechanisms
```javascript
process.env.ARE_DISABLE_HOOK === '1'
// OR
readFileSync('.agents-reverse-engineer.yaml').includes('hook_enabled: false')
```

### Version Resolution Priority
1. Project-local: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`
2. Global: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`
3. Fallback: `'0.0.0'` (discovery), `'unknown'` (version.ts)

### Update Check Cache Schema
```json
{
  "update_available": false,
  "installed": "0.8.0",
  "latest": "0.8.0",
  "checked": 1738416000
}
```

### Git Change Detection
```javascript
execSync('git status --porcelain', { encoding: 'utf-8' })
// Exit if status.trim() === '' (no changes) or command throws (not a git repo)
```

### Generated File Marker
```javascript
GENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'
```

### Compression Injection
```javascript
// Condition: compressionRatio < 0.5 && sourceFileSize > 0
targetSize = Math.round(sourceFileSize * compressionRatio)
maxSize = Math.round(targetSize * 1.2)
compressionPercentage = Math.round(compressionRatio * 100)
```

## Stack

- **Runtime**: Node.js >=18.0.0, ES modules (`"type": "module"`)
- **Language**: TypeScript 5.7.3 targeting ES2022 with NodeNext module resolution
- **Concurrency**: Iterator-based worker pool, shared iterator, N workers (src/orchestration/pool.ts)
- **File Discovery**: fast-glob@3.3.3 with ignore@7.0.3 (gitignore filtering)
- **Git Operations**: simple-git@3.27.0 for change detection (src/change-detection/detector.ts)
- **Config Parsing**: yaml@2.7.0 + zod@3.24.1 schema validation (src/config/schema.ts)
- **JSON Editing**: jsonc-parser@3.3.1 for settings.json hook registration (src/installer/operations.ts)
- **Binary Detection**: isbinaryfile@5.0.4 for `.sum` exclusion (src/discovery/filters/binary.ts)
- **Terminal UI**: ora@8.1.1 (spinners), picocolors@1.1.1 (colored output)
- **AI Backends**: subprocess spawning (src/ai/subprocess.ts) targeting `claude`, `gemini`, `opencode` CLIs
- **Build**: tsc (TypeScript compiler), tsx@4.19.2 (dev watch mode)