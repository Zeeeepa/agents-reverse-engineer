<!-- Generated by agents-reverse-engineer -->

# agents-reverse-engineer

AI-driven codebase documentation generator that reverse-engineers project structure through three-phase analysis: per-file `.sum` summaries (parallel), per-directory `AGENTS.md` overviews (post-order tree traversal), and root entry points (`CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`).

## Stack

**Runtime**: Node.js ≥18.0.0 (ES modules, `"type": "module"` in package.json)  
**Language**: TypeScript 5.7.3 (ES2022 target, NodeNext module resolution, strict mode)  
**Build**: `tsc` emits to `dist/`, declarations enabled, source maps for debugging  
**Binaries**: `are` and `agents-reverse-engineer` point to `dist/cli/index.js`  
**Scripts**:
- `npm run build` — Compile TypeScript via `tsc`
- `npm run build:hooks` — Copy hook files via `scripts/build-hooks.js`
- `npm run prepublishOnly` — Build + build:hooks pre-publish chain
- `npm run dev` — Hot-reload via `tsx watch src/cli/index.ts`

**Dependencies**: fast-glob (file discovery), ignore (gitignore parsing), isbinaryfile (binary detection), ora (spinner UI), picocolors (terminal colors), simple-git (change detection), yaml (config parsing), zod (schema validation)

## Commands

**CLI entry point**: `src/cli/index.ts`
- `are init` → `src/cli/init.ts` — Creates `.agents-reverse-engineer/config.yaml`
- `are discover` → `src/cli/discover.ts` — Scans files, generates `GENERATION-PLAN.md`
- `are generate` → `src/cli/generate.ts` — Executes three-phase documentation generation
- `are update` → `src/cli/update.ts` — Regenerates only modified files via git diff
- `are specify` → `src/cli/specify.ts` — Synthesizes all `AGENTS.md` into `specs/SPEC.md`
- `are clean` → `src/cli/clean.ts` — Removes all `.sum`, `AGENTS.md`, root docs

**Installed AI slash commands** (`/are-init`, `/are-discover`, etc.): `src/installer/index.ts` installs to `~/.claude/commands/` or `.claude/commands/`, session hooks to `~/.claude/hooks/` (Claude), `~/.config/opencode/plugins/` (OpenCode), `~/.config/gemini/hooks/` (Gemini)

## Architecture

### Three-Phase Generation Pipeline

1. **File Analysis** (`src/generation/executor.ts` → `runFileAnalysisPhase()`)  
   Parallel pool execution via `src/orchestration/pool.ts` creates `.sum` files for each source file using `src/generation/writers/sum.ts`. Concurrency controlled by `config.ai.concurrency` (default 2 in WSL, 5 elsewhere).

2. **Directory Documentation** (`runDirectoryPhase()`)  
   Post-order tree traversal via `src/discovery/walker.ts` generates `AGENTS.md` per directory using `src/generation/writers/agents-md.ts`. Deepest directories processed first, consuming child `.sum` and `AGENTS.md` files.

3. **Root Documentation** (`runRootPhase()`)  
   Sequential generation of `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` via `src/integration/generate.ts`, consuming root `AGENTS.md` and tree structure.

### AI Backend Abstraction

`src/ai/service.ts` (`AIService`) dispatches to backend-specific subprocess runners:
- `src/ai/backends/claude.ts` — `claude chat --quiet --no-stream`
- `src/ai/backends/gemini.ts` — `gemini chat --quiet --no-stream`
- `src/ai/backends/opencode.ts` — `opencode chat --quiet --no-stream`

Subprocess execution via `src/ai/subprocess.ts` (`runSubprocess()`) spawns child processes with `execFile()`, applies resource limits (`NODE_OPTIONS=--max-old-space-size=512`, `UV_THREADPOOL_SIZE=4`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS=1`), and kills process groups (`kill(-pid)`) on timeout.

Retry logic in `src/ai/retry.ts` (`withRetry()`) handles transient errors (rate limits, timeouts) with exponential backoff up to `config.ai.maxRetries` (default 3).

### Concurrency Control

`src/orchestration/pool.ts` implements iterator-based worker pool: N workers consume shared iterator, preventing task duplication. Trace events (`worker:start`, `task:pickup`, `task:done`, `worker:end`) logged via `src/orchestration/trace.ts` when `--trace` flag enabled.

Progress tracking via `src/orchestration/progress.ts` (`ProgressReporter`) writes human-readable updates to `.agents-reverse-engineer/progress.log` and NDJSON machine output to `.agents-reverse-engineer/logs/run-{timestamp}.jsonl`.

Plan tracking via `src/orchestration/plan-tracker.ts` (`PlanTracker`) maintains promise chain for serialized writes, preventing corruption from concurrent workers.

## File Discovery

`src/discovery/run.ts` orchestrates file discovery via `src/discovery/walker.ts` (`DirectoryWalker`), applying filter chain from `src/discovery/filters/`:
- `src/discovery/filters/gitignore.ts` — Parses `.gitignore` via `ignore` library
- `src/discovery/filters/vendor.ts` — Excludes `node_modules`, `dist`, `.git` (configurable via `config.exclude.vendorDirs`)
- `src/discovery/filters/binary.ts` — Skips binary files via `isbinaryfile`
- `src/discovery/filters/custom.ts` — Applies `config.exclude.patterns` globs

Tree structure built via post-order traversal, enabling directory docs to consume child summaries.

## Change Detection

`src/change-detection/detector.ts` (`ChangeDetector`) uses `simple-git` to compute diff between working tree and last commit. Identifies:
- Modified files → regenerate `.sum` + parent `AGENTS.md`
- Deleted files → remove `.sum` via `src/update/orphan-cleaner.ts` (`OrphanCleaner`)
- New files → add to discovery and regenerate

`src/update/orchestrator.ts` (`UpdateOrchestrator`) propagates changes up directory tree, regenerating all ancestor `AGENTS.md` files.

## Import Extraction

`src/imports/extractor.ts` (`ImportExtractor`) parses dependency manifests:
- `package.json` → npm/yarn/pnpm (JavaScript/TypeScript)
- `requirements.txt`, `pyproject.toml`, `setup.py`, `Pipfile` → pip/poetry/pipenv (Python)
- `go.mod` → go modules (Go)
- `Cargo.toml` → cargo (Rust)

Manifest-to-language mapping documented in `LANGUAGES-MANIFEST.md`. Extracted dependencies populate `dependencies` section in `.sum` files.

## Prompt Engineering

`src/generation/prompts/builder.ts` (`PromptBuilder`) constructs context-aware prompts:
- File analysis: `src/generation/prompts/templates.ts` (`ANALYZE_FILE_TEMPLATE`) + file content + import map
- Directory docs: `buildPromptForDirectory()` includes child `.sum`, `AGENTS.md`, project structure
- Root docs: `buildPromptForRoot()` consumes root `AGENTS.md` + integration context

User notes from `config.userNotes` prepended to prompts for domain-specific instructions.

## Quality Validation

`src/quality/` contains linting subsystem:
- `src/quality/density/validator.ts` — Checks AGENTS.md contains file-specific identifiers (function/class names)
- `src/quality/inconsistency/code-vs-code.ts` — Detects contradictions within `.sum` files
- `src/quality/inconsistency/code-vs-doc.ts` — Detects mismatches between `.sum` and source code
- `src/quality/phantom-paths/validator.ts` — Validates cross-references use actual paths from import map
- `src/quality/inconsistency/reporter.ts` — Aggregates quality issues into reports

Quality checks run post-generation, warnings logged to `progress.log`.

## Configuration

`src/config/loader.ts` loads `.agents-reverse-engineer/config.yaml`, validated against `src/config/schema.ts` (Zod schema), merges with `src/config/defaults.ts`. Schema defines:
- `exclude` (patterns, vendorDirs, binaryExtensions)
- `options` (followSymlinks, maxFileSize)
- `output` (colors, verbose)
- `ai` (backend, model, timeoutMs, maxRetries, concurrency, telemetry, pricing)

## Telemetry

`src/ai/telemetry/logger.ts` (`TelemetryLogger`) writes NDJSON run logs to `.agents-reverse-engineer/logs/`, capturing token counts, costs, durations. `src/ai/telemetry/cleanup.ts` (`cleanupOldRuns()`) enforces `config.ai.telemetry.keepRuns` retention limit (default 50). Cost warnings trigger when cumulative cost exceeds `config.ai.telemetry.costThresholdUsd` (default $10).

`src/orchestration/trace.ts` (`TraceWriter`) emits NDJSON trace events to `.agents-reverse-engineer/traces/` when `--trace` flag enabled. Events: `phase:start`, `phase:end`, `worker:start`, `worker:end`, `task:pickup`, `task:done`, `subprocess:spawn`, `subprocess:exit`, `retry`.

## Installation

`src/installer/index.ts` orchestrates interactive or non-interactive installs:
- Prompts for runtime (Claude Code, Gemini, OpenCode, all) via `src/installer/prompts.ts`
- Copies command files to `~/.claude/commands/` or `.claude/commands/` via `src/installer/operations.ts`
- Installs session hooks (`hooks/are-session-end.js`, `hooks/opencode-are-session-end.js`) to IDE-specific hook directories
- Writes `ARE-VERSION` file for update checks

`src/installer/uninstall.ts` removes command files, hooks, permissions, `.agents-reverse-engineer/` folder.

## Project Specification

`src/specify/index.ts` (`SpecGenerator`) synthesizes all `AGENTS.md` into `specs/SPEC.md`:
- Single-file mode: Aggregates all directory overviews into monolithic spec
- Multi-file mode (`--multi-file`): Creates `specs/SPEC.md` + per-directory specs in `specs/<dirname>.md`
- Dry-run mode (`--dry-run`): Outputs to stdout without writing files

Prompts defined in `src/specify/prompts.ts`, writing via `src/specify/writer.ts`.

## Subdirectories

**[docs/](./docs/)** — Original vision document (`INPUT.md`) defining the RLM algorithm and brownfield documentation strategy. Predates implementation.

**[hooks/](./hooks/)** — Session lifecycle hooks (`are-session-end.js`, `are-check-update.js`, OpenCode equivalents) for automatic version checks and documentation updates via detached background processes.

**[scripts/](./scripts/)** — Build automation (`build-hooks.js`) for copying hook files to `hooks/dist/` during npm publish lifecycle.

**[src/](./src/)** — TypeScript source tree with CLI, AI backend abstraction, file discovery, prompt engineering, quality validation, and three-phase generation pipeline.

**[.github/workflows/](./github/workflows/)** — CI/CD workflows for automated testing and npm publishing.