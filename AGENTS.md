<!-- Generated by agents-reverse-engineer -->

# agents-reverse-engineer

**agents-reverse-engineer (ARE)** is a CLI tool that generates AI-friendly codebase documentation through three-phase AI analysis: per-file `.sum` summaries with YAML frontmatter, per-directory `AGENTS.md` navigational indexes synthesized via post-order traversal, and root `CLAUDE.md`/`GEMINI.md`/`OPENCODE.md` entry points. Enables incremental updates via git-based or hash-based change detection, specification synthesis via `SPEC.md` generation, and project reconstruction from specifications with checkpoint resumption.

## Stack

**Runtime**: Node.js ≥18.0.0 ESM (type: "module")  
**Build**: TypeScript 5.7.3 → ES2022, NodeNext module resolution, output to `dist/`  
**CLI**: Dual binaries `agents-reverse-engineer` and `are` both mapping to `dist/cli/index.js`  
**Tests**: Vitest (implicit via `npm test`)  
**Package Manager**: npm (package.json scripts for build/dev/prepublish)

**Core Dependencies**:
- **fast-glob** 3.3.3 — glob pattern matching for file discovery
- **ignore** 7.0.3 — `.gitignore` parsing for exclusion filters
- **isbinaryfile** 5.0.4 — binary file detection to skip non-text files
- **simple-git** 3.27.0 — git diff/status for change detection
- **yaml** 2.7.0 — config parsing and frontmatter serialization
- **zod** 3.24.1 — schema validation for `config.yaml`
- **ora** 8.1.1 — terminal spinner UI for progress feedback
- **picocolors** 1.1.1 — ANSI color formatting for CLI output

**Build Scripts**:
- `npm run build` — tsc compilation to dist/
- `npm run build:hooks` — copies hooks/ to hooks/dist/ for npm package
- `npm run dev` — tsx watch mode for live reload
- `npm run prepack` — removes .sum files before packaging
- `npm run prepublishOnly` — runs build + build:hooks before publish

**Entry Points**:
- **CLI commands**: init, discover, generate, update, clean, specify, rebuild (see src/cli/)
- **npx installer**: `npx agents-reverse-engineer@latest` interactive or `--runtime <claude|opencode|gemini|all> -g/-l` non-interactive
- **AI assistant commands**: `/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean` (installed to `.claude/skills/`, `.opencode/commands/`, `.gemini/commands/`)

## Contents

### Documentation

**[README.md](./README.md)** — User-facing documentation covering installation (interactive `npx` installer with runtime selection), command reference (CLI + AI assistant commands), three-phase workflow (init → discover → generate → update → specify), configuration schema (`.agents-reverse-engineer/config.yaml` structure with exclude/options/output/ai sections), generated artifact formats (`.sum` YAML frontmatter, `AGENTS.md` directory overviews, runtime-specific root docs), system requirements (Node.js 18+, Claude/Gemini/OpenCode integrations).

**[CONTRIBUTING.md](./CONTRIBUTING.md)** — Developer onboarding with git clone instructions, `npm install`/`npm run dev`/`npm run build`/`npm test` commands, source organization map (six module directories: cli, config, discovery, generation, orchestration, ai), contribution workflow (fork → branch → test → PR), issue reporting guidelines (bug templates require reproduction steps, feature requests require use case), license agreement (MIT).

**[LANGUAGES-MANIFEST.md](./LANGUAGES-MANIFEST.md)** — Package manifest catalog across 25+ languages. Supported: JavaScript/TypeScript (package.json), Python (requirements.txt, pyproject.toml, setup.py, Pipfile), Go (go.mod), Rust (Cargo.toml). Unsupported: Ruby (Gemfile), Java/Kotlin (pom.xml, build.gradle), C#/.NET (*.csproj), PHP (composer.json), 15+ additional ecosystems. Referenced by `src/discovery/filters/vendor.ts` for vendor directory detection and `src/imports/extractor.ts` for language-specific manifest parsing.

**[LICENSE](./LICENSE)** — MIT License terms granting unrestricted use, copy, modify, merge, publish, distribute, sublicense, sell rights. Copyright 2026 GeoloeG-IsT. Applies to source files, binaries, and all generated artifacts (`.sum`, `AGENTS.md`, runtime docs).

### Configuration

**[package.json](./package.json)** — npm manifest defining `agents-reverse-engineer` v0.7.3 with dual binaries `agents-reverse-engineer` and `are` pointing to `dist/cli/index.js`. Engines require Node ≥18.0.0. Type field set to `"module"` for ESM. Exports seven runtime dependencies (fast-glob, ignore, isbinaryfile, ora, picocolors, simple-git, yaml, zod) and three devDependencies (@types/node, tsx, typescript). Build scripts: `build` (tsc), `build:hooks` (copies hooks/ to hooks/dist/), `prepack` (removes .sum files), `prepublishOnly` (build + build:hooks). Files array specifies package contents: `dist/`, `hooks/dist/`, `README.md`, `LICENSE`.

**[tsconfig.json](./tsconfig.json)** — TypeScript compiler config targeting ES2022 with NodeNext module resolution for Node.js ESM output. Sets `outDir: "dist"`, `rootDir: "src"`, enables `declaration`/`declarationMap`/`sourceMap` for type definitions and debugging. Enforces strict type-checking with `strict: true`, `forceConsistentCasingInFileNames`, `isolatedModules` (ESM requirement), `skipLibCheck`. Enables `esModuleInterop` for CommonJS/ESM interop and `resolveJsonModule` for typed JSON imports. Includes `src/**/*`, excludes `node_modules` and `dist`.

### Subdirectories

**[docs/](./docs/)** — Founding requirements document `INPUT.md` specifying RLM (Recursive Language Model) algorithm, `{filename}.sum` → AGENTS.md synthesis pipeline, `/are-generate` and `/are-update` command semantics, companion tool references (SpecKit, BMAD, GSD). Defines leaf-first traversal, post-order directory synthesis, session-end hook triggers.

**[.vscode/](./vscode/)** — VSCode workspace configuration. `settings.json` excludes `**/*.sum` from file explorer via `files.exclude` to hide AI-generated summaries, applies green title bar theme (`#19ad25` active, `#287417` inactive) via `workbench.colorCustomizations`.

**[hooks/](./hooks/)** — Node.js hook scripts for Claude CLI and OpenCode enabling automatic version checks and incremental updates. `are-check-update.js` spawns detached background process querying npm registry, writing cache to `~/.claude/cache/are-update-check.json`. `are-session-end.js` triggers `npx agents-reverse-engineer@latest update --quiet` when session ends with uncommitted changes (git dirty tree). OpenCode equivalents `opencode-are-check-update.js` and `opencode-are-session-end.js` export plugin objects with `event: { 'session.created': handler }` and `event: { 'session.deleted': handler }` structures. All hooks use `spawn()` with `detached: true`, `stdio: 'ignore'`, `windowsHide: true`, `child.unref()` for background execution.

**[scripts/](./scripts/)** — Build automation. `build-hooks.js` copies `.js` files from `hooks/` to `hooks/dist/` during `npm run build:hooks` and `prepublishOnly`, filtering out `dist` directory, using `mkdirSync({recursive:true})` + `copyFileSync()` + console logging.

**[src/](./src/)** — Root source directory implementing eight command handlers (init, discover, generate, update, clean, specify, rebuild, install/uninstall), three-phase AI pipeline (file analysis → directory synthesis → root docs) with iterator-based concurrency pool, multi-backend AI service abstraction (Claude/Gemini/OpenCode), git/hash-based change detection, import extraction, quality validation (code-vs-doc, code-vs-code, phantom paths), NDJSON tracing, telemetry logging, checkpoint-based project reconstruction. Contains 13 subdirectories: ai, change-detection, cli, config, discovery, generation, imports, installer, integration, orchestration, output, quality, rebuild, specify, types, update. Entry point `src/cli/index.ts` routes to command modules. Version retrieval `src/version.ts` reads `../package.json`.

**[.github/workflows/](./github/workflows/)** — CI/CD automation. `publish.yml` defines npm publish workflow triggered on GitHub release creation, runs Node.js 20.x tests, authenticates to npm registry via `NODE_AUTH_TOKEN`, executes `npm publish` with `--provenance` flag for supply chain attestation.

## Architecture

### Three-Phase AI Pipeline

**Phase 1 (File Analysis)**: Concurrent `.sum` generation via `runPool()` sharing iterator across worker tasks. Each worker executes `buildFilePrompt()` (embeds source content, language, import map) → `AIService.call()` → `writeSumFile()` with YAML frontmatter (`generated_at`, `content_hash`, `purpose`, `critical_todos`, `related_files`). Concurrency controlled by config or CPU/memory-based formula: `clamp(cores * 5, 2, min(floor(totalMemGB * 0.5 / 0.512), 20))` allocating 50% system memory with 512MB per subprocess.

**Phase 2 (Directory Synthesis)**: Post-order `AGENTS.md` generation grouped by directory depth descending (deepest-first). Each directory task executes `buildDirectoryPrompt()` (reads child `.sum` files + subdirectory AGENTS.md, extracts import map) → `AIService.call()` → `writeAgentsMd()` with `GENERATED_MARKER`. Preserves user-authored content as `AGENTS.local.md`.

**Phase 3 (Root Documentation)**: Sequential root doc generation (concurrency=1). Root tasks execute `buildRootPrompt()` (aggregates all AGENTS.md + package.json metadata) → `AIService.call()` → writes `CLAUDE.md`/`OPENCODE.md`/`GEMINI.md`.

### Iterator-Based Concurrency Pool

`orchestration/pool.ts` implements shared iterator pattern: `runPool()` spawns `Math.min(concurrency, tasks.length)` workers pulling `[index, task]` pairs from single `tasks.entries()` iterator. Each worker executes task factory → `onComplete?.(result)` → checks `aborted` flag when `failFast` enabled. Phases labeled for tracing (`'phase-1-files'`, `'phase-2-directories'`, `'phase-3-root'`, `'pre-phase-1-cache'`, `'post-phase-1-quality'`, `'post-phase-2-phantom'`).

### AI Backend Abstraction

`AIBackend` interface defines four methods: `isAvailable()` checks CLI presence via `isCommandOnPath()`, `buildArgs()` constructs subprocess argv, `parseResponse()` normalizes stdout to `AIResponse`, `getInstallInstructions()` returns setup guide. `BackendRegistry` pre-populated with ClaudeBackend, GeminiBackend, OpenCodeBackend in detection priority order. `resolveBackend()` handles `'auto'` detection or explicit backend selection, throws `AIServiceError('CLI_NOT_FOUND')` with install instructions on unavailable CLI. `AIService.call()` wraps `runSubprocess()` with `withRetry()` (exponential backoff, 3 max retries, rate-limit detection), enforces timeout via SIGTERM → SIGKILL escalation, attempts process group kill `kill(-pid)`, records telemetry to `.agents-reverse-engineer/logs/run-${timestamp}.json`, emits NDJSON trace events.

### Change Detection Strategies

**Git-based**: `getChangedFiles()` parses `git diff --name-status -M baseCommit..HEAD` with 50% rename similarity threshold, optionally appends uncommitted changes from `git.status()` (modified, deleted, not_added, staged arrays), maps status codes (`A` → added, `M` → modified, `D` → deleted, `R<percentage>` → renamed).

**Hash-based**: `UpdateOrchestrator.preparePlan()` reads `.sum` frontmatter via `readSumFile()`, compares stored `contentHash` against `computeContentHash()` (SHA-256 hex digest from disk), classifies files as added (no .sum), modified (hash mismatch), or unchanged (hash match), calls `cleanupOrphans()` for deleted files, sorts affected directories deepest-first for post-order regeneration. Abandoned git-only approach to support non-git repositories.

### Quality Validation Pipeline

Runs during `executeGenerate()` and `executeUpdate()`:

1. **Pre-Phase 1 (cache)**: Reads existing `.sum` files concurrently (concurrency=20) into `oldSumCache` for stale documentation detection
2. **Post-Phase 1 (quality)**: Groups processed files by directory, runs `checkCodeVsDoc()` (old-doc stale + new-doc omission) and `checkCodeVsCode()` (duplicate exports) per directory with concurrency=10, builds `InconsistencyReport`
3. **Post-Phase 2 (phantom paths)**: Reads all generated `AGENTS.md`, runs `checkPhantomPaths()` detecting references to non-existent files via three regex patterns (markdown links, backtick paths, prose references), filters false positives

## Behavioral Contracts

### CLI Commands

| Command | Entry Point | Purpose |
|---------|-------------|---------|
| `are install` | `src/installer/index.ts` | Interactive/non-interactive installer with runtime selection |
| `are init` | `src/cli/init.ts` | Bootstraps `.agents-reverse-engineer/config.yaml` |
| `are discover` | `src/cli/discover.ts` | Walks file tree, creates `GENERATION-PLAN.md` |
| `are generate` | `src/cli/generate.ts` | Executes three-phase AI pipeline |
| `are update` | `src/cli/update.ts` | Incremental regeneration via hash comparison |
| `are clean` | `src/cli/clean.ts` | Deletes ARE-generated artifacts via marker filtering |
| `are specify` | `src/cli/specify.ts` | Synthesizes `specs/SPEC.md` from AGENTS.md |
| `are rebuild` | `src/cli/rebuild.ts` | Reconstructs project from specification |

### CLI Exit Codes

- **0**: Success (all tasks completed without failures)
- **1**: Partial failure (some files/modules failed, at least one succeeded)
- **2**: Total failure (no files processed AND failures occurred) OR CLI backend not found

### Subprocess Timeout Handling

SIGTERM sent at `timeoutMs`, SIGKILL escalation after `timeoutMs + SIGKILL_GRACE_MS` (5000ms). Process group kill `kill(-pid)` attempts to terminate subprocess tree, falls back to single process `kill(pid)`.

### Import Detection Regex

`/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm` captures TypeScript/JavaScript export identifiers in group 1.

### Phantom Path Extraction Patterns

- Markdown links: `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`
- Backtick paths: `` /`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g ``
- Prose references: `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`

### Retry Configuration

`DEFAULT_RETRY_OPTIONS`: `maxRetries: 3`, `baseDelayMs: 1000`, `maxDelayMs: 8000`, `multiplier: 2`. Exponential backoff formula: `min(baseDelayMs * multiplier^attempt, maxDelayMs) + jitter` where jitter is `Math.random() * 500`. Rate-limit errors retry up to `maxRetries` when stderr matches `['rate limit', '429', 'too many requests', 'overloaded']` case-insensitively. Timeout errors do not retry.

### Trace Event Schema

NDJSON events written to `.agents-reverse-engineer/traces/trace-${timestamp}.ndjson` with auto-populated fields: `seq` (monotonic), `ts` (ISO 8601), `pid` (process.pid), `elapsedMs` (fractional ms since run start). Event types: `phase:start`/`phase:end`, `worker:start`/`worker:end`, `task:pickup`/`task:done`, `subprocess:spawn`/`subprocess:exit`, `retry`, `discovery:start`/`discovery:end`, `filter:applied`, `plan:created`, `config:loaded`.

### Configuration Constants

- `CONFIG_DIR = ".agents-reverse-engineer"` — configuration directory name
- `CONFIG_FILE = "config.yaml"` — configuration filename
- `CONCURRENCY_MULTIPLIER = 5` — CPU core scaling factor
- `MIN_CONCURRENCY = 2` — floor for computed concurrency
- `MAX_CONCURRENCY = 20` — ceiling for computed concurrency
- `SUBPROCESS_HEAP_GB = 0.512` — memory budget per subprocess
- `MEMORY_FRACTION = 0.5` — allocates 50% of system memory to pool
- `DEFAULT_MAX_FILE_SIZE = 1048576` — 1MB file size threshold
- `SIGKILL_GRACE_MS = 5000` — delay between SIGTERM and SIGKILL
- `BUILT_CONTEXT_LIMIT = 100000` — max chars for rebuild accumulated context
- `TRUNCATED_HEAD_LINES = 20` — lines retained when truncating context

## File Relationships

**Installation Flow**: `src/installer/index.ts` parses CLI flags → dispatches to `runInstaller()` or `uninstallFiles()` → copies command templates from `src/integration/templates.ts` → registers hooks/plugins in `settings.json` → adds bash permission patterns to `settings.permissions.allow` → writes VERSION marker.

**Discovery Flow**: `src/cli/discover.ts` calls `loadConfig()` → `discoverFiles()` → `walkDirectory()` → `applyFilters()` (gitignore, vendor, binary, custom) → returns `FilterResult` → writes `GENERATION-PLAN.md`.

**Generation Flow**: `src/cli/generate.ts` calls `createOrchestrator().createPlan()` → `buildExecutionPlan()` → `CommandRunner.executeGenerate()` → three-phase sequence: (1) `runPool()` file analysis with `buildFilePrompt()` → `aiService.call()` → `writeSumFile()`, (2) post-order directory synthesis with `buildDirectoryPrompt()` → `aiService.call()` → `writeAgentsMd()`, (3) sequential root doc generation with `buildRootPrompt()` → `aiService.call()` → writes CLAUDE.md/OPENCODE.md/GEMINI.md → quality checks via `checkCodeVsDoc()`/`checkCodeVsCode()`/`checkPhantomPaths()` → `buildInconsistencyReport()` → `formatReportForCli()`.

**Update Flow**: `src/cli/update.ts` calls `createUpdateOrchestrator().preparePlan()` → `readSumFile()` + `computeContentHash()` → classifies added/modified/unchanged → `cleanupOrphans()` → `getAffectedDirectories()` → `CommandRunner.executeUpdate()` → parallel file analysis → sequential directory regeneration.

**Specify Flow**: `src/cli/specify.ts` calls `collectAgentsDocs()` + `collectAnnexFiles()` → `buildSpecPrompt()` → `aiService.call()` → `writeSpec()` with single-file or multi-file mode via `splitByHeadings()`.

**Rebuild Flow**: `src/cli/rebuild.ts` calls `readSpecFiles()` → `partitionSpec()` → `CheckpointManager.load()` → `executeRebuild()` groups by order → `runPool()` calls `buildRebuildPrompt()` → `aiService.call()` → `parseModuleOutput()` → `writeFile()` → `checkpoint.markDone()`.

**AI Service Flow**: `AIService.call()` resolves backend via `resolveBackend()` → constructs argv via `backend.buildArgs()` → `withRetry()` wraps `runSubprocess()` → `execFile()` spawns child process → enforces timeout with SIGTERM/SIGKILL → `backend.parseResponse()` normalizes stdout → `TelemetryLogger.addEntry()` records metrics → `tracer.emit()` writes NDJSON events.