<!-- Generated by agents-reverse-engineer -->

# agents-reverse-engineer

**CLI tool implementing Recursive Language Model (RLM) algorithm for AI-driven codebase documentation via three-phase pipeline: concurrent `.sum` file generation with subprocess pools, post-order `AGENTS.md` directory aggregation, and platform-specific root synthesis (`CLAUDE.md`/`GEMINI.md`/`OPENCODE.md`) with gitignore-aware discovery, SHA-256 incremental updates, and NDJSON telemetry.**

## Contents

### Root Documentation

**[LANGUAGES-MANIFEST.md](./LANGUAGES-MANIFEST.md)** — Enumerates 25 language ecosystem manifest types (package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile, plus 16 unsupported: Gemfile, *.csproj, Package.swift, mix.exs, rebar.config, build.sbt, deps.edn, *.cabal, pubspec.yaml, *.rockspec, DESCRIPTION, Project.toml, build.zig.zon, *.nimble, dune-project) with support checkmarks indicating `extractDirectoryImports()` detection coverage. Serves as specification for manifest-aware prompt construction in Phase 2 directory aggregation.

**[LICENSE](./LICENSE)** — MIT license grant for agents-reverse-engineer (copyright 2026 GeoloeG-IsT) granting unrestricted usage/modification/distribution rights with warranty disclaimer and liability waiver.

**[README.md](./README.md)** — User-facing documentation covering `npx agents-reverse-engineer@latest` installation workflows (runtime selection: claude/opencode/gemini/all, scope: global `-g`/local `-l`), command reference (init/discover/generate/update/specify/clean), generated artifact formats (`.sum` with YAML frontmatter, `AGENTS.md` directories, runtime-specific roots), configuration schema (`.agents-reverse-engineer/config.yaml` with exclude patterns/vendorDirs/binaryExtensions/ai backend/concurrency/timeout/pricing), three-phase workflow (file analysis → directory aggregation → root synthesis), incremental update strategy (SHA-256 hash comparison, orphan cleanup, affected directory propagation), IDE integration hooks (session-end auto-update, version checking), requirements (Node.js ≥18.0.0, Claude Code/Gemini CLI/OpenCode support).

**[package.json](./package.json)** — Package metadata: name `agents-reverse-engineer`, version `0.6.6`, license MIT. Binary entry points: `agents-reverse-engineer`/`are` → `dist/cli/index.js`. Build scripts: `build` (tsc), `build:hooks` (copies hooks/ → hooks/dist/), `prepublishOnly` (build + build:hooks), `prepack` (remove .sum artifacts), `dev` (tsx watch). Dependencies: fast-glob, ignore, isbinaryfile, ora, picocolors, simple-git, yaml, zod. DevDependencies: @types/node, tsx, typescript. Files array: dist, hooks/dist, README.md, LICENSE. Engine: Node.js ≥18.0.0.

**[tsconfig.json](./tsconfig.json)** — TypeScript compiler configuration: target ES2022, module/moduleResolution NodeNext (native ES modules), outDir dist, rootDir src, strict type-checking enabled, declaration/declarationMap/sourceMap generation, esModuleInterop/resolveJsonModule enabled, isolatedModules enforced, include src/**, exclude node_modules/dist. Invoked by `npm run build` (tsc) and `prepublishOnly` hook.

## Subdirectories

**[.github/workflows/](./github/workflows/)** — CI/CD GitHub Actions workflow for npm package publishing with Sigstore-signed provenance attestation on `release[published]` events. Executes `ubuntu-latest` job with `id-token: write` permission enabling cryptographic attestation linking published artifact to source commit SHA. Runs `actions/checkout@v4`, `actions/setup-node@v4` with registry-url `https://registry.npmjs.org`, executes `npm ci`, `npm run build` (tsc + build:hooks), publishes via `npm publish --provenance --access public` using `NPM_TOKEN` secret.

**[docs/](./docs/)** — Original vision document `INPUT.md` defining RLM algorithm (post-order traversal, leaf-to-root aggregation), command contracts (`/are-generate`, `/are-update`), session lifecycle hooks (SessionStart version check, SessionEnd auto-update), multi-tier documentation system (AGENTS.md, ARCHITECTURE.md, STRUCTURE.md, STACK.md, INTEGRATIONS.md, INFRASTRUCTURE.md, CONVENTIONS.md, TESTING.md, PATTERNS.md, CONCERNS.md), and references to inspirational projects: SpecKit (GitHub spec toolkit), BMAD (methodology framework), GSD (workflow system).

**[hooks/](./hooks/)** — IDE session lifecycle hooks implemented as detached background processes for Claude Code/Gemini CLI/OpenCode: `are-check-update.js` (SessionStart npm registry query via `npm view agents-reverse-engineer version`, cache to `~/.claude/cache/are-update-check.json` with 10s timeout), `are-session-end.js` (SessionEnd git change detection via `git status --porcelain`, spawns `npx agents-reverse-engineer@latest update --quiet` when uncommitted changes exist), `opencode-are-check-update.js`/`opencode-are-session-end.js` (plugin wrappers exporting async factories returning OpenCode plugin objects with `event['session.created']`/`event['session.deleted']` handlers). Spawned via `spawn(process.execPath, ['-e', scriptString], { stdio: 'ignore', detached: true, windowsHide: true }).unref()` to prevent blocking IDE exit. Honors disable flags: `ARE_DISABLE_HOOK=1` environment variable or `hook_enabled: false` in `.agents-reverse-engineer.yaml`.

**[scripts/](./scripts/)** — Build automation script `build-hooks.js` copying hook source files from `hooks/` → `hooks/dist/` during `prepublishOnly` lifecycle via `readdirSync()` filtering `.js` files + `copyFileSync()` per file. Ensures session lifecycle hooks exist in npm tarball for `src/installer/operations.ts` reference during global/local hook installation.

**[src/](./src/)** — Core implementation housing seven CLI commands (init, discover, generate, update, clean, specify, help), three-phase pipeline orchestration (concurrent file analysis with iterator-based worker pools, post-order directory synthesis with dependency graphs, sequential root integration with preamble stripping), AI backend abstraction layer with Claude/Gemini/OpenCode adapters + subprocess resource management (512MB heap limits, 4-thread libuv pools, process group killing), gitignore-aware file discovery with composable filter chains (gitignore → vendor → binary → custom), SHA-256 incremental change detection with orphan cleanup, quality validation (code-vs-doc/code-vs-code inconsistencies via regex export extraction, phantom path detection via three regex patterns + `existsSync()` validation), worker pool concurrency control with shared iterator preventing over-allocation, NDJSON trace emission (phase/worker/task/subprocess/retry events with auto-populated seq/ts/pid/elapsedMs fields), platform-specific IDE integration (Claude Code skills/hooks, OpenCode commands/plugins, Gemini commands/hooks with TOML format).

## Architecture

### Three-Phase Pipeline Execution

**Phase 1 (Concurrent File Analysis):** Iterator-based worker pool (`src/orchestration/pool.ts`) shares `tasks.entries()` iterator across N workers (default 2 WSL, 5 elsewhere) to prevent over-allocation. Each worker invokes `AIService.call()` → `runSubprocess()` → `execFile()` spawning AI CLI subprocesses with resource limits (`NODE_OPTIONS='--max-old-space-size=512'` limits heap to 512MB, `UV_THREADPOOL_SIZE='4'` constrains libuv thread pool, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` prevents background tasks, `--disallowedTools Task` blocks subagents). Process group killing (`kill(-pid)`) terminates subprocess trees on timeout (SIGTERM at `timeoutMs`, SIGKILL escalation after 5s grace period). Exponential backoff retry on rate limits (stderr patterns: "rate limit", "429", "too many requests", "overloaded"). Writes `.sum` files with YAML frontmatter containing `generated_at` timestamp, `content_hash` (SHA-256), followed by markdown sections (Purpose, Public Interface, Dependencies, Implementation Notes). Detects `## Annex References` marker for `writeAnnexFile()` reproduction-critical source content.

**Phase 2 (Post-Order Directory Aggregation):** Sorts directories by depth descending via `path.relative().split(path.sep).length` (deepest first). Waits for all child `.sum` files to exist via `isDirectoryComplete()` predicate before processing directory. Prompts include aggregated child `.sum` content via `readSumFile()`, subdirectory `AGENTS.md` files via recursive traversal, import maps via `extractDirectoryImports()` with verified path constraints, manifest detection (9 types: package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile). User-authored `AGENTS.md` files renamed to `AGENTS.local.md` and prepended above generated content with `---` separator. Writes `AGENTS.md` with `<!-- Generated by agents-reverse-engineer -->` marker.

**Phase 3 (Root Document Synthesis):** Sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`. Prompts consume all `AGENTS.md` files via `collectAgentsDocs()` recursive tree traversal (skips 13 directories: node_modules, .git, .agents-reverse-engineer, vendor, dist, build, __pycache__, .next, venv, .venv, target, .cargo, .gradle), parse root `package.json` for project metadata, enforce synthesis-only constraints (no invention of features/hooks/patterns not in source documents). Strips conversational preamble via pattern matching (prefixes: "now i", "perfect", "based on", "let me", "here is", "i'll", "i will", "great", "okay", "sure", "certainly", "alright"; separator: `\n---\n` within first 500 chars; bold headers: `/^[\s\S]{0,500}?(\*\*[A-Z])/` without `##` markers) before writing output.

### Incremental Update Strategy

Workflow orchestrated by `src/update/orchestrator.ts`:
1. Read `content_hash` from each `.sum` file's YAML frontmatter via `readSumFile()`
2. Compute current file content hash via `computeContentHash()` (SHA-256)
3. Hash mismatch → add to `filesToAnalyze` as `FileChange` with `status: 'modified'` or `'added'`
4. Hash match → add to `filesToSkip`
5. Detect orphans: `.sum` files for deleted source files or renamed oldPaths
6. Call `cleanupOrphans()` to delete stale `.sum` files
7. Call `cleanupEmptyDirectoryDocs()` to remove `AGENTS.md` from directories with no remaining sources (excludes `GENERATED_FILES` set: CLAUDE.md, AGENTS.md, ARCHITECTURE.md, etc.)
8. Compute `affectedDirs` via `getAffectedDirectories()` by walking parent directories of changed files via `path.dirname()` until `.` or absolute path
9. Regenerate `.sum` for `filesToAnalyze` via Phase 1 pool execution
10. Regenerate `AGENTS.md` for `affectedDirs` sequentially (no Phase 2 post-order traversal required)

Git integration: supports committed changes (`git diff <baseCommit>..HEAD`) and uncommitted (`git status --porcelain` merge via `--uncommitted` flag), rename detection via `git diff -M` (50% similarity threshold), fallback to SHA-256 hashing for non-git workflows.

### Subprocess Resource Management

Mitigates Claude CLI thread exhaustion (GitHub #5771: 200 Node.js instances reported):
- `NODE_OPTIONS='--max-old-space-size=512'` limits heap to 512MB per subprocess
- `UV_THREADPOOL_SIZE='4'` constrains libuv thread pool to 4 threads
- `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` prevents background task spawning
- `--disallowedTools Task` prevents subprocess from spawning subagents
- Process group killing: `kill(-pid)` terminates entire subprocess tree
- Default concurrency reduced from 5 → 2 for resource-constrained environments (WSL detection in `src/config/defaults.ts` via `clamp(cores × 5, MIN=2, min(floor((totalMemGB × 0.5) / 0.512), MAX=20))`)

Timeout enforcement: SIGTERM sent at `timeoutMs`, SIGKILL escalation after 5s grace period, unref'd timeout handle allows Node.js exit without cleanup blocking.

### Telemetry & Tracing

**Run logs:** `.agents-reverse-engineer/logs/run-<timestamp>.json` aggregate per-call token counts (input/output/cacheRead/cacheCreation), costs (computed via per-model pricing from config), durations, errors. Tracks `filesRead[]` metadata with `path`, `sizeBytes`, `linesRead`. Computes summary: `totalInputTokens`, `totalCacheReadTokens`, `errorCount`, `uniqueFilesRead`. Enforces retention via `cleanupOldLogs(keepCount)` after each run (default 50 runs).

**Trace events:** `.agents-reverse-engineer/traces/trace-<timestamp>.ndjson` enabled via `--trace` flag. Events: `phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`. Auto-populated fields: `seq` (monotonic), `ts` (ISO 8601), `pid`, `elapsedMs` (high-resolution delta). Promise-chain serialization ensures NDJSON line order matches emission order despite concurrent workers. Retention: keeps 500 most recent traces via `cleanupOldTraces(keepCount)`.

**Progress log:** `.agents-reverse-engineer/progress.log` human-readable streaming output mirroring console. ETA calculation via moving average of last 10 task durations. Quality metrics: code-vs-doc/code-vs-code inconsistencies, phantom path counts. Real-time monitoring: `tail -f .agents-reverse-engineer/progress.log`.

## File Relationships

**CLI orchestration chain:**
1. `src/cli/index.ts` parses args → routes to `src/cli/{command}.ts` (init/discover/generate/update/clean/specify)
2. Commands call `src/config/loader.ts` → `loadConfig()` with Zod validation against `src/config/schema.ts`
3. Commands call `src/discovery/run.ts` → `discoverFiles()` with four-stage filter chain (gitignore → vendor → binary → custom)
4. `src/cli/generate.ts` calls `src/generation/orchestrator.ts` → `createOrchestrator().createPlan()`, then `src/orchestration/runner.ts` → `CommandRunner.executeGenerate()`
5. Runner calls `src/ai/service.ts` → `AIService.call()` → `src/ai/subprocess.ts` → `runSubprocess()` → Node.js `execFile()`
6. Runner calls `src/generation/writers/sum.ts` → `writeSumFile()` with YAML frontmatter, `src/generation/writers/agents-md.ts` → `writeAgentsMd()` preserving user content
7. Post-generation calls `src/quality/index.ts` → `checkCodeVsDoc()`, `checkCodeVsCode()`, `checkPhantomPaths()` → `buildInconsistencyReport()`

**Trace emission flow:**
1. CLI creates `TraceWriter` via `src/orchestration/trace.ts` → `createTraceWriter()`
2. Threads `tracer` through `CommandRunOptions` → `PoolOptions` → `AIServiceOptions`
3. Runner emits `phase:start/end`, pool emits `worker:start/end` + `task:pickup/done`, AIService emits `subprocess:spawn/exit` + `retry`
4. TraceWriter serializes via promise-chain writes, finalized via `tracer.finalize()` after all phases

**Update workflow chain:**
1. `src/cli/update.ts` calls `src/update/orchestrator.ts` → `preparePlan()` reading `.sum` frontmatter
2. Orchestrator calls `src/change-detection/detector.ts` → `computeContentHash()` for SHA-256 comparison
3. Orchestrator calls `src/update/orphan-cleaner.ts` → `cleanupOrphans()`, `cleanupEmptyDirectoryDocs()`
4. CLI calls `src/orchestration/runner.ts` → `CommandRunner.executeUpdate()` for file regeneration
5. CLI loops `affectedDirs` calling `src/generation/prompts/builder.ts` → `buildDirectoryPrompt()`, `src/generation/writers/agents-md.ts` → `writeAgentsMd()`

**Installer workflow chain:**
1. `src/installer/index.ts` → `parseInstallerArgs()` → `runInstall()` or `runUninstall()`
2. Operations call `src/installer/paths.ts` → `getRuntimePaths()` with environment overrides (`CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`)
3. Operations call `src/integration/templates.ts` → `getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()`
4. Operations read bundled hooks from `hooks/dist/` via `getBundledHookPath()`
5. Operations modify `settings.json` via JSON parse/stringify for hook/permission registration
6. Uninstallation calls `src/installer/uninstall.ts` → `cleanupOrphans()`, `cleanupEmptyDirs()`, `cleanupLegacyGeminiFiles()`

## Behavioral Contracts

**Default vendor directories** (`src/config/defaults.ts`):
```typescript
['node_modules', '.git', 'dist', 'build', 'target', '.next', '__pycache__', 'venv', '.venv', '.cargo', '.gradle', '.agents-reverse-engineer', '.agents', '.planning', '.claude', '.opencode', '.gemini']
```

**Default concurrency formula** (`src/config/defaults.ts`):
```typescript
clamp(cores × 5, MIN=2, min(floor((totalMemGB × 0.5) / 0.512), MAX=20))
```

**Export extraction regex** (`src/quality/inconsistency/code-vs-doc.ts`):
```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```

**Phantom path detection patterns** (`src/quality/phantom-paths/validator.ts`):
- Markdown links: `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`
- Backtick paths: `` /`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g ``
- Prose-embedded: `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`

**Rate limit detection patterns** (`src/ai/service.ts`):
```typescript
['rate limit', '429', 'too many requests', 'overloaded']
```

**Preamble stripping patterns** (`src/orchestration/runner.ts`):
- Prefixes (case-insensitive): `['now i', 'perfect', 'based on', 'let me', 'here is', "i'll", 'i will', 'great', 'okay', 'sure', 'certainly', 'alright']`
- Separator detection: `\n---\n` within first 500 chars
- Bold header detection: `/^[\s\S]{0,500}?(\*\*[A-Z])/` without `##` markers, strip if <300 chars

**YAML manifest types** (`src/generation/prompts/builder.ts`):
```typescript
['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']
```

**Trace event types** (`src/orchestration/types.ts`):
```typescript
'phase:start' | 'phase:end' | 'worker:start' | 'worker:end' | 'task:pickup' | 'task:done' | 'task:start' | 'subprocess:spawn' | 'subprocess:exit' | 'retry' | 'discovery:start' | 'discovery:end' | 'filter:applied' | 'plan:created' | 'config:loaded'
```