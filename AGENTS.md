<!-- Generated by agents-reverse-engineer -->

# agents-reverse-engineer

**AI-driven codebase documentation generator executing Recursive Language Model (RLM) algorithm: concurrent per-file `.sum` analysis via subprocess pools, post-order directory `AGENTS.md` aggregation, and platform-specific root synthesis (`CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`) with gitignore-aware discovery, SHA-256 incremental updates, and session lifecycle hooks.**

## Contents

### Package Definition

**[package.json](./package.json)** — npm manifest defining `agents-reverse-engineer` v0.6.3 with dual binary entry points (`are`, `agents-reverse-engineer` → `dist/cli/index.js`), build scripts (`build` → `tsc`, `build:hooks` → `scripts/build-hooks.js`, `prepublishOnly` → sequential `build && build:hooks`), runtime dependencies (`fast-glob`, `ignore`, `isbinaryfile`, `ora`, `picocolors`, `simple-git`, `yaml`, `zod`), engines requirement (Node.js ≥18.0.0), distribution configuration (`files: ["dist", "hooks/dist", "README.md", "LICENSE"]`).

**[tsconfig.json](./tsconfig.json)** — TypeScript compiler configuration targeting ES2022 with `module: "NodeNext"` and `moduleResolution: "NodeNext"` for ESM/CJS interop, `outDir: "dist"` with `rootDir: "src"` preserving directory structure, strict type checking (`strict: true`, `forceConsistentCasingInFileNames: true`, `isolatedModules: true`), source map generation (`sourceMap: true`, `declarationMap: true`), JSON module imports (`resolveJsonModule: true`), inclusion scope `["src/**/*"]` excluding `node_modules` and `dist`.

### Documentation

**[README.md](./README.md)** — User-facing guide documenting installation workflows (`npx agents-reverse-engineer@latest` interactive mode, `--runtime <rt> {-g|-l}` non-interactive), CLI command reference (`are init`, `are discover`, `are generate`, `are update`, `are specify`, `are clean`), AI slash commands (`/are-*`), configuration schema (`.agents-reverse-engineer/config.yaml` with `exclude`, `options`, `output`, `ai` sections), three-phase pipeline explanation (concurrent file analysis → post-order directory aggregation → sequential root synthesis), incremental update strategy (SHA-256 hash comparison, orphan cleanup, affected directory computation), session hooks (Claude/Gemini auto-update on session end).

**[LICENSE](./LICENSE)** — MIT License granting unrestricted distribution, modification, commercial use without warranty. Copyright holder: GeoloeG-IsT (2026).

### Reference Materials

**[LANGUAGES-MANIFEST.md](./LANGUAGES-MANIFEST.md)** — Matrix documenting 24 programming language ecosystems with manifest files (e.g., `package.json`, `Cargo.toml`, `go.mod`) used by `src/generation/prompts/builder.ts` `detectManifests()` during directory aggregation prompts. Marks supported languages (JavaScript/TypeScript, Python, Go, Rust) with checkmarks, lists unsupported manifests (Ruby `Gemfile`, Java `pom.xml`, C# `*.csproj`, etc.) pending implementation.

## Subdirectories

**[.github/workflows/](./..github/workflows/)** — CI/CD automation for npm publishing with provenance attestation. Contains GitHub Actions workflow `publish.yml` triggered on version tag push.

**[docs/](./docs/)** — Foundational specification `INPUT.md` defining original product vision, RLM algorithm, and feature requirements that guided implementation of three-phase pipeline, incremental updates, session hooks, and multi-platform command interface.

**[hooks/](./hooks/)** — SessionStart and SessionEnd lifecycle hooks for Claude Code, Gemini, OpenCode: `are-check-update.js` (detached subprocess querying npm registry, caching version comparison), `are-session-end.js` (spawning `npx agents-reverse-engineer@latest update --quiet` on uncommitted changes), OpenCode plugin adapters `opencode-are-*.js` exporting async factories with `event['session.created']` and `event['session.deleted']` handlers.

**[scripts/](./scripts/)** — Build automation: `build-hooks.js` copies `hooks/*.js` → `hooks/dist/*.js` via `copyFileSync()` during `prepublishOnly` lifecycle for npm tarball inclusion.

**[src/](./src/)** — TypeScript source tree implementing RLM algorithm across modular subsystems: `ai/` (backend abstraction, subprocess management, telemetry), `cli/` (command entry points), `config/` (Zod schema validation, YAML loading), `discovery/` (gitignore-aware file walking), `generation/` (three-phase orchestration, prompt engineering, `.sum`/`AGENTS.md` writers), `imports/` (static dependency analysis), `installer/` (IDE command/hook registration), `integration/` (platform-specific template synthesis), `orchestration/` (worker pool, progress reporting, trace emission), `quality/` (code-doc consistency, phantom path validation), `update/` (incremental regeneration, orphan cleanup).

## Architecture

### Three-Phase Generation Pipeline

**Phase 1 (Concurrent File Analysis)** — `src/generation/orchestrator.ts` `runPhase1()` executes iterator-based worker pool (`src/orchestration/pool.ts`) sharing single task iterator across N workers (default 2 for WSL, 5 elsewhere). Workers invoke `AIService.call()` → `runSubprocess()` → `execFile()` spawning AI CLI subprocesses (Claude Code, Gemini, OpenCode) with resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`). Writes `.sum` files with YAML frontmatter (`generated_at`, `content_hash` SHA-256, `purpose`, optional `critical_todos`, `related_files`).

**Phase 2 (Post-Order Directory Aggregation)** — `runPhase2()` sorts directories by depth descending via `path.relative().split(path.sep).length`, waits for child `.sum` existence via `isDirectoryComplete()`. Prompts include aggregated child summaries, subdirectory `AGENTS.md`, import maps (`extractDirectoryImports()`), manifest detection (`detectManifests()`). Renames user-authored `AGENTS.md` → `AGENTS.local.md`, prepends above generated content, writes output with `<!-- Generated by agents-reverse-engineer -->` marker.

**Phase 3 (Root Document Synthesis)** — `runPhase3()` sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` via `src/integration/generate.ts`. Prompts consume all `AGENTS.md` via `collectAgentsDocs()` recursive traversal, parse `package.json` for project metadata, enforce synthesis-only constraints (no invention of features/hooks/patterns).

### Subprocess Resource Management

Mitigates Claude CLI thread spawning issue (GitHub #5771: 200 Node.js instances) via environment constraints in `src/ai/subprocess.ts`: `--max-old-space-size=512` limits heap, `UV_THREADPOOL_SIZE='4'` constrains libuv, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` prevents background spawning, `--disallowedTools Task` blocks subagents. Process group killing (`kill(-pid)`) terminates subprocess tree. Timeout enforcement: SIGTERM at `timeoutMs`, SIGKILL after 5s grace period. Exponential backoff retry on rate limits (stderr patterns: "rate limit", "429", "too many requests", "overloaded").

### Incremental Update Strategy

`src/update/orchestrator.ts` reads `content_hash` from `.sum` YAML frontmatter via `readSumFile()`, computes current SHA-256 via `computeContentHash()`. Hash mismatch → add to `filesToAnalyze` as `FileChange` with `status: 'modified'` or `'added'`. Detect orphans: `.sum` for deleted source files. Execute `cleanupOrphans()` (delete stale `.sum`), `cleanupEmptyDirectoryDocs()` (remove `AGENTS.md` from empty directories), compute `affectedDirs` via `getAffectedDirectories()` (parent directory traversal). Regenerate `.sum` for changed files via Phase 1 pool, regenerate `AGENTS.md` for affected directories sequentially (no Phase 2 post-order traversal).

### File Discovery

`src/discovery/walker.ts` executes `fast-glob` with filter chain: `src/discovery/filters/gitignore.ts` (parses via `ignore` library), `binary.ts` (extension + content analysis using `isbinaryfile`), `vendor.ts` (excludes 18 default directories: `node_modules`, `.git`, `dist`, `coverage`, `target`, etc.), `custom.ts` (user-defined glob patterns from config). Supports symlink following via `options.followSymlinks`, size threshold via `options.maxFileSize`.

### Quality Validation

**Code-vs-Doc (`src/quality/inconsistency/code-vs-doc.ts`)** — Extracts exports via regex `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, verifies presence in `.sum` summary text via substring search. Reports `CodeDocInconsistency` with `missingFromDoc` arrays.

**Code-vs-Code (`code-vs-code.ts`)** — Aggregates exports per directory into `Map<symbol, string[]>`, detects duplicates (symbol appears in multiple files). Reports `CodeCodeInconsistency` with `pattern: 'duplicate-export'`.

**Phantom Paths (`src/quality/phantom-paths/validator.ts`)** — Extracts paths from `AGENTS.md` via regex: markdown links `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`, backtick-quoted `` /`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g ``, prose-embedded `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`. Resolves against AGENTS.md directory and project root with `.ts`/`.js` fallback. Reports `PhantomPathInconsistency` for unresolved references.

### Telemetry & Tracing

**Run Logs** — `.agents-reverse-engineer/logs/run-<timestamp>.json` aggregates per-call token counts, costs, durations, errors. Tracks `filesRead[]` metadata (`path`, `sizeBytes`, `linesRead`). Computes summary: `totalInputTokens`, `totalCacheReadTokens`, `errorCount`, `uniqueFilesRead`. Enforces retention via `cleanupOldLogs(keepCount)` after each run.

**Trace Events** — `.agents-reverse-engineer/traces/trace-<timestamp>.ndjson` enabled via `--trace` flag. Events: `phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`. Auto-populated fields: `seq` (monotonic), `ts` (ISO 8601), `pid`, `elapsedMs` (high-resolution delta). Promise-chain serialization ensures NDJSON line order matches emission order. Retention: keeps 500 most recent traces via `cleanupOldTraces(keepCount)`.

**Progress Log** — `.agents-reverse-engineer/progress.log` human-readable streaming output mirroring console. ETA calculation via moving average of last 10 task durations. Quality metrics: code-vs-doc/code-vs-code inconsistencies, phantom path counts. Real-time monitoring: `tail -f .agents-reverse-engineer/progress.log`.

## Stack

**Runtime:** Node.js ≥18.0.0 with ES modules (`"type": "module"` in package.json)

**Language:** TypeScript 5.7.3 (ES2022 target, NodeNext module resolution, strict mode, source maps, declaration maps)

**CLI:** Binary entry points `are` and `agents-reverse-engineer` resolving to `dist/cli/index.js`, spinner UI via `ora`, terminal colors via `picocolors`

**Core Dependencies:**
- `fast-glob@^3.3.3` — File discovery with glob patterns
- `ignore@^7.0.3` — Gitignore parsing for discovery filters
- `isbinaryfile@^5.0.4` — Binary file detection via extension + content analysis
- `simple-git@^3.27.0` — Git diff parsing with rename detection (`-M` flag)
- `yaml@^2.7.0` — Config file parsing (`.agents-reverse-engineer/config.yaml`)
- `zod@^3.24.1` — Schema validation for config structure

**Build:** TypeScript compiler (`tsc`) emits to `dist/`, pre-publish hooks (`build` + `build:hooks`) copy `hooks/` to `hooks/dist/` via `scripts/build-hooks.js`

**AI Backends:**
- `@anthropic-ai/claude-code` — Claude Code CLI adapter via `src/ai/backends/claude.ts`
- Gemini CLI — Stub implementation (`src/ai/backends/gemini.ts` throws `SUBPROCESS_ERROR` until JSON output stabilizes)
- OpenCode CLI — Stub implementation (`src/ai/backends/opencode.ts` throws `SUBPROCESS_ERROR` until JSONL parsing implemented)

**Distribution:** npm package with `files: ["dist", "hooks/dist", "README.md", "LICENSE"]`, published via GitHub Actions workflow `.github/workflows/publish.yml` with provenance attestation

## Key Patterns

### Iterator-Based Worker Pool

`src/orchestration/pool.ts` shares single task iterator across N workers using `iterator.next()` mutex. Each worker loops until iterator exhaustion, preventing over-allocation and enabling clean shutdown. Progress reporter `src/orchestration/progress.ts` computes completion percentage and ETA from total task count and moving average duration.

### Promise-Chain Serialization

`src/orchestration/plan-tracker.ts` `PlanTracker`, `trace.ts` `TraceWriter`, `progress.ts` `ProgressReporter` use internal `writeChain` promise anchoring each write to previous completion. Prevents NDJSON line corruption and file descriptor conflicts during concurrent pool execution.

### Subprocess Lifecycle

`src/ai/subprocess.ts` `runSubprocess()` wraps `execFile()` with resource limits, timeout enforcement (SIGTERM → 5s → SIGKILL), stderr pattern matching for rate limit detection. Returns `{ result, usage }` with token counts/costs or throws `SubprocessError` with exitCode and stderr. Integrates with telemetry logger writing NDJSON run logs.

### Detached Hook Spawn

`hooks/are-session-end.js`, `hooks/opencode-are-session-end.js` spawn background processes via:
```javascript
spawn(process.execPath, ['-e', scriptString], {
  stdio: 'ignore',
  detached: true,
  windowsHide: true
}).unref()
```
Creates independent process group (`detached`), suppresses tty attachment (`stdio: 'ignore'`), removes from event loop reference count (`.unref()`), prevents console window flash on Windows (`windowsHide`).

### Backend Registry

`src/ai/registry.ts` exports `AI_BACKENDS` map: `'claude'` → `ClaudeBackend`, `'gemini'` → `GeminiBackend`, `'opencode'` → `OpenCodeBackend`. `detectAvailableBackends()` spawns `<cli> --version` subprocesses with short timeout (2s), parses stderr for version strings. Used by `ai.backend: 'auto'` config option.

## Installation & Usage

**Interactive Install:**
```bash
npx agents-reverse-engineer@latest
# Prompts for runtime selection (claude/opencode/gemini/all) and location (-g global/-l local)
```

**Non-Interactive Install:**
```bash
npx agents-reverse-engineer@latest --runtime claude -g  # Global install to ~/.claude/
npx agents-reverse-engineer@latest --runtime opencode -l  # Local install to ./.opencode/
```

**Uninstall:**
```bash
npx agents-reverse-engineer@latest uninstall
# Removes command files, session hooks, ARE permissions from settings.json, .agents-reverse-engineer folder (local only)
```

**Configuration:**
```bash
are init  # Creates .agents-reverse-engineer/config.yaml with defaults
```

**Discovery Preview:**
```bash
are discover --plan  # Writes GENERATION-PLAN.md with phase breakdown
are discover --show-excluded  # Shows excluded files with reasons
```

**Full Generation:**
```bash
are generate  # Three-phase pipeline: .sum files → AGENTS.md → CLAUDE.md/GEMINI.md/OPENCODE.md
are generate --trace  # Enable NDJSON trace output to .agents-reverse-engineer/traces/
are generate --debug  # Verbose subprocess logging with heap/RSS metrics
are generate --concurrency 2  # Override worker pool size (1-10)
```

**Incremental Update:**
```bash
are update  # SHA-256 hash-based change detection, regenerates modified files only
are update --uncommitted  # Include working tree changes (git status --porcelain)
```

**Project Specification:**
```bash
are specify  # Synthesizes all AGENTS.md into specs/SPEC.md
are specify --multi-file  # Split output into specs/<dirname>.md per directory
are specify --dry-run  # Preview without writing files
```

**Cleanup:**
```bash
are clean  # Removes .sum, AGENTS.md (generated only), CLAUDE.md, GEMINI.md, OPENCODE.md, GENERATION-PLAN.md
# Restores AGENTS.local.md → AGENTS.md
```

**AI Assistant Commands:**
- `/are-init` — Initialize configuration
- `/are-discover` — Rediscover and regenerate plan
- `/are-generate` — Generate all documentation (monitor via `tail -f .agents-reverse-engineer/progress.log`)
- `/are-update` — Update changed files only
- `/are-specify` — Generate project specification
- `/are-clean` — Remove generated artifacts
- `/are-help` — Show command list

## Environment Configuration

**Path Overrides:**
- `CLAUDE_CONFIG_DIR` — Override `~/.claude` path for Claude Code hooks
- `OPENCODE_CONFIG_DIR` — Override `~/.config/opencode` path for OpenCode plugins
- `GEMINI_CONFIG_DIR` — Override `~/.gemini` path for Gemini CLI commands

**Hook Control:**
- `ARE_DISABLE_HOOK=1` — Disable session-end auto-update (checked by hooks before spawning update subprocess)

**Subprocess Configuration:**
- `NODE_OPTIONS='--max-old-space-size=512'` — Applied to AI CLI subprocesses to limit heap
- `UV_THREADPOOL_SIZE='4'` — Constrains libuv thread pool in subprocesses
- `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` — Prevents Claude CLI background task spawning

## Related Projects

**SpecKit** — Project specification format used by GSD workflow for milestone planning and phase decomposition. ARE generates specifications via `are specify` command.

**BMAD (Brownfield Minimum Automated Documentation)** — Lightweight documentation methodology for legacy codebases. ARE implements BMAD principles through `.sum` files and `AGENTS.md` overviews.

**GSD (Get Shit Done)** — Milestone-driven development workflow with atomic commits, phase-based roadmaps, context handoff protocols. ARE provides documentation foundation for GSD's planning and execution phases.