<!-- Generated by agents-reverse-engineer -->

# agents-reverse-engineer

CLI tool for generating AI-friendly codebase documentation via recursive post-order traversal: parallel `.sum` file analysis followed by hierarchical `AGENTS.md` aggregation, with session hooks for incremental updates and cross-runtime support (Claude Code, Gemini CLI, OpenCode).

## Contents

### Documentation

**[CONTRIBUTING.md](./CONTRIBUTING.md)** — Developer onboarding guide documenting install workflow (`npm install` → `npm run dev` → `npm run build`), six core source directories (`src/cli/`, `src/config/`, `src/discovery/`, `src/generation/`, `src/orchestration/`, `src/ai/`), fork-based contribution process, and MIT License agreement.

**[LANGUAGES-MANIFEST.md](./LANGUAGES-MANIFEST.md)** — Reference catalog mapping 26 language ecosystems to manifest file patterns (`package.json`/npm, `Cargo.toml`/cargo, `go.mod`/go modules) with support status checkboxes. Informs `src/discovery/walker.ts` and `src/imports/extractor.ts` dependency extraction logic.

**[README.md](./README.md)** — Project entry point documenting installation (`npx agents-reverse-engineer@latest` interactive installer with `--runtime <rt> -g|-l` flags), eight CLI commands (`init`, `discover`, `generate`, `update`, `specify`, `clean`, `rebuild`, plus slash command equivalents), generated artifact formats (`.sum` YAML frontmatter + markdown sections, `AGENTS.md` directory aggregates, `CLAUDE.md` runtime pointers), config schema (`.agents-reverse-engineer/config.yaml` with exclude patterns, AI backend selection, concurrency settings), and runtime support matrix.

**[LICENSE](./LICENSE)** — MIT License copyright notice (GeoloeG-IsT, 2026) granting unrestricted usage, modification, and distribution rights with warranty disclaimer.

### Configuration

**[package.json](./package.json)** — npm package manifest (`agents-reverse-engineer@0.7.8`, MIT license) exposing binaries `agents-reverse-engineer` and `are` targeting `dist/cli/index.js`, defining scripts (`build: tsc`, `build:hooks`, `dev: tsx watch`, `prepublishOnly` hook), declaring dependencies (`fast-glob`, `ignore`, `isbinaryfile`, `jsonc-parser`, `ora`, `picocolors`, `simple-git`, `yaml`, `zod`) and devDependencies (`@types/node`, `tsx`, `typescript`), specifying Node.js `>=18.0.0` engine requirement, listing distribution files (`dist/`, `hooks/dist/`, `README.md`, `LICENSE`).

**[tsconfig.json](./tsconfig.json)** — TypeScript compiler configuration targeting ES2022 with `NodeNext` module resolution (ESM package.json `"type": "module"`), strict type-checking, declaration/sourceMap generation, `src/**/*` include pattern, `node_modules`/`dist` exclusion. Enables `resolveJsonModule` and `isolatedModules` for JSON imports and ts-loader compatibility.

## Subdirectories

**[docs/](./docs/)** — Project vision specifications, containing INPUT.md defining the Recursive Language Model (RLM) algorithm (post-order leaf-to-root traversal: file analysis → directory aggregation → root synthesis), command interface, and GSD/BMAD brownfield documentation pattern research directives.

**[hooks/](./hooks/)** — Session lifecycle automation: `are-check-update.js` / `opencode-are-check-update.js` (SessionStart detached npm registry version check writing `~/.claude/cache/are-update-check.json`), `are-session-end.js` / `opencode-are-session-end.js` (detached `are update --quiet` on session close with git change detection, `ARE_DISABLE_HOOK=1` gate, `hook_enabled: false` config gate).

**[scripts/](./scripts/)** — Build automation containing `build-hooks.js` (copies `hooks/*.js` → `hooks/dist/` via `copyFileSync()` during `npm run build:hooks` / `prepublishOnly`).

**[src/](./src/)** — TypeScript source tree implementing two-phase documentation pipeline: phase 1 (parallel file `.sum` generation via `src/generation/orchestrator.ts` → `runPool()` → `AIService.call()` → `writeSumFile()` with SHA-256 `content_hash` frontmatter), phase 2 (post-order directory `AGENTS.md` aggregation via dependency graph sorted by depth descending → `buildDirectoryPrompt()` → `writeAgentsMd()` → root `writeClaudeMdPointer()`). Core subsystems: `src/cli/` (command routing), `src/config/` (YAML/Zod validation), `src/discovery/` (four-filter chain: gitignore → vendor → binary → custom), `src/generation/` (two-phase orchestration + prompt templates), `src/orchestration/` (iterator-based worker pool, NDJSON trace emission, promise-chain serialized progress logging), `src/ai/` (multi-backend subprocess spawning with exponential backoff retry, telemetry, SIGTERM/SIGKILL timeout escalation), `src/update/` (frontmatter-based staleness detection + orphan cleanup), `src/quality/` (code-vs-doc/code-vs-code/phantom-path validation), `src/rebuild/` (AI-driven project reconstruction from specs with checkpoint management), `src/specify/` (AGENTS.md → 12-section project specification transformation).

**[.github/workflows/](../.github/workflows/)** — GitHub Actions CI/CD automation.

## Architecture

### Two-Phase Pipeline

**Phase 1 (File Analysis)**: `src/generation/orchestrator.ts` `createFileTasks()` builds `GenerationTask[]` with `buildFilePrompt()` (injects import maps, project structure), executes via `src/orchestration/runner.ts` `runPool()` with user-configured concurrency (default: `os.availableParallelism() * 5` clamped to memory cap), spawns LLM subprocesses via `src/ai/subprocess.ts` `runSubprocess()` (SIGTERM at timeout, SIGKILL at timeout+5s), writes `.sum` files via `src/generation/writers/sum.ts` `writeSumFile()` with YAML frontmatter (`file_type`, `generated_at`, `content_hash`).

**Phase 2 (Directory Aggregation)**: `createDirectoryTasks()` constructs dependency graph (child file task IDs), sorts by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending), filters via `getReadyDirectories()` where `isDirectoryComplete()` confirms all child `.sum` exist, executes depth-grouped sequential batches with concurrency per group, `buildDirectoryPrompt()` reads child `.sum` via `fs.readFileSync()`, `src/generation/writers/agents-md.ts` `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` + injects `@AGENTS.local.md` directive, root `src/generation/writers/claude-md.ts` `writeClaudeMdPointer()` generates deterministic `CLAUDE.md` import.

### Concurrency Control

`src/orchestration/pool.ts` `runPool<T>()` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator. Each worker pulls `[index, task]` pairs until exhausted or `aborted` flag set. Maintains full utilization during variable-duration tasks. Optional `onComplete?: (result) => void` callback enables serialized `src/orchestration/plan-tracker.ts` `PlanTracker.markDone()` updates to `GENERATION-PLAN.md` checkboxes via promise-chain pattern.

### Update Strategy

`src/update/orchestrator.ts` `UpdateOrchestrator.preparePlan()` reads existing `.sum` YAML frontmatter via `src/generation/writers/sum.ts` `readSumFile()`, compares stored `content_hash` against `src/change-detection/detector.ts` `computeContentHash()` (SHA-256 hex digest), populates `filesToAnalyze` on mismatch, executes phase-1-files pipeline for changed files, invokes `getAffectedDirectories()` collecting parent directories sorted by depth descending, sequentially regenerates `AGENTS.md` consuming updated child `.sum`. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for git-deleted files, removes AGENTS.md when no source files remain.

### Telemetry Pipeline

`src/ai/service.ts` `AIService` wraps `runSubprocess()` in `src/ai/retry.ts` `withRetry()` (exponential backoff: `min(1000 * 2^attempt, 8000) + random(500)` for RATE_LIMIT errors), records `src/ai/telemetry/run-log.ts` `TelemetryEntry` (prompt/response/tokens/latency/retryCount), optional `src/orchestration/trace.ts` `TraceWriter` emits NDJSON events (`subprocess:spawn`, `subprocess:exit`, `retry`, `worker:start`, `task:done`, `phase:start`) to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` when `--trace` flag set. `aiService.finalize(projectRoot)` writes `RunLog` to `.agents-reverse-engineer/logs/run-{timestamp}.json`, calls `src/ai/telemetry/cleanup.ts` `cleanupOldLogs()` enforcing `config.ai.telemetry.keepRuns` retention.

### Quality Checks

`src/orchestration/runner.ts` `CommandRunner.run()` executes five phases: pre-phase-1-cache (reads existing `.sum` for baseline), phase-1-files (parallel AI calls), post-phase-1-quality (`src/quality/inconsistency/code-vs-doc.ts` `checkCodeVsDoc()` detects undocumented exports via `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`, `src/quality/inconsistency/code-vs-code.ts` `checkCodeVsCode()` finds duplicate symbols), phase-2-dirs (post-order aggregation), post-phase-2 (`src/quality/phantom-paths/validator.ts` `checkPhantomPaths()` validates markdown links via `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g` + backtick paths + prose references). Aggregates findings via `src/quality/inconsistency/reporter.ts` `buildInconsistencyReport()`, emits severity-tagged CLI output via `formatReportForCli()`.

## Behavioral Contracts

### Exit Codes
- **0**: all tasks succeeded or no tasks to process
- **1**: partial failure (some tasks failed but some succeeded)
- **2**: total failure (all tasks failed or CLI not found)

### Concurrency Calculation
```javascript
concurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))
// Constants: SUBPROCESS_HEAP_GB=0.512, MEMORY_FRACTION=0.5, MULTIPLIER=5, MIN=2, MAX=20
```

### Exponential Backoff
```javascript
delay = min(1000 * 2^attempt, 8000) + Math.random() * 500
// Defaults: baseDelayMs=1000, multiplier=2, maxDelayMs=8000, jitter=[0,500ms]
```

### Rate Limit Detection
```javascript
['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))
```

### Timeout Escalation
- SIGTERM at `options.timeoutMs`
- SIGKILL at `options.timeoutMs + 5000ms` via `process.kill(-childPid, 'SIGKILL')` (process group)

### Post-Order Sort
```javascript
getDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth
// getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length
```

### Import Extraction
```regex
/^[ \t]*import\s+(type\s+)?(?:\{([^}]*)\}|(\*\s+as\s+\w+)|(\w+))\s+from\s+['"]([^'"]+)['"]/gm
```
Captures: group 1 (type keyword), group 2 (named symbols), group 3 (namespace import), group 4 (default import), group 5 (module specifier).

### Export Extraction
```regex
/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm
```
Captures identifier in group 1 after export keyword and declaration type.

### Hook Disable Mechanisms
```javascript
process.env.ARE_DISABLE_HOOK === '1'
// OR
readFileSync('.agents-reverse-engineer.yaml').includes('hook_enabled: false')
```

### Version Resolution Priority
1. Project-local: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`
2. Global: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`
3. Fallback: `'0.0.0'`

### Update Check Cache Schema
```json
{
  "update_available": false,
  "installed": "0.7.8",
  "latest": "0.7.8",
  "checked": 1738416000
}
```

### Git Change Detection
```javascript
execSync('git status --porcelain', { encoding: 'utf-8' })
// Exit if status.trim() === '' (no changes) or command throws (not a git repo)
```

## Stack

- **Runtime**: Node.js >=18.0.0, ES modules (`"type": "module"`)
- **Language**: TypeScript 5.7.3 targeting ES2022 with NodeNext module resolution
- **Concurrency**: Iterator-based worker pool, shared iterator, N workers (src/orchestration/pool.ts)
- **File Discovery**: fast-glob@3.3.3 with ignore@7.0.3 (gitignore filtering)
- **Git Operations**: simple-git@3.27.0 for change detection (src/change-detection/detector.ts)
- **Config Parsing**: yaml@2.7.0 + zod@3.24.1 schema validation (src/config/schema.ts)
- **JSON Editing**: jsonc-parser@3.3.1 for settings.json hook registration (src/installer/operations.ts)
- **Binary Detection**: isbinaryfile@5.0.4 for `.sum` exclusion (src/discovery/filters/binary.ts)
- **Terminal UI**: ora@8.1.1 (spinners), picocolors@1.1.1 (colored output)
- **AI Backends**: subprocess spawning (`src/ai/subprocess.ts`) targeting `claude`, `gemini`, `opencode` CLIs
- **Build**: tsc (TypeScript compiler), tsx@4.19.2 (dev watch mode)