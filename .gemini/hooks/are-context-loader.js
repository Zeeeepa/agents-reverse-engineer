#!/usr/bin/env node

/**
 * ARE Context Loader Hook (PostToolUse → Read)
 *
 * Fires after every Read tool call. When the read file's directory contains
 * an AGENTS.md generated by ARE, and it hasn't been loaded yet this session,
 * outputs its content as additionalContext for Claude.
 *
 * Deduplicates per session via temp file keyed by session_id.
 * Skips the project root (already loaded via CLAUDE.md → @AGENTS.md).
 */

import fs from 'node:fs';
import path from 'node:path';
import os from 'node:os';

let input = '';
process.stdin.setEncoding('utf8');
process.stdin.on('data', (chunk) => { input += chunk; });
process.stdin.on('end', () => {
  try {
    main(JSON.parse(input));
  } catch {
    // Malformed input — exit silently
  }
});

function main(data) {
  const filePath = data.tool_input && data.tool_input.file_path;
  if (!filePath) return;

  const projectRoot = data.cwd || '';

  // Only trigger for files within the project
  if (projectRoot && !filePath.startsWith(projectRoot)) return;

  const startDir = path.dirname(path.resolve(filePath));

  // Skip project root — already loaded via CLAUDE.md → @AGENTS.md
  if (startDir === projectRoot) return;

  // Deduplicate per session
  const sessionId = data.session_id || 'default';
  const dedupeDir = path.join(os.tmpdir(), 'are-context-loader');
  const dedupeFile = path.join(dedupeDir, sessionId + '.json');

  let seen = {};
  try {
    if (fs.existsSync(dedupeFile)) {
      seen = JSON.parse(fs.readFileSync(dedupeFile, 'utf8'));
    }
  } catch {}

  // Walk from the file's directory up to (but not including) project root,
  // collecting all unseen ARE-generated AGENTS.md files
  const parts = [];
  let dir = startDir;
  while (dir && dir !== projectRoot && dir !== path.dirname(dir)) {
    if (!seen[dir]) {
      const agentsMd = path.join(dir, 'AGENTS.md');
      if (fs.existsSync(agentsMd)) {
        try {
          const content = fs.readFileSync(agentsMd, 'utf8');
          if (content.includes('Generated by agents-reverse-engineer')) {
            const relDir = projectRoot ? path.relative(projectRoot, dir) : dir;
            parts.push('## ARE Context: ' + relDir + '/AGENTS.md\n\n' + content);
            seen[dir] = true;
          }
        } catch {}
      }
    }
    dir = path.dirname(dir);
  }

  if (parts.length === 0) return;

  // Persist dedup state
  try {
    fs.mkdirSync(dedupeDir, { recursive: true });
    fs.writeFileSync(dedupeFile, JSON.stringify(seen));
  } catch {}

  // Output structured JSON — additionalContext is injected into Claude's conversation
  // Reverse so parent context appears before child (root-to-leaf order)
  process.stdout.write(JSON.stringify({
    suppressOutput: false,
    hookSpecificOutput: {
      hookEventName: 'PostToolUse',
      additionalContext: parts.reverse().join('\n\n'),
    },
  }));
}
