---
phase: 08-full-telemetry
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - src/orchestration/progress.ts
  - src/ai/index.ts
autonomous: true

must_haves:
  truths:
    - "Run summary shows estimated cost in format '$X.XXXX (NNK in / NNK out)'"
    - "Run summary shows files-read count with unique dedup: 'N files read (M unique)'"
    - "When cost is unavailable, summary shows 'N/A' instead of $0.0000"
    - "When run cost exceeds configured threshold, a warning is printed to stderr"
    - "When model has no pricing data, a warning about unknown model is printed"
    - "Pricing module is exported from the AI barrel export"
  artifacts:
    - path: "src/orchestration/progress.ts"
      provides: "Enhanced printSummary with cost and files-read display"
      contains: "formatCost"
    - path: "src/ai/index.ts"
      provides: "Barrel export including pricing types and functions"
      contains: "pricing"
  key_links:
    - from: "src/orchestration/progress.ts"
      to: "src/ai/pricing.ts"
      via: "imports formatCost and formatTokens for summary display"
      pattern: "import.*formatCost.*formatTokens.*from"
    - from: "src/ai/index.ts"
      to: "src/ai/pricing.ts"
      via: "barrel re-export of pricing module"
      pattern: "export.*from.*pricing"
---

<objective>
Add cost and files-read display to the run summary, cost threshold warnings, unknown model warnings, and barrel export for the pricing module.

Purpose: This is the user-facing layer -- after this, running `are generate` or `are update` shows estimated cost and files-read counts in the terminal summary, with warnings when cost exceeds a configured threshold or model pricing is unknown.
Output: Enhanced summary display and barrel export.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-full-telemetry/08-RESEARCH.md
@.planning/phases/08-full-telemetry/08-01-SUMMARY.md
@.planning/phases/08-full-telemetry/08-02-SUMMARY.md

Source files to modify:
@src/orchestration/progress.ts
@src/ai/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance summary display with cost and files-read</name>
  <files>src/orchestration/progress.ts</files>
  <action>
    1. Import `formatCost` and `formatTokens` from `../ai/pricing.js`.

    2. Update `printSummary(summary: RunSummary)` to add cost and files-read lines. The new output should look like:

       ```
       === Run Summary ===
         Files processed: 12
         Total calls:     12
         Estimated cost:  $0.1234 (42K in / 8K out)
         Files read:      12 (10 unique)
         Total time:      45.2s
         Errors:          0
       ```

       Specifically, replace the existing tokens-in/tokens-out lines with a single "Estimated cost" line that uses `formatCost` and `formatTokens`:
       ```typescript
       const costStr = formatCost(summary.totalCostUsd, summary.costAvailable);
       const tokIn = formatTokens(summary.totalInputTokens);
       const tokOut = formatTokens(summary.totalOutputTokens);
       console.log(`  Estimated cost:  ${costStr} (${tokIn} in / ${tokOut} out)`);
       ```

    3. Add a "Files read" line after the cost line:
       ```typescript
       if (summary.totalFilesRead > 0) {
         console.log(`  Files read:      ${summary.totalFilesRead} (${summary.uniqueFilesRead} unique)`);
       }
       ```

    4. Keep the existing lines for Files processed, Files failed, Files skipped, Total calls, Total time, Errors, Retries -- just reorder so cost and files come after Total calls and before Total time.

    5. Add a cost threshold check after the summary. Accept an optional `costThresholdUsd` parameter:
       ```typescript
       printSummary(summary: RunSummary, costThresholdUsd?: number): void {
       ```
       After printing the summary block, if the threshold is set and exceeded:
       ```typescript
       if (costThresholdUsd !== undefined && summary.costAvailable && summary.totalCostUsd > costThresholdUsd) {
         console.error(
           pc.yellow(`Warning: Run cost $${summary.totalCostUsd.toFixed(4)} exceeds configured threshold of $${costThresholdUsd.toFixed(4)}`)
         );
       }
       ```
       Use `console.error` for warnings (stderr) to preserve JSON output on stdout.
  </action>
  <verify>
    `npx tsc --noEmit` passes. Manual review: the summary output format matches the design spec.
  </verify>
  <done>
    printSummary shows estimated cost with token breakdown, files-read with unique count, and prints cost threshold warning to stderr when exceeded. Format uses $X.XXXX 4-decimal precision and NK/NM token abbreviations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Barrel export, cost threshold in runner, and unknown model warning</name>
  <files>src/ai/index.ts, src/orchestration/runner.ts, src/ai/service.ts</files>
  <action>
    **In `src/ai/index.ts`:**

    1. Add pricing module exports to the barrel:
       ```typescript
       // ---------------------------------------------------------------------------
       // Pricing and cost estimation
       // ---------------------------------------------------------------------------

       export type { ModelPricing, CostSource, CostEstimate } from './pricing.js';
       export { DEFAULT_MODEL_PRICING, lookupPricing, estimateCost, formatCost, formatTokens } from './pricing.js';
       ```

    2. Add `FileRead` to the type exports from `./types.js`.

    **In `src/orchestration/runner.ts`:**

    3. Update `executeGenerate()` and `executeUpdate()` to pass `costThresholdUsd` to `reporter.printSummary()`. The config is not currently available in CommandRunner. Add it:
       - Add a `config` field to `CommandRunOptions` or pass the threshold directly.
       - Simplest approach: add `costThresholdUsd?: number` to `CommandRunOptions`.
       - In both executeGenerate and executeUpdate, pass it to printSummary:
         ```typescript
         reporter.printSummary(summary, this.options.costThresholdUsd);
         ```

    **In `src/ai/service.ts`:**

    4. Add an unknown model warning. When `estimateCost` returns `source: 'unavailable'`, log a warning to stderr (once per unique unknown model per run, to avoid spam):
       - Add a `private readonly warnedModels = new Set<string>();` field to `AIService`.
       - After the `estimateCost` call in `call()`, if `costResult.source === 'unavailable'` and the model hasn't been warned about yet:
         ```typescript
         if (costResult.source === 'unavailable' && !this.warnedModels.has(response.model)) {
           this.warnedModels.add(response.model);
           console.error(`Warning: No pricing data for model "${response.model}". Cost shown as N/A. Add pricing in config under ai.pricing.`);
         }
         ```
  </action>
  <verify>
    ```bash
    npx tsc --noEmit
    npx vitest run
    ```
    Both pass. The barrel export compiles and the pricing types are importable from `./ai/index.js`.
  </verify>
  <done>
    Pricing module exported from AI barrel. Cost threshold warning printed when exceeded. Unknown model warning printed once per unique model. All callers of printSummary pass through the cost threshold from config.
  </done>
</task>

</tasks>

<verification>
```bash
npx tsc --noEmit
npx vitest run
```
Both pass. Verify manually:
1. The import `import { estimateCost, formatCost, ModelPricing } from './ai/index.js'` resolves correctly.
2. The `printSummary` output includes cost and files-read lines.
3. The cost threshold warning is emitted to stderr.
</verification>

<success_criteria>
- `npx tsc --noEmit` passes
- `npx vitest run` passes
- Run summary output includes "Estimated cost: $X.XXXX (NK in / NK out)"
- Run summary output includes "Files read: N (M unique)" when files were tracked
- Cost threshold warning prints to stderr when exceeded
- Unknown model warning prints to stderr (once per model) when pricing unavailable
- Pricing types and functions are importable from `src/ai/index.ts`
</success_criteria>

<output>
After completion, create `.planning/phases/08-full-telemetry/08-03-SUMMARY.md`
</output>
