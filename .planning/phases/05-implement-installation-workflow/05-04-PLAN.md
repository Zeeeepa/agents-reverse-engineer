---
phase: 05-implement-installation-workflow
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - src/installer/uninstall.ts
  - src/installer/index.ts
  - src/cli/index.ts
autonomous: true

must_haves:
  truths:
    - "Uninstall removes all installed command and hook files"
    - "Uninstall removes hook registration from settings.json"
    - "CLI routes 'install' subcommand to installer"
    - "Non-interactive mode works with flags (--runtime --global)"
    - "Installer can be invoked via npx agents-reverse-engineer"
  artifacts:
    - path: "src/installer/uninstall.ts"
      provides: "Uninstallation logic for removing installed files"
      exports: ["uninstallFiles", "unregisterHooks"]
    - path: "src/installer/index.ts"
      provides: "Complete installer entry point with all flows"
      exports: ["runInstaller", "parseInstallerArgs"]
    - path: "src/cli/index.ts"
      provides: "CLI with install subcommand routing"
  key_links:
    - from: "src/cli/index.ts"
      to: "src/installer/index.ts"
      via: "install command handler"
      pattern: "import.*from.*installer"
    - from: "src/installer/index.ts"
      to: "src/installer/operations.ts"
      via: "file installation"
      pattern: "installFiles"
    - from: "src/installer/index.ts"
      to: "src/installer/uninstall.ts"
      via: "uninstall flow"
      pattern: "uninstallFiles"
---

<objective>
Complete the installer with uninstall support and CLI integration.

Purpose: Finalizes the installation workflow by adding uninstall capability and wiring everything into the main CLI. Makes `npx agents-reverse-engineer` and `are install` work end-to-end.

Output: Uninstall module, completed installer entry point, and updated CLI with install command.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-implement-installation-workflow/05-CONTEXT.md
@.planning/phases/05-implement-installation-workflow/05-RESEARCH.md
@src/cli/index.ts
@src/installer/types.ts
@src/installer/paths.ts
@src/installer/operations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create uninstall module</name>
  <files>src/installer/uninstall.ts</files>
  <action>
Create src/installer/uninstall.ts with:

1. Imports:
   - `import { existsSync, unlinkSync, readFileSync, writeFileSync, readdirSync, rmdirSync } from 'node:fs'`
   - `import * as path from 'node:path'`
   - `import type { Runtime, Location, InstallerResult } from './types.js'`
   - `import { resolveInstallPath, getAllRuntimes } from './paths.js'`
   - `import { getClaudeTemplates, getOpenCodeTemplates, getGeminiTemplates } from '../integration/templates.js'`

2. `uninstallFiles(runtime: Runtime, location: Location, dryRun: boolean = false): InstallerResult[]`:
   - If runtime is 'all', iterate getAllRuntimes() and call uninstallFilesForRuntime for each
   - Otherwise call uninstallFilesForRuntime once
   - Return array of results

3. `uninstallFilesForRuntime(runtime: Exclude<Runtime, 'all'>, location: Location, dryRun: boolean): InstallerResult`:
   - Resolve base install path
   - Get templates for this runtime
   - For each template:
     - Compute full path
     - If exists, delete file (unless dryRun)
     - Track deleted files
   - For Claude, also delete hook file if exists
   - Delete VERSION file if exists
   - Try to remove empty are/ commands directory
   - Call unregisterHooks() for Claude
   - Return result with files deleted

4. `unregisterHooks(basePath: string, dryRun: boolean): boolean`:
   - Settings path: path.join(basePath, 'settings.json')
   - If doesn't exist, return false
   - Read and parse settings.json
   - Find and remove ARE hook from SessionEnd array (match by command string)
   - If hooks.SessionEnd becomes empty, remove the key
   - If hooks becomes empty, remove the key
   - Write updated settings.json (unless dryRun)
   - Return true if hook was removed

5. `cleanupEmptyDirs(dirPath: string): void`:
   - Helper to remove empty directories recursively
   - Check if directory is empty (after file deletions)
   - If empty, rmdir
   - Work up the tree until non-empty or at root

6. Export uninstallFiles, unregisterHooks
  </action>
  <verify>
Run: `npx tsc --noEmit src/installer/uninstall.ts`
No TypeScript errors.
  </verify>
  <done>Uninstall module removes installed files and unregisters hooks from settings.json.</done>
</task>

<task type="auto">
  <name>Task 2: Complete installer entry point</name>
  <files>src/installer/index.ts</files>
  <action>
Update src/installer/index.ts to complete the implementation:

1. Add imports:
   - `import { installFiles, verifyInstallation, formatInstallResult } from './operations.js'`
   - `import { uninstallFiles } from './uninstall.js'`

2. Complete `runInstaller(args: InstallerArgs)`:
   - If args.help, call showHelp() and return []

   - Determine mode: uninstall or install based on args.uninstall

   - For UNINSTALL mode:
     - Determine runtime (from args or prompt)
     - Determine location (from args or prompt)
     - Call uninstallFiles(runtime, location, dryRun)
     - Display results using showSuccess/showInfo
     - Return results

   - For INSTALL mode:
     - Display banner
     - Check if non-interactive and missing required flags -> error
     - Determine runtime (from args or prompt via selectRuntime())
     - Determine location (from args or prompt via selectLocation())
     - Call installFiles(runtime, location, { force: args.force, dryRun: false })
     - Call verifyInstallation() on created files
     - If verification fails, show error for missing files
     - Display success message with:
       - Checkmarks for each action: "Created commands", "Registered hooks", etc.
       - List of skipped files if any
       - Next steps: "Run /are:help in Claude Code to get started"
       - Links: GitHub docs URL, community link
     - Ask if user wants to run `are init` in current project (if local install)
     - Return results

3. Add output formatting:
   - Use showSuccess() for completed items
   - Use showInfo() for next steps
   - Use showWarning() for skipped files
   - Show GitHub URL: https://github.com/GeoloeG-IsT/agents-reverse-engineer

4. Handle non-interactive mode:
   - If !isInteractive() && (!args.runtime || (!args.global && !args.local)):
     - showError("Non-interactive mode requires --runtime and --global or --local flags")
     - process.exit(1)
  </action>
  <verify>
Run: `npx tsc --noEmit src/installer/index.ts`
No TypeScript errors. All paths wire together.
  </verify>
  <done>Installer entry point handles full install/uninstall flow with prompts and output.</done>
</task>

<task type="auto">
  <name>Task 3: Add install command to CLI</name>
  <files>src/cli/index.ts</files>
  <action>
Update src/cli/index.ts:

1. Add import:
   - `import { runInstaller, parseInstallerArgs } from '../installer/index.js'`
   - `import { displayBanner, showHelp as showInstallerHelp } from '../installer/banner.js'`

2. Update USAGE string to include install command:
   ```
   Commands:
     install           Install commands and hooks to AI assistant
     init              Create default configuration
     ...

   Install Options:
     --runtime <name>  Runtime to install (claude, opencode, gemini, all)
     -g, --global      Install to global config directory
     -l, --local       Install to current project directory
     -u, --uninstall   Remove installed files
     --force           Overwrite existing files
   ```

3. Add case 'install' to the switch statement:
   ```typescript
   case 'install': {
     // Re-parse args for installer-specific flags
     const installerArgs = parseInstallerArgs(args);
     await runInstaller(installerArgs);
     break;
   }
   ```

4. Consider: If no command is provided and we detect installer-style flags (--runtime, -g, -l, -u),
   route to installer automatically (for `npx agents-reverse-engineer --runtime claude -g` use case).

   Add before the switch:
   ```typescript
   // Direct installer invocation without 'install' command
   if (!command && (flags.has('global') || flags.has('local') || values.has('runtime') || flags.has('uninstall'))) {
     const installerArgs = parseInstallerArgs(args);
     await runInstaller(installerArgs);
     return;
   }
   ```

5. For the default case (no command, no help), show help instead of error.
  </action>
  <verify>
Run: `npx tsc --noEmit src/cli/index.ts`
No TypeScript errors.
Run: `npx tsx src/cli/index.ts --help` shows install in commands list.
Run: `npx tsx src/cli/index.ts install --help` shows installer help.
  </verify>
  <done>CLI routes 'install' command and direct flag invocation to installer module.</done>
</task>

</tasks>

<verification>
1. All files compile: `npm run build`
2. `npx tsx src/cli/index.ts install --help` shows installer help
3. `npx tsx src/cli/index.ts --runtime claude --global --force` runs non-interactive install
4. Uninstall removes files and unregisters hooks
5. Interactive mode prompts for runtime and location
</verification>

<success_criteria>
- [ ] src/installer/uninstall.ts exports uninstallFiles, unregisterHooks
- [ ] Uninstall removes command files, hook files, and VERSION
- [ ] Uninstall removes hook registration from settings.json
- [ ] src/cli/index.ts handles 'install' command
- [ ] Direct flag invocation (npx are --runtime claude -g) works
- [ ] Non-interactive mode validates required flags are present
- [ ] Success message shows checkmarks and next steps
</success_criteria>

<output>
After completion, create `.planning/phases/05-implement-installation-workflow/05-04-SUMMARY.md`
</output>
