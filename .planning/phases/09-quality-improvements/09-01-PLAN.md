---
phase: 09-quality-improvements
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/quality/types.ts
  - src/quality/inconsistency/code-vs-doc.ts
  - src/quality/inconsistency/code-vs-doc.test.ts
autonomous: true

must_haves:
  truths:
    - "extractExports finds named exports (function, class, const, let, var, type, interface, enum) from TypeScript/JavaScript source"
    - "extractExports finds default exports"
    - "extractExports ignores non-export declarations and re-exports"
    - "checkCodeVsDoc returns null when .sum content is consistent with source exports"
    - "checkCodeVsDoc flags missingFromDoc when source has exports not mentioned in .sum"
    - "checkCodeVsDoc flags missingFromCode when .sum mentions symbols not found in source"
    - "checkCodeVsDoc severity is error when missingFromCode is non-empty, warning when only missingFromDoc"
    - "checkCodeVsDoc uses case-sensitive matching for symbol names to respect casing conventions"
  artifacts:
    - path: "src/quality/types.ts"
      provides: "Shared types for inconsistency detection and density analysis"
      exports: ["CodeDocInconsistency", "CodeCodeInconsistency", "Inconsistency", "InconsistencyReport", "InconsistencySeverity"]
    - path: "src/quality/inconsistency/code-vs-doc.ts"
      provides: "Heuristic code-vs-doc inconsistency detection via export extraction and .sum comparison"
      exports: ["extractExports", "checkCodeVsDoc"]
    - path: "src/quality/inconsistency/code-vs-doc.test.ts"
      provides: "Test suite covering all extraction and comparison behaviors"
      min_lines: 80
  key_links:
    - from: "src/quality/inconsistency/code-vs-doc.ts"
      to: "src/quality/types.ts"
      via: "imports CodeDocInconsistency type"
      pattern: "import.*CodeDocInconsistency.*from.*types"
    - from: "src/quality/inconsistency/code-vs-doc.ts"
      to: "src/generation/writers/sum.ts"
      via: "uses SumFileContent type for .sum comparison"
      pattern: "import.*SumFileContent.*from.*sum"
---

<objective>
Build the foundational types for quality analysis and implement heuristic code-vs-doc inconsistency detection with full test coverage.

Purpose: Provides the type definitions shared by all quality analysis features and the core INCON-01 detection logic. This is pure string-matching heuristic logic with clearly defined inputs/outputs -- ideal for TDD.
Output: `src/quality/types.ts` with shared types, `src/quality/inconsistency/code-vs-doc.ts` with detection logic, and `src/quality/inconsistency/code-vs-doc.test.ts` with tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-quality-improvements/09-RESEARCH.md

Key reference: The RESEARCH.md contains example interfaces and code for `extractExports`, `checkCodeVsDoc`, and all type definitions. Follow those patterns precisely.

Existing codebase conventions:
- ESM with NodeNext resolution (import with .js extensions)
- JSDoc on all exports
- Test runner: vitest (configured in package.json)
- `SumFileContent` type lives in `src/generation/writers/sum.ts`
- `SummaryMetadata` type lives in `src/generation/types.ts` (has `purpose`, `publicInterface`, `dependencies`, `patterns` fields)
</context>

<feature>
  <name>Quality types and code-vs-doc inconsistency detection</name>
  <files>src/quality/types.ts, src/quality/inconsistency/code-vs-doc.ts, src/quality/inconsistency/code-vs-doc.test.ts</files>
  <behavior>
    **Types (src/quality/types.ts):**

    - `InconsistencySeverity = 'info' | 'warning' | 'error'`

    - `CodeDocInconsistency` -- inconsistency between .sum content and source code:
      ```
      { type: 'code-vs-doc'; severity: InconsistencySeverity; filePath: string; sumPath: string;
        description: string; details: { missingFromDoc: string[]; missingFromCode: string[];
        purposeMismatch?: string; } }
      ```

    - `CodeCodeInconsistency` -- inconsistency across files:
      ```
      { type: 'code-vs-code'; severity: InconsistencySeverity; files: string[];
        description: string; pattern: string; }
      ```

    - `Inconsistency = CodeDocInconsistency | CodeCodeInconsistency`

    - `InconsistencyReport`:
      ```
      { metadata: { timestamp: string; projectRoot: string; filesChecked: number; durationMs: number; };
        issues: Inconsistency[]; summary: { total: number; codeVsDoc: number; codeVsCode: number;
        errors: number; warnings: number; info: number; } }
      ```

    **Functions (src/quality/inconsistency/code-vs-doc.ts):**

    - `extractExports(sourceContent: string): string[]`
      - Matches: `export function foo`, `export class Bar`, `export const BAZ`, `export let x`, `export var y`, `export type Foo`, `export interface Bar`, `export enum Status`, `export default function main`, `export default class App`
      - Does NOT match: `// export const commented`, internal declarations without export, re-exports like `export { foo } from './bar'`
      - Example: `extractExports('export function foo() {}\nexport const BAR = 1;\nfunction internal() {}')` -> `['foo', 'BAR']`

    - `checkCodeVsDoc(sourceContent: string, sumContent: SumFileContent, filePath: string): CodeDocInconsistency | null`
      - Compares exports from source against names mentioned in .sum text (summary + publicInterface joined)
      - `missingFromDoc`: exports in source not found anywhere in .sum text (case-sensitive word boundary search)
      - `missingFromCode`: items in `sumContent.metadata.publicInterface` not found as exports in source
      - Returns `null` when no inconsistencies detected
      - severity: `'error'` when `missingFromCode.length > 0`, `'warning'` when only `missingFromDoc`
      - `sumPath` is always `${filePath}.sum`
      - description format: `"Documentation out of sync: X exports undocumented, Y documented items not found in code"`

    Test cases to cover:
    1. `extractExports` with all export declaration types (function, class, const, let, var, type, interface, enum)
    2. `extractExports` with default exports
    3. `extractExports` ignoring comments, internal declarations, re-exports
    4. `extractExports` returning empty array for no-export files
    5. `checkCodeVsDoc` returning null for consistent source + .sum
    6. `checkCodeVsDoc` detecting missingFromDoc (new export added to source)
    7. `checkCodeVsDoc` detecting missingFromCode (export removed from source)
    8. `checkCodeVsDoc` detecting both missingFromDoc and missingFromCode simultaneously
    9. `checkCodeVsDoc` severity levels (error vs warning)
    10. `checkCodeVsDoc` case-sensitive matching (export `Foo` not matched by text mentioning `foo`)
  </behavior>
  <implementation>
    Follow the code examples in RESEARCH.md. Key implementation details:

    - `extractExports` regex: `/export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/g`
    - For checking symbol presence in .sum text, search the concatenation of `sumContent.summary + ' ' + sumContent.metadata.publicInterface.join(' ')` using word boundary matching or simple `includes()` for the symbol name
    - `missingFromCode` checks each item in `sumContent.metadata.publicInterface` to see if any source export name appears in it (partial match since publicInterface might contain signatures like "fetchData(url: string): Promise")
    - Create the `src/quality/` directory structure: `src/quality/types.ts`, `src/quality/inconsistency/code-vs-doc.ts`
  </implementation>
</feature>

<verification>
```bash
npx vitest run src/quality/inconsistency/code-vs-doc.test.ts
npx tsc --noEmit
```
All tests pass. No type errors.
</verification>

<success_criteria>
- src/quality/types.ts exports all inconsistency types
- src/quality/inconsistency/code-vs-doc.ts exports extractExports and checkCodeVsDoc
- src/quality/inconsistency/code-vs-doc.test.ts covers all 10 test cases listed above
- `npx vitest run src/quality/inconsistency/code-vs-doc.test.ts` passes
- `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-quality-improvements/09-01-SUMMARY.md`
</output>
