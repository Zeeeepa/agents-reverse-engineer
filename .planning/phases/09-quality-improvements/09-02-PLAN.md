---
phase: 09-quality-improvements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/generation/prompts/templates.ts
  - src/generation/prompts/types.ts
  - src/generation/writers/agents-md.ts
  - src/quality/density/validator.ts
autonomous: true

must_haves:
  truths:
    - "BASE_SYSTEM_PROMPT includes density rules requiring every sentence to reference a specific identifier"
    - "BASE_SYSTEM_PROMPT includes anchor term preservation rules requiring all exported identifiers to appear in summaries"
    - "BASE_SYSTEM_PROMPT prohibits filler phrases (this file, this module, provides, responsible for, is used to)"
    - "All 11 per-type templates inherit the density-aware system prompt"
    - "AGENTS.md Contents section shows file name with brief link but does NOT repeat the full purpose description from .sum"
    - "AGENTS.md includes a cross-cutting Patterns section that adds parent-unique value"
    - "AGENTS.md includes a How Files Relate section synthesized from file descriptions"
    - "validateFindability checks that exported symbol names from .sum files appear in parent AGENTS.md content"
  artifacts:
    - path: "src/generation/prompts/templates.ts"
      provides: "Density-aware prompt templates with anchor term preservation and filler elimination"
      exports: ["TEMPLATES", "getTemplate"]
    - path: "src/generation/writers/agents-md.ts"
      provides: "AGENTS.md builder with hierarchical dedup -- parents add patterns and relationships, not repeated descriptions"
      exports: ["buildAgentsMd", "buildDirectoryDoc", "writeAgentsMd"]
    - path: "src/quality/density/validator.ts"
      provides: "Heuristic findability validation: checks that key symbols from .sum appear in AGENTS.md"
      exports: ["validateFindability", "FindabilityResult"]
  key_links:
    - from: "src/generation/prompts/templates.ts"
      to: "BASE_SYSTEM_PROMPT"
      via: "All 11 templates reference the shared density-aware system prompt"
      pattern: "DENSITY RULES"
    - from: "src/generation/writers/agents-md.ts"
      to: "src/generation/writers/sum.ts"
      via: "buildDirectoryDoc reads .sum files to extract metadata"
      pattern: "readSumFile"
    - from: "src/quality/density/validator.ts"
      to: "src/generation/writers/sum.ts"
      via: "reads SumFileContent for exported symbol names"
      pattern: "import.*SumFileContent"
---

<objective>
Revise prompts for higher information density and modify the AGENTS.md builder to eliminate parent-child content duplication.

Purpose: Addresses all four density requirements (DENSE-01 through DENSE-04). The revised prompts produce .sum files with more compressed, identifier-rich content. The modified AGENTS.md builder generates parents that add unique cross-cutting value rather than repeating child descriptions. A findability validator confirms the output quality.
Output: Updated `src/generation/prompts/templates.ts`, updated `src/generation/writers/agents-md.ts`, new `src/quality/density/validator.ts`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-quality-improvements/09-RESEARCH.md

Key references from RESEARCH.md:
- Pattern 2: Prompt-Driven Density -- single-pass density-aware prompt with anchor term preservation
- Pattern 3: Hierarchical Deduplication -- parent AGENTS.md adds only cross-cutting value
- Example 4: DENSE_BASE_SYSTEM_PROMPT with density rules and anchor term preservation
- Example 5: Modified buildAgentsMd with dedup
- Example 6: FindabilityTest interface and generateFindabilityTests

Existing files to modify:
@src/generation/prompts/templates.ts
@src/generation/prompts/types.ts
@src/generation/writers/agents-md.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Revise prompts for density and anchor term preservation (DENSE-01, DENSE-02)</name>
  <files>src/generation/prompts/templates.ts, src/generation/prompts/types.ts</files>
  <action>
    Replace the existing `BASE_SYSTEM_PROMPT` in `templates.ts` with a density-aware version adapted from RESEARCH.md Example 4. The new system prompt MUST include:

    1. **DENSITY RULES** section:
       - Every sentence must reference at least one specific identifier from the code
       - Prohibit filler phrases: "this file", "this module", "provides", "responsible for", "is used to", "basically", "essentially", "provides functionality for"
       - Use technical shorthand: "exports X, Y, Z" not "this module exports a function called X..."
       - Compress descriptions: "parses YAML frontmatter from .sum files" not "responsible for the parsing of YAML-style frontmatter..."
       - Maximum 300 words (reduced from 300-500). Every word must earn its place.

    2. **ANCHOR TERM PRESERVATION** section:
       - All exported function/class/type/const names MUST appear in the summary
       - Key parameter types and return types MUST be mentioned
       - Preserve exact casing of identifiers (e.g., `buildAgentsMd`, not "build agents md")

    3. **OUTPUT FORMAT** section:
       - Lead with a single-line purpose statement (what this file IS, not what it does)
       - List all public exports with type signatures
       - For each export: one sentence explaining its role
       - End with dependencies and coupled files

    All 11 per-type templates (`COMPONENT_TEMPLATE`, `SERVICE_TEMPLATE`, etc.) already reference `BASE_SYSTEM_PROMPT` as their `systemPrompt`, so they will inherit the density rules automatically.

    Also update `SUMMARY_GUIDELINES` in `types.ts`: change `targetLength.max` from 500 to 300 to match the new density constraint.

    Do NOT change the userPrompt templates -- those are type-specific and already structured well. The density improvement comes from the systemPrompt constraints.
  </action>
  <verify>
    ```bash
    npx tsc --noEmit
    ```
    Grep for "DENSITY RULES" in templates.ts to confirm the new prompt section exists.
    Grep for "ANCHOR TERM" in templates.ts to confirm anchor term preservation section exists.
    Grep for "max: 300" in types.ts to confirm reduced word count.
  </verify>
  <done>
    BASE_SYSTEM_PROMPT contains DENSITY RULES and ANCHOR TERM PRESERVATION sections. All 11 templates inherit them. SUMMARY_GUIDELINES.targetLength.max is 300. `npx tsc --noEmit` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Hierarchical dedup in AGENTS.md builder + findability validator (DENSE-03, DENSE-04)</name>
  <files>src/generation/writers/agents-md.ts, src/quality/density/validator.ts</files>
  <action>
    **Modify `buildAgentsMd` in `agents-md.ts`:**

    Change the Contents section to show abbreviated file references instead of repeating the full purpose description from .sum files. The current format is:
    ```
    - [file.ts](./file.ts) - Full purpose description from .sum
    ```
    Change to:
    ```
    - [file.ts](./file.ts)
    ```
    This eliminates the biggest source of parent-child duplication. The full description already lives in the .sum file.

    Keep the `critical` marker for critical files (append ` **[critical]**` after the link).

    **Add "How Files Relate" section:**

    After the Contents section (or after Patterns if it exists), add a "How Files Relate" section using `doc.description`. This is inherently parent-level information -- how the directory's files work together -- that no individual child contains.

    The section should only appear if `doc.description` is non-empty. Format:
    ```
    ## How Files Relate

    {doc.description}
    ```

    Move the `doc.description` from being rendered under the H1 header (where it currently is) to this dedicated section, so the H1 is clean.

    **Create `src/quality/density/validator.ts`:**

    Create a heuristic findability validator (no LLM calls). Export:

    - `FindabilityResult { filePath: string; symbolsTested: string[]; symbolsFound: string[]; symbolsMissing: string[]; score: number; }` (score = found/tested, 0-1)
    - `validateFindability(agentsMdContent: string, sumFiles: Map<string, SumFileContent>): FindabilityResult[]`
      - For each .sum file, check if the key symbols from `metadata.publicInterface` appear in the AGENTS.md content
      - Score: `symbolsFound.length / symbolsTested.length` (1.0 = all found, 0.0 = none found)
      - If a .sum file has no publicInterface items, skip it (don't include in results)
      - Symbol matching is case-sensitive string includes on the AGENTS.md content

    Import `SumFileContent` from `../../generation/writers/sum.js`.
    Create directory `src/quality/density/` if it does not exist.
  </action>
  <verify>
    ```bash
    npx tsc --noEmit
    ```
    Review the output of `buildAgentsMd` to confirm file entries no longer include the ` - ${file.description}` suffix.
    Confirm "How Files Relate" section is generated.
    Confirm `src/quality/density/validator.ts` exports `validateFindability` and `FindabilityResult`.
  </verify>
  <done>
    `buildAgentsMd` generates abbreviated file references without repeating .sum descriptions. A "How Files Relate" section uses the synthesized directory description. `validateFindability` checks symbol presence in AGENTS.md content. `npx tsc --noEmit` passes.
  </done>
</task>

</tasks>

<verification>
```bash
# Type check
npx tsc --noEmit

# Confirm density rules in prompts
grep -c "DENSITY RULES" src/generation/prompts/templates.ts
# Expected: 1

# Confirm anchor term section in prompts
grep -c "ANCHOR TERM" src/generation/prompts/templates.ts
# Expected: 1

# Confirm dedup in AGENTS.md builder (file entries without description suffix)
grep -c "file.description" src/generation/writers/agents-md.ts
# Expected: 0 (removed from the Contents section link line)

# Confirm findability validator exists
grep -c "validateFindability" src/quality/density/validator.ts
# Expected: at least 1
```
</verification>

<success_criteria>
- BASE_SYSTEM_PROMPT in templates.ts includes DENSITY RULES and ANCHOR TERM PRESERVATION sections
- SUMMARY_GUIDELINES max word count is 300
- buildAgentsMd Contents section links files without repeating .sum descriptions
- buildAgentsMd includes "How Files Relate" section with directory description
- src/quality/density/validator.ts exports validateFindability and FindabilityResult
- `npx tsc --noEmit` passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-quality-improvements/09-02-SUMMARY.md`
</output>
