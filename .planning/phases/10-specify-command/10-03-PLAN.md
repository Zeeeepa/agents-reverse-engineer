---
phase: 10-specify-command
plan: 03
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - src/cli/specify.ts
  - src/cli/index.ts
  - src/specify/index.ts
autonomous: true

must_haves:
  truths:
    - "Running `are specify .` collects all AGENTS.md + .sum content, calls AI, and writes a spec to specs/SPEC.md"
    - "Running `are specify --dry-run` shows input file count, estimated tokens, output path, and context window warning if >150K tokens -- without calling AI"
    - "Running `are specify --force` overwrites existing spec files without error"
    - "Running `are specify --output custom/path.md` writes the spec to the specified location"
    - "Running `are specify --multi-file` splits output into multiple files in the specs/ directory"
    - "When no AGENTS.md files exist, the command auto-generates by calling generateCommand() before proceeding"
    - "When no AI CLI is installed, the command fails with actionable install instructions"
    - "The specify command is registered in the CLI entry point and appears in --help output"
    - "Telemetry run log is written after the AI call completes"
  artifacts:
    - path: "src/cli/specify.ts"
      provides: "CLI specify command handler"
      exports: ["specifyCommand", "SpecifyOptions"]
    - path: "src/cli/index.ts"
      provides: "CLI entry point with specify command registered"
      contains: "case 'specify'"
    - path: "src/specify/index.ts"
      provides: "Complete barrel export for specify module"
      exports: ["collectSpecInput", "SpecInput", "buildSpecPrompt", "SpecPrompt", "writeSpec", "WriteSpecOptions", "SpecExistsError"]
  key_links:
    - from: "src/cli/specify.ts"
      to: "src/specify/index.ts"
      via: "imports collectSpecInput, buildSpecPrompt, writeSpec"
      pattern: "from.*specify/index"
    - from: "src/cli/specify.ts"
      to: "src/ai/index.ts"
      via: "AIService, createBackendRegistry, resolveBackend for AI orchestration"
      pattern: "AIService"
    - from: "src/cli/specify.ts"
      to: "src/cli/generate.ts"
      via: "imports generateCommand for auto-generate when AGENTS.md missing"
      pattern: "generateCommand"
    - from: "src/cli/index.ts"
      to: "src/cli/specify.ts"
      via: "import and route specify command"
      pattern: "specifyCommand"
---

<objective>
Create the CLI command handler for `are specify` that wires together config loading, backend resolution, content collection, AI synthesis, and output writing. Register the command in the CLI entry point.

Purpose: This is the user-facing integration layer. It connects the collector (Plan 01) and prompts/writer (Plan 02) with the existing AI service infrastructure to deliver the full `are specify` experience.
Output: `src/cli/specify.ts` command handler, updated `src/cli/index.ts` with command registration, and complete barrel index.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-specify-command/10-CONTEXT.md
@.planning/phases/10-specify-command/10-RESEARCH.md

@.planning/phases/10-specify-command/10-01-SUMMARY.md
@.planning/phases/10-specify-command/10-02-SUMMARY.md

@src/cli/generate.ts
@src/cli/index.ts
@src/ai/service.ts
@src/config/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create specify command handler</name>
  <files>src/cli/specify.ts, src/specify/index.ts</files>
  <action>
Create `src/cli/specify.ts` following the exact structure of `src/cli/generate.ts`:

1. **SpecifyOptions interface:**
   ```typescript
   interface SpecifyOptions {
     output?: string;       // Custom output path (default: specs/SPEC.md)
     force?: boolean;       // Overwrite existing specs
     dryRun?: boolean;      // Show plan without calling AI
     multiFile?: boolean;   // Split output into multiple files
     debug?: boolean;       // Show verbose debug info
     trace?: boolean;       // Enable tracing
   }
   ```

2. **specifyCommand(targetPath: string, options: SpecifyOptions): Promise<void>** function:

   a. **Resolve paths:**
      - `absolutePath = path.resolve(targetPath)`
      - `outputPath = options.output ? path.resolve(options.output) : path.join(absolutePath, 'specs', 'SPEC.md')`

   b. **Load config** using `loadConfig(absolutePath, { debug: options.debug })`

   c. **Check for AGENTS.md files:**
      - Call `collectSpecInput(absolutePath)`
      - If `input.agentsSections.length === 0`:
        - Print message: "No AGENTS.md files found. Running generate first..."
        - Call `generateCommand(targetPath, { debug: options.debug, trace: options.trace })` (import from `./generate.js`)
        - Re-collect: `input = await collectSpecInput(absolutePath)`
        - If still empty, print error and exit with code 1

   d. **Dry-run mode** (if options.dryRun):
      - Print summary using picocolors:
        ```
        --- Dry Run Summary ---

          AGENTS.md files:   {count}
          .sum files:        {count}
          Total input:       ~{Math.ceil(input.totalChars / 4) / 1000}K tokens
          Output:            {outputPath}
          Mode:              {multiFile ? 'multi-file' : 'single-file'}

        No AI calls made (dry run).
        ```
      - If estimated tokens > 150,000, print yellow warning: "Warning: Input exceeds 150K tokens. Consider using a model with extended context."
      - Return (no AI calls)

   e. **Resolve backend** (same pattern as generate.ts):
      - `const registry = createBackendRegistry()`
      - Try `resolveBackend(registry, config.ai.backend)`
      - Catch AIServiceError with code 'CLI_NOT_FOUND': print error with install instructions, exit 2

   f. **Create AI service:**
      - `new AIService(backend, { timeoutMs: Math.max(config.ai.timeoutMs, 600_000), maxRetries: config.ai.maxRetries, model: config.ai.model, telemetry: { keepRuns: config.ai.telemetry.keepRuns } })`
      - Note: Uses `Math.max(config.ai.timeoutMs, 600_000)` to ensure at least 10 minutes for spec generation (longer than file analysis)
      - If debug, call `aiService.setDebug(true)`

   g. **Build prompt and call AI:**
      - `const prompt = buildSpecPrompt(input)` (import from `../specify/index.js`)
      - If debug, print prompt length info to stderr
      - Print progress: "Generating specification..." with a note about expected duration
      - `const response = await aiService.call({ prompt: prompt.user, systemPrompt: prompt.system, taskLabel: 'specify' })`

   h. **Write output:**
      - Import `writeSpec` and `SpecExistsError` from `../specify/index.js`
      - Try `const writtenFiles = await writeSpec(response.text, { outputPath, force: options.force ?? false, multiFile: options.multiFile ?? false })`
      - Catch `SpecExistsError`: print the error message to stderr and exit with code 1
      - Print success: list written files

   i. **Finalize telemetry:**
      - `await aiService.finalize(absolutePath)`
      - Print summary line: tokens used, duration, output location

3. Export `specifyCommand` and `SpecifyOptions`.

**Update `src/specify/index.ts`** to add re-exports from `./prompts.js` and `./writer.js` (remove the placeholder comments from Plan 01):
   - Re-export `SpecPrompt`, `buildSpecPrompt` from `./prompts.js`
   - Re-export `WriteSpecOptions`, `writeSpec`, `SpecExistsError` from `./writer.js`
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify `src/cli/specify.ts` exports `specifyCommand` and `SpecifyOptions`. Verify `src/specify/index.ts` re-exports all public symbols from all three submodules.
  </verify>
  <done>
specifyCommand() compiles and follows the established CLI command pattern: config loading, backend resolution, AI call, output writing, telemetry finalization. Auto-generate fallback, dry-run, and overwrite protection are all wired.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register specify command in CLI entry point</name>
  <files>src/cli/index.ts</files>
  <action>
Update `src/cli/index.ts`:

1. **Add import** at the top with other command imports:
   ```typescript
   import { specifyCommand, type SpecifyOptions } from './specify.js';
   ```

2. **Add `specify` case** to the switch statement (after the `update` case, before `default`):
   ```typescript
   case 'specify': {
     const specifyOpts: SpecifyOptions = {
       output: values.get('output'),
       force: flags.has('force'),
       dryRun: flags.has('dry-run'),
       multiFile: flags.has('multi-file'),
       debug: flags.has('debug'),
       trace: flags.has('trace'),
     };
     await specifyCommand(positional[0] || '.', specifyOpts);
     break;
   }
   ```

3. **Update USAGE string** to include the specify command:
   - Add `specify [path]  Generate project specification from AGENTS.md docs` in the Commands section
   - Add `--output <path>  Output path for specification (specify only)` in the General Options section
   - Add `--multi-file     Split specification into multiple files (specify only)` in the General Options section
   - Add `--force          Overwrite existing files` (already present for install, but add a note that it also applies to specify)
   - Add example: `are specify --dry-run`
   - Add example: `are specify --output ./docs/spec.md --force`

4. **Verify** the `--force` flag is already parsed by the existing flag parser (it is -- it's in `hasInstallerFlags`). However, `--output` is a value flag that's already handled by the generic value parser. And `--multi-file` is a flag that will be parsed by `flags.add('multi-file')`. Confirm the existing `parseArgs` handles these correctly -- `--output custom/path` will be in `values.get('output')`, `--multi-file` will be in `flags.has('multi-file')`, and `--force` will be in `flags.has('force')`.

No changes needed to `parseArgs()` -- the generic parser already handles `--flag` -> flags Set and `--key value` -> values Map.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Run `node dist/cli/index.js --help` (after building) and verify `specify` appears in the command list. Run `node dist/cli/index.js specify --dry-run` on the project root and verify it shows the dry-run summary.
  </verify>
  <done>
The `specify` command is registered in the CLI, appears in `--help`, and routes correctly to specifyCommand(). All CLI flags (--output, --force, --dry-run, --multi-file, --debug, --trace) are parsed and forwarded.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. `node dist/cli/index.js --help` shows the specify command
4. `node dist/cli/index.js specify --dry-run` shows dry-run output (AGENTS.md count, .sum count, estimated tokens, output path)
5. All existing tests still pass: `npx vitest run`
</verification>

<success_criteria>
- The `are specify` command is fully functional end-to-end
- --dry-run shows accurate input statistics without calling AI
- --force allows overwriting existing specs
- --output and --multi-file flags work correctly
- Auto-generate triggers when no AGENTS.md files exist
- Backend resolution failures produce actionable error messages
- Telemetry is recorded for AI calls
- The command appears in CLI help text
</success_criteria>

<output>
After completion, create `.planning/phases/10-specify-command/10-03-SUMMARY.md`
</output>
