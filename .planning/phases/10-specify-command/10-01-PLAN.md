---
phase: 10-specify-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/specify/collector.ts
  - src/specify/index.ts
  - tests/specify/collector.test.ts
autonomous: true

must_haves:
  truths:
    - "collectSpecInput() recursively walks a project directory and returns all AGENTS.md content and .sum content as structured arrays"
    - "collectSpecInput() skips standard vendor/build directories (node_modules, .git, dist, etc.)"
    - "collectSpecInput() computes totalChars and fileCount for dry-run cost estimation"
    - "collectSpecInput() reads package.json metadata when available (name, version, description, dependencies)"
    - "The barrel index exports all public types and functions from the specify module"
  artifacts:
    - path: "src/specify/collector.ts"
      provides: "Documentation content collection for spec synthesis"
      exports: ["collectSpecInput", "SpecInput"]
    - path: "src/specify/index.ts"
      provides: "Barrel export for specify module"
      exports: ["collectSpecInput", "SpecInput"]
    - path: "tests/specify/collector.test.ts"
      provides: "Unit tests for collector"
  key_links:
    - from: "src/specify/collector.ts"
      to: "src/generation/writers/sum.ts"
      via: "readSumFile() import for .sum parsing"
      pattern: "readSumFile"
    - from: "src/specify/collector.ts"
      to: "src/generation/prompts/builder.ts"
      via: "Follows collectAgentsMdFiles() recursive walk pattern"
      pattern: "SKIP_DIRS"
---

<objective>
Create the content collector for the specify command that recursively gathers all AGENTS.md files, .sum files, and package.json metadata into a structured input object for AI synthesis.

Purpose: The collector is the data-gathering foundation that feeds all downstream spec generation. Without it, the AI has no content to synthesize.
Output: `src/specify/collector.ts` with `collectSpecInput()` function, barrel index, and unit tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-specify-command/10-CONTEXT.md
@.planning/phases/10-specify-command/10-RESEARCH.md

@src/generation/prompts/builder.ts
@src/generation/writers/sum.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create collector module and barrel index</name>
  <files>src/specify/collector.ts, src/specify/index.ts</files>
  <action>
Create `src/specify/collector.ts` with the following:

1. **SpecInput interface** -- the structured result of collection:
   ```typescript
   interface SpecInput {
     agentsSections: Array<{ relativePath: string; content: string }>;
     sumSections: Array<{ relativePath: string; purpose: string; summary: string }>;
     packageJson?: { name?: string; version?: string; description?: string; dependencies?: Record<string, string>; devDependencies?: Record<string, string>; scripts?: Record<string, string> };
     totalChars: number;
     fileCount: number;
   }
   ```

2. **collectSpecInput(projectRoot: string): Promise<SpecInput>** function that:
   - Recursively walks the project directory using `readdir({ withFileTypes: true })`
   - Skips standard directories using a SKIP_DIRS Set identical to the one in `src/generation/prompts/builder.ts` (node_modules, .git, .agents-reverse-engineer, vendor, dist, build, __pycache__, .next, venv, .venv, target, .cargo, .gradle)
   - Collects AGENTS.md files: reads content, stores relativePath + content
   - Collects .sum files: uses `readSumFile()` from `../generation/writers/sum.js` to parse, extracts purpose from metadata and summary text
   - Reads package.json from project root: extracts name, version, description, dependencies, devDependencies, scripts
   - Computes totalChars as sum of all AGENTS.md content lengths + all .sum summary lengths
   - Computes fileCount as count of AGENTS.md files + .sum files collected
   - Sorts agentsSections and sumSections by relativePath for deterministic output
   - Wraps all file reads in try/catch to gracefully skip unreadable files

3. **Export** both `SpecInput` (type) and `collectSpecInput` (function).

Create `src/specify/index.ts` as the barrel export:
   - Re-export `SpecInput` type and `collectSpecInput` from `./collector.js`
   - Add placeholder re-exports for `./prompts.js` and `./writer.js` as comments (to be filled in Plan 02)

Follow the exact coding style of `src/generation/prompts/builder.ts` -- JSDoc on all exports, no default exports, explicit import paths with `.js` extension.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify `src/specify/collector.ts` and `src/specify/index.ts` exist and export the expected symbols.
  </verify>
  <done>
`collectSpecInput()` compiles, accepts a project root path, and returns a typed `SpecInput` with agentsSections, sumSections, packageJson, totalChars, and fileCount.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for collector</name>
  <files>tests/specify/collector.test.ts</files>
  <action>
Create `tests/specify/collector.test.ts` using vitest (matching the project's existing test patterns).

Test cases:
1. **Empty directory** -- collectSpecInput on a temp dir with no AGENTS.md or .sum files returns empty arrays and zero counts
2. **Single AGENTS.md** -- create a temp dir with one AGENTS.md file, verify it appears in agentsSections with correct relativePath and content
3. **Single .sum file** -- create a temp dir with a valid .sum file (YAML frontmatter + summary body), verify it appears in sumSections with purpose and summary extracted
4. **Skips vendor directories** -- create a temp dir with node_modules/AGENTS.md, verify it is NOT collected
5. **Package.json extraction** -- create a temp dir with a package.json containing name, version, description, dependencies, verify packageJson field is populated
6. **No package.json** -- verify packageJson is undefined when file doesn't exist
7. **totalChars and fileCount** -- create a temp dir with 2 AGENTS.md files and 1 .sum file, verify totalChars is the sum of their content lengths and fileCount is 3
8. **Deterministic sort order** -- create AGENTS.md files in nested dirs (b/AGENTS.md, a/AGENTS.md), verify they are sorted alphabetically by relativePath

Use `mkdtemp` and `writeFile` from node:fs/promises to create temp directories. Clean up after each test with `rm -rf`.

For .sum file tests, create files with valid frontmatter format:
```
---
purpose: "Test purpose"
exports: []
content_hash: "abc123"
generated_at: "2026-01-01T00:00:00Z"
---
This is the summary content.
```
  </action>
  <verify>
Run `npx vitest run tests/specify/collector.test.ts` -- all tests pass.
  </verify>
  <done>
All 8 test cases pass. The collector correctly handles empty dirs, single files, vendor dir skipping, package.json parsing, accurate counting, and deterministic sorting.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx vitest run tests/specify/collector.test.ts` -- all tests pass
3. `src/specify/collector.ts` exports `SpecInput` type and `collectSpecInput` function
4. `src/specify/index.ts` re-exports everything from collector
</verification>

<success_criteria>
- collectSpecInput() correctly gathers all AGENTS.md and .sum content from a directory tree
- Vendor/build directories are skipped
- Package.json metadata is extracted when available
- totalChars and fileCount are accurate
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-specify-command/10-01-SUMMARY.md`
</output>
