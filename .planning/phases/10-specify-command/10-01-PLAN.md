---
phase: 10-specify-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/generation/collector.ts
  - src/generation/prompts/builder.ts
autonomous: true

must_haves:
  truths:
    - "collectAgentsDocs() lives in src/generation/collector.ts and recursively walks a project directory returning all AGENTS.md content as Array<{ relativePath, content }>, skipping vendor/build directories"
    - "collectAgentsDocs() is the single source of truth for AGENTS.md collection — used by both buildRootPrompt() and the specify command"
    - "buildRootPrompt() in builder.ts is refactored to import and use collectAgentsDocs() — its private collectAgentsMdFiles() is deleted"
    - "buildRootPrompt() still reads package.json itself (not part of the shared collector)"
  artifacts:
    - path: "src/generation/collector.ts"
      provides: "Shared AGENTS.md collection used across modules"
      exports: ["collectAgentsDocs", "AgentsDocs"]
    - path: "src/generation/prompts/builder.ts"
      provides: "Refactored buildRootPrompt using shared collectAgentsDocs"
  key_links:
    - from: "src/generation/prompts/builder.ts"
      to: "src/generation/collector.ts"
      via: "imports collectAgentsDocs to replace private collectAgentsMdFiles"
      pattern: "collectAgentsDocs"
---

<objective>
Extract the AGENTS.md recursive walk into a shared `collectAgentsDocs()` in `src/generation/collector.ts` and refactor `buildRootPrompt()` to use it.

Purpose: The shared collector becomes the single source of truth for project-wide AGENTS.md discovery, reused by both buildRootPrompt and the specify command (Plan 03).
Output: Shared collector in generation module, refactored builder.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-specify-command/10-CONTEXT.md
@.planning/phases/10-specify-command/10-RESEARCH.md

@src/generation/prompts/builder.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared AGENTS.md collector in generation module</name>
  <files>src/generation/collector.ts</files>
  <action>
Create `src/generation/collector.ts` with:

1. **AgentsDocs type:**
   ```typescript
   type AgentsDocs = Array<{ relativePath: string; content: string }>;
   ```

2. **collectAgentsDocs(projectRoot: string): Promise<AgentsDocs>** function that:
   - Recursively walks the project directory using `readdir({ withFileTypes: true })`
   - Skips standard directories using a SKIP_DIRS Set: node_modules, .git, .agents-reverse-engineer, vendor, dist, build, __pycache__, .next, venv, .venv, target, .cargo, .gradle
   - For each AGENTS.md file found: reads content, stores `{ relativePath: path.relative(projectRoot, filePath), content }`
   - Sorts results by relativePath for deterministic output
   - Wraps readdir/readFile in try/catch to gracefully skip unreadable dirs/files
   - Returns the sorted array

3. **Export** `AgentsDocs` (type) and `collectAgentsDocs`.

Follow the exact coding style of `src/generation/prompts/builder.ts` — JSDoc on exports, no default exports, explicit import paths with `.js` extension.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors.
  </verify>
  <done>
`collectAgentsDocs()` compiles and is exported from `src/generation/collector.ts`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor buildRootPrompt to use shared collector</name>
  <files>src/generation/prompts/builder.ts</files>
  <action>
Refactor `src/generation/prompts/builder.ts`:

1. **Add import** at the top:
   ```typescript
   import { collectAgentsDocs } from '../collector.js';
   ```

2. **Delete** the private `collectAgentsMdFiles()` function (lines 230-257 — the entire function including its JSDoc).

3. **Refactor `buildRootPrompt()`** to use `collectAgentsDocs()`:
   - Replace `const agentsFiles = await collectAgentsMdFiles(projectRoot);` and the subsequent read loop (lines 271-285) with:
     ```typescript
     const agentsDocs = await collectAgentsDocs(projectRoot);
     const agentsSections: string[] = agentsDocs.map(
       (doc) => `### ${doc.relativePath}\n\n${doc.content}`,
     );
     ```
   - The rest of buildRootPrompt stays unchanged: package.json reading, user prompt assembly, logTemplate call.

4. **Verify** that no other code in builder.ts references `collectAgentsMdFiles` — it was private (no export), so only buildRootPrompt used it.

The refactoring is purely mechanical: same behavior, different data source.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Run `npm run build` — build succeeds.
  </verify>
  <done>
buildRootPrompt() now imports and uses collectAgentsDocs() from the shared collector. The private collectAgentsMdFiles() is deleted. Behavior is identical.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. `src/generation/collector.ts` exports `AgentsDocs` and `collectAgentsDocs`
4. `src/generation/prompts/builder.ts` no longer contains `collectAgentsMdFiles` — imports `collectAgentsDocs` instead
5. `buildRootPrompt()` behavior is unchanged (same output for same input)
</verification>

<success_criteria>
- collectAgentsDocs() lives in src/generation/ and is the single AGENTS.md collection mechanism
- buildRootPrompt() refactored to use shared collector — private walk function deleted
- Build succeeds with no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-specify-command/10-01-SUMMARY.md`
</output>
