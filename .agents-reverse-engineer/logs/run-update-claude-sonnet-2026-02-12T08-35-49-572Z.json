{
  "runId": "2026-02-12T08:35:49.572Z",
  "startTime": "2026-02-12T08:35:49.572Z",
  "endTime": "2026-02-12T08:43:13.691Z",
  "backend": "claude",
  "model": "sonnet",
  "command": "update",
  "entries": [
    {
      "timestamp": "2026-02-12T08:35:49.581Z",
      "prompt": "Analyze this source file and generate a summary that captures what an AI coding assistant needs to know to work with this file effectively.\n\nFile: package.json\n\n```json\n{\n  \"name\": \"agents-reverse-engineer\",\n  \"version\": \"0.8.3\",\n  \"description\": \"CLI tool for reverse-engineering codebase documentation for AI agents\",\n  \"type\": \"module\",\n  \"bin\": {\n    \"agents-reverse-engineer\": \"dist/cli/index.js\",\n    \"are\": \"dist/cli/index.js\"\n  },\n  \"scripts\": {\n    \"build\": \"tsc\",\n    \"build:hooks\": \"node scripts/build-hooks.js\",\n    \"prepack\": \"rm -f LICENSE.sum README.md.sum\",\n    \"prepublishOnly\": \"npm run build && npm run build:hooks\",\n    \"dev\": \"tsx watch src/cli/index.ts\"\n  },\n  \"dependencies\": {\n    \"fast-glob\": \"^3.3.3\",\n    \"ignore\": \"^7.0.3\",\n    \"isbinaryfile\": \"^5.0.4\",\n    \"jsonc-parser\": \"^3.3.1\",\n    \"ora\": \"^8.1.1\",\n    \"picocolors\": \"^1.1.1\",\n    \"simple-git\": \"^3.27.0\",\n    \"yaml\": \"^2.7.0\",\n    \"zod\": \"^3.24.1\"\n  },\n  \"devDependencies\": {\n    \"@types/node\": \"^22.10.7\",\n    \"tsx\": \"^4.19.2\",\n    \"typescript\": \"^5.7.3\"\n  },\n  \"engines\": {\n    \"node\": \">=18.0.0\"\n  },\n  \"keywords\": [\n    \"documentation\",\n    \"codebase\",\n    \"ai\",\n    \"agents\",\n    \"reverse-engineering\",\n    \"claude-code\",\n    \"gemini-cli\",\n    \"opencode\",\n    \"agents-md\",\n    \"code-documentation\",\n    \"ai-documentation\",\n    \"codebase-analysis\",\n    \"developer-tools\",\n    \"cli\",\n    \"llm\"\n  ],\n  \"author\": \"GeoloeG-IsT\",\n  \"license\": \"MIT\",\n  \"exports\": {\n    \".\": \"./dist/cli/index.js\",\n    \"./core\": {\n      \"types\": \"./dist/core/index.d.ts\",\n      \"default\": \"./dist/core/index.js\"\n    }\n  },\n  \"main\": \"dist/cli/index.js\",\n  \"files\": [\n    \"dist\",\n    \"hooks/dist\",\n    \"README.md\",\n    \"LICENSE\"\n  ],\n  \"repository\": {\n    \"type\": \"git\",\n    \"url\": \"git+https://github.com/GeoloeG-IsT/agents-reverse-engineer.git\"\n  },\n  \"bugs\": {\n    \"url\": \"https://github.com/GeoloeG-IsT/agents-reverse-engineer/issues\"\n  },\n  \"homepage\": \"https://github.com/GeoloeG-IsT/agents-reverse-engineer#readme\"\n}\n\n```\n\nLead with a single bold purpose statement: **[FileName] does X.**\nThen use ## headings to organize the remaining content.\nEvery file MUST include at minimum:\n- A purpose statement (first line, bold)\n- Exported symbols with signatures (under any appropriate heading)\nChoose additional sections based on file content.\n\n## Existing Summary (update this — preserve stable content, modify only what changed)\n\n**npm package manifest v0.8.2 exposing CLI binaries `agents-reverse-engineer` and `are` targeting `dist/cli/index.js`, dual exports (`./` CLI, `./core` @beta library), Node.js >=18.0.0 ES module package.**\n\n## Binaries\n`agents-reverse-engineer`, `are` → `dist/cli/index.js`\n\n## Scripts\n`build` (tsc), `build:hooks` (node scripts/build-hooks.js), `prepack` (rm -f LICENSE.sum README.md.sum), `prepublishOnly` (build + build:hooks), `dev` (tsx watch src/cli/index.ts)\n\n## Dependencies\nfast-glob@3.3.3, ignore@7.0.3, isbinaryfile@5.0.4, jsonc-parser@3.3.1, ora@8.1.1, picocolors@1.1.1, simple-git@3.27.0, yaml@2.7.0, zod@3.24.1\n\n## Exports\n`./` → dist/cli/index.js, `./core` → dist/core/index.js (types: dist/core/index.d.ts)\n\n## Distribution\nfiles: `dist`, `hooks/dist`, `README.md`, `LICENSE`",
      "systemPrompt": "You are updating an existing file summary for an AI coding assistant. The source code has changed and the summary needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING summary and the UPDATED source code\n- Preserve the structure, section headings, and phrasing of the existing summary wherever the underlying code is unchanged\n- Only modify content that is directly affected by the code changes\n- If a section describes code that has not changed, keep it VERBATIM — do not rephrase, reorganize, or \"improve\" stable text\n- Add new sections only if the code changes introduce entirely new concepts\n- Remove sections only if the code they described has been deleted\n- Update signatures, type names, and identifiers to match the current source exactly\n\nBEHAVIORAL CONTRACT PRESERVATION (MANDATORY):\n- Regex patterns, format strings, magic constants, and template content from the existing summary MUST be preserved verbatim unless the source code changed them\n- If source code changes a regex pattern or constant, update the summary to show the NEW value verbatim\n- Never summarize or paraphrase regex patterns — always show the exact pattern in backticks\n\nWORKFLOW & CONVENTION RULE PRESERVATION (MANDATORY):\n- Contribution guidelines, testing mandates, PR conventions, code conventions, and AI agent instructions from the existing summary MUST be preserved verbatim unless the source file changed them\n\n\nTARGET LENGTH (MANDATORY):\n- Source file: 1820 characters\n- Target summary: ~455 characters (25% compression)\n- Maximum: 546 characters\n- Achieve this by: ultra-dense writing, minimal examples, single-sentence descriptions\n\nULTRA-COMPRESSION TECHNIQUES:\n- Use telegraphic style: \"exports foo, bar, baz\" not \"this file exports three functions\"\n- No code examples unless critical to understanding\n- One sentence per export maximum\n- Omit obvious parameter names (\"opts: Options\" not \"options: Options - configuration object\")\n- Use abbreviations: \"params\" not \"parameters\", \"config\" not \"configuration\"\n- Skip section if empty (don't write \"No special concerns\" or \"N/A\")\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this file\", \"this module\", \"provides\", \"responsible for\", \"is used to\", \"basically\", \"essentially\", \"provides functionality for\"\n- Use the pattern: \"[ExportName] does X\" not \"The ExportName function is responsible for doing X\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- All exported function/class/type/const names MUST appear in the summary exactly as written in source\n- Key parameter types and return types MUST be mentioned\n- Preserve exact casing of identifiers\n- Missing any exported identifier is a failure\n\nOUTPUT FORMAT (MANDATORY):\n- Start your response DIRECTLY with the purpose statement — a single bold line: **Purpose statement here.**\n- Do NOT include any preamble, thinking, or meta-commentary before the purpose statement\n- Do NOT say \"Here is...\", \"Now I'll...\", \"Based on my analysis...\", \"Let me create...\", \"Perfect.\"\n- Your response IS the documentation — not a message about the documentation",
      "response": "**npm package manifest v0.8.3 exposing CLI binaries `agents-reverse-engineer` and `are` targeting `dist/cli/index.js`, dual exports (`./` CLI, `./core` @beta library), Node.js >=18.0.0 ES module package.**\n\n## Binaries\n`agents-reverse-engineer`, `are` → `dist/cli/index.js`\n\n## Scripts\n`build` (tsc), `build:hooks` (node scripts/build-hooks.js), `prepack` (rm -f LICENSE.sum README.md.sum), `prepublishOnly` (build + build:hooks), `dev` (tsx watch src/cli/index.ts)\n\n## Dependencies\nfast-glob@3.3.3, ignore@7.0.3, isbinaryfile@5.0.4, jsonc-parser@3.3.1, ora@8.1.1, picocolors@1.1.1, simple-git@3.27.0, yaml@2.7.0, zod@3.24.1\n\n## Exports\n`./` → dist/cli/index.js, `./core` → dist/core/index.js (types: dist/core/index.d.ts)\n\n## Distribution\nfiles: `dist`, `hooks/dist`, `README.md`, `LICENSE`",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 318,
      "cacheReadTokens": 0,
      "cacheCreationTokens": 24726,
      "latencyMs": 12773,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": [
        {
          "path": "package.json",
          "sizeBytes": 1820
        }
      ]
    },
    {
      "timestamp": "2026-02-12T08:35:49.576Z",
      "prompt": "Analyze this source file and generate a summary that captures what an AI coding assistant needs to know to work with this file effectively.\n\nFile: README.md\n\n```markdown\n<div align=\"center\">\n\n# AGENTS REVERSE ENGINEER (ARE)\n\n**Reverse engineer your codebase into AI-friendly documentation.**\n\n**Generate `.sum` files and `AGENTS.md` for Claude Code, OpenCode, and any AI assistant that supports `AGENTS.md`.**\n\n[![npm version](https://img.shields.io/npm/v/agents-reverse-engineer?style=for-the-badge&logo=npm&logoColor=white&color=CB3837)](https://www.npmjs.com/package/agents-reverse-engineer)\n[![npm downloads](https://img.shields.io/npm/dw/agents-reverse-engineer?style=for-the-badge&logo=npm&logoColor=white&color=CB3837)](https://www.npmjs.com/package/agents-reverse-engineer)\n[![GitHub stars](https://img.shields.io/github/stars/GeoloeG-IsT/agents-reverse-engineer?style=for-the-badge&logo=github&color=181717)](https://github.com/GeoloeG-IsT/agents-reverse-engineer)\n[![Last commit](https://img.shields.io/github/last-commit/GeoloeG-IsT/agents-reverse-engineer?style=for-the-badge&logo=github&color=181717)](https://github.com/GeoloeG-IsT/agents-reverse-engineer/commits)\n[![License](https://img.shields.io/badge/license-MIT-blue?style=for-the-badge)](LICENSE)\n\n<br>\n\n```bash\nnpx agents-reverse-engineer@latest\n```\n\n**Interactive installer with runtime and location selection.**\n\n**Works on Mac, Windows, and Linux.**\n\n<br>\n\n_\"Finally, my AI assistant actually understands my codebase structure.\"_\n\n_\"No more explaining the same architecture in every conversation.\"_\n\n<br>\n\n[Why This Exists](#why-this-exists) · [How It Works](#how-it-works) · [Commands](#commands) · [Generated Docs](#generated-documentation)\n\n<br>\n\n### Works with\n\n[<img src=\"https://img.shields.io/badge/Claude_Code-F97316?style=for-the-badge&logo=anthropic&logoColor=white\" alt=\"Claude Code\">](https://claude.ai/claude-code)\n[<img src=\"https://img.shields.io/badge/Gemini_CLI-4285F4?style=for-the-badge&logo=google&logoColor=white\" alt=\"Gemini CLI\">](https://github.com/google-gemini/gemini-cli)\n[<img src=\"https://img.shields.io/badge/OpenCode-000000?style=for-the-badge&logo=github&logoColor=white\" alt=\"OpenCode\">](https://github.com/anomalyco/opencode)\n[<img src=\"https://img.shields.io/badge/Any_AGENTS.md_tool-6B7280?style=for-the-badge\" alt=\"Any AGENTS.md tool\">](#)\n\n</div>\n\n---\n\n## Why This Exists\n\nAI coding assistants are powerful, but they don't know your codebase. Every session starts fresh. You explain the same architecture, the same patterns, the same file locations — over and over.\n\n**agents-reverse-engineer** fixes that. It generates documentation that AI assistants actually read:\n\n- **`.sum` files** — Per-file summaries with purpose, exports, dependencies\n- **`AGENTS.md`** — Per-directory overviews with file organization (standard format)\n- **`CLAUDE.md`** / **`GEMINI.md`** / **`OPENCODE.md`** — Runtime-specific project entry points\n\nThe result: Your AI assistant understands your codebase from the first message.\n\n---\n\n## Who This Is For\n\nDevelopers using AI coding assistants (Claude Code, OpenCode, Gemini CLI, or any tool supporting `AGENTS.md`) who want their assistant to actually understand their project structure — without manually writing documentation or repeating context every session.\n\n---\n\n## Getting Started\n\n### 1. Install Commands\n\n```bash\nnpx agents-reverse-engineer@latest\n```\n\nThe interactive installer prompts you to:\n\n1. **Select runtime** — Claude Code, OpenCode, Gemini CLI, or all\n2. **Select location** — Global (`~/.claude/`) or local (`./.claude/`)\n\nThis installs:\n\n- **Commands** — `/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`\n\n### 2. Initialize Configuration\n\nAfter installation, create the configuration file in your AI assistant:\n\n```bash\n/are-init\n```\n\nThis creates `.agents-reverse-engineer/config.yaml` with default settings.\n\n### 3. Generate Documentation\n\nIn your AI assistant:\n\n```\n/are-discover\n/are-generate\n```\n\nThe assistant creates the plan and generates all documentation.\n\n### Non-Interactive Installation\n\n```bash\n# Install for Claude Code globally\nnpx agents-reverse-engineer@latest --runtime claude -g\n\n# Install for all runtimes locally\nnpx agents-reverse-engineer@latest --runtime all -l\n```\n\n### Uninstall\n\n```bash\nnpx agents-reverse-engineer@latest uninstall\n```\n\nRemoves:\n- Command files (`/are-*` commands)\n- ARE permissions from settings.json\n- `.agents-reverse-engineer` folder (local installs only)\n\nUse `--runtime` and `-g`/`-l` flags for specific targets.\n\n### Checking Version\n\n```bash\nnpx agents-reverse-engineer@latest --version\n```\n\n---\n\n## How It Works\n\n### 1. Install Commands\n\n```bash\nnpx agents-reverse-engineer@latest\n```\n\nInteractive installer installs commands and hooks for your chosen runtime(s).\n\n**Runtimes:** Claude Code, OpenCode, Gemini CLI (or all at once)\n\n---\n\n### 2. Initialize Configuration\n\n```\n/are-init\n```\n\nCreates `.agents-reverse-engineer/config.yaml` with exclusion patterns and options.\n\n---\n\n### 3. Discover & Plan\n\n```\n/are-discover\n```\n\nScans your codebase (respecting `.gitignore`), detects file types, and creates `GENERATION-PLAN.md` with all files to analyze.\n\nUses **post-order traversal** — deepest directories first, so child documentation exists before parent directories are documented.\n\n---\n\n### 4. Generate (in your AI assistant)\n\n```\n/are-generate\n```\n\nYour AI assistant executes the plan:\n\n1. **File Analysis** — Creates `.sum` file for each source file\n2. **Directory Docs** — Creates `AGENTS.md` and `CLAUDE.md` pointer for each directory\n\n---\n\n### 5. Update Incrementally\n\n```\n/are-update\n```\n\nOnly regenerates documentation for files that changed since last run.\n\n---\n\n### 6. Generate Specification\n\n```\n/are-specify\n```\n\nSynthesizes all AGENTS.md documentation into a single project specification document (`specs/SPEC.md`). Use `--multi-file` to split into separate files, or `--dry-run` to preview without calling the AI.\n\n---\n\n## Commands\n\n| Command                         | Description                      |\n| ------------------------------- | -------------------------------- |\n| `are`                           | Interactive installer (default)  |\n| `are install`                   | Install with prompts             |\n| `are install --runtime <rt> -g` | Install to runtime globally      |\n| `are install --runtime <rt> -l` | Install to runtime locally       |\n| `are install -u`                | Uninstall (remove files/hooks)   |\n| `are init`                      | Create configuration file        |\n| `are discover`                  | Scan files and create GENERATION-PLAN.md |\n| `are generate`                  | Generate all documentation       |\n| `are update`                    | Update changed files only        |\n| `are specify`                   | Generate project specification   |\n| `are clean`                     | Remove all generated docs        |\n\n**Runtimes:** `claude`, `opencode`, `gemini`, `all`\n\n### AI Assistant Commands\n\n| Command         | Description                    | Supported Runtimes       |\n| --------------- | ------------------------------ | ------------------------ |\n| `/are-init`     | Initialize config and commands | Claude, OpenCode, Gemini |\n| `/are-discover` | Rediscover and regenerate plan | Claude, OpenCode, Gemini |\n| `/are-generate` | Generate all documentation     | Claude, OpenCode, Gemini |\n| `/are-update`   | Update changed files only      | Claude, OpenCode, Gemini |\n| `/are-specify`  | Generate project specification | Claude, OpenCode, Gemini |\n| `/are-clean`    | Remove all generated docs      | Claude, OpenCode, Gemini |\n\n---\n\n## Generated Documentation\n\n### `.sum` Files (Per File)\n\n```yaml\n---\nfile_type: service\ngenerated_at: 2026-01-30T12:00:00Z\n---\n\n## Purpose\nHandles user authentication via JWT tokens.\n\n## Public Interface\n- `authenticate(token: string): User`\n- `generateToken(user: User): string`\n\n## Dependencies\n- jsonwebtoken: Token signing/verification\n- ./user-repository: User data access\n\n## Implementation Notes\nTokens expire after 24 hours. Refresh handled by client.\n```\n\n### `AGENTS.md` (Per Directory)\n\nDirectory overview with:\n\n- Description of the directory's role\n- Files grouped by purpose (Types, Services, Utils, etc.)\n- Subdirectories with brief descriptions\n\n### Pointer Files\n\n- **`CLAUDE.md`** — Imports `AGENTS.md` for Claude Code (auto-loaded per directory)\n\n### Root Overview\n\n- **`AGENTS.md`** — Root directory overview (universal format)\n\n---\n\n## Configuration\n\nEdit `.agents-reverse-engineer/config.yaml`:\n\n```yaml\n# File and directory exclusions\nexclude:\n  patterns: []              # Custom glob patterns (e.g., [\"*.log\", \"temp/**\"])\n  vendorDirs:               # Directories to skip\n    - node_modules\n    - dist\n    - .git\n  binaryExtensions:         # File types to skip\n    - .png\n    - .jpg\n    - .pdf\n\n# Discovery options\noptions:\n  followSymlinks: false     # Follow symbolic links during traversal\n  maxFileSize: 1048576      # Max file size in bytes (1MB default)\n\n# Output formatting\noutput:\n  colors: true              # Use colors in terminal output\n\n# AI service configuration\nai:\n  backend: auto             # Backend: 'claude', 'gemini', 'opencode', 'auto'\n  model: sonnet             # Model identifier (backend-specific)\n  timeoutMs: 300000         # Subprocess timeout in ms (5 minutes)\n  maxRetries: 3             # Max retries for transient errors\n  concurrency: 10           # Parallel AI calls (1-20, auto-detected from CPU/RAM)\n\n  telemetry:\n    keepRuns: 50            # Number of run logs to keep\n```\n\n### Key Config Options\n\n**Concurrency (`ai.concurrency`)**\n- Default: Auto-detected from CPU cores and available memory\n- Range: `1-20`\n- Lower values recommended for resource-constrained environments\n- Higher values speed up generation but use more memory\n\n**Timeout (`ai.timeoutMs`)**\n- Default: `300000` (5 minutes)\n- AI subprocess timeout for each file analysis\n- Increase for very large files or slow connections\n\n---\n\n## Requirements\n\n- **Node.js 18+**\n- **AI Coding Assistant** — One of:\n  - [Claude Code](https://claude.ai/claude-code) (full support)\n  - [Gemini CLI](https://github.com/google-gemini/gemini-cli) (full support)\n  - [OpenCode](https://github.com/opencode-ai/opencode) (AGENTS.md supported)\n  - Any assistant supporting `AGENTS.md` format\n\n---\n\n## Contributing\n\nContributions are welcome! Whether it's bug reports, feature requests, or pull requests — all input is valued.\n\nSee [CONTRIBUTING.md](CONTRIBUTING.md) for development setup and guidelines.\n\n---\n\n## License\n\nMIT\n\n```\n\nLead with a single bold purpose statement: **[FileName] does X.**\nThen use ## headings to organize the remaining content.\nEvery file MUST include at minimum:\n- A purpose statement (first line, bold)\n- Exported symbols with signatures (under any appropriate heading)\nChoose additional sections based on file content.\n\n## Existing Summary (update this — preserve stable content, modify only what changed)\n\n**README.md serves as project entry point documenting installation workflows, command interfaces, generated artifact formats, configuration schema, and runtime support matrix for AI-assisted codebase documentation generation.**\n\n## Installation Workflows\n\nInteractive installer via `npx agents-reverse-engineer@latest` prompts for runtime selection (Claude Code, OpenCode, Gemini CLI, all) and location (global `~/.claude/` or local `./.claude/`), installs slash commands (`/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`, `/are-help`) and session hooks (auto-updates on session end for Claude/Gemini). Non-interactive flags: `--runtime <rt>` with `-g` (global) or `-l` (local). Uninstall via `npx agents-reverse-engineer@latest uninstall` removes command files, session hooks, ARE permissions from settings.json, and `.agents-reverse-engineer` folder (local only). Version check via `--version` flag.\n\n## Generated Artifacts\n\n`.sum` files contain YAML frontmatter (`file_type`, `generated_at`) plus markdown sections (Purpose, Public Interface, Dependencies, Implementation Notes). `AGENTS.md` per-directory overviews list files grouped by purpose (Types, Services, Utils) and subdirectories with descriptions. Pointer files `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` import `AGENTS.md` for runtime-specific auto-loading. Root `AGENTS.md` provides universal project overview.\n\n## Command Interface\n\nCLI commands: `are` (interactive installer default), `are install` (with optional `--runtime <rt> -g|-l`), `are install -u` (uninstall), `are init` (create config), `are discover` (scan files, create GENERATION-PLAN.md), `are generate` (generate all docs), `are update` (incremental regeneration for changed files), `are specify` (synthesize AGENTS.md into `specs/SPEC.md` with optional `--multi-file` or `--dry-run`), `are clean` (remove generated docs), `are rebuild` (AI-driven reconstruction from specs). Runtime values: `claude`, `opencode`, `gemini`, `all`. AI assistant slash commands mirror CLI functionality plus `/are-help` for command listing.\n\n## Configuration Schema\n\n`.agents-reverse-engineer/config.yaml` defines `exclude.patterns` (custom globs), `exclude.vendorDirs` (node_modules, dist, .git), `exclude.binaryExtensions` (.png, .jpg, .pdf), `options.followSymlinks` (default false), `options.maxFileSize` (1048576 bytes), `output.colors` (default true), `ai.backend` (auto|claude|gemini|opencode), `ai.model` (sonnet), `ai.timeoutMs` (300000), `ai.maxRetries` (3), `ai.concurrency` (1-20, auto-detected from CPU/RAM), `ai.telemetry.keepRuns` (50).\n\n## Workflow Algorithm\n\nPost-order traversal: `/are-discover` scans codebase respecting `.gitignore`, detects file types, creates GENERATION-PLAN.md with deepest directories first ensuring child documentation exists before parent aggregation. `/are-generate` executes two-phase pipeline: file analysis (creates `.sum` per source file), directory docs (creates `AGENTS.md` and pointer files per directory). `/are-update` regenerates only changed files via content hash comparison. `/are-rebuild` reconstructs codebase from `specs/*.md` using checkpoint-based phase execution with delimiter format `===FILE: path===` / `===END_FILE===`.\n\n## Runtime Support Matrix\n\nClaude Code: full support including slash commands and session hooks. Gemini CLI: full support including slash commands and session hooks. OpenCode: AGENTS.md format supported, slash commands available. Any tool supporting `AGENTS.md` format: universal directory overviews usable.\n\n## Requirements\n\nNode.js >=18.0.0, AI coding assistant (Claude Code, Gemini CLI, OpenCode, or any AGENTS.md-compatible tool). MIT License (GeoloeG-IsT, 2026). Contributing guidelines in CONTRIBUTING.md.",
      "systemPrompt": "You are updating an existing file summary for an AI coding assistant. The source code has changed and the summary needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING summary and the UPDATED source code\n- Preserve the structure, section headings, and phrasing of the existing summary wherever the underlying code is unchanged\n- Only modify content that is directly affected by the code changes\n- If a section describes code that has not changed, keep it VERBATIM — do not rephrase, reorganize, or \"improve\" stable text\n- Add new sections only if the code changes introduce entirely new concepts\n- Remove sections only if the code they described has been deleted\n- Update signatures, type names, and identifiers to match the current source exactly\n\nBEHAVIORAL CONTRACT PRESERVATION (MANDATORY):\n- Regex patterns, format strings, magic constants, and template content from the existing summary MUST be preserved verbatim unless the source code changed them\n- If source code changes a regex pattern or constant, update the summary to show the NEW value verbatim\n- Never summarize or paraphrase regex patterns — always show the exact pattern in backticks\n\nWORKFLOW & CONVENTION RULE PRESERVATION (MANDATORY):\n- Contribution guidelines, testing mandates, PR conventions, code conventions, and AI agent instructions from the existing summary MUST be preserved verbatim unless the source file changed them\n\n\nTARGET LENGTH (MANDATORY):\n- Source file: 10431 characters\n- Target summary: ~2608 characters (25% compression)\n- Maximum: 3130 characters\n- Achieve this by: ultra-dense writing, minimal examples, single-sentence descriptions\n\nULTRA-COMPRESSION TECHNIQUES:\n- Use telegraphic style: \"exports foo, bar, baz\" not \"this file exports three functions\"\n- No code examples unless critical to understanding\n- One sentence per export maximum\n- Omit obvious parameter names (\"opts: Options\" not \"options: Options - configuration object\")\n- Use abbreviations: \"params\" not \"parameters\", \"config\" not \"configuration\"\n- Skip section if empty (don't write \"No special concerns\" or \"N/A\")\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this file\", \"this module\", \"provides\", \"responsible for\", \"is used to\", \"basically\", \"essentially\", \"provides functionality for\"\n- Use the pattern: \"[ExportName] does X\" not \"The ExportName function is responsible for doing X\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- All exported function/class/type/const names MUST appear in the summary exactly as written in source\n- Key parameter types and return types MUST be mentioned\n- Preserve exact casing of identifiers\n- Missing any exported identifier is a failure\n\nOUTPUT FORMAT (MANDATORY):\n- Start your response DIRECTLY with the purpose statement — a single bold line: **Purpose statement here.**\n- Do NOT include any preamble, thinking, or meta-commentary before the purpose statement\n- Do NOT say \"Here is...\", \"Now I'll...\", \"Based on my analysis...\", \"Let me create...\", \"Perfect.\"\n- Your response IS the documentation — not a message about the documentation",
      "response": "**README.md serves as project entry point documenting installation workflows, command interfaces, generated artifact formats, configuration schema, and runtime support matrix for AI-assisted codebase documentation generation.**\n\n## Installation Workflows\n\nInteractive installer via `npx agents-reverse-engineer@latest` prompts for runtime selection (Claude Code, OpenCode, Gemini CLI, all) and location (global `~/.claude/` or local `./.claude/`), installs slash commands (`/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`) and session hooks (auto-updates on session end for Claude/Gemini). Non-interactive flags: `--runtime <rt>` with `-g` (global) or `-l` (local). Uninstall via `npx agents-reverse-engineer@latest uninstall` removes command files, session hooks, ARE permissions from settings.json, and `.agents-reverse-engineer` folder (local only). Version check via `--version` flag.\n\n## Generated Artifacts\n\n`.sum` files contain YAML frontmatter (`file_type`, `generated_at`) plus markdown sections (Purpose, Public Interface, Dependencies, Implementation Notes). `AGENTS.md` per-directory overviews list files grouped by purpose (Types, Services, Utils) and subdirectories with descriptions. Pointer files `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` import `AGENTS.md` for runtime-specific auto-loading. Root `AGENTS.md` provides universal project overview.\n\n## Command Interface\n\nCLI commands: `are` (interactive installer default), `are install` (with optional `--runtime <rt> -g|-l`), `are install -u` (uninstall), `are init` (create config), `are discover` (scan files, create GENERATION-PLAN.md), `are generate` (generate all docs), `are update` (incremental regeneration for changed files), `are specify` (synthesize AGENTS.md into `specs/SPEC.md` with optional `--multi-file` or `--dry-run`), `are clean` (remove generated docs). Runtime values: `claude`, `opencode`, `gemini`, `all`. AI assistant slash commands mirror CLI functionality.\n\n## Configuration Schema\n\n`.agents-reverse-engineer/config.yaml` defines `exclude.patterns` (custom globs), `exclude.vendorDirs` (node_modules, dist, .git), `exclude.binaryExtensions` (.png, .jpg, .pdf), `options.followSymlinks` (default false), `options.maxFileSize` (1048576 bytes), `output.colors` (default true), `ai.backend` (auto|claude|gemini|opencode), `ai.model` (sonnet), `ai.timeoutMs` (300000), `ai.maxRetries` (3), `ai.concurrency` (1-20, auto-detected from CPU/RAM), `ai.telemetry.keepRuns` (50).\n\n## Workflow Algorithm\n\nPost-order traversal: `/are-discover` scans codebase respecting `.gitignore`, detects file types, creates GENERATION-PLAN.md with deepest directories first ensuring child documentation exists before parent aggregation. `/are-generate` executes two-phase pipeline: file analysis (creates `.sum` per source file), directory docs (creates `AGENTS.md` and pointer files per directory). `/are-update` regenerates only changed files via content hash comparison.\n\n## Runtime Support Matrix\n\nClaude Code: full support including slash commands and session hooks. Gemini CLI: full support including slash commands and session hooks. OpenCode: AGENTS.md format supported, slash commands available. Any tool supporting `AGENTS.md` format: universal directory overviews usable.\n\n## Requirements\n\nNode.js >=18.0.0, AI coding assistant (Claude Code, Gemini CLI, OpenCode, or any AGENTS.md-compatible tool). MIT License (GeoloeG-IsT, 2026). Contributing guidelines in CONTRIBUTING.md.",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 928,
      "cacheReadTokens": 0,
      "cacheCreationTokens": 27590,
      "latencyMs": 18395,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": [
        {
          "path": "README.md",
          "sizeBytes": 10464
        }
      ]
    },
    {
      "timestamp": "2026-02-12T08:35:49.584Z",
      "prompt": "Analyze this source file and generate a summary that captures what an AI coding assistant needs to know to work with this file effectively.\n\nFile: src/installer/operations.ts\n\n```typescript\n/**\n * File operations for installer module\n *\n * Handles copying command/hook files to runtime directories,\n * verifying installations, and registering hooks in settings.json.\n */\n\nimport { existsSync, mkdirSync, writeFileSync, readFileSync } from 'node:fs';\nimport * as path from 'node:path';\nimport { fileURLToPath } from 'node:url';\nimport { parse, modify, applyEdits } from 'jsonc-parser';\nimport type { Runtime, Location, InstallerResult } from './types.js';\nimport { resolveInstallPath, getAllRuntimes } from './paths.js';\nimport {\n  getClaudeTemplates,\n  getOpenCodeTemplates,\n  getGeminiTemplates,\n} from '../integration/templates.js';\n\n/**\n * Options for install operations\n */\nexport interface InstallOptions {\n  /** Overwrite existing files */\n  force: boolean;\n  /** Preview mode - don't write files */\n  dryRun: boolean;\n}\n\n/**\n * Ensure directory exists for a file path\n *\n * @param filePath - Full path to the file\n */\nfunction ensureDir(filePath: string): void {\n  const dir = path.dirname(filePath);\n  if (!existsSync(dir)) {\n    mkdirSync(dir, { recursive: true });\n  }\n}\n\n/**\n * Get the path to a bundled hook file\n *\n * Hooks are bundled in hooks/dist/ during npm prepublishOnly.\n *\n * @param hookName - Name of the hook file (e.g., 'are-session-end.js')\n * @returns Absolute path to the bundled hook file\n */\nfunction getBundledHookPath(hookName: string): string {\n  // Navigate from dist/installer/operations.js to hooks/dist/\n  const __filename = fileURLToPath(import.meta.url);\n  const __dirname = path.dirname(__filename);\n  // From dist/installer/ go up two levels to project root, then to hooks/dist/\n  return path.join(__dirname, '..', '..', 'hooks', 'dist', hookName);\n}\n\n/**\n * Read bundled hook content\n *\n * @param hookName - Name of the hook file\n * @returns Hook file content as string\n * @throws Error if hook file not found\n */\nfunction readBundledHook(hookName: string): string {\n  const hookPath = getBundledHookPath(hookName);\n  if (!existsSync(hookPath)) {\n    throw new Error(`Bundled hook not found: ${hookPath}`);\n  }\n  return readFileSync(hookPath, 'utf-8');\n}\n\n/**\n * Get templates for a specific runtime\n *\n * @param runtime - Target runtime (claude, opencode, or gemini)\n * @returns Array of template objects for the runtime\n */\nfunction getTemplatesForRuntime(runtime: Exclude<Runtime, 'all'>) {\n  switch (runtime) {\n    case 'claude':\n      return getClaudeTemplates();\n    case 'opencode':\n      return getOpenCodeTemplates();\n    case 'gemini':\n      return getGeminiTemplates();\n  }\n}\n\n/**\n * Install files for one or all runtimes\n *\n * If runtime is 'all', installs to all supported runtimes.\n * Otherwise, installs to the specified runtime only.\n *\n * @param runtime - Target runtime or 'all'\n * @param location - Installation location (global or local)\n * @param options - Install options (force, dryRun)\n * @returns Array of installation results (one per runtime)\n */\nexport function installFiles(\n  runtime: Runtime,\n  location: Location,\n  options: InstallOptions,\n): InstallerResult[] {\n  if (runtime === 'all') {\n    return getAllRuntimes().map((r) => installFilesForRuntime(r, location, options));\n  }\n  return [installFilesForRuntime(runtime, location, options)];\n}\n\n/**\n * Install files for a specific runtime\n *\n * Copies command templates and hook files to the installation directory.\n * Skips existing files unless force=true.\n *\n * @param runtime - Target runtime (claude, opencode, or gemini)\n * @param location - Installation location (global or local)\n * @param options - Install options (force, dryRun)\n * @returns Installation result with files created/skipped\n */\nfunction installFilesForRuntime(\n  runtime: Exclude<Runtime, 'all'>,\n  location: Location,\n  options: InstallOptions,\n): InstallerResult {\n  const basePath = resolveInstallPath(runtime, location);\n  const templates = getTemplatesForRuntime(runtime);\n  const filesCreated: string[] = [];\n  const filesSkipped: string[] = [];\n  const errors: string[] = [];\n\n  // Install command templates\n  for (const template of templates) {\n    // Template path is relative (e.g., .claude/commands/are/generate.md)\n    // Extract the part after the runtime directory (e.g., commands/are/generate.md)\n    const relativePath = template.path.split('/').slice(1).join('/');\n    const fullPath = path.join(basePath, relativePath);\n\n    if (existsSync(fullPath) && !options.force) {\n      filesSkipped.push(fullPath);\n    } else {\n      if (!options.dryRun) {\n        try {\n          ensureDir(fullPath);\n          writeFileSync(fullPath, template.content, 'utf-8');\n        } catch (err) {\n          errors.push(`Failed to write ${fullPath}: ${err}`);\n          continue;\n        }\n      }\n      filesCreated.push(fullPath);\n    }\n  }\n\n  // Install hooks/plugins based on runtime\n  let hookRegistered = false;\n  if (runtime === 'claude' || runtime === 'gemini') {\n    // Claude and Gemini: install session hooks\n    for (const hookDef of ARE_HOOKS) {\n      const hookPath = path.join(basePath, 'hooks', hookDef.filename);\n      if (existsSync(hookPath) && !options.force) {\n        filesSkipped.push(hookPath);\n      } else {\n        if (!options.dryRun) {\n          try {\n            ensureDir(hookPath);\n            const hookContent = readBundledHook(hookDef.filename);\n            writeFileSync(hookPath, hookContent, 'utf-8');\n          } catch (err) {\n            errors.push(`Failed to write hook ${hookPath}: ${err}`);\n          }\n        }\n        if (!errors.some((e) => e.includes(hookPath))) {\n          filesCreated.push(hookPath);\n        }\n      }\n    }\n\n    // Register hooks in settings.json\n    hookRegistered = registerHooks(basePath, runtime, options.dryRun);\n\n    // Register permissions for Claude (reduces friction for users)\n    if (runtime === 'claude') {\n      const settingsPath = path.join(basePath, 'settings.json');\n      registerPermissions(settingsPath, options.dryRun);\n    }\n  } else if (runtime === 'opencode') {\n    // OpenCode: install plugins (auto-loaded from plugins/ directory)\n    for (const pluginDef of ARE_PLUGINS) {\n      const pluginPath = path.join(basePath, 'plugins', pluginDef.destFilename);\n      if (existsSync(pluginPath) && !options.force) {\n        filesSkipped.push(pluginPath);\n      } else {\n        if (!options.dryRun) {\n          try {\n            ensureDir(pluginPath);\n            const pluginContent = readBundledHook(pluginDef.srcFilename);\n            writeFileSync(pluginPath, pluginContent, 'utf-8');\n          } catch (err) {\n            errors.push(`Failed to write plugin ${pluginPath}: ${err}`);\n          }\n        }\n        if (!errors.some((e) => e.includes(pluginPath))) {\n          filesCreated.push(pluginPath);\n          hookRegistered = true;\n        }\n      }\n    }\n  }\n\n  // Write VERSION file if files were created and not dry run\n  let versionWritten = false;\n  if (filesCreated.length > 0 && !options.dryRun) {\n    try {\n      writeVersionFile(basePath, options.dryRun);\n      versionWritten = true;\n    } catch {\n      // Non-fatal, don't add to errors\n    }\n  }\n\n  return {\n    success: errors.length === 0,\n    runtime,\n    location,\n    filesCreated,\n    filesSkipped,\n    errors,\n    hookRegistered,\n    versionWritten,\n  };\n}\n\n/**\n * Verify that installed files exist\n *\n * @param files - Array of file paths to verify\n * @returns Object with success status and list of missing files\n */\nexport function verifyInstallation(files: string[]): { success: boolean; missing: string[] } {\n  const missing = files.filter((f) => !existsSync(f));\n  return {\n    success: missing.length === 0,\n    missing,\n  };\n}\n\n/**\n * Session hook configuration for settings.json\n */\ninterface SessionHook {\n  type: 'command';\n  command: string;\n}\n\ninterface HookEvent {\n  hooks: SessionHook[];\n}\n\ninterface SettingsJson {\n  hooks?: {\n    SessionStart?: HookEvent[];\n    SessionEnd?: HookEvent[];\n  };\n  permissions?: {\n    allow?: string[];\n    deny?: string[];\n  };\n  [key: string]: unknown;\n}\n\n/**\n * Gemini hook configuration (simpler format)\n */\ninterface GeminiHook {\n  name: string;\n  type: 'command';\n  command: string;\n}\n\ninterface GeminiSettingsJson {\n  hooks?: {\n    SessionStart?: GeminiHook[];\n    SessionEnd?: GeminiHook[];\n  };\n  [key: string]: unknown;\n}\n\n/**\n * Hook definitions for ARE (Claude and Gemini)\n */\ninterface HookDefinition {\n  event: 'SessionStart' | 'SessionEnd';\n  filename: string;\n  name: string; // For Gemini format\n}\n\nconst ARE_HOOKS: HookDefinition[] = [\n  // { event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' },\n  // { event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }, // Disabled - causing issues\n];\n\n/**\n * Plugin definitions for ARE (OpenCode)\n *\n * OpenCode uses a plugin system (.opencode/plugins/) instead of hooks.\n * Plugins are JS/TS modules that export async functions returning event handlers.\n */\ninterface PluginDefinition {\n  /** Source filename in hooks/dist/ (prefixed with opencode-) */\n  srcFilename: string;\n  /** Destination filename in .opencode/plugins/ */\n  destFilename: string;\n}\n\nconst ARE_PLUGINS: PluginDefinition[] = [\n  // Disabled - causing issues in OpenCode\n  // { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' },\n];\n\n/**\n * Register ARE hooks in settings.json\n *\n * Registers both SessionStart (update check) and SessionEnd (auto-update) hooks.\n * Supports both Claude Code and Gemini CLI formats.\n * Merges with existing hooks, doesn't overwrite.\n *\n * @param basePath - Base installation path (e.g., ~/.claude or ~/.gemini)\n * @param runtime - Target runtime (claude or gemini)\n * @param dryRun - If true, don't write changes\n * @returns true if any hook was added, false if all already existed\n */\nexport function registerHooks(\n  basePath: string,\n  runtime: Exclude<Runtime, 'all'>,\n  dryRun: boolean,\n): boolean {\n  // Only for Claude and Gemini installations\n  if (runtime !== 'claude' && runtime !== 'gemini') {\n    return false;\n  }\n\n  const settingsPath = path.join(basePath, 'settings.json');\n  const runtimeDir = runtime === 'claude' ? '.claude' : '.gemini';\n\n  if (runtime === 'gemini') {\n    return registerGeminiHooks(settingsPath, runtimeDir, dryRun);\n  }\n\n  return registerClaudeHooks(settingsPath, runtimeDir, dryRun);\n}\n\n/**\n * Register ARE hooks in Claude Code settings.json format\n */\nfunction registerClaudeHooks(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean {\n  // Load or create settings (JSONC-aware)\n  let content = '{}';\n  if (existsSync(settingsPath)) {\n    try {\n      content = readFileSync(settingsPath, 'utf-8');\n    } catch {\n      // If can't read, start with empty object\n    }\n  }\n\n  const settings = (parse(content) ?? {}) as SettingsJson;\n\n  // Ensure hooks structure exists\n  if (!settings.hooks) {\n    settings.hooks = {};\n  }\n\n  let addedAny = false;\n\n  for (const hookDef of ARE_HOOKS) {\n    const hookCommand = `node ${runtimeDir}/hooks/${hookDef.filename}`;\n\n    // Ensure event array exists\n    if (!settings.hooks[hookDef.event]) {\n      settings.hooks[hookDef.event] = [];\n    }\n\n    // Check if hook already exists (by command string match)\n    const hookExists = settings.hooks[hookDef.event]!.some((event) =>\n      event.hooks?.some((h) => h.command === hookCommand),\n    );\n\n    if (!hookExists) {\n      // Define our hook (Claude format: nested hooks array)\n      const newHook: HookEvent = {\n        hooks: [\n          {\n            type: 'command',\n            command: hookCommand,\n          },\n        ],\n      };\n      settings.hooks[hookDef.event]!.push(newHook);\n      addedAny = true;\n    }\n  }\n\n  if (!addedAny) {\n    return false;\n  }\n\n  // Write settings preserving comments outside the hooks section\n  if (!dryRun) {\n    ensureDir(settingsPath);\n    const updated = applyEdits(content, modify(content, ['hooks'], settings.hooks, {\n      formattingOptions: { tabSize: 2, insertSpaces: true },\n    }));\n    writeFileSync(settingsPath, updated, 'utf-8');\n  }\n\n  return true;\n}\n\n/**\n * Permissions to auto-allow for ARE commands\n */\nconst ARE_PERMISSIONS = [\n  'Bash(npx agents-reverse-engineer@latest init*)',\n  'Bash(npx agents-reverse-engineer@latest discover*)',\n  'Bash(npx agents-reverse-engineer@latest generate*)',\n  'Bash(npx agents-reverse-engineer@latest update*)',\n  'Bash(npx agents-reverse-engineer@latest clean*)',\n  'Bash(rm -f .agents-reverse-engineer/progress.log*)',\n  'Bash(sleep *)',\n];\n\n/**\n * Register ARE permissions in Claude Code settings.json\n *\n * Adds bash command permissions for ARE commands to reduce friction.\n *\n * @param settingsPath - Path to settings.json\n * @param dryRun - If true, don't write changes\n * @returns true if permissions were added, false if already existed\n */\nexport function registerPermissions(settingsPath: string, dryRun: boolean): boolean {\n  // Load or create settings (JSONC-aware)\n  let content = '{}';\n  if (existsSync(settingsPath)) {\n    try {\n      content = readFileSync(settingsPath, 'utf-8');\n    } catch {\n      // If can't read, start with empty object\n    }\n  }\n\n  const settings = (parse(content) ?? {}) as SettingsJson;\n\n  // Ensure permissions structure exists\n  if (!settings.permissions) {\n    settings.permissions = {};\n  }\n  if (!settings.permissions.allow) {\n    settings.permissions.allow = [];\n  }\n\n  // Add any missing ARE permissions\n  let addedAny = false;\n  for (const perm of ARE_PERMISSIONS) {\n    if (!settings.permissions.allow.includes(perm)) {\n      settings.permissions.allow.push(perm);\n      addedAny = true;\n    }\n  }\n\n  if (!addedAny) {\n    return false;\n  }\n\n  // Write settings preserving comments outside the permissions section\n  if (!dryRun) {\n    ensureDir(settingsPath);\n    const updated = applyEdits(content, modify(content, ['permissions'], settings.permissions, {\n      formattingOptions: { tabSize: 2, insertSpaces: true },\n    }));\n    writeFileSync(settingsPath, updated, 'utf-8');\n  }\n\n  return true;\n}\n\n/**\n * Register ARE hooks in Gemini CLI settings.json format\n */\nfunction registerGeminiHooks(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean {\n  // Load or create settings (JSONC-aware)\n  let content = '{}';\n  if (existsSync(settingsPath)) {\n    try {\n      content = readFileSync(settingsPath, 'utf-8');\n    } catch {\n      // If can't read, start with empty object\n    }\n  }\n\n  const settings = (parse(content) ?? {}) as GeminiSettingsJson;\n\n  // Ensure hooks structure exists\n  if (!settings.hooks) {\n    settings.hooks = {};\n  }\n\n  let addedAny = false;\n\n  for (const hookDef of ARE_HOOKS) {\n    const hookCommand = `node ${runtimeDir}/hooks/${hookDef.filename}`;\n\n    // Ensure event array exists\n    if (!settings.hooks[hookDef.event]) {\n      settings.hooks[hookDef.event] = [];\n    }\n\n    // Check if hook already exists (by command string match)\n    const hookExists = settings.hooks[hookDef.event]!.some((h) => h.command === hookCommand);\n\n    if (!hookExists) {\n      // Define our hook (Gemini format: flat object with name)\n      const newHook: GeminiHook = {\n        name: hookDef.name,\n        type: 'command',\n        command: hookCommand,\n      };\n      settings.hooks[hookDef.event]!.push(newHook);\n      addedAny = true;\n    }\n  }\n\n  if (!addedAny) {\n    return false;\n  }\n\n  // Write settings preserving comments outside the hooks section\n  if (!dryRun) {\n    ensureDir(settingsPath);\n    const updated = applyEdits(content, modify(content, ['hooks'], settings.hooks, {\n      formattingOptions: { tabSize: 2, insertSpaces: true },\n    }));\n    writeFileSync(settingsPath, updated, 'utf-8');\n  }\n\n  return true;\n}\n\n/**\n * Get package version from package.json\n *\n * @returns Version string or 'unknown' if can't read\n */\nexport function getPackageVersion(): string {\n  try {\n    // Navigate from dist/installer/operations.js to package.json\n    // In ESM, we need to use import.meta.url\n    const __filename = fileURLToPath(import.meta.url);\n    const __dirname = path.dirname(__filename);\n    // From src/installer/ go up two levels to project root\n    const packagePath = path.join(__dirname, '..', '..', 'package.json');\n    const content = readFileSync(packagePath, 'utf-8');\n    const pkg = JSON.parse(content) as { version?: string };\n    return pkg.version || 'unknown';\n  } catch {\n    return 'unknown';\n  }\n}\n\n/**\n * Write ARE-VERSION file to track installed version\n *\n * @param basePath - Base installation path\n * @param dryRun - If true, don't write the file\n */\nexport function writeVersionFile(basePath: string, dryRun: boolean): void {\n  if (dryRun) {\n    return;\n  }\n\n  const versionPath = path.join(basePath, 'ARE-VERSION');\n  const version = getPackageVersion();\n\n  ensureDir(versionPath);\n  writeFileSync(versionPath, version, 'utf-8');\n}\n\n/**\n * Format installation result for display\n *\n * Generates human-readable lines showing created/skipped files.\n *\n * @param result - Installation result to format\n * @returns Array of formatted lines for display\n */\nexport function formatInstallResult(result: InstallerResult): string[] {\n  const lines: string[] = [];\n\n  // Header with runtime and location\n  lines.push(`  ${result.runtime} (${result.location}):`);\n\n  // Created files\n  for (const file of result.filesCreated) {\n    lines.push(`    Created: ${file}`);\n  }\n\n  // Skipped files\n  for (const file of result.filesSkipped) {\n    lines.push(`    Skipped: ${file} (already exists)`);\n  }\n\n  // Hook registration status (Claude only)\n  if (result.hookRegistered) {\n    lines.push(`    Registered: SessionEnd hook in settings.json`);\n  }\n\n  // Summary line\n  const created = result.filesCreated.length;\n  const skipped = result.filesSkipped.length;\n  lines.push(`    ${created} files installed, ${skipped} skipped`);\n\n  return lines;\n}\n\n```\n\nLead with a single bold purpose statement: **[FileName] does X.**\nThen use ## headings to organize the remaining content.\nEvery file MUST include at minimum:\n- A purpose statement (first line, bold)\n- Exported symbols with signatures (under any appropriate heading)\nChoose additional sections based on file content.\n\n## Existing Summary (update this — preserve stable content, modify only what changed)\n\n**Installer file operations: copies command templates and session hooks to runtime directories, registers hooks/permissions in settings.json via jsonc-parser, tracks installed versions, formats installation results.**\n\n## Exports\n\n**installFiles**(runtime: Runtime, location: Location, options: InstallOptions): InstallerResult[] — dispatches to `installFilesForRuntime()` for each runtime if runtime='all', otherwise single-runtime install.\n\n**verifyInstallation**(files: string[]): { success: boolean; missing: string[] } — filters files via `existsSync()`, returns missing files list.\n\n**registerHooks**(basePath: string, runtime: Exclude<Runtime, 'all'>, dryRun: boolean): boolean — delegates to `registerClaudeHooks()` or `registerGeminiHooks()`, returns true if hooks added to settings.json.\n\n**registerPermissions**(settingsPath: string, dryRun: boolean): boolean — merges ARE_PERMISSIONS into settings.json permissions.allow via `jsonc-parser` `modify()`/`applyEdits()`, preserves JSONC comments, returns true if permissions added.\n\n**getPackageVersion**(): string — reads ../../package.json from dist/installer/operations.js, extracts version field, returns 'unknown' on failure.\n\n**writeVersionFile**(basePath: string, dryRun: boolean): void — writes ARE-VERSION file containing `getPackageVersion()` output to basePath.\n\n**formatInstallResult**(result: InstallerResult): string[] — formats InstallerResult as lines showing runtime/location, created/skipped files, hook registration, summary counts.\n\n### Types\n\n**InstallOptions** — { force: boolean; dryRun: boolean }\n\n**SessionHook** — { type: 'command'; command: string }\n\n**HookEvent** — { hooks: SessionHook[] }\n\n**SettingsJson** — { hooks?: { SessionStart?: HookEvent[]; SessionEnd?: HookEvent[] }; permissions?: { allow?: string[]; deny?: string[] }; [key: string]: unknown }\n\n**GeminiHook** — { name: string; type: 'command'; command: string }\n\n**GeminiSettingsJson** — { hooks?: { SessionStart?: GeminiHook[]; SessionEnd?: GeminiHook[] }; [key: string]: unknown }\n\n**HookDefinition** — { event: 'SessionStart' | 'SessionEnd'; filename: string; name: string }\n\n**PluginDefinition** — { srcFilename: string; destFilename: string }\n\n## Internal Functions\n\n**installFilesForRuntime**(runtime: Exclude<Runtime, 'all'>, location: Location, options: InstallOptions): InstallerResult — copies command templates via `getTemplatesForRuntime()` to `resolveInstallPath()`, installs hooks (Claude/Gemini) or plugins (OpenCode), calls `registerHooks()`/`registerPermissions()`, invokes `writeVersionFile()`, returns InstallerResult.\n\n**ensureDir**(filePath: string): void — creates parent directory via `mkdirSync(path.dirname(filePath), { recursive: true })` if missing.\n\n**getBundledHookPath**(hookName: string): string — navigates from dist/installer/operations.js via `../../hooks/dist/${hookName}` to locate bundled hook file.\n\n**readBundledHook**(hookName: string): string — reads hook content via `readFileSync(getBundledHookPath(hookName))`, throws if not found.\n\n**getTemplatesForRuntime**(runtime: Exclude<Runtime, 'all'>) — dispatches to `getClaudeTemplates()`, `getOpenCodeTemplates()`, or `getGeminiTemplates()`.\n\n**registerClaudeHooks**(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean — registers Claude Code format hooks (nested hooks array) via ARE_HOOKS loop, constructs `node ${runtimeDir}/hooks/${hookDef.filename}` commands, merges into settings.hooks via `modify(content, ['hooks'], settings.hooks)`, preserves JSONC comments via `applyEdits()`.\n\n**registerGeminiHooks**(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean — registers Gemini CLI format hooks (flat objects with name field) via ARE_HOOKS loop, uses GeminiHook schema.\n\n## Integration\n\nImports `resolveInstallPath()`, `getAllRuntimes()` from `./paths.js`, `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` from `../integration/templates.js`, types Runtime/Location/InstallerResult from `./types.js`. Uses `jsonc-parser` exports `parse()`, `modify()`, `applyEdits()` for settings.json manipulation.\n\n## Behavioral Contracts\n\n### Hook Definitions\n\n```typescript\nconst ARE_HOOKS: HookDefinition[] = [\n  // { event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' },\n  // { event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }, // Disabled - causing issues\n];\n```\nCurrently empty array (all hooks disabled).\n\n### Plugin Definitions\n\n```typescript\nconst ARE_PLUGINS: PluginDefinition[] = [\n  { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' },\n];\n```\nOnly SessionStart check-update plugin active for OpenCode.\n\n### Permission Strings\n\n```typescript\nconst ARE_PERMISSIONS = [\n  'Bash(npx agents-reverse-engineer@latest init*)',\n  'Bash(npx agents-reverse-engineer@latest discover*)',\n  'Bash(npx agents-reverse-engineer@latest generate*)',\n  'Bash(npx agents-reverse-engineer@latest update*)',\n  'Bash(npx agents-reverse-engineer@latest clean*)',\n  'Bash(rm -f .agents-reverse-engineer/progress.log*)',\n  'Bash(sleep *)',\n];\n```\n\n### Hook Command Format\n\n`node ${runtimeDir}/hooks/${hookDef.filename}` where runtimeDir is '.claude' or '.gemini'.\n\n### Settings.json Modification\n\nUses jsonc-parser with `formattingOptions: { tabSize: 2, insertSpaces: true }`. Preserves JSONC comments via `applyEdits(content, modify(...))` pattern.\n\n### Installation Flow\n\n1. Resolve basePath via `resolveInstallPath(runtime, location)`\n2. Get templates via `getTemplatesForRuntime(runtime)`\n3. Extract relativePath via `template.path.split('/').slice(1).join('/')` (strips runtime prefix)\n4. Write files: skip if exists and !force, track in filesCreated/filesSkipped/errors\n5. Install hooks (Claude/Gemini) or plugins (OpenCode) via `readBundledHook()`\n6. Register hooks via `registerHooks()` → hookRegistered boolean\n7. Register permissions (Claude only) via `registerPermissions()`\n8. Write ARE-VERSION if filesCreated.length > 0 and !dryRun\n\n### Result Schema\n\nInstallerResult: success (errors.length === 0), runtime, location, filesCreated[], filesSkipped[], errors[], hookRegistered, versionWritten.",
      "systemPrompt": "You are updating an existing file summary for an AI coding assistant. The source code has changed and the summary needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING summary and the UPDATED source code\n- Preserve the structure, section headings, and phrasing of the existing summary wherever the underlying code is unchanged\n- Only modify content that is directly affected by the code changes\n- If a section describes code that has not changed, keep it VERBATIM — do not rephrase, reorganize, or \"improve\" stable text\n- Add new sections only if the code changes introduce entirely new concepts\n- Remove sections only if the code they described has been deleted\n- Update signatures, type names, and identifiers to match the current source exactly\n\nBEHAVIORAL CONTRACT PRESERVATION (MANDATORY):\n- Regex patterns, format strings, magic constants, and template content from the existing summary MUST be preserved verbatim unless the source code changed them\n- If source code changes a regex pattern or constant, update the summary to show the NEW value verbatim\n- Never summarize or paraphrase regex patterns — always show the exact pattern in backticks\n\nWORKFLOW & CONVENTION RULE PRESERVATION (MANDATORY):\n- Contribution guidelines, testing mandates, PR conventions, code conventions, and AI agent instructions from the existing summary MUST be preserved verbatim unless the source file changed them\n\n\nTARGET LENGTH (MANDATORY):\n- Source file: 17754 characters\n- Target summary: ~4439 characters (25% compression)\n- Maximum: 5327 characters\n- Achieve this by: ultra-dense writing, minimal examples, single-sentence descriptions\n\nULTRA-COMPRESSION TECHNIQUES:\n- Use telegraphic style: \"exports foo, bar, baz\" not \"this file exports three functions\"\n- No code examples unless critical to understanding\n- One sentence per export maximum\n- Omit obvious parameter names (\"opts: Options\" not \"options: Options - configuration object\")\n- Use abbreviations: \"params\" not \"parameters\", \"config\" not \"configuration\"\n- Skip section if empty (don't write \"No special concerns\" or \"N/A\")\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this file\", \"this module\", \"provides\", \"responsible for\", \"is used to\", \"basically\", \"essentially\", \"provides functionality for\"\n- Use the pattern: \"[ExportName] does X\" not \"The ExportName function is responsible for doing X\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- All exported function/class/type/const names MUST appear in the summary exactly as written in source\n- Key parameter types and return types MUST be mentioned\n- Preserve exact casing of identifiers\n- Missing any exported identifier is a failure\n\nOUTPUT FORMAT (MANDATORY):\n- Start your response DIRECTLY with the purpose statement — a single bold line: **Purpose statement here.**\n- Do NOT include any preamble, thinking, or meta-commentary before the purpose statement\n- Do NOT say \"Here is...\", \"Now I'll...\", \"Based on my analysis...\", \"Let me create...\", \"Perfect.\"\n- Your response IS the documentation — not a message about the documentation",
      "response": "**Installer file operations: copies command templates and session hooks to runtime directories, registers hooks/permissions in settings.json via jsonc-parser, tracks installed versions, formats installation results.**\n\n## Exports\n\n**installFiles**(runtime: Runtime, location: Location, options: InstallOptions): InstallerResult[] — dispatches to `installFilesForRuntime()` for each runtime if runtime='all', otherwise single-runtime install.\n\n**verifyInstallation**(files: string[]): { success: boolean; missing: string[] } — filters files via `existsSync()`, returns missing files list.\n\n**registerHooks**(basePath: string, runtime: Exclude<Runtime, 'all'>, dryRun: boolean): boolean — delegates to `registerClaudeHooks()` or `registerGeminiHooks()`, returns true if hooks added to settings.json.\n\n**registerPermissions**(settingsPath: string, dryRun: boolean): boolean — merges ARE_PERMISSIONS into settings.json permissions.allow via `jsonc-parser` `modify()`/`applyEdits()`, preserves JSONC comments, returns true if permissions added.\n\n**getPackageVersion**(): string — reads ../../package.json from dist/installer/operations.js, extracts version field, returns 'unknown' on failure.\n\n**writeVersionFile**(basePath: string, dryRun: boolean): void — writes ARE-VERSION file containing `getPackageVersion()` output to basePath.\n\n**formatInstallResult**(result: InstallerResult): string[] — formats InstallerResult as lines showing runtime/location, created/skipped files, hook registration, summary counts.\n\n### Types\n\n**InstallOptions** — { force: boolean; dryRun: boolean }\n\n**SessionHook** — { type: 'command'; command: string }\n\n**HookEvent** — { hooks: SessionHook[] }\n\n**SettingsJson** — { hooks?: { SessionStart?: HookEvent[]; SessionEnd?: HookEvent[] }; permissions?: { allow?: string[]; deny?: string[] }; [key: string]: unknown }\n\n**GeminiHook** — { name: string; type: 'command'; command: string }\n\n**GeminiSettingsJson** — { hooks?: { SessionStart?: GeminiHook[]; SessionEnd?: GeminiHook[] }; [key: string]: unknown }\n\n**HookDefinition** — { event: 'SessionStart' | 'SessionEnd'; filename: string; name: string }\n\n**PluginDefinition** — { srcFilename: string; destFilename: string }\n\n## Internal Functions\n\n**installFilesForRuntime**(runtime: Exclude<Runtime, 'all'>, location: Location, options: InstallOptions): InstallerResult — copies command templates via `getTemplatesForRuntime()` to `resolveInstallPath()`, installs hooks (Claude/Gemini) or plugins (OpenCode), calls `registerHooks()`/`registerPermissions()`, invokes `writeVersionFile()`, returns InstallerResult.\n\n**ensureDir**(filePath: string): void — creates parent directory via `mkdirSync(path.dirname(filePath), { recursive: true })` if missing.\n\n**getBundledHookPath**(hookName: string): string — navigates from dist/installer/operations.js via `../../hooks/dist/${hookName}` to locate bundled hook file.\n\n**readBundledHook**(hookName: string): string — reads hook content via `readFileSync(getBundledHookPath(hookName))`, throws if not found.\n\n**getTemplatesForRuntime**(runtime: Exclude<Runtime, 'all'>) — dispatches to `getClaudeTemplates()`, `getOpenCodeTemplates()`, or `getGeminiTemplates()`.\n\n**registerClaudeHooks**(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean — registers Claude Code format hooks (nested hooks array) via ARE_HOOKS loop, constructs `node ${runtimeDir}/hooks/${hookDef.filename}` commands, merges into settings.hooks via `modify(content, ['hooks'], settings.hooks)`, preserves JSONC comments via `applyEdits()`.\n\n**registerGeminiHooks**(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean — registers Gemini CLI format hooks (flat objects with name field) via ARE_HOOKS loop, uses GeminiHook schema.\n\n## Integration\n\nImports `resolveInstallPath()`, `getAllRuntimes()` from `./paths.js`, `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` from `../integration/templates.js`, types Runtime/Location/InstallerResult from `./types.js`. Uses `jsonc-parser` exports `parse()`, `modify()`, `applyEdits()` for settings.json manipulation.\n\n## Behavioral Contracts\n\n### Hook Definitions\n\n```typescript\nconst ARE_HOOKS: HookDefinition[] = [\n  // { event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' },\n  // { event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }, // Disabled - causing issues\n];\n```\nCurrently empty array (all hooks disabled).\n\n### Plugin Definitions\n\n```typescript\nconst ARE_PLUGINS: PluginDefinition[] = [\n  // Disabled - causing issues in OpenCode\n  // { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' },\n];\n```\nCurrently empty array (all plugins disabled).\n\n### Permission Strings\n\n```typescript\nconst ARE_PERMISSIONS = [\n  'Bash(npx agents-reverse-engineer@latest init*)',\n  'Bash(npx agents-reverse-engineer@latest discover*)',\n  'Bash(npx agents-reverse-engineer@latest generate*)',\n  'Bash(npx agents-reverse-engineer@latest update*)',\n  'Bash(npx agents-reverse-engineer@latest clean*)',\n  'Bash(rm -f .agents-reverse-engineer/progress.log*)',\n  'Bash(sleep *)',\n];\n```\n\n### Hook Command Format\n\n`node ${runtimeDir}/hooks/${hookDef.filename}` where runtimeDir is '.claude' or '.gemini'.\n\n### Settings.json Modification\n\nUses jsonc-parser with `formattingOptions: { tabSize: 2, insertSpaces: true }`. Preserves JSONC comments via `applyEdits(content, modify(...))` pattern.\n\n### Installation Flow\n\n1. Resolve basePath via `resolveInstallPath(runtime, location)`\n2. Get templates via `getTemplatesForRuntime(runtime)`\n3. Extract relativePath via `template.path.split('/').slice(1).join('/')` (strips runtime prefix)\n4. Write files: skip if exists and !force, track in filesCreated/filesSkipped/errors\n5. Install hooks (Claude/Gemini) or plugins (OpenCode) via `readBundledHook()`\n6. Register hooks via `registerHooks()` → hookRegistered boolean\n7. Register permissions (Claude only) via `registerPermissions()`\n8. Write ARE-VERSION if filesCreated.length > 0 and !dryRun\n\n### Result Schema\n\nInstallerResult: success (errors.length === 0), runtime, location, filesCreated[], filesSkipped[], errors[], hookRegistered, versionWritten.",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 1812,
      "cacheReadTokens": 0,
      "cacheCreationTokens": 31021,
      "latencyMs": 33748,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": [
        {
          "path": "src/installer/operations.ts",
          "sizeBytes": 17754
        }
      ]
    },
    {
      "timestamp": "2026-02-12T08:35:49.588Z",
      "prompt": "Analyze this source file and generate a summary that captures what an AI coding assistant needs to know to work with this file effectively.\n\nFile: src/integration/templates.ts\n\n```typescript\n/**\n * Template generators for AI coding assistant integration files\n *\n * Generates command file templates for Claude Code, OpenCode, Gemini CLI, and session hooks.\n */\n\nimport type { IntegrationTemplate } from './types.js';\n\n// =============================================================================\n// Shared Command Content\n// =============================================================================\n\nconst COMMANDS = {\n  generate: {\n    description: 'Generate AI-friendly documentation for the entire codebase',\n    argumentHint: '[path] [--dry-run] [--concurrency N] [--fail-fast] [--debug] [--trace]',\n    content: `Generate comprehensive documentation for this codebase using agents-reverse-engineer.\n\n<execution>\nRun the generate command in the background and monitor progress in real time.\n\n## Steps\n\n1. **Display version**: Read \\`VERSION_FILE_PATH\\` and show the user: \\`agents-reverse-engineer vX.Y.Z\\`\n\n2. **Delete stale progress log** (prevents reading leftover data from a previous run):\n   \\`\\`\\`bash\n   rm -f .agents-reverse-engineer/progress.log\n   \\`\\`\\`\n\n3. **Run the generate command in the background** using \\`run_in_background: true\\`:\n   \\`\\`\\`bash\n   npx agents-reverse-engineer@latest generate $ARGUMENTS\n   \\`\\`\\`\n\n4. **Monitor progress by polling** \\`.agents-reverse-engineer/progress.log\\`:\n   - Wait ~15 seconds (use \\`sleep 15\\` in Bash), then use the **Read** tool to read \\`.agents-reverse-engineer/progress.log\\` (use the \\`offset\\` parameter to read only the last ~20 lines for long files)\n   - Show the user a brief progress update (e.g. \"32/96 files analyzed, ~12m remaining\")\n   - Check whether the background task has completed using \\`TaskOutput\\` with \\`block: false\\`\n   - Repeat until the background task finishes\n   - **Important**: Keep polling even if progress.log doesn't exist yet (the command takes a few seconds to start writing)\n\n5. **On completion**, read the full background task output and summarize:\n   - Number of files analyzed and any failures\n   - Number of directories documented\n   - Any inconsistency warnings from the quality report\n\nThis executes a two-phase pipeline:\n\n1. **File Analysis** (concurrent): Discovers files, applies filters, then analyzes each source file via AI and writes \\`.sum\\` summary files with YAML frontmatter (\\`content_hash\\`, \\`file_type\\`, \\`purpose\\`, \\`public_interface\\`, \\`dependencies\\`, \\`patterns\\`).\n\n2. **Directory Aggregation** (sequential): Generates \\`AGENTS.md\\` per directory in post-order traversal (deepest first, so child summaries feed into parents), and writes \\`CLAUDE.md\\` pointers.\n\n**Options:**\n- \\`--dry-run\\`: Preview the plan without making AI calls\n- \\`--concurrency N\\`: Control number of parallel AI calls (default: auto)\n- \\`--fail-fast\\`: Stop on first file analysis failure\n- \\`--debug\\`: Show AI prompts and backend details\n- \\`--trace\\`: Enable concurrency tracing to \\`.agents-reverse-engineer/traces/\\`\n</execution>`,\n  },\n\n  update: {\n    description: 'Incrementally update documentation for changed files',\n    argumentHint: '[path] [--uncommitted] [--dry-run] [--concurrency N] [--fail-fast] [--debug] [--trace]',\n    content: `Update documentation for files that changed since last run.\n\n<execution>\nRun the update command in the background and monitor progress in real time.\n\n## Steps\n\n1. **Display version**: Read \\`VERSION_FILE_PATH\\` and show the user: \\`agents-reverse-engineer vX.Y.Z\\`\n\n2. **Delete stale progress log** (prevents reading leftover data from a previous run):\n   \\`\\`\\`bash\n   rm -f .agents-reverse-engineer/progress.log\n   \\`\\`\\`\n\n3. **Run the update command in the background** using \\`run_in_background: true\\`:\n   \\`\\`\\`bash\n   npx agents-reverse-engineer@latest update $ARGUMENTS\n   \\`\\`\\`\n\n4. **Monitor progress by polling** \\`.agents-reverse-engineer/progress.log\\`:\n   - Wait ~15 seconds (use \\`sleep 15\\` in Bash), then use the **Read** tool to read \\`.agents-reverse-engineer/progress.log\\` (use the \\`offset\\` parameter to read only the last ~20 lines for long files)\n   - Show the user a brief progress update (e.g. \"12/30 files updated, ~5m remaining\")\n   - Check whether the background task has completed using \\`TaskOutput\\` with \\`block: false\\`\n   - Repeat until the background task finishes\n   - **Important**: Keep polling even if progress.log doesn't exist yet (the command takes a few seconds to start writing)\n\n5. **On completion**, read the full background task output and summarize:\n   - Files updated\n   - Files unchanged\n   - Any orphaned docs cleaned up\n\n**Options:**\n- \\`--uncommitted\\`: Include staged but uncommitted changes\n- \\`--dry-run\\`: Show what would be updated without writing\n- \\`--concurrency N\\`: Control number of parallel AI calls (default: auto)\n- \\`--fail-fast\\`: Stop on first file analysis failure\n- \\`--debug\\`: Show AI prompts and backend details\n- \\`--trace\\`: Enable concurrency tracing to \\`.agents-reverse-engineer/traces/\\`\n</execution>`,\n  },\n\n  init: {\n    description: 'Initialize agents-reverse-engineer configuration',\n    argumentHint: '',\n    content: `Initialize agents-reverse-engineer configuration in this project.\n\n<execution>\n1. **Display version**: Read \\`VERSION_FILE_PATH\\` and show the user: \\`agents-reverse-engineer vX.Y.Z\\`\n\n2. Run the agents-reverse-engineer init command:\n\n\\`\\`\\`bash\nnpx agents-reverse-engineer@latest init\n\\`\\`\\`\n\nThis creates \\`.agents-reverse-engineer/config.yaml\\` configuration file.\n</execution>`,\n  },\n\n  discover: {\n    description: 'Discover files in codebase',\n    argumentHint: '[path] [--debug] [--trace]',\n    content: `List files that would be analyzed for documentation.\n\n<execution>\n## STRICT RULES - VIOLATION IS FORBIDDEN\n\n1. Run ONLY this exact command: \\`npx agents-reverse-engineer@latest discover $ARGUMENTS\\`\n2. DO NOT add ANY flags the user did not explicitly type\n3. If user typed nothing after \\`COMMAND_PREFIXdiscover\\`, run with ZERO flags\n\n## Steps\n\n1. **Display version**: Read \\`VERSION_FILE_PATH\\` and show the user: \\`agents-reverse-engineer vX.Y.Z\\`\n\n2. **Delete stale progress log** (prevents reading leftover data from a previous run):\n   \\`\\`\\`bash\n   rm -f .agents-reverse-engineer/progress.log\n   \\`\\`\\`\n\n3. **Run the discover command in the background** using \\`run_in_background: true\\`:\n   \\`\\`\\`bash\n   npx agents-reverse-engineer@latest discover $ARGUMENTS\n   \\`\\`\\`\n\n4. **Monitor progress by polling** \\`.agents-reverse-engineer/progress.log\\`:\n   - Wait ~10 seconds (use \\`sleep 10\\` in Bash), then use the **Read** tool to read \\`.agents-reverse-engineer/progress.log\\` (use the \\`offset\\` parameter to read only the last ~20 lines for long files)\n   - Show the user a brief progress update\n   - Check whether the background task has completed using \\`TaskOutput\\` with \\`block: false\\`\n   - Repeat until the background task finishes\n   - **Important**: Keep polling even if progress.log doesn't exist yet (the command takes a few seconds to start writing)\n\n5. **On completion**, read the full background task output and report number of files found.\n\n6. **Review plan and suggest exclusions**:\n   - Read \\`.agents-reverse-engineer/GENERATION-PLAN.md\\` and \\`.agents-reverse-engineer/config.yaml\\`\n   - Scan the Phase 1 file list and classify files into these categories:\n     - **Test/spec files**: matches like \\`*.test.*\\`, \\`*.spec.*\\`, \\`__tests__/**\\`, \\`__mocks__/**\\`, \\`*.stories.*\\`, \\`*.story.*\\`\n     - **CI/CD configs**: \\`.github/workflows/*.yml\\`, \\`.gitlab-ci.yml\\`, \\`Jenkinsfile\\`, \\`.circleci/**\\`, \\`.travis.yml\\`\n     - **Tool configs**: \\`.eslintrc*\\`, \\`.prettierrc*\\`, \\`jest.config.*\\`, \\`.editorconfig\\`, \\`babel.config.*\\`, \\`webpack.config.*\\`, \\`vite.config.*\\`, \\`rollup.config.*\\`, \\`tsconfig*.json\\`, \\`.lintstagedrc*\\`, \\`.huskyrc*\\`, \\`.stylelintrc*\\`, \\`commitlint.config.*\\`\n     - **Migration files**: paths containing \\`migrations/\\` or matching \\`*.migration.*\\`\n     - **Fixture/snapshot files**: \\`__snapshots__/**\\`, \\`*.fixture.*\\`, \\`fixtures/**\\`, \\`test-data/**\\`, \\`testdata/**\\`\n     - **Type declarations**: \\`*.d.ts\\` (not source code, auto-generated or ambient)\n     - **Docker/infra**: \\`Dockerfile*\\`, \\`docker-compose*\\`, \\`*.Dockerfile\\`, \\`k8s/**\\`, \\`terraform/**\\`, \\`helm/**\\`\n   - For each category, count how many files from the plan match and list up to 3 example filenames\n   - **Skip categories with zero matches** — only present categories that have files in the plan\n   - Also skip patterns that are already in the current \\`config.yaml\\` exclude list\n   - Present the findings in a summary table showing category, file count, example files, and proposed glob patterns\n   - Ask the user which categories to exclude using \\`AskUserQuestion\\` with \\`multiSelect: true\\`\n   - For accepted categories, use the **Edit** tool to append the corresponding glob patterns to the \\`exclude.patterns\\` array in \\`.agents-reverse-engineer/config.yaml\\`\n   - After editing, briefly confirm what was added\n</execution>`,\n  },\n\n  clean: {\n    description: 'Delete all generated documentation artifacts (.sum, AGENTS.md, plan)',\n    argumentHint: '[path] [--dry-run]',\n    content: `Remove all documentation artifacts generated by agents-reverse-engineer.\n\n<execution>\n## STRICT RULES - VIOLATION IS FORBIDDEN\n\n1. Run ONLY this exact command: \\`npx agents-reverse-engineer@latest clean $ARGUMENTS\\`\n2. DO NOT add ANY flags the user did not explicitly type\n3. If user typed nothing after \\`COMMAND_PREFIXclean\\`, run with ZERO flags\n\n**Display version**: Read \\`VERSION_FILE_PATH\\` and show the user: \\`agents-reverse-engineer vX.Y.Z\\`\n\n\\`\\`\\`bash\nnpx agents-reverse-engineer@latest clean $ARGUMENTS\n\\`\\`\\`\n\nReport number of files deleted.\n</execution>`,\n  },\n\n  specify: {\n    description: 'Generate project specification from AGENTS.md docs',\n    argumentHint: '[path] [--dry-run] [--output <path>] [--multi-file] [--force] [--debug] [--trace]',\n    content: `Generate a project specification from existing AGENTS.md documentation.\n\n<execution>\nRun the specify command in the background and monitor progress in real time.\n\n## Steps\n\n1. **Display version**: Read \\`VERSION_FILE_PATH\\` and show the user: \\`agents-reverse-engineer vX.Y.Z\\`\n\n2. **Delete stale progress log** (prevents reading leftover data from a previous run):\n   \\`\\`\\`bash\n   rm -f .agents-reverse-engineer/progress.log\n   \\`\\`\\`\n\n3. **Run the specify command in the background** using \\`run_in_background: true\\`:\n   \\`\\`\\`bash\n   npx agents-reverse-engineer@latest specify $ARGUMENTS\n   \\`\\`\\`\n\n4. **Monitor progress by polling** \\`.agents-reverse-engineer/progress.log\\`:\n   - Wait ~15 seconds (use \\`sleep 15\\` in Bash), then use the **Read** tool to read \\`.agents-reverse-engineer/progress.log\\` (use the \\`offset\\` parameter to read only the last ~20 lines for long files)\n   - Show the user a brief progress update\n   - Check whether the background task has completed using \\`TaskOutput\\` with \\`block: false\\`\n   - Repeat until the background task finishes\n   - **Important**: Keep polling even if progress.log doesn't exist yet (the command takes a few seconds to start writing)\n\n5. **On completion**, read the full background task output and summarize:\n   - Number of AGENTS.md files collected\n   - Output file(s) written\n\nThis collects all AGENTS.md files, synthesizes them via AI, and writes a comprehensive project specification.\n\nIf no AGENTS.md files exist, it will auto-run \\`generate\\` first.\n\n**Options:**\n- \\`--dry-run\\`: Show input statistics without making AI calls\n- \\`--output <path>\\`: Custom output path (default: specs/SPEC.md)\n- \\`--multi-file\\`: Split specification into multiple files\n- \\`--force\\`: Overwrite existing specification\n- \\`--debug\\`: Show AI prompts and backend details\n- \\`--trace\\`: Enable concurrency tracing to \\`.agents-reverse-engineer/traces/\\`\n</execution>`,\n  },\n\n  rebuild: {\n    description: 'Reconstruct project from specification documents',\n    argumentHint: '[path] [--dry-run] [--output <path>] [--force] [--concurrency N] [--fail-fast] [--debug] [--trace]',\n    content: `Reconstruct a project from specification documents using agents-reverse-engineer.\n\n<execution>\nRun the rebuild command in the background and monitor progress in real time.\n\n## Steps\n\n1. **Display version**: Read \\`VERSION_FILE_PATH\\` and show the user: \\`agents-reverse-engineer vX.Y.Z\\`\n\n2. **Delete stale progress log** (prevents reading leftover data from a previous run):\n   \\`\\`\\`bash\n   rm -f .agents-reverse-engineer/progress.log\n   \\`\\`\\`\n\n3. **Run the rebuild command in the background** using \\`run_in_background: true\\`:\n   \\`\\`\\`bash\n   npx agents-reverse-engineer@latest rebuild $ARGUMENTS\n   \\`\\`\\`\n\n4. **Monitor progress by polling** \\`.agents-reverse-engineer/progress.log\\`:\n   - Wait ~15 seconds (use \\`sleep 15\\` in Bash), then use the **Read** tool to read \\`.agents-reverse-engineer/progress.log\\` (use the \\`offset\\` parameter to read only the last ~20 lines for long files)\n   - Show the user a brief progress update (e.g. \"4/12 rebuild units completed\")\n   - Check whether the background task has completed using \\`TaskOutput\\` with \\`block: false\\`\n   - Repeat until the background task finishes\n   - **Important**: Keep polling even if progress.log doesn't exist yet (the command takes a few seconds to start writing)\n\n5. **On completion**, read the full background task output and summarize:\n   - Number of rebuild units processed\n   - Files generated and output directory\n   - Any failures or partial completions\n\nThis reads spec files from \\`specs/\\`, partitions them into ordered rebuild units, and processes each via AI to generate source files.\n\n**Options:**\n- \\`--dry-run\\`: Show rebuild plan without making AI calls\n- \\`--output <path>\\`: Output directory (default: rebuild/)\n- \\`--force\\`: Wipe output directory and start fresh\n- \\`--concurrency N\\`: Control number of parallel AI calls (default: auto)\n- \\`--fail-fast\\`: Stop on first failure\n- \\`--debug\\`: Show AI prompts and backend details\n- \\`--trace\\`: Enable concurrency tracing to \\`.agents-reverse-engineer/traces/\\`\n\n**Exit codes:** 0 (success), 1 (partial failure), 2 (total failure)\n</execution>`,\n  },\n\n  help: {\n    description: 'Show available ARE commands and usage guide',\n    argumentHint: '',\n    // Content uses COMMAND_PREFIX placeholder, replaced per platform\n    content: `<objective>\nDisplay the complete ARE command reference.\n\n**First**: Read \\`VERSION_FILE_PATH\\` and show the user the version: \\`agents-reverse-engineer vX.Y.Z\\`\n\n**Then**: Output ONLY the reference content below. Do NOT add:\n- Project-specific analysis\n- Git status or file context\n- Next-step suggestions\n- Any commentary beyond the reference\n</objective>\n\n<reference>\n# agents-reverse-engineer (ARE) Command Reference\n\n**ARE** generates AI-friendly documentation for codebases, creating structured summaries optimized for AI assistants.\n\n## Quick Start\n\n1. \\`COMMAND_PREFIXinit\\` — Create configuration file\n2. \\`COMMAND_PREFIXgenerate\\` — Generate documentation for the codebase\n3. \\`COMMAND_PREFIXupdate\\` — Keep docs in sync after code changes\n\n## Commands Reference\n\n### \\`COMMAND_PREFIXinit\\`\nInitialize configuration in this project.\n\nCreates \\`.agents-reverse-engineer/config.yaml\\` with customizable settings.\n\n**Usage:** \\`COMMAND_PREFIXinit\\`\n**CLI:** \\`npx are init\\`\n\n---\n\n### \\`COMMAND_PREFIXdiscover\\`\nDiscover files that would be analyzed for documentation.\n\nShows included files, excluded files with reasons, and generates a \\`GENERATION-PLAN.md\\` execution plan.\n\n**Options:**\n| Flag | Description |\n|------|-------------|\n| \\`[path]\\` | Target directory (default: current directory) |\n| \\`--debug\\` | Show verbose debug output |\n| \\`--trace\\` | Enable concurrency tracing to \\`.agents-reverse-engineer/traces/\\` |\n**Usage:**\n- \\`COMMAND_PREFIXdiscover\\` — Discover files and generate execution plan\n\n**CLI:**\n\\`\\`\\`bash\nnpx are discover\nnpx are discover ./src\n\\`\\`\\`\n\n---\n\n### \\`COMMAND_PREFIXgenerate\\`\nGenerate comprehensive documentation for the codebase.\n\n**Options:**\n| Flag | Description |\n|------|-------------|\n| \\`[path]\\` | Target directory (default: current directory) |\n| \\`--concurrency N\\` | Number of concurrent AI calls (default: auto) |\n| \\`--dry-run\\` | Show what would be generated without writing |\n| \\`--fail-fast\\` | Stop on first file analysis failure |\n| \\`--debug\\` | Show AI prompts and backend details |\n| \\`--trace\\` | Enable concurrency tracing to \\`.agents-reverse-engineer/traces/\\` |\n**Usage:**\n- \\`COMMAND_PREFIXgenerate\\` — Generate docs\n- \\`COMMAND_PREFIXgenerate --dry-run\\` — Preview without writing\n- \\`COMMAND_PREFIXgenerate --concurrency 3\\` — Limit parallel AI calls\n\n**CLI:**\n\\`\\`\\`bash\nnpx are generate\nnpx are generate --dry-run\nnpx are generate ./my-project --concurrency 3\nnpx are generate --debug --trace\n\\`\\`\\`\n\n**How it works:**\n1. Discovers files, applies filters, analyzes each file via concurrent AI calls, writes \\`.sum\\` summary files\n2. Generates \\`AGENTS.md\\` for each directory (post-order traversal) and writes \\`CLAUDE.md\\` pointers\n\n---\n\n### \\`COMMAND_PREFIXupdate\\`\nIncrementally update documentation for changed files.\n\n**Options:**\n| Flag | Description |\n|------|-------------|\n| \\`[path]\\` | Target directory (default: current directory) |\n| \\`--uncommitted\\` | Include staged but uncommitted changes |\n| \\`--dry-run\\` | Show what would be updated without writing |\n| \\`--concurrency N\\` | Number of concurrent AI calls (default: auto) |\n| \\`--fail-fast\\` | Stop on first file analysis failure |\n| \\`--debug\\` | Show AI prompts and backend details |\n| \\`--trace\\` | Enable concurrency tracing to \\`.agents-reverse-engineer/traces/\\` |\n**Usage:**\n- \\`COMMAND_PREFIXupdate\\` — Update docs for committed changes\n- \\`COMMAND_PREFIXupdate --uncommitted\\` — Include uncommitted changes\n\n**CLI:**\n\\`\\`\\`bash\nnpx are update\nnpx are update --uncommitted\nnpx are update --dry-run\nnpx are update ./my-project --concurrency 3\n\\`\\`\\`\n\n---\n\n### \\`COMMAND_PREFIXspecify\\`\nGenerate a project specification from AGENTS.md documentation.\n\nCollects all AGENTS.md files, synthesizes them via AI, and writes a comprehensive project specification. Auto-runs \\`generate\\` if no AGENTS.md files exist.\n\n**Options:**\n| Flag | Description |\n|------|-------------|\n| \\`[path]\\` | Target directory (default: current directory) |\n| \\`--output <path>\\` | Custom output path (default: specs/SPEC.md) |\n| \\`--multi-file\\` | Split specification into multiple files |\n| \\`--force\\` | Overwrite existing specification |\n| \\`--dry-run\\` | Show input statistics without making AI calls |\n| \\`--debug\\` | Show AI prompts and backend details |\n| \\`--trace\\` | Enable concurrency tracing to \\`.agents-reverse-engineer/traces/\\` |\n**Usage:**\n- \\`COMMAND_PREFIXspecify\\` — Generate specification\n- \\`COMMAND_PREFIXspecify --dry-run\\` — Preview without calling AI\n- \\`COMMAND_PREFIXspecify --output ./docs/spec.md --force\\` — Custom output path\n\n**CLI:**\n\\`\\`\\`bash\nnpx are specify\nnpx are specify --dry-run\nnpx are specify --output ./docs/spec.md --force\nnpx are specify --multi-file\n\\`\\`\\`\n\n---\n\n### \\`COMMAND_PREFIXrebuild\\`\nReconstruct a project from specification documents.\n\nReads spec files from \\`specs/\\`, partitions them into ordered rebuild units, processes each via AI, and writes generated source files to an output directory. Supports checkpoint-based session continuity for resumable long-running rebuilds.\n\n**Options:**\n| Flag | Description |\n|------|-------------|\n| \\`[path]\\` | Target directory (default: current directory) |\n| \\`--output <path>\\` | Output directory (default: rebuild/) |\n| \\`--force\\` | Wipe output directory and start fresh |\n| \\`--dry-run\\` | Show rebuild plan without making AI calls |\n| \\`--concurrency N\\` | Number of concurrent AI calls (default: auto) |\n| \\`--fail-fast\\` | Stop on first failure |\n| \\`--debug\\` | Show AI prompts and backend details |\n| \\`--trace\\` | Enable concurrency tracing to \\`.agents-reverse-engineer/traces/\\` |\n**Usage:**\n- \\`COMMAND_PREFIXrebuild --dry-run\\` — Preview rebuild plan\n- \\`COMMAND_PREFIXrebuild --output ./out --force\\` — Rebuild to custom directory\n\n**CLI:**\n\\`\\`\\`bash\nnpx are rebuild --dry-run\nnpx are rebuild --output ./out --force\nnpx are rebuild --concurrency 3\n\\`\\`\\`\n\n**How it works:**\n1. Reads all spec files from \\`specs/\\` directory\n2. Partitions specs into ordered rebuild units (from Build Plan phases or top-level headings)\n3. Processes units in order: sequentially between groups, concurrently within each group\n4. Accumulates context (export signatures) after each group for dependent phases\n5. Writes generated source files via \\`===FILE:===\\` delimited output parsing\n\n**Exit codes:** 0 (success), 1 (partial failure), 2 (total failure)\n\n---\n\n### \\`COMMAND_PREFIXclean\\`\nRemove all generated documentation artifacts.\n\n**Options:**\n| Flag | Description |\n|------|-------------|\n| \\`--dry-run\\` | Show what would be deleted without deleting |\n\n**What gets deleted:**\n- \\`.agents-reverse-engineer/GENERATION-PLAN.md\\`\n- All \\`*.sum\\` files\n- All \\`AGENTS.md\\` files\n- Pointers: \\`CLAUDE.md\\`\n\n**Usage:**\n- \\`COMMAND_PREFIXclean --dry-run\\` — Preview deletions\n- \\`COMMAND_PREFIXclean\\` — Delete all artifacts\n\n**CLI:**\n\\`\\`\\`bash\nnpx are clean --dry-run\nnpx are clean\n\\`\\`\\`\n\n---\n\n### \\`COMMAND_PREFIXhelp\\`\nShow this command reference.\n\n## CLI Installation\n\nInstall ARE commands to your AI assistant:\n\n\\`\\`\\`bash\nnpx agents-reverse-engineer install              # Interactive mode\nnpx agents-reverse-engineer install --runtime claude -g  # Global Claude\nnpx agents-reverse-engineer install --runtime claude -l  # Local project\nnpx agents-reverse-engineer install --runtime all -g     # All runtimes\n\\`\\`\\`\n\n**Install/Uninstall Options:**\n| Flag | Description |\n|------|-------------|\n| \\`--runtime <name>\\` | Target: \\`claude\\`, \\`opencode\\`, \\`gemini\\`, \\`all\\` |\n| \\`-g, --global\\` | Install to global config directory |\n| \\`-l, --local\\` | Install to current project directory |\n| \\`--force\\` | Overwrite existing files (install only) |\n\n## Configuration\n\n**File:** \\`.agents-reverse-engineer/config.yaml\\`\n\n\\`\\`\\`yaml\n# Exclusion patterns\nexclude:\n  patterns:\n    - \"**/*.test.ts\"\n    - \"**/__mocks__/**\"\n  vendorDirs:\n    - node_modules\n    - dist\n    - .git\n  binaryExtensions:\n    - .png\n    - .jpg\n    - .pdf\n\n# Options\noptions:\n  followSymlinks: false\n  maxFileSize: 100000\n\n# Output settings\noutput:\n  colors: true\n\\`\\`\\`\n\n## Generated Files\n\n### Per Source File\n\n**\\`*.sum\\`** — File summaries with YAML frontmatter + detailed prose.\n\n\\`\\`\\`yaml\n---\nfile_type: service\ngenerated_at: 2025-01-15T10:30:00Z\ncontent_hash: abc123...\npurpose: Handles user authentication and session management\npublic_interface: [login(), logout(), refreshToken(), AuthService]\ndependencies: [express, jsonwebtoken, ./user-model]\npatterns: [singleton, factory, observer]\nrelated_files: [./types.ts, ./middleware.ts]\n---\n\n<300-500 word summary covering implementation, patterns, edge cases>\n\\`\\`\\`\n\n### Per Directory\n\n**\\`AGENTS.md\\`** — Directory overview synthesized from \\`.sum\\` files. Groups files by purpose and links to subdirectories.\n\n### Pointer Files\n\n| File | Purpose |\n|------|---------|\n| \\`CLAUDE.md\\` | Project entry point — imports root AGENTS.md |\n\n## Common Workflows\n\n**Initial documentation:**\n\\`\\`\\`\nCOMMAND_PREFIXinit\nCOMMAND_PREFIXgenerate\n\\`\\`\\`\n\n**After code changes:**\n\\`\\`\\`\nCOMMAND_PREFIXupdate\n\\`\\`\\`\n\n**Full regeneration:**\n\\`\\`\\`\nCOMMAND_PREFIXclean\nCOMMAND_PREFIXgenerate\n\\`\\`\\`\n\n**Preview before generating:**\n\\`\\`\\`\nCOMMAND_PREFIXdiscover                   # Check files and exclusions\nCOMMAND_PREFIXgenerate --dry-run         # Preview generation\n\\`\\`\\`\n\n## Tips\n\n- **Custom exclusions**: Edit \\`.agents-reverse-engineer/config.yaml\\` to skip files\n- **Hook auto-update**: Install creates a session-end hook that auto-runs update\n\n## Resources\n\n- **Repository:** https://github.com/GeoloeG-IsT/agents-reverse-engineer\n- **Update:** \\`npx agents-reverse-engineer@latest install --force\\`\n</reference>`,\n  },\n} as const;\n\n// =============================================================================\n// Platform-specific template generators\n// =============================================================================\n\ntype Platform = 'claude' | 'opencode' | 'gemini';\n\ninterface PlatformConfig {\n  commandPrefix: string; // /are- (claude, opencode) or /are: (gemini)\n  pathPrefix: string; // .claude/commands/are/ or .opencode/commands/ etc\n  filenameSeparator: string; // . or -\n  extraFrontmatter?: string; // e.g., \"agent: build\" for OpenCode\n  usesName: boolean; // Claude uses \"name:\" in frontmatter\n  versionFilePath: string; // .claude/ARE-VERSION, .opencode/ARE-VERSION, etc.\n}\n\nconst PLATFORM_CONFIGS: Record<Platform, PlatformConfig> = {\n  claude: {\n    commandPrefix: '/are-',\n    pathPrefix: '.claude/skills/',\n    filenameSeparator: '.',\n    usesName: true,\n    versionFilePath: '.claude/ARE-VERSION',\n  },\n  opencode: {\n    commandPrefix: '/are-',\n    pathPrefix: '.opencode/commands/',\n    filenameSeparator: '-',\n    extraFrontmatter: 'agent: build',\n    usesName: false,\n    versionFilePath: '.opencode/ARE-VERSION',\n  },\n  gemini: {\n    commandPrefix: '/are-',\n    pathPrefix: '.gemini/commands/',\n    filenameSeparator: '-',\n    usesName: false,\n    versionFilePath: '.gemini/ARE-VERSION',\n  },\n};\n\nfunction buildFrontmatter(\n  platform: Platform,\n  commandName: string,\n  description: string\n): string {\n  const config = PLATFORM_CONFIGS[platform];\n  const lines = ['---'];\n\n  if (config.usesName) {\n    lines.push(`name: are-${commandName}`);\n  }\n\n  lines.push(`description: ${description}`);\n\n  if (config.extraFrontmatter) {\n    lines.push(config.extraFrontmatter);\n  }\n\n  lines.push('---');\n  return lines.join('\\n');\n}\n\n/**\n * Build TOML content for Gemini CLI commands\n *\n * Gemini uses TOML format with description and prompt fields.\n * See: https://geminicli.com/docs/cli/custom-commands/\n */\nfunction buildGeminiToml(\n  commandName: string,\n  command: (typeof COMMANDS)[keyof typeof COMMANDS]\n): string {\n  const config = PLATFORM_CONFIGS.gemini;\n  // Replace placeholders in content\n  const promptContent = command.content\n    .replace(/COMMAND_PREFIX/g, config.commandPrefix)\n    .replace(/VERSION_FILE_PATH/g, config.versionFilePath);\n\n  // Build TOML content\n  // Use triple quotes for multi-line prompt\n  const lines = [`description = \"${command.description}\"`];\n\n  if (command.argumentHint) {\n    lines.push(`# Arguments: ${command.argumentHint}`);\n  }\n\n  lines.push(`prompt = \"\"\"`);\n  lines.push(promptContent);\n  lines.push(`\"\"\"`);\n\n  return lines.join('\\n');\n}\n\nfunction buildTemplate(\n  platform: Platform,\n  commandName: string,\n  command: (typeof COMMANDS)[keyof typeof COMMANDS]\n): IntegrationTemplate {\n  const config = PLATFORM_CONFIGS[platform];\n\n  // Platform-specific file naming:\n  // - Claude: .claude/skills/are-{command}/SKILL.md\n  // - OpenCode: .opencode/commands/are-{command}.md\n  // - Gemini: .gemini/commands/are-{command}.toml (TOML format)\n  if (platform === 'gemini') {\n    const filename = `are-${commandName}.toml`;\n    const path = `${config.pathPrefix}${filename}`;\n    const content = buildGeminiToml(commandName, command);\n\n    return {\n      filename,\n      path,\n      content: `${content}\\n`,\n    };\n  }\n\n  const filename = platform === 'claude' ? 'SKILL.md' : `are-${commandName}.md`;\n  const path =\n    platform === 'claude'\n      ? `${config.pathPrefix}are-${commandName}/${filename}`\n      : `${config.pathPrefix}${filename}`;\n\n  const frontmatter = buildFrontmatter(\n    platform,\n    commandName,\n    command.description\n  );\n\n  // Replace placeholders in content\n  const content = command.content\n    .replace(/COMMAND_PREFIX/g, config.commandPrefix)\n    .replace(/VERSION_FILE_PATH/g, config.versionFilePath);\n\n  return {\n    filename,\n    path,\n    content: `${frontmatter}\\n\\n${content}\\n`,\n  };\n}\n\nfunction getTemplatesForPlatform(platform: Platform): IntegrationTemplate[] {\n  return Object.entries(COMMANDS).map(([name, command]) =>\n    buildTemplate(platform, name, command)\n  );\n}\n\n// =============================================================================\n// Public API\n// =============================================================================\n\n/**\n * Get Claude Code command file templates\n */\nexport function getClaudeTemplates(): IntegrationTemplate[] {\n  return getTemplatesForPlatform('claude');\n}\n\n/**\n * Get OpenCode command file templates\n */\nexport function getOpenCodeTemplates(): IntegrationTemplate[] {\n  return getTemplatesForPlatform('opencode');\n}\n\n/**\n * Get Gemini CLI command file templates\n */\nexport function getGeminiTemplates(): IntegrationTemplate[] {\n  return getTemplatesForPlatform('gemini');\n}\n\n\n```\n\nLead with a single bold purpose statement: **[FileName] does X.**\nThen use ## headings to organize the remaining content.\nEvery file MUST include at minimum:\n- A purpose statement (first line, bold)\n- Exported symbols with signatures (under any appropriate heading)\nChoose additional sections based on file content.\n\n## Existing Summary (update this — preserve stable content, modify only what changed)\n\n**Generates AI coding assistant integration templates for eight ARE commands (`init`, `discover`, `generate`, `update`, `specify`, `rebuild`, `clean`, `help`) targeting three platforms (Claude Code, OpenCode, Gemini CLI) with platform-specific frontmatter, path conventions, and execution instructions.**\n\n## Exports\n\n**`getClaudeTemplates()`** → `IntegrationTemplate[]` — returns array of templates for `.claude/skills/are-{command}/SKILL.md` files with `name:` frontmatter and `/are-` prefix.\n\n**`getOpenCodeTemplates()`** → `IntegrationTemplate[]` — returns array of templates for `.opencode/commands/are-{command}.md` files with `agent: build` frontmatter, dash-separated filenames, `/are-` prefix.\n\n**`getGeminiTemplates()`** → `IntegrationTemplate[]` — returns array of templates for `.gemini/commands/are-{command}.toml` files in TOML format (`description = \"...\"`, `prompt = \"\"\"...\"\"\"`), `/are-` prefix.\n\n## Command Template Definitions\n\n**`COMMANDS`** — readonly object mapping eight command names to `{description, argumentHint, content}` structures. Each `content` field contains multi-paragraph markdown with `<execution>` sections defining AI assistant workflows, `COMMAND_PREFIX` and `VERSION_FILE_PATH` template variables.\n\n### Command Entries\n\n**`generate`** — description: \"Generate AI-friendly documentation for the entire codebase\", argumentHint: `[path] [--dry-run] [--concurrency N] [--fail-fast] [--debug] [--trace]`, content: 4-step workflow (display version from `VERSION_FILE_PATH`, run `npx agents-reverse-engineer@latest generate $ARGUMENTS` with `run_in_background: true`, poll `.agents-reverse-engineer/progress.log` every 15s showing \"X/Y files analyzed, ~Zm remaining\", summarize completion with file/directory counts and quality warnings). Describes two-phase pipeline: concurrent file `.sum` analysis with YAML frontmatter, post-order `AGENTS.md` aggregation.\n\n**`update`** — description: \"Incrementally update documentation for changed files\", argumentHint: `[path] [--uncommitted] [--dry-run] [--concurrency N] [--fail-fast] [--debug] [--trace]`, content: mirrors `generate` workflow structure, polls progress.log showing \"X/Y files updated, ~Zm remaining\", summarizes files updated/unchanged/orphaned.\n\n**`init`** — description: \"Initialize agents-reverse-engineer configuration\", argumentHint: \"\" (no arguments), content: 2-step workflow (display version, run `npx agents-reverse-engineer@latest init`), creates `.agents-reverse-engineer/config.yaml`.\n\n**`discover`** — description: \"Discover files in codebase\", argumentHint: `[path] [--debug] [--trace]`, content: 5-step workflow with **STRICT RULES** preamble (\"DO NOT add ANY flags the user did not explicitly type\"), runs `discover $ARGUMENTS` in background, polls progress.log, reads `GENERATION-PLAN.md` and `config.yaml`, classifies Phase 1 files into seven categories (test/spec: `*.test.*`, `*.spec.*`, `__tests__/**`, `__mocks__/**`, `*.stories.*`, `*.story.*`; CI/CD: `.github/workflows/*.yml`, `.gitlab-ci.yml`, `Jenkinsfile`, `.circleci/**`, `.travis.yml`; tool configs: `.eslintrc*`, `.prettierrc*`, `jest.config.*`, `.editorconfig`, `babel.config.*`, `webpack.config.*`, `vite.config.*`, `rollup.config.*`, `tsconfig*.json`, `.lintstagedrc*`, `.huskyrc*`, `.stylelintrc*`, `commitlint.config.*`; migrations: paths containing `migrations/` or `*.migration.*`; fixtures/snapshots: `__snapshots__/**`, `*.fixture.*`, `fixtures/**`, `test-data/**`, `testdata/**`; type declarations: `*.d.ts`; Docker/infra: `Dockerfile*`, `docker-compose*`, `*.Dockerfile`, `k8s/**`, `terraform/**`, `helm/**`), presents summary table with counts/examples/proposed globs, uses `AskUserQuestion` with `multiSelect: true`, appends accepted patterns to `config.yaml` via Edit tool.\n\n**`clean`** — description: \"Delete all generated documentation artifacts (.sum, AGENTS.md, plan)\", argumentHint: `[path] [--dry-run]`, content: **STRICT RULES** enforcing exact `clean $ARGUMENTS` invocation, displays version, runs command, reports deletion count.\n\n**`specify`** — description: \"Generate project specification from AGENTS.md docs\", argumentHint: `[path] [--dry-run] [--output <path>] [--multi-file] [--force] [--debug] [--trace]`, content: 4-step background workflow polling progress.log, summarizes AGENTS.md file count and output paths, auto-runs `generate` if no AGENTS.md exist.\n\n**`rebuild`** — description: \"Reconstruct project from specification documents\", argumentHint: `[path] [--dry-run] [--output <path>] [--force] [--concurrency N] [--fail-fast] [--debug] [--trace]`, content: 4-step background workflow showing \"X/Y rebuild units completed\", reads `specs/`, partitions into ordered units, processes via AI, exit codes 0/1/2.\n\n**`help`** — description: \"Show available ARE commands and usage guide\", argumentHint: \"\" (no arguments), content: `<objective>` section mandating display version first then output `<reference>` block with NO additional commentary. Reference block contains comprehensive command documentation: Quick Start (init → generate → update), eight command entries with usage tables showing flags/descriptions (e.g., `--concurrency N`, `--dry-run`, `--uncommitted`, `--multi-file`, `--force`), CLI installation instructions (`npx agents-reverse-engineer install --runtime <rt> -g|-l`), config.yaml schema example (exclude.patterns, vendorDirs, binaryExtensions, options, output.colors), generated file formats (*.sum YAML frontmatter structure, AGENTS.md, CLAUDE.md pointer table), common workflows (initial: init+generate, after changes: update, full regen: clean+generate), tips (custom exclusions, hook auto-update), resources (GitHub repo, update command).\n\n## Platform-Specific Configuration\n\n**`PLATFORM_CONFIGS`** — readonly record mapping `'claude' | 'opencode' | 'gemini'` to `PlatformConfig` structures.\n\n**`PlatformConfig`** — interface defining `commandPrefix: string` (/are- for all platforms), `pathPrefix: string` (.claude/skills/, .opencode/commands/, .gemini/commands/), `filenameSeparator: string` (. for Claude, - for OpenCode/Gemini), `extraFrontmatter?: string` (\"agent: build\" for OpenCode only), `usesName: boolean` (true for Claude, false for OpenCode/Gemini), `versionFilePath: string` (.claude/ARE-VERSION, .opencode/ARE-VERSION, .gemini/ARE-VERSION).\n\n**Claude config**: `commandPrefix: '/are-'`, `pathPrefix: '.claude/skills/'`, `filenameSeparator: '.'`, `usesName: true`, `versionFilePath: '.claude/ARE-VERSION'` — creates `.claude/skills/are-{command}/SKILL.md` directories.\n\n**OpenCode config**: `commandPrefix: '/are-'`, `pathPrefix: '.opencode/commands/'`, `filenameSeparator: '-'`, `extraFrontmatter: 'agent: build'`, `usesName: false`, `versionFilePath: '.opencode/ARE-VERSION'` — creates `.opencode/commands/are-{command}.md` flat files.\n\n**Gemini config**: `commandPrefix: '/are-'`, `pathPrefix: '.gemini/commands/'`, `filenameSeparator: '-'`, `usesName: false`, `versionFilePath: '.gemini/ARE-VERSION'` — creates `.gemini/commands/are-{command}.toml` TOML files.\n\n## Template Generation Logic\n\n**`buildFrontmatter(platform, commandName, description)`** → `string` — constructs markdown frontmatter: adds `name: are-{command}` if `config.usesName` true, always adds `description:`, optionally appends `config.extraFrontmatter`, wraps in `---` delimiters. Used by Claude/OpenCode markdown templates.\n\n**`buildGeminiToml(commandName, command)`** → `string` — constructs TOML format: single-line `description = \"...\"`, optional `# Arguments:` comment for `argumentHint`, triple-quoted `prompt = \"\"\"...\"\"\"` block containing `command.content` with placeholders replaced. Returns concatenated string with newlines.\n\n**`buildTemplate(platform, commandName, command)`** → `IntegrationTemplate` — branches on platform: for Gemini calls `buildGeminiToml()` returning `{filename: 'are-{command}.toml', path: '.gemini/commands/are-{command}.toml', content}`, for Claude/OpenCode calls `buildFrontmatter()` returning `{filename: 'SKILL.md' | 'are-{command}.md', path: '.claude/skills/are-{command}/SKILL.md' | '.opencode/commands/are-{command}.md', content: frontmatter + '\\n\\n' + replacedContent + '\\n'}`. Replaces `COMMAND_PREFIX` → `config.commandPrefix`, `VERSION_FILE_PATH` → `config.versionFilePath` in `command.content`.\n\n**`getTemplatesForPlatform(platform)`** → `IntegrationTemplate[]` — maps `Object.entries(COMMANDS)` to `buildTemplate(platform, name, command)` calls, returns array of eight templates.\n\n## Template Variable Substitution\n\nAll command `content` strings contain two placeholders replaced at template build time:\n\n**`COMMAND_PREFIX`** — replaced with platform-specific prefix (`/are-` for all current platforms).\n\n**`VERSION_FILE_PATH`** — replaced with platform-specific version file path (`.claude/ARE-VERSION`, `.opencode/ARE-VERSION`, `.gemini/ARE-VERSION`).\n\n## Workflow Instructions\n\n**Background execution pattern** (generate, update, discover, specify, rebuild): all use identical 4-step structure: (1) read `VERSION_FILE_PATH` and display \"agents-reverse-engineer vX.Y.Z\", (2) run `npx agents-reverse-engineer@latest {command} $ARGUMENTS` with `run_in_background: true`, (3) poll `.agents-reverse-engineer/progress.log` every 10-15s using Read tool with `offset` parameter reading last ~20 lines, show brief progress updates, check TaskOutput with `block: false` until completion, keep polling even if progress.log doesn't exist yet, (4) on completion read full background task output and summarize results.\n\n**Synchronous execution** (init, clean): read version file, run command directly without background flag, report outcome.\n\n**Interactive workflow** (discover command only): after background task completes, reads `GENERATION-PLAN.md` and `config.yaml`, scans Phase 1 file list, classifies into seven categories with regex patterns, counts matches per category showing up to 3 examples, skips categories with zero matches or already-excluded patterns, presents summary table, invokes `AskUserQuestion` with `multiSelect: true` to select categories, uses Edit tool to append chosen glob patterns to `config.yaml` `exclude.patterns` array, confirms additions.\n\n## File Format Outputs\n\n**Claude**: directory structure `.claude/skills/are-{command}/SKILL.md` containing frontmatter with `name:` and `description:`, followed by content block.\n\n**OpenCode**: flat structure `.opencode/commands/are-{command}.md` containing frontmatter with `description:` and `agent: build`, followed by content block.\n\n**Gemini**: flat structure `.gemini/commands/are-{command}.toml` in TOML format with `description` field and triple-quoted `prompt` field, optional `# Arguments:` comment.\n\n## Dependencies\n\nImports `IntegrationTemplate` type from `./types.js` (defines `{filename: string, path: string, content: string}` structure).",
      "systemPrompt": "You are updating an existing file summary for an AI coding assistant. The source code has changed and the summary needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING summary and the UPDATED source code\n- Preserve the structure, section headings, and phrasing of the existing summary wherever the underlying code is unchanged\n- Only modify content that is directly affected by the code changes\n- If a section describes code that has not changed, keep it VERBATIM — do not rephrase, reorganize, or \"improve\" stable text\n- Add new sections only if the code changes introduce entirely new concepts\n- Remove sections only if the code they described has been deleted\n- Update signatures, type names, and identifiers to match the current source exactly\n\nBEHAVIORAL CONTRACT PRESERVATION (MANDATORY):\n- Regex patterns, format strings, magic constants, and template content from the existing summary MUST be preserved verbatim unless the source code changed them\n- If source code changes a regex pattern or constant, update the summary to show the NEW value verbatim\n- Never summarize or paraphrase regex patterns — always show the exact pattern in backticks\n\nWORKFLOW & CONVENTION RULE PRESERVATION (MANDATORY):\n- Contribution guidelines, testing mandates, PR conventions, code conventions, and AI agent instructions from the existing summary MUST be preserved verbatim unless the source file changed them\n\n\nTARGET LENGTH (MANDATORY):\n- Source file: 28726 characters\n- Target summary: ~7182 characters (25% compression)\n- Maximum: 8618 characters\n- Achieve this by: ultra-dense writing, minimal examples, single-sentence descriptions\n\nULTRA-COMPRESSION TECHNIQUES:\n- Use telegraphic style: \"exports foo, bar, baz\" not \"this file exports three functions\"\n- No code examples unless critical to understanding\n- One sentence per export maximum\n- Omit obvious parameter names (\"opts: Options\" not \"options: Options - configuration object\")\n- Use abbreviations: \"params\" not \"parameters\", \"config\" not \"configuration\"\n- Skip section if empty (don't write \"No special concerns\" or \"N/A\")\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this file\", \"this module\", \"provides\", \"responsible for\", \"is used to\", \"basically\", \"essentially\", \"provides functionality for\"\n- Use the pattern: \"[ExportName] does X\" not \"The ExportName function is responsible for doing X\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- All exported function/class/type/const names MUST appear in the summary exactly as written in source\n- Key parameter types and return types MUST be mentioned\n- Preserve exact casing of identifiers\n- Missing any exported identifier is a failure\n\nOUTPUT FORMAT (MANDATORY):\n- Start your response DIRECTLY with the purpose statement — a single bold line: **Purpose statement here.**\n- Do NOT include any preamble, thinking, or meta-commentary before the purpose statement\n- Do NOT say \"Here is...\", \"Now I'll...\", \"Based on my analysis...\", \"Let me create...\", \"Perfect.\"\n- Your response IS the documentation — not a message about the documentation",
      "response": "**Generates AI assistant integration templates for eight ARE commands (`init`, `discover`, `generate`, `update`, `specify`, `rebuild`, `clean`, `help`) targeting Claude Code, OpenCode, and Gemini CLI, with platform-specific frontmatter (YAML vs TOML), path conventions (.claude/skills/, .opencode/commands/, .gemini/commands/), and background execution workflows.**\n\n## Exports\n\n**`getClaudeTemplates()`** → `IntegrationTemplate[]` — returns templates for `.claude/skills/are-{command}/SKILL.md` with `name:` frontmatter.\n\n**`getOpenCodeTemplates()`** → `IntegrationTemplate[]` — returns templates for `.opencode/commands/are-{command}.md` with `agent: build` frontmatter.\n\n**`getGeminiTemplates()`** → `IntegrationTemplate[]` — returns templates for `.gemini/commands/are-{command}.toml` in TOML format (`description = \"...\"`, `prompt = \"\"\"...\"\"\"`).\n\n## Command Definitions\n\n**`COMMANDS`** — readonly object mapping eight command names to `{description: string, argumentHint: string, content: string}`. `content` contains markdown with `<execution>` sections, template variables `COMMAND_PREFIX`, `VERSION_FILE_PATH`.\n\n**`generate`** — \"Generate AI-friendly documentation for the entire codebase\", args `[path] [--dry-run] [--concurrency N] [--fail-fast] [--debug] [--trace]`, 5-step workflow: display version from `VERSION_FILE_PATH`, delete `.agents-reverse-engineer/progress.log`, run `npx agents-reverse-engineer@latest generate $ARGUMENTS` with `run_in_background: true`, poll progress.log every 15s showing \"X/Y files analyzed, ~Zm remaining\" (Read tool with `offset`, TaskOutput with `block: false`), summarize file/directory counts and quality warnings. Describes two-phase pipeline: concurrent `.sum` file analysis with YAML frontmatter (`content_hash`, `file_type`, `purpose`, `public_interface`, `dependencies`, `patterns`), post-order `AGENTS.md` aggregation + `CLAUDE.md` pointers.\n\n**`update`** — \"Incrementally update documentation for changed files\", args `[path] [--uncommitted] [--dry-run] [--concurrency N] [--fail-fast] [--debug] [--trace]`, mirrors `generate` 5-step workflow, shows \"X/Y files updated, ~Zm remaining\", summarizes files updated/unchanged/orphaned.\n\n**`init`** — \"Initialize agents-reverse-engineer configuration\", no args, 2-step: display version, run `npx agents-reverse-engineer@latest init`, creates `.agents-reverse-engineer/config.yaml`.\n\n**`discover`** — \"Discover files in codebase\", args `[path] [--debug] [--trace]`, 6-step workflow with **STRICT RULES** preamble (\"DO NOT add ANY flags the user did not explicitly type\"), runs `discover $ARGUMENTS` in background, polls progress.log every 10s, reads `GENERATION-PLAN.md` and `config.yaml`, classifies Phase 1 files into seven categories with regex patterns: test/spec (`*.test.*`, `*.spec.*`, `__tests__/**`, `__mocks__/**`, `*.stories.*`, `*.story.*`), CI/CD (`.github/workflows/*.yml`, `.gitlab-ci.yml`, `Jenkinsfile`, `.circleci/**`, `.travis.yml`), tool configs (`.eslintrc*`, `.prettierrc*`, `jest.config.*`, `.editorconfig`, `babel.config.*`, `webpack.config.*`, `vite.config.*`, `rollup.config.*`, `tsconfig*.json`, `.lintstagedrc*`, `.huskyrc*`, `.stylelintrc*`, `commitlint.config.*`), migrations (paths containing `migrations/` or `*.migration.*`), fixtures/snapshots (`__snapshots__/**`, `*.fixture.*`, `fixtures/**`, `test-data/**`, `testdata/**`), type declarations (`*.d.ts`), Docker/infra (`Dockerfile*`, `docker-compose*`, `*.Dockerfile`, `k8s/**`, `terraform/**`, `helm/**`). Presents summary table with counts/examples/proposed globs, skips categories with zero matches or already-excluded patterns, uses `AskUserQuestion` with `multiSelect: true`, appends accepted patterns to `config.yaml` `exclude.patterns` via Edit tool.\n\n**`clean`** — \"Delete all generated documentation artifacts (.sum, AGENTS.md, plan)\", args `[path] [--dry-run]`, **STRICT RULES** enforcing exact `clean $ARGUMENTS` invocation with zero added flags, displays version, runs command, reports deletion count. Deletes `.agents-reverse-engineer/GENERATION-PLAN.md`, `*.sum`, `AGENTS.md`, `CLAUDE.md`.\n\n**`specify`** — \"Generate project specification from AGENTS.md docs\", args `[path] [--dry-run] [--output <path>] [--multi-file] [--force] [--debug] [--trace]`, 5-step background workflow deleting progress.log, running command, polling every 15s, summarizing AGENTS.md file count and output paths. Auto-runs `generate` if no AGENTS.md exist. Options: `--output` (default specs/SPEC.md), `--multi-file` (split into multiple files).\n\n**`rebuild`** — \"Reconstruct project from specification documents\", args `[path] [--dry-run] [--output <path>] [--force] [--concurrency N] [--fail-fast] [--debug] [--trace]`, 5-step background workflow showing \"X/Y rebuild units completed\", reads `specs/`, partitions into ordered units via `===FILE: path===`/`===END_FILE===` delimiter parsing, processes sequentially between groups with concurrent pool per group, exit codes 0 (success), 1 (partial failure), 2 (total failure). Options: `--output` (default rebuild/), `--force` (wipe output directory).\n\n**`help`** — \"Show available ARE commands and usage guide\", no args, `<objective>` section mandating display version first, output `<reference>` block with NO additional commentary. Reference: Quick Start (init → generate → update), eight command entries with flag tables (`--concurrency N`, `--dry-run`, `--uncommitted`, `--multi-file`, `--force`, `--fail-fast`, `--debug`, `--trace`), CLI installation (`npx agents-reverse-engineer install --runtime <claude|opencode|gemini|all> -g|-l`, flags: `--runtime`, `-g/--global`, `-l/--local`, `--force`), config.yaml schema (exclude.patterns, vendorDirs, binaryExtensions, options.followSymlinks/maxFileSize, output.colors), generated file formats (*.sum YAML frontmatter: `file_type`, `generated_at`, `content_hash`, `purpose`, `public_interface`, `dependencies`, `patterns`, `related_files`; AGENTS.md directory overviews; CLAUDE.md pointer), common workflows (initial: init+generate, after changes: update, full regen: clean+generate, preview: discover+generate --dry-run), tips (custom exclusions via config.yaml, hook auto-update), resources (GitHub repo https://github.com/GeoloeG-IsT/agents-reverse-engineer, update: `npx agents-reverse-engineer@latest install --force`).\n\n## Platform Configuration\n\n**`PLATFORM_CONFIGS`** — readonly `Record<'claude' | 'opencode' | 'gemini', PlatformConfig>`.\n\n**`PlatformConfig`** — interface: `commandPrefix: string` (/are- for all), `pathPrefix: string`, `filenameSeparator: string`, `extraFrontmatter?: string`, `usesName: boolean`, `versionFilePath: string`.\n\n**Claude**: `pathPrefix: '.claude/skills/'`, `filenameSeparator: '.'`, `usesName: true`, `versionFilePath: '.claude/ARE-VERSION'` → `.claude/skills/are-{command}/SKILL.md`.\n\n**OpenCode**: `pathPrefix: '.opencode/commands/'`, `filenameSeparator: '-'`, `extraFrontmatter: 'agent: build'`, `usesName: false`, `versionFilePath: '.opencode/ARE-VERSION'` → `.opencode/commands/are-{command}.md`.\n\n**Gemini**: `pathPrefix: '.gemini/commands/'`, `filenameSeparator: '-'`, `usesName: false`, `versionFilePath: '.gemini/ARE-VERSION'` → `.gemini/commands/are-{command}.toml`.\n\n## Template Generation\n\n**`buildFrontmatter(platform, commandName, description)`** → `string` — YAML frontmatter wrapped in `---`: adds `name: are-{command}` if `config.usesName`, always adds `description:`, appends `config.extraFrontmatter` if present.\n\n**`buildGeminiToml(commandName, command)`** → `string` — TOML format: `description = \"...\"` line, optional `# Arguments:` comment if `argumentHint`, triple-quoted `prompt = \"\"\"...\"\"\"` with placeholder-replaced `command.content`.\n\n**`buildTemplate(platform, commandName, command)`** → `IntegrationTemplate` — branches: Gemini calls `buildGeminiToml()` returning `{filename: 'are-{command}.toml', path: '.gemini/commands/are-{command}.toml', content}`; Claude/OpenCode calls `buildFrontmatter()` returning `{filename: 'SKILL.md' | 'are-{command}.md', path: '.claude/skills/are-{command}/SKILL.md' | '.opencode/commands/are-{command}.md', content: frontmatter + '\\n\\n' + replacedContent + '\\n'}`. Replaces `COMMAND_PREFIX` → `config.commandPrefix`, `VERSION_FILE_PATH` → `config.versionFilePath`.\n\n**`getTemplatesForPlatform(platform)`** → `IntegrationTemplate[]` — maps `Object.entries(COMMANDS)` to `buildTemplate(platform, name, command)`.\n\n## Workflow Patterns\n\n**Background execution** (generate, update, discover, specify, rebuild): (1) read `VERSION_FILE_PATH`, display \"agents-reverse-engineer vX.Y.Z\", (2) delete `.agents-reverse-engineer/progress.log`, (3) run `npx agents-reverse-engineer@latest {command} $ARGUMENTS` with `run_in_background: true`, (4) poll progress.log every 10-15s via Read tool with `offset` (last ~20 lines), TaskOutput with `block: false`, keep polling if file absent, (5) summarize completion.\n\n**Synchronous execution** (init, clean): read version, run command, report.\n\n**Interactive post-processing** (discover): after background completion, reads GENERATION-PLAN.md + config.yaml, scans Phase 1 files, classifies into seven categories, counts matches with up to 3 examples each, skips zero-match or already-excluded categories, presents table, invokes `AskUserQuestion` (`multiSelect: true`), uses Edit tool to append globs to `config.yaml` `exclude.patterns`.\n\n## Dependencies\n\nImports `IntegrationTemplate` from `./types.js` (`{filename: string, path: string, content: string}`).",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 2782,
      "cacheReadTokens": 0,
      "cacheCreationTokens": 35349,
      "latencyMs": 42473,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": [
        {
          "path": "src/integration/templates.ts",
          "sizeBytes": 28766
        }
      ]
    },
    {
      "timestamp": "2026-02-12T08:36:32.074Z",
      "prompt": "Generate AGENTS.md for directory: \"src/installer\" (installer)\n\n## File Summaries (7 files)\n\n### banner.ts\n**Purpose:** Installer terminal UI module providing ASCII banner display, help text formatter, and styled message helpers (success...\n\n**Installer terminal UI module providing ASCII banner display, help text formatter, and styled message helpers (success/error/warning/info/next-steps) using picocolors.**\n\n## Exports\n\n`VERSION: string` — Package version from `getVersion()` (package.json).\n\n`displayBanner(): void` — Renders green ASCII \"ARE\" art + version + tagline via `pc.green()` for 7-line box-drawing characters (U+25XX block).\n\n`showHelp(): void` — Prints usage syntax, options table (`--runtime`, `-g`, `-l`, `-u`, `--force`, `-q`, `-h`), three example command invocations (interactive mode, Claude global install, all-runtime local install, global uninstall).\n\n`showSuccess(msg: string): void` — Logs `pc.green('✓') + ' ' + msg`.\n\n`showError(msg: string): void` — Logs `pc.red('✗') + ' ' + msg`.\n\n`showWarning(msg: string): void` — Logs `pc.yellow('!') + ' ' + msg`.\n\n`showInfo(msg: string): void` — Logs `pc.cyan('>') + ' ' + msg`.\n\n`showNextSteps(runtime: string, filesCreated: number): void` — Displays 7-step post-install guide (verify with `/are-help`, run `/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`) + GitHub docs link, shows runtime and file count via `pc.dim()`.\n\n## Dependencies\n\n`picocolors` — Terminal color formatting (`green`, `red`, `yellow`, `cyan`, `dim`, `bold`).\n\n`../version.js` — `getVersion()` reads package.json version field.\n\n## Integration\n\nCalled by `src/installer/index.ts` during interactive/non-interactive install flows. Banner suppressed when `--quiet` flag set. Next steps shown on successful install completion with file count from operation results.\n### index.ts\n**Purpose:** Orchestrates npx installation workflow supporting both interactive prompts (runtime/location selection) and non-inter...\n\n**Orchestrates npx installation workflow supporting both interactive prompts (runtime/location selection) and non-interactive CI mode (flag-based), routing to install/uninstall operations with post-action verification and styled terminal output.**\n\n## Exported Interface\n\n`parseInstallerArgs(args: string[]): InstallerArgs` — Parses CLI args supporting `--runtime <value>`, `-g/--global`, `-l/--local`, `--force`, `-q/--quiet`, `-h/--help` flags. Validates runtime against `['claude', 'opencode', 'gemini', 'all']`, returns structured InstallerArgs. Sets `uninstall: false` (command-level flag, not arg-level).\n\n`runInstaller(args: InstallerArgs): Promise<InstallerResult[]>` — Main entry point routing install/uninstall workflows. Displays banner unless `args.quiet`, exits early on `args.help` via `showHelp()`. Non-interactive mode requires `--runtime` + location flag or exits with code 1. Interactive mode calls `selectRuntime(mode)` / `selectLocation(mode)` for missing values. Routes to `runUninstall()` if `args.uninstall`, else `runInstall()`. Returns `InstallerResult[]` array (one per runtime/location pair).\n\nRe-exports types: `InstallerArgs`, `InstallerResult`, `Runtime`, `Location`, `RuntimePaths` from `./types.js`. Re-exports functions: `getRuntimePaths`, `getAllRuntimes`, `resolveInstallPath`, `getSettingsPath` from `./paths.js`, banner functions (`displayBanner`, `showHelp`, `showSuccess`, `showError`, `showWarning`, `showInfo`, `showNextSteps`, `VERSION`) from `./banner.js`, prompt functions (`selectRuntime`, `selectLocation`, `confirmAction`, `isInteractive`) from `./prompts.js`.\n\n## Internal Workflow Functions\n\n`determineLocation(args: InstallerArgs): Location | undefined` — Returns `'global'` if `args.global && !args.local`, `'local'` if `args.local && !args.global`, else `undefined` (requires prompt).\n\n`determineRuntimes(runtime: Runtime | undefined): Array<Exclude<Runtime, 'all'>>` — Returns empty array if no runtime, calls `getAllRuntimes()` if `runtime === 'all'`, else returns single-element array.\n\n`runInstall(runtime: Runtime, location: Location, force: boolean, quiet: boolean): Promise<InstallerResult[]>` — Calls `installFiles(runtime, location, { force, dryRun: false })`, verifies via `verifyInstallation(allCreatedFiles)`, displays missing files if `verification.success === false`, calls `displayInstallResults(results)` unless quiet.\n\n`runUninstall(runtime: Runtime, location: Location, quiet: boolean): InstallerResult[]` — Calls `uninstallFiles(runtime, location, false)`, `deleteConfigFolder(location, false)`, displays results via `displayUninstallResults()` unless quiet.\n\n## Display Handlers\n\n`displayInstallResults(results: InstallerResult[]): void` — Iterates results calling `showSuccess()` / `showError()` per runtime, aggregates `totalCreated`, `totalSkipped`, `hooksRegistered` counts, displays summary with `--force` hint for skipped files, calls `showNextSteps(primaryRuntime, totalCreated)` using `results[0]?.runtime || 'claude'`, prints GitHub docs URL.\n\n`displayUninstallResults(results: InstallerResult[], configDeleted: boolean = false): void` — Interprets `result.filesCreated` as deleted files (uninstall context), `result.hookRegistered` as hook unregistration status, shows per-runtime summaries, aggregates `totalDeleted` / `hooksUnregistered`, displays config folder deletion if `configDeleted === true`, shows \"No files were removed\" if zero deletions.\n\n## Integration Points\n\nDepends on `./operations.ts` (`installFiles`, `verifyInstallation`), `./uninstall.ts` (`uninstallFiles`, `deleteConfigFolder`), `./prompts.ts` (`isInteractive`, `selectRuntime`, `selectLocation`), `./banner.ts` (all show* functions), `./paths.ts` (`getAllRuntimes`). Called by `src/cli/index.ts` after command routing.\n\n## Error Handling\n\nNon-interactive mode: exits process with code 1 if `--runtime` or location flags missing, emitting error via `showError()`. Validation failure: exits with code 1 if runtime/location unresolved after prompts. Verification failure: displays warnings but does not exit (non-blocking).\n\n## Behavioral Contracts\n\nValid runtimes: `['claude', 'opencode', 'gemini', 'all']` (line 63).\n\nNon-interactive error messages:\n- `'Missing --runtime flag (required in non-interactive mode)'`\n- `'Missing -g/--global or -l/--local flag (required in non-interactive mode)'`\n- `'Unable to determine runtime and location'`\n\nVerification failure format: `'Installation verification failed - some files missing:'` followed by `'  Missing: ${missing}'` per item.\n\nGitHub docs URL: `'https://github.com/GeoloeG-IsT/agents-reverse-engineer'` (line 290).\n### operations.ts\n**Purpose:** Installer file operations: copies command templates and session hooks to runtime directories, registers hooks/permiss...\n\n**Installer file operations: copies command templates and session hooks to runtime directories, registers hooks/permissions in settings.json via jsonc-parser, tracks installed versions, formats installation results.**\n\n## Exports\n\n**installFiles**(runtime: Runtime, location: Location, options: InstallOptions): InstallerResult[] — dispatches to `installFilesForRuntime()` for each runtime if runtime='all', otherwise single-runtime install.\n\n**verifyInstallation**(files: string[]): { success: boolean; missing: string[] } — filters files via `existsSync()`, returns missing files list.\n\n**registerHooks**(basePath: string, runtime: Exclude<Runtime, 'all'>, dryRun: boolean): boolean — delegates to `registerClaudeHooks()` or `registerGeminiHooks()`, returns true if hooks added to settings.json.\n\n**registerPermissions**(settingsPath: string, dryRun: boolean): boolean — merges ARE_PERMISSIONS into settings.json permissions.allow via `jsonc-parser` `modify()`/`applyEdits()`, preserves JSONC comments, returns true if permissions added.\n\n**getPackageVersion**(): string — reads ../../package.json from dist/installer/operations.js, extracts version field, returns 'unknown' on failure.\n\n**writeVersionFile**(basePath: string, dryRun: boolean): void — writes ARE-VERSION file containing `getPackageVersion()` output to basePath.\n\n**formatInstallResult**(result: InstallerResult): string[] — formats InstallerResult as lines showing runtime/location, created/skipped files, hook registration, summary counts.\n\n### Types\n\n**InstallOptions** — { force: boolean; dryRun: boolean }\n\n**SessionHook** — { type: 'command'; command: string }\n\n**HookEvent** — { hooks: SessionHook[] }\n\n**SettingsJson** — { hooks?: { SessionStart?: HookEvent[]; SessionEnd?: HookEvent[] }; permissions?: { allow?: string[]; deny?: string[] }; [key: string]: unknown }\n\n**GeminiHook** — { name: string; type: 'command'; command: string }\n\n**GeminiSettingsJson** — { hooks?: { SessionStart?: GeminiHook[]; SessionEnd?: GeminiHook[] }; [key: string]: unknown }\n\n**HookDefinition** — { event: 'SessionStart' | 'SessionEnd'; filename: string; name: string }\n\n**PluginDefinition** — { srcFilename: string; destFilename: string }\n\n## Internal Functions\n\n**installFilesForRuntime**(runtime: Exclude<Runtime, 'all'>, location: Location, options: InstallOptions): InstallerResult — copies command templates via `getTemplatesForRuntime()` to `resolveInstallPath()`, installs hooks (Claude/Gemini) or plugins (OpenCode), calls `registerHooks()`/`registerPermissions()`, invokes `writeVersionFile()`, returns InstallerResult.\n\n**ensureDir**(filePath: string): void — creates parent directory via `mkdirSync(path.dirname(filePath), { recursive: true })` if missing.\n\n**getBundledHookPath**(hookName: string): string — navigates from dist/installer/operations.js via `../../hooks/dist/${hookName}` to locate bundled hook file.\n\n**readBundledHook**(hookName: string): string — reads hook content via `readFileSync(getBundledHookPath(hookName))`, throws if not found.\n\n**getTemplatesForRuntime**(runtime: Exclude<Runtime, 'all'>) — dispatches to `getClaudeTemplates()`, `getOpenCodeTemplates()`, or `getGeminiTemplates()`.\n\n**registerClaudeHooks**(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean — registers Claude Code format hooks (nested hooks array) via ARE_HOOKS loop, constructs `node ${runtimeDir}/hooks/${hookDef.filename}` commands, merges into settings.hooks via `modify(content, ['hooks'], settings.hooks)`, preserves JSONC comments via `applyEdits()`.\n\n**registerGeminiHooks**(settingsPath: string, runtimeDir: string, dryRun: boolean): boolean — registers Gemini CLI format hooks (flat objects with name field) via ARE_HOOKS loop, uses GeminiHook schema.\n\n## Integration\n\nImports `resolveInstallPath()`, `getAllRuntimes()` from `./paths.js`, `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` from `../integration/templates.js`, types Runtime/Location/InstallerResult from `./types.js`. Uses `jsonc-parser` exports `parse()`, `modify()`, `applyEdits()` for settings.json manipulation.\n\n## Behavioral Contracts\n\n### Hook Definitions\n\n```typescript\nconst ARE_HOOKS: HookDefinition[] = [\n  // { event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' },\n  // { event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }, // Disabled - causing issues\n];\n```\nCurrently empty array (all hooks disabled).\n\n### Plugin Definitions\n\n```typescript\nconst ARE_PLUGINS: PluginDefinition[] = [\n  // Disabled - causing issues in OpenCode\n  // { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' },\n];\n```\nCurrently empty array (all plugins disabled).\n\n### Permission Strings\n\n```typescript\nconst ARE_PERMISSIONS = [\n  'Bash(npx agents-reverse-engineer@latest init*)',\n  'Bash(npx agents-reverse-engineer@latest discover*)',\n  'Bash(npx agents-reverse-engineer@latest generate*)',\n  'Bash(npx agents-reverse-engineer@latest update*)',\n  'Bash(npx agents-reverse-engineer@latest clean*)',\n  'Bash(rm -f .agents-reverse-engineer/progress.log*)',\n  'Bash(sleep *)',\n];\n```\n\n### Hook Command Format\n\n`node ${runtimeDir}/hooks/${hookDef.filename}` where runtimeDir is '.claude' or '.gemini'.\n\n### Settings.json Modification\n\nUses jsonc-parser with `formattingOptions: { tabSize: 2, insertSpaces: true }`. Preserves JSONC comments via `applyEdits(content, modify(...))` pattern.\n\n### Installation Flow\n\n1. Resolve basePath via `resolveInstallPath(runtime, location)`\n2. Get templates via `getTemplatesForRuntime(runtime)`\n3. Extract relativePath via `template.path.split('/').slice(1).join('/')` (strips runtime prefix)\n4. Write files: skip if exists and !force, track in filesCreated/filesSkipped/errors\n5. Install hooks (Claude/Gemini) or plugins (OpenCode) via `readBundledHook()`\n6. Register hooks via `registerHooks()` → hookRegistered boolean\n7. Register permissions (Claude only) via `registerPermissions()`\n8. Write ARE-VERSION if filesCreated.length > 0 and !dryRun\n\n### Result Schema\n\nInstallerResult: success (errors.length === 0), runtime, location, filesCreated[], filesSkipped[], errors[], hookRegistered, versionWritten.\n### paths.ts\n**Purpose:** Cross-platform path resolver for AI runtime installations, providing global/local directory resolution with environme...\n\n**Cross-platform path resolver for AI runtime installations, providing global/local directory resolution with environment variable overrides for Claude (`CLAUDE_CONFIG_DIR`), OpenCode (`OPENCODE_CONFIG_DIR`, `XDG_CONFIG_HOME`), and Gemini (`GEMINI_CONFIG_DIR`).**\n\n## Exports\n\n`getAllRuntimes()` returns `['claude', 'opencode', 'gemini']` array excluding 'all' meta-runtime. `getRuntimePaths(runtime: Exclude<Runtime, 'all'>)` returns `RuntimePaths` object containing `global` (absolute config dir), `local` (relative project dir like `.claude`), `settingsFile` (absolute settings.json path). `resolveInstallPath(runtime, location: Location, projectRoot?: string)` resolves full installation path: global location returns absolute global path, local location joins projectRoot with local dir. `getSettingsPath(runtime)` returns absolute settings.json path for hook registration. `isRuntimeInstalledLocally(runtime, projectRoot)` checks if local config directory exists via `stat()`. `isRuntimeInstalledGlobally(runtime)` checks global config directory existence. `getInstalledRuntimes(projectRoot)` returns array of locally installed runtimes by testing each with `isRuntimeInstalledLocally()`.\n\n## Path Resolution Strategy\n\nClaude: `CLAUDE_CONFIG_DIR || ~/.claude` (global), `.claude` (local). OpenCode: `OPENCODE_CONFIG_DIR || XDG_CONFIG_HOME/opencode || ~/.config/opencode` (global), `.opencode` (local). Gemini: `GEMINI_CONFIG_DIR || ~/.gemini` (global), `.gemini` (local). All paths use `os.homedir()` and `path.join()` for cross-platform compatibility. Settings files located at `{globalPath}/settings.json`.\n\n## Dependencies\n\nImports `os.homedir()` for user directory, `path.join()` for cross-platform joining, `fs/promises.stat()` for directory existence checks, `Runtime`/`Location`/`RuntimePaths` types from `./types.js`.\n### prompts.ts\n**Purpose:** Interactive prompt module providing TTY-aware user input via arrow key selection (interactive) or numbered fallback (...\n\n**Interactive prompt module providing TTY-aware user input via arrow key selection (interactive) or numbered fallback (CI/non-TTY), with guaranteed raw mode cleanup.**\n\n## Exports\n\n`isInteractive(): boolean` — returns `process.stdin.isTTY === true`.\n\n`selectOption<T>(prompt: string, options: SelectOption<T>[]): Promise<T>` — routes to `arrowKeySelect()` if TTY, else `numberedSelect()`.\n\n`selectRuntime(mode?: 'install' | 'uninstall'): Promise<Runtime>` — prompts for runtime selection from `claude`, `opencode`, `gemini`, `all`.\n\n`selectLocation(mode?: 'install' | 'uninstall'): Promise<Location>` — prompts for `global` (`~/.claude`) or `local` (`./.claude`).\n\n`confirmAction(message: string): Promise<boolean>` — Yes/No confirmation via `selectOption<boolean>()`.\n\n## Types\n\n`SelectOption<T>` — `{ label: string; value: T }`.\n\n`Runtime`, `Location` imported from `./types.js`.\n\n## Terminal Handling\n\n`arrowKeySelect()` enables `readline.emitKeypressEvents()` + `setRawMode(true)`, listens for `keypress` events: `up` decrements `selectedIndex`, `down` increments, `return` resolves selected value. Re-renders via ANSI escape codes `\\x1b[${n}A` (cursor up), `\\x1b[2K` (clear line), `\\x1b[1B` (cursor down). Cleans up via `cleanupRawMode()` in finally block.\n\n`numberedSelect()` prints options with 1-indexed numbers, reads input via `readline.createInterface()`, validates numeric range `1..options.length`, rejects on invalid input.\n\n## Cleanup Protocol\n\n`cleanupRawMode()` disables raw mode via `process.stdin.setRawMode(false)` + `pause()`, tracks state in module-scoped `rawModeActive` boolean. Registered on `process.on('exit')` and `process.on('SIGINT')` for guaranteed terminal restoration. Always wrapped in try/catch to suppress errors during cleanup.\n\n## Dependencies\n\n`node:readline` for keypress events and interface creation, `picocolors` (`pc.bold()`, `pc.cyan()`) for styled output.\n### types.ts\n**Purpose:** Defines TypeScript interfaces for interactive installer that copies command files and hooks to runtime-specific direc...\n\n**Defines TypeScript interfaces for interactive installer that copies command files and hooks to runtime-specific directories (Claude Code, OpenCode, Gemini) with support for global/local installation targets, force overwrite, uninstall operations, and installation result tracking.**\n\n## Exported Types\n\n`Runtime` — union type `'claude' | 'opencode' | 'gemini' | 'all'` mapping to runtime-specific directories (`~/.claude`, `~/.config/opencode`, `~/.gemini`).\n\n`Location` — union type `'global' | 'local'` distinguishing user-level (`~/.*`) vs project-level (`./*`) installation.\n\n`InstallerArgs` — CLI argument schema with `runtime?: Runtime`, `global: boolean`, `local: boolean`, `uninstall: boolean`, `force: boolean`, `help: boolean`, `quiet: boolean` controlling interactive vs flag-driven modes.\n\n`InstallerResult` — operation outcome with `success: boolean`, `runtime: Exclude<Runtime, 'all'>`, `location: Location`, `filesCreated: string[]`, `filesSkipped: string[]`, `errors: string[]`, `hookRegistered?: boolean`, `versionWritten?: boolean` tracking per-runtime/location installation state.\n\n`RuntimePaths` — resolved paths containing `global: string`, `local: string`, `settingsFile: string` for command file destination and settings.json hook registration target.\n### uninstall.ts\n**Purpose:** Reverses installer operations: deletes command templates, hooks/plugins, hook registrations from settings.json, permi...\n\n**Reverses installer operations: deletes command templates, hooks/plugins, hook registrations from settings.json, permissions from Claude settings, ARE-VERSION files, and optionally `.agents-reverse-engineer/` config folder for local installs.**\n\n## Exports\n\n**`uninstallFiles(runtime: Runtime, location: Location, dryRun: boolean = false): InstallerResult[]`** — Uninstalls ARE from specified runtime or all runtimes if `runtime === 'all'`, returning `InstallerResult[]` with `filesCreated` repurposed to track deleted files. Delegates to `uninstallFilesForRuntime()` per concrete runtime.\n\n**`unregisterHooks(basePath: string, runtime: Exclude<Runtime, 'all'>, dryRun: boolean): boolean`** — Removes ARE hook entries from `settings.json` at `basePath/settings.json`. Delegates to `unregisterClaudeHooks()` or `unregisterGeminiHooks()` based on runtime. Returns true if any hooks removed.\n\n**`unregisterPermissions(basePath: string, dryRun: boolean): boolean`** — Removes all entries in `ARE_PERMISSIONS` array from `settings.permissions.allow` in Claude settings.json. Uses `jsonc-parser` `modify()` + `applyEdits()` to preserve comments. Cleans up empty `permissions` object. Returns true if any permissions removed.\n\n**`deleteConfigFolder(location: Location, dryRun: boolean): boolean`** — Deletes `.agents-reverse-engineer/` directory via `rmSync(configPath, {recursive: true, force: true})` only when `location === 'local'`. Returns true if folder deleted, false if not found or global install.\n\n## Internal Functions\n\n**`uninstallFilesForRuntime(runtime: Exclude<Runtime, 'all'>, location: Location, dryRun: boolean): InstallerResult`** — Deletes command templates from runtime-specific directories (retrieved via `getTemplatesForRuntime()` and `resolveInstallPath()`), hook files from `hooks/` (Claude/Gemini) or `plugins/` (OpenCode), `ARE-VERSION` file, unregisters hooks via `unregisterHooks()`, unregisters permissions (Claude only). Invokes `cleanupAreSkillDirs()` for Claude, `cleanupLegacyGeminiFiles()` + `cleanupEmptyDirs()` for Gemini/OpenCode. Returns `InstallerResult` with `filesCreated` as deleted file list, `hookRegistered` repurposed as `hookUnregistered`.\n\n**`getTemplatesForRuntime(runtime: Exclude<Runtime, 'all'>)`** — Returns `getClaudeTemplates()`, `getOpenCodeTemplates()`, or `getGeminiTemplates()` based on runtime parameter.\n\n**`unregisterClaudeHooks(basePath: string, dryRun: boolean): boolean`** — Parses `settings.json` via `jsonc-parser.parse()`, filters `settings.hooks.SessionStart` and `settings.hooks.SessionEnd` arrays removing entries where `event.hooks` contains commands matching `getHookPatterns('.claude')`, writes back via `applyEdits()` + `modify()` preserving JSONC comments. Deletes empty `hooks` key when no events remain.\n\n**`unregisterGeminiHooks(basePath: string, dryRun: boolean): boolean`** — Similar to `unregisterClaudeHooks()` but filters `GeminiHook[]` arrays (simpler schema with `name`, `type`, `command` fields) matching `getHookPatterns('.gemini')`.\n\n**`getHookPatterns(runtimeDir: string): string[]`** — Builds command pattern array from `ARE_HOOKS` definitions: current format `node ${runtimeDir}/hooks/${hookDef.filename}` and legacy format `node hooks/${hookDef.filename}` for backward compatibility.\n\n**`cleanupAreSkillDirs(skillsDir: string): void`** — Iterates entries in `skillsDir`, recursively calls `cleanupEmptyDirs()` on all directories with `entry.startsWith('are-')`. Claude-specific cleanup for skills format.\n\n**`cleanupEmptyDirs(dirPath: string): void`** — Recursively removes empty directories via `readdirSync()` → `rmdirSync()` if `entries.length === 0`. Stops at runtime roots (`.claude`, `.opencode`, `.gemini`, `.config`).\n\n**`cleanupLegacyGeminiFiles(commandsDir: string): void`** — Deletes legacy `are-*.md` files from `.gemini/commands/` (pre-TOML format) and `.gemini/commands/are/*.toml` files (pre-flat structure). Calls `cleanupEmptyDirs()` on `are/` subdirectory after deletion.\n\n## Constants\n\n**`ARE_HOOKS: HookDefinition[]`** — `[{event: 'SessionStart', filename: 'are-check-update.js'}, {event: 'SessionEnd', filename: 'are-session-end.js'}]`. Must mirror `operations.ts` definitions.\n\n**`ARE_PLUGIN_FILENAMES: string[]`** — `['are-check-update.js']` for OpenCode plugin removal. Must mirror `operations.ts`.\n\n**`ARE_PERMISSIONS: string[]`** — Five bash permission patterns: `Bash(npx agents-reverse-engineer@latest init*)`, `discover*`, `generate*`, `update*`, `clean*`. Must mirror `operations.ts`.\n\n**`CONFIG_DIR: string`** — `'.agents-reverse-engineer'` matching `src/config/loader.ts` constant.\n\n## Type Definitions\n\n**`SessionHook`** — `{type: 'command', command: string}` for Claude settings.json hook array entries.\n\n**`HookEvent`** — `{hooks: SessionHook[]}` for Claude `settings.hooks.SessionStart`/`SessionEnd` array entries.\n\n**`SettingsJson`** — Claude settings schema with `hooks?: {SessionStart?: HookEvent[], SessionEnd?: HookEvent[]}`, `permissions?: {allow?: string[], deny?: string[]}`, indexed signature `[key: string]: unknown`.\n\n**`GeminiHook`** — `{name: string, type: 'command', command: string}` simpler hook schema for Gemini CLI.\n\n**`GeminiSettingsJson`** — `{hooks?: {SessionStart?: GeminiHook[], SessionEnd?: GeminiHook[]}}` with indexed signature.\n\n**`HookDefinition`** — `{event: 'SessionStart' | 'SessionEnd', filename: string}` internal hook descriptor.\n\n## Dependencies\n\nUses `node:fs` (`existsSync`, `unlinkSync`, `readFileSync`, `writeFileSync`, `readdirSync`, `rmdirSync`, `rmSync`), `node:path`, `jsonc-parser` (`parse`, `modify`, `applyEdits` with `formattingOptions: {tabSize: 2, insertSpaces: true}`), imports from `./types.js` (`Runtime`, `Location`, `InstallerResult`), `./paths.js` (`resolveInstallPath`, `getAllRuntimes`), `../integration/templates.js` (`getClaudeTemplates`, `getOpenCodeTemplates`, `getGeminiTemplates`).\n\n## Design Patterns\n\nMirrors `operations.ts` install logic for symmetric reversal. Uses jsonc-parser for comment-preserving JSON edits with format `{formattingOptions: {tabSize: 2, insertSpaces: true}}`. Employs defensive deletion with try-catch ignore blocks for permission errors. Repurposes `InstallerResult.filesCreated` to track deletions and `hookRegistered` as `hookUnregistered` boolean. Recursive directory cleanup with runtime root boundary checks (`baseName !== '.claude' && baseName !== '.opencode' && baseName !== '.gemini' && baseName !== '.config'`).\n\n## Error Handling\n\nSwallows filesystem exceptions in cleanup functions (`cleanupEmptyDirs`, `cleanupAreSkillDirs`, `cleanupLegacyGeminiFiles`) with empty catch blocks. Populates `InstallerResult.errors` array for file deletion failures with messages like `Failed to delete ${fullPath}: ${err}`. `unregisterHooks()` and `unregisterPermissions()` return false on missing settings.json or read failures, true only when modifications made. `deleteConfigFolder()` returns false on `rmSync()` exception.\n\n## Import Map (verified — use these exact paths)\n\nbanner.ts:\n  ../version.js → getVersion\n\noperations.ts:\n  ../integration/templates.js → getClaudeTemplates, getOpenCodeTemplates, getGeminiTemplates\n\nuninstall.ts:\n  ../integration/templates.js → getClaudeTemplates, getOpenCodeTemplates, getGeminiTemplates\n\n## Existing AGENTS.md (update this — preserve stable content, modify only what changed)\n\n<!-- Generated by agents-reverse-engineer v0.8.2 -->\n\n# src/installer\n\nInteractive installer module orchestrating command template/session hook deployment to AI runtime config directories (`.claude/`, `.gemini/`, `.config/opencode/`) with TTY-aware prompts, settings.json hook registration via jsonc-parser, permission injection for Claude, version tracking, and symmetric uninstall operations.\n\n## Contents\n\n**[banner.ts](./banner.ts)** — Terminal UI helpers: `displayBanner()` renders green ASCII \"ARE\" box-drawing art + version, `showHelp()` prints usage table (`--runtime`, `-g`, `-l`, `-u`, `--force`, `-q`, `-h`) + 3 examples, `showSuccess()`/`showError()`/`showWarning()`/`showInfo()` emit picocolors-styled messages, `showNextSteps()` displays 7-step post-install guide (/are-help, /are-init, /are-discover, /are-generate, /are-update, /are-specify, /are-clean) + GitHub docs link.\n\n**[index.ts](./index.ts)** — Main entry point: `runInstaller()` routes install/uninstall workflows via `runInstall()`/`runUninstall()`, `parseInstallerArgs()` parses CLI flags (`--runtime`, `-g/--global`, `-l/--local`, `--force`, `-q/--quiet`, `-h/--help`) validating runtime against `['claude', 'opencode', 'gemini', 'all']`, `displayInstallResults()`/`displayUninstallResults()` format operation summaries with file counts + hook status. Non-interactive mode requires `--runtime` + location flag or exits code 1. Interactive mode calls `selectRuntime()`/`selectLocation()` prompts. Re-exports types/functions from `./types.js`, `./paths.js`, `./banner.js`, `./prompts.js`.\n\n**[operations.ts](./operations.ts)** — Install operations: `installFilesForRuntime()` copies command templates from `getTemplatesForRuntime()` to `resolveInstallPath()`, writes hooks (Claude/Gemini) or plugins (OpenCode) from `getBundledHookPath()` (navigates `../../hooks/dist/`), calls `registerHooks()`/`registerPermissions()` via jsonc-parser `modify()`/`applyEdits()` preserving comments, writes `ARE-VERSION` file via `writeVersionFile()`. `registerClaudeHooks()` constructs `node ${runtimeDir}/hooks/${hookDef.filename}` commands into nested hooks array. `registerGeminiHooks()` uses flat GeminiHook schema with name field. `registerPermissions()` merges `ARE_PERMISSIONS` (7 patterns including `Bash(rm -f .agents-reverse-engineer/progress.log*)` and `Bash(sleep *)`) into settings.permissions.allow. `verifyInstallation()` filters files via `existsSync()`. `formatInstallResult()` builds human-readable lines. Returns `InstallerResult` with `filesCreated`/`filesSkipped`/`errors`/`hookRegistered`/`versionWritten`.\n\n**[paths.ts](./paths.ts)** — Path resolver: `getRuntimePaths()` returns `RuntimePaths` with `global` (absolute config dir), `local` (relative project dir like `.claude`), `settingsFile` (settings.json path). `resolveInstallPath()` joins projectRoot + local dir for local installs, returns global path otherwise. `getSettingsPath()` returns settings.json absolute path. `isRuntimeInstalledLocally()`/`isRuntimeInstalledGlobally()` check directory existence via `stat()`. `getInstalledRuntimes()` returns array of locally installed runtimes. Uses env var overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `XDG_CONFIG_HOME`, `GEMINI_CONFIG_DIR`. Defaults: Claude `~/.claude`, OpenCode `~/.config/opencode`, Gemini `~/.gemini`.\n\n**[prompts.ts](./prompts.ts)** — Interactive prompts: `isInteractive()` returns `process.stdin.isTTY === true`. `selectOption()` routes to `arrowKeySelect()` (TTY) or `numberedSelect()` (CI/non-TTY). `selectRuntime()` prompts for runtime from `['claude', 'opencode', 'gemini', 'all']`. `selectLocation()` prompts for `'global'` (~/.claude) or `'local'` (./.claude). `confirmAction()` Yes/No selection. `arrowKeySelect()` enables `readline.emitKeypressEvents()` + `setRawMode(true)`, listens for up/down/return keypresses, renders via ANSI escape codes (`\\x1b[${n}A`, `\\x1b[2K`, `\\x1b[1B`), guarantees cleanup via `cleanupRawMode()` in finally block + `process.on('exit')` + `process.on('SIGINT')`.\n\n**[types.ts](./types.ts)** — TypeScript interfaces: `Runtime = 'claude' | 'opencode' | 'gemini' | 'all'`, `Location = 'global' | 'local'`, `InstallerArgs` (CLI schema: `runtime?`, `global`, `local`, `uninstall`, `force`, `help`, `quiet`), `InstallerResult` (operation outcome: `success`, `runtime`, `location`, `filesCreated[]`, `filesSkipped[]`, `errors[]`, `hookRegistered?`, `versionWritten?`), `RuntimePaths` (resolved paths: `global`, `local`, `settingsFile`).\n\n**[uninstall.ts](./uninstall.ts)** — Reverses install: `uninstallFilesForRuntime()` deletes command templates from `resolveInstallPath()`, hooks/plugins from `hooks/`/`plugins/` dirs, `ARE-VERSION` file, calls `unregisterHooks()`/`unregisterPermissions()`, `cleanupAreSkillDirs()` (Claude skills), `cleanupLegacyGeminiFiles()` (pre-TOML formats), `cleanupEmptyDirs()` (recursive removal stopping at runtime roots). `unregisterClaudeHooks()`/`unregisterGeminiHooks()` filter settings.json hook arrays removing entries matching `getHookPatterns()` (current + legacy `node hooks/` formats) via jsonc-parser. `unregisterPermissions()` removes `ARE_PERMISSIONS` from settings.permissions.allow, cleans empty permissions object. `deleteConfigFolder()` deletes `.agents-reverse-engineer/` via `rmSync({recursive: true, force: true})` only when `location === 'local'`. Returns `InstallerResult` with `filesCreated` repurposed as deleted files, `hookRegistered` as `hookUnregistered`.\n\n## Workflow\n\n### Interactive Install\n1. `parseInstallerArgs()` extracts `--runtime`/`-g`/`-l`/`--force`/`--quiet` flags\n2. `displayBanner()` unless quiet\n3. `selectRuntime()`/`selectLocation()` if missing via TTY arrow keys or numbered fallback\n4. `runInstall()` calls `installFilesForRuntime()` per runtime:\n   - Copy templates from `getTemplatesForRuntime()` to `resolveInstallPath()`\n   - Write hooks from `getBundledHookPath('../../hooks/dist/')` to `hooks/`/`plugins/`\n   - `registerHooks()` → `registerClaudeHooks()`/`registerGeminiHooks()` via jsonc-parser\n   - `registerPermissions()` (Claude only) merges `ARE_PERMISSIONS` into settings.permissions.allow\n   - `writeVersionFile()` writes package.json version to `ARE-VERSION`\n5. `verifyInstallation()` checks `existsSync()` for all created files\n6. `displayInstallResults()` shows filesCreated/filesSkipped/hookRegistered counts\n7. `showNextSteps()` emits 7-step usage guide\n\n### Non-Interactive Install\nRequires `--runtime` + `-g`/`-l` flags or exits code 1. Skips prompts. Same file operations.\n\n### Uninstall\n1. `runUninstall()` calls `uninstallFilesForRuntime()`:\n   - Delete command templates, hooks/plugins, `ARE-VERSION`\n   - `unregisterHooks()` filters settings.json via jsonc-parser\n   - `unregisterPermissions()` removes ARE_PERMISSIONS (Claude)\n   - `cleanupAreSkillDirs()`/`cleanupLegacyGeminiFiles()`/`cleanupEmptyDirs()`\n2. `deleteConfigFolder()` removes `.agents-reverse-engineer/` if local install\n3. `displayUninstallResults()` shows deletion counts\n\n## Behavioral Contracts\n\n### Hook Definitions\n```typescript\nconst ARE_HOOKS: HookDefinition[] = [\n  // { event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' },\n  // { event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }, // Disabled - causing issues\n];\n```\nCurrently empty (all commented). Must mirror across operations.ts/uninstall.ts.\n\n### Plugin Filenames\n```typescript\nconst ARE_PLUGINS: PluginDefinition[] = [\n  { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' },\n];\n```\nOnly SessionStart check-update plugin active for OpenCode.\n\n### Permission Patterns\n```typescript\nconst ARE_PERMISSIONS = [\n  'Bash(npx agents-reverse-engineer@latest init*)',\n  'Bash(npx agents-reverse-engineer@latest discover*)',\n  'Bash(npx agents-reverse-engineer@latest generate*)',\n  'Bash(npx agents-reverse-engineer@latest update*)',\n  'Bash(npx agents-reverse-engineer@latest clean*)',\n  'Bash(rm -f .agents-reverse-engineer/progress.log*)',\n  'Bash(sleep *)',\n];\n```\nMust mirror across operations.ts/uninstall.ts.\n\n### Hook Command Format\nClaude/Gemini: `node ${runtimeDir}/hooks/${hookDef.filename}` where runtimeDir is `.claude` or `.gemini`.\n\n### Valid Runtimes\n`['claude', 'opencode', 'gemini', 'all']` (index.ts:63).\n\n### Error Messages\n- `'Missing --runtime flag (required in non-interactive mode)'`\n- `'Missing -g/--global or -l/--local flag (required in non-interactive mode)'`\n- `'Unable to determine runtime and location'`\n- `'Installation verification failed - some files missing:'`\n\n### GitHub Docs URL\n`'https://github.com/GeoloeG-IsT/agents-reverse-engineer'` (index.ts:290).\n\n### Bundled Hook Path\n`../../hooks/dist/${hookName}` from `dist/installer/operations.js`.\n\n### jsonc-parser Formatting\n```typescript\nformattingOptions: { tabSize: 2, insertSpaces: true }\n```\n\n### Empty Directory Cleanup Boundary\nStops at `baseName !== '.claude' && baseName !== '.opencode' && baseName !== '.gemini' && baseName !== '.config'`.\n\n## Integration Points\n\nDepends on `../integration/templates.js` (`getClaudeTemplates`, `getOpenCodeTemplates`, `getGeminiTemplates`), `../version.js` (`getVersion`). Called by `src/cli/index.ts` after command routing. Uses `jsonc-parser` for comment-preserving JSON edits, `readline` for keypress events, `picocolors` for styled output.",
      "systemPrompt": "You are updating an existing AGENTS.md file — a directory-level overview for AI coding assistants. Some file summaries or subdirectory documents have changed, and AGENTS.md needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING AGENTS.md and the CURRENT file summaries and subdirectory documents\n- Preserve the structure, section headings, and descriptions that are still accurate\n- Only modify entries for files or subdirectories whose summaries have changed\n- Add entries for new files, remove entries for deleted files\n- Do NOT reorganize, rephrase, or restructure sections that are unaffected by changes\n- Keep the same section ordering unless files were added/removed in a way that requires regrouping\n- Behavioral Contracts section: preserve verbatim regex patterns and constants unless source file summaries show they changed\n- Reproduction-Critical Constants: if file summaries reference annex files (.annex.sum), preserve the links. Add links for new annexes, remove links for deleted ones.\n- Workflow & Conventions section: preserve existing rules unless source file summaries show they changed. Add rules from new files, remove rules for deleted files.\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Preserve the existing purpose statement unless the directory's role has fundamentally changed\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n- Cross-module references must use the specifier format from actual import statements\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context",
      "response": "<!-- Generated by agents-reverse-engineer -->\n\n# src/installer\n\nInteractive installer module orchestrating command template/session hook deployment to AI runtime config directories (`.claude/`, `.gemini/`, `.config/opencode/`) with TTY-aware prompts, settings.json hook registration via jsonc-parser, permission injection for Claude, version tracking, and symmetric uninstall operations.\n\n## Contents\n\n**[banner.ts](./banner.ts)** — Terminal UI helpers: `displayBanner()` renders green ASCII \"ARE\" box-drawing art + version, `showHelp()` prints usage table (`--runtime`, `-g`, `-l`, `-u`, `--force`, `-q`, `-h`) + 3 examples, `showSuccess()`/`showError()`/`showWarning()`/`showInfo()` emit picocolors-styled messages, `showNextSteps()` displays 7-step post-install guide (/are-help, /are-init, /are-discover, /are-generate, /are-update, /are-specify, /are-clean) + GitHub docs link, `VERSION` constant from `getVersion()`.\n\n**[index.ts](./index.ts)** — Main entry point: `runInstaller()` routes install/uninstall workflows via `runInstall()`/`runUninstall()`, `parseInstallerArgs()` parses CLI flags (`--runtime`, `-g/--global`, `-l/--local`, `--force`, `-q/--quiet`, `-h/--help`) validating runtime against `['claude', 'opencode', 'gemini', 'all']`, `displayInstallResults()`/`displayUninstallResults()` format operation summaries with file counts + hook status. Non-interactive mode requires `--runtime` + location flag or exits code 1. Interactive mode calls `selectRuntime()`/`selectLocation()` prompts. Re-exports types/functions from `./types.js`, `./paths.js`, `./banner.js`, `./prompts.js`.\n\n**[operations.ts](./operations.ts)** — Install operations: `installFilesForRuntime()` copies command templates from `getTemplatesForRuntime()` to `resolveInstallPath()`, writes hooks (Claude/Gemini) or plugins (OpenCode) from `getBundledHookPath()` (navigates `../../hooks/dist/`), calls `registerHooks()`/`registerPermissions()` via jsonc-parser `modify()`/`applyEdits()` preserving comments, writes `ARE-VERSION` file via `writeVersionFile()`. `registerClaudeHooks()` constructs `node ${runtimeDir}/hooks/${hookDef.filename}` commands into nested hooks array. `registerGeminiHooks()` uses flat GeminiHook schema with name field. `registerPermissions()` merges `ARE_PERMISSIONS` (7 patterns: `Bash(npx agents-reverse-engineer@latest init*)`, `discover*`, `generate*`, `update*`, `clean*`, `Bash(rm -f .agents-reverse-engineer/progress.log*)`, `Bash(sleep *)`) into settings.permissions.allow. `verifyInstallation()` filters files via `existsSync()`. `formatInstallResult()` builds human-readable lines. `getPackageVersion()` reads `../../package.json` version field from dist/installer/operations.js. Returns `InstallerResult` with `filesCreated`/`filesSkipped`/`errors`/`hookRegistered`/`versionWritten`.\n\n**[paths.ts](./paths.ts)** — Path resolver: `getAllRuntimes()` returns `['claude', 'opencode', 'gemini']`, `getRuntimePaths()` returns `RuntimePaths` with `global` (absolute config dir), `local` (relative project dir like `.claude`), `settingsFile` (settings.json path). `resolveInstallPath()` joins projectRoot + local dir for local installs, returns global path otherwise. `getSettingsPath()` returns settings.json absolute path. `isRuntimeInstalledLocally()`/`isRuntimeInstalledGlobally()` check directory existence via `stat()`. `getInstalledRuntimes()` returns array of locally installed runtimes. Uses env var overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `XDG_CONFIG_HOME`, `GEMINI_CONFIG_DIR`. Defaults: Claude `~/.claude`, OpenCode `~/.config/opencode`, Gemini `~/.gemini`.\n\n**[prompts.ts](./prompts.ts)** — Interactive prompts: `isInteractive()` returns `process.stdin.isTTY === true`. `selectOption()` routes to `arrowKeySelect()` (TTY) or `numberedSelect()` (CI/non-TTY). `selectRuntime()` prompts for runtime from `['claude', 'opencode', 'gemini', 'all']`. `selectLocation()` prompts for `'global'` (~/.claude) or `'local'` (./.claude). `confirmAction()` Yes/No selection. `arrowKeySelect()` enables `readline.emitKeypressEvents()` + `setRawMode(true)`, listens for up/down/return keypresses, renders via ANSI escape codes (`\\x1b[${n}A`, `\\x1b[2K`, `\\x1b[1B`), guarantees cleanup via `cleanupRawMode()` in finally block + `process.on('exit')` + `process.on('SIGINT')`.\n\n**[types.ts](./types.ts)** — TypeScript interfaces: `Runtime = 'claude' | 'opencode' | 'gemini' | 'all'`, `Location = 'global' | 'local'`, `InstallerArgs` (CLI schema: `runtime?`, `global`, `local`, `uninstall`, `force`, `help`, `quiet`), `InstallerResult` (operation outcome: `success`, `runtime`, `location`, `filesCreated[]`, `filesSkipped[]`, `errors[]`, `hookRegistered?`, `versionWritten?`), `RuntimePaths` (resolved paths: `global`, `local`, `settingsFile`).\n\n**[uninstall.ts](./uninstall.ts)** — Reverses install: `uninstallFilesForRuntime()` deletes command templates from `resolveInstallPath()`, hooks/plugins from `hooks/`/`plugins/` dirs, `ARE-VERSION` file, calls `unregisterHooks()`/`unregisterPermissions()`, `cleanupAreSkillDirs()` (Claude skills), `cleanupLegacyGeminiFiles()` (pre-TOML formats), `cleanupEmptyDirs()` (recursive removal stopping at runtime roots). `unregisterClaudeHooks()`/`unregisterGeminiHooks()` filter settings.json hook arrays removing entries matching `getHookPatterns()` (current `node ${runtimeDir}/hooks/${hookDef.filename}` + legacy `node hooks/${hookDef.filename}` formats) via jsonc-parser. `unregisterPermissions()` removes `ARE_PERMISSIONS` from settings.permissions.allow, cleans empty permissions object. `deleteConfigFolder()` deletes `.agents-reverse-engineer/` via `rmSync({recursive: true, force: true})` only when `location === 'local'`. Returns `InstallerResult` with `filesCreated` repurposed as deleted files, `hookRegistered` as `hookUnregistered`.\n\n## Workflow\n\n### Interactive Install\n1. `parseInstallerArgs()` extracts `--runtime`/`-g`/`-l`/`--force`/`--quiet` flags\n2. `displayBanner()` unless quiet\n3. `selectRuntime()`/`selectLocation()` if missing via TTY arrow keys or numbered fallback\n4. `runInstall()` calls `installFilesForRuntime()` per runtime:\n   - Copy templates from `getTemplatesForRuntime()` to `resolveInstallPath()`\n   - Write hooks from `getBundledHookPath('../../hooks/dist/')` to `hooks/`/`plugins/`\n   - `registerHooks()` → `registerClaudeHooks()`/`registerGeminiHooks()` via jsonc-parser\n   - `registerPermissions()` (Claude only) merges `ARE_PERMISSIONS` into settings.permissions.allow\n   - `writeVersionFile()` writes package.json version to `ARE-VERSION`\n5. `verifyInstallation()` checks `existsSync()` for all created files\n6. `displayInstallResults()` shows filesCreated/filesSkipped/hookRegistered counts\n7. `showNextSteps()` emits 7-step usage guide\n\n### Non-Interactive Install\nRequires `--runtime` + `-g`/`-l` flags or exits code 1. Skips prompts. Same file operations.\n\n### Uninstall\n1. `runUninstall()` calls `uninstallFilesForRuntime()`:\n   - Delete command templates, hooks/plugins, `ARE-VERSION`\n   - `unregisterHooks()` filters settings.json via jsonc-parser\n   - `unregisterPermissions()` removes ARE_PERMISSIONS (Claude)\n   - `cleanupAreSkillDirs()`/`cleanupLegacyGeminiFiles()`/`cleanupEmptyDirs()`\n2. `deleteConfigFolder()` removes `.agents-reverse-engineer/` if local install\n3. `displayUninstallResults()` shows deletion counts\n\n## Behavioral Contracts\n\n### Hook Definitions\n```typescript\nconst ARE_HOOKS: HookDefinition[] = [\n  // { event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' },\n  // { event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }, // Disabled - causing issues\n];\n```\nCurrently empty array (all hooks disabled). Must mirror across operations.ts/uninstall.ts.\n\n### Plugin Definitions\n```typescript\nconst ARE_PLUGINS: PluginDefinition[] = [\n  // Disabled - causing issues in OpenCode\n  // { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' },\n];\n```\nCurrently empty array (all plugins disabled). Must mirror operations.ts.\n\n### Permission Patterns\n```typescript\nconst ARE_PERMISSIONS = [\n  'Bash(npx agents-reverse-engineer@latest init*)',\n  'Bash(npx agents-reverse-engineer@latest discover*)',\n  'Bash(npx agents-reverse-engineer@latest generate*)',\n  'Bash(npx agents-reverse-engineer@latest update*)',\n  'Bash(npx agents-reverse-engineer@latest clean*)',\n  'Bash(rm -f .agents-reverse-engineer/progress.log*)',\n  'Bash(sleep *)',\n];\n```\nMust mirror across operations.ts/uninstall.ts.\n\n### Hook Command Format\nClaude/Gemini: `node ${runtimeDir}/hooks/${hookDef.filename}` where runtimeDir is `.claude` or `.gemini`.\n\n### Valid Runtimes\n`['claude', 'opencode', 'gemini', 'all']` (index.ts:63).\n\n### Error Messages\n- `'Missing --runtime flag (required in non-interactive mode)'`\n- `'Missing -g/--global or -l/--local flag (required in non-interactive mode)'`\n- `'Unable to determine runtime and location'`\n- `'Installation verification failed - some files missing:'`\n\n### GitHub Docs URL\n`'https://github.com/GeoloeG-IsT/agents-reverse-engineer'` (index.ts:290).\n\n### Bundled Hook Path\n`../../hooks/dist/${hookName}` from `dist/installer/operations.js`.\n\n### jsonc-parser Formatting\n```typescript\nformattingOptions: { tabSize: 2, insertSpaces: true }\n```\n\n### Empty Directory Cleanup Boundary\nStops at `baseName !== '.claude' && baseName !== '.opencode' && baseName !== '.gemini' && baseName !== '.config'`.\n\n## Integration Points\n\nDepends on `../integration/templates.js` (`getClaudeTemplates`, `getOpenCodeTemplates`, `getGeminiTemplates`), `../version.js` (`getVersion`). Called by `src/cli/index.ts` after command routing. Uses `jsonc-parser` for comment-preserving JSON edits, `readline` for keypress events, `picocolors` for styled output.",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 3061,
      "cacheReadTokens": 0,
      "cacheCreationTokens": 33967,
      "latencyMs": 55942,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": []
    },
    {
      "timestamp": "2026-02-12T08:37:28.025Z",
      "prompt": "Generate AGENTS.md for directory: \"src/integration\" (integration)\n\n## File Summaries (4 files)\n\n### detect.ts\n**Purpose:** Detects AI coding assistant environments (Claude Code, OpenCode, Aider) in project by checking for config directories...\n\n**Detects AI coding assistant environments (Claude Code, OpenCode, Aider) in project by checking for config directories and marker files.**\n\n## Exports\n\n`detectEnvironments(projectRoot: string): DetectedEnvironment[]` — Returns array of all detected environments by checking `.claude/` OR `CLAUDE.md` (Claude Code), `.opencode/` (OpenCode), `.aider.conf.yml` OR `.aider/` (Aider) via `existsSync()`. Each returned object contains `type: EnvironmentType`, `configDir: string`, `detected: true`.\n\n`hasEnvironment(projectRoot: string, type: EnvironmentType): boolean` — Returns true if specified environment type detected, delegates to `detectEnvironments()` and filters by `env.type === type`.\n\n## Detection Logic\n\nClaude Code: `.claude/` directory OR `CLAUDE.md` file existence triggers detection with `configDir: '.claude'`.\nOpenCode: `.opencode/` directory only.\nAider: `.aider.conf.yml` file OR `.aider/` directory triggers detection with `configDir: '.aider'`.\n### generate.ts\n**Purpose:** Generates AI assistant integration files (command templates, hooks) for detected environments with skip-if-exists log...\n\n**Generates AI assistant integration files (command templates, hooks) for detected environments with skip-if-exists logic and bundled hook path resolution.**\n\n## Exports\n\n`generateIntegrationFiles(projectRoot: string, options?: GenerateOptions): Promise<IntegrationResult[]>` — orchestrates file generation for all detected/specified environments by calling `detectEnvironments()` (or using `options.environment`), invoking `getTemplatesForEnvironment()`, writing template content via `ensureDir()` + `writeFileSync()`, conditionally copying `.claude/hooks/are-session-end.js` via `readBundledHook()`, skipping existing files unless `options.force=true`, respecting `options.dryRun` flag, returning per-environment results with `filesCreated`/`filesSkipped` arrays.\n\n`GenerateOptions` — interface with `dryRun?: boolean` (report-only mode), `force?: boolean` (overwrite existing), `environment?: EnvironmentType` (bypass auto-detection).\n\n`getBundledHookPath(hookName: string): string` — resolves hook file path by navigating from `dist/integration/` up two levels to project root, then to `hooks/dist/${hookName}`.\n\n`readBundledHook(hookName: string): string` — reads bundled hook content via `readFileSync()` at path from `getBundledHookPath()`, throws Error if not found.\n\n`ensureDir(filePath: string): void` — creates parent directories via `mkdirSync(path.dirname(filePath), { recursive: true })` if missing.\n\n`getTemplatesForEnvironment(type: EnvironmentType): Array<{path: string, content: string}>` — maps environment type to template provider: `'claude'` → `getClaudeTemplates()`, `'opencode'` → `getOpenCodeTemplates()`, `'gemini'` → `getGeminiTemplates()`, `'aider'` → `[]`.\n\n## Integration Points\n\nImports `detectEnvironments()` from `./detect.js` (returns `{type, configDir}[]` for present environments), `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` from `./templates.js` (return template arrays), `IntegrationResult`, `EnvironmentType` from `./types.js`. Used by `src/cli/init.ts` during installation workflow.\n\n## File Creation Logic\n\nIterates detected/specified environments, fetches templates via `getTemplatesForEnvironment()`, checks `existsSync(fullPath)` → skips if `force=false` (adds to `filesSkipped`), otherwise writes `template.content` to `template.path` (adds to `filesCreated`). Special case: Claude environments trigger `.claude/hooks/are-session-end.js` creation via `readBundledHook('are-session-end.js')` copy operation with same skip/force semantics.\n\n## Environment Resolution\n\nWhen `options.environment` provided: constructs single-element array using `configDirMap: Record<EnvironmentType, string>` mapping `{'claude': '.claude', 'opencode': '.opencode', 'aider': '.aider', 'gemini': '.gemini'}`. Otherwise invokes `detectEnvironments(projectRoot)` for auto-discovery.\n### templates.ts\n**Purpose:** Generates AI assistant integration templates for eight ARE commands (`init`, `discover`, `generate`, `update`, `speci...\n\n**Generates AI assistant integration templates for eight ARE commands (`init`, `discover`, `generate`, `update`, `specify`, `rebuild`, `clean`, `help`) targeting Claude Code, OpenCode, and Gemini CLI, with platform-specific frontmatter (YAML vs TOML), path conventions (.claude/skills/, .opencode/commands/, .gemini/commands/), and background execution workflows.**\n\n## Exports\n\n**`getClaudeTemplates()`** → `IntegrationTemplate[]` — returns templates for `.claude/skills/are-{command}/SKILL.md` with `name:` frontmatter.\n\n**`getOpenCodeTemplates()`** → `IntegrationTemplate[]` — returns templates for `.opencode/commands/are-{command}.md` with `agent: build` frontmatter.\n\n**`getGeminiTemplates()`** → `IntegrationTemplate[]` — returns templates for `.gemini/commands/are-{command}.toml` in TOML format (`description = \"...\"`, `prompt = \"\"\"...\"\"\"`).\n\n## Command Definitions\n\n**`COMMANDS`** — readonly object mapping eight command names to `{description: string, argumentHint: string, content: string}`. `content` contains markdown with `<execution>` sections, template variables `COMMAND_PREFIX`, `VERSION_FILE_PATH`.\n\n**`generate`** — \"Generate AI-friendly documentation for the entire codebase\", args `[path] [--dry-run] [--concurrency N] [--fail-fast] [--debug] [--trace]`, 5-step workflow: display version from `VERSION_FILE_PATH`, delete `.agents-reverse-engineer/progress.log`, run `npx agents-reverse-engineer@latest generate $ARGUMENTS` with `run_in_background: true`, poll progress.log every 15s showing \"X/Y files analyzed, ~Zm remaining\" (Read tool with `offset`, TaskOutput with `block: false`), summarize file/directory counts and quality warnings. Describes two-phase pipeline: concurrent `.sum` file analysis with YAML frontmatter (`content_hash`, `file_type`, `purpose`, `public_interface`, `dependencies`, `patterns`), post-order `AGENTS.md` aggregation + `CLAUDE.md` pointers.\n\n**`update`** — \"Incrementally update documentation for changed files\", args `[path] [--uncommitted] [--dry-run] [--concurrency N] [--fail-fast] [--debug] [--trace]`, mirrors `generate` 5-step workflow, shows \"X/Y files updated, ~Zm remaining\", summarizes files updated/unchanged/orphaned.\n\n**`init`** — \"Initialize agents-reverse-engineer configuration\", no args, 2-step: display version, run `npx agents-reverse-engineer@latest init`, creates `.agents-reverse-engineer/config.yaml`.\n\n**`discover`** — \"Discover files in codebase\", args `[path] [--debug] [--trace]`, 6-step workflow with **STRICT RULES** preamble (\"DO NOT add ANY flags the user did not explicitly type\"), runs `discover $ARGUMENTS` in background, polls progress.log every 10s, reads `GENERATION-PLAN.md` and `config.yaml`, classifies Phase 1 files into seven categories with regex patterns: test/spec (`*.test.*`, `*.spec.*`, `__tests__/**`, `__mocks__/**`, `*.stories.*`, `*.story.*`), CI/CD (`.github/workflows/*.yml`, `.gitlab-ci.yml`, `Jenkinsfile`, `.circleci/**`, `.travis.yml`), tool configs (`.eslintrc*`, `.prettierrc*`, `jest.config.*`, `.editorconfig`, `babel.config.*`, `webpack.config.*`, `vite.config.*`, `rollup.config.*`, `tsconfig*.json`, `.lintstagedrc*`, `.huskyrc*`, `.stylelintrc*`, `commitlint.config.*`), migrations (paths containing `migrations/` or `*.migration.*`), fixtures/snapshots (`__snapshots__/**`, `*.fixture.*`, `fixtures/**`, `test-data/**`, `testdata/**`), type declarations (`*.d.ts`), Docker/infra (`Dockerfile*`, `docker-compose*`, `*.Dockerfile`, `k8s/**`, `terraform/**`, `helm/**`). Presents summary table with counts/examples/proposed globs, skips categories with zero matches or already-excluded patterns, uses `AskUserQuestion` with `multiSelect: true`, appends accepted patterns to `config.yaml` `exclude.patterns` via Edit tool.\n\n**`clean`** — \"Delete all generated documentation artifacts (.sum, AGENTS.md, plan)\", args `[path] [--dry-run]`, **STRICT RULES** enforcing exact `clean $ARGUMENTS` invocation with zero added flags, displays version, runs command, reports deletion count. Deletes `.agents-reverse-engineer/GENERATION-PLAN.md`, `*.sum`, `AGENTS.md`, `CLAUDE.md`.\n\n**`specify`** — \"Generate project specification from AGENTS.md docs\", args `[path] [--dry-run] [--output <path>] [--multi-file] [--force] [--debug] [--trace]`, 5-step background workflow deleting progress.log, running command, polling every 15s, summarizing AGENTS.md file count and output paths. Auto-runs `generate` if no AGENTS.md exist. Options: `--output` (default specs/SPEC.md), `--multi-file` (split into multiple files).\n\n**`rebuild`** — \"Reconstruct project from specification documents\", args `[path] [--dry-run] [--output <path>] [--force] [--concurrency N] [--fail-fast] [--debug] [--trace]`, 5-step background workflow showing \"X/Y rebuild units completed\", reads `specs/`, partitions into ordered units via `===FILE: path===`/`===END_FILE===` delimiter parsing, processes sequentially between groups with concurrent pool per group, exit codes 0 (success), 1 (partial failure), 2 (total failure). Options: `--output` (default rebuild/), `--force` (wipe output directory).\n\n**`help`** — \"Show available ARE commands and usage guide\", no args, `<objective>` section mandating display version first, output `<reference>` block with NO additional commentary. Reference: Quick Start (init → generate → update), eight command entries with flag tables (`--concurrency N`, `--dry-run`, `--uncommitted`, `--multi-file`, `--force`, `--fail-fast`, `--debug`, `--trace`), CLI installation (`npx agents-reverse-engineer install --runtime <claude|opencode|gemini|all> -g|-l`, flags: `--runtime`, `-g/--global`, `-l/--local`, `--force`), config.yaml schema (exclude.patterns, vendorDirs, binaryExtensions, options.followSymlinks/maxFileSize, output.colors), generated file formats (*.sum YAML frontmatter: `file_type`, `generated_at`, `content_hash`, `purpose`, `public_interface`, `dependencies`, `patterns`, `related_files`; AGENTS.md directory overviews; CLAUDE.md pointer), common workflows (initial: init+generate, after changes: update, full regen: clean+generate, preview: discover+generate --dry-run), tips (custom exclusions via config.yaml, hook auto-update), resources (GitHub repo https://github.com/GeoloeG-IsT/agents-reverse-engineer, update: `npx agents-reverse-engineer@latest install --force`).\n\n## Platform Configuration\n\n**`PLATFORM_CONFIGS`** — readonly `Record<'claude' | 'opencode' | 'gemini', PlatformConfig>`.\n\n**`PlatformConfig`** — interface: `commandPrefix: string` (/are- for all), `pathPrefix: string`, `filenameSeparator: string`, `extraFrontmatter?: string`, `usesName: boolean`, `versionFilePath: string`.\n\n**Claude**: `pathPrefix: '.claude/skills/'`, `filenameSeparator: '.'`, `usesName: true`, `versionFilePath: '.claude/ARE-VERSION'` → `.claude/skills/are-{command}/SKILL.md`.\n\n**OpenCode**: `pathPrefix: '.opencode/commands/'`, `filenameSeparator: '-'`, `extraFrontmatter: 'agent: build'`, `usesName: false`, `versionFilePath: '.opencode/ARE-VERSION'` → `.opencode/commands/are-{command}.md`.\n\n**Gemini**: `pathPrefix: '.gemini/commands/'`, `filenameSeparator: '-'`, `usesName: false`, `versionFilePath: '.gemini/ARE-VERSION'` → `.gemini/commands/are-{command}.toml`.\n\n## Template Generation\n\n**`buildFrontmatter(platform, commandName, description)`** → `string` — YAML frontmatter wrapped in `---`: adds `name: are-{command}` if `config.usesName`, always adds `description:`, appends `config.extraFrontmatter` if present.\n\n**`buildGeminiToml(commandName, command)`** → `string` — TOML format: `description = \"...\"` line, optional `# Arguments:` comment if `argumentHint`, triple-quoted `prompt = \"\"\"...\"\"\"` with placeholder-replaced `command.content`.\n\n**`buildTemplate(platform, commandName, command)`** → `IntegrationTemplate` — branches: Gemini calls `buildGeminiToml()` returning `{filename: 'are-{command}.toml', path: '.gemini/commands/are-{command}.toml', content}`; Claude/OpenCode calls `buildFrontmatter()` returning `{filename: 'SKILL.md' | 'are-{command}.md', path: '.claude/skills/are-{command}/SKILL.md' | '.opencode/commands/are-{command}.md', content: frontmatter + '\\n\\n' + replacedContent + '\\n'}`. Replaces `COMMAND_PREFIX` → `config.commandPrefix`, `VERSION_FILE_PATH` → `config.versionFilePath`.\n\n**`getTemplatesForPlatform(platform)`** → `IntegrationTemplate[]` — maps `Object.entries(COMMANDS)` to `buildTemplate(platform, name, command)`.\n\n## Workflow Patterns\n\n**Background execution** (generate, update, discover, specify, rebuild): (1) read `VERSION_FILE_PATH`, display \"agents-reverse-engineer vX.Y.Z\", (2) delete `.agents-reverse-engineer/progress.log`, (3) run `npx agents-reverse-engineer@latest {command} $ARGUMENTS` with `run_in_background: true`, (4) poll progress.log every 10-15s via Read tool with `offset` (last ~20 lines), TaskOutput with `block: false`, keep polling if file absent, (5) summarize completion.\n\n**Synchronous execution** (init, clean): read version, run command, report.\n\n**Interactive post-processing** (discover): after background completion, reads GENERATION-PLAN.md + config.yaml, scans Phase 1 files, classifies into seven categories, counts matches with up to 3 examples each, skips zero-match or already-excluded categories, presents table, invokes `AskUserQuestion` (`multiSelect: true`), uses Edit tool to append globs to `config.yaml` `exclude.patterns`.\n\n## Dependencies\n\nImports `IntegrationTemplate` from `./types.js` (`{filename: string, path: string, content: string}`).\n### types.ts\n**Purpose:** Type definitions for AI coding assistant environment detection and integration file generation.\n\n**Type definitions for AI coding assistant environment detection and integration file generation.**\n\n## Exports\n\n`EnvironmentType`: union type `'claude' | 'opencode' | 'aider' | 'gemini'` identifying supported AI assistant runtimes.\n\n`DetectedEnvironment`: `{ type: EnvironmentType; configDir: string; detected: boolean }` representing environment discovery results with config directory path.\n\n`IntegrationTemplate`: `{ filename: string; path: string; content: string }` defining template data for generating command files, hooks, and config entries.\n\n`IntegrationResult`: `{ environment: EnvironmentType; filesCreated: string[]; filesSkipped: string[] }` capturing outcome of integration file installation distinguishing new vs existing files.\n\n## Existing AGENTS.md (update this — preserve stable content, modify only what changed)\n\n<!-- Generated by agents-reverse-engineer v0.8.2 -->\n\n# src/integration\n\nEnvironment detection and integration file generation for three AI coding assistants (Claude Code, OpenCode, Gemini CLI) via directory/file presence checks and platform-specific template rendering (markdown frontmatter, TOML).\n\n## Contents\n\n**[detect.ts](./detect.ts)** — `detectEnvironments(projectRoot): DetectedEnvironment[]` checks `.claude/` OR `CLAUDE.md` (Claude Code), `.opencode/` (OpenCode), `.aider.conf.yml` OR `.aider/` (Aider) via `existsSync()`, returns `{type, configDir, detected: true}[]`. `hasEnvironment(projectRoot, type)` filters results by `EnvironmentType`.\n\n**[generate.ts](./generate.ts)** — `generateIntegrationFiles(projectRoot, options?): Promise<IntegrationResult[]>` orchestrates template writing via `getTemplatesForEnvironment()`, creates `ensureDir()` + `writeFileSync()` with skip-if-exists (unless `force=true`), copies `.claude/hooks/are-session-end.js` via `readBundledHook()` resolved from `hooks/dist/`, returns per-environment `{filesCreated, filesSkipped}`. `getBundledHookPath(hookName)` navigates from `dist/integration/` up two levels to `hooks/dist/${hookName}`.\n\n**[templates.ts](./templates.ts)** — `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` return arrays mapping eight commands (init, discover, generate, update, specify, rebuild, clean, help) to `IntegrationTemplate` structures. `COMMANDS` defines `{description, argumentHint, content}` for each command with multi-paragraph markdown workflows. `buildTemplate(platform, commandName, command)` branches on platform: Gemini → `buildGeminiToml()` (TOML format with `description` + triple-quoted `prompt`), Claude/OpenCode → `buildFrontmatter()` (markdown with `name:`/`description:`/`agent: build`). Replaces `COMMAND_PREFIX` → `/are-`, `VERSION_FILE_PATH` → `.{platform}/ARE-VERSION`.\n\n**[types.ts](./types.ts)** — `EnvironmentType = 'claude' | 'opencode' | 'aider' | 'gemini'`, `DetectedEnvironment = {type, configDir, detected}`, `IntegrationTemplate = {filename, path, content}`, `IntegrationResult = {environment, filesCreated, filesSkipped}`.\n\n## Platform Configuration\n\n**`PLATFORM_CONFIGS`** (templates.ts) maps `'claude' | 'opencode' | 'gemini'` to `PlatformConfig`:\n\n- **Claude**: `pathPrefix: '.claude/skills/'`, `filenameSeparator: '.'`, `usesName: true`, `versionFilePath: '.claude/ARE-VERSION'` → creates `.claude/skills/are-{command}/SKILL.md` directories with `name:` frontmatter.\n- **OpenCode**: `pathPrefix: '.opencode/commands/'`, `filenameSeparator: '-'`, `extraFrontmatter: 'agent: build'`, `usesName: false`, `versionFilePath: '.opencode/ARE-VERSION'` → creates `.opencode/commands/are-{command}.md` flat files.\n- **Gemini**: `pathPrefix: '.gemini/commands/'`, `filenameSeparator: '-'`, `usesName: false`, `versionFilePath: '.gemini/ARE-VERSION'` → creates `.gemini/commands/are-{command}.toml` TOML files.\n\nAll platforms use `commandPrefix: '/are-'`.\n\n## Detection Logic\n\n**Claude Code**: triggers when `.claude/` directory OR `CLAUDE.md` file exists, assigns `configDir: '.claude'`.\n\n**OpenCode**: triggers when `.opencode/` directory exists, assigns `configDir: '.opencode'`.\n\n**Aider**: triggers when `.aider.conf.yml` file OR `.aider/` directory exists, assigns `configDir: '.aider'`.\n\n**Gemini**: no detection implemented (manual via `options.environment='gemini'`).\n\n## Command Workflows\n\nAll background commands (generate, update, discover, specify, rebuild) follow 4-step pattern: (1) read `VERSION_FILE_PATH` via Read tool, display \"agents-reverse-engineer vX.Y.Z\", (2) `Bash` invokes `npx agents-reverse-engineer@latest {command} $ARGUMENTS` with `run_in_background: true`, (3) poll `.agents-reverse-engineer/progress.log` every 10-15s using Read with `offset` showing \"X/Y units processed\", check TaskOutput with `block: false`, (4) summarize completion results.\n\n**discover command** (interactive workflow): after background completion, reads `GENERATION-PLAN.md` + `config.yaml`, classifies Phase 1 files into seven categories (test/spec: `*.test.*`, `*.spec.*`, `__tests__/**`, `__mocks__/**`, `*.stories.*`; CI/CD: `.github/workflows/*.yml`, `.gitlab-ci.yml`, `Jenkinsfile`, `.circleci/**`, `.travis.yml`; tool configs: `.eslintrc*`, `.prettierrc*`, `jest.config.*`, `.editorconfig`, `babel.config.*`, `webpack.config.*`, `vite.config.*`, `rollup.config.*`, `tsconfig*.json`, `.lintstagedrc*`, `.huskyrc*`, `.stylelintrc*`, `commitlint.config.*`; migrations: `**/migrations/**`, `*.migration.*`; fixtures/snapshots: `__snapshots__/**`, `*.fixture.*`, `fixtures/**`, `test-data/**`, `testdata/**`; type declarations: `*.d.ts`; Docker/infra: `Dockerfile*`, `docker-compose*`, `*.Dockerfile`, `k8s/**`, `terraform/**`, `helm/**`), counts matches showing ≤3 examples, skips zero-match categories, presents summary table, invokes `AskUserQuestion` with `multiSelect: true`, appends selected globs to `config.yaml` `exclude.patterns` via Edit tool.\n\n**help command**: displays version from `VERSION_FILE_PATH`, outputs `<reference>` block with NO additional commentary containing: Quick Start (init → generate → update), eight command entries with flags (`--concurrency N`, `--dry-run`, `--uncommitted`, `--multi-file`, `--force`, `--fail-fast`, `--debug`, `--trace`), installation instructions (`npx agents-reverse-engineer install --runtime <rt> -g|-l`), config.yaml schema (exclude.patterns, vendorDirs, binaryExtensions, options, output.colors), file formats (*.sum YAML frontmatter, AGENTS.md, CLAUDE.md pointer), common workflows, tips, resources.\n\n## Integration with CLI\n\nUsed by `src/cli/init.ts` during installation workflow. `src/installer/operations.ts` calls `generateIntegrationFiles()` after config initialization, reads bundled hooks from `hooks/dist/` distributed via `prepublishOnly` script (`scripts/build-hooks.js`).\n\n## Behavioral Contracts\n\n### Environment Resolution Priority\n```javascript\n// When options.environment provided:\nconfigDirMap = { 'claude': '.claude', 'opencode': '.opencode', 'aider': '.aider', 'gemini': '.gemini' }\n// Otherwise: detectEnvironments(projectRoot)\n```\n\n### File Creation Logic\n```javascript\nif (existsSync(fullPath) && !force) {\n  filesSkipped.push(template.path)\n} else {\n  writeFileSync(fullPath, template.content)\n  filesCreated.push(template.path)\n}\n```\n\n### Hook Path Resolution\n```javascript\n// From dist/integration/ → hooks/dist/\npath.join(__dirname, '..', '..', 'hooks', 'dist', hookName)\n```\n\n### Progress Polling Pattern\n```javascript\n// Read last ~20 lines every 10-15s\nRead('.agents-reverse-engineer/progress.log', { offset: max(0, lineCount - 20) })\n// Continues even if file doesn't exist yet\n```\n\n### Category Classification Regex\n- **Tests/Specs**: `/\\.(test|spec)\\./`, `/__tests__/`, `/__mocks__/`, `/\\.(stories|story)\\./`\n- **CI/CD**: `/\\.github\\/workflows\\/.*\\.yml$/`, `/\\.gitlab-ci\\.yml$/`, `/Jenkinsfile$/`, `/\\.circleci\\//`, `/\\.travis\\.yml$/`\n- **Tool Configs**: `/\\.eslintrc/`, `/\\.prettierrc/`, `/jest\\.config\\./`, `/\\.editorconfig$/`, `/babel\\.config\\./`, `/webpack\\.config\\./`, `/vite\\.config\\./`, `/rollup\\.config\\./`, `/tsconfig.*\\.json$/`, `/\\.lintstagedrc/`, `/\\.huskyrc/`, `/\\.stylelintrc/`, `/commitlint\\.config\\./`\n- **Migrations**: `/\\/migrations\\//`, `/\\.migration\\./`\n- **Fixtures/Snapshots**: `/__snapshots__/`, `/\\.fixture\\./`, `/\\/fixtures\\//`, `/\\/test-data\\//`, `/\\/testdata\\//`\n- **Type Declarations**: `/\\.d\\.ts$/`\n- **Docker/Infra**: `/^Dockerfile/, `/docker-compose/`, `/\\.Dockerfile$/`, `/\\/k8s\\//`, `/\\/terraform\\//`, `/\\/helm\\//`",
      "systemPrompt": "You are updating an existing AGENTS.md file — a directory-level overview for AI coding assistants. Some file summaries or subdirectory documents have changed, and AGENTS.md needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING AGENTS.md and the CURRENT file summaries and subdirectory documents\n- Preserve the structure, section headings, and descriptions that are still accurate\n- Only modify entries for files or subdirectories whose summaries have changed\n- Add entries for new files, remove entries for deleted files\n- Do NOT reorganize, rephrase, or restructure sections that are unaffected by changes\n- Keep the same section ordering unless files were added/removed in a way that requires regrouping\n- Behavioral Contracts section: preserve verbatim regex patterns and constants unless source file summaries show they changed\n- Reproduction-Critical Constants: if file summaries reference annex files (.annex.sum), preserve the links. Add links for new annexes, remove links for deleted ones.\n- Workflow & Conventions section: preserve existing rules unless source file summaries show they changed. Add rules from new files, remove rules for deleted files.\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Preserve the existing purpose statement unless the directory's role has fundamentally changed\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n- Cross-module references must use the specifier format from actual import statements\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context",
      "response": "<!-- Generated by agents-reverse-engineer -->\n\n# src/integration\n\nEnvironment detection and integration file generation for three AI coding assistants (Claude Code, OpenCode, Gemini CLI) via directory/file presence checks and platform-specific template rendering (markdown frontmatter, TOML).\n\n## Contents\n\n**[detect.ts](./detect.ts)** — `detectEnvironments(projectRoot): DetectedEnvironment[]` checks `.claude/` OR `CLAUDE.md` (Claude Code), `.opencode/` (OpenCode), `.aider.conf.yml` OR `.aider/` (Aider) via `existsSync()`, returns `{type, configDir, detected: true}[]`. `hasEnvironment(projectRoot, type)` filters results by `EnvironmentType`.\n\n**[generate.ts](./generate.ts)** — `generateIntegrationFiles(projectRoot, options?): Promise<IntegrationResult[]>` orchestrates template writing via `getTemplatesForEnvironment()`, creates `ensureDir()` + `writeFileSync()` with skip-if-exists (unless `force=true`), copies `.claude/hooks/are-session-end.js` via `readBundledHook()` resolved from `hooks/dist/`, returns per-environment `{filesCreated, filesSkipped}`. `getBundledHookPath(hookName)` navigates from `dist/integration/` up two levels to `hooks/dist/${hookName}`.\n\n**[templates.ts](./templates.ts)** — `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` return arrays mapping eight commands (init, discover, generate, update, specify, rebuild, clean, help) to `IntegrationTemplate` structures. `COMMANDS` defines `{description, argumentHint, content}` for each command with multi-paragraph markdown workflows. `buildTemplate(platform, commandName, command)` branches on platform: Gemini → `buildGeminiToml()` (TOML format with `description` + triple-quoted `prompt`), Claude/OpenCode → `buildFrontmatter()` (markdown with `name:`/`description:`/`agent: build`). Replaces `COMMAND_PREFIX` → `/are-`, `VERSION_FILE_PATH` → `.{platform}/ARE-VERSION`.\n\n**[types.ts](./types.ts)** — `EnvironmentType = 'claude' | 'opencode' | 'aider' | 'gemini'`, `DetectedEnvironment = {type, configDir, detected}`, `IntegrationTemplate = {filename, path, content}`, `IntegrationResult = {environment, filesCreated, filesSkipped}`.\n\n## Platform Configuration\n\n**`PLATFORM_CONFIGS`** (templates.ts) maps `'claude' | 'opencode' | 'gemini'` to `PlatformConfig`:\n\n- **Claude**: `pathPrefix: '.claude/skills/'`, `filenameSeparator: '.'`, `usesName: true`, `versionFilePath: '.claude/ARE-VERSION'` → creates `.claude/skills/are-{command}/SKILL.md` directories with `name:` frontmatter.\n- **OpenCode**: `pathPrefix: '.opencode/commands/'`, `filenameSeparator: '-'`, `extraFrontmatter: 'agent: build'`, `usesName: false`, `versionFilePath: '.opencode/ARE-VERSION'` → creates `.opencode/commands/are-{command}.md` flat files.\n- **Gemini**: `pathPrefix: '.gemini/commands/'`, `filenameSeparator: '-'`, `usesName: false`, `versionFilePath: '.gemini/ARE-VERSION'` → creates `.gemini/commands/are-{command}.toml` TOML files.\n\nAll platforms use `commandPrefix: '/are-'`.\n\n## Detection Logic\n\n**Claude Code**: triggers when `.claude/` directory OR `CLAUDE.md` file exists, assigns `configDir: '.claude'`.\n\n**OpenCode**: triggers when `.opencode/` directory exists, assigns `configDir: '.opencode'`.\n\n**Aider**: triggers when `.aider.conf.yml` file OR `.aider/` directory exists, assigns `configDir: '.aider'`.\n\n**Gemini**: no detection implemented (manual via `options.environment='gemini'`).\n\n## Command Workflows\n\nAll background commands (generate, update, discover, specify, rebuild) follow 5-step pattern: (1) read `VERSION_FILE_PATH` via Read tool, display \"agents-reverse-engineer vX.Y.Z\", (2) delete `.agents-reverse-engineer/progress.log`, (3) `Bash` invokes `npx agents-reverse-engineer@latest {command} $ARGUMENTS` with `run_in_background: true`, (4) poll `.agents-reverse-engineer/progress.log` every 10-15s using Read with `offset` showing \"X/Y units processed\", check TaskOutput with `block: false`, (5) summarize completion results.\n\n**generate command**: displays version, deletes progress.log, runs `generate $ARGUMENTS` in background, polls progress.log every 15s showing \"X/Y files analyzed, ~Zm remaining\" via Read with `offset` and TaskOutput with `block: false`, summarizes file/directory counts and quality warnings. Describes two-phase pipeline: concurrent `.sum` file analysis with YAML frontmatter (`content_hash`, `file_type`, `purpose`, `public_interface`, `dependencies`, `patterns`), post-order `AGENTS.md` aggregation + `CLAUDE.md` pointers.\n\n**update command**: mirrors generate 5-step workflow, polls progress.log showing \"X/Y files updated, ~Zm remaining\", summarizes files updated/unchanged/orphaned.\n\n**discover command**: 6-step interactive workflow with STRICT RULES preamble (\"DO NOT add ANY flags the user did not explicitly type\"), runs `discover $ARGUMENTS` in background, polls progress.log every 10s, after completion reads `GENERATION-PLAN.md` + `config.yaml`, classifies Phase 1 files into seven categories (test/spec: `*.test.*`, `*.spec.*`, `__tests__/**`, `__mocks__/**`, `*.stories.*`, `*.story.*`; CI/CD: `.github/workflows/*.yml`, `.gitlab-ci.yml`, `Jenkinsfile`, `.circleci/**`, `.travis.yml`; tool configs: `.eslintrc*`, `.prettierrc*`, `jest.config.*`, `.editorconfig`, `babel.config.*`, `webpack.config.*`, `vite.config.*`, `rollup.config.*`, `tsconfig*.json`, `.lintstagedrc*`, `.huskyrc*`, `.stylelintrc*`, `commitlint.config.*`; migrations: `**/migrations/**`, `*.migration.*`; fixtures/snapshots: `__snapshots__/**`, `*.fixture.*`, `fixtures/**`, `test-data/**`, `testdata/**`; type declarations: `*.d.ts`; Docker/infra: `Dockerfile*`, `docker-compose*`, `*.Dockerfile`, `k8s/**`, `terraform/**`, `helm/**`), counts matches showing ≤3 examples, skips zero-match or already-excluded categories, presents summary table, invokes `AskUserQuestion` with `multiSelect: true`, appends selected globs to `config.yaml` `exclude.patterns` via Edit tool.\n\n**specify command**: 5-step background workflow displaying version, deleting progress.log, running `specify $ARGUMENTS` in background, polling progress.log every 15s, summarizing AGENTS.md file count and output paths. Auto-runs `generate` if no AGENTS.md exist. Options: `--output` (default specs/SPEC.md), `--multi-file` (split into multiple files).\n\n**rebuild command**: 5-step background workflow displaying version, deleting progress.log, running `rebuild $ARGUMENTS` in background, polling progress.log showing \"X/Y rebuild units completed\", summarizing completion. Reads `specs/`, partitions into ordered units via `===FILE: path===`/`===END_FILE===` delimiter parsing, processes sequentially between groups with concurrent pool per group, exit codes 0 (success), 1 (partial failure), 2 (total failure). Options: `--output` (default rebuild/), `--force` (wipe output directory).\n\n**init command**: 2-step synchronous workflow displaying version, running `npx agents-reverse-engineer@latest init`, creates `.agents-reverse-engineer/config.yaml`.\n\n**clean command**: synchronous workflow with STRICT RULES enforcing exact `clean $ARGUMENTS` invocation with zero added flags, displays version, runs command, reports deletion count. Deletes `.agents-reverse-engineer/GENERATION-PLAN.md`, `*.sum`, `AGENTS.md`, `CLAUDE.md`.\n\n**help command**: displays version from `VERSION_FILE_PATH`, outputs `<reference>` block with NO additional commentary containing: Quick Start (init → generate → update), eight command entries with flag tables (`--concurrency N`, `--dry-run`, `--uncommitted`, `--multi-file`, `--force`, `--fail-fast`, `--debug`, `--trace`), CLI installation (`npx agents-reverse-engineer install --runtime <claude|opencode|gemini|all> -g|-l`, flags: `--runtime`, `-g/--global`, `-l/--local`, `--force`), config.yaml schema (exclude.patterns, vendorDirs, binaryExtensions, options.followSymlinks/maxFileSize, output.colors), generated file formats (*.sum YAML frontmatter: `file_type`, `generated_at`, `content_hash`, `purpose`, `public_interface`, `dependencies`, `patterns`, `related_files`; AGENTS.md directory overviews; CLAUDE.md pointer), common workflows (initial: init+generate, after changes: update, full regen: clean+generate, preview: discover+generate --dry-run), tips (custom exclusions via config.yaml, hook auto-update), resources (GitHub repo https://github.com/GeoloeG-IsT/agents-reverse-engineer, update: `npx agents-reverse-engineer@latest install --force`).\n\n## Integration with CLI\n\nUsed by `src/cli/init.ts` during installation workflow. `src/installer/operations.ts` calls `generateIntegrationFiles()` after config initialization, reads bundled hooks from `hooks/dist/` distributed via `prepublishOnly` script (`scripts/build-hooks.js`).\n\n## Behavioral Contracts\n\n### Environment Resolution Priority\n```javascript\n// When options.environment provided:\nconfigDirMap = { 'claude': '.claude', 'opencode': '.opencode', 'aider': '.aider', 'gemini': '.gemini' }\n// Otherwise: detectEnvironments(projectRoot)\n```\n\n### File Creation Logic\n```javascript\nif (existsSync(fullPath) && !force) {\n  filesSkipped.push(template.path)\n} else {\n  writeFileSync(fullPath, template.content)\n  filesCreated.push(template.path)\n}\n```\n\n### Hook Path Resolution\n```javascript\n// From dist/integration/ → hooks/dist/\npath.join(__dirname, '..', '..', 'hooks', 'dist', hookName)\n```\n\n### Progress Polling Pattern\n```javascript\n// Read last ~20 lines every 10-15s\nRead('.agents-reverse-engineer/progress.log', { offset: max(0, lineCount - 20) })\n// Continues even if file doesn't exist yet\n```\n\n### Category Classification Regex\n- **Tests/Specs**: `/\\.(test|spec)\\./`, `/__tests__/`, `/__mocks__/`, `/\\.(stories|story)\\./`\n- **CI/CD**: `/\\.github\\/workflows\\/.*\\.yml$/`, `/\\.gitlab-ci\\.yml$/`, `/Jenkinsfile$/`, `/\\.circleci\\//`, `/\\.travis\\.yml$/`\n- **Tool Configs**: `/\\.eslintrc/`, `/\\.prettierrc/`, `/jest\\.config\\./`, `/\\.editorconfig$/`, `/babel\\.config\\./`, `/webpack\\.config\\./`, `/vite\\.config\\./`, `/rollup\\.config\\./`, `/tsconfig.*\\.json$/`, `/\\.lintstagedrc/`, `/\\.huskyrc/`, `/\\.stylelintrc/`, `/commitlint\\.config\\./`\n- **Migrations**: `/\\/migrations\\//`, `/\\.migration\\./`\n- **Fixtures/Snapshots**: `/__snapshots__/`, `/\\.fixture\\./`, `/\\/fixtures\\//`, `/\\/test-data\\//`, `/\\/testdata\\//`\n- **Type Declarations**: `/\\.d\\.ts$/`\n- **Docker/Infra**: `/^Dockerfile/, `/docker-compose/`, `/\\.Dockerfile$/`, `/\\/k8s\\//`, `/\\/terraform\\//`, `/\\/helm\\//`",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 3066,
      "cacheReadTokens": 15986,
      "cacheCreationTokens": 14143,
      "latencyMs": 38359,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": []
    },
    {
      "timestamp": "2026-02-12T08:38:06.404Z",
      "prompt": "Generate AGENTS.md for directory: \"src\" (src)\n\n## File Summaries (1 files)\n\n### version.ts\n**Purpose:** Exports `getVersion()` reading package.json from `__dirname/../package.json` via ESM import.meta.url resolution, retu...\n\n**Exports `getVersion()` reading package.json from `__dirname/../package.json` via ESM import.meta.url resolution, returning `version` field or `'unknown'` fallback.**\n\n## Public Interface\n\n`getVersion(): string` — Resolves `import.meta.url` → `fileURLToPath()` → `dirname()` → `join(__dirname, '..', 'package.json')`, parses JSON via `readFileSync()`, returns `packageJson.version || 'unknown'`, catches all errors returning `'unknown'`.\n\n## Integration Points\n\nUsed by CLI commands for `--version` flags and telemetry metadata. Assumes package.json exists one directory above compiled dist/version.js location (src/ → dist/ build output).\n\n## Subdirectories\n\n### installer/\n<!-- Generated by agents-reverse-engineer v0.8.3 -->\n\n# src/installer\n\nInteractive installer module orchestrating command template/session hook deployment to AI runtime config directories (`.claude/`, `.gemini/`, `.config/opencode/`) with TTY-aware prompts, settings.json hook registration via jsonc-parser, permission injection for Claude, version tracking, and symmetric uninstall operations.\n\n## Contents\n\n**[banner.ts](./banner.ts)** — Terminal UI helpers: `displayBanner()` renders green ASCII \"ARE\" box-drawing art + version, `showHelp()` prints usage table (`--runtime`, `-g`, `-l`, `-u`, `--force`, `-q`, `-h`) + 3 examples, `showSuccess()`/`showError()`/`showWarning()`/`showInfo()` emit picocolors-styled messages, `showNextSteps()` displays 7-step post-install guide (/are-help, /are-init, /are-discover, /are-generate, /are-update, /are-specify, /are-clean) + GitHub docs link, `VERSION` constant from `getVersion()`.\n\n**[index.ts](./index.ts)** — Main entry point: `runInstaller()` routes install/uninstall workflows via `runInstall()`/`runUninstall()`, `parseInstallerArgs()` parses CLI flags (`--runtime`, `-g/--global`, `-l/--local`, `--force`, `-q/--quiet`, `-h/--help`) validating runtime against `['claude', 'opencode', 'gemini', 'all']`, `displayInstallResults()`/`displayUninstallResults()` format operation summaries with file counts + hook status. Non-interactive mode requires `--runtime` + location flag or exits code 1. Interactive mode calls `selectRuntime()`/`selectLocation()` prompts. Re-exports types/functions from `./types.js`, `./paths.js`, `./banner.js`, `./prompts.js`.\n\n**[operations.ts](./operations.ts)** — Install operations: `installFilesForRuntime()` copies command templates from `getTemplatesForRuntime()` to `resolveInstallPath()`, writes hooks (Claude/Gemini) or plugins (OpenCode) from `getBundledHookPath()` (navigates `../../hooks/dist/`), calls `registerHooks()`/`registerPermissions()` via jsonc-parser `modify()`/`applyEdits()` preserving comments, writes `ARE-VERSION` file via `writeVersionFile()`. `registerClaudeHooks()` constructs `node ${runtimeDir}/hooks/${hookDef.filename}` commands into nested hooks array. `registerGeminiHooks()` uses flat GeminiHook schema with name field. `registerPermissions()` merges `ARE_PERMISSIONS` (7 patterns: `Bash(npx agents-reverse-engineer@latest init*)`, `discover*`, `generate*`, `update*`, `clean*`, `Bash(rm -f .agents-reverse-engineer/progress.log*)`, `Bash(sleep *)`) into settings.permissions.allow. `verifyInstallation()` filters files via `existsSync()`. `formatInstallResult()` builds human-readable lines. `getPackageVersion()` reads `../../package.json` version field from dist/installer/operations.js. Returns `InstallerResult` with `filesCreated`/`filesSkipped`/`errors`/`hookRegistered`/`versionWritten`.\n\n**[paths.ts](./paths.ts)** — Path resolver: `getAllRuntimes()` returns `['claude', 'opencode', 'gemini']`, `getRuntimePaths()` returns `RuntimePaths` with `global` (absolute config dir), `local` (relative project dir like `.claude`), `settingsFile` (settings.json path). `resolveInstallPath()` joins projectRoot + local dir for local installs, returns global path otherwise. `getSettingsPath()` returns settings.json absolute path. `isRuntimeInstalledLocally()`/`isRuntimeInstalledGlobally()` check directory existence via `stat()`. `getInstalledRuntimes()` returns array of locally installed runtimes. Uses env var overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `XDG_CONFIG_HOME`, `GEMINI_CONFIG_DIR`. Defaults: Claude `~/.claude`, OpenCode `~/.config/opencode`, Gemini `~/.gemini`.\n\n**[prompts.ts](./prompts.ts)** — Interactive prompts: `isInteractive()` returns `process.stdin.isTTY === true`. `selectOption()` routes to `arrowKeySelect()` (TTY) or `numberedSelect()` (CI/non-TTY). `selectRuntime()` prompts for runtime from `['claude', 'opencode', 'gemini', 'all']`. `selectLocation()` prompts for `'global'` (~/.claude) or `'local'` (./.claude). `confirmAction()` Yes/No selection. `arrowKeySelect()` enables `readline.emitKeypressEvents()` + `setRawMode(true)`, listens for up/down/return keypresses, renders via ANSI escape codes (`\\x1b[${n}A`, `\\x1b[2K`, `\\x1b[1B`), guarantees cleanup via `cleanupRawMode()` in finally block + `process.on('exit')` + `process.on('SIGINT')`.\n\n**[types.ts](./types.ts)** — TypeScript interfaces: `Runtime = 'claude' | 'opencode' | 'gemini' | 'all'`, `Location = 'global' | 'local'`, `InstallerArgs` (CLI schema: `runtime?`, `global`, `local`, `uninstall`, `force`, `help`, `quiet`), `InstallerResult` (operation outcome: `success`, `runtime`, `location`, `filesCreated[]`, `filesSkipped[]`, `errors[]`, `hookRegistered?`, `versionWritten?`), `RuntimePaths` (resolved paths: `global`, `local`, `settingsFile`).\n\n**[uninstall.ts](./uninstall.ts)** — Reverses install: `uninstallFilesForRuntime()` deletes command templates from `resolveInstallPath()`, hooks/plugins from `hooks/`/`plugins/` dirs, `ARE-VERSION` file, calls `unregisterHooks()`/`unregisterPermissions()`, `cleanupAreSkillDirs()` (Claude skills), `cleanupLegacyGeminiFiles()` (pre-TOML formats), `cleanupEmptyDirs()` (recursive removal stopping at runtime roots). `unregisterClaudeHooks()`/`unregisterGeminiHooks()` filter settings.json hook arrays removing entries matching `getHookPatterns()` (current `node ${runtimeDir}/hooks/${hookDef.filename}` + legacy `node hooks/${hookDef.filename}` formats) via jsonc-parser. `unregisterPermissions()` removes `ARE_PERMISSIONS` from settings.permissions.allow, cleans empty permissions object. `deleteConfigFolder()` deletes `.agents-reverse-engineer/` via `rmSync({recursive: true, force: true})` only when `location === 'local'`. Returns `InstallerResult` with `filesCreated` repurposed as deleted files, `hookRegistered` as `hookUnregistered`.\n\n## Workflow\n\n### Interactive Install\n1. `parseInstallerArgs()` extracts `--runtime`/`-g`/`-l`/`--force`/`--quiet` flags\n2. `displayBanner()` unless quiet\n3. `selectRuntime()`/`selectLocation()` if missing via TTY arrow keys or numbered fallback\n4. `runInstall()` calls `installFilesForRuntime()` per runtime:\n   - Copy templates from `getTemplatesForRuntime()` to `resolveInstallPath()`\n   - Write hooks from `getBundledHookPath('../../hooks/dist/')` to `hooks/`/`plugins/`\n   - `registerHooks()` → `registerClaudeHooks()`/`registerGeminiHooks()` via jsonc-parser\n   - `registerPermissions()` (Claude only) merges `ARE_PERMISSIONS` into settings.permissions.allow\n   - `writeVersionFile()` writes package.json version to `ARE-VERSION`\n5. `verifyInstallation()` checks `existsSync()` for all created files\n6. `displayInstallResults()` shows filesCreated/filesSkipped/hookRegistered counts\n7. `showNextSteps()` emits 7-step usage guide\n\n### Non-Interactive Install\nRequires `--runtime` + `-g`/`-l` flags or exits code 1. Skips prompts. Same file operations.\n\n### Uninstall\n1. `runUninstall()` calls `uninstallFilesForRuntime()`:\n   - Delete command templates, hooks/plugins, `ARE-VERSION`\n   - `unregisterHooks()` filters settings.json via jsonc-parser\n   - `unregisterPermissions()` removes ARE_PERMISSIONS (Claude)\n   - `cleanupAreSkillDirs()`/`cleanupLegacyGeminiFiles()`/`cleanupEmptyDirs()`\n2. `deleteConfigFolder()` removes `.agents-reverse-engineer/` if local install\n3. `displayUninstallResults()` shows deletion counts\n\n## Behavioral Contracts\n\n### Hook Definitions\n```typescript\nconst ARE_HOOKS: HookDefinition[] = [\n  // { event: 'SessionStart', filename: 'are-check-update.js', name: 'are-check-update' },\n  // { event: 'SessionEnd', filename: 'are-session-end.js', name: 'are-session-end' }, // Disabled - causing issues\n];\n```\nCurrently empty array (all hooks disabled). Must mirror across operations.ts/uninstall.ts.\n\n### Plugin Definitions\n```typescript\nconst ARE_PLUGINS: PluginDefinition[] = [\n  // Disabled - causing issues in OpenCode\n  // { srcFilename: 'opencode-are-check-update.js', destFilename: 'are-check-update.js' },\n];\n```\nCurrently empty array (all plugins disabled). Must mirror operations.ts.\n\n### Permission Patterns\n```typescript\nconst ARE_PERMISSIONS = [\n  'Bash(npx agents-reverse-engineer@latest init*)',\n  'Bash(npx agents-reverse-engineer@latest discover*)',\n  'Bash(npx agents-reverse-engineer@latest generate*)',\n  'Bash(npx agents-reverse-engineer@latest update*)',\n  'Bash(npx agents-reverse-engineer@latest clean*)',\n  'Bash(rm -f .agents-reverse-engineer/progress.log*)',\n  'Bash(sleep *)',\n];\n```\nMust mirror across operations.ts/uninstall.ts.\n\n### Hook Command Format\nClaude/Gemini: `node ${runtimeDir}/hooks/${hookDef.filename}` where runtimeDir is `.claude` or `.gemini`.\n\n### Valid Runtimes\n`['claude', 'opencode', 'gemini', 'all']` (index.ts:63).\n\n### Error Messages\n- `'Missing --runtime flag (required in non-interactive mode)'`\n- `'Missing -g/--global or -l/--local flag (required in non-interactive mode)'`\n- `'Unable to determine runtime and location'`\n- `'Installation verification failed - some files missing:'`\n\n### GitHub Docs URL\n`'https://github.com/GeoloeG-IsT/agents-reverse-engineer'` (index.ts:290).\n\n### Bundled Hook Path\n`../../hooks/dist/${hookName}` from `dist/installer/operations.js`.\n\n### jsonc-parser Formatting\n```typescript\nformattingOptions: { tabSize: 2, insertSpaces: true }\n```\n\n### Empty Directory Cleanup Boundary\nStops at `baseName !== '.claude' && baseName !== '.opencode' && baseName !== '.gemini' && baseName !== '.config'`.\n\n## Integration Points\n\nDepends on `../integration/templates.js` (`getClaudeTemplates`, `getOpenCodeTemplates`, `getGeminiTemplates`), `../version.js` (`getVersion`). Called by `src/cli/index.ts` after command routing. Uses `jsonc-parser` for comment-preserving JSON edits, `readline` for keypress events, `picocolors` for styled output.\n### integration/\n<!-- Generated by agents-reverse-engineer v0.8.3 -->\n\n# src/integration\n\nEnvironment detection and integration file generation for three AI coding assistants (Claude Code, OpenCode, Gemini CLI) via directory/file presence checks and platform-specific template rendering (markdown frontmatter, TOML).\n\n## Contents\n\n**[detect.ts](./detect.ts)** — `detectEnvironments(projectRoot): DetectedEnvironment[]` checks `.claude/` OR `CLAUDE.md` (Claude Code), `.opencode/` (OpenCode), `.aider.conf.yml` OR `.aider/` (Aider) via `existsSync()`, returns `{type, configDir, detected: true}[]`. `hasEnvironment(projectRoot, type)` filters results by `EnvironmentType`.\n\n**[generate.ts](./generate.ts)** — `generateIntegrationFiles(projectRoot, options?): Promise<IntegrationResult[]>` orchestrates template writing via `getTemplatesForEnvironment()`, creates `ensureDir()` + `writeFileSync()` with skip-if-exists (unless `force=true`), copies `.claude/hooks/are-session-end.js` via `readBundledHook()` resolved from `hooks/dist/`, returns per-environment `{filesCreated, filesSkipped}`. `getBundledHookPath(hookName)` navigates from `dist/integration/` up two levels to `hooks/dist/${hookName}`.\n\n**[templates.ts](./templates.ts)** — `getClaudeTemplates()`, `getOpenCodeTemplates()`, `getGeminiTemplates()` return arrays mapping eight commands (init, discover, generate, update, specify, rebuild, clean, help) to `IntegrationTemplate` structures. `COMMANDS` defines `{description, argumentHint, content}` for each command with multi-paragraph markdown workflows. `buildTemplate(platform, commandName, command)` branches on platform: Gemini → `buildGeminiToml()` (TOML format with `description` + triple-quoted `prompt`), Claude/OpenCode → `buildFrontmatter()` (markdown with `name:`/`description:`/`agent: build`). Replaces `COMMAND_PREFIX` → `/are-`, `VERSION_FILE_PATH` → `.{platform}/ARE-VERSION`.\n\n**[types.ts](./types.ts)** — `EnvironmentType = 'claude' | 'opencode' | 'aider' | 'gemini'`, `DetectedEnvironment = {type, configDir, detected}`, `IntegrationTemplate = {filename, path, content}`, `IntegrationResult = {environment, filesCreated, filesSkipped}`.\n\n## Platform Configuration\n\n**`PLATFORM_CONFIGS`** (templates.ts) maps `'claude' | 'opencode' | 'gemini'` to `PlatformConfig`:\n\n- **Claude**: `pathPrefix: '.claude/skills/'`, `filenameSeparator: '.'`, `usesName: true`, `versionFilePath: '.claude/ARE-VERSION'` → creates `.claude/skills/are-{command}/SKILL.md` directories with `name:` frontmatter.\n- **OpenCode**: `pathPrefix: '.opencode/commands/'`, `filenameSeparator: '-'`, `extraFrontmatter: 'agent: build'`, `usesName: false`, `versionFilePath: '.opencode/ARE-VERSION'` → creates `.opencode/commands/are-{command}.md` flat files.\n- **Gemini**: `pathPrefix: '.gemini/commands/'`, `filenameSeparator: '-'`, `usesName: false`, `versionFilePath: '.gemini/ARE-VERSION'` → creates `.gemini/commands/are-{command}.toml` TOML files.\n\nAll platforms use `commandPrefix: '/are-'`.\n\n## Detection Logic\n\n**Claude Code**: triggers when `.claude/` directory OR `CLAUDE.md` file exists, assigns `configDir: '.claude'`.\n\n**OpenCode**: triggers when `.opencode/` directory exists, assigns `configDir: '.opencode'`.\n\n**Aider**: triggers when `.aider.conf.yml` file OR `.aider/` directory exists, assigns `configDir: '.aider'`.\n\n**Gemini**: no detection implemented (manual via `options.environment='gemini'`).\n\n## Command Workflows\n\nAll background commands (generate, update, discover, specify, rebuild) follow 5-step pattern: (1) read `VERSION_FILE_PATH` via Read tool, display \"agents-reverse-engineer vX.Y.Z\", (2) delete `.agents-reverse-engineer/progress.log`, (3) `Bash` invokes `npx agents-reverse-engineer@latest {command} $ARGUMENTS` with `run_in_background: true`, (4) poll `.agents-reverse-engineer/progress.log` every 10-15s using Read with `offset` showing \"X/Y units processed\", check TaskOutput with `block: false`, (5) summarize completion results.\n\n**generate command**: displays version, deletes progress.log, runs `generate $ARGUMENTS` in background, polls progress.log every 15s showing \"X/Y files analyzed, ~Zm remaining\" via Read with `offset` and TaskOutput with `block: false`, summarizes file/directory counts and quality warnings. Describes two-phase pipeline: concurrent `.sum` file analysis with YAML frontmatter (`content_hash`, `file_type`, `purpose`, `public_interface`, `dependencies`, `patterns`), post-order `AGENTS.md` aggregation + `CLAUDE.md` pointers.\n\n**update command**: mirrors generate 5-step workflow, polls progress.log showing \"X/Y files updated, ~Zm remaining\", summarizes files updated/unchanged/orphaned.\n\n**discover command**: 6-step interactive workflow with STRICT RULES preamble (\"DO NOT add ANY flags the user did not explicitly type\"), runs `discover $ARGUMENTS` in background, polls progress.log every 10s, after completion reads `GENERATION-PLAN.md` + `config.yaml`, classifies Phase 1 files into seven categories (test/spec: `*.test.*`, `*.spec.*`, `__tests__/**`, `__mocks__/**`, `*.stories.*`, `*.story.*`; CI/CD: `.github/workflows/*.yml`, `.gitlab-ci.yml`, `Jenkinsfile`, `.circleci/**`, `.travis.yml`; tool configs: `.eslintrc*`, `.prettierrc*`, `jest.config.*`, `.editorconfig`, `babel.config.*`, `webpack.config.*`, `vite.config.*`, `rollup.config.*`, `tsconfig*.json`, `.lintstagedrc*`, `.huskyrc*`, `.stylelintrc*`, `commitlint.config.*`; migrations: `**/migrations/**`, `*.migration.*`; fixtures/snapshots: `__snapshots__/**`, `*.fixture.*`, `fixtures/**`, `test-data/**`, `testdata/**`; type declarations: `*.d.ts`; Docker/infra: `Dockerfile*`, `docker-compose*`, `*.Dockerfile`, `k8s/**`, `terraform/**`, `helm/**`), counts matches showing ≤3 examples, skips zero-match or already-excluded categories, presents summary table, invokes `AskUserQuestion` with `multiSelect: true`, appends selected globs to `config.yaml` `exclude.patterns` via Edit tool.\n\n**specify command**: 5-step background workflow displaying version, deleting progress.log, running `specify $ARGUMENTS` in background, polling progress.log every 15s, summarizing AGENTS.md file count and output paths. Auto-runs `generate` if no AGENTS.md exist. Options: `--output` (default specs/SPEC.md), `--multi-file` (split into multiple files).\n\n**rebuild command**: 5-step background workflow displaying version, deleting progress.log, running `rebuild $ARGUMENTS` in background, polling progress.log showing \"X/Y rebuild units completed\", summarizing completion. Reads `specs/`, partitions into ordered units via `===FILE: path===`/`===END_FILE===` delimiter parsing, processes sequentially between groups with concurrent pool per group, exit codes 0 (success), 1 (partial failure), 2 (total failure). Options: `--output` (default rebuild/), `--force` (wipe output directory).\n\n**init command**: 2-step synchronous workflow displaying version, running `npx agents-reverse-engineer@latest init`, creates `.agents-reverse-engineer/config.yaml`.\n\n**clean command**: synchronous workflow with STRICT RULES enforcing exact `clean $ARGUMENTS` invocation with zero added flags, displays version, runs command, reports deletion count. Deletes `.agents-reverse-engineer/GENERATION-PLAN.md`, `*.sum`, `AGENTS.md`, `CLAUDE.md`.\n\n**help command**: displays version from `VERSION_FILE_PATH`, outputs `<reference>` block with NO additional commentary containing: Quick Start (init → generate → update), eight command entries with flag tables (`--concurrency N`, `--dry-run`, `--uncommitted`, `--multi-file`, `--force`, `--fail-fast`, `--debug`, `--trace`), CLI installation (`npx agents-reverse-engineer install --runtime <claude|opencode|gemini|all> -g|-l`, flags: `--runtime`, `-g/--global`, `-l/--local`, `--force`), config.yaml schema (exclude.patterns, vendorDirs, binaryExtensions, options.followSymlinks/maxFileSize, output.colors), generated file formats (*.sum YAML frontmatter: `file_type`, `generated_at`, `content_hash`, `purpose`, `public_interface`, `dependencies`, `patterns`, `related_files`; AGENTS.md directory overviews; CLAUDE.md pointer), common workflows (initial: init+generate, after changes: update, full regen: clean+generate, preview: discover+generate --dry-run), tips (custom exclusions via config.yaml, hook auto-update), resources (GitHub repo https://github.com/GeoloeG-IsT/agents-reverse-engineer, update: `npx agents-reverse-engineer@latest install --force`).\n\n## Integration with CLI\n\nUsed by `src/cli/init.ts` during installation workflow. `src/installer/operations.ts` calls `generateIntegrationFiles()` after config initialization, reads bundled hooks from `hooks/dist/` distributed via `prepublishOnly` script (`scripts/build-hooks.js`).\n\n## Behavioral Contracts\n\n### Environment Resolution Priority\n```javascript\n// When options.environment provided:\nconfigDirMap = { 'claude': '.claude', 'opencode': '.opencode', 'aider': '.aider', 'gemini': '.gemini' }\n// Otherwise: detectEnvironments(projectRoot)\n```\n\n### File Creation Logic\n```javascript\nif (existsSync(fullPath) && !force) {\n  filesSkipped.push(template.path)\n} else {\n  writeFileSync(fullPath, template.content)\n  filesCreated.push(template.path)\n}\n```\n\n### Hook Path Resolution\n```javascript\n// From dist/integration/ → hooks/dist/\npath.join(__dirname, '..', '..', 'hooks', 'dist', hookName)\n```\n\n### Progress Polling Pattern\n```javascript\n// Read last ~20 lines every 10-15s\nRead('.agents-reverse-engineer/progress.log', { offset: max(0, lineCount - 20) })\n// Continues even if file doesn't exist yet\n```\n\n### Category Classification Regex\n- **Tests/Specs**: `/\\.(test|spec)\\./`, `/__tests__/`, `/__mocks__/`, `/\\.(stories|story)\\./`\n- **CI/CD**: `/\\.github\\/workflows\\/.*\\.yml$/`, `/\\.gitlab-ci\\.yml$/`, `/Jenkinsfile$/`, `/\\.circleci\\//`, `/\\.travis\\.yml$/`\n- **Tool Configs**: `/\\.eslintrc/`, `/\\.prettierrc/`, `/jest\\.config\\./`, `/\\.editorconfig$/`, `/babel\\.config\\./`, `/webpack\\.config\\./`, `/vite\\.config\\./`, `/rollup\\.config\\./`, `/tsconfig.*\\.json$/`, `/\\.lintstagedrc/`, `/\\.huskyrc/`, `/\\.stylelintrc/`, `/commitlint\\.config\\./`\n- **Migrations**: `/\\/migrations\\//`, `/\\.migration\\./`\n- **Fixtures/Snapshots**: `/__snapshots__/`, `/\\.fixture\\./`, `/\\/fixtures\\//`, `/\\/test-data\\//`, `/\\/testdata\\//`\n- **Type Declarations**: `/\\.d\\.ts$/`\n- **Docker/Infra**: `/^Dockerfile/, `/docker-compose/`, `/\\.Dockerfile$/`, `/\\/k8s\\//`, `/\\/terraform\\//`, `/\\/helm\\//`\n\n## Existing AGENTS.md (update this — preserve stable content, modify only what changed)\n\n<!-- Generated by agents-reverse-engineer v0.8.2 -->\n\n# src\n\nTypeScript source root implementing eight-command CLI (`init`, `discover`, `generate`, `update`, `specify`, `rebuild`, `clean`, `install`/`uninstall`), two-phase AI documentation pipeline (file analysis → directory aggregation), iterator-based concurrency control, multi-backend subprocess orchestration (Claude/Gemini/OpenCode), frontmatter-based change detection, quality validation (code-vs-doc/code-vs-code/phantom-paths), specification synthesis, AI-driven reconstruction, and runtime integration (session hooks, slash commands, permission pre-approval).\n\n## Contents\n\n**[version.ts](./version.ts)** — `getVersion()` resolves package.json from `import.meta.url` → `fileURLToPath()` → `dirname()` → `join(__dirname, '..', 'package.json')`, parses via `readFileSync()`, returns `version` field or `'unknown'` on error. Used by CLI `--version` flags and telemetry metadata.\n\n## Subdirectories\n\n**[ai/](./ai/)** — AI service orchestration: subprocess spawning (`claude`/`gemini`/`opencode` CLI tools), exponential backoff retry (rate-limit only, timeouts NOT retried), timeout enforcement (SIGTERM → SIGKILL escalation at +5s), backend auto-detection (PATH scanning with insertion-order priority: Claude > Gemini > OpenCode), telemetry accumulation (`TelemetryEntry[]` → `RunLog` JSON with token/cache/latency/exit code/retry count), NDJSON trace emission (`subprocess:spawn`/`subprocess:exit`/`retry` events), provider abstraction (`AIProvider` interface decoupling transport from business logic). `AIService.call()` wraps provider in `withRetry()` configured with `isRetryable: (err) => err.code === 'RATE_LIMIT'`, records telemetry, emits trace events. `ClaudeBackend` tri-format JSON parser handles CLI ≥2.1.38 arrays, NDJSON, legacy single-object via Zod schema validation. Rate-limit detection: `['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))`. Subprocess SIGKILL via `process.kill(-childPid, 'SIGKILL')` targeting process group. Telemetry cleanup: `cleanupOldLogs(projectRoot, keepRuns)` enforces retention.\n\n**[change-detection/](./change-detection/)** — Git-based file change detection: `isGitRepo()` checks repository status, `getCurrentCommit()` fetches HEAD hash, `getChangedFiles()` detects modifications between `baseCommit` and HEAD via `git diff --name-status -M` with 50% rename threshold, optionally merges uncommitted changes from `git.status()` staged/modified/not_added/deleted arrays. `computeContentHash()` generates SHA-256 hex digest from file content. `computeContentHashFromString()` hashes in-memory strings. `ChangeType = 'added' | 'modified' | 'deleted' | 'renamed'`. Consumed by `src/update/orchestrator.ts` for frontmatter hash comparison triggering incremental regeneration.\n\n**[cli/](./cli/)** — Command-line interface routing: `index.ts` shebang entry point parses commands/flags, maps short flags (`-h`→`help`, `-g`→`global`, `-l`→`local`, `-V`→`version`), triggers interactive installer on zero-argument invocation. Eight command handlers: `init` (creates config.yaml, adds `*.sum` to `.gitignore`, sets VS Code `files.exclude`), `discover` (four-filter chain → `GENERATION-PLAN.md`), `generate` (two-phase pipeline with quality gates), `update` (frontmatter hash comparison → incremental regeneration), `specify` (12-section spec synthesis with 15-minute timeout, opus upgrade), `rebuild` (AI-driven reconstruction from Build Plan phases), `clean` (marker-filtered artifact deletion with `.local.md` restoration), `install`/`uninstall` (runtime integration). Exit codes: 0 (success/no tasks), 1 (partial failure), 2 (total failure/CLI_NOT_FOUND). Default path resolution: `positional[0] || '.'`. Extended timeout: `Math.max(config.ai.timeoutMs, 900_000)` for specify/rebuild.\n\n**[config/](./config/)** — Zod-based configuration: `loadConfig()` reads `.agents-reverse-engineer/config.yaml` via `yaml.parse()` + `ConfigSchema.parse()`, returns defaults on ENOENT, throws `ConfigError` on validation failure. `ConfigSchema` validates `exclude` (patterns/vendorDirs/binaryExtensions), `options` (followSymlinks/maxFileSize), `output.colors`, `generation.compressionRatio` clamped `[0.1, 1.0]`, `ai` (backend enum `['claude','gemini','opencode','auto']`, model, timeoutMs, maxRetries, concurrency clamped `[1, 20]`, telemetry.keepRuns). `getDefaultConcurrency()` computes `min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))`. `writeDefaultConfig()` emits inline-documented YAML template with `yamlScalar()` quoting via `/[*{}\\[\\]?,:#&!|>'\"%@`]/`.\n\n**[core/](./core/)** — Programmatic API surface (`'agents-reverse-engineer/core'` package.json export): aggregates 60+ symbols from ai/, discovery/, generation/, quality/, orchestration/, config/, change-detection/, imports/ subsystems. Exports `AIService`, `discoverFiles()`, `buildFilePrompt()`, `buildDirectoryPrompt()`, `writeSumFile()`, `readSumFile()`, `writeAgentsMd()`, `writeClaudeMdPointer()`, `DocumentationOrchestrator` (aliased `GenerationOrchestrator`, `UpdateOrchestrator`), `runPool()`, `extractExports()`, `checkCodeVsDoc()`, `checkCodeVsCode()`, `checkPhantomPaths()`, `buildInconsistencyReport()`, `formatReportForCli()`, `computeContentHash()`, `getChangedFiles()`, `loadConfig()`, `findProjectRoot()`, `extractImports()`, `nullLogger`, `consoleLogger`. `@beta` stability. Excludes CLI dependencies (ora, picocolors, process.exit()).\n\n**[discovery/](./discovery/)** — File discovery pipeline: `walkDirectory()` wraps `fast-glob@3.3.3` with `absolute: true`, `onlyFiles: true`, `dot: true`, `followSymbolicLinks: false`, `ignore: ['**/.git/**']`. `applyFilters()` runs four-filter chain via concurrency-30 worker pool with short-circuit evaluation: gitignore (pattern matching via `ignore` library, absolute→relative conversion), vendor (partitioned Set lookup + substring match for 10+ vendor dirs), binary (extension Set fast path → `isbinaryfile()` content analysis for unknowns with 1MB size cap), custom (user patterns from config). Returns `FilterResult` with `included`/`excluded` arrays. `discoverFiles()` orchestrates pipeline, emits `discovery:start`/`discovery:end` trace events. Iterator-based pool prevents file descriptor exhaustion.\n\n**[generation/](./generation/)** — Two-phase orchestration: phase-1 file analysis (source → `.sum` via `buildFilePrompt()` with import maps, compression directives, existing summary preservation), phase-2 directory aggregation (parallel `.sum` reads → `AGENTS.md` via `buildDirectoryPrompt()` post-order). `collectAgentsDocs()` recursively walks tree collecting `AGENTS.md` files sorted by `localeCompare()`, skips `SKIP_DIRS` (node_modules, .git, dist, build). `buildExecutionPlan()` creates dependency graph: `fileTasks` with empty `dependencies[]` (full parallelization), `directoryTasks` sorted by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` descending with `dependencies: files.map(f => \"file:${f}\")` (post-order constraint). `buildFilePrompt()` injects compression directives when `compressionRatio < 0.5`: `TARGET LENGTH: ~${targetSize} chars, MAX: ${maxSize}`. `writeSumFile()` formats YAML frontmatter (`generated_at`, `content_hash`, `purpose`) + markdown. `writeAgentsMd()` preserves user content via rename → `AGENTS.local.md` + `@AGENTS.local.md` import when `GENERATED_MARKER` missing. Language detection: `langMap[extname(filePath)] ?? 'text'`. Manifest detection: `['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']`.\n\n**[imports/](./imports/)** — Import extraction: `extractImports()` applies regex `/^import\\s+(type\\s+)?(?:\\{([^}]*)\\}|(\\*\\s+as\\s+\\w+)|(\\w+))\\s+from\\s+['\"]([^'\"]+)['\"]/gm` capturing type keyword (group 1), named symbols (group 2), namespace import (group 3), default import (group 4), module specifier (group 5). `extractDirectoryImports()` reads first 100 lines per file (optimization: imports at top), classifies relative imports as internal (`./`) or external (`../`), excludes `node:` builtins and bare specifiers. `formatImportMap()` serializes to `fileName:\\n  specifier → symbol1, symbol2 (type)\\n\\n` format with `(type)` suffix for type-only imports. Consumed by `src/generation/prompts/builder.ts` for cross-module dependency context injection.\n\n**[installer/](./installer/)** — Interactive installer: `runInstaller()` routes install/uninstall via `selectRuntime()` (Claude/OpenCode/Gemini/all) and `selectLocation()` (global `~/.claude` or local `./.claude`) TTY prompts with arrow keys via `readline.emitKeypressEvents()` + `setRawMode(true)`, ANSI rendering (`\\x1b[${n}A`, `\\x1b[2K`), guarantees cleanup via `cleanupRawMode()` in finally block + `process.on('exit'|'SIGINT')`. `installFilesForRuntime()` copies command templates from `getTemplatesForRuntime()` to `resolveInstallPath()`, writes hooks/plugins from `getBundledHookPath('../../hooks/dist/')`, calls `registerHooks()` (Claude: nested hooks array with `node ${runtimeDir}/hooks/${hookDef.filename}`, Gemini: flat schema with name field) and `registerPermissions()` (merges `ARE_PERMISSIONS` into settings.permissions.allow) via jsonc-parser `modify()`/`applyEdits()` preserving comments, writes `ARE-VERSION` file. `uninstallFilesForRuntime()` deletes templates/hooks/plugins, calls `unregisterHooks()`/`unregisterPermissions()` filtering via `getHookPatterns()` (current + legacy `node hooks/` formats), `cleanupAreSkillDirs()`/`cleanupLegacyGeminiFiles()`/`cleanupEmptyDirs()`, `deleteConfigFolder()` removes `.agents-reverse-engineer/` when `location === 'local'`. Hook definitions: all commented (disabled). Env var overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `XDG_CONFIG_HOME`, `GEMINI_CONFIG_DIR`.\n\n**[integration/](./integration/)** — Environment detection: `detectEnvironments(projectRoot)` checks `.claude/` OR `CLAUDE.md` (Claude Code), `.opencode/` (OpenCode), `.aider.conf.yml` OR `.aider/` (Aider) via `existsSync()`. `generateIntegrationFiles()` orchestrates template writing via `getTemplatesForEnvironment()`, creates directories + writes files with skip-if-exists (unless `force=true`), copies session hooks from `hooks/dist/`. Platform configs: Claude (`.claude/skills/are-{command}/SKILL.md` directories with `name:` frontmatter), OpenCode (`.opencode/commands/are-{command}.md` flat files with `agent: build`), Gemini (`.gemini/commands/are-{command}.toml` TOML format). Eight commands: init, discover (interactive category filter with `AskUserQuestion` multiSelect), generate, update, specify, rebuild, clean, help (reference block with NO commentary). All background commands follow 4-step pattern: (1) read `VERSION_FILE_PATH`, (2) `Bash` with `run_in_background: true`, (3) poll `.agents-reverse-engineer/progress.log` every 10-15s via Read with `offset`, check TaskOutput with `block: false`, (4) summarize completion. Category classification regex: 7 categories (test/spec, CI/CD, tool configs, migrations, fixtures/snapshots, type declarations, Docker/infra) with 30+ patterns.\n\n**[orchestration/](./orchestration/)** — Concurrency control and pipeline orchestration: `runPool<T>(tasks, options, onComplete?)` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator, each worker loops `for (const [index, task] of iterator)` pulling next when previous completes, returns sparse `TaskResult<T>[]` indexed by original position, invokes optional `onComplete(result)` callback after each task settles, supports `failFast` (sets shared `aborted` flag). `CommandRunner.run()` executes five-phase pipeline: **pre-phase-1-cache** (reads existing `.sum` into `oldSumCache` via concurrency 20), **phase-1-files** (parallel AI calls, writes `.sum`/`.annex.sum`, caches source in `sourceContentCache`), **post-phase-1-quality** (throttled `checkCodeVsDoc()` against old/new `.sum` + `checkCodeVsCode()` per directory group, concurrency 10), **phase-2-dirs** (depth-grouped post-order aggregation sorted `depthB - depthA`, sequentially by depth, concurrently within depth), **post-phase-2** (`checkPhantomPaths()` markdown link validation). Separate `executeUpdate()` runs phase-1 only. `DocumentationOrchestrator.createPlan()` nullifies `PreparedFile.content` after prompt building to free memory. `preparePlan()` performs frontmatter hash comparison, populates `filesToAnalyze`/`filesToSkip`, calls `cleanupOrphans()`, `getAffectedDirectories()` sorted by depth descending. `PlanTracker` serializes `GENERATION-PLAN.md` writes via `this.writeQueue.then(() => writeFile(...))` promise chain, `markDone()` replaces `- [ ]` with `- [x]`. `ProgressReporter` maintains sliding windows (`windowSize = 10`) for moving-average ETA. `TraceWriter` appends NDJSON to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson`, injects base fields (`seq`, `ts`, `pid`, `elapsedMs`), 14 event types. `cleanupOldTraces(projectRoot, keepCount = 500)`.\n\n**[output/](./output/)** — Terminal output abstraction: `Logger` interface (`info`, `file`, `excluded`, `summary`, `warn`, `error`), `createLogger` factory conditionally applies picocolors@8.1.1 via `ColorFunctions` adapter when `options.colors: true`, `createSilentLogger` (no-op for tests). Format templates: `file()` → `\"  +\" + path` (green), `excluded()` → `\"  -\" + path + \" (reason: filter)\"` (dim), `summary()` → `\"\\nDiscovered N files (M excluded)\"` (bold counts), `warn()` → `\"Warning: \"` (yellow), `error()` → `\"Error: \"` (red). Used by CLI commands for serialized progress logging during worker pool execution.\n\n**[quality/](./quality/)** — Post-generation validation: `extractExports()` via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, `checkCodeVsDoc()` compares extracted symbols against `.sum` summary text via case-sensitive `includes()`, `checkCodeVsCode()` flags duplicates when `exportMap.get(symbolName).length >= 2`, `checkPhantomPaths()` extracts paths via three regex patterns (markdown links `/\\[(?:[^\\]]*)\\]\\((\\.[^)]+)\\)/g`, backtick-quoted `/`((?:src\\/|\\.\\.?\\/)[^`]+\\.[a-z]{1,4})`/g`, prose `/(?:from|in|by|via|see)\\s+`?(src\\/[\\w\\-./]+)`?/gi`), applies six exclusion patterns (`/node_modules/`, `/\\.git\\//`, `/^https?:/`, `/\\{\\{/`, `/\\$\\{/`, `/\\*/`, `/\\{[^}]*,[^}]*\\}/`), resolves via dual strategy (relative to AGENTS.md directory + project root), handles `.js`→`.ts` substitution. `buildInconsistencyReport()` aggregates findings, `formatReportForCli()` emits `[ERROR]`/`[WARN]`/`[INFO]` tagged output. Severity levels: error (blocking, unused), warning (drift/duplicates/broken paths), info (advisory, unused). Invoked by `CommandRunner.run()` in post-phase-1-quality (throttled directory group checks, concurrency 10) and post-phase-2 (phantom path validation). Non-throwing: errors logged but do not abort pipeline. `validateFindability()` stub (disabled).\n\n**[rebuild/](./rebuild/)** — AI-driven reconstruction: `readSpecFiles()` loads `specs/*.md` sorted alphabetically, `partitionSpec()` extracts Build Plan phases via `/^### Phase (\\d+):\\s*(.+)$/gm`, injects Architecture section + targeted Public API Surface/Data Structures/Behavioral Contracts subsections when `hasDefinesConsumes` detects `/^\\*\\*Defines:\\*\\*|^Defines:/m`, else injects full Public API Surface. `CheckpointManager.load()` validates `.rebuild-checkpoint` JSON (RebuildCheckpointSchema) with spec drift detection (SHA-256 hash comparison), returns `{manager, isResume}` + filters pending units. `executeRebuild()` groups `RebuildUnit[]` by `order` field, processes groups sequentially with concurrent `runPool()` per group, calls `buildRebuildPrompt(unit, fullSpec, builtContext)` injecting context → `AIService.call()` → `parseModuleOutput()` → writes files → `checkpoint.markDone()`. Accumulates `builtContext` from written source files (skips `.md`/`.json`/`.yml`), truncates at `BUILT_CONTEXT_LIMIT` (100,000 chars) preserving recent sections full + older sections as 20-line headers. `parseModuleOutput()` uses delimiter parser (`===FILE: path===` / `===END_FILE===` state machine requiring column-0 delimiters), fallback to fenced block extractor (`/```\\w*:([^\\n]+)\\n([\\s\\S]*?)```/g`). `REBUILD_SYSTEM_PROMPT` mandates delimiter format, exact identifier matching, production-ready code, imports from \"Already Built\" context, prohibits column-0 delimiter text in generated code. Module status enum: `'pending' | 'done' | 'failed'`. Spec drift triggers checkpoint discard. Promise-chain serialization via `checkpoint.writeQueue.then(() => writeFile())`.\n\n**[specify/](./specify/)** — Specification synthesis: `buildSpecPrompt(docs, annexFiles?)` injects `AgentsDocs` arrays into `SPEC_SYSTEM_PROMPT` enforcing 12-section format (Project Overview → Build Plan → Prompt Templates → File Manifest) with mandatory verbatim reproduction of regex patterns, format strings, magic constants, prompt templates, installer configs from annex files. `writeSpec(content, options)` single-file mode writes direct to `outputPath`, multi-file mode splits on `# ` headings via `/^(?=# )/m` + slugified filenames in `outputPath` directory, throws `SpecExistsError` listing conflicting `paths[]` when files exist and `force=false`, pre-validates all targets atomically before writing. Preamble → `00-preamble.md`. Build Plan validation rules: every API Surface export MUST appear in exactly one phase's \"Defines:\" list, every File Manifest entry MUST be referenced in a phase, each phase MUST include \"Defines:\" and \"Consumes:\" lists cross-referencing section 3. Prohibited patterns: folder-mirroring structure, directory names as headings, omitting version numbers from Dependencies, missing type signatures in API Surface, phases without Defines/Consumes lists. Verbatim reproduction mandate: regex/format/template/constant/environment variable/sentinel values in fenced blocks, NO summarization/paraphrasing/abbreviation/prose substitution. Consumed by `src/cli/specify.ts` calling `collectAgentsDocs()` → `buildSpecPrompt()` → `AIService.call()` (15-minute timeout, opus upgrade) → `writeSpec()`. Output consumed by `src/rebuild/spec-reader.ts` for reconstruction.\n\n**[types/](./types/)** — Shared discovery types: `ExcludedFile` (`{path, reason}`), `DiscoveryResult` (`{files, excluded}`), `DiscoveryStats` (`{totalFiles, includedFiles, excludedFiles, exclusionReasons: Record<string, number>}`). Consumed by `src/discovery/walker.ts` (four-filter chain output), `src/cli/discover.ts` (CLI reporting). Aggregated metrics with exclusion reason bucketing for terminal output.\n\n**[update/](./update/)** — Incremental update: `UpdateOrchestrator.preparePlan()` reads existing `.sum` frontmatter via `readSumFile()`, compares `content_hash` against `computeContentHash()`, populates `filesToAnalyze` on mismatch (status `'added'` if no .sum, `'modified'` if hash differs), populates `filesToSkip` on match. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for deleted/renamed files via `deleteIfExists()`, invokes `cleanupEmptyDirectoryDocs()` on affected parent directories (checks `hasSourceFiles` excluding `GENERATED_FILES`, dotfiles, `.sum` suffixes, deletes `AGENTS.md` when empty), returns `CleanupResult`. `getAffectedDirectories()` collects parent directories from non-deleted `FileChange[]` via `path.dirname()` walk, sorted by depth descending. Dry-run support via boolean flag (simulates deletion without `unlink()`). `UpdateOptions` (`includeUncommitted?`, `dryRun?`), `UpdateResult` (`analyzedFiles`, `skippedFiles`, `cleanup`, `regeneratedDirs`, `baseCommit`, `currentCommit`, `dryRun`). Consumes `FileChange` type from change-detection/ containing `path`, `status`, optional `oldPath` for renames.\n\n## Architecture\n\n### Two-Phase Pipeline\n\n**Phase 1 (File Analysis)**: `src/generation/orchestrator.ts` `createFileTasks()` builds `GenerationTask[]` with `buildFilePrompt()` (injects import maps, project structure, compression directives), executes via `src/orchestration/runner.ts` `runPool()` with user-configured concurrency (default: `os.availableParallelism() * 5` clamped to memory cap `min(20, floor(totalMemGB * 0.5 / 0.512), max(2, cpus * 5))`), spawns LLM subprocesses via `src/ai/subprocess.ts` `runSubprocess()` (SIGTERM at timeout, SIGKILL at timeout+5s), writes `.sum` files via `src/generation/writers/sum.ts` `writeSumFile()` with YAML frontmatter (`file_type`, `generated_at`, `content_hash`). Nullifies task content after prompt building to free memory.\n\n**Phase 2 (Directory Aggregation)**: `createDirectoryTasks()` constructs dependency graph (child file task IDs), sorts by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending), groups by depth, executes depth-grouped sequential batches with parallel concurrency per group, `buildDirectoryPrompt()` reads child `.sum` via parallel `readSumFile()`, `src/generation/writers/agents-md.ts` `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` + injects `@AGENTS.local.md` directive, root `src/generation/writers/claude-md.ts` `writeClaudeMdPointer()` generates deterministic `CLAUDE.md` import.\n\n### Concurrency Control\n\n`src/orchestration/pool.ts` `runPool<T>()` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator. Each worker pulls `[index, task]` pairs until exhausted or `aborted` flag set. Maintains full utilization during variable-duration tasks. Optional `onComplete?: (result) => void` callback enables serialized `src/orchestration/plan-tracker.ts` `PlanTracker.markDone()` updates to `GENERATION-PLAN.md` checkboxes via promise-chain pattern. Calculation: `concurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))`.\n\n### Update Strategy\n\n`src/update/orchestrator.ts` `UpdateOrchestrator.preparePlan()` reads existing `.sum` YAML frontmatter via `src/generation/writers/sum.ts` `readSumFile()`, compares stored `content_hash` against `src/change-detection/detector.ts` `computeContentHash()` (SHA-256 hex digest), populates `filesToAnalyze` on mismatch, executes phase-1-files pipeline for changed files, invokes `getAffectedDirectories()` collecting parent directories sorted by depth descending, sequentially regenerates `AGENTS.md` consuming updated child `.sum`. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for git-deleted files, removes AGENTS.md when no source files remain.\n\n### Telemetry Pipeline\n\n`src/ai/service.ts` `AIService` wraps `runSubprocess()` in `src/ai/retry.ts` `withRetry()` (exponential backoff: `min(1000 * 2^attempt, 8000) + random(500)` for RATE_LIMIT errors only, timeouts NOT retried), records `src/ai/telemetry/run-log.ts` `TelemetryEntry` (prompt/response/tokens/cache/latency/exitCode/retryCount/thinking/filesRead), optional `src/orchestration/trace.ts` `TraceWriter` emits NDJSON events (`subprocess:spawn`, `subprocess:exit`, `retry`, `worker:start`, `task:done`, `phase:start`) to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` when `--trace` flag set. `aiService.finalize(projectRoot)` writes `RunLog` to `.agents-reverse-engineer/logs/run-{timestamp}.json`, calls `src/ai/telemetry/cleanup.ts` `cleanupOldLogs()` enforcing `config.ai.telemetry.keepRuns` retention.\n\n### Quality Gates\n\n`src/orchestration/runner.ts` `CommandRunner.run()` executes five phases: **pre-phase-1-cache** (reads existing `.sum` for baseline via `runPool()` concurrency 20), **phase-1-files** (parallel AI calls), **post-phase-1-quality** (throttled directory group checks: `src/quality/inconsistency/code-vs-doc.ts` `checkCodeVsDoc()` detects undocumented exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, `src/quality/inconsistency/code-vs-code.ts` `checkCodeVsCode()` finds duplicate symbols, concurrency 10 per group), **phase-2-dirs** (post-order aggregation), **post-phase-2** (`src/quality/phantom-paths/validator.ts` `checkPhantomPaths()` validates markdown links via `/\\[(?:[^\\]]*)\\]\\((\\.[^)]+)\\)/g` + backtick paths + prose references with dual-resolution strategy + `.js`→`.ts` substitution). Aggregates findings via `src/quality/inconsistency/reporter.ts` `buildInconsistencyReport()`, emits severity-tagged CLI output via `formatReportForCli()`.\n\n### Rebuild Workflow\n\n`src/rebuild/spec-reader.ts` `readSpecFiles()` discovers `specs/*.md` → `partitionSpec()` extracts Build Plan phases via `/^### Phase (\\d+):\\s*(.+)$/gm` → `src/rebuild/checkpoint.ts` `CheckpointManager.load()` validates `.rebuild-checkpoint` JSON with spec drift detection (SHA-256 hash comparison) → `src/rebuild/orchestrator.ts` `executeRebuild()` groups `RebuildUnit[]` by `order` → sequential groups with concurrent `runPool()` per group → `src/rebuild/prompts.ts` `buildRebuildPrompt()` (injects Architecture + targeted subsections, accumulates `builtContext` truncated at 100KB) → `AIService.call()` → `src/rebuild/output-parser.ts` `parseModuleOutput()` (delimiter format: `===FILE: path===` / `===END_FILE===` with column-0 requirement, fallback to fenced-block parser) → writes files → `CheckpointManager.markDone()` serialized updates.\n\n## Behavioral Contracts\n\n### Exit Codes\n- **0**: All tasks succeeded or no tasks to process\n- **1**: Partial failure (some tasks failed but some succeeded)\n- **2**: Total failure (all tasks failed or CLI not found)\n\n### Concurrency Calculation\n```javascript\nconcurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))\n// Constants: SUBPROCESS_HEAP_GB=0.512, MEMORY_FRACTION=0.5, MULTIPLIER=5, MIN=2, MAX=20\n```\n\n### Exponential Backoff\n```javascript\ndelay = min(1000 * 2^attempt, 8000) + Math.random() * 500\n// Defaults: baseDelayMs=1000, multiplier=2, maxDelayMs=8000, jitter=[0,500ms]\n```\n\n### Retry Policy\n```javascript\nisRetryable: err => err.code === 'RATE_LIMIT'\n// Timeouts NOT retried (subprocess overhead on struggling systems)\n```\n\n### Rate Limit Detection\n```javascript\n['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))\n```\n\n### Timeout Escalation\n- SIGTERM at `options.timeoutMs` via `execFile()` timeout option\n- SIGKILL at `options.timeoutMs + 5000ms` via `setTimeout(() => process.kill(-childPid, 'SIGKILL'), ...)` (process group)\n\n### Post-Order Sort\n```javascript\ngetDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth\n// getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length\n```\n\n### Import Extraction\n```regex\n/^[ \\t]*import\\s+(type\\s+)?(?:\\{([^}]*)\\}|(\\*\\s+as\\s+\\w+)|(\\w+))\\s+from\\s+['\"]([^'\"]+)['\"]/gm\n```\nCaptures: group 1 (type keyword), group 2 (named symbols), group 3 (namespace import), group 4 (default import), group 5 (module specifier).\n\n### Export Extraction\n```regex\n/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm\n```\nCaptures identifier in group 1 after export keyword and declaration type.\n\n### Hook Disable Mechanisms\n```javascript\nprocess.env.ARE_DISABLE_HOOK === '1'\n// OR\nreadFileSync('.agents-reverse-engineer.yaml').includes('hook_enabled: false')\n```\n\n### Version Resolution Priority\n1. Project-local: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`\n2. Global: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`\n3. Fallback: `'0.0.0'` (discovery), `'unknown'` (version.ts)\n\n### Update Check Cache Schema\n```json\n{\n  \"update_available\": false,\n  \"installed\": \"0.8.0\",\n  \"latest\": \"0.8.0\",\n  \"checked\": 1738416000\n}\n```\n\n### Git Change Detection\n```javascript\nexecSync('git status --porcelain', { encoding: 'utf-8' })\n// Exit if status.trim() === '' (no changes) or command throws (not a git repo)\n```\n\n### Generated File Marker\n```javascript\nGENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'\n```\n\n### Compression Injection\n```javascript\n// Condition: compressionRatio < 0.5 && sourceFileSize > 0\ntargetSize = Math.round(sourceFileSize * compressionRatio)\nmaxSize = Math.round(targetSize * 1.2)\ncompressionPercentage = Math.round(compressionRatio * 100)\n```",
      "systemPrompt": "You are updating an existing AGENTS.md file — a directory-level overview for AI coding assistants. Some file summaries or subdirectory documents have changed, and AGENTS.md needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING AGENTS.md and the CURRENT file summaries and subdirectory documents\n- Preserve the structure, section headings, and descriptions that are still accurate\n- Only modify entries for files or subdirectories whose summaries have changed\n- Add entries for new files, remove entries for deleted files\n- Do NOT reorganize, rephrase, or restructure sections that are unaffected by changes\n- Keep the same section ordering unless files were added/removed in a way that requires regrouping\n- Behavioral Contracts section: preserve verbatim regex patterns and constants unless source file summaries show they changed\n- Reproduction-Critical Constants: if file summaries reference annex files (.annex.sum), preserve the links. Add links for new annexes, remove links for deleted ones.\n- Workflow & Conventions section: preserve existing rules unless source file summaries show they changed. Add rules from new files, remove rules for deleted files.\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Preserve the existing purpose statement unless the directory's role has fundamentally changed\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n- Cross-module references must use the specifier format from actual import statements\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context",
      "response": "<!-- Generated by agents-reverse-engineer -->\n\n# src\n\nTypeScript source root implementing eight-command CLI (`init`, `discover`, `generate`, `update`, `specify`, `rebuild`, `clean`, `install`/`uninstall`), two-phase AI documentation pipeline (file analysis → directory aggregation), iterator-based concurrency control, multi-backend subprocess orchestration (Claude/Gemini/OpenCode), frontmatter-based change detection, quality validation (code-vs-doc/code-vs-code/phantom-paths), specification synthesis, AI-driven reconstruction, and runtime integration (session hooks, slash commands, permission pre-approval).\n\n## Contents\n\n**[version.ts](./version.ts)** — `getVersion()` resolves `import.meta.url` → `fileURLToPath()` → `dirname()` → `join(__dirname, '..', 'package.json')`, parses JSON via `readFileSync()`, returns `version` field or `'unknown'` fallback on error. Used by CLI `--version` flags and telemetry metadata.\n\n## Subdirectories\n\n**[ai/](./ai/)** — AI service orchestration: subprocess spawning (`claude`/`gemini`/`opencode` CLI tools), exponential backoff retry (rate-limit only, timeouts NOT retried), timeout enforcement (SIGTERM → SIGKILL escalation at +5s), backend auto-detection (PATH scanning with insertion-order priority: Claude > Gemini > OpenCode), telemetry accumulation (`TelemetryEntry[]` → `RunLog` JSON with token/cache/latency/exit code/retry count), NDJSON trace emission (`subprocess:spawn`/`subprocess:exit`/`retry` events), provider abstraction (`AIProvider` interface decoupling transport from business logic). `AIService.call()` wraps provider in `withRetry()` configured with `isRetryable: (err) => err.code === 'RATE_LIMIT'`, records telemetry, emits trace events. `ClaudeBackend` tri-format JSON parser handles CLI ≥2.1.38 arrays, NDJSON, legacy single-object via Zod schema validation. Rate-limit detection: `['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))`. Subprocess SIGKILL via `process.kill(-childPid, 'SIGKILL')` targeting process group. Telemetry cleanup: `cleanupOldLogs(projectRoot, keepRuns)` enforces retention.\n\n**[change-detection/](./change-detection/)** — Git-based file change detection: `isGitRepo()` checks repository status, `getCurrentCommit()` fetches HEAD hash, `getChangedFiles()` detects modifications between `baseCommit` and HEAD via `git diff --name-status -M` with 50% rename threshold, optionally merges uncommitted changes from `git.status()` staged/modified/not_added/deleted arrays. `computeContentHash()` generates SHA-256 hex digest from file content. `computeContentHashFromString()` hashes in-memory strings. `ChangeType = 'added' | 'modified' | 'deleted' | 'renamed'`. Consumed by `src/update/orchestrator.ts` for frontmatter hash comparison triggering incremental regeneration.\n\n**[cli/](./cli/)** — Command-line interface routing: `index.ts` shebang entry point parses commands/flags, maps short flags (`-h`→`help`, `-g`→`global`, `-l`→`local`, `-V`→`version`), triggers interactive installer on zero-argument invocation. Eight command handlers: `init` (creates config.yaml, adds `*.sum` to `.gitignore`, sets VS Code `files.exclude`), `discover` (four-filter chain → `GENERATION-PLAN.md`), `generate` (two-phase pipeline with quality gates), `update` (frontmatter hash comparison → incremental regeneration), `specify` (12-section spec synthesis with 15-minute timeout, opus upgrade), `rebuild` (AI-driven reconstruction from Build Plan phases), `clean` (marker-filtered artifact deletion with `.local.md` restoration), `install`/`uninstall` (runtime integration). Exit codes: 0 (success/no tasks), 1 (partial failure), 2 (total failure/CLI_NOT_FOUND). Default path resolution: `positional[0] || '.'`. Extended timeout: `Math.max(config.ai.timeoutMs, 900_000)` for specify/rebuild.\n\n**[config/](./config/)** — Zod-based configuration: `loadConfig()` reads `.agents-reverse-engineer/config.yaml` via `yaml.parse()` + `ConfigSchema.parse()`, returns defaults on ENOENT, throws `ConfigError` on validation failure. `ConfigSchema` validates `exclude` (patterns/vendorDirs/binaryExtensions), `options` (followSymlinks/maxFileSize), `output.colors`, `generation.compressionRatio` clamped `[0.1, 1.0]`, `ai` (backend enum `['claude','gemini','opencode','auto']`, model, timeoutMs, maxRetries, concurrency clamped `[1, 20]`, telemetry.keepRuns). `getDefaultConcurrency()` computes `min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))`. `writeDefaultConfig()` emits inline-documented YAML template with `yamlScalar()` quoting via `/[*{}\\[\\]?,:#&!|>'\"%@`]/`.\n\n**[core/](./core/)** — Programmatic API surface (`'agents-reverse-engineer/core'` package.json export): aggregates 60+ symbols from ai/, discovery/, generation/, quality/, orchestration/, config/, change-detection/, imports/ subsystems. Exports `AIService`, `discoverFiles()`, `buildFilePrompt()`, `buildDirectoryPrompt()`, `writeSumFile()`, `readSumFile()`, `writeAgentsMd()`, `writeClaudeMdPointer()`, `DocumentationOrchestrator` (aliased `GenerationOrchestrator`, `UpdateOrchestrator`), `runPool()`, `extractExports()`, `checkCodeVsDoc()`, `checkCodeVsCode()`, `checkPhantomPaths()`, `buildInconsistencyReport()`, `formatReportForCli()`, `computeContentHash()`, `getChangedFiles()`, `loadConfig()`, `findProjectRoot()`, `extractImports()`, `nullLogger`, `consoleLogger`. `@beta` stability. Excludes CLI dependencies (ora, picocolors, process.exit()).\n\n**[discovery/](./discovery/)** — File discovery pipeline: `walkDirectory()` wraps `fast-glob@3.3.3` with `absolute: true`, `onlyFiles: true`, `dot: true`, `followSymbolicLinks: false`, `ignore: ['**/.git/**']`. `applyFilters()` runs four-filter chain via concurrency-30 worker pool with short-circuit evaluation: gitignore (pattern matching via `ignore` library, absolute→relative conversion), vendor (partitioned Set lookup + substring match for 10+ vendor dirs), binary (extension Set fast path → `isbinaryfile()` content analysis for unknowns with 1MB size cap), custom (user patterns from config). Returns `FilterResult` with `included`/`excluded` arrays. `discoverFiles()` orchestrates pipeline, emits `discovery:start`/`discovery:end` trace events. Iterator-based pool prevents file descriptor exhaustion.\n\n**[generation/](./generation/)** — Two-phase orchestration: phase-1 file analysis (source → `.sum` via `buildFilePrompt()` with import maps, compression directives, existing summary preservation), phase-2 directory aggregation (parallel `.sum` reads → `AGENTS.md` via `buildDirectoryPrompt()` post-order). `collectAgentsDocs()` recursively walks tree collecting `AGENTS.md` files sorted by `localeCompare()`, skips `SKIP_DIRS` (node_modules, .git, dist, build). `buildExecutionPlan()` creates dependency graph: `fileTasks` with empty `dependencies[]` (full parallelization), `directoryTasks` sorted by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` descending with `dependencies: files.map(f => \"file:${f}\")` (post-order constraint). `buildFilePrompt()` injects compression directives when `compressionRatio < 0.5`: `TARGET LENGTH: ~${targetSize} chars, MAX: ${maxSize}`. `writeSumFile()` formats YAML frontmatter (`generated_at`, `content_hash`, `purpose`) + markdown. `writeAgentsMd()` preserves user content via rename → `AGENTS.local.md` + `@AGENTS.local.md` import when `GENERATED_MARKER` missing. Language detection: `langMap[extname(filePath)] ?? 'text'`. Manifest detection: `['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']`.\n\n**[imports/](./imports/)** — Import extraction: `extractImports()` applies regex `/^[ \\t]*import\\s+(type\\s+)?(?:\\{([^}]*)\\}|(\\*\\s+as\\s+\\w+)|(\\w+))\\s+from\\s+['\"]([^'\"]+)['\"]/gm` capturing type keyword (group 1), named symbols (group 2), namespace import (group 3), default import (group 4), module specifier (group 5). `extractDirectoryImports()` reads first 100 lines per file (optimization: imports at top), classifies relative imports as internal (`./`) or external (`../`), excludes `node:` builtins and bare specifiers. `formatImportMap()` serializes to `fileName:\\n  specifier → symbol1, symbol2 (type)\\n\\n` format with `(type)` suffix for type-only imports. Consumed by `src/generation/prompts/builder.ts` for cross-module dependency context injection.\n\n**[installer/](./installer/)** — Interactive installer orchestrating command template/session hook deployment to AI runtime config directories (`.claude/`, `.gemini/`, `.config/opencode/`) with TTY-aware prompts, settings.json hook registration via jsonc-parser, permission injection for Claude, version tracking, and symmetric uninstall operations. `runInstaller()` routes install/uninstall via `selectRuntime()` (Claude/OpenCode/Gemini/all) and `selectLocation()` (global `~/.claude` or local `./.claude`) TTY prompts with arrow keys via `readline.emitKeypressEvents()` + `setRawMode(true)`, ANSI rendering (`\\x1b[${n}A`, `\\x1b[2K`), guarantees cleanup via `cleanupRawMode()` in finally block + `process.on('exit'|'SIGINT')`. `installFilesForRuntime()` copies command templates from `getTemplatesForRuntime()` to `resolveInstallPath()`, writes hooks/plugins from `getBundledHookPath('../../hooks/dist/')`, calls `registerHooks()` (Claude: nested hooks array with `node ${runtimeDir}/hooks/${hookDef.filename}`, Gemini: flat schema with name field) and `registerPermissions()` (merges `ARE_PERMISSIONS` into settings.permissions.allow) via jsonc-parser `modify()`/`applyEdits()` preserving comments, writes `ARE-VERSION` file. `uninstallFilesForRuntime()` deletes templates/hooks/plugins, calls `unregisterHooks()`/`unregisterPermissions()` filtering via `getHookPatterns()` (current + legacy `node hooks/` formats), `cleanupAreSkillDirs()`/`cleanupLegacyGeminiFiles()`/`cleanupEmptyDirs()`, `deleteConfigFolder()` removes `.agents-reverse-engineer/` when `location === 'local'`. Hook definitions: all commented (disabled). Env var overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `XDG_CONFIG_HOME`, `GEMINI_CONFIG_DIR`.\n\n**[integration/](./integration/)** — Environment detection and integration file generation for three AI coding assistants (Claude Code, OpenCode, Gemini CLI) via directory/file presence checks and platform-specific template rendering (markdown frontmatter, TOML). `detectEnvironments(projectRoot)` checks `.claude/` OR `CLAUDE.md` (Claude Code), `.opencode/` (OpenCode), `.aider.conf.yml` OR `.aider/` (Aider) via `existsSync()`. `generateIntegrationFiles()` orchestrates template writing via `getTemplatesForEnvironment()`, creates directories + writes files with skip-if-exists (unless `force=true`), copies session hooks from `hooks/dist/`. Platform configs: Claude (`.claude/skills/are-{command}/SKILL.md` directories with `name:` frontmatter), OpenCode (`.opencode/commands/are-{command}.md` flat files with `agent: build`), Gemini (`.gemini/commands/are-{command}.toml` TOML format). Eight commands: init, discover (interactive category filter with `AskUserQuestion` multiSelect), generate, update, specify, rebuild, clean, help (reference block with NO commentary). All background commands follow 5-step pattern: (1) read `VERSION_FILE_PATH`, display version, (2) delete `.agents-reverse-engineer/progress.log`, (3) `Bash` with `run_in_background: true`, (4) poll `.agents-reverse-engineer/progress.log` every 10-15s via Read with `offset`, check TaskOutput with `block: false`, (5) summarize completion. Category classification regex: 7 categories (test/spec, CI/CD, tool configs, migrations, fixtures/snapshots, type declarations, Docker/infra) with 30+ patterns.\n\n**[orchestration/](./orchestration/)** — Concurrency control and pipeline orchestration: `runPool<T>(tasks, options, onComplete?)` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator, each worker loops `for (const [index, task] of iterator)` pulling next when previous completes, returns sparse `TaskResult<T>[]` indexed by original position, invokes optional `onComplete(result)` callback after each task settles, supports `failFast` (sets shared `aborted` flag). `CommandRunner.run()` executes five-phase pipeline: **pre-phase-1-cache** (reads existing `.sum` into `oldSumCache` via concurrency 20), **phase-1-files** (parallel AI calls, writes `.sum`/`.annex.sum`, caches source in `sourceContentCache`), **post-phase-1-quality** (throttled `checkCodeVsDoc()` against old/new `.sum` + `checkCodeVsCode()` per directory group, concurrency 10), **phase-2-dirs** (depth-grouped post-order aggregation sorted `depthB - depthA`, sequentially by depth, concurrently within depth), **post-phase-2** (`checkPhantomPaths()` markdown link validation). Separate `executeUpdate()` runs phase-1 only. `DocumentationOrchestrator.createPlan()` nullifies `PreparedFile.content` after prompt building to free memory. `preparePlan()` performs frontmatter hash comparison, populates `filesToAnalyze`/`filesToSkip`, calls `cleanupOrphans()`, `getAffectedDirectories()` sorted by depth descending. `PlanTracker` serializes `GENERATION-PLAN.md` writes via `this.writeQueue.then(() => writeFile(...))` promise chain, `markDone()` replaces `- [ ]` with `- [x]`. `ProgressReporter` maintains sliding windows (`windowSize = 10`) for moving-average ETA. `TraceWriter` appends NDJSON to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson`, injects base fields (`seq`, `ts`, `pid`, `elapsedMs`), 14 event types. `cleanupOldTraces(projectRoot, keepCount = 500)`.\n\n**[output/](./output/)** — Terminal output abstraction: `Logger` interface (`info`, `file`, `excluded`, `summary`, `warn`, `error`), `createLogger` factory conditionally applies picocolors@8.1.1 via `ColorFunctions` adapter when `options.colors: true`, `createSilentLogger` (no-op for tests). Format templates: `file()` → `\"  +\" + path` (green), `excluded()` → `\"  -\" + path + \" (reason: filter)\"` (dim), `summary()` → `\"\\nDiscovered N files (M excluded)\"` (bold counts), `warn()` → `\"Warning: \"` (yellow), `error()` → `\"Error: \"` (red). Used by CLI commands for serialized progress logging during worker pool execution.\n\n**[quality/](./quality/)** — Post-generation validation: `extractExports()` via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, `checkCodeVsDoc()` compares extracted symbols against `.sum` summary text via case-sensitive `includes()`, `checkCodeVsCode()` flags duplicates when `exportMap.get(symbolName).length >= 2`, `checkPhantomPaths()` extracts paths via three regex patterns (markdown links `/\\[(?:[^\\]]*)\\]\\((\\.[^)]+)\\)/g`, backtick-quoted `/`((?:src\\/|\\.\\.?\\/)[^`]+\\.[a-z]{1,4})`/g`, prose `/(?:from|in|by|via|see)\\s+`?(src\\/[\\w\\-./]+)`?/gi`), applies six exclusion patterns (`/node_modules/`, `/\\.git\\//`, `/^https?:/`, `/\\{\\{/`, `/\\$\\{/`, `/\\*/`, `/\\{[^}]*,[^}]*\\}/`), resolves via dual strategy (relative to AGENTS.md directory + project root), handles `.js`→`.ts` substitution. `buildInconsistencyReport()` aggregates findings, `formatReportForCli()` emits `[ERROR]`/`[WARN]`/`[INFO]` tagged output. Severity levels: error (blocking, unused), warning (drift/duplicates/broken paths), info (advisory, unused). Invoked by `CommandRunner.run()` in post-phase-1-quality (throttled directory group checks, concurrency 10) and post-phase-2 (phantom path validation). Non-throwing: errors logged but do not abort pipeline. `validateFindability()` stub (disabled).\n\n**[rebuild/](./rebuild/)** — AI-driven reconstruction: `readSpecFiles()` loads `specs/*.md` sorted alphabetically, `partitionSpec()` extracts Build Plan phases via `/^### Phase (\\d+):\\s*(.+)$/gm`, injects Architecture section + targeted Public API Surface/Data Structures/Behavioral Contracts subsections when `hasDefinesConsumes` detects `/^\\*\\*Defines:\\*\\*|^Defines:/m`, else injects full Public API Surface. `CheckpointManager.load()` validates `.rebuild-checkpoint` JSON (RebuildCheckpointSchema) with spec drift detection (SHA-256 hash comparison), returns `{manager, isResume}` + filters pending units. `executeRebuild()` groups `RebuildUnit[]` by `order` field, processes groups sequentially with concurrent `runPool()` per group, calls `buildRebuildPrompt(unit, fullSpec, builtContext)` injecting context → `AIService.call()` → `parseModuleOutput()` → writes files → `checkpoint.markDone()`. Accumulates `builtContext` from written source files (skips `.md`/`.json`/`.yml`), truncates at `BUILT_CONTEXT_LIMIT` (100,000 chars) preserving recent sections full + older sections as 20-line headers. `parseModuleOutput()` uses delimiter parser (`===FILE: path===` / `===END_FILE===` state machine requiring column-0 delimiters), fallback to fenced block extractor (`/```\\w*:([^\\n]+)\\n([\\s\\S]*?)```/g`). `REBUILD_SYSTEM_PROMPT` mandates delimiter format, exact identifier matching, production-ready code, imports from \"Already Built\" context, prohibits column-0 delimiter text in generated code. Module status enum: `'pending' | 'done' | 'failed'`. Spec drift triggers checkpoint discard. Promise-chain serialization via `checkpoint.writeQueue.then(() => writeFile())`.\n\n**[specify/](./specify/)** — Specification synthesis: `buildSpecPrompt(docs, annexFiles?)` injects `AgentsDocs` arrays into `SPEC_SYSTEM_PROMPT` enforcing 12-section format (Project Overview → Build Plan → Prompt Templates → File Manifest) with mandatory verbatim reproduction of regex patterns, format strings, magic constants, prompt templates, installer configs from annex files. `writeSpec(content, options)` single-file mode writes direct to `outputPath`, multi-file mode splits on `# ` headings via `/^(?=# )/m` + slugified filenames in `outputPath` directory, throws `SpecExistsError` listing conflicting `paths[]` when files exist and `force=false`, pre-validates all targets atomically before writing. Preamble → `00-preamble.md`. Build Plan validation rules: every API Surface export MUST appear in exactly one phase's \"Defines:\" list, every File Manifest entry MUST be referenced in a phase, each phase MUST include \"Defines:\" and \"Consumes:\" lists cross-referencing section 3. Prohibited patterns: folder-mirroring structure, directory names as headings, omitting version numbers from Dependencies, missing type signatures in API Surface, phases without Defines/Consumes lists. Verbatim reproduction mandate: regex/format/template/constant/environment variable/sentinel values in fenced blocks, NO summarization/paraphrasing/abbreviation/prose substitution. Consumed by `src/cli/specify.ts` calling `collectAgentsDocs()` → `buildSpecPrompt()` → `AIService.call()` (15-minute timeout, opus upgrade) → `writeSpec()`. Output consumed by `src/rebuild/spec-reader.ts` for reconstruction.\n\n**[types/](./types/)** — Shared discovery types: `ExcludedFile` (`{path, reason}`), `DiscoveryResult` (`{files, excluded}`), `DiscoveryStats` (`{totalFiles, includedFiles, excludedFiles, exclusionReasons: Record<string, number>}`). Consumed by `src/discovery/walker.ts` (four-filter chain output), `src/cli/discover.ts` (CLI reporting). Aggregated metrics with exclusion reason bucketing for terminal output.\n\n**[update/](./update/)** — Incremental update: `UpdateOrchestrator.preparePlan()` reads existing `.sum` frontmatter via `readSumFile()`, compares `content_hash` against `computeContentHash()`, populates `filesToAnalyze` on mismatch (status `'added'` if no .sum, `'modified'` if hash differs), populates `filesToSkip` on match. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for deleted/renamed files via `deleteIfExists()`, invokes `cleanupEmptyDirectoryDocs()` on affected parent directories (checks `hasSourceFiles` excluding `GENERATED_FILES`, dotfiles, `.sum` suffixes, deletes `AGENTS.md` when empty), returns `CleanupResult`. `getAffectedDirectories()` collects parent directories from non-deleted `FileChange[]` via `path.dirname()` walk, sorted by depth descending. Dry-run support via boolean flag (simulates deletion without `unlink()`). `UpdateOptions` (`includeUncommitted?`, `dryRun?`), `UpdateResult` (`analyzedFiles`, `skippedFiles`, `cleanup`, `regeneratedDirs`, `baseCommit`, `currentCommit`, `dryRun`). Consumes `FileChange` type from change-detection/ containing `path`, `status`, optional `oldPath` for renames.\n\n## Architecture\n\n### Two-Phase Pipeline\n\n**Phase 1 (File Analysis)**: `src/generation/orchestrator.ts` `createFileTasks()` builds `GenerationTask[]` with `buildFilePrompt()` (injects import maps, project structure, compression directives), executes via `src/orchestration/runner.ts` `runPool()` with user-configured concurrency (default: `os.availableParallelism() * 5` clamped to memory cap `min(20, floor(totalMemGB * 0.5 / 0.512), max(2, cpus * 5))`), spawns LLM subprocesses via `src/ai/subprocess.ts` `runSubprocess()` (SIGTERM at timeout, SIGKILL at timeout+5s), writes `.sum` files via `src/generation/writers/sum.ts` `writeSumFile()` with YAML frontmatter (`file_type`, `generated_at`, `content_hash`). Nullifies task content after prompt building to free memory.\n\n**Phase 2 (Directory Aggregation)**: `createDirectoryTasks()` constructs dependency graph (child file task IDs), sorts by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending), groups by depth, executes depth-grouped sequential batches with parallel concurrency per group, `buildDirectoryPrompt()` reads child `.sum` via parallel `readSumFile()`, `src/generation/writers/agents-md.ts` `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` + injects `@AGENTS.local.md` directive, root `src/generation/writers/claude-md.ts` `writeClaudeMdPointer()` generates deterministic `CLAUDE.md` import.\n\n### Concurrency Control\n\n`src/orchestration/pool.ts` `runPool<T>()` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator. Each worker pulls `[index, task]` pairs until exhausted or `aborted` flag set. Maintains full utilization during variable-duration tasks. Optional `onComplete?: (result) => void` callback enables serialized `src/orchestration/plan-tracker.ts` `PlanTracker.markDone()` updates to `GENERATION-PLAN.md` checkboxes via promise-chain pattern. Calculation: `concurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))`.\n\n### Update Strategy\n\n`src/update/orchestrator.ts` `UpdateOrchestrator.preparePlan()` reads existing `.sum` YAML frontmatter via `src/generation/writers/sum.ts` `readSumFile()`, compares stored `content_hash` against `src/change-detection/detector.ts` `computeContentHash()` (SHA-256 hex digest), populates `filesToAnalyze` on mismatch, executes phase-1-files pipeline for changed files, invokes `getAffectedDirectories()` collecting parent directories sorted by depth descending, sequentially regenerates `AGENTS.md` consuming updated child `.sum`. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for git-deleted files, removes AGENTS.md when no source files remain.\n\n### Telemetry Pipeline\n\n`src/ai/service.ts` `AIService` wraps `runSubprocess()` in `src/ai/retry.ts` `withRetry()` (exponential backoff: `min(1000 * 2^attempt, 8000) + random(500)` for RATE_LIMIT errors only, timeouts NOT retried), records `src/ai/telemetry/run-log.ts` `TelemetryEntry` (prompt/response/tokens/cache/latency/exitCode/retryCount/thinking/filesRead), optional `src/orchestration/trace.ts` `TraceWriter` emits NDJSON events (`subprocess:spawn`, `subprocess:exit`, `retry`, `worker:start`, `task:done`, `phase:start`) to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` when `--trace` flag set. `aiService.finalize(projectRoot)` writes `RunLog` to `.agents-reverse-engineer/logs/run-{timestamp}.json`, calls `src/ai/telemetry/cleanup.ts` `cleanupOldLogs()` enforcing `config.ai.telemetry.keepRuns` retention.\n\n### Quality Gates\n\n`src/orchestration/runner.ts` `CommandRunner.run()` executes five phases: **pre-phase-1-cache** (reads existing `.sum` for baseline via `runPool()` concurrency 20), **phase-1-files** (parallel AI calls), **post-phase-1-quality** (throttled directory group checks: `src/quality/inconsistency/code-vs-doc.ts` `checkCodeVsDoc()` detects undocumented exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, `src/quality/inconsistency/code-vs-code.ts` `checkCodeVsCode()` finds duplicate symbols, concurrency 10 per group), **phase-2-dirs** (post-order aggregation), **post-phase-2** (`src/quality/phantom-paths/validator.ts` `checkPhantomPaths()` validates markdown links via `/\\[(?:[^\\]]*)\\]\\((\\.[^)]+)\\)/g` + backtick paths + prose references with dual-resolution strategy + `.js`→`.ts` substitution). Aggregates findings via `src/quality/inconsistency/reporter.ts` `buildInconsistencyReport()`, emits severity-tagged CLI output via `formatReportForCli()`.\n\n### Rebuild Workflow\n\n`src/rebuild/spec-reader.ts` `readSpecFiles()` discovers `specs/*.md` → `partitionSpec()` extracts Build Plan phases via `/^### Phase (\\d+):\\s*(.+)$/gm` → `src/rebuild/checkpoint.ts` `CheckpointManager.load()` validates `.rebuild-checkpoint` JSON with spec drift detection (SHA-256 hash comparison) → `src/rebuild/orchestrator.ts` `executeRebuild()` groups `RebuildUnit[]` by `order` → sequential groups with concurrent `runPool()` per group → `src/rebuild/prompts.ts` `buildRebuildPrompt()` (injects Architecture + targeted subsections, accumulates `builtContext` truncated at 100KB) → `AIService.call()` → `src/rebuild/output-parser.ts` `parseModuleOutput()` (delimiter format: `===FILE: path===` / `===END_FILE===` with column-0 requirement, fallback to fenced-block parser) → writes files → `CheckpointManager.markDone()` serialized updates.\n\n## Behavioral Contracts\n\n### Exit Codes\n- **0**: All tasks succeeded or no tasks to process\n- **1**: Partial failure (some tasks failed but some succeeded)\n- **2**: Total failure (all tasks failed or CLI not found)\n\n### Concurrency Calculation\n```javascript\nconcurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))\n// Constants: SUBPROCESS_HEAP_GB=0.512, MEMORY_FRACTION=0.5, MULTIPLIER=5, MIN=2, MAX=20\n```\n\n### Exponential Backoff\n```javascript\ndelay = min(1000 * 2^attempt, 8000) + Math.random() * 500\n// Defaults: baseDelayMs=1000, multiplier=2, maxDelayMs=8000, jitter=[0,500ms]\n```\n\n### Retry Policy\n```javascript\nisRetryable: err => err.code === 'RATE_LIMIT'\n// Timeouts NOT retried (subprocess overhead on struggling systems)\n```\n\n### Rate Limit Detection\n```javascript\n['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))\n```\n\n### Timeout Escalation\n- SIGTERM at `options.timeoutMs` via `execFile()` timeout option\n- SIGKILL at `options.timeoutMs + 5000ms` via `setTimeout(() => process.kill(-childPid, 'SIGKILL'), ...)` (process group)\n\n### Post-Order Sort\n```javascript\ngetDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth\n// getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length\n```\n\n### Import Extraction\n```regex\n/^[ \\t]*import\\s+(type\\s+)?(?:\\{([^}]*)\\}|(\\*\\s+as\\s+\\w+)|(\\w+))\\s+from\\s+['\"]([^'\"]+)['\"]/gm\n```\nCaptures: group 1 (type keyword), group 2 (named symbols), group 3 (namespace import), group 4 (default import), group 5 (module specifier).\n\n### Export Extraction\n```regex\n/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm\n```\nCaptures identifier in group 1 after export keyword and declaration type.\n\n### Hook Disable Mechanisms\n```javascript\nprocess.env.ARE_DISABLE_HOOK === '1'\n// OR\nreadFileSync('.agents-reverse-engineer.yaml').includes('hook_enabled: false')\n```\n\n### Version Resolution Priority\n1. Project-local: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`\n2. Global: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`\n3. Fallback: `'0.0.0'` (discovery), `'unknown'` (version.ts)\n\n### Update Check Cache Schema\n```json\n{\n  \"update_available\": false,\n  \"installed\": \"0.8.0\",\n  \"latest\": \"0.8.0\",\n  \"checked\": 1738416000\n}\n```\n\n### Git Change Detection\n```javascript\nexecSync('git status --porcelain', { encoding: 'utf-8' })\n// Exit if status.trim() === '' (no changes) or command throws (not a git repo)\n```\n\n### Generated File Marker\n```javascript\nGENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'\n```\n\n### Compression Injection\n```javascript\n// Condition: compressionRatio < 0.5 && sourceFileSize > 0\ntargetSize = Math.round(sourceFileSize * compressionRatio)\nmaxSize = Math.round(targetSize * 1.2)\ncompressionPercentage = Math.round(compressionRatio * 100)\n```",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 8677,
      "cacheReadTokens": 0,
      "cacheCreationTokens": 38591,
      "latencyMs": 219939,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": []
    },
    {
      "timestamp": "2026-02-12T08:41:46.359Z",
      "prompt": "Generate AGENTS.md for directory: \".\" (agents-reverse-engineer)\n\n## File Summaries (6 files)\n\n### CONTRIBUTING.md\n**Purpose:** Developer onboarding guide documenting install workflow, six core source directories, fork-based contribution process...\n\n**Developer onboarding guide documenting install workflow, six core source directories, fork-based contribution process, and MIT License agreement.**\n\n## Development Workflow\nClone repo → `npm install` → `npm run dev` (tsx watch) → `npm run build` (tsc → dist/).\n\n## Project Structure\nSix core directories: `src/cli/` (command handlers), `src/config/` (schema/loading), `src/discovery/` (file discovery), `src/generation/` (AI-driven docs), `src/orchestration/` (concurrency/tracing), `src/ai/` (subprocess management).\n\n## Contribution Rules\nFork repo, branch from `main`, ensure `npm run build` succeeds, submit PR. Bug reports require reproduction steps, expected/actual behavior, environment (OS/Node/runtime). Feature requests use `enhancement` label with use case description.\n### LANGUAGES-MANIFEST.md\n**Purpose:** Reference catalog mapping 26 language ecosystems to manifest file patterns with support status flags.\n\n**Reference catalog mapping 26 language ecosystems to manifest file patterns with support status flags.**\n\n## Manifest Mappings\n\nDocuments manifest filenames, package managers, and support status for: JavaScript/TypeScript (`package.json`, npm/yarn/pnpm, ✓), Python (`requirements.txt`/`pyproject.toml`/`setup.py`/`Pipfile`, pip/poetry/pipenv, ✓), Go (`go.mod`, go modules, ✓), Rust (`Cargo.toml`, cargo, ✓), Ruby (`Gemfile`, bundler), Java (`pom.xml`/`build.gradle`, Maven/Gradle), C# (`*.csproj`/`packages.config`, NuGet), PHP (`composer.json`, Composer), Swift (`Package.swift`), Dart (`pubspec.yaml`, pub), Haskell (`package.yaml`/`*.cabal`/`stack.yaml`), C/C++ (`CMakeLists.txt`/`conanfile.txt`/`vcpkg.json`), plus 14 others (Kotlin, Elixir, Erlang, Scala, Clojure, Lua, R, Julia, Zig, Nim, OCaml).\n\n## Integration Points\n\nInforms `src/discovery/walker.ts` file discovery and `src/imports/extractor.ts` dependency extraction logic for supported ecosystems.\n### LICENSE\n**Purpose:** MIT License granting unrestricted rights to use, modify, distribute agents-reverse-engineer software (copyright 2026 ...\n\n**MIT License granting unrestricted rights to use, modify, distribute agents-reverse-engineer software (copyright 2026 GeoloeG-IsT) with warranty disclaimer and attribution requirement for binary distributions.**\n\n## Legal Requirements\n\nCopyright notice and permission notice must be included in all copies or substantial portions of the Software. Applies to entire project tree (`src/`, `hooks/`, `dist/`) and compiled binaries referenced in `package.json` `files` array.\n\n## Warranty Disclaimer\n\nSoftware provided \"AS IS\" without warranties of MERCHANTABILITY, FITNESS, or NONINFRINGEMENT. No liability for damages.\n### README.md\n**Purpose:** README.md serves as project entry point documenting installation workflows, command interfaces, generated artifact fo...\n\n**README.md serves as project entry point documenting installation workflows, command interfaces, generated artifact formats, configuration schema, and runtime support matrix for AI-assisted codebase documentation generation.**\n\n## Installation Workflows\n\nInteractive installer via `npx agents-reverse-engineer@latest` prompts for runtime selection (Claude Code, OpenCode, Gemini CLI, all) and location (global `~/.claude/` or local `./.claude/`), installs slash commands (`/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`) and session hooks (auto-updates on session end for Claude/Gemini). Non-interactive flags: `--runtime <rt>` with `-g` (global) or `-l` (local). Uninstall via `npx agents-reverse-engineer@latest uninstall` removes command files, session hooks, ARE permissions from settings.json, and `.agents-reverse-engineer` folder (local only). Version check via `--version` flag.\n\n## Generated Artifacts\n\n`.sum` files contain YAML frontmatter (`file_type`, `generated_at`) plus markdown sections (Purpose, Public Interface, Dependencies, Implementation Notes). `AGENTS.md` per-directory overviews list files grouped by purpose (Types, Services, Utils) and subdirectories with descriptions. Pointer files `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` import `AGENTS.md` for runtime-specific auto-loading. Root `AGENTS.md` provides universal project overview.\n\n## Command Interface\n\nCLI commands: `are` (interactive installer default), `are install` (with optional `--runtime <rt> -g|-l`), `are install -u` (uninstall), `are init` (create config), `are discover` (scan files, create GENERATION-PLAN.md), `are generate` (generate all docs), `are update` (incremental regeneration for changed files), `are specify` (synthesize AGENTS.md into `specs/SPEC.md` with optional `--multi-file` or `--dry-run`), `are clean` (remove generated docs). Runtime values: `claude`, `opencode`, `gemini`, `all`. AI assistant slash commands mirror CLI functionality.\n\n## Configuration Schema\n\n`.agents-reverse-engineer/config.yaml` defines `exclude.patterns` (custom globs), `exclude.vendorDirs` (node_modules, dist, .git), `exclude.binaryExtensions` (.png, .jpg, .pdf), `options.followSymlinks` (default false), `options.maxFileSize` (1048576 bytes), `output.colors` (default true), `ai.backend` (auto|claude|gemini|opencode), `ai.model` (sonnet), `ai.timeoutMs` (300000), `ai.maxRetries` (3), `ai.concurrency` (1-20, auto-detected from CPU/RAM), `ai.telemetry.keepRuns` (50).\n\n## Workflow Algorithm\n\nPost-order traversal: `/are-discover` scans codebase respecting `.gitignore`, detects file types, creates GENERATION-PLAN.md with deepest directories first ensuring child documentation exists before parent aggregation. `/are-generate` executes two-phase pipeline: file analysis (creates `.sum` per source file), directory docs (creates `AGENTS.md` and pointer files per directory). `/are-update` regenerates only changed files via content hash comparison.\n\n## Runtime Support Matrix\n\nClaude Code: full support including slash commands and session hooks. Gemini CLI: full support including slash commands and session hooks. OpenCode: AGENTS.md format supported, slash commands available. Any tool supporting `AGENTS.md` format: universal directory overviews usable.\n\n## Requirements\n\nNode.js >=18.0.0, AI coding assistant (Claude Code, Gemini CLI, OpenCode, or any AGENTS.md-compatible tool). MIT License (GeoloeG-IsT, 2026). Contributing guidelines in CONTRIBUTING.md.\n### package.json\n**Purpose:** npm package manifest v0.8.3 exposing CLI binaries `agents-reverse-engineer` and `are` targeting `dist/cli/index.js`, ...\n\n**npm package manifest v0.8.3 exposing CLI binaries `agents-reverse-engineer` and `are` targeting `dist/cli/index.js`, dual exports (`./` CLI, `./core` @beta library), Node.js >=18.0.0 ES module package.**\n\n## Binaries\n`agents-reverse-engineer`, `are` → `dist/cli/index.js`\n\n## Scripts\n`build` (tsc), `build:hooks` (node scripts/build-hooks.js), `prepack` (rm -f LICENSE.sum README.md.sum), `prepublishOnly` (build + build:hooks), `dev` (tsx watch src/cli/index.ts)\n\n## Dependencies\nfast-glob@3.3.3, ignore@7.0.3, isbinaryfile@5.0.4, jsonc-parser@3.3.1, ora@8.1.1, picocolors@1.1.1, simple-git@3.27.0, yaml@2.7.0, zod@3.24.1\n\n## Exports\n`./` → dist/cli/index.js, `./core` → dist/core/index.js (types: dist/core/index.d.ts)\n\n## Distribution\nfiles: `dist`, `hooks/dist`, `README.md`, `LICENSE`\n### tsconfig.json\n**Purpose:** TypeScript compiler configuration for ES2022 ESM Node.js package with strict type-checking and declaration generation.\n\n**TypeScript compiler configuration for ES2022 ESM Node.js package with strict type-checking and declaration generation.**\n\n## Compiler Options\n\n**Target & Module**: `ES2022` target, `NodeNext` module/moduleResolution (ESM via package.json `\"type\": \"module\"`), `ES2022` lib.\n\n**Output**: `outDir: \"dist\"`, `rootDir: \"src\"`, emits `.d.ts` declarations with sourcemaps (`declaration: true`, `declarationMap: true`, `sourceMap: true`).\n\n**Type-Checking**: `strict: true`, `forceConsistentCasingInFileNames: true`, `skipLibCheck: true`.\n\n**Module Compatibility**: `esModuleInterop: true`, `resolveJsonModule: true` (JSON imports), `isolatedModules: true` (ts-loader/tsx compatibility).\n\n## File Scope\n\n**Include**: `src/**/*`  \n**Exclude**: `node_modules`, `dist`\n\n## Subdirectories\n\n### src/\n<!-- Generated by agents-reverse-engineer v0.8.3 -->\n\n# src\n\nTypeScript source root implementing eight-command CLI (`init`, `discover`, `generate`, `update`, `specify`, `rebuild`, `clean`, `install`/`uninstall`), two-phase AI documentation pipeline (file analysis → directory aggregation), iterator-based concurrency control, multi-backend subprocess orchestration (Claude/Gemini/OpenCode), frontmatter-based change detection, quality validation (code-vs-doc/code-vs-code/phantom-paths), specification synthesis, AI-driven reconstruction, and runtime integration (session hooks, slash commands, permission pre-approval).\n\n## Contents\n\n**[version.ts](./version.ts)** — `getVersion()` resolves `import.meta.url` → `fileURLToPath()` → `dirname()` → `join(__dirname, '..', 'package.json')`, parses JSON via `readFileSync()`, returns `version` field or `'unknown'` fallback on error. Used by CLI `--version` flags and telemetry metadata.\n\n## Subdirectories\n\n**[ai/](./ai/)** — AI service orchestration: subprocess spawning (`claude`/`gemini`/`opencode` CLI tools), exponential backoff retry (rate-limit only, timeouts NOT retried), timeout enforcement (SIGTERM → SIGKILL escalation at +5s), backend auto-detection (PATH scanning with insertion-order priority: Claude > Gemini > OpenCode), telemetry accumulation (`TelemetryEntry[]` → `RunLog` JSON with token/cache/latency/exit code/retry count), NDJSON trace emission (`subprocess:spawn`/`subprocess:exit`/`retry` events), provider abstraction (`AIProvider` interface decoupling transport from business logic). `AIService.call()` wraps provider in `withRetry()` configured with `isRetryable: (err) => err.code === 'RATE_LIMIT'`, records telemetry, emits trace events. `ClaudeBackend` tri-format JSON parser handles CLI ≥2.1.38 arrays, NDJSON, legacy single-object via Zod schema validation. Rate-limit detection: `['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))`. Subprocess SIGKILL via `process.kill(-childPid, 'SIGKILL')` targeting process group. Telemetry cleanup: `cleanupOldLogs(projectRoot, keepRuns)` enforces retention.\n\n**[change-detection/](./change-detection/)** — Git-based file change detection: `isGitRepo()` checks repository status, `getCurrentCommit()` fetches HEAD hash, `getChangedFiles()` detects modifications between `baseCommit` and HEAD via `git diff --name-status -M` with 50% rename threshold, optionally merges uncommitted changes from `git.status()` staged/modified/not_added/deleted arrays. `computeContentHash()` generates SHA-256 hex digest from file content. `computeContentHashFromString()` hashes in-memory strings. `ChangeType = 'added' | 'modified' | 'deleted' | 'renamed'`. Consumed by `src/update/orchestrator.ts` for frontmatter hash comparison triggering incremental regeneration.\n\n**[cli/](./cli/)** — Command-line interface routing: `index.ts` shebang entry point parses commands/flags, maps short flags (`-h`→`help`, `-g`→`global`, `-l`→`local`, `-V`→`version`), triggers interactive installer on zero-argument invocation. Eight command handlers: `init` (creates config.yaml, adds `*.sum` to `.gitignore`, sets VS Code `files.exclude`), `discover` (four-filter chain → `GENERATION-PLAN.md`), `generate` (two-phase pipeline with quality gates), `update` (frontmatter hash comparison → incremental regeneration), `specify` (12-section spec synthesis with 15-minute timeout, opus upgrade), `rebuild` (AI-driven reconstruction from Build Plan phases), `clean` (marker-filtered artifact deletion with `.local.md` restoration), `install`/`uninstall` (runtime integration). Exit codes: 0 (success/no tasks), 1 (partial failure), 2 (total failure/CLI_NOT_FOUND). Default path resolution: `positional[0] || '.'`. Extended timeout: `Math.max(config.ai.timeoutMs, 900_000)` for specify/rebuild.\n\n**[config/](./config/)** — Zod-based configuration: `loadConfig()` reads `.agents-reverse-engineer/config.yaml` via `yaml.parse()` + `ConfigSchema.parse()`, returns defaults on ENOENT, throws `ConfigError` on validation failure. `ConfigSchema` validates `exclude` (patterns/vendorDirs/binaryExtensions), `options` (followSymlinks/maxFileSize), `output.colors`, `generation.compressionRatio` clamped `[0.1, 1.0]`, `ai` (backend enum `['claude','gemini','opencode','auto']`, model, timeoutMs, maxRetries, concurrency clamped `[1, 20]`, telemetry.keepRuns). `getDefaultConcurrency()` computes `min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))`. `writeDefaultConfig()` emits inline-documented YAML template with `yamlScalar()` quoting via `/[*{}\\[\\]?,:#&!|>'\"%@`]/`.\n\n**[core/](./core/)** — Programmatic API surface (`'agents-reverse-engineer/core'` package.json export): aggregates 60+ symbols from ai/, discovery/, generation/, quality/, orchestration/, config/, change-detection/, imports/ subsystems. Exports `AIService`, `discoverFiles()`, `buildFilePrompt()`, `buildDirectoryPrompt()`, `writeSumFile()`, `readSumFile()`, `writeAgentsMd()`, `writeClaudeMdPointer()`, `DocumentationOrchestrator` (aliased `GenerationOrchestrator`, `UpdateOrchestrator`), `runPool()`, `extractExports()`, `checkCodeVsDoc()`, `checkCodeVsCode()`, `checkPhantomPaths()`, `buildInconsistencyReport()`, `formatReportForCli()`, `computeContentHash()`, `getChangedFiles()`, `loadConfig()`, `findProjectRoot()`, `extractImports()`, `nullLogger`, `consoleLogger`. `@beta` stability. Excludes CLI dependencies (ora, picocolors, process.exit()).\n\n**[discovery/](./discovery/)** — File discovery pipeline: `walkDirectory()` wraps `fast-glob@3.3.3` with `absolute: true`, `onlyFiles: true`, `dot: true`, `followSymbolicLinks: false`, `ignore: ['**/.git/**']`. `applyFilters()` runs four-filter chain via concurrency-30 worker pool with short-circuit evaluation: gitignore (pattern matching via `ignore` library, absolute→relative conversion), vendor (partitioned Set lookup + substring match for 10+ vendor dirs), binary (extension Set fast path → `isbinaryfile()` content analysis for unknowns with 1MB size cap), custom (user patterns from config). Returns `FilterResult` with `included`/`excluded` arrays. `discoverFiles()` orchestrates pipeline, emits `discovery:start`/`discovery:end` trace events. Iterator-based pool prevents file descriptor exhaustion.\n\n**[generation/](./generation/)** — Two-phase orchestration: phase-1 file analysis (source → `.sum` via `buildFilePrompt()` with import maps, compression directives, existing summary preservation), phase-2 directory aggregation (parallel `.sum` reads → `AGENTS.md` via `buildDirectoryPrompt()` post-order). `collectAgentsDocs()` recursively walks tree collecting `AGENTS.md` files sorted by `localeCompare()`, skips `SKIP_DIRS` (node_modules, .git, dist, build). `buildExecutionPlan()` creates dependency graph: `fileTasks` with empty `dependencies[]` (full parallelization), `directoryTasks` sorted by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` descending with `dependencies: files.map(f => \"file:${f}\")` (post-order constraint). `buildFilePrompt()` injects compression directives when `compressionRatio < 0.5`: `TARGET LENGTH: ~${targetSize} chars, MAX: ${maxSize}`. `writeSumFile()` formats YAML frontmatter (`generated_at`, `content_hash`, `purpose`) + markdown. `writeAgentsMd()` preserves user content via rename → `AGENTS.local.md` + `@AGENTS.local.md` import when `GENERATED_MARKER` missing. Language detection: `langMap[extname(filePath)] ?? 'text'`. Manifest detection: `['package.json', 'Cargo.toml', 'go.mod', 'pyproject.toml', 'pom.xml', 'build.gradle', 'Gemfile', 'composer.json', 'CMakeLists.txt', 'Makefile']`.\n\n**[imports/](./imports/)** — Import extraction: `extractImports()` applies regex `/^[ \\t]*import\\s+(type\\s+)?(?:\\{([^}]*)\\}|(\\*\\s+as\\s+\\w+)|(\\w+))\\s+from\\s+['\"]([^'\"]+)['\"]/gm` capturing type keyword (group 1), named symbols (group 2), namespace import (group 3), default import (group 4), module specifier (group 5). `extractDirectoryImports()` reads first 100 lines per file (optimization: imports at top), classifies relative imports as internal (`./`) or external (`../`), excludes `node:` builtins and bare specifiers. `formatImportMap()` serializes to `fileName:\\n  specifier → symbol1, symbol2 (type)\\n\\n` format with `(type)` suffix for type-only imports. Consumed by `src/generation/prompts/builder.ts` for cross-module dependency context injection.\n\n**[installer/](./installer/)** — Interactive installer orchestrating command template/session hook deployment to AI runtime config directories (`.claude/`, `.gemini/`, `.config/opencode/`) with TTY-aware prompts, settings.json hook registration via jsonc-parser, permission injection for Claude, version tracking, and symmetric uninstall operations. `runInstaller()` routes install/uninstall via `selectRuntime()` (Claude/OpenCode/Gemini/all) and `selectLocation()` (global `~/.claude` or local `./.claude`) TTY prompts with arrow keys via `readline.emitKeypressEvents()` + `setRawMode(true)`, ANSI rendering (`\\x1b[${n}A`, `\\x1b[2K`), guarantees cleanup via `cleanupRawMode()` in finally block + `process.on('exit'|'SIGINT')`. `installFilesForRuntime()` copies command templates from `getTemplatesForRuntime()` to `resolveInstallPath()`, writes hooks/plugins from `getBundledHookPath('../../hooks/dist/')`, calls `registerHooks()` (Claude: nested hooks array with `node ${runtimeDir}/hooks/${hookDef.filename}`, Gemini: flat schema with name field) and `registerPermissions()` (merges `ARE_PERMISSIONS` into settings.permissions.allow) via jsonc-parser `modify()`/`applyEdits()` preserving comments, writes `ARE-VERSION` file. `uninstallFilesForRuntime()` deletes templates/hooks/plugins, calls `unregisterHooks()`/`unregisterPermissions()` filtering via `getHookPatterns()` (current + legacy `node hooks/` formats), `cleanupAreSkillDirs()`/`cleanupLegacyGeminiFiles()`/`cleanupEmptyDirs()`, `deleteConfigFolder()` removes `.agents-reverse-engineer/` when `location === 'local'`. Hook definitions: all commented (disabled). Env var overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `XDG_CONFIG_HOME`, `GEMINI_CONFIG_DIR`.\n\n**[integration/](./integration/)** — Environment detection and integration file generation for three AI coding assistants (Claude Code, OpenCode, Gemini CLI) via directory/file presence checks and platform-specific template rendering (markdown frontmatter, TOML). `detectEnvironments(projectRoot)` checks `.claude/` OR `CLAUDE.md` (Claude Code), `.opencode/` (OpenCode), `.aider.conf.yml` OR `.aider/` (Aider) via `existsSync()`. `generateIntegrationFiles()` orchestrates template writing via `getTemplatesForEnvironment()`, creates directories + writes files with skip-if-exists (unless `force=true`), copies session hooks from `hooks/dist/`. Platform configs: Claude (`.claude/skills/are-{command}/SKILL.md` directories with `name:` frontmatter), OpenCode (`.opencode/commands/are-{command}.md` flat files with `agent: build`), Gemini (`.gemini/commands/are-{command}.toml` TOML format). Eight commands: init, discover (interactive category filter with `AskUserQuestion` multiSelect), generate, update, specify, rebuild, clean, help (reference block with NO commentary). All background commands follow 5-step pattern: (1) read `VERSION_FILE_PATH`, display version, (2) delete `.agents-reverse-engineer/progress.log`, (3) `Bash` with `run_in_background: true`, (4) poll `.agents-reverse-engineer/progress.log` every 10-15s via Read with `offset`, check TaskOutput with `block: false`, (5) summarize completion. Category classification regex: 7 categories (test/spec, CI/CD, tool configs, migrations, fixtures/snapshots, type declarations, Docker/infra) with 30+ patterns.\n\n**[orchestration/](./orchestration/)** — Concurrency control and pipeline orchestration: `runPool<T>(tasks, options, onComplete?)` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator, each worker loops `for (const [index, task] of iterator)` pulling next when previous completes, returns sparse `TaskResult<T>[]` indexed by original position, invokes optional `onComplete(result)` callback after each task settles, supports `failFast` (sets shared `aborted` flag). `CommandRunner.run()` executes five-phase pipeline: **pre-phase-1-cache** (reads existing `.sum` into `oldSumCache` via concurrency 20), **phase-1-files** (parallel AI calls, writes `.sum`/`.annex.sum`, caches source in `sourceContentCache`), **post-phase-1-quality** (throttled `checkCodeVsDoc()` against old/new `.sum` + `checkCodeVsCode()` per directory group, concurrency 10), **phase-2-dirs** (depth-grouped post-order aggregation sorted `depthB - depthA`, sequentially by depth, concurrently within depth), **post-phase-2** (`checkPhantomPaths()` markdown link validation). Separate `executeUpdate()` runs phase-1 only. `DocumentationOrchestrator.createPlan()` nullifies `PreparedFile.content` after prompt building to free memory. `preparePlan()` performs frontmatter hash comparison, populates `filesToAnalyze`/`filesToSkip`, calls `cleanupOrphans()`, `getAffectedDirectories()` sorted by depth descending. `PlanTracker` serializes `GENERATION-PLAN.md` writes via `this.writeQueue.then(() => writeFile(...))` promise chain, `markDone()` replaces `- [ ]` with `- [x]`. `ProgressReporter` maintains sliding windows (`windowSize = 10`) for moving-average ETA. `TraceWriter` appends NDJSON to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson`, injects base fields (`seq`, `ts`, `pid`, `elapsedMs`), 14 event types. `cleanupOldTraces(projectRoot, keepCount = 500)`.\n\n**[output/](./output/)** — Terminal output abstraction: `Logger` interface (`info`, `file`, `excluded`, `summary`, `warn`, `error`), `createLogger` factory conditionally applies picocolors@8.1.1 via `ColorFunctions` adapter when `options.colors: true`, `createSilentLogger` (no-op for tests). Format templates: `file()` → `\"  +\" + path` (green), `excluded()` → `\"  -\" + path + \" (reason: filter)\"` (dim), `summary()` → `\"\\nDiscovered N files (M excluded)\"` (bold counts), `warn()` → `\"Warning: \"` (yellow), `error()` → `\"Error: \"` (red). Used by CLI commands for serialized progress logging during worker pool execution.\n\n**[quality/](./quality/)** — Post-generation validation: `extractExports()` via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, `checkCodeVsDoc()` compares extracted symbols against `.sum` summary text via case-sensitive `includes()`, `checkCodeVsCode()` flags duplicates when `exportMap.get(symbolName).length >= 2`, `checkPhantomPaths()` extracts paths via three regex patterns (markdown links `/\\[(?:[^\\]]*)\\]\\((\\.[^)]+)\\)/g`, backtick-quoted `/`((?:src\\/|\\.\\.?\\/)[^`]+\\.[a-z]{1,4})`/g`, prose `/(?:from|in|by|via|see)\\s+`?(src\\/[\\w\\-./]+)`?/gi`), applies six exclusion patterns (`/node_modules/`, `/\\.git\\//`, `/^https?:/`, `/\\{\\{/`, `/\\$\\{/`, `/\\*/`, `/\\{[^}]*,[^}]*\\}/`), resolves via dual strategy (relative to AGENTS.md directory + project root), handles `.js`→`.ts` substitution. `buildInconsistencyReport()` aggregates findings, `formatReportForCli()` emits `[ERROR]`/`[WARN]`/`[INFO]` tagged output. Severity levels: error (blocking, unused), warning (drift/duplicates/broken paths), info (advisory, unused). Invoked by `CommandRunner.run()` in post-phase-1-quality (throttled directory group checks, concurrency 10) and post-phase-2 (phantom path validation). Non-throwing: errors logged but do not abort pipeline. `validateFindability()` stub (disabled).\n\n**[rebuild/](./rebuild/)** — AI-driven reconstruction: `readSpecFiles()` loads `specs/*.md` sorted alphabetically, `partitionSpec()` extracts Build Plan phases via `/^### Phase (\\d+):\\s*(.+)$/gm`, injects Architecture section + targeted Public API Surface/Data Structures/Behavioral Contracts subsections when `hasDefinesConsumes` detects `/^\\*\\*Defines:\\*\\*|^Defines:/m`, else injects full Public API Surface. `CheckpointManager.load()` validates `.rebuild-checkpoint` JSON (RebuildCheckpointSchema) with spec drift detection (SHA-256 hash comparison), returns `{manager, isResume}` + filters pending units. `executeRebuild()` groups `RebuildUnit[]` by `order` field, processes groups sequentially with concurrent `runPool()` per group, calls `buildRebuildPrompt(unit, fullSpec, builtContext)` injecting context → `AIService.call()` → `parseModuleOutput()` → writes files → `checkpoint.markDone()`. Accumulates `builtContext` from written source files (skips `.md`/`.json`/`.yml`), truncates at `BUILT_CONTEXT_LIMIT` (100,000 chars) preserving recent sections full + older sections as 20-line headers. `parseModuleOutput()` uses delimiter parser (`===FILE: path===` / `===END_FILE===` state machine requiring column-0 delimiters), fallback to fenced block extractor (`/```\\w*:([^\\n]+)\\n([\\s\\S]*?)```/g`). `REBUILD_SYSTEM_PROMPT` mandates delimiter format, exact identifier matching, production-ready code, imports from \"Already Built\" context, prohibits column-0 delimiter text in generated code. Module status enum: `'pending' | 'done' | 'failed'`. Spec drift triggers checkpoint discard. Promise-chain serialization via `checkpoint.writeQueue.then(() => writeFile())`.\n\n**[specify/](./specify/)** — Specification synthesis: `buildSpecPrompt(docs, annexFiles?)` injects `AgentsDocs` arrays into `SPEC_SYSTEM_PROMPT` enforcing 12-section format (Project Overview → Build Plan → Prompt Templates → File Manifest) with mandatory verbatim reproduction of regex patterns, format strings, magic constants, prompt templates, installer configs from annex files. `writeSpec(content, options)` single-file mode writes direct to `outputPath`, multi-file mode splits on `# ` headings via `/^(?=# )/m` + slugified filenames in `outputPath` directory, throws `SpecExistsError` listing conflicting `paths[]` when files exist and `force=false`, pre-validates all targets atomically before writing. Preamble → `00-preamble.md`. Build Plan validation rules: every API Surface export MUST appear in exactly one phase's \"Defines:\" list, every File Manifest entry MUST be referenced in a phase, each phase MUST include \"Defines:\" and \"Consumes:\" lists cross-referencing section 3. Prohibited patterns: folder-mirroring structure, directory names as headings, omitting version numbers from Dependencies, missing type signatures in API Surface, phases without Defines/Consumes lists. Verbatim reproduction mandate: regex/format/template/constant/environment variable/sentinel values in fenced blocks, NO summarization/paraphrasing/abbreviation/prose substitution. Consumed by `src/cli/specify.ts` calling `collectAgentsDocs()` → `buildSpecPrompt()` → `AIService.call()` (15-minute timeout, opus upgrade) → `writeSpec()`. Output consumed by `src/rebuild/spec-reader.ts` for reconstruction.\n\n**[types/](./types/)** — Shared discovery types: `ExcludedFile` (`{path, reason}`), `DiscoveryResult` (`{files, excluded}`), `DiscoveryStats` (`{totalFiles, includedFiles, excludedFiles, exclusionReasons: Record<string, number>}`). Consumed by `src/discovery/walker.ts` (four-filter chain output), `src/cli/discover.ts` (CLI reporting). Aggregated metrics with exclusion reason bucketing for terminal output.\n\n**[update/](./update/)** — Incremental update: `UpdateOrchestrator.preparePlan()` reads existing `.sum` frontmatter via `readSumFile()`, compares `content_hash` against `computeContentHash()`, populates `filesToAnalyze` on mismatch (status `'added'` if no .sum, `'modified'` if hash differs), populates `filesToSkip` on match. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for deleted/renamed files via `deleteIfExists()`, invokes `cleanupEmptyDirectoryDocs()` on affected parent directories (checks `hasSourceFiles` excluding `GENERATED_FILES`, dotfiles, `.sum` suffixes, deletes `AGENTS.md` when empty), returns `CleanupResult`. `getAffectedDirectories()` collects parent directories from non-deleted `FileChange[]` via `path.dirname()` walk, sorted by depth descending. Dry-run support via boolean flag (simulates deletion without `unlink()`). `UpdateOptions` (`includeUncommitted?`, `dryRun?`), `UpdateResult` (`analyzedFiles`, `skippedFiles`, `cleanup`, `regeneratedDirs`, `baseCommit`, `currentCommit`, `dryRun`). Consumes `FileChange` type from change-detection/ containing `path`, `status`, optional `oldPath` for renames.\n\n## Architecture\n\n### Two-Phase Pipeline\n\n**Phase 1 (File Analysis)**: `src/generation/orchestrator.ts` `createFileTasks()` builds `GenerationTask[]` with `buildFilePrompt()` (injects import maps, project structure, compression directives), executes via `src/orchestration/runner.ts` `runPool()` with user-configured concurrency (default: `os.availableParallelism() * 5` clamped to memory cap `min(20, floor(totalMemGB * 0.5 / 0.512), max(2, cpus * 5))`), spawns LLM subprocesses via `src/ai/subprocess.ts` `runSubprocess()` (SIGTERM at timeout, SIGKILL at timeout+5s), writes `.sum` files via `src/generation/writers/sum.ts` `writeSumFile()` with YAML frontmatter (`file_type`, `generated_at`, `content_hash`). Nullifies task content after prompt building to free memory.\n\n**Phase 2 (Directory Aggregation)**: `createDirectoryTasks()` constructs dependency graph (child file task IDs), sorts by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending), groups by depth, executes depth-grouped sequential batches with parallel concurrency per group, `buildDirectoryPrompt()` reads child `.sum` via parallel `readSumFile()`, `src/generation/writers/agents-md.ts` `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` + injects `@AGENTS.local.md` directive, root `src/generation/writers/claude-md.ts` `writeClaudeMdPointer()` generates deterministic `CLAUDE.md` import.\n\n### Concurrency Control\n\n`src/orchestration/pool.ts` `runPool<T>()` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator. Each worker pulls `[index, task]` pairs until exhausted or `aborted` flag set. Maintains full utilization during variable-duration tasks. Optional `onComplete?: (result) => void` callback enables serialized `src/orchestration/plan-tracker.ts` `PlanTracker.markDone()` updates to `GENERATION-PLAN.md` checkboxes via promise-chain pattern. Calculation: `concurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))`.\n\n### Update Strategy\n\n`src/update/orchestrator.ts` `UpdateOrchestrator.preparePlan()` reads existing `.sum` YAML frontmatter via `src/generation/writers/sum.ts` `readSumFile()`, compares stored `content_hash` against `src/change-detection/detector.ts` `computeContentHash()` (SHA-256 hex digest), populates `filesToAnalyze` on mismatch, executes phase-1-files pipeline for changed files, invokes `getAffectedDirectories()` collecting parent directories sorted by depth descending, sequentially regenerates `AGENTS.md` consuming updated child `.sum`. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for git-deleted files, removes AGENTS.md when no source files remain.\n\n### Telemetry Pipeline\n\n`src/ai/service.ts` `AIService` wraps `runSubprocess()` in `src/ai/retry.ts` `withRetry()` (exponential backoff: `min(1000 * 2^attempt, 8000) + random(500)` for RATE_LIMIT errors only, timeouts NOT retried), records `src/ai/telemetry/run-log.ts` `TelemetryEntry` (prompt/response/tokens/cache/latency/exitCode/retryCount/thinking/filesRead), optional `src/orchestration/trace.ts` `TraceWriter` emits NDJSON events (`subprocess:spawn`, `subprocess:exit`, `retry`, `worker:start`, `task:done`, `phase:start`) to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` when `--trace` flag set. `aiService.finalize(projectRoot)` writes `RunLog` to `.agents-reverse-engineer/logs/run-{timestamp}.json`, calls `src/ai/telemetry/cleanup.ts` `cleanupOldLogs()` enforcing `config.ai.telemetry.keepRuns` retention.\n\n### Quality Gates\n\n`src/orchestration/runner.ts` `CommandRunner.run()` executes five phases: **pre-phase-1-cache** (reads existing `.sum` for baseline via `runPool()` concurrency 20), **phase-1-files** (parallel AI calls), **post-phase-1-quality** (throttled directory group checks: `src/quality/inconsistency/code-vs-doc.ts` `checkCodeVsDoc()` detects undocumented exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, `src/quality/inconsistency/code-vs-code.ts` `checkCodeVsCode()` finds duplicate symbols, concurrency 10 per group), **phase-2-dirs** (post-order aggregation), **post-phase-2** (`src/quality/phantom-paths/validator.ts` `checkPhantomPaths()` validates markdown links via `/\\[(?:[^\\]]*)\\]\\((\\.[^)]+)\\)/g` + backtick paths + prose references with dual-resolution strategy + `.js`→`.ts` substitution). Aggregates findings via `src/quality/inconsistency/reporter.ts` `buildInconsistencyReport()`, emits severity-tagged CLI output via `formatReportForCli()`.\n\n### Rebuild Workflow\n\n`src/rebuild/spec-reader.ts` `readSpecFiles()` discovers `specs/*.md` → `partitionSpec()` extracts Build Plan phases via `/^### Phase (\\d+):\\s*(.+)$/gm` → `src/rebuild/checkpoint.ts` `CheckpointManager.load()` validates `.rebuild-checkpoint` JSON with spec drift detection (SHA-256 hash comparison) → `src/rebuild/orchestrator.ts` `executeRebuild()` groups `RebuildUnit[]` by `order` → sequential groups with concurrent `runPool()` per group → `src/rebuild/prompts.ts` `buildRebuildPrompt()` (injects Architecture + targeted subsections, accumulates `builtContext` truncated at 100KB) → `AIService.call()` → `src/rebuild/output-parser.ts` `parseModuleOutput()` (delimiter format: `===FILE: path===` / `===END_FILE===` with column-0 requirement, fallback to fenced-block parser) → writes files → `CheckpointManager.markDone()` serialized updates.\n\n## Behavioral Contracts\n\n### Exit Codes\n- **0**: All tasks succeeded or no tasks to process\n- **1**: Partial failure (some tasks failed but some succeeded)\n- **2**: Total failure (all tasks failed or CLI not found)\n\n### Concurrency Calculation\n```javascript\nconcurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))\n// Constants: SUBPROCESS_HEAP_GB=0.512, MEMORY_FRACTION=0.5, MULTIPLIER=5, MIN=2, MAX=20\n```\n\n### Exponential Backoff\n```javascript\ndelay = min(1000 * 2^attempt, 8000) + Math.random() * 500\n// Defaults: baseDelayMs=1000, multiplier=2, maxDelayMs=8000, jitter=[0,500ms]\n```\n\n### Retry Policy\n```javascript\nisRetryable: err => err.code === 'RATE_LIMIT'\n// Timeouts NOT retried (subprocess overhead on struggling systems)\n```\n\n### Rate Limit Detection\n```javascript\n['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))\n```\n\n### Timeout Escalation\n- SIGTERM at `options.timeoutMs` via `execFile()` timeout option\n- SIGKILL at `options.timeoutMs + 5000ms` via `setTimeout(() => process.kill(-childPid, 'SIGKILL'), ...)` (process group)\n\n### Post-Order Sort\n```javascript\ngetDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth\n// getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length\n```\n\n### Import Extraction\n```regex\n/^[ \\t]*import\\s+(type\\s+)?(?:\\{([^}]*)\\}|(\\*\\s+as\\s+\\w+)|(\\w+))\\s+from\\s+['\"]([^'\"]+)['\"]/gm\n```\nCaptures: group 1 (type keyword), group 2 (named symbols), group 3 (namespace import), group 4 (default import), group 5 (module specifier).\n\n### Export Extraction\n```regex\n/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm\n```\nCaptures identifier in group 1 after export keyword and declaration type.\n\n### Hook Disable Mechanisms\n```javascript\nprocess.env.ARE_DISABLE_HOOK === '1'\n// OR\nreadFileSync('.agents-reverse-engineer.yaml').includes('hook_enabled: false')\n```\n\n### Version Resolution Priority\n1. Project-local: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`\n2. Global: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`\n3. Fallback: `'0.0.0'` (discovery), `'unknown'` (version.ts)\n\n### Update Check Cache Schema\n```json\n{\n  \"update_available\": false,\n  \"installed\": \"0.8.0\",\n  \"latest\": \"0.8.0\",\n  \"checked\": 1738416000\n}\n```\n\n### Git Change Detection\n```javascript\nexecSync('git status --porcelain', { encoding: 'utf-8' })\n// Exit if status.trim() === '' (no changes) or command throws (not a git repo)\n```\n\n### Generated File Marker\n```javascript\nGENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'\n```\n\n### Compression Injection\n```javascript\n// Condition: compressionRatio < 0.5 && sourceFileSize > 0\ntargetSize = Math.round(sourceFileSize * compressionRatio)\nmaxSize = Math.round(targetSize * 1.2)\ncompressionPercentage = Math.round(compressionRatio * 100)\n```\n\n## Directory Hints\n\nContains manifest file(s): package.json — likely a package or project root.\n\n## Existing AGENTS.md (update this — preserve stable content, modify only what changed)\n\n<!-- Generated by agents-reverse-engineer v0.8.2 -->\n\n# agents-reverse-engineer\n\nCLI tool for generating AI-friendly codebase documentation via recursive post-order traversal: parallel `.sum` file analysis followed by hierarchical `AGENTS.md` aggregation, with session hooks for incremental updates and cross-runtime support (Claude Code, Gemini CLI, OpenCode).\n\n## Contents\n\n### Documentation\n\n**[CONTRIBUTING.md](./CONTRIBUTING.md)** — Developer onboarding: `npm install` → `npm run dev` (tsx watch) → `npm run build` (tsc → dist/). Six core directories: `src/cli/` (command handlers), `src/config/` (YAML/Zod validation), `src/discovery/` (four-filter chain), `src/generation/` (AI-driven docs), `src/orchestration/` (worker pool, tracing), `src/ai/` (subprocess management). Fork-based contribution process with PR requirements: `npm run build` succeeds, reproduction steps for bugs, use case descriptions for features.\n\n**[LANGUAGES-MANIFEST.md](./LANGUAGES-MANIFEST.md)** — Maps 26 ecosystems to manifest patterns: JavaScript/TypeScript (`package.json`, npm/yarn/pnpm, ✓), Python (`requirements.txt`/`pyproject.toml`/`setup.py`/`Pipfile`, pip/poetry/pipenv, ✓), Go (`go.mod`, go modules, ✓), Rust (`Cargo.toml`, cargo, ✓), Ruby (`Gemfile`, bundler), Java (`pom.xml`/`build.gradle`, Maven/Gradle), C# (`*.csproj`/`packages.config`, NuGet), PHP (`composer.json`, Composer), Swift (`Package.swift`), Dart (`pubspec.yaml`, pub), Haskell (`package.yaml`/`*.cabal`/`stack.yaml`), C/C++ (`CMakeLists.txt`/`conanfile.txt`/`vcpkg.json`), plus 14 others. Informs `src/discovery/walker.ts` file discovery and `src/imports/extractor.ts` dependency extraction.\n\n**[LICENSE](./LICENSE)** — MIT License (GeoloeG-IsT, 2026) granting unrestricted usage, modification, distribution with warranty disclaimer. Copyright notice + permission notice required in all copies/substantial portions. Applies to source tree (`src/`, `hooks/`, `dist/`) and compiled binaries per `package.json` `files` array.\n\n**[README.md](./README.md)** — Installation: `npx agents-reverse-engineer@latest` (interactive) or `--runtime <rt> -g|-l` (non-interactive). Eight commands: `init` (config), `discover` (scan → GENERATION-PLAN.md), `generate` (two-phase pipeline), `update` (incremental regeneration), `specify` (AGENTS.md → specs/SPEC.md with `--multi-file` or `--dry-run`), `clean` (artifact deletion), `rebuild` (AI-driven reconstruction from specs with delimiter format `===FILE: path===` / `===END_FILE===`), `install`/`uninstall` (slash commands + session hooks). Artifact formats: `.sum` (YAML frontmatter + markdown sections), `AGENTS.md` (directory aggregates), `CLAUDE.md`/`GEMINI.md`/`OPENCODE.md` (runtime pointers). Config schema: `.agents-reverse-engineer/config.yaml` with exclude patterns, AI backend, concurrency, telemetry retention. Runtime support: Claude Code (full), Gemini CLI (full), OpenCode (AGENTS.md only).\n\n### Configuration\n\n**[package.json](./package.json)** — npm manifest v0.8.2: binaries `agents-reverse-engineer`/`are` → `dist/cli/index.js`. Dual exports: `./` (CLI), `./core` (@beta library API). Scripts: `build` (tsc), `build:hooks` (node scripts/build-hooks.js), `prepack` (rm -f LICENSE.sum README.md.sum), `prepublishOnly` (build + build:hooks), `dev` (tsx watch). Dependencies: fast-glob@3.3.3, ignore@7.0.3, isbinaryfile@5.0.4, jsonc-parser@3.3.1, ora@8.1.1, picocolors@1.1.1, simple-git@3.27.0, yaml@2.7.0, zod@3.24.1. Node.js >=18.0.0. Distribution: `dist/`, `hooks/dist/`, `README.md`, `LICENSE`.\n\n**[tsconfig.json](./tsconfig.json)** — TypeScript config: ES2022 target, NodeNext module/moduleResolution (ESM via package.json `\"type\": \"module\"`), `outDir: \"dist\"`, `rootDir: \"src\"`. Emits `.d.ts` declarations with sourcemaps. Strict type-checking enabled. `resolveJsonModule: true` (JSON imports), `isolatedModules: true` (ts-loader/tsx compatibility). Includes `src/**/*`, excludes `node_modules`/`dist`.\n\n## Subdirectories\n\n**[docs/](./docs/)** — RLM algorithm specification defining post-order traversal (file `.sum` → leaf-complete `AGENTS.md` → recursive parent aggregation), slash command interface, session-end hooks, brownfield research directives (GSD workflow patterns, BMAD method, SpecKit structure). Contains INPUT.md with optional reference documents (ARCHITECTURE.md, STRUCTURE.md, STACK.md, INTEGRATIONS.md, INFRASTRUCTURE.md, CONVENTIONS.md, TESTING.md, PATTERNS.md, CONCERNS.md).\n\n**[hooks/](./hooks/)** — Session lifecycle automation: `are-check-update.js` / `opencode-are-check-update.js` (SessionStart detached npm registry check → `~/.claude/cache/are-update-check.json` or `~/.config/opencode/cache/are-update-check.json`), `are-session-end.js` (SessionEnd detached `npx agents-reverse-engineer@latest update --quiet` on git change detection). Disable gates: `ARE_DISABLE_HOOK=1` env var, `hook_enabled: false` in `.agents-reverse-engineer.yaml`. Detached spawn pattern: `spawn(command, args, {stdio: 'ignore', detached: true, windowsHide: true})` + `child.unref()`. Version resolution priority: project-local `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`, global `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`, fallback `'0.0.0'`.\n\n**[scripts/](./scripts/)** — Build automation: `build-hooks.js` copies `hooks/*.js` → `hooks/dist/` via `copyFileSync()` during `npm run build:hooks` / `prepublishOnly`. Creates destination with `mkdirSync({recursive: true})`, logs copied count. Ensures session hooks bundled in published package for `src/installer/operations.ts` `installSessionHooks()`.\n\n**[src/](./src/)** — TypeScript source tree implementing CLI, configuration, discovery, generation, orchestration, AI integration, quality validation, update orchestration, rebuild pipeline, specification transformation. Entry point: `cli/index.ts`. Programmatic API: `core/index.ts` exports 60+ symbols via `'agents-reverse-engineer/core'` package.json export (@beta stability). Subsystems: `cli/` (command routing), `config/` (YAML/Zod validation), `discovery/` (four-filter chain), `generation/` (two-phase orchestration + prompt templates), `orchestration/` (iterator-based worker pool, NDJSON trace emission, serialized progress logging), `ai/` (multi-backend subprocess spawning with exponential backoff retry, telemetry, SIGTERM/SIGKILL timeout escalation), `update/` (frontmatter-based staleness detection + orphan cleanup), `quality/` (code-vs-doc/code-vs-code/phantom-paths validation), `rebuild/` (AI-driven reconstruction with checkpoint management), `specify/` (AGENTS.md → 12-section project spec), `imports/` (import/export extraction), `installer/` (interactive runtime integration), `integration/` (environment detection + command templates), `change-detection/` (git-based hash comparison).\n\n**[.github/workflows/](../.github/workflows/)** — GitHub Actions CI/CD automation.\n\n## Architecture\n\n### Two-Phase Pipeline\n\n**Phase 1 (File Analysis)**: `src/generation/orchestrator.ts` `createFileTasks()` builds `GenerationTask[]` with `buildFilePrompt()` (injects import maps, project structure, compression directives), executes via `src/orchestration/runner.ts` `runPool()` with user-configured concurrency (default: `os.availableParallelism() * 5` clamped to memory cap), spawns LLM subprocesses via `src/ai/subprocess.ts` `runSubprocess()` (SIGTERM at timeout, SIGKILL at timeout+5s), writes `.sum` files via `src/generation/writers/sum.ts` `writeSumFile()` with YAML frontmatter (`file_type`, `generated_at`, `content_hash`). Nullifies task content after prompt building to free memory.\n\n**Phase 2 (Directory Aggregation)**: `createDirectoryTasks()` constructs dependency graph (child file task IDs), sorts by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending), groups by depth, executes depth-grouped sequential batches with parallel concurrency per group, `buildDirectoryPrompt()` reads child `.sum` via parallel `readSumFile()`, `src/generation/writers/agents-md.ts` `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` + injects `@AGENTS.local.md` directive, root `src/generation/writers/claude-md.ts` `writeClaudeMdPointer()` generates deterministic `CLAUDE.md` import.\n\n### Concurrency Control\n\n`src/orchestration/pool.ts` `runPool<T>()` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator. Each worker pulls `[index, task]` pairs until exhausted or `aborted` flag set. Maintains full utilization during variable-duration tasks. Optional `onComplete?: (result) => void` callback enables serialized `src/orchestration/plan-tracker.ts` `PlanTracker.markDone()` updates to `GENERATION-PLAN.md` checkboxes via promise-chain pattern. Calculation: `concurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))`.\n\n### Update Strategy\n\n`src/update/orchestrator.ts` `UpdateOrchestrator.preparePlan()` reads existing `.sum` YAML frontmatter via `src/generation/writers/sum.ts` `readSumFile()`, compares stored `content_hash` against `src/change-detection/detector.ts` `computeContentHash()` (SHA-256 hex digest), populates `filesToAnalyze` on mismatch, executes phase-1-files pipeline for changed files, invokes `getAffectedDirectories()` collecting parent directories sorted by depth descending, sequentially regenerates `AGENTS.md` consuming updated child `.sum`. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for git-deleted files, removes AGENTS.md when no source files remain.\n\n### Telemetry Pipeline\n\n`src/ai/service.ts` `AIService` wraps `runSubprocess()` in `src/ai/retry.ts` `withRetry()` (exponential backoff: `min(1000 * 2^attempt, 8000) + random(500)` for RATE_LIMIT errors only, timeouts NOT retried), records `src/ai/telemetry/run-log.ts` `TelemetryEntry` (prompt/response/tokens/cache/latency/exitCode/retryCount/thinking/filesRead), optional `src/orchestration/trace.ts` `TraceWriter` emits NDJSON events (`subprocess:spawn`, `subprocess:exit`, `retry`, `worker:start`, `task:done`, `phase:start`) to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` when `--trace` flag set. `aiService.finalize(projectRoot)` writes `RunLog` to `.agents-reverse-engineer/logs/run-{timestamp}.json`, calls `src/ai/telemetry/cleanup.ts` `cleanupOldLogs()` enforcing `config.ai.telemetry.keepRuns` retention.\n\n### Quality Gates\n\n`src/orchestration/runner.ts` `CommandRunner.run()` executes five phases: **pre-phase-1-cache** (reads existing `.sum` for baseline via `runPool()` concurrency 20), **phase-1-files** (parallel AI calls), **post-phase-1-quality** (throttled directory group checks: `src/quality/inconsistency/code-vs-doc.ts` `checkCodeVsDoc()` detects undocumented exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, `src/quality/inconsistency/code-vs-code.ts` `checkCodeVsCode()` finds duplicate symbols, concurrency 10 per group), **phase-2-dirs** (post-order aggregation), **post-phase-2** (`src/quality/phantom-paths/validator.ts` `checkPhantomPaths()` validates markdown links via `/\\[(?:[^\\]]*)\\]\\((\\.[^)]+)\\)/g` + backtick paths + prose references with dual-resolution strategy + `.js`→`.ts` substitution). Aggregates findings via `src/quality/inconsistency/reporter.ts` `buildInconsistencyReport()`, emits severity-tagged CLI output via `formatReportForCli()`.\n\n### Rebuild Workflow\n\n`src/rebuild/spec-reader.ts` `readSpecFiles()` discovers `specs/*.md` → `partitionSpec()` extracts Build Plan phases via `/^### Phase (\\d+):\\s*(.+)$/gm` → `src/rebuild/checkpoint.ts` `CheckpointManager.load()` validates `.rebuild-checkpoint` JSON with spec drift detection (SHA-256 hash comparison) → `src/rebuild/orchestrator.ts` `executeRebuild()` groups `RebuildUnit[]` by `order` → sequential groups with concurrent `runPool()` per group → `src/rebuild/prompts.ts` `buildRebuildPrompt()` (injects Architecture + targeted subsections, accumulates `builtContext` truncated at 100KB) → `AIService.call()` → `src/rebuild/output-parser.ts` `parseModuleOutput()` (delimiter format: `===FILE: path===` / `===END_FILE===` with column-0 requirement, fallback to fenced-block parser) → writes files → `CheckpointManager.markDone()` serialized updates.\n\n## Behavioral Contracts\n\n### Exit Codes\n- **0**: All tasks succeeded or no tasks to process\n- **1**: Partial failure (some tasks failed but some succeeded)\n- **2**: Total failure (all tasks failed or CLI not found)\n\n### Concurrency Calculation\n```javascript\nconcurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))\n// Constants: SUBPROCESS_HEAP_GB=0.512, MEMORY_FRACTION=0.5, MULTIPLIER=5, MIN=2, MAX=20\n```\n\n### Exponential Backoff\n```javascript\ndelay = min(1000 * 2^attempt, 8000) + Math.random() * 500\n// Defaults: baseDelayMs=1000, multiplier=2, maxDelayMs=8000, jitter=[0,500ms]\n```\n\n### Retry Policy\n```javascript\nisRetryable: err => err.code === 'RATE_LIMIT'\n// Timeouts NOT retried (subprocess overhead on struggling systems)\n```\n\n### Rate Limit Detection\n```javascript\n['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))\n```\n\n### Timeout Escalation\n- SIGTERM at `options.timeoutMs` via `execFile()` timeout option\n- SIGKILL at `options.timeoutMs + 5000ms` via `setTimeout(() => process.kill(-childPid, 'SIGKILL'), ...)` (process group)\n\n### Post-Order Sort\n```javascript\ngetDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth\n// getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length\n```\n\n### Import Extraction\n```regex\n/^[ \\t]*import\\s+(type\\s+)?(?:\\{([^}]*)\\}|(\\*\\s+as\\s+\\w+)|(\\w+))\\s+from\\s+['\"]([^'\"]+)['\"]/gm\n```\nCaptures: group 1 (type keyword), group 2 (named symbols), group 3 (namespace import), group 4 (default import), group 5 (module specifier).\n\n### Export Extraction\n```regex\n/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm\n```\nCaptures identifier in group 1 after export keyword and declaration type.\n\n### Hook Disable Mechanisms\n```javascript\nprocess.env.ARE_DISABLE_HOOK === '1'\n// OR\nreadFileSync('.agents-reverse-engineer.yaml').includes('hook_enabled: false')\n```\n\n### Version Resolution Priority\n1. Project-local: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`\n2. Global: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`\n3. Fallback: `'0.0.0'` (discovery), `'unknown'` (version.ts)\n\n### Update Check Cache Schema\n```json\n{\n  \"update_available\": false,\n  \"installed\": \"0.8.0\",\n  \"latest\": \"0.8.0\",\n  \"checked\": 1738416000\n}\n```\n\n### Git Change Detection\n```javascript\nexecSync('git status --porcelain', { encoding: 'utf-8' })\n// Exit if status.trim() === '' (no changes) or command throws (not a git repo)\n```\n\n### Generated File Marker\n```javascript\nGENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'\n```\n\n### Compression Injection\n```javascript\n// Condition: compressionRatio < 0.5 && sourceFileSize > 0\ntargetSize = Math.round(sourceFileSize * compressionRatio)\nmaxSize = Math.round(targetSize * 1.2)\ncompressionPercentage = Math.round(compressionRatio * 100)\n```\n\n## Stack\n\n- **Runtime**: Node.js >=18.0.0, ES modules (`\"type\": \"module\"`)\n- **Language**: TypeScript 5.7.3 targeting ES2022 with NodeNext module resolution\n- **Concurrency**: Iterator-based worker pool, shared iterator, N workers (src/orchestration/pool.ts)\n- **File Discovery**: fast-glob@3.3.3 with ignore@7.0.3 (gitignore filtering)\n- **Git Operations**: simple-git@3.27.0 for change detection (src/change-detection/detector.ts)\n- **Config Parsing**: yaml@2.7.0 + zod@3.24.1 schema validation (src/config/schema.ts)\n- **JSON Editing**: jsonc-parser@3.3.1 for settings.json hook registration (src/installer/operations.ts)\n- **Binary Detection**: isbinaryfile@5.0.4 for `.sum` exclusion (src/discovery/filters/binary.ts)\n- **Terminal UI**: ora@8.1.1 (spinners), picocolors@1.1.1 (colored output)\n- **AI Backends**: subprocess spawning (src/ai/subprocess.ts) targeting `claude`, `gemini`, `opencode` CLIs\n- **Build**: tsc (TypeScript compiler), tsx@4.19.2 (dev watch mode)",
      "systemPrompt": "You are updating an existing AGENTS.md file — a directory-level overview for AI coding assistants. Some file summaries or subdirectory documents have changed, and AGENTS.md needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING AGENTS.md and the CURRENT file summaries and subdirectory documents\n- Preserve the structure, section headings, and descriptions that are still accurate\n- Only modify entries for files or subdirectories whose summaries have changed\n- Add entries for new files, remove entries for deleted files\n- Do NOT reorganize, rephrase, or restructure sections that are unaffected by changes\n- Keep the same section ordering unless files were added/removed in a way that requires regrouping\n- Behavioral Contracts section: preserve verbatim regex patterns and constants unless source file summaries show they changed\n- Reproduction-Critical Constants: if file summaries reference annex files (.annex.sum), preserve the links. Add links for new annexes, remove links for deleted ones.\n- Workflow & Conventions section: preserve existing rules unless source file summaries show they changed. Add rules from new files, remove rules for deleted files.\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Preserve the existing purpose statement unless the directory's role has fundamentally changed\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n- Cross-module references must use the specifier format from actual import statements\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context",
      "response": "<!-- Generated by agents-reverse-engineer -->\n\n# agents-reverse-engineer\n\nCLI tool for generating AI-friendly codebase documentation via recursive post-order traversal: parallel `.sum` file analysis followed by hierarchical `AGENTS.md` aggregation, with session hooks for incremental updates and cross-runtime support (Claude Code, Gemini CLI, OpenCode).\n\n## Contents\n\n### Documentation\n\n**[CONTRIBUTING.md](./CONTRIBUTING.md)** — Developer onboarding: `npm install` → `npm run dev` (tsx watch) → `npm run build` (tsc → dist/). Six core directories: `src/cli/` (command handlers), `src/config/` (YAML/Zod validation), `src/discovery/` (four-filter chain), `src/generation/` (AI-driven docs), `src/orchestration/` (worker pool, tracing), `src/ai/` (subprocess management). Fork-based contribution process with PR requirements: `npm run build` succeeds, reproduction steps for bugs, use case descriptions for features.\n\n**[LANGUAGES-MANIFEST.md](./LANGUAGES-MANIFEST.md)** — Maps 26 ecosystems to manifest patterns: JavaScript/TypeScript (`package.json`, npm/yarn/pnpm, ✓), Python (`requirements.txt`/`pyproject.toml`/`setup.py`/`Pipfile`, pip/poetry/pipenv, ✓), Go (`go.mod`, go modules, ✓), Rust (`Cargo.toml`, cargo, ✓), Ruby (`Gemfile`, bundler), Java (`pom.xml`/`build.gradle`, Maven/Gradle), C# (`*.csproj`/`packages.config`, NuGet), PHP (`composer.json`, Composer), Swift (`Package.swift`), Dart (`pubspec.yaml`, pub), Haskell (`package.yaml`/`*.cabal`/`stack.yaml`), C/C++ (`CMakeLists.txt`/`conanfile.txt`/`vcpkg.json`), plus 14 others. Informs `src/discovery/walker.ts` file discovery and `src/imports/extractor.ts` dependency extraction.\n\n**[LICENSE](./LICENSE)** — MIT License (GeoloeG-IsT, 2026) granting unrestricted usage, modification, distribution with warranty disclaimer. Copyright notice + permission notice required in all copies/substantial portions. Applies to source tree (`src/`, `hooks/`, `dist/`) and compiled binaries per `package.json` `files` array.\n\n**[README.md](./README.md)** — Installation: `npx agents-reverse-engineer@latest` (interactive) or `--runtime <rt> -g|-l` (non-interactive). Eight commands: `init` (config), `discover` (scan → GENERATION-PLAN.md), `generate` (two-phase pipeline), `update` (incremental regeneration), `specify` (AGENTS.md → specs/SPEC.md with `--multi-file` or `--dry-run`), `clean` (artifact deletion), `rebuild` (AI-driven reconstruction from specs with delimiter format `===FILE: path===` / `===END_FILE===`), `install`/`uninstall` (slash commands + session hooks). Artifact formats: `.sum` (YAML frontmatter + markdown sections), `AGENTS.md` (directory aggregates), `CLAUDE.md`/`GEMINI.md`/`OPENCODE.md` (runtime pointers). Config schema: `.agents-reverse-engineer/config.yaml` with exclude patterns, AI backend, concurrency, telemetry retention. Runtime support: Claude Code (full), Gemini CLI (full), OpenCode (AGENTS.md only).\n\n### Configuration\n\n**[package.json](./package.json)** — npm manifest v0.8.3: binaries `agents-reverse-engineer`/`are` → `dist/cli/index.js`. Dual exports: `./` (CLI), `./core` (@beta library API). Scripts: `build` (tsc), `build:hooks` (node scripts/build-hooks.js), `prepack` (rm -f LICENSE.sum README.md.sum), `prepublishOnly` (build + build:hooks), `dev` (tsx watch). Dependencies: fast-glob@3.3.3, ignore@7.0.3, isbinaryfile@5.0.4, jsonc-parser@3.3.1, ora@8.1.1, picocolors@1.1.1, simple-git@3.27.0, yaml@2.7.0, zod@3.24.1. Node.js >=18.0.0. Distribution: `dist/`, `hooks/dist/`, `README.md`, `LICENSE`.\n\n**[tsconfig.json](./tsconfig.json)** — TypeScript config: ES2022 target, NodeNext module/moduleResolution (ESM via package.json `\"type\": \"module\"`), `outDir: \"dist\"`, `rootDir: \"src\"`. Emits `.d.ts` declarations with sourcemaps. Strict type-checking enabled. `resolveJsonModule: true` (JSON imports), `isolatedModules: true` (ts-loader/tsx compatibility). Includes `src/**/*`, excludes `node_modules`/`dist`.\n\n## Subdirectories\n\n**[docs/](./docs/)** — RLM algorithm specification defining post-order traversal (file `.sum` → leaf-complete `AGENTS.md` → recursive parent aggregation), slash command interface, session-end hooks, brownfield research directives (GSD workflow patterns, BMAD method, SpecKit structure). Contains INPUT.md with optional reference documents (ARCHITECTURE.md, STRUCTURE.md, STACK.md, INTEGRATIONS.md, INFRASTRUCTURE.md, CONVENTIONS.md, TESTING.md, PATTERNS.md, CONCERNS.md).\n\n**[hooks/](./hooks/)** — Session lifecycle automation: `are-check-update.js` / `opencode-are-check-update.js` (SessionStart detached npm registry check → `~/.claude/cache/are-update-check.json` or `~/.config/opencode/cache/are-update-check.json`), `are-session-end.js` (SessionEnd detached `npx agents-reverse-engineer@latest update --quiet` on git change detection). Disable gates: `ARE_DISABLE_HOOK=1` env var, `hook_enabled: false` in `.agents-reverse-engineer.yaml`. Detached spawn pattern: `spawn(command, args, {stdio: 'ignore', detached: true, windowsHide: true})` + `child.unref()`. Version resolution priority: project-local `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`, global `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`, fallback `'0.0.0'`.\n\n**[scripts/](./scripts/)** — Build automation: `build-hooks.js` copies `hooks/*.js` → `hooks/dist/` via `copyFileSync()` during `npm run build:hooks` / `prepublishOnly`. Creates destination with `mkdirSync({recursive: true})`, logs copied count. Ensures session hooks bundled in published package for `src/installer/operations.ts` `installSessionHooks()`.\n\n**[src/](./src/)** — TypeScript source tree implementing CLI, configuration, discovery, generation, orchestration, AI integration, quality validation, update orchestration, rebuild pipeline, specification transformation. Entry point: `cli/index.ts`. Programmatic API: `core/index.ts` exports 60+ symbols via `'agents-reverse-engineer/core'` package.json export (@beta stability). Subsystems: `cli/` (command routing), `config/` (YAML/Zod validation), `discovery/` (four-filter chain), `generation/` (two-phase orchestration + prompt templates), `orchestration/` (iterator-based worker pool, NDJSON trace emission, serialized progress logging), `ai/` (multi-backend subprocess spawning with exponential backoff retry, telemetry, SIGTERM/SIGKILL timeout escalation), `update/` (frontmatter-based staleness detection + orphan cleanup), `quality/` (code-vs-doc/code-vs-code/phantom-paths validation), `rebuild/` (AI-driven reconstruction with checkpoint management), `specify/` (AGENTS.md → 12-section project spec), `imports/` (import/export extraction), `installer/` (interactive runtime integration), `integration/` (environment detection + command templates), `change-detection/` (git-based hash comparison).\n\n**[.github/workflows/](../.github/workflows/)** — GitHub Actions CI/CD automation.\n\n## Architecture\n\n### Two-Phase Pipeline\n\n**Phase 1 (File Analysis)**: `src/generation/orchestrator.ts` `createFileTasks()` builds `GenerationTask[]` with `buildFilePrompt()` (injects import maps, project structure, compression directives), executes via `src/orchestration/runner.ts` `runPool()` with user-configured concurrency (default: `os.availableParallelism() * 5` clamped to memory cap), spawns LLM subprocesses via `src/ai/subprocess.ts` `runSubprocess()` (SIGTERM at timeout, SIGKILL at timeout+5s), writes `.sum` files via `src/generation/writers/sum.ts` `writeSumFile()` with YAML frontmatter (`file_type`, `generated_at`, `content_hash`). Nullifies task content after prompt building to free memory.\n\n**Phase 2 (Directory Aggregation)**: `createDirectoryTasks()` constructs dependency graph (child file task IDs), sorts by `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (descending), groups by depth, executes depth-grouped sequential batches with parallel concurrency per group, `buildDirectoryPrompt()` reads child `.sum` via parallel `readSumFile()`, `src/generation/writers/agents-md.ts` `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` + injects `@AGENTS.local.md` directive, root `src/generation/writers/claude-md.ts` `writeClaudeMdPointer()` generates deterministic `CLAUDE.md` import.\n\n### Concurrency Control\n\n`src/orchestration/pool.ts` `runPool<T>()` spawns `Math.min(options.concurrency, tasks.length)` workers sharing single `tasks.entries()` iterator. Each worker pulls `[index, task]` pairs until exhausted or `aborted` flag set. Maintains full utilization during variable-duration tasks. Optional `onComplete?: (result) => void` callback enables serialized `src/orchestration/plan-tracker.ts` `PlanTracker.markDone()` updates to `GENERATION-PLAN.md` checkboxes via promise-chain pattern. Calculation: `concurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))`.\n\n### Update Strategy\n\n`src/update/orchestrator.ts` `UpdateOrchestrator.preparePlan()` reads existing `.sum` YAML frontmatter via `src/generation/writers/sum.ts` `readSumFile()`, compares stored `content_hash` against `src/change-detection/detector.ts` `computeContentHash()` (SHA-256 hex digest), populates `filesToAnalyze` on mismatch, executes phase-1-files pipeline for changed files, invokes `getAffectedDirectories()` collecting parent directories sorted by depth descending, sequentially regenerates `AGENTS.md` consuming updated child `.sum`. `cleanupOrphans()` deletes `.sum`/`.annex.sum` for git-deleted files, removes AGENTS.md when no source files remain.\n\n### Telemetry Pipeline\n\n`src/ai/service.ts` `AIService` wraps `runSubprocess()` in `src/ai/retry.ts` `withRetry()` (exponential backoff: `min(1000 * 2^attempt, 8000) + random(500)` for RATE_LIMIT errors only, timeouts NOT retried), records `src/ai/telemetry/run-log.ts` `TelemetryEntry` (prompt/response/tokens/cache/latency/exitCode/retryCount/thinking/filesRead), optional `src/orchestration/trace.ts` `TraceWriter` emits NDJSON events (`subprocess:spawn`, `subprocess:exit`, `retry`, `worker:start`, `task:done`, `phase:start`) to `.agents-reverse-engineer/traces/trace-{ISO8601}.ndjson` when `--trace` flag set. `aiService.finalize(projectRoot)` writes `RunLog` to `.agents-reverse-engineer/logs/run-{timestamp}.json`, calls `src/ai/telemetry/cleanup.ts` `cleanupOldLogs()` enforcing `config.ai.telemetry.keepRuns` retention.\n\n### Quality Gates\n\n`src/orchestration/runner.ts` `CommandRunner.run()` executes five phases: **pre-phase-1-cache** (reads existing `.sum` for baseline via `runPool()` concurrency 20), **phase-1-files** (parallel AI calls), **post-phase-1-quality** (throttled directory group checks: `src/quality/inconsistency/code-vs-doc.ts` `checkCodeVsDoc()` detects undocumented exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, `src/quality/inconsistency/code-vs-code.ts` `checkCodeVsCode()` finds duplicate symbols, concurrency 10 per group), **phase-2-dirs** (post-order aggregation), **post-phase-2** (`src/quality/phantom-paths/validator.ts` `checkPhantomPaths()` validates markdown links via `/\\[(?:[^\\]]*)\\]\\((\\.[^)]+)\\)/g` + backtick paths + prose references with dual-resolution strategy + `.js`→`.ts` substitution). Aggregates findings via `src/quality/inconsistency/reporter.ts` `buildInconsistencyReport()`, emits severity-tagged CLI output via `formatReportForCli()`.\n\n### Rebuild Workflow\n\n`src/rebuild/spec-reader.ts` `readSpecFiles()` discovers `specs/*.md` → `partitionSpec()` extracts Build Plan phases via `/^### Phase (\\d+):\\s*(.+)$/gm` → `src/rebuild/checkpoint.ts` `CheckpointManager.load()` validates `.rebuild-checkpoint` JSON with spec drift detection (SHA-256 hash comparison) → `src/rebuild/orchestrator.ts` `executeRebuild()` groups `RebuildUnit[]` by `order` → sequential groups with concurrent `runPool()` per group → `src/rebuild/prompts.ts` `buildRebuildPrompt()` (injects Architecture + targeted subsections, accumulates `builtContext` truncated at 100KB) → `AIService.call()` → `src/rebuild/output-parser.ts` `parseModuleOutput()` (delimiter format: `===FILE: path===` / `===END_FILE===` with column-0 requirement, fallback to fenced-block parser) → writes files → `CheckpointManager.markDone()` serialized updates.\n\n## Behavioral Contracts\n\n### Exit Codes\n- **0**: All tasks succeeded or no tasks to process\n- **1**: Partial failure (some tasks failed but some succeeded)\n- **2**: Total failure (all tasks failed or CLI not found)\n\n### Concurrency Calculation\n```javascript\nconcurrency = min(20, floor(totalMemGB * 0.5 / 0.512), max(2, os.availableParallelism() * 5))\n// Constants: SUBPROCESS_HEAP_GB=0.512, MEMORY_FRACTION=0.5, MULTIPLIER=5, MIN=2, MAX=20\n```\n\n### Exponential Backoff\n```javascript\ndelay = min(1000 * 2^attempt, 8000) + Math.random() * 500\n// Defaults: baseDelayMs=1000, multiplier=2, maxDelayMs=8000, jitter=[0,500ms]\n```\n\n### Retry Policy\n```javascript\nisRetryable: err => err.code === 'RATE_LIMIT'\n// Timeouts NOT retried (subprocess overhead on struggling systems)\n```\n\n### Rate Limit Detection\n```javascript\n['rate limit', '429', 'too many requests', 'overloaded'].some(pattern => stderr.toLowerCase().includes(pattern))\n```\n\n### Timeout Escalation\n- SIGTERM at `options.timeoutMs` via `execFile()` timeout option\n- SIGKILL at `options.timeoutMs + 5000ms` via `setTimeout(() => process.kill(-childPid, 'SIGKILL'), ...)` (process group)\n\n### Post-Order Sort\n```javascript\ngetDirectoryDepth(dirB) - getDirectoryDepth(dirA)  // Descending depth\n// getDirectoryDepth(dir) = dir === '.' ? 0 : dir.split(path.sep).length\n```\n\n### Import Extraction\n```regex\n/^[ \\t]*import\\s+(type\\s+)?(?:\\{([^}]*)\\}|(\\*\\s+as\\s+\\w+)|(\\w+))\\s+from\\s+['\"]([^'\"]+)['\"]/gm\n```\nCaptures: group 1 (type keyword), group 2 (named symbols), group 3 (namespace import), group 4 (default import), group 5 (module specifier).\n\n### Export Extraction\n```regex\n/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm\n```\nCaptures identifier in group 1 after export keyword and declaration type.\n\n### Hook Disable Mechanisms\n```javascript\nprocess.env.ARE_DISABLE_HOOK === '1'\n// OR\nreadFileSync('.agents-reverse-engineer.yaml').includes('hook_enabled: false')\n```\n\n### Version Resolution Priority\n1. Project-local: `.claude/ARE-VERSION` or `.opencode/ARE-VERSION`\n2. Global: `~/.claude/ARE-VERSION` or `~/.config/opencode/ARE-VERSION`\n3. Fallback: `'0.0.0'` (discovery), `'unknown'` (version.ts)\n\n### Update Check Cache Schema\n```json\n{\n  \"update_available\": false,\n  \"installed\": \"0.8.0\",\n  \"latest\": \"0.8.0\",\n  \"checked\": 1738416000\n}\n```\n\n### Git Change Detection\n```javascript\nexecSync('git status --porcelain', { encoding: 'utf-8' })\n// Exit if status.trim() === '' (no changes) or command throws (not a git repo)\n```\n\n### Generated File Marker\n```javascript\nGENERATED_MARKER = '<!-- Generated by agents-reverse-engineer -->'\n```\n\n### Compression Injection\n```javascript\n// Condition: compressionRatio < 0.5 && sourceFileSize > 0\ntargetSize = Math.round(sourceFileSize * compressionRatio)\nmaxSize = Math.round(targetSize * 1.2)\ncompressionPercentage = Math.round(compressionRatio * 100)\n```\n\n## Stack\n\n- **Runtime**: Node.js >=18.0.0, ES modules (`\"type\": \"module\"`)\n- **Language**: TypeScript 5.7.3 targeting ES2022 with NodeNext module resolution\n- **Concurrency**: Iterator-based worker pool, shared iterator, N workers (src/orchestration/pool.ts)\n- **File Discovery**: fast-glob@3.3.3 with ignore@7.0.3 (gitignore filtering)\n- **Git Operations**: simple-git@3.27.0 for change detection (src/change-detection/detector.ts)\n- **Config Parsing**: yaml@2.7.0 + zod@3.24.1 schema validation (src/config/schema.ts)\n- **JSON Editing**: jsonc-parser@3.3.1 for settings.json hook registration (src/installer/operations.ts)\n- **Binary Detection**: isbinaryfile@5.0.4 for `.sum` exclusion (src/discovery/filters/binary.ts)\n- **Terminal UI**: ora@8.1.1 (spinners), picocolors@1.1.1 (colored output)\n- **AI Backends**: subprocess spawning (src/ai/subprocess.ts) targeting `claude`, `gemini`, `opencode` CLIs\n- **Build**: tsc (TypeScript compiler), tsx@4.19.2 (dev watch mode)",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 5069,
      "cacheReadTokens": 0,
      "cacheCreationTokens": 39800,
      "latencyMs": 87326,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": []
    }
  ],
  "summary": {
    "totalCalls": 8,
    "totalInputTokens": 24,
    "totalOutputTokens": 25713,
    "totalCacheReadTokens": 15986,
    "totalCacheCreationTokens": 245187,
    "totalDurationMs": 508955,
    "errorCount": 0,
    "totalFilesRead": 4,
    "uniqueFilesRead": 4
  }
}