{
  "runId": "2026-02-09T15:50:44.352Z",
  "startTime": "2026-02-09T15:50:44.352Z",
  "endTime": "2026-02-09T15:55:46.523Z",
  "entries": [
    {
      "timestamp": "2026-02-09T15:50:44.376Z",
      "prompt": "Analyze this source file and generate a summary that captures what an AI coding assistant needs to know to work with this file effectively.\n\nFile: src/generation/prompts/types.ts\n\n```typescript\n/**\n * Context provided when building a prompt.\n */\nexport interface PromptContext {\n  /** Absolute path to the file */\n  filePath: string;\n  /** File content to analyze */\n  content: string;\n  /** Related files for additional context */\n  contextFiles?: Array<{\n    path: string;\n    content: string;\n  }>;\n  /** Project structure listing for bird's-eye context */\n  projectPlan?: string;\n  /** Existing .sum summary text for incremental updates */\n  existingSum?: string;\n}\n\n/**\n * Guidelines for summary generation (from CONTEXT.md).\n */\nexport const SUMMARY_GUIDELINES = {\n  /** Target word count range */\n  targetLength: { min: 300, max: 500 },\n  /** What to include */\n  include: [\n    'Purpose and responsibility',\n    'Public interface (exports, key functions)',\n    'Key patterns and notable algorithms',\n    'Dependencies with usage context',\n    'Key function signatures as code snippets',\n    'Tightly coupled sibling files',\n    'Behavioral contracts: verbatim regex patterns, format strings, magic constants, sentinel values, output templates, environment variables',\n  ],\n  /** What to exclude */\n  exclude: [\n    'Control flow minutiae (loop structures, variable naming, temporary state)',\n    'Generic TODOs/FIXMEs (keep only security/breaking)',\n    'Broad architectural relationships (handled by AGENTS.md)',\n  ],\n} as const;\n\n```\n\n\n## Project Structure\n\nFull project file listing for context:\n\n<project-structure>\n# Documentation Generation Plan\n\nGenerated: 2026-02-09\nProject: /home/pascal/wks/agents-reverse-engineer\n\n## Summary\n\n- **Total Tasks**: 126\n- **File Tasks**: 96\n- **Directory Tasks**: 29\n- **Root Tasks**: 1\n- **Traversal**: Post-order (children before parents)\n\n---\n\n## Phase 1: File Analysis (Post-Order Traversal)\n\n### Depth 3: src/ai/backends/ (3 files)\n- [x] `src/ai/backends/claude.ts`\n- [x] `src/ai/backends/gemini.ts`\n- [x] `src/ai/backends/opencode.ts`\n\n### Depth 3: src/ai/telemetry/ (3 files)\n- [x] `src/ai/telemetry/cleanup.ts`\n- [x] `src/ai/telemetry/logger.ts`\n- [x] `src/ai/telemetry/run-log.ts`\n\n### Depth 3: src/discovery/filters/ (5 files)\n- [x] `src/discovery/filters/binary.ts`\n- [x] `src/discovery/filters/custom.ts`\n- [x] `src/discovery/filters/gitignore.ts`\n- [x] `src/discovery/filters/index.ts`\n- [x] `src/discovery/filters/vendor.ts`\n\n### Depth 3: src/generation/prompts/ (4 files)\n- [x] `src/generation/prompts/builder.ts`\n- [x] `src/generation/prompts/index.ts`\n- [x] `src/generation/prompts/templates.ts`\n- [x] `src/generation/prompts/types.ts`\n\n### Depth 3: src/generation/writers/ (3 files)\n- [x] `src/generation/writers/agents-md.ts`\n- [x] `src/generation/writers/index.ts`\n- [x] `src/generation/writers/sum.ts`\n\n### Depth 3: src/quality/density/ (1 files)\n- [x] `src/quality/density/validator.ts`\n\n### Depth 3: src/quality/inconsistency/ (3 files)\n- [x] `src/quality/inconsistency/code-vs-code.ts`\n- [x] `src/quality/inconsistency/code-vs-doc.ts`\n- [x] `src/quality/inconsistency/reporter.ts`\n\n### Depth 3: src/quality/phantom-paths/ (2 files)\n- [x] `src/quality/phantom-paths/index.ts`\n- [x] `src/quality/phantom-paths/validator.ts`\n\n### Depth 2: .github/workflows/ (1 files)\n- [x] `.github/workflows/publish.yml`\n\n### Depth 2: src/ai/ (6 files)\n- [x] `src/ai/index.ts`\n- [x] `src/ai/registry.ts`\n- [x] `src/ai/retry.ts`\n- [x] `src/ai/service.ts`\n- [x] `src/ai/subprocess.ts`\n- [x] `src/ai/types.ts`\n\n### Depth 2: src/change-detection/ (3 files)\n- [x] `src/change-detection/detector.ts`\n- [x] `src/change-detection/index.ts`\n- [x] `src/change-detection/types.ts`\n\n### Depth 2: src/cli/ (7 files)\n- [x] `src/cli/clean.ts`\n- [x] `src/cli/discover.ts`\n- [x] `src/cli/generate.ts`\n- [x] `src/cli/index.ts`\n- [x] `src/cli/init.ts`\n- [x] `src/cli/specify.ts`\n- [x] `src/cli/update.ts`\n\n### Depth 2: src/config/ (3 files)\n- [x] `src/config/defaults.ts`\n- [x] `src/config/loader.ts`\n- [x] `src/config/schema.ts`\n\n### Depth 2: src/discovery/ (3 files)\n- [x] `src/discovery/run.ts`\n- [x] `src/discovery/types.ts`\n- [x] `src/discovery/walker.ts`\n\n### Depth 2: src/generation/ (5 files)\n- [x] `src/generation/collector.ts`\n- [x] `src/generation/complexity.ts`\n- [x] `src/generation/executor.ts`\n- [x] `src/generation/orchestrator.ts`\n- [x] `src/generation/types.ts`\n\n### Depth 2: src/imports/ (3 files)\n- [x] `src/imports/extractor.ts`\n- [x] `src/imports/index.ts`\n- [x] `src/imports/types.ts`\n\n### Depth 2: src/installer/ (7 files)\n- [x] `src/installer/banner.ts`\n- [x] `src/installer/index.ts`\n- [x] `src/installer/operations.ts`\n- [x] `src/installer/paths.ts`\n- [x] `src/installer/prompts.ts`\n- [x] `src/installer/types.ts`\n- [x] `src/installer/uninstall.ts`\n\n### Depth 2: src/integration/ (4 files)\n- [x] `src/integration/detect.ts`\n- [x] `src/integration/generate.ts`\n- [x] `src/integration/templates.ts`\n- [x] `src/integration/types.ts`\n\n### Depth 2: src/orchestration/ (7 files)\n- [x] `src/orchestration/index.ts`\n- [x] `src/orchestration/plan-tracker.ts`\n- [x] `src/orchestration/pool.ts`\n- [x] `src/orchestration/progress.ts`\n- [x] `src/orchestration/runner.ts`\n- [x] `src/orchestration/trace.ts`\n- [x] `src/orchestration/types.ts`\n\n### Depth 2: src/output/ (1 files)\n- [x] `src/output/logger.ts`\n\n### Depth 2: src/quality/ (2 files)\n- [x] `src/quality/index.ts`\n- [x] `src/quality/types.ts`\n\n### Depth 2: src/specify/ (3 files)\n- [x] `src/specify/index.ts`\n- [x] `src/specify/prompts.ts`\n- [x] `src/specify/writer.ts`\n\n### Depth 2: src/types/ (1 files)\n- [x] `src/types/index.ts`\n\n### Depth 2: src/update/ (4 files)\n- [x] `src/update/index.ts`\n- [x] `src/update/orchestrator.ts`\n- [x] `src/update/orphan-cleaner.ts`\n- [x] `src/update/types.ts`\n\n### Depth 1: docs/ (1 files)\n- [x] `docs/INPUT.md`\n\n### Depth 1: hooks/ (4 files)\n- [x] `hooks/are-check-update.js`\n- [x] `hooks/are-session-end.js`\n- [x] `hooks/opencode-are-check-update.js`\n- [x] `hooks/opencode-are-session-end.js`\n\n### Depth 1: scripts/ (1 files)\n- [x] `scripts/build-hooks.js`\n\n### Depth 1: src/ (1 files)\n- [x] `src/version.ts`\n\n### Depth 0: ./ (5 files)\n- [x] `LANGUAGES-MANIFEST.md`\n- [x] `LICENSE`\n- [x] `README.md`\n- [x] `package.json`\n- [x] `tsconfig.json`\n\n---\n\n## Phase 2: Directory AGENTS.md (Post-Order Traversal, 29 directories)\n\n### Depth 3\n- [x] `src/ai/backends/AGENTS.md`\n- [x] `src/ai/telemetry/AGENTS.md`\n- [x] `src/discovery/filters/AGENTS.md`\n- [x] `src/generation/prompts/AGENTS.md`\n- [x] `src/generation/writers/AGENTS.md`\n- [x] `src/quality/density/AGENTS.md`\n- [x] `src/quality/inconsistency/AGENTS.md`\n- [x] `src/quality/phantom-paths/AGENTS.md`\n\n### Depth 2\n- [x] `.github/workflows/AGENTS.md`\n- [x] `src/ai/AGENTS.md`\n- [x] `src/change-detection/AGENTS.md`\n- [x] `src/cli/AGENTS.md`\n- [x] `src/config/AGENTS.md`\n- [x] `src/discovery/AGENTS.md`\n- [x] `src/generation/AGENTS.md`\n- [x] `src/imports/AGENTS.md`\n- [x] `src/installer/AGENTS.md`\n- [x] `src/integration/AGENTS.md`\n- [x] `src/orchestration/AGENTS.md`\n- [x] `src/output/AGENTS.md`\n- [x] `src/quality/AGENTS.md`\n- [x] `src/specify/AGENTS.md`\n- [x] `src/types/AGENTS.md`\n- [x] `src/update/AGENTS.md`\n\n### Depth 1\n- [x] `docs/AGENTS.md`\n- [x] `hooks/AGENTS.md`\n- [x] `scripts/AGENTS.md`\n- [x] `src/AGENTS.md`\n\n### Depth 0\n- [x] `./AGENTS.md` (root)\n\n---\n\n## Phase 3: Root Documents\n\n- [x] `CLAUDE.md`\n\n</project-structure>\nLead with a single bold purpose statement: **[FileName] does X.**\nThen use ## headings to organize the remaining content.\nEvery file MUST include at minimum:\n- A purpose statement (first line, bold)\n- Exported symbols with signatures (under any appropriate heading)\nChoose additional sections based on file content.\n\n## Existing Summary (update this — preserve stable content, modify only what changed)\n\n**types.ts defines TypeScript interfaces and constants for prompt construction in the three-phase documentation generation pipeline.**\n\n## Exported Types\n\n**PromptContext** interface structures the data bundle passed to prompt builders across all three generation phases:\n- `filePath: string` — absolute path to target file for Phase 1 analysis or directory for Phase 2 aggregation\n- `content: string` — file content (Phase 1) or aggregated child `.sum` content (Phase 2)\n- `contextFiles?: Array<{ path: string; content: string }>` — optional sibling files for import relationship context\n- `projectPlan?: string` — optional GENERATION-PLAN.md content providing bird's-eye view of codebase structure\n- `existingSum?: string` — previous `.sum` content for incremental updates (enables diff-based regeneration)\n\n## Summary Guidelines\n\n**SUMMARY_GUIDELINES** constant exports frozen object with validation constraints for `.sum` file quality:\n\n```typescript\n{\n  targetLength: { min: 200, max: 300 },\n  include: [...],\n  exclude: [...]\n}\n```\n\n**`targetLength`** defines word count range (200-300) enforced by density validators in `src/quality/density/validator.ts`.\n\n**`include`** array specifies required content elements:\n- `'Purpose and responsibility'` — one-line purpose statement\n- `'Public interface (exports, key functions)'` — exported symbols extracted by code-vs-doc validator (`src/quality/inconsistency/code-vs-doc.ts`)\n- `'Key patterns and notable algorithms'` — design pattern identification (Strategy, Builder, etc.)\n- `'Dependencies with usage context'` — import statements with usage rationale\n- `'Key function signatures as code snippets'` — TypeScript/JavaScript signatures with parameter types\n- `'Tightly coupled sibling files'` — related files detected via `extractDirectoryImports()` in `src/imports/extractor.ts`\n\n**`exclude`** array defines content to omit:\n- `'Internal implementation details'` — private functions, loop mechanics, variable names\n- `'Generic TODOs/FIXMEs (keep only security/breaking)'` — filters low-priority comments\n- `'Broad architectural relationships (handled by AGENTS.md)'` — defers system-level patterns to Phase 2 directory aggregation\n\n## Integration Points\n\nConsumed by `buildFileAnalysisPrompt()` and `buildDirectoryPrompt()` in `src/generation/prompts/builder.ts` to construct AI subprocess prompts. The `PromptContext` interface threads through `executePhase1()`, `executePhase2()`, `executePhase3()` in `src/generation/executor.ts` as input to `AIService.call()`.\n\nGuidelines enforced during quality validation via `validateCodeDocConsistency()` and `validateCodeCodeConsistency()` in `src/quality/inconsistency/` modules, checking that all `include` items appear in generated summaries and no `exclude` items dominate the content.",
      "systemPrompt": "You are updating an existing file summary for an AI coding assistant. The source code has changed and the summary needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING summary and the UPDATED source code\n- Preserve the structure, section headings, and phrasing of the existing summary wherever the underlying code is unchanged\n- Only modify content that is directly affected by the code changes\n- If a section describes code that has not changed, keep it VERBATIM — do not rephrase, reorganize, or \"improve\" stable text\n- Add new sections only if the code changes introduce entirely new concepts\n- Remove sections only if the code they described has been deleted\n- Update signatures, type names, and identifiers to match the current source exactly\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this file\", \"this module\", \"provides\", \"responsible for\", \"is used to\", \"basically\", \"essentially\", \"provides functionality for\"\n- Use the pattern: \"[ExportName] does X\" not \"The ExportName function is responsible for doing X\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- All exported function/class/type/const names MUST appear in the summary exactly as written in source\n- Key parameter types and return types MUST be mentioned\n- Preserve exact casing of identifiers\n- Missing any exported identifier is a failure\n\nOUTPUT FORMAT (MANDATORY):\n- Start your response DIRECTLY with the purpose statement — a single bold line: **Purpose statement here.**\n- Do NOT include any preamble, thinking, or meta-commentary before the purpose statement\n- Do NOT say \"Here is...\", \"Now I'll...\", \"Based on my analysis...\", \"Let me create...\", \"Perfect.\"\n- Your response IS the documentation — not a message about the documentation",
      "response": "**types.ts defines TypeScript interfaces and constants for prompt construction in the three-phase documentation generation pipeline.**\n\n## Exported Types\n\n**PromptContext** interface structures the data bundle passed to prompt builders across all three generation phases:\n- `filePath: string` — absolute path to target file for Phase 1 analysis or directory for Phase 2 aggregation\n- `content: string` — file content (Phase 1) or aggregated child `.sum` content (Phase 2)\n- `contextFiles?: Array<{ path: string; content: string }>` — optional sibling files for import relationship context\n- `projectPlan?: string` — optional GENERATION-PLAN.md content providing bird's-eye view of codebase structure\n- `existingSum?: string` — previous `.sum` content for incremental updates (enables diff-based regeneration)\n\n## Summary Guidelines\n\n**SUMMARY_GUIDELINES** constant exports frozen object with validation constraints for `.sum` file quality:\n\n```typescript\n{\n  targetLength: { min: 300, max: 500 },\n  include: [\n    'Purpose and responsibility',\n    'Public interface (exports, key functions)',\n    'Key patterns and notable algorithms',\n    'Dependencies with usage context',\n    'Key function signatures as code snippets',\n    'Tightly coupled sibling files',\n    'Behavioral contracts: verbatim regex patterns, format strings, magic constants, sentinel values, output templates, environment variables',\n  ],\n  exclude: [\n    'Control flow minutiae (loop structures, variable naming, temporary state)',\n    'Generic TODOs/FIXMEs (keep only security/breaking)',\n    'Broad architectural relationships (handled by AGENTS.md)',\n  ],\n}\n```\n\n**`targetLength`** defines word count range (300-500) enforced by density validators in `src/quality/density/validator.ts`.\n\n**`include`** array specifies required content elements:\n- `'Purpose and responsibility'` — one-line purpose statement\n- `'Public interface (exports, key functions)'` — exported symbols extracted by code-vs-doc validator (`src/quality/inconsistency/code-vs-doc.ts`)\n- `'Key patterns and notable algorithms'` — design pattern identification (Strategy, Builder, etc.)\n- `'Dependencies with usage context'` — import statements with usage rationale\n- `'Key function signatures as code snippets'` — TypeScript/JavaScript signatures with parameter types\n- `'Tightly coupled sibling files'` — related files detected via `extractDirectoryImports()` in `src/imports/extractor.ts`\n- `'Behavioral contracts: verbatim regex patterns, format strings, magic constants, sentinel values, output templates, environment variables'` — concrete values required for correct integration (e.g., `NODE_OPTIONS='--max-old-space-size=512'`, `/^[ \\t]*export\\s+/gm`, `<!-- Generated by agents-reverse-engineer -->`)\n\n**`exclude`** array defines content to omit:\n- `'Control flow minutiae (loop structures, variable naming, temporary state)'` — private implementation details\n- `'Generic TODOs/FIXMEs (keep only security/breaking)'` — filters low-priority comments\n- `'Broad architectural relationships (handled by AGENTS.md)'` — defers system-level patterns to Phase 2 directory aggregation\n\n## Integration Points\n\nConsumed by `buildFileAnalysisPrompt()` and `buildDirectoryPrompt()` in `src/generation/prompts/builder.ts` to construct AI subprocess prompts. The `PromptContext` interface threads through `executePhase1()`, `executePhase2()`, `executePhase3()` in `src/generation/executor.ts` as input to `AIService.call()`.\n\nGuidelines enforced during quality validation via `validateCodeDocConsistency()` and `validateCodeCodeConsistency()` in `src/quality/inconsistency/` modules, checking that all `include` items appear in generated summaries and no `exclude` items dominate the content.",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 940,
      "cacheReadTokens": 0,
      "cacheCreationTokens": 28807,
      "latencyMs": 16735,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": [
        {
          "path": "src/generation/prompts/types.ts",
          "sizeBytes": 1345
        }
      ]
    },
    {
      "timestamp": "2026-02-09T15:50:44.372Z",
      "prompt": "Analyze this source file and generate a summary that captures what an AI coding assistant needs to know to work with this file effectively.\n\nFile: src/specify/prompts.ts\n\n```typescript\nimport type { AgentsDocs } from '../generation/collector.js';\n\n/**\n * Prompt pair for spec generation: system instructions and user content.\n */\nexport interface SpecPrompt {\n  system: string;\n  user: string;\n}\n\n/**\n * System prompt for AI-driven specification synthesis.\n *\n * Enforces conceptual grouping by concern, prohibits folder-mirroring\n * and exact file path prescription, and targets AI agent consumption.\n */\nexport const SPEC_SYSTEM_PROMPT = `You produce software specifications from documentation.\n\nTASK:\nGenerate a comprehensive specification document from the provided AGENTS.md content. The specification must contain enough detail for an AI agent to reconstruct the entire project from scratch without seeing the original source code.\n\nAUDIENCE: AI agents (LLMs) — use structured, precise, instruction-oriented language. Every statement should be actionable.\n\nORGANIZATION (MANDATORY):\nGroup content by CONCERN, not by directory structure. Use these conceptual sections in order:\n\n1. Project Overview — purpose, core value proposition, problem solved, technology stack with versions\n2. Architecture — system design, module boundaries, data flow patterns, key design decisions and their rationale\n3. Public API Surface — all exported interfaces, function signatures with full parameter and return types, type definitions, error contracts\n4. Data Structures & State — key types, schemas, config objects, state management patterns, serialization formats\n5. Configuration — all config options with types, defaults, validation rules, environment variables\n6. Dependencies — each external dependency with exact version and rationale for inclusion\n7. Behavioral Contracts — Split into two subsections:\n   a. Runtime Behavior: error handling strategies (exact error types/codes and when thrown), retry logic (formulas, delay values), concurrency model, lifecycle hooks, resource management\n   b. Implementation Contracts: every regex pattern used for parsing/validation/extraction (verbatim in backticks), every format string and output template (exact structure with examples), every magic constant and sentinel value with its meaning, every environment variable with expected values, every file format specification (YAML schemas, NDJSON structures). These are reproduction-critical — an AI agent needs them to rebuild the system with identical observable behavior.\n8. Test Contracts — what each module's tests should verify: scenarios, edge cases, expected behaviors, error conditions\n9. Build Plan — phased implementation sequence: what to build first and why, dependency order between modules, incremental milestones\n\nRULES:\n- Describe MODULE BOUNDARIES and their interfaces — not file paths or directory layouts\n- Use exact function, type, and constant names as they appear in the documentation\n- Include FULL type signatures for all public APIs (parameters, return types, generics)\n- Do NOT prescribe exact filenames or file paths — describe what each module does and exports\n- Do NOT mirror the project's folder structure in your section organization\n- Do NOT use directory names as section headings\n- Include version numbers for ALL external dependencies\n- The Build Plan MUST list implementation phases with explicit dependency ordering\n- Each Build Plan phase must state what it depends on and what it enables\n- Behavioral Contracts must specify exact error types/codes and when they are thrown\n- Behavioral Contracts MUST include verbatim regex patterns, format strings, and magic constants from the source documents — do NOT paraphrase regex patterns into prose descriptions\n- When multiple modules reference the same constant or pattern, consolidate into a single definition with cross-references to the modules that use it\n\nOUTPUT: Raw markdown. No preamble. No meta-commentary. No \"Here is...\" or \"I've generated...\" prefix.`;\n\n/**\n * Build the system + user prompt pair for spec generation.\n *\n * Injects all collected AGENTS.md content with section delimiters.\n *\n * @param docs - Collected AGENTS.md documents from collectAgentsDocs()\n * @returns SpecPrompt with system and user prompt strings\n */\nexport function buildSpecPrompt(docs: AgentsDocs): SpecPrompt {\n  const agentsSections = docs.map(\n    (doc) => `### ${doc.relativePath}\\n\\n${doc.content}`,\n  );\n\n  const userSections: string[] = [\n    'Generate a comprehensive project specification from the following documentation.',\n    '',\n    `## AGENTS.md Files (${docs.length} directories)`,\n    '',\n    ...agentsSections,\n  ];\n\n  userSections.push(\n    '',\n    '## Output Requirements',\n    '',\n    'The specification MUST include these sections in order:',\n    '1. Project Overview (purpose, value, tech stack)',\n    '2. Architecture (module boundaries, data flow, design decisions)',\n    '3. Public API Surface (all exported interfaces, full type signatures)',\n    '4. Data Structures & State (types, schemas, config objects)',\n    '5. Configuration (options, types, defaults, validation)',\n    '6. Dependencies (each with version and rationale)',\n    '7. Behavioral Contracts (error handling, concurrency, lifecycle, PLUS verbatim regex patterns, format specs, magic constants, templates)',\n    '8. Test Contracts (per-module test scenarios and edge cases)',\n    '9. Build Plan (phased implementation order with dependencies)',\n    '',\n    'Output ONLY the markdown content. No preamble.',\n  );\n\n  return {\n    system: SPEC_SYSTEM_PROMPT,\n    user: userSections.join('\\n'),\n  };\n}\n\n```\n\n\n## Project Structure\n\nFull project file listing for context:\n\n<project-structure>\n# Documentation Generation Plan\n\nGenerated: 2026-02-09\nProject: /home/pascal/wks/agents-reverse-engineer\n\n## Summary\n\n- **Total Tasks**: 126\n- **File Tasks**: 96\n- **Directory Tasks**: 29\n- **Root Tasks**: 1\n- **Traversal**: Post-order (children before parents)\n\n---\n\n## Phase 1: File Analysis (Post-Order Traversal)\n\n### Depth 3: src/ai/backends/ (3 files)\n- [x] `src/ai/backends/claude.ts`\n- [x] `src/ai/backends/gemini.ts`\n- [x] `src/ai/backends/opencode.ts`\n\n### Depth 3: src/ai/telemetry/ (3 files)\n- [x] `src/ai/telemetry/cleanup.ts`\n- [x] `src/ai/telemetry/logger.ts`\n- [x] `src/ai/telemetry/run-log.ts`\n\n### Depth 3: src/discovery/filters/ (5 files)\n- [x] `src/discovery/filters/binary.ts`\n- [x] `src/discovery/filters/custom.ts`\n- [x] `src/discovery/filters/gitignore.ts`\n- [x] `src/discovery/filters/index.ts`\n- [x] `src/discovery/filters/vendor.ts`\n\n### Depth 3: src/generation/prompts/ (4 files)\n- [x] `src/generation/prompts/builder.ts`\n- [x] `src/generation/prompts/index.ts`\n- [x] `src/generation/prompts/templates.ts`\n- [x] `src/generation/prompts/types.ts`\n\n### Depth 3: src/generation/writers/ (3 files)\n- [x] `src/generation/writers/agents-md.ts`\n- [x] `src/generation/writers/index.ts`\n- [x] `src/generation/writers/sum.ts`\n\n### Depth 3: src/quality/density/ (1 files)\n- [x] `src/quality/density/validator.ts`\n\n### Depth 3: src/quality/inconsistency/ (3 files)\n- [x] `src/quality/inconsistency/code-vs-code.ts`\n- [x] `src/quality/inconsistency/code-vs-doc.ts`\n- [x] `src/quality/inconsistency/reporter.ts`\n\n### Depth 3: src/quality/phantom-paths/ (2 files)\n- [x] `src/quality/phantom-paths/index.ts`\n- [x] `src/quality/phantom-paths/validator.ts`\n\n### Depth 2: .github/workflows/ (1 files)\n- [x] `.github/workflows/publish.yml`\n\n### Depth 2: src/ai/ (6 files)\n- [x] `src/ai/index.ts`\n- [x] `src/ai/registry.ts`\n- [x] `src/ai/retry.ts`\n- [x] `src/ai/service.ts`\n- [x] `src/ai/subprocess.ts`\n- [x] `src/ai/types.ts`\n\n### Depth 2: src/change-detection/ (3 files)\n- [x] `src/change-detection/detector.ts`\n- [x] `src/change-detection/index.ts`\n- [x] `src/change-detection/types.ts`\n\n### Depth 2: src/cli/ (7 files)\n- [x] `src/cli/clean.ts`\n- [x] `src/cli/discover.ts`\n- [x] `src/cli/generate.ts`\n- [x] `src/cli/index.ts`\n- [x] `src/cli/init.ts`\n- [x] `src/cli/specify.ts`\n- [x] `src/cli/update.ts`\n\n### Depth 2: src/config/ (3 files)\n- [x] `src/config/defaults.ts`\n- [x] `src/config/loader.ts`\n- [x] `src/config/schema.ts`\n\n### Depth 2: src/discovery/ (3 files)\n- [x] `src/discovery/run.ts`\n- [x] `src/discovery/types.ts`\n- [x] `src/discovery/walker.ts`\n\n### Depth 2: src/generation/ (5 files)\n- [x] `src/generation/collector.ts`\n- [x] `src/generation/complexity.ts`\n- [x] `src/generation/executor.ts`\n- [x] `src/generation/orchestrator.ts`\n- [x] `src/generation/types.ts`\n\n### Depth 2: src/imports/ (3 files)\n- [x] `src/imports/extractor.ts`\n- [x] `src/imports/index.ts`\n- [x] `src/imports/types.ts`\n\n### Depth 2: src/installer/ (7 files)\n- [x] `src/installer/banner.ts`\n- [x] `src/installer/index.ts`\n- [x] `src/installer/operations.ts`\n- [x] `src/installer/paths.ts`\n- [x] `src/installer/prompts.ts`\n- [x] `src/installer/types.ts`\n- [x] `src/installer/uninstall.ts`\n\n### Depth 2: src/integration/ (4 files)\n- [x] `src/integration/detect.ts`\n- [x] `src/integration/generate.ts`\n- [x] `src/integration/templates.ts`\n- [x] `src/integration/types.ts`\n\n### Depth 2: src/orchestration/ (7 files)\n- [x] `src/orchestration/index.ts`\n- [x] `src/orchestration/plan-tracker.ts`\n- [x] `src/orchestration/pool.ts`\n- [x] `src/orchestration/progress.ts`\n- [x] `src/orchestration/runner.ts`\n- [x] `src/orchestration/trace.ts`\n- [x] `src/orchestration/types.ts`\n\n### Depth 2: src/output/ (1 files)\n- [x] `src/output/logger.ts`\n\n### Depth 2: src/quality/ (2 files)\n- [x] `src/quality/index.ts`\n- [x] `src/quality/types.ts`\n\n### Depth 2: src/specify/ (3 files)\n- [x] `src/specify/index.ts`\n- [x] `src/specify/prompts.ts`\n- [x] `src/specify/writer.ts`\n\n### Depth 2: src/types/ (1 files)\n- [x] `src/types/index.ts`\n\n### Depth 2: src/update/ (4 files)\n- [x] `src/update/index.ts`\n- [x] `src/update/orchestrator.ts`\n- [x] `src/update/orphan-cleaner.ts`\n- [x] `src/update/types.ts`\n\n### Depth 1: docs/ (1 files)\n- [x] `docs/INPUT.md`\n\n### Depth 1: hooks/ (4 files)\n- [x] `hooks/are-check-update.js`\n- [x] `hooks/are-session-end.js`\n- [x] `hooks/opencode-are-check-update.js`\n- [x] `hooks/opencode-are-session-end.js`\n\n### Depth 1: scripts/ (1 files)\n- [x] `scripts/build-hooks.js`\n\n### Depth 1: src/ (1 files)\n- [x] `src/version.ts`\n\n### Depth 0: ./ (5 files)\n- [x] `LANGUAGES-MANIFEST.md`\n- [x] `LICENSE`\n- [x] `README.md`\n- [x] `package.json`\n- [x] `tsconfig.json`\n\n---\n\n## Phase 2: Directory AGENTS.md (Post-Order Traversal, 29 directories)\n\n### Depth 3\n- [x] `src/ai/backends/AGENTS.md`\n- [x] `src/ai/telemetry/AGENTS.md`\n- [x] `src/discovery/filters/AGENTS.md`\n- [x] `src/generation/prompts/AGENTS.md`\n- [x] `src/generation/writers/AGENTS.md`\n- [x] `src/quality/density/AGENTS.md`\n- [x] `src/quality/inconsistency/AGENTS.md`\n- [x] `src/quality/phantom-paths/AGENTS.md`\n\n### Depth 2\n- [x] `.github/workflows/AGENTS.md`\n- [x] `src/ai/AGENTS.md`\n- [x] `src/change-detection/AGENTS.md`\n- [x] `src/cli/AGENTS.md`\n- [x] `src/config/AGENTS.md`\n- [x] `src/discovery/AGENTS.md`\n- [x] `src/generation/AGENTS.md`\n- [x] `src/imports/AGENTS.md`\n- [x] `src/installer/AGENTS.md`\n- [x] `src/integration/AGENTS.md`\n- [x] `src/orchestration/AGENTS.md`\n- [x] `src/output/AGENTS.md`\n- [x] `src/quality/AGENTS.md`\n- [x] `src/specify/AGENTS.md`\n- [x] `src/types/AGENTS.md`\n- [x] `src/update/AGENTS.md`\n\n### Depth 1\n- [x] `docs/AGENTS.md`\n- [x] `hooks/AGENTS.md`\n- [x] `scripts/AGENTS.md`\n- [x] `src/AGENTS.md`\n\n### Depth 0\n- [x] `./AGENTS.md` (root)\n\n---\n\n## Phase 3: Root Documents\n\n- [x] `CLAUDE.md`\n\n</project-structure>\nLead with a single bold purpose statement: **[FileName] does X.**\nThen use ## headings to organize the remaining content.\nEvery file MUST include at minimum:\n- A purpose statement (first line, bold)\n- Exported symbols with signatures (under any appropriate heading)\nChoose additional sections based on file content.\n\n## Existing Summary (update this — preserve stable content, modify only what changed)\n\n**prompts.ts defines the AI prompt infrastructure for project specification synthesis, providing `buildSpecPrompt()` to generate system and user prompts from collected AGENTS.md files with mandatory concern-based organization rules.**\n\n## Exported Types\n\n`SpecPrompt` interface defines prompt pair structure with `system: string` and `user: string` properties for AI-driven specification generation.\n\n## Exported Constants\n\n`SPEC_SYSTEM_PROMPT` constant contains system-level instructions enforcing conceptual grouping by concern (not directory structure), prohibiting folder-mirroring and exact file path prescription, targeting AI agent consumption with nine mandatory sections:\n1. Project Overview (purpose, tech stack with versions)\n2. Architecture (module boundaries, data flow, design decisions)\n3. Public API Surface (exported interfaces, full type signatures)\n4. Data Structures & State (types, schemas, state management)\n5. Configuration (options, types, defaults, validation, env vars)\n6. Dependencies (each with exact version and rationale)\n7. Behavioral Contracts (error handling, retry logic, concurrency, lifecycle hooks)\n8. Test Contracts (per-module scenarios, edge cases, expected behaviors)\n9. Build Plan (phased implementation with dependency ordering)\n\n## Exported Functions\n\n`buildSpecPrompt(docs: AgentsDocs): SpecPrompt` constructs prompt pair by:\n- Mapping `docs` array to markdown sections via `### ${doc.relativePath}\\n\\n${doc.content}` template\n- Building `userSections` array with header `Generate a comprehensive project specification from the following documentation.`\n- Injecting `## AGENTS.md Files (${docs.length} directories)` section with all `agentsSections`\n- Appending `## Output Requirements` section reiterating nine mandatory specification sections\n- Enforcing raw markdown output constraint: `Output ONLY the markdown content. No preamble.`\n- Returning `{ system: SPEC_SYSTEM_PROMPT, user: userSections.join('\\n') }`\n\n## Dependencies\n\nImports `AgentsDocs` type from `../generation/collector.js` for typed AGENTS.md document array consumed by `buildSpecPrompt()`.\n\n## Design Constraints\n\nPrompt engineering rules enforce MODULE BOUNDARY descriptions over file path prescriptions, exact function/type/constant name preservation from documentation, FULL type signature inclusion (parameters, return types, generics), prohibition of directory name section headings, version number requirements for ALL external dependencies, explicit dependency ordering in Build Plan phases, and exact error type/code specification in Behavioral Contracts.",
      "systemPrompt": "You are updating an existing file summary for an AI coding assistant. The source code has changed and the summary needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING summary and the UPDATED source code\n- Preserve the structure, section headings, and phrasing of the existing summary wherever the underlying code is unchanged\n- Only modify content that is directly affected by the code changes\n- If a section describes code that has not changed, keep it VERBATIM — do not rephrase, reorganize, or \"improve\" stable text\n- Add new sections only if the code changes introduce entirely new concepts\n- Remove sections only if the code they described has been deleted\n- Update signatures, type names, and identifiers to match the current source exactly\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this file\", \"this module\", \"provides\", \"responsible for\", \"is used to\", \"basically\", \"essentially\", \"provides functionality for\"\n- Use the pattern: \"[ExportName] does X\" not \"The ExportName function is responsible for doing X\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- All exported function/class/type/const names MUST appear in the summary exactly as written in source\n- Key parameter types and return types MUST be mentioned\n- Preserve exact casing of identifiers\n- Missing any exported identifier is a failure\n\nOUTPUT FORMAT (MANDATORY):\n- Start your response DIRECTLY with the purpose statement — a single bold line: **Purpose statement here.**\n- Do NOT include any preamble, thinking, or meta-commentary before the purpose statement\n- Do NOT say \"Here is...\", \"Now I'll...\", \"Based on my analysis...\", \"Let me create...\", \"Perfect.\"\n- Your response IS the documentation — not a message about the documentation",
      "response": "**prompts.ts defines the AI prompt infrastructure for project specification synthesis, providing `buildSpecPrompt()` to generate system and user prompts from collected AGENTS.md files with mandatory concern-based organization rules and reproduction-critical implementation contracts.**\n\n## Exported Types\n\n`SpecPrompt` interface defines prompt pair structure with `system: string` and `user: string` properties for AI-driven specification generation.\n\n## Exported Constants\n\n`SPEC_SYSTEM_PROMPT` constant contains system-level instructions enforcing conceptual grouping by concern (not directory structure), prohibiting folder-mirroring and exact file path prescription, targeting AI agent consumption with nine mandatory sections:\n1. Project Overview (purpose, tech stack with versions)\n2. Architecture (module boundaries, data flow, design decisions)\n3. Public API Surface (exported interfaces, full type signatures)\n4. Data Structures & State (types, schemas, state management)\n5. Configuration (options, types, defaults, validation, env vars)\n6. Dependencies (each with exact version and rationale)\n7. Behavioral Contracts — Split into two subsections:\n   - Runtime Behavior: error handling strategies (exact error types/codes and when thrown), retry logic (formulas, delay values), concurrency model, lifecycle hooks, resource management\n   - Implementation Contracts: verbatim regex patterns for parsing/validation/extraction (in backticks), format strings and output templates (exact structure with examples), magic constants and sentinel values with meanings, environment variables with expected values, file format specifications (YAML schemas, NDJSON structures)\n8. Test Contracts (per-module scenarios, edge cases, expected behaviors)\n9. Build Plan (phased implementation with dependency ordering)\n\n## Exported Functions\n\n`buildSpecPrompt(docs: AgentsDocs): SpecPrompt` constructs prompt pair by:\n- Mapping `docs` array to markdown sections via `### ${doc.relativePath}\\n\\n${doc.content}` template\n- Building `userSections` array with header `Generate a comprehensive project specification from the following documentation.`\n- Injecting `## AGENTS.md Files (${docs.length} directories)` section with all `agentsSections`\n- Appending `## Output Requirements` section reiterating nine mandatory specification sections with emphasis on verbatim regex patterns, format specs, magic constants, and templates in Behavioral Contracts\n- Enforcing raw markdown output constraint: `Output ONLY the markdown content. No preamble.`\n- Returning `{ system: SPEC_SYSTEM_PROMPT, user: userSections.join('\\n') }`\n\n## Dependencies\n\nImports `AgentsDocs` type from `../generation/collector.js` for typed AGENTS.md document array consumed by `buildSpecPrompt()`.\n\n## Design Constraints\n\nPrompt engineering rules enforce MODULE BOUNDARY descriptions over file path prescriptions, exact function/type/constant name preservation from documentation, FULL type signature inclusion (parameters, return types, generics), prohibition of directory name section headings, version number requirements for ALL external dependencies, explicit dependency ordering in Build Plan phases, exact error type/code specification in Behavioral Contracts, and MANDATORY verbatim inclusion of regex patterns, format strings, magic constants, and templates (no paraphrasing into prose descriptions). When multiple modules reference the same constant or pattern, consolidation into single definition with cross-references is required.",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 758,
      "cacheReadTokens": 16334,
      "cacheCreationTokens": 13247,
      "latencyMs": 17615,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": [
        {
          "path": "src/specify/prompts.ts",
          "sizeBytes": 5497
        }
      ]
    },
    {
      "timestamp": "2026-02-09T15:50:44.360Z",
      "prompt": "Analyze this source file and generate a summary that captures what an AI coding assistant needs to know to work with this file effectively.\n\nFile: specs/SPEC.md\n\n```markdown\n# Project Specification: agents-reverse-engineer\n\n## 1. Project Overview\n\n**Purpose:** Automate brownfield codebase documentation for AI coding assistants through parallel file analysis, hierarchical aggregation, and platform-specific synthesis.\n\n**Core Value Proposition:** Solves AI assistant session amnesia by generating persistent, AI-optimized documentation corpus (`.sum` summaries, `AGENTS.md` hierarchies, root integration documents) from arbitrary codebases without manual annotation.\n\n**Problem Solved:** Eliminates repetitive codebase re-explanation across AI assistant sessions by maintaining incremental documentation synchronized with source changes via SHA-256 content hashing.\n\n**Technology Stack:**\n- **Runtime:** Node.js ≥18.0.0 (native ES modules, `import.meta.url`, top-level await)\n- **Language:** TypeScript 5.7.3 (ES2022 target, NodeNext module resolution, strict mode)\n- **Core Libraries:**\n  - `fast-glob` 3.x — file discovery with glob patterns and dotfile support\n  - `ignore` 5.x — gitignore parsing engine\n  - `isbinaryfile` 5.x — content-based binary detection\n  - `simple-git` 3.x — git diff parsing with rename detection\n  - `yaml` 2.x — YAML serialization without comments\n  - `zod` 3.x — runtime schema validation with type inference\n  - `ora` 8.x — terminal spinner UI\n  - `picocolors` 1.x — ANSI color codes without dependencies\n- **Development:** `tsx` (watch mode), `vitest` (testing), `@types/node` (type definitions)\n- **Distribution:** npm with provenance attestation via GitHub Actions OIDC\n\n## 2. Architecture\n\n### System Design: Three-Phase Recursive Language Model (RLM) Pipeline\n\n**Phase 1: Concurrent File Analysis**\n- Worker pool executes file-level analysis tasks in parallel (configurable concurrency: 2-20)\n- Each worker invokes AI CLI subprocess via `execFile()` with prompt containing source code and import context\n- Subprocess returns markdown summary parsed from JSON response\n- Results written to `.sum` files with YAML frontmatter embedding SHA-256 content hash\n\n**Phase 2: Post-Order Directory Aggregation**\n- Directories sorted by depth descending (deepest first) for bottom-up traversal\n- Aggregation waits for all child `.sum` files to exist before processing directory\n- Prompts include child summaries, manifest detection (9 package managers), import maps\n- Outputs `AGENTS.md` files preserving user content via `AGENTS.local.md` prepending\n\n**Phase 3: Sequential Root Synthesis**\n- Collects all `AGENTS.md` files via recursive traversal\n- Generates platform-specific integration documents (Claude, Gemini, OpenCode)\n- Enforces synthesis-only constraint: no invention, all claims traceable to source documents\n\n### Module Boundaries\n\n**`src/cli/`** — Command routing and argument parsing, creates orchestrators, threads trace writers and progress loggers\n**`src/ai/`** — Backend-agnostic subprocess management, retry logic, telemetry accumulation\n**`src/discovery/`** — File walking with composable filter chain (gitignore → vendor → binary → custom)\n**`src/generation/`** — Prompt construction, task dependency resolution, YAML frontmatter serialization\n**`src/orchestration/`** — Iterator-based worker pool, progress tracking, NDJSON trace emission\n**`src/update/`** — Hash-based change detection, orphan cleanup, affected directory propagation\n**`src/quality/`** — Post-generation validators for code-doc consistency, duplicate symbols, phantom paths\n**`src/config/`** — Zod schema validation, YAML parsing, resource-aware concurrency defaults\n**`src/imports/`** — Regex-based import extraction, classification into internal/external\n**`src/installer/`** — npx-driven command installation with hook registration mutating settings.json\n**`src/integration/`** — Platform detection and template generation for IDE command systems\n\n### Data Flow Patterns\n\n**Discovery → Planning → Execution:**\n```\ndiscoverFiles() → ExecutionPlan → runPool() → writeSumFile()\n                              ↓\n                     buildExecutionPlan() (dependency ordering)\n                              ↓\n                     Phase 1: fileTasks (concurrent)\n                     Phase 2: directoryTasks (post-order by depth)\n                     Phase 3: rootTasks (sequential)\n```\n\n**Incremental Update:**\n```\npreparePlan() → readSumFile(content_hash) → computeContentHash()\n            ↓\n  filesToAnalyze (hash mismatch/missing)\n  filesToSkip (hash match)\n  orphans (deleted/renamed sources)\n            ↓\n  regenerate .sum → regenerate AGENTS.md → cleanupOrphans()\n```\n\n**Subprocess Invocation:**\n```\nAIService.call() → withRetry() → runSubprocess() → execFile()\n                                              ↓\n                              stdin.write(prompt) → parse JSON response\n                                              ↓\n                          TelemetryLogger.addEntry() → TraceWriter.emit()\n```\n\n### Key Design Decisions\n\n**1. Iterator-Based Pool Over Batch Processing**\n- **Decision:** Single shared `tasks.entries()` iterator across N workers\n- **Rationale:** Prevents batch anti-pattern where workers idle waiting for slowest batch member\n- **Alternative Rejected:** Pre-partitioning tasks into N batches (inefficient slot utilization)\n\n**2. Hash-Based Change Detection Over Git Diffing**\n- **Decision:** SHA-256 content hashes embedded in `.sum` YAML frontmatter\n- **Rationale:** Stateless operation without external database, works in non-git environments\n- **Alternative Rejected:** Git diff comparison (requires versioned repository, complex merge handling)\n\n**3. Subprocess Per File Over Single Long-Running Process**\n- **Decision:** Spawn AI CLI subprocess for each file analysis\n- **Rationale:** Isolates crashes, enforces memory limits, prevents context leakage\n- **Alternative Rejected:** Persistent subprocess with JSON-RPC (complex state management, memory accumulation)\n\n**4. Promise-Chain Serialization Over Locks**\n- **Decision:** `writeQueue = writeQueue.then(() => writeFile())` pattern\n- **Rationale:** Async-friendly serialization without blocking primitives, preserves NDJSON line order\n- **Alternative Rejected:** Mutex-based locking (blocking, no async/await support in Node.js stdlib)\n\n**5. Regex-Based Import Extraction Over AST Parsing**\n- **Decision:** Single regex pattern with five capture groups\n- **Rationale:** Fast, zero-dependency, covers 95% of CommonJS/ESM patterns\n- **Alternative Rejected:** Full AST parsing (heavy dependencies, performance overhead for metadata-only use case)\n\n## 3. Public API Surface\n\n### CLI Commands\n\n**`are init`**\n```typescript\nfunction initCommand(args: ParsedArgs): Promise<void>\n// Creates .agents-reverse-engineer/config.yaml\n// Exits with code 1 on permission errors (EACCES/EPERM)\n```\n\n**`are discover`**\n```typescript\nfunction discoverCommand(args: ParsedArgs): Promise<void>\n// Writes GENERATION-PLAN.md with three-phase breakdown\n// Emits discovery:start/end trace events\n```\n\n**`are generate`**\n```typescript\nfunction generateCommand(args: ParsedArgs): Promise<void>\n// Exit codes: 0 (success), 1 (partial failure), 2 (total failure)\n// Flags: --dry-run, --concurrency N, --debug, --trace, --fail-fast\n```\n\n**`are update`**\n```typescript\nfunction updateCommand(args: ParsedArgs): Promise<void>\n// Flags: --uncommitted (include working tree changes)\n// Returns UpdateResult with analyzedFiles[], skippedFiles[], cleanup\n```\n\n**`are specify`**\n```typescript\nfunction specifyCommand(args: ParsedArgs): Promise<void>\n// Flags: --multi-file, --force, --output <path>\n// Throws SpecExistsError when target exists without --force\n```\n\n**`are clean`**\n```typescript\nfunction cleanCommand(args: ParsedArgs): Promise<void>\n// Deletes .sum, AGENTS.md (generated only), CLAUDE.md, GENERATION-PLAN.md\n// Restores AGENTS.local.md → AGENTS.md\n```\n\n### Core Types\n\n**`Config`**\n```typescript\ninterface Config {\n  exclude: {\n    patterns: string[];          // Gitignore-style globs\n    vendorDirs: string[];        // Third-party directory names\n    binaryExtensions: string[];  // File extensions without leading dot\n  };\n  options: {\n    followSymlinks: boolean;     // Default: false\n    maxFileSize: number;         // Bytes, default: 1048576 (1MB)\n  };\n  output: {\n    colors: boolean;             // ANSI color codes, default: true\n  };\n  ai: {\n    backend: 'claude' | 'gemini' | 'opencode' | 'auto';\n    model: string | null;        // Override backend default\n    timeoutMs: number;           // Subprocess timeout, min: 1\n    maxRetries: number;          // Exponential backoff attempts, min: 0\n    concurrency: number;         // Worker pool size, range: [1, 20]\n    telemetry: {\n      enabled: boolean;\n      keepRuns: number;          // Retention limit, min: 0\n      costThresholdUsd: number;  // Warning threshold\n    };\n    pricing: {\n      [backend: string]: {\n        inputCostPer1kTokens: number;\n        outputCostPer1kTokens: number;\n        cacheReadCostPer1kTokens: number;\n        cacheCreationCostPer1kTokens: number;\n      };\n    };\n  };\n}\n```\n\n**`AIBackend`**\n```typescript\ninterface AIBackend {\n  name: string;                  // 'claude' | 'gemini' | 'opencode'\n  cliCommand: string;            // Executable name for PATH resolution\n  isAvailable(): Promise<boolean>;\n  buildArgs(options: AICallOptions): string[];\n  parseResponse(stdout: string, durationMs: number, exitCode: number): AIResponse;\n  getInstallInstructions(): string;\n}\n```\n\n**`AICallOptions`**\n```typescript\ninterface AICallOptions {\n  prompt: string;\n  systemPrompt?: string;\n  model?: string;\n  timeoutMs?: number;\n  maxTurns?: number;\n  taskLabel?: string;           // For trace correlation\n}\n```\n\n**`AIResponse`**\n```typescript\ninterface AIResponse {\n  text: string;\n  model: string;\n  inputTokens: number;\n  outputTokens: number;\n  cacheReadTokens: number;\n  cacheCreationTokens: number;\n  durationMs: number;\n  exitCode: number;\n  raw: string;                  // Unparsed stdout\n}\n```\n\n**`FileChange`**\n```typescript\ntype FileChange = \n  | { status: 'added'; path: string }\n  | { status: 'modified'; path: string }\n  | { status: 'deleted'; path: string }\n  | { status: 'renamed'; path: string; oldPath: string };\n```\n\n**`ExecutionPlan`**\n```typescript\ninterface ExecutionPlan {\n  tasks: ExecutionTask[];\n  fileTasks: ExecutionTask[];\n  directoryTasks: ExecutionTask[];\n  rootTasks: ExecutionTask[];\n  directoryFileMap: Record<string, string[]>;\n}\n\ninterface ExecutionTask {\n  id: string;                   // 'file:path' | 'dir:path' | 'root:CLAUDE.md'\n  type: 'file' | 'directory' | 'root';\n  dependencies: string[];        // Task IDs\n  systemPrompt: string;\n  userPrompt: string;\n  outputPath: string;\n  metadata?: {\n    depth?: number;\n    directoryFiles?: string[];\n  };\n}\n```\n\n**`SumFileContent`**\n```typescript\ninterface SumFileContent {\n  generatedAt: string;          // ISO 8601 timestamp\n  contentHash: string;          // SHA-256 hex digest\n  purpose: string;\n  criticalTodos?: string[];\n  relatedFiles?: string[];\n  summary: string;              // Markdown content after frontmatter\n}\n```\n\n**`TraceEvent`** (discriminated union with 14 types)\n```typescript\ntype TraceEvent = \n  | { type: 'phase:start'; phase: string; taskCount: number; concurrency: number }\n  | { type: 'phase:end'; phase: string; tasksCompleted: number; tasksFailed: number; durationMs: number }\n  | { type: 'worker:start'; workerId: number }\n  | { type: 'worker:end'; workerId: number; tasksExecuted: number; durationMs: number }\n  | { type: 'task:pickup'; taskIndex: number; taskLabel: string; activeTasks: number }\n  | { type: 'task:done'; taskIndex: number; taskLabel: string; success: boolean; activeTasks: number; durationMs: number }\n  | { type: 'task:start'; taskLabel: string; phase: string }\n  | { type: 'subprocess:spawn'; childPid: number; command: string; args: string[] }\n  | { type: 'subprocess:exit'; childPid: number; exitCode: number; signal: string | null; timedOut: boolean; durationMs: number }\n  | { type: 'retry'; attempt: number; taskLabel: string; errorCode: string; delayMs: number }\n  | { type: 'discovery:start' }\n  | { type: 'discovery:end'; filesIncluded: number; filesExcluded: number; durationMs: number }\n  | { type: 'filter:applied'; filterName: string; filesMatched: number; filesRejected: number }\n  | { type: 'plan:created'; planType: string; fileCount: number }\n  | { type: 'config:loaded'; configPath: string; model: string; concurrency: number };\n\n// All events automatically enriched with:\ninterface TraceEventBase {\n  seq: number;                  // Monotonic counter\n  ts: string;                   // ISO 8601 timestamp\n  pid: number;                  // process.pid\n  elapsedMs: number;            // High-resolution delta from start\n}\n```\n\n### Exported Functions\n\n**Discovery:**\n```typescript\nfunction discoverFiles(root: string, config: DiscoveryConfig, options?: { tracer?: ITraceWriter; debug?: boolean }): Promise<FilterResult>\n\ninterface FilterResult {\n  included: string[];           // Absolute paths passing all filters\n  excluded: ExcludedFile[];     // { path, reason, filter }\n}\n```\n\n**Configuration:**\n```typescript\nfunction loadConfig(root: string, options?: { tracer?: ITraceWriter; debug?: boolean }): Promise<Config>\nfunction configExists(root: string): Promise<boolean>\nfunction writeDefaultConfig(root: string): Promise<void>\nfunction getDefaultConcurrency(): number  // CPU/memory-aware calculation\n```\n\n**Generation:**\n```typescript\nfunction buildFilePrompt(context: PromptContext): { systemPrompt: string; userPrompt: string }\nfunction buildDirectoryPrompt(directoryPath: string, projectRoot: string, existingAgentsMd?: string): Promise<{ systemPrompt: string; userPrompt: string }>\nfunction buildRootPrompt(projectRoot: string): Promise<{ systemPrompt: string; userPrompt: string }>\n\ninterface PromptContext {\n  filePath: string;\n  content: string;\n  contextFiles?: Array<{ path: string; content: string }>;\n  projectPlan?: string;\n  existingSum?: string;         // Triggers update-specific prompt\n}\n```\n\n**Writers:**\n```typescript\nfunction writeSumFile(filePath: string, summary: string, metadata: SummaryMetadata): Promise<void>\nfunction readSumFile(sumPath: string): SumFileContent | null\nfunction getSumPath(filePath: string): string\nfunction sumFileExists(filePath: string): boolean\nfunction writeAgentsMd(directoryPath: string, content: string): Promise<void>\n```\n\n**Change Detection:**\n```typescript\nfunction getChangedFiles(baseCommit: string, options?: { includeUncommitted?: boolean }): Promise<ChangeDetectionResult>\nfunction computeContentHash(filePath: string): Promise<string>\nfunction computeContentHashFromString(content: string): string\n\ninterface ChangeDetectionResult {\n  changes: FileChange[];\n  baseCommit: string;\n  currentCommit: string;\n  includesUncommitted: boolean;\n}\n```\n\n**Pool Execution:**\n```typescript\nfunction runPool<T>(\n  tasks: Array<() => Promise<T>>, \n  options: PoolOptions, \n  onComplete?: (result: TaskResult<T>) => void\n): Promise<TaskResult<T>[]>\n\ninterface PoolOptions {\n  concurrency: number;\n  failFast?: boolean;\n  tracer?: ITraceWriter;\n  debug?: boolean;\n}\n\ntype TaskResult<T> = \n  | { index: number; success: true; result: T }\n  | { index: number; success: false; error: Error };\n```\n\n**Quality Validation:**\n```typescript\nfunction checkCodeVsDoc(sourceContent: string, sumContent: SumFileContent, filePath: string): CodeDocInconsistency | null\nfunction checkCodeVsCode(files: Array<{ path: string; content: string }>): CodeCodeInconsistency[]\nfunction checkPhantomPaths(agentsMdPath: string, content: string, projectRoot: string): PhantomPathInconsistency[]\nfunction buildInconsistencyReport(issues: Inconsistency[], metadata: { projectRoot: string; filesChecked: number; durationMs: number }): InconsistencyReport\n```\n\n**Installer:**\n```typescript\nfunction runInstaller(args: InstallerArgs): Promise<InstallerResult[]>\n\ninterface InstallerArgs {\n  runtime?: 'claude' | 'opencode' | 'gemini' | 'all';\n  global?: boolean;             // Install to ~/.claude, etc.\n  local?: boolean;              // Install to .claude, etc.\n  uninstall?: boolean;\n  force?: boolean;              // Overwrite existing files\n  help?: boolean;\n  quiet?: boolean;\n}\n\ninterface InstallerResult {\n  success: boolean;\n  runtime: string;\n  location: 'global' | 'local';\n  filesCreated: string[];\n  filesSkipped: string[];\n  errors: string[];\n  hookRegistered: boolean;\n  versionWritten: boolean;\n}\n```\n\n## 4. Data Structures & State\n\n### YAML Frontmatter Schema\n\n**.sum files:**\n```yaml\n---\ngenerated_at: 2026-02-09T12:34:56.789Z\ncontent_hash: a3f5d8e9b4c7f1e2d6a8b3c5e4f9a1d7  # SHA-256 hex (64 chars)\npurpose: One-line purpose statement\ncritical_todos:\n  - Security issue requiring immediate attention\n  - Performance bottleneck in hot path\nrelated_files:\n  - src/related/module.ts\n  - tests/integration/suite.test.ts\n---\n\nMarkdown summary content...\n```\n\n### Configuration State\n\n**Default vendor directories (18 entries):**\n```\nnode_modules, .git, dist, build, coverage, .next, .nuxt, out, vendor, \ntarget, __pycache__, venv, .venv, .gradle, .cargo, .planning, .claude, .pytest_cache\n```\n\n**Default exclude patterns (32 globs):**\n```\nAGENTS.md, CLAUDE.md, GEMINI.md, OPENCODE.md, SPEC.md, *.lock, \npackage-lock.json, yarn.lock, .env, .env.*, *.log, *.sum, \nGENERATION-PLAN.md, .DS_Store, Thumbs.db, **/.git/**, **/node_modules/**, \n**/dist/**, **/.agents-reverse-engineer/**, **/SKILL.md, **/.claude/**, \n**/.opencode/**, **/.gemini/**, **/.aider/**, etc.\n```\n\n**Default binary extensions (26 types):**\n```\n.png, .jpg, .jpeg, .gif, .bmp, .svg, .ico, .pdf, .zip, .tar, \n.gz, .bz2, .7z, .rar, .exe, .dll, .so, .dylib, .bin, .woff, \n.woff2, .ttf, .otf, .eot, .mp4, .mp3\n```\n\n### In-Memory State\n\n**TelemetryLogger:**\n```typescript\nclass TelemetryLogger {\n  private entries: TelemetryEntry[] = [];\n  private runId: string;        // ISO 8601 timestamp\n  \n  addEntry(entry: TelemetryEntry): void\n  setFilesReadOnLastEntry(filesRead: FileRead[]): void\n  getSummary(): { totalInputTokens, totalOutputTokens, errorCount, uniqueFilesRead, ... }\n  toRunLog(): RunLog\n}\n```\n\n**TraceWriter:**\n```typescript\nclass TraceWriter implements ITraceWriter {\n  private writeQueue: Promise<void> = Promise.resolve();\n  private eventCounter = 0;\n  private startTime: bigint;\n  \n  emit(event: TraceEventPayload): void  // Promise-chain serialization\n  finalize(): Promise<void>             // Await queue drain\n}\n```\n\n**ProgressReporter:**\n```typescript\nclass ProgressReporter {\n  private completionTimes: number[] = [];      // Sliding window (last 10)\n  private dirCompletionTimes: number[] = [];\n  \n  onFileStart(filePath: string, index: number, total: number): void\n  onFileDone(filePath: string, durationMs: number, tokensIn: number, tokensOut: number): void\n  printSummary(summary: RunSummary): void\n}\n```\n\n**BackendRegistry:**\n```typescript\nclass BackendRegistry {\n  private backends: AIBackend[] = [];   // Insertion-order preservation\n  \n  register(backend: AIBackend): void\n  get(name: string): AIBackend | undefined\n  getAll(): AIBackend[]\n}\n```\n\n### Serialization Formats\n\n**Run Log JSON:**\n```json\n{\n  \"runId\": \"2026-02-09T12-00-00-000Z\",\n  \"startTime\": \"2026-02-09T12:00:00.000Z\",\n  \"endTime\": \"2026-02-09T12:05:30.123Z\",\n  \"entries\": [\n    {\n      \"timestamp\": \"2026-02-09T12:00:01.234Z\",\n      \"prompt\": \"Analyze this file...\",\n      \"response\": \"This module exports...\",\n      \"model\": \"claude-sonnet-4\",\n      \"inputTokens\": 1500,\n      \"outputTokens\": 300,\n      \"cacheReadTokens\": 800,\n      \"cacheCreationTokens\": 1500,\n      \"latencyMs\": 2300,\n      \"exitCode\": 0,\n      \"retryCount\": 0,\n      \"thinking\": false,\n      \"filesRead\": [\n        { \"path\": \"src/module.ts\", \"sizeBytes\": 4096 }\n      ]\n    }\n  ],\n  \"summary\": {\n    \"totalInputTokens\": 45000,\n    \"totalOutputTokens\": 9000,\n    \"totalCacheReadTokens\": 24000,\n    \"totalCacheCreationTokens\": 45000,\n    \"totalLatencyMs\": 69000,\n    \"errorCount\": 2,\n    \"uniqueFilesRead\": 15\n  }\n}\n```\n\n**Trace NDJSON:**\n```jsonl\n{\"seq\":1,\"ts\":\"2026-02-09T12:00:00.001Z\",\"pid\":12345,\"elapsedMs\":1,\"type\":\"phase:start\",\"phase\":\"phase-1-files\",\"taskCount\":50,\"concurrency\":5}\n{\"seq\":2,\"ts\":\"2026-02-09T12:00:00.012Z\",\"pid\":12345,\"elapsedMs\":12,\"type\":\"worker:start\",\"workerId\":0}\n{\"seq\":3,\"ts\":\"2026-02-09T12:00:00.015Z\",\"pid\":12345,\"elapsedMs\":15,\"type\":\"task:pickup\",\"taskIndex\":0,\"taskLabel\":\"src/index.ts\",\"activeTasks\":1}\n{\"seq\":4,\"ts\":\"2026-02-09T12:00:00.020Z\",\"pid\":12345,\"elapsedMs\":20,\"type\":\"subprocess:spawn\",\"childPid\":12346,\"command\":\"claude\",\"args\":[\"-p\",\"--output-format\",\"json\"]}\n```\n\n## 5. Configuration\n\n### Config File Location\n\n`.agents-reverse-engineer/config.yaml` at project root\n\n### Schema Validation\n\nAll fields validated via Zod with these constraints:\n\n**Numeric Constraints:**\n- `ai.concurrency`: `.min(1).max(20)` — worker pool size\n- `ai.timeoutMs`: `.positive()` — subprocess timeout\n- `ai.maxRetries`: `.min(0)` — retry attempts\n- `options.maxFileSize`: `.positive()` — binary detection threshold\n\n**Enum Validation:**\n- `ai.backend`: `z.enum(['claude', 'gemini', 'opencode', 'auto'])`\n\n**Array Defaults:**\n- `exclude.patterns`: spreads `DEFAULT_EXCLUDE_PATTERNS` (32 globs)\n- `exclude.vendorDirs`: spreads `DEFAULT_VENDOR_DIRS` (18 directories)\n- `exclude.binaryExtensions`: spreads `DEFAULT_BINARY_EXTENSIONS` (26 extensions)\n\n### Environment Variable Overrides\n\n**IDE Config Directories:**\n- `CLAUDE_CONFIG_DIR` — overrides `~/.claude`\n- `OPENCODE_CONFIG_DIR` — overrides `~/.config/opencode` (with `XDG_CONFIG_HOME` fallback)\n- `GEMINI_CONFIG_DIR` — overrides `~/.gemini`\n\n**Hook Disabling:**\n- `ARE_DISABLE_HOOK=1` — disables session hooks via early exit in hook scripts\n\n### Dynamic Defaults\n\n**Concurrency Calculation:**\n```typescript\nfunction getDefaultConcurrency(): number {\n  const cores = os.cpus().length;\n  const totalMemGB = os.totalmem() / (1024 ** 3);\n  \n  const cpuBased = cores * 5;\n  const memoryBased = Math.floor(totalMemGB * 0.5 / 0.512);  // 512MB per subprocess\n  \n  return Math.max(MIN_CONCURRENCY, Math.min(cpuBased, memoryBased, MAX_CONCURRENCY));\n}\n// MIN_CONCURRENCY=2, MAX_CONCURRENCY=20\n```\n\n### Complete Config Example\n\n```yaml\nexclude:\n  patterns:\n    - \"*.test.ts\"\n    - \"**/__tests__/**\"\n    - \"*.config.js\"\n  vendorDirs:\n    - node_modules\n    - .git\n    - dist\n  binaryExtensions:\n    - .png\n    - .zip\n    - .pdf\n\noptions:\n  followSymlinks: false\n  maxFileSize: 1048576\n\noutput:\n  colors: true\n\nai:\n  backend: auto\n  model: null\n  timeoutMs: 120000\n  maxRetries: 3\n  concurrency: 5\n  \n  telemetry:\n    enabled: true\n    keepRuns: 50\n    costThresholdUsd: 10\n  \n  pricing:\n    claude:\n      inputCostPer1kTokens: 0.003\n      outputCostPer1kTokens: 0.015\n      cacheReadCostPer1kTokens: 0.0003\n      cacheCreationCostPer1kTokens: 0.00375\n```\n\n## 6. Dependencies\n\n### Production Dependencies\n\n**`fast-glob` ^3.3.2**\n- **Purpose:** File discovery with glob patterns, dotfile support, symlink control\n- **Rationale:** Fastest glob library with native ignore support, replaces recursive fs.readdir\n- **Usage:** `fast-glob('**/*', { onlyFiles: true, dot: true, ignore: ['.git/**'] })`\n\n**`ignore` ^5.3.1**\n- **Purpose:** Gitignore pattern matching engine\n- **Rationale:** Canonical implementation matching git behavior exactly\n- **Usage:** `ig.add(patterns).ignores(relativePath)`\n\n**`isbinaryfile` ^5.0.2**\n- **Purpose:** Content-based binary file detection\n- **Rationale:** Prevents LLM context pollution with non-text content\n- **Usage:** `await isBinaryFile(absolutePath)` for unknown extensions\n\n**`simple-git` ^3.24.0**\n- **Purpose:** Git diff parsing with rename detection\n- **Rationale:** Enables incremental updates by detecting changed files\n- **Usage:** `git diff --name-status -M <baseCommit>..HEAD`\n\n**`yaml` ^2.4.1**\n- **Purpose:** YAML parsing without comment preservation\n- **Rationale:** Lightweight, spec-compliant, no dependencies\n- **Usage:** `yaml.parse(configContent)` for config loading\n\n**`zod` ^3.22.4**\n- **Purpose:** Runtime schema validation with TypeScript inference\n- **Rationale:** Type-safe config validation, detailed error messages\n- **Usage:** `ConfigSchema.parse(rawConfig)` throws ZodError with formatted issues\n\n**`ora` ^8.0.1**\n- **Purpose:** Terminal spinner UI with color support\n- **Rationale:** Provides visual feedback during long-running operations\n- **Usage:** `ora('Analyzing files...').start()` / `.succeed()` / `.fail()`\n\n**`picocolors` ^1.0.0**\n- **Purpose:** ANSI color codes without dependencies\n- **Rationale:** Zero-dependency alternative to chalk, 14x smaller\n- **Usage:** `pc.green('✓')`, `pc.red('✗')`, `pc.dim('...')`\n\n### Development Dependencies\n\n**`typescript` ^5.7.3**\n- **Purpose:** Static type checking, ES2022 code generation\n- **Rationale:** Industry standard for Node.js type safety\n- **Configuration:** NodeNext module resolution, strict mode\n\n**`tsx` ^4.7.1**\n- **Purpose:** Hot-reload TypeScript execution\n- **Rationale:** Fast development iteration without tsc compilation\n- **Usage:** `tsx watch src/cli/index.ts`\n\n**`@types/node` ^20.11.0**\n- **Purpose:** Node.js stdlib type definitions\n- **Rationale:** Enables IDE autocomplete for fs, path, child_process\n\n**`vitest` (implicit, not in package.json)**\n- **Purpose:** Unit testing framework\n- **Rationale:** Fast, TypeScript-native, Jest-compatible API\n\n### Peer Dependencies (Implicit)\n\n**AI CLI Tools (at least one required):**\n- `@anthropic-ai/claude-code` — Claude Code CLI (`claude` command)\n- Gemini CLI — Google Gemini assistant (`gemini` command)\n- OpenCode CLI — OpenCode assistant (`opencode` command)\n\n### Dependency Graph\n\n```\nCLI Commands (src/cli/)\n  ↓\nCommandRunner (src/orchestration/runner.ts)\n  ↓\n├── AIService (src/ai/service.ts)\n│   └── Backends (src/ai/backends/)\n│       └── runSubprocess() → child_process.execFile\n├── Discovery (src/discovery/run.ts)\n│   ├── fast-glob\n│   ├── ignore (gitignore parsing)\n│   └── isbinaryfile\n├── Quality (src/quality/)\n│   └── Node.js stdlib (fs, path)\n├── Config (src/config/loader.ts)\n│   ├── yaml\n│   └── zod\n└── Update (src/update/orchestrator.ts)\n    └── simple-git\n```\n\n## 7. Behavioral Contracts\n\n### Error Handling Strategy\n\n**Error Types:**\n```typescript\nclass AIServiceError extends Error {\n  code: 'CLI_NOT_FOUND' | 'TIMEOUT' | 'PARSE_ERROR' | 'SUBPROCESS_ERROR' | 'RATE_LIMIT';\n  details?: Record<string, unknown>;\n}\n\nclass ConfigError extends Error {\n  filePath: string;\n  cause?: Error;\n}\n\nclass SpecExistsError extends Error {\n  paths: string[];\n}\n```\n\n**Error Propagation:**\n- Subprocess failures: `AIServiceError` with `code: 'SUBPROCESS_ERROR'` if exitCode !== 0\n- Rate limits: `AIServiceError` with `code: 'RATE_LIMIT'` if stderr matches patterns `['rate limit', '429', 'too many requests', 'overloaded']`\n- Timeouts: `AIServiceError` with `code: 'TIMEOUT'` if subprocess exceeds `timeoutMs`\n- Parse failures: `AIServiceError` with `code: 'PARSE_ERROR'` if JSON.parse() throws\n- Missing CLI: `AIServiceError` with `code: 'CLI_NOT_FOUND'` if no backend available\n\n**Exit Codes:**\n- `0` — All tasks succeeded or no files to process\n- `1` — Partial failure (`filesProcessed > 0` and `filesFailed > 0`), or permission denied\n- `2` — Total failure (`filesProcessed === 0` and `filesFailed > 0`), or no backend available\n\n### Retry Logic\n\n**Exponential Backoff:**\n```typescript\nfunction withRetry<T>(fn: () => Promise<T>, options: RetryOptions): Promise<T>\n\ninterface RetryOptions {\n  maxRetries: number;           // Default: 3\n  baseDelayMs: number;          // Default: 1000\n  maxDelayMs: number;           // Default: 8000\n  multiplier: number;           // Default: 2\n  isRetryable: (error: Error) => boolean;\n  onRetry?: (attempt: number, error: Error) => void;\n}\n\n// Formula: delay = min(baseDelayMs * multiplier^attempt, maxDelayMs) + jitter\n// jitter = Math.random() * 500\n```\n\n**Retryable Conditions:**\n- `AIServiceError` with `code === 'RATE_LIMIT'`\n- Network timeouts from fetch (if backend supports)\n\n**Non-Retryable Conditions:**\n- `AIServiceError` with `code === 'TIMEOUT'` (subprocess timeout)\n- `AIServiceError` with `code === 'PARSE_ERROR'` (invalid response)\n- `AIServiceError` with `code === 'CLI_NOT_FOUND'` (missing executable)\n- All other error types\n\n### Concurrency Model\n\n**Worker Pool Pattern:**\n- Shared iterator across N workers prevents batch anti-pattern\n- Iterator protocol ensures atomic task consumption\n- Workers execute until iterator exhausted\n- Fail-fast mode aborts all workers on first error\n\n**Resource Limits Per Subprocess:**\n```typescript\nconst env = {\n  NODE_OPTIONS: '--max-old-space-size=512',          // 512MB heap\n  UV_THREADPOOL_SIZE: '4',                           // 4 libuv threads\n  CLAUDE_CODE_DISABLE_BACKGROUND_TASKS: '1',         // No background spawns\n};\nconst args = [...backendArgs, '--disallowedTools', 'Task'];\n```\n\n**Timeout Enforcement:**\n1. SIGTERM sent at `timeoutMs`\n2. 5-second grace period for cleanup\n3. SIGKILL escalation if still running\n4. Process group killing via `kill(-pid)` to terminate subprocess tree\n\n### Lifecycle Hooks\n\n**Session Lifecycle (Claude/Gemini/OpenCode):**\n\n**SessionStart Hook (`are-check-update.js`):**\n```javascript\n// Spawns detached process\n// Queries: npm view agents-reverse-engineer version\n// Compares: cached ARE-VERSION file\n// Writes: ~/.claude/cache/are-update-check.json\n// Exit: 0 (silent failure on errors)\n```\n\n**SessionEnd Hook (`are-session-end.js`):**\n```javascript\n// Guards: ARE_DISABLE_HOOK='1' or config 'hook_enabled: false'\n// Checks: git status --porcelain (non-empty = uncommitted changes)\n// Spawns: npx agents-reverse-engineer@latest update --quiet (detached)\n// Exit: 0 (silent failure on errors/non-git repos)\n```\n\n**Hook Disable Mechanisms:**\n1. Environment variable: `ARE_DISABLE_HOOK=1`\n2. Config substring: `.agents-reverse-engineer.yaml` contains `hook_enabled: false`\n\n### Resource Management\n\n**File Handles:**\n- `ProgressLog` opens `.agents-reverse-engineer/progress.log` in truncate mode ('w')\n- `TraceWriter` opens `.agents-reverse-engineer/traces/trace-<timestamp>.ndjson` in append mode ('a')\n- Both closed via `finalize()` after queue drain\n\n**Memory Management:**\n- `GenerationOrchestrator.prepareFiles()` clears file content after task creation: `(file as { content: string }).content = ''`\n- Subprocess heap limited to 512MB prevents OOM\n- Default concurrency computed from system memory: `floor(totalMemGB * 0.5 / 0.512)`\n\n**Process Management:**\n- Active subprocess tracking via `activeSubprocesses: Map<number, { pid, command, args }>`\n- Process group killing ensures no orphaned subprocesses\n- Unref'd timeout handles prevent event loop blocking\n\n### State Persistence\n\n**Stateless Incremental Updates:**\n- No external database required\n- SHA-256 hash embedded in `.sum` YAML frontmatter\n- Hash comparison determines regeneration scope\n- Works in non-git environments\n\n**Telemetry Retention:**\n- Run logs: kept last `config.ai.telemetry.keepRuns` (default 50)\n- Traces: kept last 500 via `cleanupOldTraces(keepCount=500)`\n- Cleanup triggered after each run via lexicographic sort descending\n\n## 8. Test Contracts\n\n### `src/ai/` Module Tests\n\n**Subprocess Management:**\n- SHOULD spawn subprocess with correct environment variables (NODE_OPTIONS, UV_THREADPOOL_SIZE)\n- SHOULD send prompt via stdin and close with EOF\n- SHOULD enforce timeout with SIGTERM → SIGKILL escalation\n- SHOULD kill process group via `kill(-pid)`\n- SHOULD track active subprocesses in Map\n- SHOULD unref timeout handles\n\n**Retry Logic:**\n- SHOULD retry rate limit errors with exponential backoff\n- SHOULD NOT retry timeout errors\n- SHOULD NOT retry parse errors\n- SHOULD invoke onRetry callback with attempt number\n- SHOULD add jitter (0-500ms) to delay calculation\n- SHOULD respect maxRetries limit\n\n**Backend Registry:**\n- SHOULD register backends in insertion order\n- SHOULD detect first available backend for 'auto' mode\n- SHOULD throw CLI_NOT_FOUND when no backend available\n- SHOULD return installation instructions for all backends\n\n**Telemetry:**\n- SHOULD accumulate entries with token counts\n- SHOULD compute summary with unique file count\n- SHOULD write run log with sanitized timestamp\n- SHOULD clean up old logs beyond retention limit\n\n### `src/discovery/` Module Tests\n\n**Filter Chain:**\n- SHOULD execute filters in order: gitignore → vendor → binary → custom\n- SHOULD short-circuit on first filter match\n- SHOULD emit filter:applied trace events with counts\n- SHOULD respect maxFileSize threshold for binary detection\n- SHOULD match vendor directories anywhere in path\n- SHOULD handle multi-segment vendor patterns\n\n**Gitignore Integration:**\n- SHOULD parse .gitignore with ignore library\n- SHOULD convert absolute paths to relative before matching\n- SHOULD return false for external paths (starting with ..)\n- SHOULD handle missing .gitignore gracefully\n\n**Binary Detection:**\n- SHOULD match known extensions via fast-path lookup\n- SHOULD enforce size threshold via fs.stat()\n- SHOULD use isbinaryfile for unknown extensions\n- SHOULD return true on fs.stat() errors\n\n### `src/generation/` Module Tests\n\n**Prompt Construction:**\n- SHOULD inject import map from extractDirectoryImports()\n- SHOULD switch to update prompts when existingSum present\n- SHOULD detect 9 manifest types (package.json, Cargo.toml, etc.)\n- SHOULD preserve user content via AGENTS.local.md prepending\n- SHOULD strip GENERATED_MARKER from LLM output\n\n**Execution Plan:**\n- SHOULD sort directories by depth descending\n- SHOULD construct dependency graph: files → directories → root\n- SHOULD wait for child .sum files via isDirectoryComplete()\n- SHOULD compute directory file map for metadata\n\n**YAML Frontmatter:**\n- SHOULD serialize inline arrays when ≤3 items <40 chars\n- SHOULD serialize multi-line arrays otherwise\n- SHOULD embed SHA-256 content_hash\n- SHOULD parse frontmatter via regex extraction\n- SHOULD return null on parse failure\n\n### `src/orchestration/` Module Tests\n\n**Worker Pool:**\n- SHOULD share single iterator across workers\n- SHOULD prevent over-allocation when tasks < concurrency\n- SHOULD abort all workers on fail-fast error\n- SHOULD emit worker:start/end events\n- SHOULD emit task:pickup/done events with activeTasks counter\n- SHOULD preserve original task order in results\n\n**Progress Tracking:**\n- SHOULD compute ETA via moving average of last 10 durations\n- SHOULD show ETA after 2+ completions\n- SHOULD format as seconds below 60s, minutes+seconds above\n- SHOULD mirror output to progress.log\n- SHOULD strip ANSI codes before file write\n\n**Trace Emission:**\n- SHOULD auto-populate seq, ts, pid, elapsedMs fields\n- SHOULD serialize writes via promise chain\n- SHOULD preserve NDJSON line order despite concurrent emissions\n- SHOULD clean up old traces beyond 500 retention limit\n\n**Plan Tracking:**\n- SHOULD mark checkboxes in GENERATION-PLAN.md\n- SHOULD serialize writes via promise chain\n- SHOULD flush queue on finalize()\n\n### `src/update/` Module Tests\n\n**Hash Comparison:**\n- SHOULD read content_hash from .sum frontmatter\n- SHOULD compute current hash via SHA-256\n- SHOULD classify as filesToAnalyze on hash mismatch\n- SHOULD classify as filesToSkip on hash match\n- SHOULD detect missing .sum as added files\n\n**Orphan Cleanup:**\n- SHOULD delete .sum files for deleted sources\n- SHOULD delete .sum files for renamed oldPath\n- SHOULD remove AGENTS.md when directory has no source files\n- SHOULD preserve AGENTS.md when source files remain\n- SHOULD exclude hidden files from empty check\n- SHOULD exclude .sum files from empty check\n\n**Affected Directories:**\n- SHOULD walk parent directory tree to root\n- SHOULD include all parent directories in set\n- SHOULD return unique directory paths\n\n### `src/quality/` Module Tests\n\n**Code-vs-Doc:**\n- SHOULD extract exports via regex pattern\n- SHOULD detect missing exports in summary\n- SHOULD return null when all exports documented\n- SHOULD populate missingFromDoc array\n\n**Code-vs-Code:**\n- SHOULD build symbol-to-paths map\n- SHOULD detect duplicates when paths.length > 1\n- SHOULD return empty array when no duplicates\n- SHOULD include all files in CodeCodeInconsistency\n\n**Phantom Paths:**\n- SHOULD extract paths via three regex patterns\n- SHOULD skip patterns matching SKIP_PATTERNS\n- SHOULD resolve relative to AGENTS.md directory\n- SHOULD resolve relative to project root\n- SHOULD try .ts fallback for .js imports\n- SHOULD deduplicate via seen Set\n\n**Report Building:**\n- SHOULD aggregate inconsistencies by type\n- SHOULD compute severity counts\n- SHOULD format CLI output with severity tags\n\n### `src/config/` Module Tests\n\n**Schema Validation:**\n- SHOULD enforce concurrency range [1, 20]\n- SHOULD enforce positive timeoutMs\n- SHOULD validate backend enum values\n- SHOULD spread default arrays\n- SHOULD throw ConfigError on ZodError\n\n**Concurrency Calculation:**\n- SHOULD compute CPU-based limit (cores * 5)\n- SHOULD compute memory-based limit (totalMemGB * 0.5 / 0.512)\n- SHOULD return min(cpuBased, memoryBased) clamped to [2, 20]\n\n**Config Writing:**\n- SHOULD generate YAML with inline comments\n- SHOULD apply yamlScalar() quoting for globs\n- SHOULD create parent directory if missing\n\n### `src/installer/` Module Tests\n\n**Hook Registration:**\n- SHOULD append hooks to settings.hooks.SessionStart/SessionEnd arrays\n- SHOULD check duplicates via command string match\n- SHOULD use nested format for Claude\n- SHOULD use flat format for Gemini\n\n**Permission Registration:**\n- SHOULD append ARE_PERMISSIONS patterns to settings.permissions.allow\n- SHOULD deduplicate via includes() check\n\n**Hook Deregistration:**\n- SHOULD filter arrays removing matching command patterns\n- SHOULD clean empty arrays/objects\n- SHOULD handle both current and legacy formats\n\n**Template Writing:**\n- SHOULD write templates to runtime-specific paths\n- SHOULD create parent directories\n- SHOULD skip existing files unless force=true\n- SHOULD return filesCreated/filesSkipped arrays\n\n## 9. Build Plan\n\n### Phase 1: Core Infrastructure (no dependencies)\n\n**Goal:** Establish configuration, logging, and type foundations\n\n**Modules:**\n1. `src/types/` — Shared interfaces (ExcludedFile, DiscoveryResult, DiscoveryStats)\n2. `src/output/logger.ts` — Terminal formatting with picocolors\n3. `src/config/schema.ts` — Zod validation schemas\n4. `src/config/defaults.ts` — Default arrays and concurrency calculation\n5. `src/config/loader.ts` — YAML parsing with loadConfig()/writeDefaultConfig()\n6. `src/version.ts` — Package version extraction\n\n**Verification:**\n- Config loads with valid YAML\n- Default concurrency computes based on system resources\n- Logger produces colored output when colors=true\n\n**Enables:** All subsequent phases depend on Config and Logger\n\n---\n\n### Phase 2: File Discovery (depends: Phase 1)\n\n**Goal:** Implement gitignore-aware file walking with composable filters\n\n**Modules:**\n1. `src/discovery/types.ts` — FileFilter interface, WalkerOptions\n2. `src/discovery/walker.ts` — fast-glob integration with .git/** exclusion\n3. `src/discovery/filters/binary.ts` — Extension + size + content detection\n4. `src/discovery/filters/vendor.ts` — Single/multi-segment directory matching\n5. `src/discovery/filters/gitignore.ts` — ignore library wrapper\n6. `src/discovery/filters/custom.ts` — User-defined glob patterns\n7. `src/discovery/filters/index.ts` — applyFilters() with worker pool\n8. `src/discovery/run.ts` — discoverFiles() orchestrator\n\n**Verification:**\n- Discovers files respecting .gitignore\n- Excludes node_modules, .git, dist\n- Detects binary files via extension/size/content\n- Returns FilterResult with included/excluded arrays\n\n**Enables:** Phase 4 (Generation) requires file lists, Phase 6 (Update) requires discovery\n\n---\n\n### Phase 3: AI Service Layer (depends: Phase 1)\n\n**Goal:** Backend-agnostic subprocess management with retry and telemetry\n\n**Modules:**\n1. `src/ai/types.ts` — AIBackend, AICallOptions, AIResponse, TelemetryEntry\n2. `src/ai/subprocess.ts` — runSubprocess() with resource limits and timeout\n3. `src/ai/retry.ts` — withRetry() exponential backoff\n4. `src/ai/backends/claude.ts` — ClaudeBackend with JSON parsing\n5. `src/ai/backends/gemini.ts` — GeminiBackend stub\n6. `src/ai/backends/opencode.ts` — OpenCodeBackend stub\n7. `src/ai/registry.ts` — Backend registration and auto-detection\n8. `src/ai/service.ts` — AIService orchestrating call()/finalize()\n9. `src/ai/telemetry/logger.ts` — TelemetryLogger with addEntry()/getSummary()\n10. `src/ai/telemetry/run-log.ts` — writeRunLog() with timestamp sanitization\n11. `src/ai/telemetry/cleanup.ts` — cleanupOldLogs() retention enforcement\n\n**Verification:**\n- Spawns Claude CLI subprocess with correct args\n- Parses JSON response extracting tokens/cost\n- Retries rate limits with exponential backoff\n- Writes run logs to .agents-reverse-engineer/logs/\n- Cleans up logs beyond retention limit\n\n**Enables:** Phase 4 (Generation) requires AI calls\n\n---\n\n### Phase 4: Generation Pipeline (depends: Phases 1-3)\n\n**Goal:** Three-phase documentation generation with prompts, writers, collectors\n\n**Modules:**\n1. `src/imports/types.ts` — ImportEntry, FileImports\n2. `src/imports/extractor.ts` — extractImports(), extractDirectoryImports()\n3. `src/generation/types.ts` — AnalysisResult, SummaryOptions\n4. `src/generation/prompts/types.ts` — PromptContext, SUMMARY_GUIDELINES\n5. `src/generation/prompts/templates.ts` — FILE/DIRECTORY/ROOT system/user prompts\n6. `src/generation/prompts/builder.ts` — buildFilePrompt()/buildDirectoryPrompt()/buildRootPrompt()\n7. `src/generation/writers/sum.ts` — writeSumFile()/readSumFile() with YAML frontmatter\n8. `src/generation/writers/agents-md.ts` — writeAgentsMd() with user content preservation\n9. `src/generation/collector.ts` — collectAgentsDocs() recursive traversal\n10. `src/generation/complexity.ts` — analyzeComplexity() with depth calculation\n11. `src/generation/orchestrator.ts` — GenerationOrchestrator.createPlan()\n12. `src/generation/executor.ts` — buildExecutionPlan() with dependency ordering\n\n**Verification:**\n- Builds file prompts with import context\n- Writes .sum files with SHA-256 content_hash\n- Builds directory prompts aggregating child .sum files\n- Writes AGENTS.md preserving AGENTS.local.md\n- Builds root prompts collecting all AGENTS.md\n- Execution plan sorts directories by depth descending\n\n**Enables:** Phase 5 (Orchestration) requires tasks, Phase 7 (Update) requires writers\n\n---\n\n### Phase 5: Orchestration & Progress (depends: Phases 1, 3, 4)\n\n**Goal:** Worker pool execution with trace emission and progress tracking\n\n**Modules:**\n1. `src/orchestration/types.ts` — FileTaskResult, RunSummary, ProgressEvent, TraceEvent\n2. `src/orchestration/trace.ts` — TraceWriter with promise-chain serialization\n3. `src/orchestration/pool.ts` — runPool() shared-iterator pattern\n4. `src/orchestration/progress.ts` — ProgressReporter with ETA calculation\n5. `src/orchestration/plan-tracker.ts` — PlanTracker for GENERATION-PLAN.md\n6. `src/orchestration/runner.ts` — CommandRunner.executeGenerate()/executeUpdate()\n\n**Verification:**\n- Workers share iterator preventing over-allocation\n- Trace events emitted with seq/ts/pid/elapsedMs\n- ETA computed from moving average of last 10 durations\n- Progress mirrored to .agents-reverse-engineer/progress.log\n- Plan tracker marks checkboxes on task completion\n\n**Enables:** Phase 8 (CLI) requires CommandRunner\n\n---\n\n### Phase 6: Change Detection (depends: Phase 1)\n\n**Goal:** Git diff parsing and SHA-256 hashing for incremental updates\n\n**Modules:**\n1. `src/change-detection/types.ts` — ChangeType, FileChange, ChangeDetectionResult\n2. `src/change-detection/detector.ts` — getChangedFiles(), computeContentHash()\n\n**Verification:**\n- Parses git diff --name-status -M with rename detection\n- Merges uncommitted changes when includeUncommitted=true\n- Computes SHA-256 hex digest for file content\n\n**Enables:** Phase 7 (Update) requires change detection\n\n---\n\n### Phase 7: Incremental Updates (depends: Phases 1, 4, 6)\n\n**Goal:** Hash-based regeneration with orphan cleanup\n\n**Modules:**\n1. `src/update/types.ts` — UpdateOptions, UpdateResult, CleanupResult\n2. `src/update/orphan-cleaner.ts` — cleanupOrphans()/getAffectedDirectories()\n3. `src/update/orchestrator.ts` — UpdateOrchestrator.preparePlan()\n\n**Verification:**\n- Reads content_hash from .sum frontmatter\n- Classifies files into filesToAnalyze vs filesToSkip\n- Deletes orphaned .sum files for deleted/renamed sources\n- Removes AGENTS.md from empty directories\n- Computes affected directories via parent tree walk\n\n**Enables:** Phase 8 (CLI update command)\n\n---\n\n### Phase 8: Quality Validation (depends: Phases 1, 4)\n\n**Goal:** Post-generation consistency checks\n\n**Modules:**\n1. `src/quality/types.ts` — Inconsistency discriminated union\n2. `src/quality/inconsistency/code-vs-doc.ts` — extractExports(), checkCodeVsDoc()\n3. `src/quality/inconsistency/code-vs-code.ts` — checkCodeVsCode()\n4. `src/quality/inconsistency/reporter.ts` — buildInconsistencyReport()\n5. `src/quality/phantom-paths/validator.ts` — checkPhantomPaths()\n6. `src/quality/density/validator.ts` — validateFindability() stub\n\n**Verification:**\n- Extracts exports via regex\n- Detects missing exports in summaries\n- Detects duplicate symbols across files\n- Resolves phantom paths with .ts fallback\n- Formats report with severity tags\n\n**Enables:** Phase 9 (CLI) reports quality metrics\n\n---\n\n### Phase 9: CLI Commands (depends: Phases 1-8)\n\n**Goal:** User-facing command interface\n\n**Modules:**\n1. `src/cli/index.ts` — Argument parsing and routing\n2. `src/cli/init.ts` — Config initialization\n3. `src/cli/discover.ts` — Discovery preview\n4. `src/cli/generate.ts` — Three-phase generation\n5. `src/cli/update.ts` — Incremental regeneration\n6. `src/cli/clean.ts` — Artifact deletion\n7. `src/cli/specify.ts` — Specification synthesis\n\n**Verification:**\n- are init creates .agents-reverse-engineer/config.yaml\n- are discover writes GENERATION-PLAN.md\n- are generate executes three phases\n- are update regenerates only changed files\n- are clean deletes .sum/AGENTS.md/CLAUDE.md\n- are specify synthesizes specs/SPEC.md\n\n**Enables:** Phase 10 (Installer) requires CLI\n\n---\n\n### Phase 10: Integration & Installer (depends: Phases 1, 9)\n\n**Goal:** IDE command installation with hook registration\n\n**Modules:**\n1. `src/integration/types.ts` — EnvironmentType, DetectedEnvironment\n2. `src/integration/detect.ts` — detectEnvironments() via filesystem markers\n3. `src/integration/templates.ts` — getClaudeTemplates()/getOpenCodeTemplates()/getGeminiTemplates()\n4. `src/integration/generate.ts` — generateIntegrationFiles()\n5. `src/installer/types.ts` — Runtime, InstallerArgs, InstallerResult\n6. `src/installer/paths.ts` — getRuntimePaths() with environment overrides\n7. `src/installer/prompts.ts` — selectRuntime()/selectLocation() with TTY detection\n8. `src/installer/operations.ts` — installFiles()/registerHooks()/registerPermissions()\n9. `src/installer/uninstall.ts` — uninstallFiles()/unregisterHooks()\n10. `src/installer/banner.ts` — displayBanner()/showNextSteps()\n11. `hooks/` — Session lifecycle scripts (4 files: Claude/Gemini/OpenCode pairs)\n12. `scripts/build-hooks.js` — Prepublish hook copying to hooks/dist/\n\n**Verification:**\n- Detects Claude/OpenCode/Gemini environments\n- Writes command templates to ~/.claude/skills/, etc.\n- Installs hooks to ~/.claude/hooks/\n- Registers hooks in settings.json (nested for Claude, flat for Gemini)\n- Registers permissions for auto-approval\n- Uninstalls templates and deregisters hooks\n- Copies hooks to hooks/dist/ during prepublish\n\n**Enables:** Complete end-to-end workflow\n\n---\n\n### Phase 11: Specification Synthesis (depends: Phases 1, 3, 4)\n\n**Goal:** Generate project specifications from AGENTS.md corpus\n\n**Modules:**\n1. `src/specify/prompts.ts` — buildSpecPrompt() with SPEC_SYSTEM_PROMPT\n2. `src/specify/writer.ts` — writeSpec() with single/multi-file modes\n3. `src/specify/index.ts` — Barrel export\n\n**Verification:**\n- Prompts enforce concern-based organization\n- Single-file mode writes specs/SPEC.md\n- Multi-file mode splits on top-level headings\n- Throws SpecExistsError without --force\n\n**Enables:** Complete feature set\n\n---\n\n### Phase 12: Build & Distribution (depends: all phases)\n\n**Goal:** Package for npm with provenance attestation\n\n**Modules:**\n1. `package.json` — Binary entry points, scripts, dependencies\n2. `tsconfig.json` — ES2022 target, NodeNext resolution\n3. `.github/workflows/publish.yml` — CI/CD with OIDC provenance\n\n**Verification:**\n- tsc compiles src/ → dist/ without errors\n- npm pack includes dist/, hooks/dist/, LICENSE, README.md\n- Binary entry points resolve to dist/cli/index.js\n- GitHub Actions publishes with provenance on release\n\n**Deliverable:** Published npm package\n```\n\n\n## Project Structure\n\nFull project file listing for context:\n\n<project-structure>\n# Documentation Generation Plan\n\nGenerated: 2026-02-09\nProject: /home/pascal/wks/agents-reverse-engineer\n\n## Summary\n\n- **Total Tasks**: 126\n- **File Tasks**: 96\n- **Directory Tasks**: 29\n- **Root Tasks**: 1\n- **Traversal**: Post-order (children before parents)\n\n---\n\n## Phase 1: File Analysis (Post-Order Traversal)\n\n### Depth 3: src/ai/backends/ (3 files)\n- [x] `src/ai/backends/claude.ts`\n- [x] `src/ai/backends/gemini.ts`\n- [x] `src/ai/backends/opencode.ts`\n\n### Depth 3: src/ai/telemetry/ (3 files)\n- [x] `src/ai/telemetry/cleanup.ts`\n- [x] `src/ai/telemetry/logger.ts`\n- [x] `src/ai/telemetry/run-log.ts`\n\n### Depth 3: src/discovery/filters/ (5 files)\n- [x] `src/discovery/filters/binary.ts`\n- [x] `src/discovery/filters/custom.ts`\n- [x] `src/discovery/filters/gitignore.ts`\n- [x] `src/discovery/filters/index.ts`\n- [x] `src/discovery/filters/vendor.ts`\n\n### Depth 3: src/generation/prompts/ (4 files)\n- [x] `src/generation/prompts/builder.ts`\n- [x] `src/generation/prompts/index.ts`\n- [x] `src/generation/prompts/templates.ts`\n- [x] `src/generation/prompts/types.ts`\n\n### Depth 3: src/generation/writers/ (3 files)\n- [x] `src/generation/writers/agents-md.ts`\n- [x] `src/generation/writers/index.ts`\n- [x] `src/generation/writers/sum.ts`\n\n### Depth 3: src/quality/density/ (1 files)\n- [x] `src/quality/density/validator.ts`\n\n### Depth 3: src/quality/inconsistency/ (3 files)\n- [x] `src/quality/inconsistency/code-vs-code.ts`\n- [x] `src/quality/inconsistency/code-vs-doc.ts`\n- [x] `src/quality/inconsistency/reporter.ts`\n\n### Depth 3: src/quality/phantom-paths/ (2 files)\n- [x] `src/quality/phantom-paths/index.ts`\n- [x] `src/quality/phantom-paths/validator.ts`\n\n### Depth 2: .github/workflows/ (1 files)\n- [x] `.github/workflows/publish.yml`\n\n### Depth 2: src/ai/ (6 files)\n- [x] `src/ai/index.ts`\n- [x] `src/ai/registry.ts`\n- [x] `src/ai/retry.ts`\n- [x] `src/ai/service.ts`\n- [x] `src/ai/subprocess.ts`\n- [x] `src/ai/types.ts`\n\n### Depth 2: src/change-detection/ (3 files)\n- [x] `src/change-detection/detector.ts`\n- [x] `src/change-detection/index.ts`\n- [x] `src/change-detection/types.ts`\n\n### Depth 2: src/cli/ (7 files)\n- [x] `src/cli/clean.ts`\n- [x] `src/cli/discover.ts`\n- [x] `src/cli/generate.ts`\n- [x] `src/cli/index.ts`\n- [x] `src/cli/init.ts`\n- [x] `src/cli/specify.ts`\n- [x] `src/cli/update.ts`\n\n### Depth 2: src/config/ (3 files)\n- [x] `src/config/defaults.ts`\n- [x] `src/config/loader.ts`\n- [x] `src/config/schema.ts`\n\n### Depth 2: src/discovery/ (3 files)\n- [x] `src/discovery/run.ts`\n- [x] `src/discovery/types.ts`\n- [x] `src/discovery/walker.ts`\n\n### Depth 2: src/generation/ (5 files)\n- [x] `src/generation/collector.ts`\n- [x] `src/generation/complexity.ts`\n- [x] `src/generation/executor.ts`\n- [x] `src/generation/orchestrator.ts`\n- [x] `src/generation/types.ts`\n\n### Depth 2: src/imports/ (3 files)\n- [x] `src/imports/extractor.ts`\n- [x] `src/imports/index.ts`\n- [x] `src/imports/types.ts`\n\n### Depth 2: src/installer/ (7 files)\n- [x] `src/installer/banner.ts`\n- [x] `src/installer/index.ts`\n- [x] `src/installer/operations.ts`\n- [x] `src/installer/paths.ts`\n- [x] `src/installer/prompts.ts`\n- [x] `src/installer/types.ts`\n- [x] `src/installer/uninstall.ts`\n\n### Depth 2: src/integration/ (4 files)\n- [x] `src/integration/detect.ts`\n- [x] `src/integration/generate.ts`\n- [x] `src/integration/templates.ts`\n- [x] `src/integration/types.ts`\n\n### Depth 2: src/orchestration/ (7 files)\n- [x] `src/orchestration/index.ts`\n- [x] `src/orchestration/plan-tracker.ts`\n- [x] `src/orchestration/pool.ts`\n- [x] `src/orchestration/progress.ts`\n- [x] `src/orchestration/runner.ts`\n- [x] `src/orchestration/trace.ts`\n- [x] `src/orchestration/types.ts`\n\n### Depth 2: src/output/ (1 files)\n- [x] `src/output/logger.ts`\n\n### Depth 2: src/quality/ (2 files)\n- [x] `src/quality/index.ts`\n- [x] `src/quality/types.ts`\n\n### Depth 2: src/specify/ (3 files)\n- [x] `src/specify/index.ts`\n- [x] `src/specify/prompts.ts`\n- [x] `src/specify/writer.ts`\n\n### Depth 2: src/types/ (1 files)\n- [x] `src/types/index.ts`\n\n### Depth 2: src/update/ (4 files)\n- [x] `src/update/index.ts`\n- [x] `src/update/orchestrator.ts`\n- [x] `src/update/orphan-cleaner.ts`\n- [x] `src/update/types.ts`\n\n### Depth 1: docs/ (1 files)\n- [x] `docs/INPUT.md`\n\n### Depth 1: hooks/ (4 files)\n- [x] `hooks/are-check-update.js`\n- [x] `hooks/are-session-end.js`\n- [x] `hooks/opencode-are-check-update.js`\n- [x] `hooks/opencode-are-session-end.js`\n\n### Depth 1: scripts/ (1 files)\n- [x] `scripts/build-hooks.js`\n\n### Depth 1: src/ (1 files)\n- [x] `src/version.ts`\n\n### Depth 0: ./ (5 files)\n- [x] `LANGUAGES-MANIFEST.md`\n- [x] `LICENSE`\n- [x] `README.md`\n- [x] `package.json`\n- [x] `tsconfig.json`\n\n---\n\n## Phase 2: Directory AGENTS.md (Post-Order Traversal, 29 directories)\n\n### Depth 3\n- [x] `src/ai/backends/AGENTS.md`\n- [x] `src/ai/telemetry/AGENTS.md`\n- [x] `src/discovery/filters/AGENTS.md`\n- [x] `src/generation/prompts/AGENTS.md`\n- [x] `src/generation/writers/AGENTS.md`\n- [x] `src/quality/density/AGENTS.md`\n- [x] `src/quality/inconsistency/AGENTS.md`\n- [x] `src/quality/phantom-paths/AGENTS.md`\n\n### Depth 2\n- [x] `.github/workflows/AGENTS.md`\n- [x] `src/ai/AGENTS.md`\n- [x] `src/change-detection/AGENTS.md`\n- [x] `src/cli/AGENTS.md`\n- [x] `src/config/AGENTS.md`\n- [x] `src/discovery/AGENTS.md`\n- [x] `src/generation/AGENTS.md`\n- [x] `src/imports/AGENTS.md`\n- [x] `src/installer/AGENTS.md`\n- [x] `src/integration/AGENTS.md`\n- [x] `src/orchestration/AGENTS.md`\n- [x] `src/output/AGENTS.md`\n- [x] `src/quality/AGENTS.md`\n- [x] `src/specify/AGENTS.md`\n- [x] `src/types/AGENTS.md`\n- [x] `src/update/AGENTS.md`\n\n### Depth 1\n- [x] `docs/AGENTS.md`\n- [x] `hooks/AGENTS.md`\n- [x] `scripts/AGENTS.md`\n- [x] `src/AGENTS.md`\n\n### Depth 0\n- [x] `./AGENTS.md` (root)\n\n---\n\n## Phase 3: Root Documents\n\n- [x] `CLAUDE.md`\n\n</project-structure>\nLead with a single bold purpose statement: **[FileName] does X.**\nThen use ## headings to organize the remaining content.\nEvery file MUST include at minimum:\n- A purpose statement (first line, bold)\n- Exported symbols with signatures (under any appropriate heading)\nChoose additional sections based on file content.",
      "systemPrompt": "You are analyzing source code to generate documentation for AI coding assistants.\n\nTASK:\nAnalyze the file and produce a dense, identifier-rich summary. Choose the documentation topics most relevant to THIS specific file. Do not follow a fixed template — adapt your sections to what matters most.\n\nConsider topics such as (choose what applies):\n- What this file IS (its role in the project)\n- Public interface: exported functions, classes, types, constants with signatures\n- Key algorithms, data structures, or state management\n- Integration points and coupling with other modules\n- Configuration, environment, or runtime requirements\n- Error handling strategies or validation boundaries\n- Concurrency, lifecycle, or resource management concerns\n- Domain-specific patterns (middleware chains, event handlers, schema definitions, factories)\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this file\", \"this module\", \"provides\", \"responsible for\", \"is used to\", \"basically\", \"essentially\", \"provides functionality for\"\n- Use the pattern: \"[ExportName] does X\" not \"The ExportName function is responsible for doing X\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Compress descriptions: \"parses YAML frontmatter from .sum files\" not \"responsible for the parsing of YAML-style frontmatter...\"\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- All exported function/class/type/const names MUST appear in the summary exactly as written in source\n- Key parameter types and return types MUST be mentioned\n- Preserve exact casing of identifiers (e.g., buildAgentsMd, not \"build agents md\")\n- Missing any exported identifier is a failure\n\nWHAT TO INCLUDE:\n- All exported function/class/type/const names\n- Parameter types and return types for public functions\n- Key dependencies and what they're used for\n- Notable design patterns (name them explicitly: \"Strategy pattern\", \"Builder pattern\", etc.)\n- Only critical TODOs (security, breaking issues)\n\nWHAT TO EXCLUDE:\n- Internal implementation details\n- Generic descriptions without identifiers\n- Filler phrases and transitions\n\nOUTPUT FORMAT (MANDATORY):\n- Start your response DIRECTLY with the purpose statement — a single bold line: **Purpose statement here.**\n- Do NOT include any preamble, thinking, or meta-commentary before the purpose statement\n- Do NOT say \"Here is...\", \"Now I'll...\", \"Based on my analysis...\", \"Let me create...\", \"Perfect.\"\n- Your response IS the documentation — not a message about the documentation",
      "response": "**Synthesizes all `AGENTS.md` hierarchical documentation into a single unified project specification (`SPEC.md`) with concern-based organization, technical depth enforcement, and traceability to source documents.**\n\n## Specification Structure\n\nOrganized into 12 numbered sections following concern-based architecture:\n\n1. **Project Overview** — purpose, technology stack, problem solved\n2. **Architecture** — RLM pipeline (three phases), module boundaries, data flow patterns, key design decisions\n3. **Public API Surface** — CLI commands, core types (`Config`, `AIBackend`, `ExecutionPlan`, `TraceEvent`), exported functions (discovery, generation, pool execution)\n4. **Data Structures & State** — YAML frontmatter schema (`.sum` files), configuration state (default vendor directories, exclude patterns, binary extensions), in-memory state (`TelemetryLogger`, `TraceWriter`, `ProgressReporter`), serialization formats (run log JSON, trace NDJSON)\n5. **Configuration** — file location (`.agents-reverse-engineer/config.yaml`), Zod schema validation, environment variable overrides (`CLAUDE_CONFIG_DIR`, `ARE_DISABLE_HOOK`), dynamic defaults (concurrency calculation)\n6. **Dependencies** — production dependencies with rationale (`fast-glob`, `ignore`, `isbinaryfile`, `simple-git`, `yaml`, `zod`, `ora`, `picocolors`), development dependencies (`typescript`, `tsx`, `vitest`), peer dependencies (AI CLI tools)\n7. **Behavioral Contracts** — error handling strategy (`AIServiceError` codes, exit codes), retry logic (exponential backoff formula), concurrency model (worker pool pattern, resource limits per subprocess), lifecycle hooks (SessionStart/SessionEnd), resource management (file handles, memory, process cleanup), state persistence (stateless hash-based updates)\n8. **Test Contracts** — module-specific test expectations (subprocess management, retry logic, filter chain, prompt construction, worker pool, hash comparison, quality validation)\n9. **Build Plan** — 12 sequential phases with dependencies, verification criteria, and deliverables (Phase 1: Core Infrastructure → Phase 12: Build & Distribution)\n\n## Synthesis Strategy\n\nEnforces synthesis-only constraint: all claims traceable to source `AGENTS.md` documents via `collectAgentsDocs()` recursive traversal. No invention of features/hooks/patterns not present in source corpus.\n\nStrips conversational preamble via regex patterns before writing output:\n- Matches `/(Here (is|are)|Based on|Now I['']?ll|Let me|I have|Perfect[.!])/i`\n- Strips \"summary of the codebase\" filler phrases\n\n## Output Modes\n\n**Single-file mode** (default): writes `specs/SPEC.md` with all 12 sections\n\n**Multi-file mode** (`--multi-file` flag): splits specification across `specs/<dirname>.md` files based on top-level heading extraction via regex `/^# (.+)$/gm`\n\n## Markdown Processing\n\nParses root `package.json` for project metadata (name, version, description, license). Detects technology stack from dependencies and devDependencies arrays.\n\nFormats technical shorthand:\n- CLI commands: triple-backtick typescript code blocks with function signatures\n- Type definitions: interface/type blocks with JSDoc-style comments\n- Configuration: YAML examples with inline comments\n\n## Error Handling\n\nThrows `SpecExistsError` when target output path exists without `--force` flag. Error includes `paths: string[]` array of conflicting files.\n\nValidates specification completeness via anchor term preservation: all exported function/class/type/const names from source must appear in spec exactly as written.",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 855,
      "cacheReadTokens": 16932,
      "cacheCreationTokens": 25469,
      "latencyMs": 34467,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": [
        {
          "path": "specs/SPEC.md",
          "sizeBytes": 49037
        }
      ]
    },
    {
      "timestamp": "2026-02-09T15:50:44.368Z",
      "prompt": "Analyze this source file and generate a summary that captures what an AI coding assistant needs to know to work with this file effectively.\n\nFile: src/generation/prompts/templates.ts\n\n```typescript\n/**\n * Prompt constants for file and directory analysis.\n */\n\nexport const FILE_SYSTEM_PROMPT = `You are analyzing source code to generate documentation for AI coding assistants.\n\nTASK:\nAnalyze the file and produce a dense, identifier-rich summary. Choose the documentation topics most relevant to THIS specific file. Do not follow a fixed template — adapt your sections to what matters most.\n\nConsider topics such as (choose what applies):\n- What this file IS (its role in the project)\n- Public interface: exported functions, classes, types, constants with signatures\n- Key algorithms, data structures, or state management\n- Integration points and coupling with other modules\n- Configuration, environment, or runtime requirements\n- Error handling strategies or validation boundaries\n- Concurrency, lifecycle, or resource management concerns\n- Domain-specific patterns (middleware chains, event handlers, schema definitions, factories)\n- Behavioral contracts: verbatim regex patterns, format strings, output templates, magic constants, sentinel values, error code strings, environment variable names\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this file\", \"this module\", \"provides\", \"responsible for\", \"is used to\", \"basically\", \"essentially\", \"provides functionality for\"\n- Use the pattern: \"[ExportName] does X\" not \"The ExportName function is responsible for doing X\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Compress descriptions: \"parses YAML frontmatter from .sum files\" not \"responsible for the parsing of YAML-style frontmatter...\"\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- All exported function/class/type/const names MUST appear in the summary exactly as written in source\n- Key parameter types and return types MUST be mentioned\n- Preserve exact casing of identifiers (e.g., buildAgentsMd, not \"build agents md\")\n- Missing any exported identifier is a failure\n\nWHAT TO INCLUDE:\n- All exported function/class/type/const names\n- Parameter types and return types for public functions\n- Key dependencies and what they're used for\n- Notable design patterns (name them explicitly: \"Strategy pattern\", \"Builder pattern\", etc.)\n- Only critical TODOs (security, breaking issues)\n\nWHAT TO EXCLUDE:\n- Control flow minutiae (loop structures, variable naming, temporary state)\n- Generic descriptions without identifiers\n- Filler phrases and transitions\n\nBEHAVIORAL CONTRACTS (NEVER EXCLUDE):\n- Regex patterns for parsing/validation/extraction — include the full pattern verbatim in backticks\n- Format strings, output templates, serialization structures — show exact format\n- Magic constants, sentinel values, numeric thresholds (timeouts, buffer sizes, retry counts)\n- Prompt text or template strings that control AI/LLM behavior\n- Error message patterns and error code strings used for matching\n- Environment variable names and their expected values\n- File format specifications (YAML frontmatter schemas, NDJSON line formats)\nThese define observable behavior that must be reproduced exactly.\n\nOUTPUT FORMAT (MANDATORY):\n- Start your response DIRECTLY with the purpose statement — a single bold line: **Purpose statement here.**\n- Do NOT include any preamble, thinking, or meta-commentary before the purpose statement\n- Do NOT say \"Here is...\", \"Now I'll...\", \"Based on my analysis...\", \"Let me create...\", \"Perfect.\"\n- Your response IS the documentation — not a message about the documentation`;\n\nexport const FILE_USER_PROMPT = `Analyze this source file and generate a summary that captures what an AI coding assistant needs to know to work with this file effectively.\n\nFile: {{FILE_PATH}}\n\n\\`\\`\\`typescript\n{{CONTENT}}\n\\`\\`\\`\n\n\n## Project Structure\n\nFull project file listing for context:\n\n<project-structure>\n# Documentation Generation Plan\n\nGenerated: 2026-02-09\nProject: /home/pascal/wks/agents-reverse-engineer\n\n## Summary\n\n- **Total Tasks**: 126\n- **File Tasks**: 96\n- **Directory Tasks**: 29\n- **Root Tasks**: 1\n- **Traversal**: Post-order (children before parents)\n\n---\n\n## Phase 1: File Analysis (Post-Order Traversal)\n\n### Depth 3: src/ai/backends/ (3 files)\n- [x] `src/ai/backends/claude.ts`\n- [x] `src/ai/backends/gemini.ts`\n- [x] `src/ai/backends/opencode.ts`\n\n### Depth 3: src/ai/telemetry/ (3 files)\n- [x] `src/ai/telemetry/cleanup.ts`\n- [x] `src/ai/telemetry/logger.ts`\n- [x] `src/ai/telemetry/run-log.ts`\n\n### Depth 3: src/discovery/filters/ (5 files)\n- [x] `src/discovery/filters/binary.ts`\n- [x] `src/discovery/filters/custom.ts`\n- [x] `src/discovery/filters/gitignore.ts`\n- [x] `src/discovery/filters/index.ts`\n- [x] `src/discovery/filters/vendor.ts`\n\n### Depth 3: src/generation/prompts/ (4 files)\n- [x] `src/generation/prompts/builder.ts`\n- [x] `src/generation/prompts/index.ts`\n- [x] `src/generation/prompts/templates.ts`\n- [x] `src/generation/prompts/types.ts`\n\n### Depth 3: src/generation/writers/ (3 files)\n- [x] `src/generation/writers/agents-md.ts`\n- [x] `src/generation/writers/index.ts`\n- [x] `src/generation/writers/sum.ts`\n\n### Depth 3: src/quality/density/ (1 files)\n- [x] `src/quality/density/validator.ts`\n\n### Depth 3: src/quality/inconsistency/ (3 files)\n- [x] `src/quality/inconsistency/code-vs-code.ts`\n- [x] `src/quality/inconsistency/code-vs-doc.ts`\n- [x] `src/quality/inconsistency/reporter.ts`\n\n### Depth 3: src/quality/phantom-paths/ (2 files)\n- [x] `src/quality/phantom-paths/index.ts`\n- [x] `src/quality/phantom-paths/validator.ts`\n\n### Depth 2: .github/workflows/ (1 files)\n- [x] `.github/workflows/publish.yml`\n\n### Depth 2: src/ai/ (6 files)\n- [x] `src/ai/index.ts`\n- [x] `src/ai/registry.ts`\n- [x] `src/ai/retry.ts`\n- [x] `src/ai/service.ts`\n- [x] `src/ai/subprocess.ts`\n- [x] `src/ai/types.ts`\n\n### Depth 2: src/change-detection/ (3 files)\n- [x] `src/change-detection/detector.ts`\n- [x] `src/change-detection/index.ts`\n- [x] `src/change-detection/types.ts`\n\n### Depth 2: src/cli/ (7 files)\n- [x] `src/cli/clean.ts`\n- [x] `src/cli/discover.ts`\n- [x] `src/cli/generate.ts`\n- [x] `src/cli/index.ts`\n- [x] `src/cli/init.ts`\n- [x] `src/cli/specify.ts`\n- [x] `src/cli/update.ts`\n\n### Depth 2: src/config/ (3 files)\n- [x] `src/config/defaults.ts`\n- [x] `src/config/loader.ts`\n- [x] `src/config/schema.ts`\n\n### Depth 2: src/discovery/ (3 files)\n- [x] `src/discovery/run.ts`\n- [x] `src/discovery/types.ts`\n- [x] `src/discovery/walker.ts`\n\n### Depth 2: src/generation/ (5 files)\n- [x] `src/generation/collector.ts`\n- [x] `src/generation/complexity.ts`\n- [x] `src/generation/executor.ts`\n- [x] `src/generation/orchestrator.ts`\n- [x] `src/generation/types.ts`\n\n### Depth 2: src/imports/ (3 files)\n- [x] `src/imports/extractor.ts`\n- [x] `src/imports/index.ts`\n- [x] `src/imports/types.ts`\n\n### Depth 2: src/installer/ (7 files)\n- [x] `src/installer/banner.ts`\n- [x] `src/installer/index.ts`\n- [x] `src/installer/operations.ts`\n- [x] `src/installer/paths.ts`\n- [x] `src/installer/prompts.ts`\n- [x] `src/installer/types.ts`\n- [x] `src/installer/uninstall.ts`\n\n### Depth 2: src/integration/ (4 files)\n- [x] `src/integration/detect.ts`\n- [x] `src/integration/generate.ts`\n- [x] `src/integration/templates.ts`\n- [x] `src/integration/types.ts`\n\n### Depth 2: src/orchestration/ (7 files)\n- [x] `src/orchestration/index.ts`\n- [x] `src/orchestration/plan-tracker.ts`\n- [x] `src/orchestration/pool.ts`\n- [x] `src/orchestration/progress.ts`\n- [x] `src/orchestration/runner.ts`\n- [x] `src/orchestration/trace.ts`\n- [x] `src/orchestration/types.ts`\n\n### Depth 2: src/output/ (1 files)\n- [x] `src/output/logger.ts`\n\n### Depth 2: src/quality/ (2 files)\n- [x] `src/quality/index.ts`\n- [x] `src/quality/types.ts`\n\n### Depth 2: src/specify/ (3 files)\n- [x] `src/specify/index.ts`\n- [x] `src/specify/prompts.ts`\n- [x] `src/specify/writer.ts`\n\n### Depth 2: src/types/ (1 files)\n- [x] `src/types/index.ts`\n\n### Depth 2: src/update/ (4 files)\n- [x] `src/update/index.ts`\n- [x] `src/update/orchestrator.ts`\n- [x] `src/update/orphan-cleaner.ts`\n- [x] `src/update/types.ts`\n\n### Depth 1: docs/ (1 files)\n- [x] `docs/INPUT.md`\n\n### Depth 1: hooks/ (4 files)\n- [x] `hooks/are-check-update.js`\n- [x] `hooks/are-session-end.js`\n- [x] `hooks/opencode-are-check-update.js`\n- [x] `hooks/opencode-are-session-end.js`\n\n### Depth 1: scripts/ (1 files)\n- [x] `scripts/build-hooks.js`\n\n### Depth 1: src/ (1 files)\n- [x] `src/version.ts`\n\n### Depth 0: ./ (5 files)\n- [x] `LANGUAGES-MANIFEST.md`\n- [x] `LICENSE`\n- [x] `README.md`\n- [x] `package.json`\n- [x] `tsconfig.json`\n\n---\n\n## Phase 2: Directory AGENTS.md (Post-Order Traversal, 29 directories)\n\n### Depth 3\n- [x] `src/ai/backends/AGENTS.md`\n- [x] `src/ai/telemetry/AGENTS.md`\n- [x] `src/discovery/filters/AGENTS.md`\n- [x] `src/generation/prompts/AGENTS.md`\n- [x] `src/generation/writers/AGENTS.md`\n- [x] `src/quality/density/AGENTS.md`\n- [x] `src/quality/inconsistency/AGENTS.md`\n- [x] `src/quality/phantom-paths/AGENTS.md`\n\n### Depth 2\n- [x] `.github/workflows/AGENTS.md`\n- [x] `src/ai/AGENTS.md`\n- [x] `src/change-detection/AGENTS.md`\n- [x] `src/cli/AGENTS.md`\n- [x] `src/config/AGENTS.md`\n- [x] `src/discovery/AGENTS.md`\n- [x] `src/generation/AGENTS.md`\n- [x] `src/imports/AGENTS.md`\n- [x] `src/installer/AGENTS.md`\n- [x] `src/integration/AGENTS.md`\n- [x] `src/orchestration/AGENTS.md`\n- [x] `src/output/AGENTS.md`\n- [x] `src/quality/AGENTS.md`\n- [x] `src/specify/AGENTS.md`\n- [x] `src/types/AGENTS.md`\n- [x] `src/update/AGENTS.md`\n\n### Depth 1\n- [x] `docs/AGENTS.md`\n- [x] `hooks/AGENTS.md`\n- [x] `scripts/AGENTS.md`\n- [x] `src/AGENTS.md`\n\n### Depth 0\n- [x] `./AGENTS.md` (root)\n\n---\n\n## Phase 3: Root Documents\n\n- [x] `CLAUDE.md`\n\n</project-structure>\nLead with a single bold purpose statement: **[FileName] does X.**\nThen use ## headings to organize the remaining content.\nEvery file MUST include at minimum:\n- A purpose statement (first line, bold)\n- Exported symbols with signatures (under any appropriate heading)\nChoose additional sections based on file content.`;\n\n/**\n * System prompt for directory-level AGENTS.md generation.\n * Used by buildDirectoryPrompt() in builder.ts.\n */\nexport const DIRECTORY_SYSTEM_PROMPT = `You are generating an AGENTS.md file — a directory-level overview for AI coding assistants.\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Write a one-paragraph purpose statement for the directory\nusage\nADAPTIVE SECTIONS:\nAnalyze the directory contents and choose the most relevant sections. Do NOT use a fixed template. Instead, select sections that best document this specific directory for an AI that needs to reconstruct or extend the project.\n\nConsider these section types (choose what applies):\n- **Contents**: Group files by purpose/category under ## headings. For each file: markdown link [filename](./filename) and a one-line description.\n- **Subdirectories**: If subdirectories exist, list them with links [dirname/](./dirname/) and brief summaries.\n- **Architecture / Data Flow**: If files form a pipeline, request/response chain, or layered architecture, document it.\n- **Stack**: If this is a package root (has package.json, Cargo.toml, go.mod, etc.), document the technology stack, key scripts, and entry points.\n- **Structure**: If the directory layout follows a convention (feature-sliced, domain-driven, MVC, etc.), document it.\n- **Patterns**: If files share recurring design patterns (factory, strategy, middleware, barrel re-export), name and document them.\n- **Configuration**: If the directory contains config files, schemas, or environment definitions, document the config surface area.\n- **API Surface**: If the directory exports a public API (barrel index, route definitions, SDK), document the interface contract.\n- **File Relationships**: How files collaborate, depend on each other, or share state.\n- **Behavioral Contracts**: If files contain regex patterns, format specifications, magic constants, or template strings that define observable behavior, collect them in a dedicated section. Preserve verbatim patterns from file summaries — do NOT paraphrase regex into prose. This section is MANDATORY when file summaries contain behavioral artifacts.\n\nChoose any relevant sections or create your own based on the directory contents. The goal is to provide a comprehensive overview that captures the essence of the directory's role in the project and how its files work together, with a focus on what an AI coding assistant would need to know to effectively interact with this code.\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n  (e.g., if the directory is called \"cli\", write \"src/cli/\", NOT \"src/commands/\")\n- Cross-module references must use the specifier format from actual import statements\n  (e.g., \"../generation/writers/sum.js\", NOT \"../fs/sum-file.js\")\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions in Contents sections: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Behavioral contracts (regex patterns, format specs, constants) belong in a separate Behavioral Contracts section, not in per-file descriptions.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context`;\n\n/**\n * System prompt for incremental file summary updates.\n * Used by buildFilePrompt() when existingSum is provided.\n */\nexport const FILE_UPDATE_SYSTEM_PROMPT = `You are updating an existing file summary for an AI coding assistant. The source code has changed and the summary needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING summary and the UPDATED source code\n- Preserve the structure, section headings, and phrasing of the existing summary wherever the underlying code is unchanged\n- Only modify content that is directly affected by the code changes\n- If a section describes code that has not changed, keep it VERBATIM — do not rephrase, reorganize, or \"improve\" stable text\n- Add new sections only if the code changes introduce entirely new concepts\n- Remove sections only if the code they described has been deleted\n- Update signatures, type names, and identifiers to match the current source exactly\n\nBEHAVIORAL CONTRACT PRESERVATION (MANDATORY):\n- Regex patterns, format strings, magic constants, and template content from the existing summary MUST be preserved verbatim unless the source code changed them\n- If source code changes a regex pattern or constant, update the summary to show the NEW value verbatim\n- Never summarize or paraphrase regex patterns — always show the exact pattern in backticks\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this file\", \"this module\", \"provides\", \"responsible for\", \"is used to\", \"basically\", \"essentially\", \"provides functionality for\"\n- Use the pattern: \"[ExportName] does X\" not \"The ExportName function is responsible for doing X\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- All exported function/class/type/const names MUST appear in the summary exactly as written in source\n- Key parameter types and return types MUST be mentioned\n- Preserve exact casing of identifiers\n- Missing any exported identifier is a failure\n\nOUTPUT FORMAT (MANDATORY):\n- Start your response DIRECTLY with the purpose statement — a single bold line: **Purpose statement here.**\n- Do NOT include any preamble, thinking, or meta-commentary before the purpose statement\n- Do NOT say \"Here is...\", \"Now I'll...\", \"Based on my analysis...\", \"Let me create...\", \"Perfect.\"\n- Your response IS the documentation — not a message about the documentation`;\n\n/**\n * System prompt for incremental directory AGENTS.md updates.\n * Used by buildDirectoryPrompt() when existingAgentsMd is provided.\n */\nexport const DIRECTORY_UPDATE_SYSTEM_PROMPT = `You are updating an existing AGENTS.md file — a directory-level overview for AI coding assistants. Some file summaries or subdirectory documents have changed, and AGENTS.md needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING AGENTS.md and the CURRENT file summaries and subdirectory documents\n- Preserve the structure, section headings, and descriptions that are still accurate\n- Only modify entries for files or subdirectories whose summaries have changed\n- Add entries for new files, remove entries for deleted files\n- Do NOT reorganize, rephrase, or restructure sections that are unaffected by changes\n- Keep the same section ordering unless files were added/removed in a way that requires regrouping\n- Behavioral Contracts section: preserve verbatim regex patterns and constants unless source file summaries show they changed\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Preserve the existing purpose statement unless the directory's role has fundamentally changed\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n- Cross-module references must use the specifier format from actual import statements\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context`;\n\n/**\n * System prompt for root CLAUDE.md generation.\n * Used by buildRootPrompt() in builder.ts.\n */\nexport const ROOT_SYSTEM_PROMPT = `You generate markdown documentation files. Output ONLY the raw markdown content.\nDo NOT include any conversational text, preamble, or meta-commentary.\nDo NOT say \"Here is...\" or \"I've generated...\" — just output the document itself.\nThe output will be written directly to a file.\n\nCRITICAL CONSTRAINT:\n- Synthesize ONLY from the AGENTS.md content provided in the user prompt\n- Do NOT invent, extrapolate, or hallucinate features, hooks, APIs, patterns, or dependencies not explicitly mentioned\n- If information is missing, omit that section rather than guessing\n- Every claim must be traceable to a specific AGENTS.md file provided`;\n\n```\n\n\n## Project Structure\n\nFull project file listing for context:\n\n<project-structure>\n# Documentation Generation Plan\n\nGenerated: 2026-02-09\nProject: /home/pascal/wks/agents-reverse-engineer\n\n## Summary\n\n- **Total Tasks**: 126\n- **File Tasks**: 96\n- **Directory Tasks**: 29\n- **Root Tasks**: 1\n- **Traversal**: Post-order (children before parents)\n\n---\n\n## Phase 1: File Analysis (Post-Order Traversal)\n\n### Depth 3: src/ai/backends/ (3 files)\n- [x] `src/ai/backends/claude.ts`\n- [x] `src/ai/backends/gemini.ts`\n- [x] `src/ai/backends/opencode.ts`\n\n### Depth 3: src/ai/telemetry/ (3 files)\n- [x] `src/ai/telemetry/cleanup.ts`\n- [x] `src/ai/telemetry/logger.ts`\n- [x] `src/ai/telemetry/run-log.ts`\n\n### Depth 3: src/discovery/filters/ (5 files)\n- [x] `src/discovery/filters/binary.ts`\n- [x] `src/discovery/filters/custom.ts`\n- [x] `src/discovery/filters/gitignore.ts`\n- [x] `src/discovery/filters/index.ts`\n- [x] `src/discovery/filters/vendor.ts`\n\n### Depth 3: src/generation/prompts/ (4 files)\n- [x] `src/generation/prompts/builder.ts`\n- [x] `src/generation/prompts/index.ts`\n- [x] `src/generation/prompts/templates.ts`\n- [x] `src/generation/prompts/types.ts`\n\n### Depth 3: src/generation/writers/ (3 files)\n- [x] `src/generation/writers/agents-md.ts`\n- [x] `src/generation/writers/index.ts`\n- [x] `src/generation/writers/sum.ts`\n\n### Depth 3: src/quality/density/ (1 files)\n- [x] `src/quality/density/validator.ts`\n\n### Depth 3: src/quality/inconsistency/ (3 files)\n- [x] `src/quality/inconsistency/code-vs-code.ts`\n- [x] `src/quality/inconsistency/code-vs-doc.ts`\n- [x] `src/quality/inconsistency/reporter.ts`\n\n### Depth 3: src/quality/phantom-paths/ (2 files)\n- [x] `src/quality/phantom-paths/index.ts`\n- [x] `src/quality/phantom-paths/validator.ts`\n\n### Depth 2: .github/workflows/ (1 files)\n- [x] `.github/workflows/publish.yml`\n\n### Depth 2: src/ai/ (6 files)\n- [x] `src/ai/index.ts`\n- [x] `src/ai/registry.ts`\n- [x] `src/ai/retry.ts`\n- [x] `src/ai/service.ts`\n- [x] `src/ai/subprocess.ts`\n- [x] `src/ai/types.ts`\n\n### Depth 2: src/change-detection/ (3 files)\n- [x] `src/change-detection/detector.ts`\n- [x] `src/change-detection/index.ts`\n- [x] `src/change-detection/types.ts`\n\n### Depth 2: src/cli/ (7 files)\n- [x] `src/cli/clean.ts`\n- [x] `src/cli/discover.ts`\n- [x] `src/cli/generate.ts`\n- [x] `src/cli/index.ts`\n- [x] `src/cli/init.ts`\n- [x] `src/cli/specify.ts`\n- [x] `src/cli/update.ts`\n\n### Depth 2: src/config/ (3 files)\n- [x] `src/config/defaults.ts`\n- [x] `src/config/loader.ts`\n- [x] `src/config/schema.ts`\n\n### Depth 2: src/discovery/ (3 files)\n- [x] `src/discovery/run.ts`\n- [x] `src/discovery/types.ts`\n- [x] `src/discovery/walker.ts`\n\n### Depth 2: src/generation/ (5 files)\n- [x] `src/generation/collector.ts`\n- [x] `src/generation/complexity.ts`\n- [x] `src/generation/executor.ts`\n- [x] `src/generation/orchestrator.ts`\n- [x] `src/generation/types.ts`\n\n### Depth 2: src/imports/ (3 files)\n- [x] `src/imports/extractor.ts`\n- [x] `src/imports/index.ts`\n- [x] `src/imports/types.ts`\n\n### Depth 2: src/installer/ (7 files)\n- [x] `src/installer/banner.ts`\n- [x] `src/installer/index.ts`\n- [x] `src/installer/operations.ts`\n- [x] `src/installer/paths.ts`\n- [x] `src/installer/prompts.ts`\n- [x] `src/installer/types.ts`\n- [x] `src/installer/uninstall.ts`\n\n### Depth 2: src/integration/ (4 files)\n- [x] `src/integration/detect.ts`\n- [x] `src/integration/generate.ts`\n- [x] `src/integration/templates.ts`\n- [x] `src/integration/types.ts`\n\n### Depth 2: src/orchestration/ (7 files)\n- [x] `src/orchestration/index.ts`\n- [x] `src/orchestration/plan-tracker.ts`\n- [x] `src/orchestration/pool.ts`\n- [x] `src/orchestration/progress.ts`\n- [x] `src/orchestration/runner.ts`\n- [x] `src/orchestration/trace.ts`\n- [x] `src/orchestration/types.ts`\n\n### Depth 2: src/output/ (1 files)\n- [x] `src/output/logger.ts`\n\n### Depth 2: src/quality/ (2 files)\n- [x] `src/quality/index.ts`\n- [x] `src/quality/types.ts`\n\n### Depth 2: src/specify/ (3 files)\n- [x] `src/specify/index.ts`\n- [x] `src/specify/prompts.ts`\n- [x] `src/specify/writer.ts`\n\n### Depth 2: src/types/ (1 files)\n- [x] `src/types/index.ts`\n\n### Depth 2: src/update/ (4 files)\n- [x] `src/update/index.ts`\n- [x] `src/update/orchestrator.ts`\n- [x] `src/update/orphan-cleaner.ts`\n- [x] `src/update/types.ts`\n\n### Depth 1: docs/ (1 files)\n- [x] `docs/INPUT.md`\n\n### Depth 1: hooks/ (4 files)\n- [x] `hooks/are-check-update.js`\n- [x] `hooks/are-session-end.js`\n- [x] `hooks/opencode-are-check-update.js`\n- [x] `hooks/opencode-are-session-end.js`\n\n### Depth 1: scripts/ (1 files)\n- [x] `scripts/build-hooks.js`\n\n### Depth 1: src/ (1 files)\n- [x] `src/version.ts`\n\n### Depth 0: ./ (5 files)\n- [x] `LANGUAGES-MANIFEST.md`\n- [x] `LICENSE`\n- [x] `README.md`\n- [x] `package.json`\n- [x] `tsconfig.json`\n\n---\n\n## Phase 2: Directory AGENTS.md (Post-Order Traversal, 29 directories)\n\n### Depth 3\n- [x] `src/ai/backends/AGENTS.md`\n- [x] `src/ai/telemetry/AGENTS.md`\n- [x] `src/discovery/filters/AGENTS.md`\n- [x] `src/generation/prompts/AGENTS.md`\n- [x] `src/generation/writers/AGENTS.md`\n- [x] `src/quality/density/AGENTS.md`\n- [x] `src/quality/inconsistency/AGENTS.md`\n- [x] `src/quality/phantom-paths/AGENTS.md`\n\n### Depth 2\n- [x] `.github/workflows/AGENTS.md`\n- [x] `src/ai/AGENTS.md`\n- [x] `src/change-detection/AGENTS.md`\n- [x] `src/cli/AGENTS.md`\n- [x] `src/config/AGENTS.md`\n- [x] `src/discovery/AGENTS.md`\n- [x] `src/generation/AGENTS.md`\n- [x] `src/imports/AGENTS.md`\n- [x] `src/installer/AGENTS.md`\n- [x] `src/integration/AGENTS.md`\n- [x] `src/orchestration/AGENTS.md`\n- [x] `src/output/AGENTS.md`\n- [x] `src/quality/AGENTS.md`\n- [x] `src/specify/AGENTS.md`\n- [x] `src/types/AGENTS.md`\n- [x] `src/update/AGENTS.md`\n\n### Depth 1\n- [x] `docs/AGENTS.md`\n- [x] `hooks/AGENTS.md`\n- [x] `scripts/AGENTS.md`\n- [x] `src/AGENTS.md`\n\n### Depth 0\n- [x] `./AGENTS.md` (root)\n\n---\n\n## Phase 3: Root Documents\n\n- [x] `CLAUDE.md`\n\n</project-structure>\nLead with a single bold purpose statement: **[FileName] does X.**\nThen use ## headings to organize the remaining content.\nEvery file MUST include at minimum:\n- A purpose statement (first line, bold)\n- Exported symbols with signatures (under any appropriate heading)\nChoose additional sections based on file content.\n\n## Existing Summary (update this — preserve stable content, modify only what changed)\n\n**templates.ts exports system and user prompt constants for the three-phase AI-driven documentation generation pipeline, defining density rules, anchor term preservation, and output format constraints for file summaries, directory AGENTS.md aggregation, and root document synthesis.**\n\n## Exported Constants\n\n### Phase 1: File Analysis Prompts\n\n**FILE_SYSTEM_PROMPT**: string constant containing system-level instructions for AI subprocesses analyzing individual source files. Enforces density rules (every sentence must reference identifiers, ban filler phrases like \"this file\" / \"provides\" / \"responsible for\"), anchor term preservation (exported function/class/type/const names must appear exactly as written with correct casing), and output format requirements (start with bold purpose statement, no preamble/meta-commentary). Specifies adaptive documentation topics: public interface with signatures, algorithms, data structures, integration points, configuration, error handling, concurrency, lifecycle, domain patterns (middleware chains, event handlers, schema definitions, factories). Mandates including all exported symbols with parameter/return types and key dependencies while excluding internal implementation details and generic descriptions.\n\n**FILE_USER_PROMPT**: string template containing user-level prompt structure for file analysis tasks. Includes placeholders `{{FILE_PATH}}` and `{{CONTENT}}` for injection via `builder.ts`. Embeds full project structure tree (37 directories, 68 files) under `<project-structure>` XML tags for cross-file context. Specifies minimum documentation requirements: bold purpose statement on first line, exported symbols with signatures under `##` headings, additional sections chosen based on file content.\n\n**FILE_UPDATE_SYSTEM_PROMPT**: string constant for incremental file summary updates during `are update` workflow. Adds incremental update rules: preserve existing structure/section headings/phrasing verbatim where code unchanged, modify only content directly affected by changes, avoid rephrasing stable text, add/remove sections only when code introduces/deletes concepts, update signatures/types/identifiers to match current source exactly. Inherits density rules, anchor term preservation, and output format from FILE_SYSTEM_PROMPT.\n\n### Phase 2: Directory Aggregation Prompts\n\n**DIRECTORY_SYSTEM_PROMPT**: string constant for generating directory-level AGENTS.md files from child .sum files and subdirectory AGENTS.md content. Mandates first line `<!-- Generated by agents-reverse-engineer -->` marker followed by `#` heading with directory name and one-paragraph purpose statement. Specifies adaptive section selection (not fixed template): Contents (group files by purpose with markdown links `[filename](./filename)` and one-line descriptions), Subdirectories (links `[dirname/](./dirname/)` with brief summaries), Architecture/Data Flow (pipeline/layered patterns), Stack (package root with technology stack/scripts/entry points), Structure (conventions like feature-sliced/domain-driven/MVC), Patterns (factory/strategy/middleware/barrel re-export), Configuration (config surface area), API Surface (barrel index/route definitions/SDK), File Relationships (collaboration/dependencies/shared state). Enforces path accuracy constraints: use only paths from \"Import Map\" section, exact directory names from \"Project Directory Structure\", actual import statement specifiers, omit cross-references if unsure rather than guessing. Adds consistency rules: no self-contradiction, no technique renaming (e.g., \"regex-based\" vs \"AST-based\"), use only values from file summaries. Defines scope: AGENTS.md as navigational index for finding files quickly, focus on file purposes/relationships/directory-level patterns, avoid reproducing full architecture (belongs in root CLAUDE.md). Handles User Notes: automatically prepended to output, do not repeat/paraphrase in generated content.\n\n**DIRECTORY_UPDATE_SYSTEM_PROMPT**: string constant for incremental AGENTS.md updates when child .sum files or subdirectory documents change. Adds incremental update rules: preserve structure/headings/descriptions still accurate, modify only entries for changed summaries, add/remove entries for new/deleted files, avoid reorganizing unaffected sections, keep section ordering unless regrouping required by additions/deletions. Inherits path accuracy, consistency, density, anchor term preservation, scope, and User Notes handling from DIRECTORY_SYSTEM_PROMPT.\n\n### Phase 3: Root Document Synthesis Prompt\n\n**ROOT_SYSTEM_PROMPT**: string constant for generating root integration documents (CLAUDE.md, GEMINI.md, OPENCODE.md) from directory AGENTS.md corpus. Mandates output ONLY raw markdown content with no conversational text/preamble/meta-commentary (e.g., ban \"Here is...\" / \"I've generated...\"), written directly to file. Enforces critical constraint: synthesize ONLY from AGENTS.md content in user prompt, do not invent/extrapolate/hallucinate features/hooks/APIs/patterns/dependencies not explicitly mentioned, omit missing sections rather than guessing, every claim must be traceable to specific AGENTS.md file provided.\n\n## Design Patterns\n\n**Template Method Pattern**: Separate system prompts (role/constraints) from user prompts (data/context) for AI subprocess invocations, allowing `builder.ts` to compose them independently.\n\n**Constraint-Driven Generation**: Prompts encode mandatory rules (DENSITY RULES, ANCHOR TERM PRESERVATION, OUTPUT FORMAT) as structured sections with ALL CAPS headings, reducing hallucination and enforcing consistency across concurrent worker pool executions.\n\n**Incremental Update Strategy**: Separate `_UPDATE_SYSTEM_PROMPT` variants for file and directory phases preserve existing content structure during `are update` workflow, minimizing unnecessary churn in version control and maintaining human-authored phrasing where code unchanged.\n\n## Integration Points\n\n**builder.ts**: Consumes FILE_SYSTEM_PROMPT, FILE_USER_PROMPT, FILE_UPDATE_SYSTEM_PROMPT, DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT, ROOT_SYSTEM_PROMPT via `buildFilePrompt()`, `buildDirectoryPrompt()`, `buildRootPrompt()` factory functions that inject runtime context (file paths, content, import maps, existing summaries, project structure).\n\n**orchestrator.ts**: Threads prompts through three-phase pipeline executor coordinating Phase 1 concurrent file analysis, Phase 2 post-order directory aggregation, Phase 3 sequential root document synthesis.\n\n**AIService**: Passes system/user prompt pairs to `runSubprocess()` for subprocess invocation with resource limits (NODE_OPTIONS, UV_THREADPOOL_SIZE, CLAUDE_CODE_DISABLE_BACKGROUND_TASKS, --disallowedTools Task).",
      "systemPrompt": "You are updating an existing file summary for an AI coding assistant. The source code has changed and the summary needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING summary and the UPDATED source code\n- Preserve the structure, section headings, and phrasing of the existing summary wherever the underlying code is unchanged\n- Only modify content that is directly affected by the code changes\n- If a section describes code that has not changed, keep it VERBATIM — do not rephrase, reorganize, or \"improve\" stable text\n- Add new sections only if the code changes introduce entirely new concepts\n- Remove sections only if the code they described has been deleted\n- Update signatures, type names, and identifiers to match the current source exactly\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this file\", \"this module\", \"provides\", \"responsible for\", \"is used to\", \"basically\", \"essentially\", \"provides functionality for\"\n- Use the pattern: \"[ExportName] does X\" not \"The ExportName function is responsible for doing X\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- All exported function/class/type/const names MUST appear in the summary exactly as written in source\n- Key parameter types and return types MUST be mentioned\n- Preserve exact casing of identifiers\n- Missing any exported identifier is a failure\n\nOUTPUT FORMAT (MANDATORY):\n- Start your response DIRECTLY with the purpose statement — a single bold line: **Purpose statement here.**\n- Do NOT include any preamble, thinking, or meta-commentary before the purpose statement\n- Do NOT say \"Here is...\", \"Now I'll...\", \"Based on my analysis...\", \"Let me create...\", \"Perfect.\"\n- Your response IS the documentation — not a message about the documentation",
      "response": "**templates.ts exports six string constants defining system and user prompts for ARE's three-phase AI-driven documentation pipeline: FILE_SYSTEM_PROMPT, FILE_USER_PROMPT, FILE_UPDATE_SYSTEM_PROMPT for Phase 1 file analysis; DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT for Phase 2 directory aggregation; ROOT_SYSTEM_PROMPT for Phase 3 root synthesis.**\n\n## Exported Constants\n\n### Phase 1: File Analysis\n\n**FILE_SYSTEM_PROMPT**: System prompt for AI subprocesses analyzing individual source files. Enforces density rules: every sentence must reference specific identifiers (function/class/type/constant names), bans filler phrases matching patterns `/this file|this module|provides|responsible for|is used to|basically|essentially|provides functionality for/`. Mandates anchor term preservation: all exported symbols must appear exactly as written in source with correct casing, parameter types and return types must be mentioned. Specifies output format: start directly with bold purpose statement `**[FileName] does X.**`, no preamble/meta-commentary/conversational text. Defines adaptive documentation topics (choose based on file content): public interface with signatures, algorithms/data structures, integration points/coupling, configuration/environment requirements, error handling/validation, concurrency/lifecycle/resource management, domain-specific patterns (middleware chains/event handlers/schema definitions/factories), behavioral contracts (verbatim regex patterns, format strings, output templates, magic constants, sentinel values, error code strings, environment variable names). Mandates including all exported symbols with parameter/return types and key dependencies while excluding control flow minutiae, generic descriptions without identifiers, filler transitions. Distinguishes behavioral contracts as observable behavior requiring exact reproduction.\n\n**FILE_USER_PROMPT**: User prompt template for file analysis with placeholders `{{FILE_PATH}}` and `{{CONTENT}}` injected by `buildFilePrompt()` in `builder.ts`. Embeds full project structure from GENERATION-PLAN.md under `<project-structure>` XML tags showing 126 total tasks (96 file, 29 directory, 1 root) across depth-organized sections (Depth 3: `src/ai/backends/`, `src/ai/telemetry/`, `src/discovery/filters/`, `src/generation/prompts/`, `src/generation/writers/`, `src/quality/density/`, `src/quality/inconsistency/`, `src/quality/phantom-paths/`; Depth 2: `.github/workflows/`, 15 src/ subdirectories; Depth 1: `docs/`, `hooks/`, `scripts/`, `src/`; Depth 0: root). Specifies minimum requirements: bold purpose statement first line, exported symbols with signatures under `##` headings, additional sections chosen based on content.\n\n**FILE_UPDATE_SYSTEM_PROMPT**: System prompt for incremental file summary updates during `are update` workflow. Adds incremental update rules: preserve existing summary structure/section headings/phrasing verbatim where underlying code unchanged, modify only content directly affected by changes, keep stable sections VERBATIM without rephrasing/reorganizing/improving, add new sections only if code introduces entirely new concepts, remove sections only if described code deleted, update signatures/type names/identifiers to match current source exactly. Adds behavioral contract preservation rule: regex patterns, format strings, magic constants, template content from existing summary must be preserved verbatim unless source code changed them, show NEW value verbatim if source changed, never summarize/paraphrase regex patterns. Inherits density rules (identifier-per-sentence, filler phrase bans, technical shorthand), anchor term preservation (exported names with exact casing, parameter/return types), output format (direct purpose statement, no preamble) from FILE_SYSTEM_PROMPT.\n\n### Phase 2: Directory Aggregation\n\n**DIRECTORY_SYSTEM_PROMPT**: System prompt for generating directory-level AGENTS.md files from child `.sum` files and subdirectory `AGENTS.md` content. Mandates output format: start with exactly `<!-- Generated by agents-reverse-engineer -->` marker, use `#` heading with directory name, write one-paragraph purpose statement. Specifies adaptive section selection (not fixed template): Contents (group files by purpose under `##` headings, markdown link format `[filename](./filename)` with one-line descriptions, 1-2 sentences max per file), Subdirectories (link format `[dirname/](./dirname/)` with brief summaries, 1-2 sentences max), Architecture/Data Flow (pipeline/request-response chain/layered architecture), Stack (if package root with package.json/Cargo.toml/go.mod/pyproject.toml/pom.xml/build.gradle/Gemfile/composer.json/CMakeLists.txt/Makefile, document technology stack/key scripts/entry points), Structure (if layout follows convention like feature-sliced/domain-driven/MVC), Patterns (if files share factory/strategy/middleware/barrel re-export patterns, name and document), Configuration (config files/schemas/environment definitions), API Surface (barrel index/route definitions/SDK interface contract), File Relationships (collaboration/dependencies/shared state), Behavioral Contracts (mandatory when file summaries contain behavioral artifacts: regex patterns, format specifications, magic constants, template strings; preserve verbatim patterns from file summaries without paraphrasing). Enforces path accuracy constraints: use ONLY paths from \"Import Map\" section, do not invent/rename/guess module paths, use exact directory names from \"Project Directory Structure\", cross-module references must use specifier format from actual import statements, omit cross-reference if unsure rather than guessing. Adds consistency rules: no self-contradiction within document, preserve technique naming (e.g., if called \"regex-based\" initially, do not call \"AST-based\" later), use ONLY version numbers/engines/config fields present in file summaries. Defines scope: AGENTS.md as navigational index helping AI find files quickly, focus on file purposes/relationships/directory-level patterns, do NOT reproduce full architecture sections (belong in root CLAUDE.md). Handles User Notes: if provided, contain user-defined instructions automatically prepended to output, do NOT repeat/paraphrase user notes in generated content (included separately), may reference for context. Inherits density rules: identifier-per-sentence, ban filler phrases matching `/this directory|this module|provides|responsible for|is used to/`, technical shorthand, per-file descriptions 1-2 sentences max (reference key symbols without reproducing full summaries), subdirectory descriptions 1-2 sentences max (capture role not full contents), behavioral contracts in separate section not per-file descriptions. Inherits anchor term preservation: key exported symbols from file summaries must appear with exact casing.\n\n**DIRECTORY_UPDATE_SYSTEM_PROMPT**: System prompt for incremental AGENTS.md updates when child `.sum` files or subdirectory documents change. Adds incremental update rules: preserve existing AGENTS.md structure/section headings/descriptions that are still accurate, modify only entries for files/subdirectories whose summaries changed, add entries for new files, remove entries for deleted files, do NOT reorganize/rephrase/restructure unaffected sections, keep same section ordering unless file additions/removals require regrouping, Behavioral Contracts section must preserve verbatim regex patterns/constants unless source file summaries show changes. Inherits output format (raw markdown only, no code fences/preamble/explanations/conversational text, entire response IS AGENTS.md content, first line exactly `<!-- Generated by agents-reverse-engineer -->`), scope (navigational index, focus on file purposes/relationships/patterns, avoid full architecture sections), path accuracy (use only Import Map paths, exact directory names, actual import specifiers, omit if unsure), consistency (no self-contradiction, preserve technique naming, use only values from file summaries), density rules (identifier-per-sentence, filler phrase bans, technical shorthand, 1-2 sentence max per-file/subdirectory descriptions), anchor term preservation (key exported symbols with exact casing), User Notes handling from DIRECTORY_SYSTEM_PROMPT.\n\n### Phase 3: Root Document Synthesis\n\n**ROOT_SYSTEM_PROMPT**: System prompt for generating root integration documents (CLAUDE.md, GEMINI.md, OPENCODE.md) from directory AGENTS.md corpus. Mandates output format: output ONLY raw markdown content, no conversational text/preamble/meta-commentary, ban phrases matching `/Here is|I've generated/`, output written directly to file. Enforces critical constraint: synthesize ONLY from AGENTS.md content provided in user prompt, do NOT invent/extrapolate/hallucinate features/hooks/APIs/patterns/dependencies not explicitly mentioned, if information missing omit section rather than guessing, every claim must be traceable to specific AGENTS.md file provided.\n\n## Behavioral Contracts\n\n**Filler phrase ban patterns** (enforced across FILE_SYSTEM_PROMPT, FILE_UPDATE_SYSTEM_PROMPT, DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT):\n- File prompts: `/this file|this module|provides|responsible for|is used to|basically|essentially|provides functionality for/`\n- Directory prompts: `/this directory|this module|provides|responsible for|is used to/`\n\n**Output format markers**:\n- Purpose statement pattern: `**[FileName] does X.**` (FILE_SYSTEM_PROMPT, FILE_UPDATE_SYSTEM_PROMPT)\n- Generated marker pattern: `<!-- Generated by agents-reverse-engineer -->` (DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT)\n- Banned conversational patterns: `/Here is|I've generated|Now I'll|Based on my analysis|Let me create|Perfect\\./` (FILE_SYSTEM_PROMPT, FILE_UPDATE_SYSTEM_PROMPT, ROOT_SYSTEM_PROMPT)\n\n**Link formats** (DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT):\n- File links: `[filename](./filename)`\n- Subdirectory links: `[dirname/](./dirname/)`\n\n**Manifest file types** (DIRECTORY_SYSTEM_PROMPT Stack section): package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt, Makefile (9 types enumerated)\n\n**XML tag markers** (FILE_USER_PROMPT): `<project-structure>` wraps embedded GENERATION-PLAN.md content\n\n## Design Patterns\n\n**Template Method Pattern**: Separate system prompts (role/constraints) from user prompts (data/context) for AI subprocess invocations, composed independently by `buildFilePrompt()`, `buildDirectoryPrompt()`, `buildRootPrompt()` in `builder.ts`.\n\n**Constraint-Driven Generation**: Prompts encode mandatory rules (DENSITY RULES, ANCHOR TERM PRESERVATION, OUTPUT FORMAT) as structured sections with ALL CAPS headings, reducing hallucination and enforcing consistency across concurrent worker pool executions.\n\n**Incremental Update Strategy**: Separate `_UPDATE_SYSTEM_PROMPT` variants (FILE_UPDATE_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT) for file and directory phases preserve existing content structure during `are update` workflow, minimizing version control churn and maintaining human-authored phrasing where code unchanged.\n\n**Adaptive Documentation**: DIRECTORY_SYSTEM_PROMPT mandates choosing relevant sections (Contents/Subdirectories/Architecture/Stack/Structure/Patterns/Configuration/API Surface/File Relationships/Behavioral Contracts) based on directory contents rather than following fixed template, optimizing for navigational utility.\n\n## Integration Points\n\n**builder.ts**: Imports all six constants, injects runtime context (file paths via `{{FILE_PATH}}`, content via `{{CONTENT}}`, import maps, existing summaries, project structure) into prompt templates via `buildFilePrompt()`, `buildDirectoryPrompt()`, `buildRootPrompt()` factory functions.\n\n**orchestrator.ts**: Threads prompts through `executeThreePhaseGeneration()` coordinating Phase 1 concurrent file analysis (FILE_SYSTEM_PROMPT/FILE_USER_PROMPT or FILE_UPDATE_SYSTEM_PROMPT), Phase 2 post-order directory aggregation (DIRECTORY_SYSTEM_PROMPT or DIRECTORY_UPDATE_SYSTEM_PROMPT), Phase 3 sequential root synthesis (ROOT_SYSTEM_PROMPT).\n\n**AIService.call()**: Receives system/user prompt pairs from builder functions, passes to `runSubprocess()` for subprocess invocation with resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`, `--disallowedTools Task`).\n\n**update/orchestrator.ts**: Consumes FILE_UPDATE_SYSTEM_PROMPT and DIRECTORY_UPDATE_SYSTEM_PROMPT for incremental regeneration workflow when `are update` detects changed files via SHA-256 hash comparison.",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 3046,
      "cacheReadTokens": 16334,
      "cacheCreationTokens": 19246,
      "latencyMs": 61346,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": [
        {
          "path": "src/generation/prompts/templates.ts",
          "sizeBytes": 16146
        }
      ]
    },
    {
      "timestamp": "2026-02-09T15:51:45.731Z",
      "prompt": "Generate AGENTS.md for directory: \"src/generation/prompts\" (prompts)\n\n## File Summaries (4 files)\n\n### builder.ts\n**Purpose:** builder.ts constructs AI prompts for the three-phase documentation pipeline: `buildFilePrompt` generates per-file ana...\n\n**builder.ts constructs AI prompts for the three-phase documentation pipeline: `buildFilePrompt` generates per-file analysis prompts with optional import context and incremental update support, `buildDirectoryPrompt` aggregates .sum files and child AGENTS.md into directory-level synthesis prompts with manifest detection and import maps, `buildRootPrompt` collects all AGENTS.md files and package.json metadata for project-wide overview generation.**\n\n## Exported Functions\n\n### buildFilePrompt\n```typescript\nfunction buildFilePrompt(context: PromptContext, debug = false): {\n  system: string;\n  user: string;\n}\n```\nConstructs prompt pair (system + user messages) for Phase 1 file analysis. Reads `context.filePath`, `context.content`, `context.projectPlan` (optional), `context.contextFiles[]` (optional), `context.existingSum` (optional). Calls `detectLanguage()` for syntax highlighting hint. Replaces placeholders in `FILE_USER_PROMPT`: `{{FILE_PATH}}`, `{{CONTENT}}`, `{{LANG}}`, `{{PROJECT_PLAN_SECTION}}`. Appends \"Related Files\" section when `context.contextFiles` is populated. For incremental updates (when `context.existingSum` present), appends existing summary section and returns `FILE_UPDATE_SYSTEM_PROMPT` instead of `FILE_SYSTEM_PROMPT`. Logs via `logTemplate()` when `debug=true`.\n\n### buildDirectoryPrompt\n```typescript\nasync function buildDirectoryPrompt(\n  dirPath: string,\n  projectRoot: string,\n  debug = false,\n  knownDirs?: Set<string>,\n  projectStructure?: string,\n  existingAgentsMd?: string,\n): Promise<{ system: string; user: string }>\n```\nConstructs prompt for Phase 2 directory aggregation into AGENTS.md. Calls `readdir()` to enumerate entries, filters via `knownDirs` set (when provided) to skip untracked subdirectories. Reads all .sum files in parallel via `getSumPath()` + `readSumFile()`, child AGENTS.md files, AGENTS.local.md (user documentation preservation). Detects manifest files via hardcoded array: `package.json`, `Cargo.toml`, `go.mod`, `pyproject.toml`, `pom.xml`, `build.gradle`, `Gemfile`, `composer.json`, `CMakeLists.txt`, `Makefile`. Calls `extractDirectoryImports()` for source files matching `/\\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, formats via `formatImportMap()`. Appends \"Project Directory Structure\" section when `projectStructure` provided. For incremental updates (when `existingAgentsMd` present), appends existing content and returns `DIRECTORY_UPDATE_SYSTEM_PROMPT` instead of `DIRECTORY_SYSTEM_PROMPT`. Returns user prompt with sections: File Summaries, Import Map, Subdirectories, Directory Hints (manifests), User Notes (AGENTS.local.md or existing non-generated AGENTS.md). Checks for `GENERATED_MARKER` to distinguish user-authored AGENTS.md from generated versions.\n\n### buildRootPrompt\n```typescript\nasync function buildRootPrompt(\n  projectRoot: string,\n  debug = false,\n): Promise<{ system: string; user: string }>\n```\nConstructs prompt for Phase 3 root document synthesis (CLAUDE.md/GEMINI.md/OPENCODE.md). Calls `collectAgentsDocs()` to recursively gather all AGENTS.md files with relative paths. Reads root package.json via `readFile()`, extracts `name`, `version`, `description`, `packageManager`, `scripts` object. Builds user prompt with sections: AGENTS.md Files (aggregated content), Package Metadata (JSON fields), Output Requirements (architecture, getting started, key technologies). Returns `ROOT_SYSTEM_PROMPT` as system message. Enforces synthesis-only constraint via user instructions: \"Do NOT invent features, hooks, patterns, or APIs that are not explicitly mentioned in the AGENTS.md content.\"\n\n### detectLanguage\n```typescript\nfunction detectLanguage(filePath: string): string\n```\nMaps file extension to syntax highlighting identifier. Uses `path.extname()` and hardcoded `langMap` object with 20 entries: `.ts` → `typescript`, `.tsx` → `tsx`, `.js` → `javascript`, `.jsx` → `jsx`, `.py` → `python`, `.rb` → `ruby`, `.go` → `go`, `.rs` → `rust`, `.java` → `java`, `.kt` → `kotlin`, `.swift` → `swift`, `.cs` → `csharp`, `.php` → `php`, `.vue` → `vue`, `.svelte` → `svelte`, `.json` → `json`, `.yaml`/`.yml` → `yaml`, `.md` → `markdown`, `.css` → `css`, `.scss` → `scss`, `.html` → `html`. Returns `'text'` for unmapped extensions.\n\n## Incremental Update Strategy\n\n`buildFilePrompt` and `buildDirectoryPrompt` switch to update-specific system prompts when existing content detected. File updates use `FILE_UPDATE_SYSTEM_PROMPT` + appended `context.existingSum`, directory updates use `DIRECTORY_UPDATE_SYSTEM_PROMPT` + appended `existingAgentsMd`. Prompts instruct: \"preserve stable content, modify only what changed\" to minimize unnecessary rewrites.\n\n## Dependencies\n\nImports `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`, `ROOT_SYSTEM_PROMPT` from `./templates.js` (static prompt templates). Calls `readSumFile()`, `getSumPath()` from `../writers/sum.js`, `GENERATED_MARKER` constant from `../writers/agents-md.js`, `extractDirectoryImports()`, `formatImportMap()` from `../../imports/index.js`, `collectAgentsDocs()` from `../collector.js`. Uses `picocolors` for debug logging via `logTemplate()`.\n\n## Debug Logging\n\nInternal `logTemplate()` function logs when `debug=true` via `console.error()`. Formats: `[prompt] buildFilePrompt → path lang=typescript`, `[prompt] buildDirectoryPrompt → path files=5 subdirs=2 imports=8`. All logs dim via `pc.dim()` to reduce visual noise.\n\n## User Documentation Preservation\n\n`buildDirectoryPrompt` checks for AGENTS.local.md first, falls back to non-generated AGENTS.md (missing `GENERATED_MARKER`). Appends user content as \"User Notes\" section with file reference. First-run detection renames user AGENTS.md → AGENTS.local.md (handled by caller, not this module).\n### index.ts\n**Purpose:** Public interface module re-exporting prompt building functions, types, and guidelines for the three-phase documentati...\n\n**Public interface module re-exporting prompt building functions, types, and guidelines for the three-phase documentation generation pipeline.**\n\n## Exports\n\n- **PromptContext** (type): Re-exported from `./types.js`, defines input structure for prompt builders containing file/directory metadata, import maps, child summaries, and manifest detection results\n- **SUMMARY_GUIDELINES** (constant): Re-exported from `./types.js`, contains density rules and formatting constraints embedded in AI prompts to enforce identifier-rich, filler-free documentation\n- **buildFilePrompt** (function): Re-exported from `./builder.js`, constructs Phase 1 prompts for per-file `.sum` analysis with import context and language detection\n- **buildDirectoryPrompt** (function): Re-exported from `./builder.js`, constructs Phase 2 prompts for `AGENTS.md` aggregation from child summaries, subdirectory docs, and manifest metadata\n- **buildRootPrompt** (function): Re-exported from `./builder.js`, constructs Phase 3 prompts for platform-specific root document synthesis (`CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`) from `AGENTS.md` corpus\n- **detectLanguage** (function): Re-exported from `./builder.js`, maps file extensions to language identifiers for syntax highlighting in generated code blocks\n\n## Integration Points\n\nConsumed by `src/generation/executor.ts` which orchestrates three-phase pipeline execution via worker pool. Phase 1 uses `buildFilePrompt()` with `PromptContext` containing import maps from `src/imports/extractor.ts`. Phase 2 uses `buildDirectoryPrompt()` with aggregated child `.sum` content. Phase 3 uses `buildRootPrompt()` with collected `AGENTS.md` files from `src/generation/collector.ts`.\n\nThe `SUMMARY_GUIDELINES` constant enforces documentation quality constraints validated post-generation by `src/quality/inconsistency/code-vs-doc.ts` and `src/quality/phantom-paths/validator.ts`.\n### templates.ts\n**Purpose:** templates.ts exports six string constants defining system and user prompts for ARE's three-phase AI-driven documentat...\n\n**templates.ts exports six string constants defining system and user prompts for ARE's three-phase AI-driven documentation pipeline: FILE_SYSTEM_PROMPT, FILE_USER_PROMPT, FILE_UPDATE_SYSTEM_PROMPT for Phase 1 file analysis; DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT for Phase 2 directory aggregation; ROOT_SYSTEM_PROMPT for Phase 3 root synthesis.**\n\n## Exported Constants\n\n### Phase 1: File Analysis\n\n**FILE_SYSTEM_PROMPT**: System prompt for AI subprocesses analyzing individual source files. Enforces density rules: every sentence must reference specific identifiers (function/class/type/constant names), bans filler phrases matching patterns `/this file|this module|provides|responsible for|is used to|basically|essentially|provides functionality for/`. Mandates anchor term preservation: all exported symbols must appear exactly as written in source with correct casing, parameter types and return types must be mentioned. Specifies output format: start directly with bold purpose statement `**[FileName] does X.**`, no preamble/meta-commentary/conversational text. Defines adaptive documentation topics (choose based on file content): public interface with signatures, algorithms/data structures, integration points/coupling, configuration/environment requirements, error handling/validation, concurrency/lifecycle/resource management, domain-specific patterns (middleware chains/event handlers/schema definitions/factories), behavioral contracts (verbatim regex patterns, format strings, output templates, magic constants, sentinel values, error code strings, environment variable names). Mandates including all exported symbols with parameter/return types and key dependencies while excluding control flow minutiae, generic descriptions without identifiers, filler transitions. Distinguishes behavioral contracts as observable behavior requiring exact reproduction.\n\n**FILE_USER_PROMPT**: User prompt template for file analysis with placeholders `{{FILE_PATH}}` and `{{CONTENT}}` injected by `buildFilePrompt()` in `builder.ts`. Embeds full project structure from GENERATION-PLAN.md under `<project-structure>` XML tags showing 126 total tasks (96 file, 29 directory, 1 root) across depth-organized sections (Depth 3: `src/ai/backends/`, `src/ai/telemetry/`, `src/discovery/filters/`, `src/generation/prompts/`, `src/generation/writers/`, `src/quality/density/`, `src/quality/inconsistency/`, `src/quality/phantom-paths/`; Depth 2: `.github/workflows/`, 15 src/ subdirectories; Depth 1: `docs/`, `hooks/`, `scripts/`, `src/`; Depth 0: root). Specifies minimum requirements: bold purpose statement first line, exported symbols with signatures under `##` headings, additional sections chosen based on content.\n\n**FILE_UPDATE_SYSTEM_PROMPT**: System prompt for incremental file summary updates during `are update` workflow. Adds incremental update rules: preserve existing summary structure/section headings/phrasing verbatim where underlying code unchanged, modify only content directly affected by changes, keep stable sections VERBATIM without rephrasing/reorganizing/improving, add new sections only if code introduces entirely new concepts, remove sections only if described code deleted, update signatures/type names/identifiers to match current source exactly. Adds behavioral contract preservation rule: regex patterns, format strings, magic constants, template content from existing summary must be preserved verbatim unless source code changed them, show NEW value verbatim if source changed, never summarize/paraphrase regex patterns. Inherits density rules (identifier-per-sentence, filler phrase bans, technical shorthand), anchor term preservation (exported names with exact casing, parameter/return types), output format (direct purpose statement, no preamble) from FILE_SYSTEM_PROMPT.\n\n### Phase 2: Directory Aggregation\n\n**DIRECTORY_SYSTEM_PROMPT**: System prompt for generating directory-level AGENTS.md files from child `.sum` files and subdirectory `AGENTS.md` content. Mandates output format: start with exactly `<!-- Generated by agents-reverse-engineer -->` marker, use `#` heading with directory name, write one-paragraph purpose statement. Specifies adaptive section selection (not fixed template): Contents (group files by purpose under `##` headings, markdown link format `[filename](./filename)` with one-line descriptions, 1-2 sentences max per file), Subdirectories (link format `[dirname/](./dirname/)` with brief summaries, 1-2 sentences max), Architecture/Data Flow (pipeline/request-response chain/layered architecture), Stack (if package root with package.json/Cargo.toml/go.mod/pyproject.toml/pom.xml/build.gradle/Gemfile/composer.json/CMakeLists.txt/Makefile, document technology stack/key scripts/entry points), Structure (if layout follows convention like feature-sliced/domain-driven/MVC), Patterns (if files share factory/strategy/middleware/barrel re-export patterns, name and document), Configuration (config files/schemas/environment definitions), API Surface (barrel index/route definitions/SDK interface contract), File Relationships (collaboration/dependencies/shared state), Behavioral Contracts (mandatory when file summaries contain behavioral artifacts: regex patterns, format specifications, magic constants, template strings; preserve verbatim patterns from file summaries without paraphrasing). Enforces path accuracy constraints: use ONLY paths from \"Import Map\" section, do not invent/rename/guess module paths, use exact directory names from \"Project Directory Structure\", cross-module references must use specifier format from actual import statements, omit cross-reference if unsure rather than guessing. Adds consistency rules: no self-contradiction within document, preserve technique naming (e.g., if called \"regex-based\" initially, do not call \"AST-based\" later), use ONLY version numbers/engines/config fields present in file summaries. Defines scope: AGENTS.md as navigational index helping AI find files quickly, focus on file purposes/relationships/directory-level patterns, do NOT reproduce full architecture sections (belong in root CLAUDE.md). Handles User Notes: if provided, contain user-defined instructions automatically prepended to output, do NOT repeat/paraphrase user notes in generated content (included separately), may reference for context. Inherits density rules: identifier-per-sentence, ban filler phrases matching `/this directory|this module|provides|responsible for|is used to/`, technical shorthand, per-file descriptions 1-2 sentences max (reference key symbols without reproducing full summaries), subdirectory descriptions 1-2 sentences max (capture role not full contents), behavioral contracts in separate section not per-file descriptions. Inherits anchor term preservation: key exported symbols from file summaries must appear with exact casing.\n\n**DIRECTORY_UPDATE_SYSTEM_PROMPT**: System prompt for incremental AGENTS.md updates when child `.sum` files or subdirectory documents change. Adds incremental update rules: preserve existing AGENTS.md structure/section headings/descriptions that are still accurate, modify only entries for files/subdirectories whose summaries changed, add entries for new files, remove entries for deleted files, do NOT reorganize/rephrase/restructure unaffected sections, keep same section ordering unless file additions/removals require regrouping, Behavioral Contracts section must preserve verbatim regex patterns/constants unless source file summaries show changes. Inherits output format (raw markdown only, no code fences/preamble/explanations/conversational text, entire response IS AGENTS.md content, first line exactly `<!-- Generated by agents-reverse-engineer -->`), scope (navigational index, focus on file purposes/relationships/patterns, avoid full architecture sections), path accuracy (use only Import Map paths, exact directory names, actual import specifiers, omit if unsure), consistency (no self-contradiction, preserve technique naming, use only values from file summaries), density rules (identifier-per-sentence, filler phrase bans, technical shorthand, 1-2 sentence max per-file/subdirectory descriptions), anchor term preservation (key exported symbols with exact casing), User Notes handling from DIRECTORY_SYSTEM_PROMPT.\n\n### Phase 3: Root Document Synthesis\n\n**ROOT_SYSTEM_PROMPT**: System prompt for generating root integration documents (CLAUDE.md, GEMINI.md, OPENCODE.md) from directory AGENTS.md corpus. Mandates output format: output ONLY raw markdown content, no conversational text/preamble/meta-commentary, ban phrases matching `/Here is|I've generated/`, output written directly to file. Enforces critical constraint: synthesize ONLY from AGENTS.md content provided in user prompt, do NOT invent/extrapolate/hallucinate features/hooks/APIs/patterns/dependencies not explicitly mentioned, if information missing omit section rather than guessing, every claim must be traceable to specific AGENTS.md file provided.\n\n## Behavioral Contracts\n\n**Filler phrase ban patterns** (enforced across FILE_SYSTEM_PROMPT, FILE_UPDATE_SYSTEM_PROMPT, DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT):\n- File prompts: `/this file|this module|provides|responsible for|is used to|basically|essentially|provides functionality for/`\n- Directory prompts: `/this directory|this module|provides|responsible for|is used to/`\n\n**Output format markers**:\n- Purpose statement pattern: `**[FileName] does X.**` (FILE_SYSTEM_PROMPT, FILE_UPDATE_SYSTEM_PROMPT)\n- Generated marker pattern: `<!-- Generated by agents-reverse-engineer -->` (DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT)\n- Banned conversational patterns: `/Here is|I've generated|Now I'll|Based on my analysis|Let me create|Perfect\\./` (FILE_SYSTEM_PROMPT, FILE_UPDATE_SYSTEM_PROMPT, ROOT_SYSTEM_PROMPT)\n\n**Link formats** (DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT):\n- File links: `[filename](./filename)`\n- Subdirectory links: `[dirname/](./dirname/)`\n\n**Manifest file types** (DIRECTORY_SYSTEM_PROMPT Stack section): package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt, Makefile (9 types enumerated)\n\n**XML tag markers** (FILE_USER_PROMPT): `<project-structure>` wraps embedded GENERATION-PLAN.md content\n\n## Design Patterns\n\n**Template Method Pattern**: Separate system prompts (role/constraints) from user prompts (data/context) for AI subprocess invocations, composed independently by `buildFilePrompt()`, `buildDirectoryPrompt()`, `buildRootPrompt()` in `builder.ts`.\n\n**Constraint-Driven Generation**: Prompts encode mandatory rules (DENSITY RULES, ANCHOR TERM PRESERVATION, OUTPUT FORMAT) as structured sections with ALL CAPS headings, reducing hallucination and enforcing consistency across concurrent worker pool executions.\n\n**Incremental Update Strategy**: Separate `_UPDATE_SYSTEM_PROMPT` variants (FILE_UPDATE_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT) for file and directory phases preserve existing content structure during `are update` workflow, minimizing version control churn and maintaining human-authored phrasing where code unchanged.\n\n**Adaptive Documentation**: DIRECTORY_SYSTEM_PROMPT mandates choosing relevant sections (Contents/Subdirectories/Architecture/Stack/Structure/Patterns/Configuration/API Surface/File Relationships/Behavioral Contracts) based on directory contents rather than following fixed template, optimizing for navigational utility.\n\n## Integration Points\n\n**builder.ts**: Imports all six constants, injects runtime context (file paths via `{{FILE_PATH}}`, content via `{{CONTENT}}`, import maps, existing summaries, project structure) into prompt templates via `buildFilePrompt()`, `buildDirectoryPrompt()`, `buildRootPrompt()` factory functions.\n\n**orchestrator.ts**: Threads prompts through `executeThreePhaseGeneration()` coordinating Phase 1 concurrent file analysis (FILE_SYSTEM_PROMPT/FILE_USER_PROMPT or FILE_UPDATE_SYSTEM_PROMPT), Phase 2 post-order directory aggregation (DIRECTORY_SYSTEM_PROMPT or DIRECTORY_UPDATE_SYSTEM_PROMPT), Phase 3 sequential root synthesis (ROOT_SYSTEM_PROMPT).\n\n**AIService.call()**: Receives system/user prompt pairs from builder functions, passes to `runSubprocess()` for subprocess invocation with resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`, `--disallowedTools Task`).\n\n**update/orchestrator.ts**: Consumes FILE_UPDATE_SYSTEM_PROMPT and DIRECTORY_UPDATE_SYSTEM_PROMPT for incremental regeneration workflow when `are update` detects changed files via SHA-256 hash comparison.\n### types.ts\n**Purpose:** types.ts defines TypeScript interfaces and constants for prompt construction in the three-phase documentation generat...\n\n**types.ts defines TypeScript interfaces and constants for prompt construction in the three-phase documentation generation pipeline.**\n\n## Exported Types\n\n**PromptContext** interface structures the data bundle passed to prompt builders across all three generation phases:\n- `filePath: string` — absolute path to target file for Phase 1 analysis or directory for Phase 2 aggregation\n- `content: string` — file content (Phase 1) or aggregated child `.sum` content (Phase 2)\n- `contextFiles?: Array<{ path: string; content: string }>` — optional sibling files for import relationship context\n- `projectPlan?: string` — optional GENERATION-PLAN.md content providing bird's-eye view of codebase structure\n- `existingSum?: string` — previous `.sum` content for incremental updates (enables diff-based regeneration)\n\n## Summary Guidelines\n\n**SUMMARY_GUIDELINES** constant exports frozen object with validation constraints for `.sum` file quality:\n\n```typescript\n{\n  targetLength: { min: 300, max: 500 },\n  include: [\n    'Purpose and responsibility',\n    'Public interface (exports, key functions)',\n    'Key patterns and notable algorithms',\n    'Dependencies with usage context',\n    'Key function signatures as code snippets',\n    'Tightly coupled sibling files',\n    'Behavioral contracts: verbatim regex patterns, format strings, magic constants, sentinel values, output templates, environment variables',\n  ],\n  exclude: [\n    'Control flow minutiae (loop structures, variable naming, temporary state)',\n    'Generic TODOs/FIXMEs (keep only security/breaking)',\n    'Broad architectural relationships (handled by AGENTS.md)',\n  ],\n}\n```\n\n**`targetLength`** defines word count range (300-500) enforced by density validators in `src/quality/density/validator.ts`.\n\n**`include`** array specifies required content elements:\n- `'Purpose and responsibility'` — one-line purpose statement\n- `'Public interface (exports, key functions)'` — exported symbols extracted by code-vs-doc validator (`src/quality/inconsistency/code-vs-doc.ts`)\n- `'Key patterns and notable algorithms'` — design pattern identification (Strategy, Builder, etc.)\n- `'Dependencies with usage context'` — import statements with usage rationale\n- `'Key function signatures as code snippets'` — TypeScript/JavaScript signatures with parameter types\n- `'Tightly coupled sibling files'` — related files detected via `extractDirectoryImports()` in `src/imports/extractor.ts`\n- `'Behavioral contracts: verbatim regex patterns, format strings, magic constants, sentinel values, output templates, environment variables'` — concrete values required for correct integration (e.g., `NODE_OPTIONS='--max-old-space-size=512'`, `/^[ \\t]*export\\s+/gm`, `<!-- Generated by agents-reverse-engineer -->`)\n\n**`exclude`** array defines content to omit:\n- `'Control flow minutiae (loop structures, variable naming, temporary state)'` — private implementation details\n- `'Generic TODOs/FIXMEs (keep only security/breaking)'` — filters low-priority comments\n- `'Broad architectural relationships (handled by AGENTS.md)'` — defers system-level patterns to Phase 2 directory aggregation\n\n## Integration Points\n\nConsumed by `buildFileAnalysisPrompt()` and `buildDirectoryPrompt()` in `src/generation/prompts/builder.ts` to construct AI subprocess prompts. The `PromptContext` interface threads through `executePhase1()`, `executePhase2()`, `executePhase3()` in `src/generation/executor.ts` as input to `AIService.call()`.\n\nGuidelines enforced during quality validation via `validateCodeDocConsistency()` and `validateCodeCodeConsistency()` in `src/quality/inconsistency/` modules, checking that all `include` items appear in generated summaries and no `exclude` items dominate the content.\n\n## Import Map (verified — use these exact paths)\n\nbuilder.ts:\n  ../writers/sum.js → readSumFile, getSumPath\n  ../writers/agents-md.js → GENERATED_MARKER\n  ../../imports/index.js → extractDirectoryImports, formatImportMap\n  ../collector.js → collectAgentsDocs\n\n## Existing AGENTS.md (update this — preserve stable content, modify only what changed)\n\n<!-- Generated by agents-reverse-engineer -->\n\n# generation/prompts\n\nExports prompt builders for the three-phase AI-driven documentation pipeline: `buildFilePrompt` constructs Phase 1 per-file `.sum` analysis prompts with import context and incremental update support, `buildDirectoryPrompt` aggregates child summaries into Phase 2 `AGENTS.md` synthesis prompts with manifest detection and import maps, `buildRootPrompt` collects all `AGENTS.md` files for Phase 3 platform-specific root document generation.\n\n## Contents\n\n### Core Prompt Builders\n\n**[builder.ts](./builder.ts)** — Implements `buildFilePrompt()` reading `PromptContext.filePath`/`content`/`contextFiles`/`existingSum`, calls `detectLanguage()` for syntax highlighting, replaces placeholders in `FILE_USER_PROMPT`, appends import context and existing summaries for incremental updates switching to `FILE_UPDATE_SYSTEM_PROMPT`; `buildDirectoryPrompt()` enumerates directory via `readdir()`, reads `.sum` files in parallel via `getSumPath()` + `readSumFile()`, detects 9 manifest types (package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile), calls `extractDirectoryImports()` for source files matching `/\\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, appends user documentation from `AGENTS.local.md` or non-generated `AGENTS.md` (missing `GENERATED_MARKER`), switches to `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` present; `buildRootPrompt()` calls `collectAgentsDocs()` for recursive `AGENTS.md` aggregation, reads root `package.json` via `readFile()`, extracts `name`/`version`/`description`/`packageManager`/`scripts`, enforces synthesis-only constraint prohibiting invention of features/hooks/patterns; `detectLanguage()` maps file extensions to 20 syntax highlighting identifiers via hardcoded `langMap` (`.ts` → `typescript`, `.py` → `python`, `.rs` → `rust`, etc.), defaults to `'text'` for unmapped types.\n\n**[templates.ts](./templates.ts)** — Exports `FILE_SYSTEM_PROMPT` enforcing density rules (every sentence references identifiers, ban filler phrases \"this file\"/\"provides\"/\"responsible for\"), anchor term preservation (exact casing of exported symbols), adaptive documentation topics (public interface, algorithms, data structures, integration points, configuration, error handling, concurrency, lifecycle, domain patterns); `FILE_USER_PROMPT` template with `{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}` placeholders and embedded project structure tree (37 directories, 68 files); `FILE_UPDATE_SYSTEM_PROMPT` adding incremental rules (preserve structure/headings/phrasing where code unchanged, modify only affected content, update signatures/types to match source); `DIRECTORY_SYSTEM_PROMPT` mandating `<!-- Generated by agents-reverse-engineer -->` marker followed by `#` heading and one-paragraph purpose, specifying adaptive sections (Contents with `[filename](./filename)` links, Subdirectories with `[dirname/](./dirname/)` summaries, Architecture/Data Flow, Stack, Structure, Patterns, Configuration, API Surface, File Relationships), enforcing path accuracy (use only Import Map paths, exact directory names from Project Directory Structure, actual import specifiers), consistency (no self-contradiction, no technique renaming, use only summary values), scope (navigational index for finding files quickly); `DIRECTORY_UPDATE_SYSTEM_PROMPT` adding incremental rules (preserve accurate structure/headings/descriptions, modify only changed entries, add/remove for new/deleted files, avoid reorganizing unaffected sections); `ROOT_SYSTEM_PROMPT` mandating raw markdown output only (no preamble/meta-commentary), synthesize-only constraint (no invention/extrapolation/hallucination, every claim traceable to AGENTS.md, omit missing sections).\n\n**[types.ts](./types.ts)** — Defines `PromptContext` interface with `filePath: string`, `content: string`, `contextFiles?: Array<{ path: string; content: string }>`, `projectPlan?: string`, `existingSum?: string`; exports `SUMMARY_GUIDELINES` frozen object with `targetLength: { min: 200, max: 300 }`, `include: string[]` array (6 entries: purpose statement, public interface, patterns/algorithms, dependencies with usage context, function signatures, tightly coupled siblings), `exclude: string[]` array (3 entries: internal implementation, generic TODOs/FIXMEs, broad architectural relationships).\n\n**[index.ts](./index.ts)** — Barrel re-export module exposing `buildFilePrompt`, `buildDirectoryPrompt`, `buildRootPrompt`, `detectLanguage` from `./builder.js`, `PromptContext`, `SUMMARY_GUIDELINES` from `./types.js`.\n\n## File Relationships\n\n`builder.ts` imports `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`, `ROOT_SYSTEM_PROMPT` from `./templates.js`, calls `readSumFile()`/`getSumPath()` from `../writers/sum.js`, `GENERATED_MARKER` from `../writers/agents-md.js`, `extractDirectoryImports()`/`formatImportMap()` from `../../imports/index.js`, `collectAgentsDocs()` from `../collector.js`. Consumed by `src/generation/executor.ts` orchestrating three-phase pipeline via worker pool: Phase 1 uses `buildFilePrompt()` with import maps from `src/imports/extractor.ts`, Phase 2 uses `buildDirectoryPrompt()` with aggregated child `.sum` content, Phase 3 uses `buildRootPrompt()` with collected `AGENTS.md` files from `src/generation/collector.ts`. Guidelines in `SUMMARY_GUIDELINES` enforced by quality validators: `src/quality/inconsistency/code-vs-doc.ts` extracts exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, `src/quality/phantom-paths/validator.ts` resolves path references in `AGENTS.md` via `existsSync()`.\n\n## Incremental Update Strategy\n\n`buildFilePrompt()` and `buildDirectoryPrompt()` switch to update-specific system prompts (`FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`) when `existingSum` or `existingAgentsMd` detected. Update prompts instruct: \"preserve stable content, modify only what changed\" via explicit rules (preserve structure/headings/phrasing verbatim where code unchanged, add/remove sections only when code introduces/deletes concepts, update signatures/types/identifiers to match current source exactly). Reduces unnecessary rewrites during `are update` workflow minimizing version control churn.\n\n## User Documentation Preservation\n\n`buildDirectoryPrompt()` checks for `AGENTS.local.md` first, falls back to non-generated `AGENTS.md` (files missing `GENERATED_MARKER` constant `<!-- Generated by agents-reverse-engineer -->`). Appends user content as \"User Notes\" section with file reference. First-run detection renames user `AGENTS.md` → `AGENTS.local.md` (handled by caller in `src/generation/writers/agents-md.ts`, not this module). User notes automatically prepended to output by templates, prompt builders instructed not to repeat/paraphrase them in generated content.\n\n## Debug Logging\n\nInternal `logTemplate()` function in `builder.ts` logs when `debug=true` via `console.error()` with `picocolors.dim()` formatting. Outputs: `[prompt] buildFilePrompt → path lang=typescript`, `[prompt] buildDirectoryPrompt → path files=5 subdirs=2 imports=8` to reduce visual noise during pipeline execution.",
      "systemPrompt": "You are updating an existing AGENTS.md file — a directory-level overview for AI coding assistants. Some file summaries or subdirectory documents have changed, and AGENTS.md needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING AGENTS.md and the CURRENT file summaries and subdirectory documents\n- Preserve the structure, section headings, and descriptions that are still accurate\n- Only modify entries for files or subdirectories whose summaries have changed\n- Add entries for new files, remove entries for deleted files\n- Do NOT reorganize, rephrase, or restructure sections that are unaffected by changes\n- Keep the same section ordering unless files were added/removed in a way that requires regrouping\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Preserve the existing purpose statement unless the directory's role has fundamentally changed\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n- Cross-module references must use the specifier format from actual import statements\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context",
      "response": "<!-- Generated by agents-reverse-engineer -->\n\n# generation/prompts\n\nExports prompt builders for the three-phase AI-driven documentation pipeline: `buildFilePrompt` constructs Phase 1 per-file `.sum` analysis prompts with import context and incremental update support, `buildDirectoryPrompt` aggregates child summaries into Phase 2 `AGENTS.md` synthesis prompts with manifest detection and import maps, `buildRootPrompt` collects all `AGENTS.md` files for Phase 3 platform-specific root document generation.\n\n## Contents\n\n### Core Prompt Builders\n\n**[builder.ts](./builder.ts)** — Implements `buildFilePrompt()` reading `PromptContext.filePath`/`content`/`contextFiles`/`existingSum`, calls `detectLanguage()` for syntax highlighting, replaces placeholders in `FILE_USER_PROMPT`, appends import context and existing summaries for incremental updates switching to `FILE_UPDATE_SYSTEM_PROMPT`; `buildDirectoryPrompt()` enumerates directory via `readdir()`, reads `.sum` files in parallel via `getSumPath()` + `readSumFile()`, detects 9 manifest types (package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile), calls `extractDirectoryImports()` for source files matching `/\\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, appends user documentation from `AGENTS.local.md` or non-generated `AGENTS.md` (missing `GENERATED_MARKER`), switches to `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` present; `buildRootPrompt()` calls `collectAgentsDocs()` for recursive `AGENTS.md` aggregation, reads root `package.json` via `readFile()`, extracts `name`/`version`/`description`/`packageManager`/`scripts`, enforces synthesis-only constraint prohibiting invention of features/hooks/patterns; `detectLanguage()` maps file extensions to 20 syntax highlighting identifiers via hardcoded `langMap` (`.ts` → `typescript`, `.py` → `python`, `.rs` → `rust`, etc.), defaults to `'text'` for unmapped types.\n\n**[templates.ts](./templates.ts)** — Exports `FILE_SYSTEM_PROMPT` enforcing density rules (every sentence references identifiers, ban filler phrases matching `/this file|this module|provides|responsible for|is used to|basically|essentially|provides functionality for/`), anchor term preservation (exact casing of exported symbols with parameter/return types), adaptive documentation topics (public interface, algorithms, data structures, integration points, configuration, error handling, concurrency, lifecycle, domain patterns, behavioral contracts); `FILE_USER_PROMPT` template with `{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}`/`{{PROJECT_PLAN_SECTION}}` placeholders and embedded project structure XML tags; `FILE_UPDATE_SYSTEM_PROMPT` adding incremental rules (preserve structure/headings/phrasing where code unchanged, modify only affected content, update signatures/types to match source, preserve behavioral contracts verbatim unless source changed); `DIRECTORY_SYSTEM_PROMPT` mandating `<!-- Generated by agents-reverse-engineer -->` marker followed by `#` heading and one-paragraph purpose, specifying adaptive sections (Contents with `[filename](./filename)` links, Subdirectories with `[dirname/](./dirname/)` summaries, Architecture/Data Flow, Stack, Structure, Patterns, Configuration, API Surface, File Relationships, Behavioral Contracts), enforcing path accuracy (use only Import Map paths, exact directory names from Project Directory Structure, actual import specifiers, omit if unsure), consistency (no self-contradiction, preserve technique naming, use only summary values), scope (navigational index for finding files quickly); `DIRECTORY_UPDATE_SYSTEM_PROMPT` adding incremental rules (preserve accurate structure/headings/descriptions, modify only changed entries, add/remove for new/deleted files, avoid reorganizing unaffected sections, preserve behavioral contracts verbatim unless source summaries changed); `ROOT_SYSTEM_PROMPT` mandating raw markdown output only (no preamble/meta-commentary/conversational text), synthesize-only constraint (no invention/extrapolation/hallucination, every claim traceable to AGENTS.md, omit missing sections).\n\n**[types.ts](./types.ts)** — Defines `PromptContext` interface with `filePath: string`, `content: string`, `contextFiles?: Array<{ path: string; content: string }>`, `projectPlan?: string`, `existingSum?: string`; exports `SUMMARY_GUIDELINES` frozen object with `targetLength: { min: 300, max: 500 }`, `include: string[]` array (7 entries: purpose statement, public interface, patterns/algorithms, dependencies with usage context, function signatures, tightly coupled siblings, behavioral contracts with verbatim regex/constants/format strings), `exclude: string[]` array (3 entries: control flow minutiae, generic TODOs/FIXMEs, broad architectural relationships).\n\n**[index.ts](./index.ts)** — Barrel re-export module exposing `buildFilePrompt`, `buildDirectoryPrompt`, `buildRootPrompt`, `detectLanguage` from `./builder.js`, `PromptContext`, `SUMMARY_GUIDELINES` from `./types.js`.\n\n## File Relationships\n\n`builder.ts` imports `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`, `ROOT_SYSTEM_PROMPT` from `./templates.js`, calls `readSumFile()`/`getSumPath()` from `../writers/sum.js`, `GENERATED_MARKER` from `../writers/agents-md.js`, `extractDirectoryImports()`/`formatImportMap()` from `../../imports/index.js`, `collectAgentsDocs()` from `../collector.js`. Consumed by `src/generation/executor.ts` orchestrating three-phase pipeline via worker pool: Phase 1 uses `buildFilePrompt()` with import maps from `src/imports/extractor.ts`, Phase 2 uses `buildDirectoryPrompt()` with aggregated child `.sum` content, Phase 3 uses `buildRootPrompt()` with collected `AGENTS.md` files from `src/generation/collector.ts`. Guidelines in `SUMMARY_GUIDELINES` enforced by quality validators: `src/quality/inconsistency/code-vs-doc.ts` extracts exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, `src/quality/phantom-paths/validator.ts` resolves path references in `AGENTS.md` via `existsSync()`.\n\n## Behavioral Contracts\n\n**Filler phrase ban patterns** enforced across prompts:\n- File prompts: `/this file|this module|provides|responsible for|is used to|basically|essentially|provides functionality for/`\n- Directory prompts: `/this directory|this module|provides|responsible for|is used to/`\n\n**Output format markers**:\n- Purpose statement pattern: `**[FileName] does X.**` (FILE_SYSTEM_PROMPT, FILE_UPDATE_SYSTEM_PROMPT)\n- Generated marker: `<!-- Generated by agents-reverse-engineer -->` (DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT)\n- Banned conversational patterns: `/Here is|I've generated|Now I'll|Based on my analysis|Let me create|Perfect\\./` (FILE_SYSTEM_PROMPT, FILE_UPDATE_SYSTEM_PROMPT, ROOT_SYSTEM_PROMPT)\n\n**Link formats** (DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT):\n- File links: `[filename](./filename)`\n- Subdirectory links: `[dirname/](./dirname/)`\n\n**Manifest file types** (DIRECTORY_SYSTEM_PROMPT Stack section): package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt, Makefile\n\n**XML tag markers** (FILE_USER_PROMPT): `<project-structure>` wraps embedded GENERATION-PLAN.md content\n\n## Incremental Update Strategy\n\n`buildFilePrompt()` and `buildDirectoryPrompt()` switch to update-specific system prompts (`FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`) when `existingSum` or `existingAgentsMd` detected. Update prompts instruct: \"preserve stable content, modify only what changed\" via explicit rules (preserve structure/headings/phrasing verbatim where code unchanged, add/remove sections only when code introduces/deletes concepts, update signatures/types/identifiers to match current source exactly, preserve behavioral contracts verbatim unless source changed). Reduces unnecessary rewrites during `are update` workflow minimizing version control churn.\n\n## User Documentation Preservation\n\n`buildDirectoryPrompt()` checks for `AGENTS.local.md` first, falls back to non-generated `AGENTS.md` (files missing `GENERATED_MARKER` constant `<!-- Generated by agents-reverse-engineer -->`). Appends user content as \"User Notes\" section with file reference. First-run detection renames user `AGENTS.md` → `AGENTS.local.md` (handled by caller in `src/generation/writers/agents-md.ts`, not this module). User notes automatically prepended to output by templates, prompt builders instructed not to repeat/paraphrase them in generated content.\n\n## Debug Logging\n\nInternal `logTemplate()` function in `builder.ts` logs when `debug=true` via `console.error()` with `picocolors.dim()` formatting. Outputs: `[prompt] buildFilePrompt → path lang=typescript`, `[prompt] buildDirectoryPrompt → path files=5 subdirs=2 imports=8` to reduce visual noise during pipeline execution.",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 2446,
      "cacheReadTokens": 16334,
      "cacheCreationTokens": 17375,
      "latencyMs": 30308,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": []
    },
    {
      "timestamp": "2026-02-09T15:52:16.046Z",
      "prompt": "Generate AGENTS.md for directory: \"src/specify\" (specify)\n\n## File Summaries (3 files)\n\n### index.ts\n**Purpose:** Barrel export module re-exporting project specification synthesis capabilities: `buildSpecPrompt()` prompt constructo...\n\n**Barrel export module re-exporting project specification synthesis capabilities: `buildSpecPrompt()` prompt constructor, `SpecPrompt` type, `writeSpec()` file writer, `SpecExistsError` exception, and `WriteSpecOptions` configuration.**\n\n## Exported Symbols\n\n**Functions:**\n- `buildSpecPrompt()` — Imported from `./prompts.js`, constructs AI prompt for synthesizing project specification from AGENTS.md corpus\n- `writeSpec()` — Imported from `./writer.js`, writes generated specification to filesystem with overwrite protection\n\n**Types:**\n- `SpecPrompt` — Imported from `./prompts.js`, defines structure of specification generation prompt\n- `WriteSpecOptions` — Imported from `./writer.js`, configuration options for specification file writing (likely includes force overwrite flag, output path, multi-file mode)\n\n**Errors:**\n- `SpecExistsError` — Imported from `./writer.js`, thrown when attempting to write specification to existing file without force flag\n\n## Module Purpose\n\nRe-exports specification generation functionality consumed by `src/cli/specify.ts` command. Provides two-module separation: prompt engineering (`./prompts.js`) vs. file I/O (`./writer.js`). Based on CLI usage patterns (`are specify --force --multi-file`), `writeSpec()` likely accepts `WriteSpecOptions` controlling single-file (`specs/SPEC.md`) vs. multi-file (`specs/<dirname>.md`) output modes and overwrite behavior.\n\n## Integration Points\n\nConsumed by `src/cli/specify.ts` to implement `/are-specify` command workflow: collect all `AGENTS.md` files via `collectAgentsDocs()`, invoke `buildSpecPrompt()` to construct synthesis prompt, call AI service, pass result to `writeSpec()` with user-supplied options.\n### prompts.ts\n**Purpose:** prompts.ts defines the AI prompt infrastructure for project specification synthesis, providing `buildSpecPrompt()` to...\n\n**prompts.ts defines the AI prompt infrastructure for project specification synthesis, providing `buildSpecPrompt()` to generate system and user prompts from collected AGENTS.md files with mandatory concern-based organization rules and reproduction-critical implementation contracts.**\n\n## Exported Types\n\n`SpecPrompt` interface defines prompt pair structure with `system: string` and `user: string` properties for AI-driven specification generation.\n\n## Exported Constants\n\n`SPEC_SYSTEM_PROMPT` constant contains system-level instructions enforcing conceptual grouping by concern (not directory structure), prohibiting folder-mirroring and exact file path prescription, targeting AI agent consumption with nine mandatory sections:\n1. Project Overview (purpose, tech stack with versions)\n2. Architecture (module boundaries, data flow, design decisions)\n3. Public API Surface (exported interfaces, full type signatures)\n4. Data Structures & State (types, schemas, state management)\n5. Configuration (options, types, defaults, validation, env vars)\n6. Dependencies (each with exact version and rationale)\n7. Behavioral Contracts — Split into two subsections:\n   - Runtime Behavior: error handling strategies (exact error types/codes and when thrown), retry logic (formulas, delay values), concurrency model, lifecycle hooks, resource management\n   - Implementation Contracts: verbatim regex patterns for parsing/validation/extraction (in backticks), format strings and output templates (exact structure with examples), magic constants and sentinel values with meanings, environment variables with expected values, file format specifications (YAML schemas, NDJSON structures)\n8. Test Contracts (per-module scenarios, edge cases, expected behaviors)\n9. Build Plan (phased implementation with dependency ordering)\n\n## Exported Functions\n\n`buildSpecPrompt(docs: AgentsDocs): SpecPrompt` constructs prompt pair by:\n- Mapping `docs` array to markdown sections via `### ${doc.relativePath}\\n\\n${doc.content}` template\n- Building `userSections` array with header `Generate a comprehensive project specification from the following documentation.`\n- Injecting `## AGENTS.md Files (${docs.length} directories)` section with all `agentsSections`\n- Appending `## Output Requirements` section reiterating nine mandatory specification sections with emphasis on verbatim regex patterns, format specs, magic constants, and templates in Behavioral Contracts\n- Enforcing raw markdown output constraint: `Output ONLY the markdown content. No preamble.`\n- Returning `{ system: SPEC_SYSTEM_PROMPT, user: userSections.join('\\n') }`\n\n## Dependencies\n\nImports `AgentsDocs` type from `../generation/collector.js` for typed AGENTS.md document array consumed by `buildSpecPrompt()`.\n\n## Design Constraints\n\nPrompt engineering rules enforce MODULE BOUNDARY descriptions over file path prescriptions, exact function/type/constant name preservation from documentation, FULL type signature inclusion (parameters, return types, generics), prohibition of directory name section headings, version number requirements for ALL external dependencies, explicit dependency ordering in Build Plan phases, exact error type/code specification in Behavioral Contracts, and MANDATORY verbatim inclusion of regex patterns, format strings, magic constants, and templates (no paraphrasing into prose descriptions). When multiple modules reference the same constant or pattern, consolidation into single definition with cross-references is required.\n### writer.ts\n**Purpose:** writeSpec() writes AI-generated specification markdown to disk with overwrite protection, slugified filename generati...\n\n**writeSpec() writes AI-generated specification markdown to disk with overwrite protection, slugified filename generation from heading splits, and multi-file mode splitting on top-level `# ` heading boundaries.**\n\n## Exported Interface\n\n**WriteSpecOptions** configures spec output behavior:\n- `outputPath: string` — full path to output file (e.g., `/project/specs/SPEC.md`)\n- `force: boolean` — overwrite existing files without error\n- `multiFile: boolean` — split AI output into multiple files by top-level `# ` headings\n\n**SpecExistsError** extends Error, thrown when writeSpec() detects existing file(s) and `force=false`:\n- `paths: readonly string[]` — paths of conflicting files\n- Constructor accepts `string[]` and formats multi-line error message with `--force` hint\n\n**writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>** orchestrates spec file writing:\n- Single-file mode: writes `content` directly to `options.outputPath`\n- Multi-file mode: calls splitByHeadings(), writes each section to `path.join(dirname(outputPath), section.filename)`\n- Returns array of absolute paths to all written files\n- Throws SpecExistsError if any target file exists and `force=false`\n- Creates parent directories via `mkdir({ recursive: true })`\n- Pre-checks all target files for existence before writing any (atomic conflict detection)\n\n## Internal Functions\n\n**fileExists(filePath: string): Promise<boolean>** checks file existence via `access(filePath, constants.F_OK)`, returns true on success, false on catch block entry.\n\n**slugify(heading: string): string** sanitizes heading string into filename-safe slug via `.toLowerCase()` → `.replace(/\\s+/g, '-')` → `.replace(/[^a-z0-9-]/g, '')` → `.replace(/-+/g, '-')` → `.replace(/^-|-$/g, '')`.\n\n**splitByHeadings(content: string): Array<{ filename: string; content: string }>** splits markdown on `/^(?=# )/m` regex (positive lookahead for lines starting with `# `):\n- Iterates parts, extracts heading text via `/^# (.+)/` match, calls slugify() to generate filename\n- Content before first heading placed into `00-preamble.md`\n- Empty slugs default to `00-preamble.md`\n- Returns array of `{ filename, content }` pairs with `content` trimmed and newline-terminated\n\n## Multi-File Split Strategy\n\nMulti-file mode operates on `dirname(outputPath)` as target directory. Splits on top-level `# ` headings only (not `## ` or `### `). Filename generation pattern: `slugify(headingText) + '.md'`. Conflict detection checks all section target paths before writing any files, preventing partial writes on overwrite protection failures.\n\n## Dependencies\n\nImports `writeFile`, `mkdir`, `access` from `node:fs/promises`, `constants` from `node:fs`, `path` from `node:path` for file system operations and path manipulation. No external npm dependencies.\n\n## Import Map (verified — use these exact paths)\n\nprompts.ts:\n  ../generation/collector.js → AgentsDocs (type)\n\n## Existing AGENTS.md (update this — preserve stable content, modify only what changed)\n\n<!-- Generated by agents-reverse-engineer -->\n\n# src/specify\n\nSynthesizes project specifications from AGENTS.md corpus through prompt construction (`buildSpecPrompt()`), AI invocation by CLI orchestrator, and filesystem output via `writeSpec()` with single-file/multi-file modes.\n\n## Contents\n\n### Core Modules\n\n**[prompts.ts](./prompts.ts)** — Prompt engineering infrastructure exporting `buildSpecPrompt(docs: AgentsDocs): SpecPrompt` to construct system/user prompt pairs from collected AGENTS.md files. System prompt (`SPEC_SYSTEM_PROMPT`) enforces concern-based organization (not directory mirroring) with nine mandatory sections: Project Overview (tech stack versions), Architecture (module boundaries, data flow), Public API Surface (full type signatures), Data Structures & State (schemas, state management), Configuration (Zod schemas, env vars), Dependencies (exact versions with rationale), Behavioral Contracts (error types, retry logic, concurrency), Test Contracts (per-module scenarios), Build Plan (phased implementation with dependency ordering). User prompt concatenates AGENTS.md content via `### ${relativePath}` sections and appends Output Requirements reiterating raw markdown constraint.\n\n**[writer.ts](./writer.ts)** — Filesystem writer exporting `writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>` orchestrating single-file (`specs/SPEC.md`) vs. multi-file (`specs/<slug>.md`) output modes. Multi-file mode splits on top-level `# ` headings via `splitByHeadings()` regex (`/^(?=# )/m` positive lookahead), generates slugified filenames from heading text via `slugify()` lowercase+hyphen transform (`/\\s+/g → '-'`, `/[^a-z0-9-]/g → ''`). Pre-checks all target paths for existence before writing (atomic conflict detection), throws `SpecExistsError` with `paths[]` array if `force=false`. Creates parent directories via `mkdir({ recursive: true })`, returns absolute paths of written files.\n\n**[index.ts](./index.ts)** — Barrel export re-exporting `buildSpecPrompt()`, `SpecPrompt`, `writeSpec()`, `WriteSpecOptions`, `SpecExistsError` for consumption by `src/cli/specify.ts` command.\n\n## Data Flow\n\n1. **Specification synthesis** (`src/cli/specify.ts`) calls `collectAgentsDocs()` to recursively traverse project tree loading all `AGENTS.md` files with content and relative paths\n2. **Prompt construction** via `buildSpecPrompt(docs)` aggregates markdown sections into user prompt, pairs with `SPEC_SYSTEM_PROMPT` system instructions\n3. **AI invocation** by CLI orchestrator passes `SpecPrompt` to `AIService.call()`, receives synthesized specification markdown\n4. **Output writing** via `writeSpec(response, { outputPath, force, multiFile })` writes single spec or splits/slugifies into directory-per-heading structure\n5. **Error handling** catches `SpecExistsError` on overwrite protection failures, displays conflicting paths with `--force` hint\n\n## Architecture Constraints\n\nPrompt engineering prohibits directory-mirroring section structure, mandates MODULE BOUNDARY descriptions over file path prescriptions, requires exact symbol name preservation, enforces full type signatures with generics/parameters/return types, demands version numbers for all external dependencies, and constrains Build Plan to phased dependency ordering without file path prescription.\n\n## Integration Points\n\nConsumed by `src/cli/specify.ts` implementing `/are-specify` command. Receives `AgentsDocs` type from `../generation/collector.js` containing array of `{ relativePath, content }` objects. Invokes AI backend via `AIService` from `../ai/service.ts` with constructed prompts. Filesystem operations via `node:fs/promises` (`writeFile`, `mkdir`, `access`) with no external npm dependencies.",
      "systemPrompt": "You are updating an existing AGENTS.md file — a directory-level overview for AI coding assistants. Some file summaries or subdirectory documents have changed, and AGENTS.md needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING AGENTS.md and the CURRENT file summaries and subdirectory documents\n- Preserve the structure, section headings, and descriptions that are still accurate\n- Only modify entries for files or subdirectories whose summaries have changed\n- Add entries for new files, remove entries for deleted files\n- Do NOT reorganize, rephrase, or restructure sections that are unaffected by changes\n- Keep the same section ordering unless files were added/removed in a way that requires regrouping\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Preserve the existing purpose statement unless the directory's role has fundamentally changed\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n- Cross-module references must use the specifier format from actual import statements\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context",
      "response": "<!-- Generated by agents-reverse-engineer -->\n\n# src/specify\n\nSynthesizes project specifications from AGENTS.md corpus through prompt construction (`buildSpecPrompt()`), AI invocation by CLI orchestrator, and filesystem output via `writeSpec()` with single-file/multi-file modes.\n\n## Contents\n\n### Core Modules\n\n**[prompts.ts](./prompts.ts)** — Prompt engineering infrastructure exporting `buildSpecPrompt(docs: AgentsDocs): SpecPrompt` to construct system/user prompt pairs from collected AGENTS.md files. System prompt (`SPEC_SYSTEM_PROMPT`) enforces concern-based organization (not directory mirroring) with nine mandatory sections: Project Overview (tech stack versions), Architecture (module boundaries, data flow), Public API Surface (full type signatures), Data Structures & State (schemas, state management), Configuration (Zod schemas, env vars), Dependencies (exact versions with rationale), Behavioral Contracts split into Runtime Behavior (error types/codes with throw conditions, retry logic formulas/delays, concurrency model, lifecycle hooks, resource management) and Implementation Contracts (verbatim regex patterns in backticks, format strings/templates with examples, magic constants/sentinel values with meanings, environment variables with expected values, file format specs for YAML schemas/NDJSON structures), Test Contracts (per-module scenarios with edge cases), Build Plan (phased implementation with dependency ordering). User prompt concatenates AGENTS.md content via `### ${relativePath}` sections and appends Output Requirements reiterating raw markdown constraint with emphasis on verbatim regex patterns, format specs, magic constants, and templates.\n\n**[writer.ts](./writer.ts)** — Filesystem writer exporting `writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>` orchestrating single-file (`specs/SPEC.md`) vs. multi-file (`specs/<slug>.md`) output modes. Multi-file mode splits on top-level `# ` headings via `splitByHeadings()` regex (`/^(?=# )/m` positive lookahead), generates slugified filenames from heading text via `slugify()` lowercase+hyphen transform (`/\\s+/g → '-'`, `/[^a-z0-9-]/g → ''`). Pre-checks all target paths for existence before writing (atomic conflict detection), throws `SpecExistsError` with `paths[]` array if `force=false`. Creates parent directories via `mkdir({ recursive: true })`, returns absolute paths of written files.\n\n**[index.ts](./index.ts)** — Barrel export re-exporting `buildSpecPrompt()`, `SpecPrompt`, `writeSpec()`, `WriteSpecOptions`, `SpecExistsError` for consumption by `src/cli/specify.ts` command.\n\n## Data Flow\n\n1. **Specification synthesis** (`src/cli/specify.ts`) calls `collectAgentsDocs()` to recursively traverse project tree loading all `AGENTS.md` files with content and relative paths\n2. **Prompt construction** via `buildSpecPrompt(docs)` aggregates markdown sections into user prompt, pairs with `SPEC_SYSTEM_PROMPT` system instructions\n3. **AI invocation** by CLI orchestrator passes `SpecPrompt` to `AIService.call()`, receives synthesized specification markdown\n4. **Output writing** via `writeSpec(response, { outputPath, force, multiFile })` writes single spec or splits/slugifies into directory-per-heading structure\n5. **Error handling** catches `SpecExistsError` on overwrite protection failures, displays conflicting paths with `--force` hint\n\n## Architecture Constraints\n\nPrompt engineering prohibits directory-mirroring section structure, mandates MODULE BOUNDARY descriptions over file path prescriptions, requires exact symbol name preservation, enforces full type signatures with generics/parameters/return types, demands version numbers for all external dependencies, constrains Build Plan to phased dependency ordering without file path prescription, and requires MANDATORY verbatim inclusion of regex patterns, format strings, magic constants, and templates in Behavioral Contracts (no paraphrasing into prose descriptions).\n\n## Integration Points\n\nConsumed by `src/cli/specify.ts` implementing `/are-specify` command. Receives `AgentsDocs` type from `../generation/collector.js` containing array of `{ relativePath, content }` objects. Invokes AI backend via `AIService` from `../ai/service.ts` with constructed prompts. Filesystem operations via `node:fs/promises` (`writeFile`, `mkdir`, `access`) with no external npm dependencies.",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 1048,
      "cacheReadTokens": 16334,
      "cacheCreationTokens": 12022,
      "latencyMs": 14922,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": []
    },
    {
      "timestamp": "2026-02-09T15:52:30.984Z",
      "prompt": "Generate AGENTS.md for directory: \"src/generation\" (generation)\n\n## File Summaries (5 files)\n\n### collector.ts\n**Purpose:** collector.ts recursively discovers and aggregates all AGENTS.md files under projectRoot, returning AgentsDocs sorted ...\n\n**collector.ts recursively discovers and aggregates all AGENTS.md files under projectRoot, returning AgentsDocs sorted by relativePath while skipping vendor directories.**\n\n## Exported Types\n\n`AgentsDocs` — Type alias for `Array<{ relativePath: string; content: string }>` representing collected AGENTS.md documents with project-relative paths and UTF-8 content.\n\n## Exported Functions\n\n`collectAgentsDocs(projectRoot: string): Promise<AgentsDocs>` — Recursively traverses directories starting at projectRoot, reads all AGENTS.md files via `readFile()`, computes relative paths via `path.relative()`, sorts results alphabetically by relativePath using `localeCompare()`, and gracefully skips unreadable directories/files via try-catch. Internal `walk()` closure performs depth-first traversal using `readdir()` with `withFileTypes: true` for efficient directory detection.\n\n## Directory Filtering\n\n`SKIP_DIRS` constant — Set containing 13 excluded directory names: `node_modules`, `.git`, `.agents-reverse-engineer`, `vendor`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`. Applied during traversal via `SKIP_DIRS.has(entry.name)` predicate to prevent descending into build artifacts, package managers, version control, and project metadata directories.\n\n## Error Handling\n\nCatches and silently ignores permission-denied errors from `readdir()` and `readFile()` via empty catch blocks, ensuring partial collection succeeds even when encountering inaccessible paths. No error logging or user notification occurs for skipped files.\n\n## Integration Context\n\nUsed by Phase 3 root synthesis in `src/generation/orchestrator.ts` to consume all directory-level AGENTS.md documents for CLAUDE.md/GEMINI.md/OPENCODE.md generation. Also consumed by `src/specify/index.ts` for project specification synthesis aggregating documentation corpus.\n### complexity.ts\n**Purpose:** complexity.ts computes codebase structure metrics from file path lists: file count, maximum directory depth via path ...\n\n**complexity.ts computes codebase structure metrics from file path lists: file count, maximum directory depth via path separator splitting, and unique directory set via parent traversal.**\n\n## Exported Interface\n\n`ComplexityMetrics` contains:\n- `fileCount: number` — Total source file count\n- `directoryDepth: number` — Maximum nesting level from project root\n- `files: string[]` — Source file path array\n- `directories: Set<string>` — Unique directory paths extracted via parent traversal\n\n## Exported Function\n\n`analyzeComplexity(files: string[], projectRoot: string): ComplexityMetrics` orchestrates metric computation by invoking `calculateDirectoryDepth()` and `extractDirectories()`, returning populated `ComplexityMetrics` object with `fileCount` derived from `files.length`.\n\n## Internal Algorithms\n\n`calculateDirectoryDepth()` computes maximum depth by splitting `path.relative(projectRoot, file)` on `path.sep`, subtracting 1 (file itself doesn't count as directory level), tracking `Math.max()` across all files.\n\n`extractDirectories()` walks parent chain for each file via `path.dirname()` loop, adding to `Set<string>` until reaching root (detected when `parent === dir`), stops at `'.'` sentinel to prevent infinite loops.\n\n## Integration Points\n\nUsed by `src/generation/orchestrator.ts` to compute codebase scale metrics during discover/generate phases. Metrics inform concurrency tuning decisions and progress reporting via `src/orchestration/progress.ts`.\n\n## Design Pattern\n\nPure functional composition: `analyzeComplexity()` delegates to stateless helper functions operating on path string arrays. `Set<string>` ensures directory uniqueness without manual deduplication logic.\n### executor.ts\n**Purpose:** Builds ExecutionPlan with dependency-ordered tasks from GenerationPlan, tracking file-to-directory relationships and ...\n\n**Builds ExecutionPlan with dependency-ordered tasks from GenerationPlan, tracking file-to-directory relationships and post-order traversal depth for three-phase pipeline orchestration.**\n\n## Exported Types\n\n**ExecutionTask** defines AI-ready work unit with fields:\n- `id: string` — Unique identifier (patterns: `file:${path}`, `dir:${path}`, `root:${docName}`)\n- `type: 'file' | 'directory' | 'root-doc'` — Task category\n- `path: string` — Relative path\n- `absolutePath: string` — Full filesystem path\n- `systemPrompt: string` — AI system context\n- `userPrompt: string` — AI user instructions\n- `dependencies: string[]` — Task IDs that must complete first (enables topological execution)\n- `outputPath: string` — Destination for generated content (`.sum` for files, `AGENTS.md` for dirs, root doc names for root tasks)\n- `metadata: { directoryFiles?: string[], depth?: number, packageRoot?: string }` — Tracking metadata\n\n**ExecutionPlan** structures dependency graph with fields:\n- `projectRoot: string` — Base directory\n- `tasks: ExecutionTask[]` — All tasks in flattened array\n- `fileTasks: ExecutionTask[]` — Phase 1 file analysis tasks (parallel-eligible)\n- `directoryTasks: ExecutionTask[]` — Phase 2 directory aggregation tasks (post-order sorted by depth descending)\n- `rootTasks: ExecutionTask[]` — Phase 3 root document synthesis tasks (sequential)\n- `directoryFileMap: Record<string, string[]>` — Maps directory paths to contained file paths\n- `projectStructure?: string` — Compact project tree for directory prompt context\n\n## Core Functions\n\n**buildExecutionPlan(plan: GenerationPlan, projectRoot: string): ExecutionPlan** transforms GenerationPlan into dependency-ordered execution structure:\n1. Builds `directoryFileMap` by extracting `path.dirname()` from each file's `relativePath`\n2. Creates file tasks with `id: 'file:${filePath}'`, empty `dependencies`, `outputPath` as `${absolutePath}.sum`\n3. Sorts file tasks by directory depth descending via `getDirectoryDepth(path.dirname(a.path))` comparison\n4. Sorts directories by depth descending via `getDirectoryDepth(dirB) - getDirectoryDepth(dirA)` (enables post-order traversal)\n5. Creates directory tasks with `id: 'dir:${dir}'`, `dependencies` as array of file task IDs from that directory, `metadata.depth` from `getDirectoryDepth(dir)`, `metadata.directoryFiles` as file list\n6. Creates root tasks with `id: 'root:CLAUDE.md'`, `dependencies` as all directory task IDs, placeholder prompts \"Built at runtime by buildRootPrompt()\" (actual prompts constructed in `runner.ts` Phase 3)\n7. Returns ExecutionPlan with concatenated task arrays and computed `projectStructure` from input plan\n\n**getDirectoryDepth(dir: string): number** computes path segment count:\n- Returns `0` for root directory `'.'`\n- Returns `dir.split(path.sep).length` for all other paths\n- Examples: `\"src\"` → 1, `\"src/cli\"` → 2\n\n**isDirectoryComplete(dirPath: string, expectedFiles: string[], projectRoot: string): Promise<{ complete: boolean; missing: string[] }>** validates readiness:\n1. Iterates `expectedFiles` array\n2. Joins each `relativePath` with `projectRoot` to get `absolutePath`\n3. Calls `sumFileExists(absolutePath)` to check for `.sum` file existence\n4. Appends to `missing[]` array if absent\n5. Returns `{ complete: missing.length === 0, missing }` object\n\n**getReadyDirectories(executionPlan: ExecutionPlan): Promise<string[]>** filters directories with complete file analysis:\n1. Iterates `Object.entries(executionPlan.directoryFileMap)`\n2. Awaits `isDirectoryComplete(dir, files, executionPlan.projectRoot)`\n3. Pushes `dir` to `ready[]` array if `complete === true`\n4. Returns ready directory paths\n\n**formatExecutionPlanAsMarkdown(plan: ExecutionPlan): string** renders human-readable plan with post-order visualization:\n1. Builds markdown header with `plan.projectRoot`, current date, task counts (`plan.tasks.length`, `plan.fileTasks.length`, `plan.directoryTasks.length`, `plan.rootTasks.length`)\n2. Groups file tasks by directory into `filesByDir: Record<string, Set<string>>` using `path.substring(0, task.path.lastIndexOf('/'))` extraction (deduplicated via Set)\n3. Outputs **Phase 1: File Analysis** section iterating `plan.directoryTasks` (preserves post-order) and rendering each directory's files with `- [ ] \\`${file}\\`` checkbox format\n4. Groups directory tasks by depth into `dirsByDepth: Record<number, string[]>` using `task.metadata.depth ?? 0`\n5. Outputs **Phase 2: Directory AGENTS.md** section with depths sorted descending via `Object.keys(dirsByDepth).map(Number).sort((a, b) => b - a)`, renders `- [ ] \\`${dir}/AGENTS.md\\`` with root directory suffix\n6. Outputs **Phase 3: Root Documents** section with hardcoded `- [ ] \\`CLAUDE.md\\`` entry\n7. Returns concatenated markdown string\n\n## Dependencies\n\nImports `GenerationPlan` from `./orchestrator.js` (input structure with files/tasks/projectStructure), `sumFileExists` from `./writers/sum.js` (checks `.sum` file presence for dependency resolution).\n\n## Design Patterns\n\n**Post-Order Traversal Enforcement**: Both file and directory task arrays sorted by `getDirectoryDepth()` descending ensures child directories processed before parents (deepest nodes first, root last).\n\n**Dependency Graph Construction**: File tasks populate directory task `dependencies[]` arrays by mapping `directoryFileMap[dir]` paths to `file:${path}` task IDs; all directory task IDs become dependencies for root tasks.\n\n**Runtime Prompt Deferral**: Directory and root task prompts contain placeholder strings (`\"Built at runtime by buildDirectoryPrompt()\"`, `\"Built at runtime by buildRootPrompt()\"`) because actual prompts require reading generated `.sum` and `AGENTS.md` files not available during plan construction.\n\n## Integration Points\n\n**Orchestrator Input**: Consumes `GenerationPlan` from `src/generation/orchestrator.ts` with `files[]`, `tasks[]`, `projectStructure` fields.\n\n**Runner Execution**: ExecutionPlan passed to `src/orchestration/runner.ts` which executes tasks respecting `dependencies[]` ordering and populates runtime prompts.\n\n**Plan Tracking**: Markdown output from `formatExecutionPlanAsMarkdown()` written to `GENERATION-PLAN.md` via `PlanTracker` in `src/orchestration/plan-tracker.ts`.\n### orchestrator.ts\n**Purpose:** GenerationOrchestrator coordinates three-phase documentation generation workflow by preparing files, creating file an...\n\n**GenerationOrchestrator coordinates three-phase documentation generation workflow by preparing files, creating file analysis tasks with prompts, creating directory synthesis tasks, and producing execution plans with complexity metrics and project structure context.**\n\n## Exported Types\n\n**PreparedFile** represents a file ready for analysis with `filePath: string` (absolute), `relativePath: string` (from project root), and `content: string` (UTF-8 file content).\n\n**AnalysisTask** discriminated union with `type: 'file' | 'directory'`, `filePath: string`, optional `systemPrompt?: string`, optional `userPrompt?: string`, optional `directoryInfo?: { sumFiles: string[]; fileCount: number }`. File tasks have prompts set immediately; directory tasks have prompts built at execution time by `buildDirectoryPrompt()`.\n\n**GenerationPlan** aggregates workflow data with `files: PreparedFile[]`, `tasks: AnalysisTask[]`, `complexity: ComplexityMetrics` (from `analyzeComplexity()`), optional `projectStructure?: string` (compact directory listing).\n\n## Core Class\n\n**GenerationOrchestrator** constructor accepts `config: Config`, `projectRoot: string`, `options?: { tracer?: ITraceWriter; debug?: boolean }`. Stores configuration, project root, optional ITraceWriter for trace emission, and debug flag for verbose logging.\n\n## Public Methods\n\n**prepareFiles(discoveryResult: DiscoveryResult): Promise<PreparedFile[]>** reads file content via `readFile()` for each path in `discoveryResult.files`, computes relative paths via `path.relative(projectRoot, filePath)`, silently skips permission errors, returns array of PreparedFile objects.\n\n**createFileTasks(files: PreparedFile[], projectStructure?: string): AnalysisTask[]** calls `buildFilePrompt({ filePath, content, projectPlan: projectStructure }, debug)` for each file, returns AnalysisTask array with `type: 'file'`, `systemPrompt`, `userPrompt` pre-populated.\n\n**createDirectoryTasks(files: PreparedFile[]): AnalysisTask[]** groups files by `path.dirname(relativePath)` via `Map<string, PreparedFile[]>`, generates AnalysisTask with `type: 'directory'`, `directoryInfo.sumFiles` containing `${relativePath}.sum` paths, `directoryInfo.fileCount` set. Directory prompts built at execution time, not during planning.\n\n**createPlan(discoveryResult: DiscoveryResult): Promise<GenerationPlan>** orchestrates planning workflow: emits `phase:start` trace with `phase: 'plan-creation'`, calls `prepareFiles()`, calls `analyzeComplexity()` from `src/generation/complexity.ts`, calls `buildProjectStructure()` to generate compact file tree, calls `createFileTasks()`, calls `createDirectoryTasks()`, clears `content` fields on PreparedFile objects to free memory, emits `plan:created` trace with `taskCount: tasks.length + 1` (accounts for root CLAUDE.md task added later by `buildExecutionPlan()`), emits `phase:end` trace with duration, returns GenerationPlan.\n\n## Private Methods\n\n**buildProjectStructure(files: PreparedFile[]): string** groups files by directory via `Map<string, string[]>` keyed on `path.dirname(relativePath)`, sorts directories and filenames, formats as multi-line tree with directory names ending in `/` and indented file basenames, returns string for bird's-eye context in file prompts.\n\n## Exported Factory\n\n**createOrchestrator(config: Config, projectRoot: string, options?: { tracer?: ITraceWriter; debug?: boolean }): GenerationOrchestrator** returns new GenerationOrchestrator instance with provided parameters.\n\n## Dependencies\n\nImports `buildFilePrompt` from `src/generation/prompts/index.ts` for file task prompt construction, `analyzeComplexity` and `ComplexityMetrics` from `src/generation/complexity.ts` for depth/breadth metrics, `ITraceWriter` from `src/orchestration/trace.ts` for NDJSON trace emission, `Config` from `src/config/schema.ts`, `DiscoveryResult` from `src/types/index.ts`.\n\n## Memory Management\n\nCalls `(file as { content: string }).content = ''` after `createFileTasks()` to release file content strings from PreparedFile objects since content is already embedded in task prompts. Runner re-reads files from disk during execution to avoid holding entire codebase in memory during plan generation.\n\n## Trace Events\n\nEmits `phase:start` with `phase: 'plan-creation'`, `taskCount: discoveryResult.files.length`, `concurrency: 1` at plan start. Emits `plan:created` with `planType: 'generate'`, `fileCount`, `taskCount` after plan construction. Emits `phase:end` with `phase: 'plan-creation'`, `durationMs`, `tasksCompleted: 1`, `tasksFailed: 0` at completion.\n\n## Task Ordering\n\nFile tasks precede directory tasks in returned tasks array via `[...fileTasks, ...dirTasks]` concatenation. Directory tasks depend on completion of file tasks in same directory to access `.sum` files for synthesis. Root document tasks (CLAUDE.md, GEMINI.md, OPENCODE.md) added separately by execution planner, not by GenerationOrchestrator.\n### types.ts\n**Purpose:** Defines TypeScript interfaces for AI-generated analysis results, metadata extraction, and summary generation options ...\n\n**Defines TypeScript interfaces for AI-generated analysis results, metadata extraction, and summary generation options used throughout the three-phase documentation pipeline.**\n\n## Exported Types\n\n**`AnalysisResult`** — Result of Phase 1 file analysis populated by LLM via `AIService.call()`. Contains:\n- `summary: string` — Generated markdown summary text written to `.sum` files\n- `metadata: SummaryMetadata` — Extracted structured metadata for YAML frontmatter\n\n**`SummaryMetadata`** — Structured metadata extracted during file analysis and serialized to `.sum` YAML frontmatter. Contains:\n- `purpose: string` — One-line purpose statement (mandatory)\n- `criticalTodos?: string[]` — Security/breaking issues only (optional)\n- `relatedFiles?: string[]` — Tightly coupled sibling file paths (optional)\n\n**`SummaryOptions`** — Configuration for summary generation behavior. Contains:\n- `targetLength: 'short' | 'standard' | 'detailed'` — Controls output verbosity\n- `includeCodeSnippets: boolean` — Whether to embed code examples in summaries\n\n## Integration Points\n\nUsed by `src/generation/executor.ts` to type-check AI service responses during Phase 1 concurrent file analysis. The `AnalysisResult.metadata` structure maps directly to YAML frontmatter fields written by `writeSumFile()` in `src/generation/writers/sum.ts`. The `content_hash` field (SHA-256) added during write is not part of this schema — it's injected by the writer layer.\n\nReferenced by `src/generation/prompts/builder.ts` when constructing prompts that specify expected LLM output format. The `SummaryOptions` type flows through `CommandRunOptions` in `src/orchestration/types.ts` to control prompt template selection.\n\n## Related Files\n\n- `src/generation/writers/sum.ts` — Consumes `AnalysisResult` to write `.sum` files with YAML frontmatter\n- `src/generation/prompts/types.ts` — Defines `PromptContext` that carries `SummaryOptions`\n- `src/orchestration/types.ts` — Defines `Task` discriminated union where `AnalyzeFileTask` produces `AnalysisResult`\n\n## Import Map (verified — use these exact paths)\n\norchestrator.ts:\n  ../config/schema.js → Config (type)\n  ../types/index.js → DiscoveryResult (type)\n  ../orchestration/trace.js → ITraceWriter (type)\n\n## Subdirectories\n\n### prompts/\n<!-- Generated by agents-reverse-engineer -->\n\n# generation/prompts\n\nExports prompt builders for the three-phase AI-driven documentation pipeline: `buildFilePrompt` constructs Phase 1 per-file `.sum` analysis prompts with import context and incremental update support, `buildDirectoryPrompt` aggregates child summaries into Phase 2 `AGENTS.md` synthesis prompts with manifest detection and import maps, `buildRootPrompt` collects all `AGENTS.md` files for Phase 3 platform-specific root document generation.\n\n## Contents\n\n### Core Prompt Builders\n\n**[builder.ts](./builder.ts)** — Implements `buildFilePrompt()` reading `PromptContext.filePath`/`content`/`contextFiles`/`existingSum`, calls `detectLanguage()` for syntax highlighting, replaces placeholders in `FILE_USER_PROMPT`, appends import context and existing summaries for incremental updates switching to `FILE_UPDATE_SYSTEM_PROMPT`; `buildDirectoryPrompt()` enumerates directory via `readdir()`, reads `.sum` files in parallel via `getSumPath()` + `readSumFile()`, detects 9 manifest types (package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile), calls `extractDirectoryImports()` for source files matching `/\\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, appends user documentation from `AGENTS.local.md` or non-generated `AGENTS.md` (missing `GENERATED_MARKER`), switches to `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` present; `buildRootPrompt()` calls `collectAgentsDocs()` for recursive `AGENTS.md` aggregation, reads root `package.json` via `readFile()`, extracts `name`/`version`/`description`/`packageManager`/`scripts`, enforces synthesis-only constraint prohibiting invention of features/hooks/patterns; `detectLanguage()` maps file extensions to 20 syntax highlighting identifiers via hardcoded `langMap` (`.ts` → `typescript`, `.py` → `python`, `.rs` → `rust`, etc.), defaults to `'text'` for unmapped types.\n\n**[templates.ts](./templates.ts)** — Exports `FILE_SYSTEM_PROMPT` enforcing density rules (every sentence references identifiers, ban filler phrases matching `/this file|this module|provides|responsible for|is used to|basically|essentially|provides functionality for/`), anchor term preservation (exact casing of exported symbols with parameter/return types), adaptive documentation topics (public interface, algorithms, data structures, integration points, configuration, error handling, concurrency, lifecycle, domain patterns, behavioral contracts); `FILE_USER_PROMPT` template with `{{FILE_PATH}}`/`{{CONTENT}}`/`{{LANG}}`/`{{PROJECT_PLAN_SECTION}}` placeholders and embedded project structure XML tags; `FILE_UPDATE_SYSTEM_PROMPT` adding incremental rules (preserve structure/headings/phrasing where code unchanged, modify only affected content, update signatures/types to match source, preserve behavioral contracts verbatim unless source changed); `DIRECTORY_SYSTEM_PROMPT` mandating `<!-- Generated by agents-reverse-engineer -->` marker followed by `#` heading and one-paragraph purpose, specifying adaptive sections (Contents with `[filename](./filename)` links, Subdirectories with `[dirname/](./dirname/)` summaries, Architecture/Data Flow, Stack, Structure, Patterns, Configuration, API Surface, File Relationships, Behavioral Contracts), enforcing path accuracy (use only Import Map paths, exact directory names from Project Directory Structure, actual import specifiers, omit if unsure), consistency (no self-contradiction, preserve technique naming, use only summary values), scope (navigational index for finding files quickly); `DIRECTORY_UPDATE_SYSTEM_PROMPT` adding incremental rules (preserve accurate structure/headings/descriptions, modify only changed entries, add/remove for new/deleted files, avoid reorganizing unaffected sections, preserve behavioral contracts verbatim unless source summaries changed); `ROOT_SYSTEM_PROMPT` mandating raw markdown output only (no preamble/meta-commentary/conversational text), synthesize-only constraint (no invention/extrapolation/hallucination, every claim traceable to AGENTS.md, omit missing sections).\n\n**[types.ts](./types.ts)** — Defines `PromptContext` interface with `filePath: string`, `content: string`, `contextFiles?: Array<{ path: string; content: string }>`, `projectPlan?: string`, `existingSum?: string`; exports `SUMMARY_GUIDELINES` frozen object with `targetLength: { min: 300, max: 500 }`, `include: string[]` array (7 entries: purpose statement, public interface, patterns/algorithms, dependencies with usage context, function signatures, tightly coupled siblings, behavioral contracts with verbatim regex/constants/format strings), `exclude: string[]` array (3 entries: control flow minutiae, generic TODOs/FIXMEs, broad architectural relationships).\n\n**[index.ts](./index.ts)** — Barrel re-export module exposing `buildFilePrompt`, `buildDirectoryPrompt`, `buildRootPrompt`, `detectLanguage` from `./builder.js`, `PromptContext`, `SUMMARY_GUIDELINES` from `./types.js`.\n\n## File Relationships\n\n`builder.ts` imports `FILE_SYSTEM_PROMPT`, `FILE_USER_PROMPT`, `FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`, `ROOT_SYSTEM_PROMPT` from `./templates.js`, calls `readSumFile()`/`getSumPath()` from `../writers/sum.js`, `GENERATED_MARKER` from `../writers/agents-md.js`, `extractDirectoryImports()`/`formatImportMap()` from `../../imports/index.js`, `collectAgentsDocs()` from `../collector.js`. Consumed by `src/generation/executor.ts` orchestrating three-phase pipeline via worker pool: Phase 1 uses `buildFilePrompt()` with import maps from `src/imports/extractor.ts`, Phase 2 uses `buildDirectoryPrompt()` with aggregated child `.sum` content, Phase 3 uses `buildRootPrompt()` with collected `AGENTS.md` files from `src/generation/collector.ts`. Guidelines in `SUMMARY_GUIDELINES` enforced by quality validators: `src/quality/inconsistency/code-vs-doc.ts` extracts exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, `src/quality/phantom-paths/validator.ts` resolves path references in `AGENTS.md` via `existsSync()`.\n\n## Behavioral Contracts\n\n**Filler phrase ban patterns** enforced across prompts:\n- File prompts: `/this file|this module|provides|responsible for|is used to|basically|essentially|provides functionality for/`\n- Directory prompts: `/this directory|this module|provides|responsible for|is used to/`\n\n**Output format markers**:\n- Purpose statement pattern: `**[FileName] does X.**` (FILE_SYSTEM_PROMPT, FILE_UPDATE_SYSTEM_PROMPT)\n- Generated marker: `<!-- Generated by agents-reverse-engineer -->` (DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT)\n- Banned conversational patterns: `/Here is|I've generated|Now I'll|Based on my analysis|Let me create|Perfect\\./` (FILE_SYSTEM_PROMPT, FILE_UPDATE_SYSTEM_PROMPT, ROOT_SYSTEM_PROMPT)\n\n**Link formats** (DIRECTORY_SYSTEM_PROMPT, DIRECTORY_UPDATE_SYSTEM_PROMPT):\n- File links: `[filename](./filename)`\n- Subdirectory links: `[dirname/](./dirname/)`\n\n**Manifest file types** (DIRECTORY_SYSTEM_PROMPT Stack section): package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt, Makefile\n\n**XML tag markers** (FILE_USER_PROMPT): `<project-structure>` wraps embedded GENERATION-PLAN.md content\n\n## Incremental Update Strategy\n\n`buildFilePrompt()` and `buildDirectoryPrompt()` switch to update-specific system prompts (`FILE_UPDATE_SYSTEM_PROMPT`, `DIRECTORY_UPDATE_SYSTEM_PROMPT`) when `existingSum` or `existingAgentsMd` detected. Update prompts instruct: \"preserve stable content, modify only what changed\" via explicit rules (preserve structure/headings/phrasing verbatim where code unchanged, add/remove sections only when code introduces/deletes concepts, update signatures/types/identifiers to match current source exactly, preserve behavioral contracts verbatim unless source changed). Reduces unnecessary rewrites during `are update` workflow minimizing version control churn.\n\n## User Documentation Preservation\n\n`buildDirectoryPrompt()` checks for `AGENTS.local.md` first, falls back to non-generated `AGENTS.md` (files missing `GENERATED_MARKER` constant `<!-- Generated by agents-reverse-engineer -->`). Appends user content as \"User Notes\" section with file reference. First-run detection renames user `AGENTS.md` → `AGENTS.local.md` (handled by caller in `src/generation/writers/agents-md.ts`, not this module). User notes automatically prepended to output by templates, prompt builders instructed not to repeat/paraphrase them in generated content.\n\n## Debug Logging\n\nInternal `logTemplate()` function in `builder.ts` logs when `debug=true` via `console.error()` with `picocolors.dim()` formatting. Outputs: `[prompt] buildFilePrompt → path lang=typescript`, `[prompt] buildDirectoryPrompt → path files=5 subdirs=2 imports=8` to reduce visual noise during pipeline execution.\n\n## Existing AGENTS.md (update this — preserve stable content, modify only what changed)\n\n<!-- Generated by agents-reverse-engineer -->\n\n# src/generation\n\n**Phase orchestration for three-stage AI-driven documentation pipeline: concurrent `.sum` file analysis via worker pools, post-order directory `AGENTS.md` synthesis with import map injection, and platform-specific root document generation from aggregated corpus.**\n\n## Contents\n\n### Orchestration & Planning\n\n**[orchestrator.ts](./orchestrator.ts)** — `GenerationOrchestrator` class with `prepareFiles()` reading file content via `readFile()`, `createFileTasks()` calling `buildFilePrompt()` for each file, `createDirectoryTasks()` grouping files by `path.dirname(relativePath)`, `createPlan()` emitting `phase:start`/`plan:created`/`phase:end` traces and returning `GenerationPlan` with `files`, `tasks`, `complexity` from `analyzeComplexity()`, `projectStructure` from `buildProjectStructure()`; memory management via `(file as { content: string }).content = ''` after task creation.\n\n**[executor.ts](./executor.ts)** — `buildExecutionPlan()` transforms `GenerationPlan` into `ExecutionPlan` with dependency-ordered `tasks[]`, `fileTasks[]`, `directoryTasks[]`, `rootTasks[]`, `directoryFileMap: Record<string, string[]>` via `path.dirname()` extraction, sorts directories by `getDirectoryDepth()` descending for post-order traversal; `isDirectoryComplete()` validates `.sum` file presence for expected files via `sumFileExists()`; `getReadyDirectories()` filters directories with complete file analysis; `formatExecutionPlanAsMarkdown()` renders plan with Phase 1/2/3 sections, groups files by directory with checkbox format, sorts directories by depth descending.\n\n**[complexity.ts](./complexity.ts)** — `analyzeComplexity()` returns `ComplexityMetrics` with `fileCount`, `directoryDepth` from `calculateDirectoryDepth()` splitting `path.relative()` on `path.sep`, `directories: Set<string>` from `extractDirectories()` walking parent chain via `path.dirname()` loop.\n\n**[types.ts](./types.ts)** — Defines `AnalysisResult` with `summary: string`, `metadata: SummaryMetadata` (`purpose`, `criticalTodos?`, `relatedFiles?`); `SummaryOptions` with `targetLength: 'short' | 'standard' | 'detailed'`, `includeCodeSnippets: boolean`.\n\n### Document Collection\n\n**[collector.ts](./collector.ts)** — `collectAgentsDocs()` recursively traverses directories via internal `walk()` closure using `readdir()` with `withFileTypes: true`, reads all `AGENTS.md` files via `readFile()`, computes relative paths via `path.relative()`, sorts results by `relativePath` via `localeCompare()`, skips 13 vendor directories (`node_modules`, `.git`, `.agents-reverse-engineer`, `vendor`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`) via `SKIP_DIRS.has(entry.name)` predicate; returns `AgentsDocs` array with `{ relativePath, content }` objects.\n\n## Subdirectories\n\n**[prompts/](./prompts/)** — Exports `buildFilePrompt()` constructing Phase 1 `.sum` analysis prompts with import context and incremental update support via `FILE_UPDATE_SYSTEM_PROMPT`, `buildDirectoryPrompt()` aggregating child summaries into Phase 2 `AGENTS.md` synthesis prompts with manifest detection (9 types: package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile) and `extractDirectoryImports()` for source files matching `/\\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, `buildRootPrompt()` collecting all `AGENTS.md` files via `collectAgentsDocs()` for Phase 3 platform-specific root document generation; templates enforce density rules (every sentence references identifiers, ban filler phrases), anchor term preservation (exact casing), path accuracy (use only Import Map paths); user documentation preserved via `AGENTS.local.md` prepending with comment block wrapper.\n\n**[writers/](./writers/)** — Exports `writeSumFile()` serializing YAML frontmatter with SHA-256 `content_hash` via `formatSumFile()`, `readSumFile()` parsing frontmatter via regex-based `parseSumFile()` with null on parse failure, `getSumPath()` appending `.sum` extension, `sumFileExists()` checking filesystem via `readSumFile()` null test; `writeAgentsMd()` implementing four-step protocol: in-place `AGENTS.md` → `AGENTS.local.md` rename if missing `GENERATED_MARKER`, fallback `AGENTS.local.md` load, marker stripping from LLM content, assembly with user content prepended in comment block; `parseYamlArray()`/`formatYamlArray()` supporting inline `[a, b, c]` and multi-line `- item` formats.\n\n## Architecture\n\n### Three-Phase Pipeline\n\n**Phase 1: Concurrent File Analysis**\n1. `GenerationOrchestrator.prepareFiles()` reads source file content via `readFile()`\n2. `createFileTasks()` calls `buildFilePrompt()` for each file with import context from `extractDirectoryImports()`\n3. Worker pool executes file tasks in parallel (default concurrency: 2 for WSL, 5 elsewhere)\n4. `writeSumFile()` persists `.sum` files with YAML frontmatter containing `generated_at`, `content_hash`, `purpose`, optional `critical_todos`/`related_files`\n\n**Phase 2: Post-Order Directory Aggregation**\n1. `buildExecutionPlan()` sorts directories by `getDirectoryDepth()` descending (deepest first)\n2. `isDirectoryComplete()` waits for all child `.sum` files to exist via `sumFileExists()` predicate\n3. `buildDirectoryPrompt()` reads child `.sum` files via `readSumFile()`, detects manifests (package.json, Cargo.toml, etc.), extracts import maps via `extractDirectoryImports()`\n4. `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` if non-generated, prepends user content to LLM output\n\n**Phase 3: Root Document Synthesis**\n1. `collectAgentsDocs()` recursively aggregates all `AGENTS.md` files\n2. `buildRootPrompt()` reads root `package.json` for project metadata (`name`, `version`, `description`, `packageManager`, `scripts`)\n3. Sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`\n4. Templates enforce synthesis-only constraint (no invention/extrapolation, every claim traceable to `AGENTS.md`)\n\n### Dependency Graph Construction\n\n`buildExecutionPlan()` constructs task dependencies:\n- File tasks: `id: 'file:${path}'`, `dependencies: []`, `outputPath: ${absolutePath}.sum`\n- Directory tasks: `id: 'dir:${dir}'`, `dependencies` array populated from `directoryFileMap[dir]` paths mapped to `file:${path}` task IDs, `metadata.depth` from `getDirectoryDepth(dir)`, `metadata.directoryFiles` as file list\n- Root tasks: `id: 'root:CLAUDE.md'`, `dependencies` array containing all directory task IDs\n\nDirectory tasks wait for child file tasks via `isDirectoryComplete()` checking `.sum` file existence. Root tasks wait for all directory tasks via dependency array containing every `dir:${path}` task ID.\n\n### Incremental Update Support\n\n`buildFilePrompt()` switches to `FILE_UPDATE_SYSTEM_PROMPT` when `existingSum` detected, instructing: \"preserve structure/headings/phrasing verbatim where code unchanged, add/remove sections only when code introduces/deletes concepts\". Similarly `buildDirectoryPrompt()` switches to `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` present. Reduces version control churn during `are update` workflow by minimizing unnecessary rewrites.\n\n## File Relationships\n\n**Consumed by src/orchestration/runner.ts:**\n- Calls `createOrchestrator()` from `orchestrator.ts` to instantiate `GenerationOrchestrator`\n- Calls `orchestrator.createPlan()` to generate `GenerationPlan`\n- Calls `buildExecutionPlan()` from `executor.ts` to transform plan into dependency-ordered `ExecutionPlan`\n- Executes tasks respecting `dependencies[]` ordering via worker pool\n\n**Consumes src/imports/extractor.ts:**\n- Calls `extractDirectoryImports()` in `buildFilePrompt()` to inject import context for Phase 1 file analysis\n- Calls `extractDirectoryImports()` in `buildDirectoryPrompt()` to inject import maps for Phase 2 directory synthesis\n\n**Consumes src/ai/service.ts:**\n- `runner.ts` invokes `AIService.call()` for each task, passing `systemPrompt`/`userPrompt` from `ExecutionTask`\n- LLM responses populate `AnalysisResult` with `summary`/`metadata` for `.sum` file writing\n\n**Consumed by src/cli/generate.ts:**\n- Imports `createOrchestrator` to orchestrate three-phase pipeline\n- Imports `buildExecutionPlan` to transform plan into executable tasks\n- Imports `formatExecutionPlanAsMarkdown` to write `GENERATION-PLAN.md`\n\n**Consumed by src/update/orchestrator.ts:**\n- Calls `readSumFile()` to extract `content_hash` for SHA-256 comparison during incremental updates\n- Calls `buildFilePrompt()` with `existingSum` parameter to trigger update-specific prompts\n\n**Consumed by src/quality/inconsistency/code-vs-doc.ts:**\n- Calls `readSumFile()` to extract exported symbols from `.sum` summaries for consistency validation\n\n## Integration Points\n\n**Trace Emission:** `GenerationOrchestrator.createPlan()` emits `phase:start`, `plan:created`, `phase:end` traces via `ITraceWriter` from `src/orchestration/trace.ts`.\n\n**Progress Tracking:** `formatExecutionPlanAsMarkdown()` output written to `GENERATION-PLAN.md` via `PlanTracker` in `src/orchestration/plan-tracker.ts`.\n\n**Memory Management:** `prepareFiles()` clears `content` fields on `PreparedFile` objects after `createFileTasks()` to release file content strings since content is already embedded in task prompts.\n\n**Quality Validation:** Exported symbols extracted via regex in `src/quality/inconsistency/code-vs-doc.ts` compared against `.sum` summary text via substring search; phantom paths extracted from `AGENTS.md` via three regex patterns in `src/quality/phantom-paths/validator.ts` resolved against filesystem via `existsSync()`.",
      "systemPrompt": "You are updating an existing AGENTS.md file — a directory-level overview for AI coding assistants. Some file summaries or subdirectory documents have changed, and AGENTS.md needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING AGENTS.md and the CURRENT file summaries and subdirectory documents\n- Preserve the structure, section headings, and descriptions that are still accurate\n- Only modify entries for files or subdirectories whose summaries have changed\n- Add entries for new files, remove entries for deleted files\n- Do NOT reorganize, rephrase, or restructure sections that are unaffected by changes\n- Keep the same section ordering unless files were added/removed in a way that requires regrouping\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Preserve the existing purpose statement unless the directory's role has fundamentally changed\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n- Cross-module references must use the specifier format from actual import statements\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context",
      "response": "<!-- Generated by agents-reverse-engineer -->\n\n# src/generation\n\n**Phase orchestration for three-stage AI-driven documentation pipeline: concurrent `.sum` file analysis via worker pools, post-order directory `AGENTS.md` synthesis with import map injection, and platform-specific root document generation from aggregated corpus.**\n\n## Contents\n\n### Orchestration & Planning\n\n**[orchestrator.ts](./orchestrator.ts)** — `GenerationOrchestrator` class with `prepareFiles()` reading file content via `readFile()`, `createFileTasks()` calling `buildFilePrompt()` for each file, `createDirectoryTasks()` grouping files by `path.dirname(relativePath)`, `createPlan()` emitting `phase:start`/`plan:created`/`phase:end` traces and returning `GenerationPlan` with `files`, `tasks`, `complexity` from `analyzeComplexity()`, `projectStructure` from `buildProjectStructure()`; memory management via `(file as { content: string }).content = ''` after task creation.\n\n**[executor.ts](./executor.ts)** — `buildExecutionPlan()` transforms `GenerationPlan` into `ExecutionPlan` with dependency-ordered `tasks[]`, `fileTasks[]`, `directoryTasks[]`, `rootTasks[]`, `directoryFileMap: Record<string, string[]>` via `path.dirname()` extraction, sorts directories by `getDirectoryDepth()` descending for post-order traversal; `isDirectoryComplete()` validates `.sum` file presence for expected files via `sumFileExists()`; `getReadyDirectories()` filters directories with complete file analysis; `formatExecutionPlanAsMarkdown()` renders plan with Phase 1/2/3 sections, groups files by directory with checkbox format, sorts directories by depth descending.\n\n**[complexity.ts](./complexity.ts)** — `analyzeComplexity()` returns `ComplexityMetrics` with `fileCount`, `directoryDepth` from `calculateDirectoryDepth()` splitting `path.relative()` on `path.sep`, `directories: Set<string>` from `extractDirectories()` walking parent chain via `path.dirname()` loop.\n\n**[types.ts](./types.ts)** — Defines `AnalysisResult` with `summary: string`, `metadata: SummaryMetadata` (`purpose`, `criticalTodos?`, `relatedFiles?`); `SummaryOptions` with `targetLength: 'short' | 'standard' | 'detailed'`, `includeCodeSnippets: boolean`.\n\n### Document Collection\n\n**[collector.ts](./collector.ts)** — `collectAgentsDocs()` recursively traverses directories via internal `walk()` closure using `readdir()` with `withFileTypes: true`, reads all `AGENTS.md` files via `readFile()`, computes relative paths via `path.relative()`, sorts results by `relativePath` via `localeCompare()`, skips 13 vendor directories (`node_modules`, `.git`, `.agents-reverse-engineer`, `vendor`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`) via `SKIP_DIRS.has(entry.name)` predicate; returns `AgentsDocs` array with `{ relativePath, content }` objects.\n\n## Subdirectories\n\n**[prompts/](./prompts/)** — Exports `buildFilePrompt()` constructing Phase 1 `.sum` analysis prompts with import context and incremental update support via `FILE_UPDATE_SYSTEM_PROMPT`, `buildDirectoryPrompt()` aggregating child summaries into Phase 2 `AGENTS.md` synthesis prompts with manifest detection (9 types: package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile) and `extractDirectoryImports()` for source files matching `/\\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, `buildRootPrompt()` collecting all `AGENTS.md` files via `collectAgentsDocs()` for Phase 3 platform-specific root document generation; templates enforce density rules (every sentence references identifiers, ban filler phrases), anchor term preservation (exact casing), path accuracy (use only Import Map paths); user documentation preserved via `AGENTS.local.md` prepending with comment block wrapper.\n\n**[writers/](./writers/)** — Exports `writeSumFile()` serializing YAML frontmatter with SHA-256 `content_hash` via `formatSumFile()`, `readSumFile()` parsing frontmatter via regex-based `parseSumFile()` with null on parse failure, `getSumPath()` appending `.sum` extension, `sumFileExists()` checking filesystem via `readSumFile()` null test; `writeAgentsMd()` implementing four-step protocol: in-place `AGENTS.md` → `AGENTS.local.md` rename if missing `GENERATED_MARKER`, fallback `AGENTS.local.md` load, marker stripping from LLM content, assembly with user content prepended in comment block; `parseYamlArray()`/`formatYamlArray()` supporting inline `[a, b, c]` and multi-line `- item` formats.\n\n## Architecture\n\n### Three-Phase Pipeline\n\n**Phase 1: Concurrent File Analysis**\n1. `GenerationOrchestrator.prepareFiles()` reads source file content via `readFile()`\n2. `createFileTasks()` calls `buildFilePrompt()` for each file with import context from `extractDirectoryImports()`\n3. Worker pool executes file tasks in parallel (default concurrency: 2 for WSL, 5 elsewhere)\n4. `writeSumFile()` persists `.sum` files with YAML frontmatter containing `generated_at`, `content_hash`, `purpose`, optional `critical_todos`/`related_files`\n\n**Phase 2: Post-Order Directory Aggregation**\n1. `buildExecutionPlan()` sorts directories by `getDirectoryDepth()` descending (deepest first)\n2. `isDirectoryComplete()` waits for all child `.sum` files to exist via `sumFileExists()` predicate\n3. `buildDirectoryPrompt()` reads child `.sum` files via `readSumFile()`, detects manifests (package.json, Cargo.toml, etc.), extracts import maps via `extractDirectoryImports()`\n4. `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` if non-generated, prepends user content to LLM output\n\n**Phase 3: Root Document Synthesis**\n1. `collectAgentsDocs()` recursively aggregates all `AGENTS.md` files\n2. `buildRootPrompt()` reads root `package.json` for project metadata (`name`, `version`, `description`, `packageManager`, `scripts`)\n3. Sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`\n4. Templates enforce synthesis-only constraint (no invention/extrapolation, every claim traceable to `AGENTS.md`)\n\n### Dependency Graph Construction\n\n`buildExecutionPlan()` constructs task dependencies:\n- File tasks: `id: 'file:${path}'`, `dependencies: []`, `outputPath: ${absolutePath}.sum`\n- Directory tasks: `id: 'dir:${dir}'`, `dependencies` array populated from `directoryFileMap[dir]` paths mapped to `file:${path}` task IDs, `metadata.depth` from `getDirectoryDepth(dir)`, `metadata.directoryFiles` as file list\n- Root tasks: `id: 'root:CLAUDE.md'`, `dependencies` array containing all directory task IDs\n\nDirectory tasks wait for child file tasks via `isDirectoryComplete()` checking `.sum` file existence. Root tasks wait for all directory tasks via dependency array containing every `dir:${path}` task ID.\n\n### Incremental Update Support\n\n`buildFilePrompt()` switches to `FILE_UPDATE_SYSTEM_PROMPT` when `existingSum` detected, instructing: \"preserve structure/headings/phrasing verbatim where code unchanged, add/remove sections only when code introduces/deletes concepts\". Similarly `buildDirectoryPrompt()` switches to `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` present. Reduces version control churn during `are update` workflow by minimizing unnecessary rewrites.\n\n## File Relationships\n\n**Consumed by src/orchestration/runner.ts:**\n- Calls `createOrchestrator()` from `orchestrator.ts` to instantiate `GenerationOrchestrator`\n- Calls `orchestrator.createPlan()` to generate `GenerationPlan`\n- Calls `buildExecutionPlan()` from `executor.ts` to transform plan into dependency-ordered `ExecutionPlan`\n- Executes tasks respecting `dependencies[]` ordering via worker pool\n\n**Consumes src/imports/extractor.ts:**\n- Calls `extractDirectoryImports()` in `buildFilePrompt()` to inject import context for Phase 1 file analysis\n- Calls `extractDirectoryImports()` in `buildDirectoryPrompt()` to inject import maps for Phase 2 directory synthesis\n\n**Consumes src/ai/service.ts:**\n- `runner.ts` invokes `AIService.call()` for each task, passing `systemPrompt`/`userPrompt` from `ExecutionTask`\n- LLM responses populate `AnalysisResult` with `summary`/`metadata` for `.sum` file writing\n\n**Consumed by src/cli/generate.ts:**\n- Imports `createOrchestrator` to orchestrate three-phase pipeline\n- Imports `buildExecutionPlan` to transform plan into executable tasks\n- Imports `formatExecutionPlanAsMarkdown` to write `GENERATION-PLAN.md`\n\n**Consumed by src/update/orchestrator.ts:**\n- Calls `readSumFile()` to extract `content_hash` for SHA-256 comparison during incremental updates\n- Calls `buildFilePrompt()` with `existingSum` parameter to trigger update-specific prompts\n\n**Consumed by src/quality/inconsistency/code-vs-doc.ts:**\n- Calls `readSumFile()` to extract exported symbols from `.sum` summaries for consistency validation\n\n## Integration Points\n\n**Trace Emission:** `GenerationOrchestrator.createPlan()` emits `phase:start`, `plan:created`, `phase:end` traces via `ITraceWriter` from `src/orchestration/trace.ts`.\n\n**Progress Tracking:** `formatExecutionPlanAsMarkdown()` output written to `GENERATION-PLAN.md` via `PlanTracker` in `src/orchestration/plan-tracker.ts`.\n\n**Memory Management:** `prepareFiles()` clears `content` fields on `PreparedFile` objects after `createFileTasks()` to release file content strings since content is already embedded in task prompts.\n\n**Quality Validation:** Exported symbols extracted via regex in `src/quality/inconsistency/code-vs-doc.ts` compared against `.sum` summary text via substring search; phantom paths extracted from `AGENTS.md` via three regex patterns in `src/quality/phantom-paths/validator.ts` resolved against filesystem via `existsSync()`.",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 2753,
      "cacheReadTokens": 17087,
      "cacheCreationTokens": 18169,
      "latencyMs": 54168,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": []
    },
    {
      "timestamp": "2026-02-09T15:53:25.157Z",
      "prompt": "Generate AGENTS.md for directory: \"specs\" (specs)\n\n## File Summaries (0 files)\n",
      "systemPrompt": "You are generating an AGENTS.md file — a directory-level overview for AI coding assistants.\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Write a one-paragraph purpose statement for the directory\nusage\nADAPTIVE SECTIONS:\nAnalyze the directory contents and choose the most relevant sections. Do NOT use a fixed template. Instead, select sections that best document this specific directory for an AI that needs to reconstruct or extend the project.\n\nConsider these section types (choose what applies):\n- **Contents**: Group files by purpose/category under ## headings. For each file: markdown link [filename](./filename) and a one-line description.\n- **Subdirectories**: If subdirectories exist, list them with links [dirname/](./dirname/) and brief summaries.\n- **Architecture / Data Flow**: If files form a pipeline, request/response chain, or layered architecture, document it.\n- **Stack**: If this is a package root (has package.json, Cargo.toml, go.mod, etc.), document the technology stack, key scripts, and entry points.\n- **Structure**: If the directory layout follows a convention (feature-sliced, domain-driven, MVC, etc.), document it.\n- **Patterns**: If files share recurring design patterns (factory, strategy, middleware, barrel re-export), name and document them.\n- **Configuration**: If the directory contains config files, schemas, or environment definitions, document the config surface area.\n- **API Surface**: If the directory exports a public API (barrel index, route definitions, SDK), document the interface contract.\n- **File Relationships**: How files collaborate, depend on each other, or share state.\n\nChoose any relevant sections or create your own based on the directory contents. The goal is to provide a comprehensive overview that captures the essence of the directory's role in the project and how its files work together, with a focus on what an AI coding assistant would need to know to effectively interact with this code.\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n  (e.g., if the directory is called \"cli\", write \"src/cli/\", NOT \"src/commands/\")\n- Cross-module references must use the specifier format from actual import statements\n  (e.g., \"../generation/writers/sum.js\", NOT \"../fs/sum-file.js\")\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context",
      "response": "<!-- Generated by agents-reverse-engineer -->\n\n# specs/\n\nPlanned location for synthesized project specifications extracted from AGENTS.md documentation corpus via `are specify` command. Contains high-level architectural overviews, API contracts, and feature requirements reconstructed from bottom-up directory documentation without access to source code.\n\n## Contents\n\n**This directory is currently empty.** When `npx agents-reverse-engineer specify` executes, it generates one of two output formats:\n\n- **Single-file mode** (default): Writes `SPEC.md` containing unified project specification aggregating all `AGENTS.md` files from repository root downward\n- **Multi-file mode** (`--multi-file` flag): Writes `<dirname>.md` for each top-level source directory (e.g., `src.md`, `cli.md`, `hooks.md`), splitting specification by architectural domain\n\n## Purpose\n\nSpecifications serve as AI-friendly reference documents for:\n\n- **Onboarding**: Provides entry-level architectural overview without requiring source code traversal\n- **Feature planning**: Identifies extension points, plugin systems, and integration boundaries documented in AGENTS.md\n- **Cross-project context**: Enables AI assistants to understand project capabilities when operating in adjacent codebases\n- **Requirement extraction**: Surfaces documented constraints, data flows, and dependency relationships for impact analysis\n\n## Generation Behavior\n\n`SpecificationSynthesizer` (invoked by `/are-specify` skill or `are specify` CLI):\n\n1. Calls `collectAgentsDocs()` to recursively gather all `AGENTS.md` files via `readDirectoryRecursive()`\n2. Parses root `package.json` for project metadata (name, version, description, scripts)\n3. Constructs prompt consuming aggregated AGENTS.md content with strict constraints:\n   - Synthesis-only: no invention of features/APIs/patterns absent from source documentation\n   - Preserve technical terminology and exported symbol names from AGENTS.md\n   - Document architectural patterns, data flows, extension mechanisms explicitly mentioned\n4. Invokes `AIService.call()` with `claude-code` backend (specification synthesis requires high-context model)\n5. Strips conversational preamble via `stripPreamble()` pattern matching\n6. Writes output to `specs/SPEC.md` or `specs/<dirname>.md` depending on mode\n\n## Relationship to AGENTS.md\n\n**AGENTS.md** documents individual directories from bottom-up via post-order traversal:\n- Per-file summaries in `.sum` frontmatter\n- Directory-level patterns, imports, file relationships\n- Navigational index optimized for AI file discovery\n\n**SPEC.md** synthesizes cross-cutting concerns from AGENTS.md corpus:\n- Project-wide architecture (three-phase pipeline, worker pool, subprocess management)\n- Public API surface (CLI commands, config schema, telemetry formats)\n- Integration contracts (session hooks, AI backend adapters, quality validators)\n- Development workflows (build, test, publish, IDE installation)\n\n## Usage\n\n**Generate unified specification:**\n```bash\nnpx agents-reverse-engineer specify\n# Writes specs/SPEC.md\n```\n\n**Generate split specifications by directory:**\n```bash\nnpx agents-reverse-engineer specify --multi-file\n# Writes specs/src.md, specs/hooks.md, specs/scripts.md\n```\n\n**Force overwrite existing specs:**\n```bash\nnpx agents-reverse-engineer specify --force\n# Overwrites specs/SPEC.md without prompt\n```\n\n## File Ownership\n\nGenerated specification files are **ephemeral artifacts** managed by ARE:\n- `are clean` does **not** remove specs (unlike AGENTS.md/CLAUDE.md)\n- `are specify` overwrites existing specs unless `--force` omitted and file exists (prompts for confirmation)\n- Manual edits to `SPEC.md` are preserved only if `are specify` not re-run or `--force` not used\n\nFor persistent specification amendments, create `SPEC.local.md` adjacent to generated files (ARE ignores `.local.md` suffix during specification generation).",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 2,
      "outputTokens": 940,
      "cacheReadTokens": 17375,
      "cacheCreationTokens": 8272,
      "latencyMs": 29630,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": []
    },
    {
      "timestamp": "2026-02-09T15:53:54.793Z",
      "prompt": "Generate AGENTS.md for directory: \"src\" (src)\n\n## File Summaries (1 files)\n\n### version.ts\n**Purpose:** version.ts exports getVersion() to retrieve the package version from package.json at runtime.\n\n**version.ts exports getVersion() to retrieve the package version from package.json at runtime.**\n\n## Exported Function\n\n`getVersion(): string` — Returns the version string from package.json or `'unknown'` if loading fails.\n\n## Implementation Strategy\n\nUses ES module path resolution via `import.meta.url` converted to file path with `fileURLToPath()`, then constructs absolute path to package.json by traversing one directory up from `__dirname` (`join(__dirname, '..', 'package.json')`). Reads file synchronously via `readFileSync()`, parses JSON, extracts `version` field with fallback to `'unknown'` if field is missing or falsy. Try-catch wrapper returns `'unknown'` on any filesystem or parse errors.\n\n## Dependencies\n\n- `node:fs` — `readFileSync()` for synchronous file read\n- `node:path` — `dirname()` and `join()` for path construction\n- `node:url` — `fileURLToPath()` for ES module path resolution\n\n## Usage Context\n\nCalled by CLI commands to display version information (e.g., `--version` flag, version check hooks). Package version used by session hooks (`are-check-update.js`) for npm registry comparison and by installer operations for reporting installed version. Supports both compiled distribution (`dist/` output) and source execution since path resolution is relative to current module location.\n\n## Subdirectories\n\n### generation/\n<!-- Generated by agents-reverse-engineer -->\n\n# src/generation\n\n**Phase orchestration for three-stage AI-driven documentation pipeline: concurrent `.sum` file analysis via worker pools, post-order directory `AGENTS.md` synthesis with import map injection, and platform-specific root document generation from aggregated corpus.**\n\n## Contents\n\n### Orchestration & Planning\n\n**[orchestrator.ts](./orchestrator.ts)** — `GenerationOrchestrator` class with `prepareFiles()` reading file content via `readFile()`, `createFileTasks()` calling `buildFilePrompt()` for each file, `createDirectoryTasks()` grouping files by `path.dirname(relativePath)`, `createPlan()` emitting `phase:start`/`plan:created`/`phase:end` traces and returning `GenerationPlan` with `files`, `tasks`, `complexity` from `analyzeComplexity()`, `projectStructure` from `buildProjectStructure()`; memory management via `(file as { content: string }).content = ''` after task creation.\n\n**[executor.ts](./executor.ts)** — `buildExecutionPlan()` transforms `GenerationPlan` into `ExecutionPlan` with dependency-ordered `tasks[]`, `fileTasks[]`, `directoryTasks[]`, `rootTasks[]`, `directoryFileMap: Record<string, string[]>` via `path.dirname()` extraction, sorts directories by `getDirectoryDepth()` descending for post-order traversal; `isDirectoryComplete()` validates `.sum` file presence for expected files via `sumFileExists()`; `getReadyDirectories()` filters directories with complete file analysis; `formatExecutionPlanAsMarkdown()` renders plan with Phase 1/2/3 sections, groups files by directory with checkbox format, sorts directories by depth descending.\n\n**[complexity.ts](./complexity.ts)** — `analyzeComplexity()` returns `ComplexityMetrics` with `fileCount`, `directoryDepth` from `calculateDirectoryDepth()` splitting `path.relative()` on `path.sep`, `directories: Set<string>` from `extractDirectories()` walking parent chain via `path.dirname()` loop.\n\n**[types.ts](./types.ts)** — Defines `AnalysisResult` with `summary: string`, `metadata: SummaryMetadata` (`purpose`, `criticalTodos?`, `relatedFiles?`); `SummaryOptions` with `targetLength: 'short' | 'standard' | 'detailed'`, `includeCodeSnippets: boolean`.\n\n### Document Collection\n\n**[collector.ts](./collector.ts)** — `collectAgentsDocs()` recursively traverses directories via internal `walk()` closure using `readdir()` with `withFileTypes: true`, reads all `AGENTS.md` files via `readFile()`, computes relative paths via `path.relative()`, sorts results by `relativePath` via `localeCompare()`, skips 13 vendor directories (`node_modules`, `.git`, `.agents-reverse-engineer`, `vendor`, `dist`, `build`, `__pycache__`, `.next`, `venv`, `.venv`, `target`, `.cargo`, `.gradle`) via `SKIP_DIRS.has(entry.name)` predicate; returns `AgentsDocs` array with `{ relativePath, content }` objects.\n\n## Subdirectories\n\n**[prompts/](./prompts/)** — Exports `buildFilePrompt()` constructing Phase 1 `.sum` analysis prompts with import context and incremental update support via `FILE_UPDATE_SYSTEM_PROMPT`, `buildDirectoryPrompt()` aggregating child summaries into Phase 2 `AGENTS.md` synthesis prompts with manifest detection (9 types: package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile) and `extractDirectoryImports()` for source files matching `/\\.(ts|tsx|js|jsx|py|go|rs|java|kt)$/`, `buildRootPrompt()` collecting all `AGENTS.md` files via `collectAgentsDocs()` for Phase 3 platform-specific root document generation; templates enforce density rules (every sentence references identifiers, ban filler phrases), anchor term preservation (exact casing), path accuracy (use only Import Map paths); user documentation preserved via `AGENTS.local.md` prepending with comment block wrapper.\n\n**[writers/](./writers/)** — Exports `writeSumFile()` serializing YAML frontmatter with SHA-256 `content_hash` via `formatSumFile()`, `readSumFile()` parsing frontmatter via regex-based `parseSumFile()` with null on parse failure, `getSumPath()` appending `.sum` extension, `sumFileExists()` checking filesystem via `readSumFile()` null test; `writeAgentsMd()` implementing four-step protocol: in-place `AGENTS.md` → `AGENTS.local.md` rename if missing `GENERATED_MARKER`, fallback `AGENTS.local.md` load, marker stripping from LLM content, assembly with user content prepended in comment block; `parseYamlArray()`/`formatYamlArray()` supporting inline `[a, b, c]` and multi-line `- item` formats.\n\n## Architecture\n\n### Three-Phase Pipeline\n\n**Phase 1: Concurrent File Analysis**\n1. `GenerationOrchestrator.prepareFiles()` reads source file content via `readFile()`\n2. `createFileTasks()` calls `buildFilePrompt()` for each file with import context from `extractDirectoryImports()`\n3. Worker pool executes file tasks in parallel (default concurrency: 2 for WSL, 5 elsewhere)\n4. `writeSumFile()` persists `.sum` files with YAML frontmatter containing `generated_at`, `content_hash`, `purpose`, optional `critical_todos`/`related_files`\n\n**Phase 2: Post-Order Directory Aggregation**\n1. `buildExecutionPlan()` sorts directories by `getDirectoryDepth()` descending (deepest first)\n2. `isDirectoryComplete()` waits for all child `.sum` files to exist via `sumFileExists()` predicate\n3. `buildDirectoryPrompt()` reads child `.sum` files via `readSumFile()`, detects manifests (package.json, Cargo.toml, etc.), extracts import maps via `extractDirectoryImports()`\n4. `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` if non-generated, prepends user content to LLM output\n\n**Phase 3: Root Document Synthesis**\n1. `collectAgentsDocs()` recursively aggregates all `AGENTS.md` files\n2. `buildRootPrompt()` reads root `package.json` for project metadata (`name`, `version`, `description`, `packageManager`, `scripts`)\n3. Sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`\n4. Templates enforce synthesis-only constraint (no invention/extrapolation, every claim traceable to `AGENTS.md`)\n\n### Dependency Graph Construction\n\n`buildExecutionPlan()` constructs task dependencies:\n- File tasks: `id: 'file:${path}'`, `dependencies: []`, `outputPath: ${absolutePath}.sum`\n- Directory tasks: `id: 'dir:${dir}'`, `dependencies` array populated from `directoryFileMap[dir]` paths mapped to `file:${path}` task IDs, `metadata.depth` from `getDirectoryDepth(dir)`, `metadata.directoryFiles` as file list\n- Root tasks: `id: 'root:CLAUDE.md'`, `dependencies` array containing all directory task IDs\n\nDirectory tasks wait for child file tasks via `isDirectoryComplete()` checking `.sum` file existence. Root tasks wait for all directory tasks via dependency array containing every `dir:${path}` task ID.\n\n### Incremental Update Support\n\n`buildFilePrompt()` switches to `FILE_UPDATE_SYSTEM_PROMPT` when `existingSum` detected, instructing: \"preserve structure/headings/phrasing verbatim where code unchanged, add/remove sections only when code introduces/deletes concepts\". Similarly `buildDirectoryPrompt()` switches to `DIRECTORY_UPDATE_SYSTEM_PROMPT` when `existingAgentsMd` present. Reduces version control churn during `are update` workflow by minimizing unnecessary rewrites.\n\n## File Relationships\n\n**Consumed by src/orchestration/runner.ts:**\n- Calls `createOrchestrator()` from `orchestrator.ts` to instantiate `GenerationOrchestrator`\n- Calls `orchestrator.createPlan()` to generate `GenerationPlan`\n- Calls `buildExecutionPlan()` from `executor.ts` to transform plan into dependency-ordered `ExecutionPlan`\n- Executes tasks respecting `dependencies[]` ordering via worker pool\n\n**Consumes src/imports/extractor.ts:**\n- Calls `extractDirectoryImports()` in `buildFilePrompt()` to inject import context for Phase 1 file analysis\n- Calls `extractDirectoryImports()` in `buildDirectoryPrompt()` to inject import maps for Phase 2 directory synthesis\n\n**Consumes src/ai/service.ts:**\n- `runner.ts` invokes `AIService.call()` for each task, passing `systemPrompt`/`userPrompt` from `ExecutionTask`\n- LLM responses populate `AnalysisResult` with `summary`/`metadata` for `.sum` file writing\n\n**Consumed by src/cli/generate.ts:**\n- Imports `createOrchestrator` to orchestrate three-phase pipeline\n- Imports `buildExecutionPlan` to transform plan into executable tasks\n- Imports `formatExecutionPlanAsMarkdown` to write `GENERATION-PLAN.md`\n\n**Consumed by src/update/orchestrator.ts:**\n- Calls `readSumFile()` to extract `content_hash` for SHA-256 comparison during incremental updates\n- Calls `buildFilePrompt()` with `existingSum` parameter to trigger update-specific prompts\n\n**Consumed by src/quality/inconsistency/code-vs-doc.ts:**\n- Calls `readSumFile()` to extract exported symbols from `.sum` summaries for consistency validation\n\n## Integration Points\n\n**Trace Emission:** `GenerationOrchestrator.createPlan()` emits `phase:start`, `plan:created`, `phase:end` traces via `ITraceWriter` from `src/orchestration/trace.ts`.\n\n**Progress Tracking:** `formatExecutionPlanAsMarkdown()` output written to `GENERATION-PLAN.md` via `PlanTracker` in `src/orchestration/plan-tracker.ts`.\n\n**Memory Management:** `prepareFiles()` clears `content` fields on `PreparedFile` objects after `createFileTasks()` to release file content strings since content is already embedded in task prompts.\n\n**Quality Validation:** Exported symbols extracted via regex in `src/quality/inconsistency/code-vs-doc.ts` compared against `.sum` summary text via substring search; phantom paths extracted from `AGENTS.md` via three regex patterns in `src/quality/phantom-paths/validator.ts` resolved against filesystem via `existsSync()`.\n### specify/\n<!-- Generated by agents-reverse-engineer -->\n\n# src/specify\n\nSynthesizes project specifications from AGENTS.md corpus through prompt construction (`buildSpecPrompt()`), AI invocation by CLI orchestrator, and filesystem output via `writeSpec()` with single-file/multi-file modes.\n\n## Contents\n\n### Core Modules\n\n**[prompts.ts](./prompts.ts)** — Prompt engineering infrastructure exporting `buildSpecPrompt(docs: AgentsDocs): SpecPrompt` to construct system/user prompt pairs from collected AGENTS.md files. System prompt (`SPEC_SYSTEM_PROMPT`) enforces concern-based organization (not directory mirroring) with nine mandatory sections: Project Overview (tech stack versions), Architecture (module boundaries, data flow), Public API Surface (full type signatures), Data Structures & State (schemas, state management), Configuration (Zod schemas, env vars), Dependencies (exact versions with rationale), Behavioral Contracts split into Runtime Behavior (error types/codes with throw conditions, retry logic formulas/delays, concurrency model, lifecycle hooks, resource management) and Implementation Contracts (verbatim regex patterns in backticks, format strings/templates with examples, magic constants/sentinel values with meanings, environment variables with expected values, file format specs for YAML schemas/NDJSON structures), Test Contracts (per-module scenarios with edge cases), Build Plan (phased implementation with dependency ordering). User prompt concatenates AGENTS.md content via `### ${relativePath}` sections and appends Output Requirements reiterating raw markdown constraint with emphasis on verbatim regex patterns, format specs, magic constants, and templates.\n\n**[writer.ts](./writer.ts)** — Filesystem writer exporting `writeSpec(content: string, options: WriteSpecOptions): Promise<string[]>` orchestrating single-file (`specs/SPEC.md`) vs. multi-file (`specs/<slug>.md`) output modes. Multi-file mode splits on top-level `# ` headings via `splitByHeadings()` regex (`/^(?=# )/m` positive lookahead), generates slugified filenames from heading text via `slugify()` lowercase+hyphen transform (`/\\s+/g → '-'`, `/[^a-z0-9-]/g → ''`). Pre-checks all target paths for existence before writing (atomic conflict detection), throws `SpecExistsError` with `paths[]` array if `force=false`. Creates parent directories via `mkdir({ recursive: true })`, returns absolute paths of written files.\n\n**[index.ts](./index.ts)** — Barrel export re-exporting `buildSpecPrompt()`, `SpecPrompt`, `writeSpec()`, `WriteSpecOptions`, `SpecExistsError` for consumption by `src/cli/specify.ts` command.\n\n## Data Flow\n\n1. **Specification synthesis** (`src/cli/specify.ts`) calls `collectAgentsDocs()` to recursively traverse project tree loading all `AGENTS.md` files with content and relative paths\n2. **Prompt construction** via `buildSpecPrompt(docs)` aggregates markdown sections into user prompt, pairs with `SPEC_SYSTEM_PROMPT` system instructions\n3. **AI invocation** by CLI orchestrator passes `SpecPrompt` to `AIService.call()`, receives synthesized specification markdown\n4. **Output writing** via `writeSpec(response, { outputPath, force, multiFile })` writes single spec or splits/slugifies into directory-per-heading structure\n5. **Error handling** catches `SpecExistsError` on overwrite protection failures, displays conflicting paths with `--force` hint\n\n## Architecture Constraints\n\nPrompt engineering prohibits directory-mirroring section structure, mandates MODULE BOUNDARY descriptions over file path prescriptions, requires exact symbol name preservation, enforces full type signatures with generics/parameters/return types, demands version numbers for all external dependencies, constrains Build Plan to phased dependency ordering without file path prescription, and requires MANDATORY verbatim inclusion of regex patterns, format strings, magic constants, and templates in Behavioral Contracts (no paraphrasing into prose descriptions).\n\n## Integration Points\n\nConsumed by `src/cli/specify.ts` implementing `/are-specify` command. Receives `AgentsDocs` type from `../generation/collector.js` containing array of `{ relativePath, content }` objects. Invokes AI backend via `AIService` from `../ai/service.ts` with constructed prompts. Filesystem operations via `node:fs/promises` (`writeFile`, `mkdir`, `access`) with no external npm dependencies.\n\n## Existing AGENTS.md (update this — preserve stable content, modify only what changed)\n\n<!-- Generated by agents-reverse-engineer -->\n\n# src\n\nRoot source directory implementing agents-reverse-engineer CLI: orchestrates three-phase AI-driven documentation pipeline (concurrent `.sum` file analysis, post-order `AGENTS.md` aggregation, platform-specific root synthesis) via worker pools with subprocess resource limits, gitignore-aware discovery, SHA-256 incremental updates, and NDJSON telemetry.\n\n## Contents\n\n**[version.ts](./version.ts)** — `getVersion()` retrieves package version from `package.json` via `import.meta.url` path resolution with `fileURLToPath()`, reads synchronously via `readFileSync()`, parses JSON extracting `version` field, fallback returns `'unknown'` on filesystem/parse errors.\n\n## Subdirectories\n\n**[ai/](./ai/)** — Backend-agnostic AI service layer: `AIService.call()` spawns AI CLI subprocesses (Claude Code, Gemini CLI, OpenCode) via `execFile()` with exponential backoff retry on rate limits, process group killing via `kill(-pid)`, resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`), `BackendRegistry` for auto-detection via `isAvailable()`, `TelemetryLogger.writeRunLog()` serializing token costs to timestamped JSON, `TraceWriter` emitting subprocess lifecycle events (`subprocess:spawn/exit`, `retry`).\n\n**[change-detection/](./change-detection/)** — Git-based change detection: `getChangedFiles()` parses `git diff --name-status -M` with rename detection, merges uncommitted changes via `git.status()` when `includeUncommitted` enabled, `computeContentHash()` generates SHA-256 hex digests, `FileChange` discriminated union with `status: 'added'|'modified'|'deleted'|'renamed'` and conditional `oldPath` for renames.\n\n**[cli/](./cli/)** — Command entry points: `index.ts` routes to `init`/`discover`/`generate`/`update`/`specify`/`clean` via `parseArgs()` flag extraction, `generate.ts` orchestrates three-phase pipeline with `CommandRunner.executeGenerate()`, `update.ts` runs incremental workflow via hash comparison with `preparePlan()`, all commands thread `ITraceWriter` for NDJSON emission and `ProgressLog` for streaming `.agents-reverse-engineer/progress.log`.\n\n**[config/](./config/)** — Zod-validated YAML config: `ConfigSchema` with numeric constraints (concurrency ∈ [1,20], timeoutMs > 0), `loadConfig()` async reader emitting `config:loaded` trace events, `writeDefaultConfig()` generator with inline documentation, `getDefaultConcurrency()` computing worker pool size via CPU cores and memory capacity (`floor(totalMemGB * 0.5 / 0.512)` preventing OOM in WSL).\n\n**[discovery/](./discovery/)** — Gitignore-aware file walker: `walkDirectory()` via `fast-glob('**/*')` with `.git/**` exclusion, `discoverFiles()` composing four-stage filter chain (gitignore, vendor, binary, custom) executing in order with short-circuit rejection, `applyFilters()` using concurrency-bounded pool (30 workers) emitting `filter:applied` trace events, `FilterResult` with `included`/`excluded` arrays.\n\n**[generation/](./generation/)** — Phase orchestration: `GenerationOrchestrator.createFileTasks()` calling `buildFilePrompt()` with import context, `buildExecutionPlan()` sorting directories by depth descending for post-order traversal, `buildDirectoryPrompt()` aggregating child `.sum` files with manifest detection (9 types: package.json, Cargo.toml, go.mod, etc.), `buildRootPrompt()` collecting all `AGENTS.md` via `collectAgentsDocs()`, `writeSumFile()` embedding SHA-256 `content_hash` in YAML frontmatter, `writeAgentsMd()` preserving user content via `AGENTS.local.md` prepending.\n\n**[imports/](./imports/)** — Static import analysis: `extractImports()` applying regex with five capture groups (type keyword, named symbols, namespace imports, default imports, module specifier), `extractDirectoryImports()` reading first 100 lines per file classifying relative imports into `internal` (`./`) and `external` (`../`) arrays, `formatImportMap()` serializing to human-readable text blocks consumed by directory aggregation prompts.\n\n**[installer/](./installer/)** — npx-driven installation: `runInstaller()` parsing flags via `parseInstallerArgs()`, routing to `installFiles()` writing templates from `getTemplatesForRuntime()` to `resolveInstallPath()` with hook registration mutating settings.json via `registerHooks()` (Claude nested format, Gemini flat format, OpenCode plugins), `uninstallFiles()` removing command templates and deregistering via `unregisterHooks()` filtering arrays by command pattern match, `selectRuntime()`/`selectLocation()` providing TTY-aware arrow key selection with `arrowKeySelect()` vs. `numberedSelect()` fallback.\n\n**[integration/](./integration/)** — Platform detection and template generation: `detectEnvironments()` scanning for `.claude/`, `CLAUDE.md`, `.opencode/`, `.aider.conf.yml` markers, `getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()` producing command files with frontmatter-wrapped templates (`.claude/skills/*/SKILL.md`, `.opencode/commands/*.md`, `.gemini/commands/*.toml`), `generateIntegrationFiles()` orchestrating write workflow with `ensureDir()` directory creation and `force`/`dryRun` handling.\n\n**[orchestration/](./orchestration/)** — Concurrency control and progress tracking: `runPool()` shared-iterator pattern executing `Array<() => Promise<T>>` task factories through concurrency-limited pool preventing batch-induced idling, `CommandRunner.executeGenerate()` sequencing Phase 1 concurrent file analysis, Phase 2 post-order directory aggregation grouped by depth, Phase 3 sequential root synthesis, `ProgressReporter` computing ETA via moving averages of last 10 durations, `PlanTracker`/`ProgressLog`/`TraceWriter` using promise-chain serialization (`writeQueue = writeQueue.then(...)`) preventing concurrent write corruption.\n\n**[output/](./output/)** — Terminal formatting: `createLogger()` factory using picocolors for ANSI coloring toggled via `LoggerOptions.colors`, `Logger` interface defining six output methods (`info`, `file`, `excluded`, `summary`, `warn`, `error`), `createSilentLogger()` returning no-op stubs for testing.\n\n**[quality/](./quality/)** — Post-generation validation: `checkCodeVsDoc()` extracting exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm` verifying presence in `.sum` summaries, `checkCodeVsCode()` aggregating exports into `Map<symbol, string[]>` detecting duplicates, `checkPhantomPaths()` applying three regex patterns (markdown links, backtick-quoted paths, prose-embedded paths) with six SKIP_PATTERNS, resolving candidates relative to AGENTS.md directory with `.js`→`.ts` fallback, `buildInconsistencyReport()` aggregating discriminated union issues with metadata.\n\n**[specify/](./specify/)** — Project specification synthesis: `buildSpecPrompt()` constructing system/user prompt pairs with `SPEC_SYSTEM_PROMPT` enforcing concern-based organization (nine mandatory sections: Project Overview, Architecture, Public API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts, Test Contracts, Build Plan), `writeSpec()` orchestrating single-file (`specs/SPEC.md`) vs. multi-file (`specs/<slug>.md`) output modes splitting on top-level `# ` headings via `/^(?=# )/m` regex, throwing `SpecExistsError` on overwrite protection failures.\n\n**[types/](./types/)** — Shared discovery result definitions: `ExcludedFile` (path + exclusion reason), `DiscoveryResult` (included files array + excluded file metadata), `DiscoveryStats` (metrics with `totalFiles`, `includedFiles`, `excludedFiles`, `exclusionReasons` histogram).\n\n**[update/](./update/)** — Incremental update system: `UpdateOrchestrator.preparePlan()` reading YAML `content_hash` from `.sum` frontmatter via `readSumFile()`, comparing against `computeContentHash()` SHA-256 output, classifying into `filesToAnalyze[]` (hash mismatch/missing) or `filesToSkip[]` (hash match), `cleanupOrphans()` deleting `.sum` files for deleted/renamed sources, `cleanupEmptyDirectoryDocs()` removing `AGENTS.md` from directories with no remaining source files, `getAffectedDirectories()` walking parent directory tree collecting paths requiring regeneration.\n\n## Architecture\n\n### Three-Phase Pipeline\n\n**Phase 1 (Concurrent File Analysis):** `GenerationOrchestrator.prepareFiles()` reads source content, `createFileTasks()` constructs prompts via `buildFilePrompt()` with import context from `extractDirectoryImports()`, `runPool()` executes file tasks through worker pool (default concurrency: 2 for WSL, 5 elsewhere), `writeSumFile()` persists `.sum` with YAML frontmatter containing `generated_at`, `content_hash` (SHA-256), `purpose`, optional `critical_todos`/`related_files`.\n\n**Phase 2 (Post-Order Directory Aggregation):** `buildExecutionPlan()` sorts directories by `getDirectoryDepth()` descending (deepest first), `isDirectoryComplete()` waits for all child `.sum` files via `sumFileExists()` predicate, `buildDirectoryPrompt()` reads child `.sum` files via `readSumFile()` and detects manifests (package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile), `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` if non-generated and prepends user content to LLM output.\n\n**Phase 3 (Root Document Synthesis):** `collectAgentsDocs()` recursively aggregates all `AGENTS.md` files, `buildRootPrompt()` reads root `package.json` for project metadata (`name`, `version`, `description`, `packageManager`, `scripts`), sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` with synthesis-only constraint (no invention/extrapolation, every claim traceable to `AGENTS.md`).\n\n### Iterator-Based Worker Pool\n\n`runPool()` shares single `tasks.entries()` iterator across N workers preventing batch anti-pattern. Workers execute tight loop: pickup task → execute → emit result → pickup next, maintaining full slot utilization. Iterator protocol atomicity ensures each `[index, task]` pair consumed by exactly one worker. Effective concurrency capped at `Math.min(options.concurrency, tasks.length)`.\n\n### Subprocess Resource Management\n\n`runSubprocess()` mitigates Claude CLI thread exhaustion (GitHub #5771: 200 NodeJS instances) via environment variables: `NODE_OPTIONS='--max-old-space-size=512'` limits heap to 512MB per subprocess, `UV_THREADPOOL_SIZE='4'` constrains libuv thread pool to 4 threads, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` prevents background task spawning, `--disallowedTools Task` blocks subagents. Process group killing via `kill(-pid)` terminates subprocess trees. SIGTERM sent at `timeoutMs`, SIGKILL escalation after 5s grace period.\n\n### Incremental Update Strategy\n\n`UpdateOrchestrator.preparePlan()` replaces git-based diffing with SHA-256 content hash comparison: reads `content_hash` from `.sum` YAML frontmatter, computes current hash via `computeContentHash()`, classifies files into `filesToAnalyze` (hash mismatch/missing) or `filesToSkip` (hash match). `cleanupOrphans()` deletes stale `.sum` files for deleted/renamed sources, `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with no remaining source files, `getAffectedDirectories()` walks parent directory tree collecting paths requiring regeneration.\n\n### Telemetry & Tracing\n\n`TelemetryLogger` accumulates `TelemetryEntry` instances with `addEntry()` per subprocess completion, `toRunLog()` assembles complete `RunLog` with shallow-copied entries and `getSummary()` aggregations (total tokens, error counts, unique files), `writeRunLog()` serializes to timestamped JSON (`.agents-reverse-engineer/logs/run-<timestamp>.json`), `cleanupOldLogs()` enforces retention limit (default 50) via lexicographic sort descending. `TraceWriter` emits NDJSON events (`phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`) to `.agents-reverse-engineer/traces/trace-<timestamp>.ndjson` with promise-chain serialization, auto-populated fields (`seq`, `ts`, `pid`, `elapsedMs`), `cleanupOldTraces()` enforcing 500-trace retention.",
      "systemPrompt": "You are updating an existing AGENTS.md file — a directory-level overview for AI coding assistants. Some file summaries or subdirectory documents have changed, and AGENTS.md needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING AGENTS.md and the CURRENT file summaries and subdirectory documents\n- Preserve the structure, section headings, and descriptions that are still accurate\n- Only modify entries for files or subdirectories whose summaries have changed\n- Add entries for new files, remove entries for deleted files\n- Do NOT reorganize, rephrase, or restructure sections that are unaffected by changes\n- Keep the same section ordering unless files were added/removed in a way that requires regrouping\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Preserve the existing purpose statement unless the directory's role has fundamentally changed\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n- Cross-module references must use the specifier format from actual import statements\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context",
      "response": "<!-- Generated by agents-reverse-engineer -->\n\n# src\n\nRoot source directory implementing agents-reverse-engineer CLI: orchestrates three-phase AI-driven documentation pipeline (concurrent `.sum` file analysis, post-order `AGENTS.md` aggregation, platform-specific root synthesis) via worker pools with subprocess resource limits, gitignore-aware discovery, SHA-256 incremental updates, and NDJSON telemetry.\n\n## Contents\n\n**[version.ts](./version.ts)** — `getVersion()` retrieves package version from `package.json` via `import.meta.url` path resolution with `fileURLToPath()`, reads synchronously via `readFileSync()`, parses JSON extracting `version` field, fallback returns `'unknown'` on filesystem/parse errors.\n\n## Subdirectories\n\n**[ai/](./ai/)** — Backend-agnostic AI service layer: `AIService.call()` spawns AI CLI subprocesses (Claude Code, Gemini CLI, OpenCode) via `execFile()` with exponential backoff retry on rate limits, process group killing via `kill(-pid)`, resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`), `BackendRegistry` for auto-detection via `isAvailable()`, `TelemetryLogger.writeRunLog()` serializing token costs to timestamped JSON, `TraceWriter` emitting subprocess lifecycle events (`subprocess:spawn/exit`, `retry`).\n\n**[change-detection/](./change-detection/)** — Git-based change detection: `getChangedFiles()` parses `git diff --name-status -M` with rename detection, merges uncommitted changes via `git.status()` when `includeUncommitted` enabled, `computeContentHash()` generates SHA-256 hex digests, `FileChange` discriminated union with `status: 'added'|'modified'|'deleted'|'renamed'` and conditional `oldPath` for renames.\n\n**[cli/](./cli/)** — Command entry points: `index.ts` routes to `init`/`discover`/`generate`/`update`/`specify`/`clean` via `parseArgs()` flag extraction, `generate.ts` orchestrates three-phase pipeline with `CommandRunner.executeGenerate()`, `update.ts` runs incremental workflow via hash comparison with `preparePlan()`, all commands thread `ITraceWriter` for NDJSON emission and `ProgressLog` for streaming `.agents-reverse-engineer/progress.log`.\n\n**[config/](./config/)** — Zod-validated YAML config: `ConfigSchema` with numeric constraints (concurrency ∈ [1,20], timeoutMs > 0), `loadConfig()` async reader emitting `config:loaded` trace events, `writeDefaultConfig()` generator with inline documentation, `getDefaultConcurrency()` computing worker pool size via CPU cores and memory capacity (`floor(totalMemGB * 0.5 / 0.512)` preventing OOM in WSL).\n\n**[discovery/](./discovery/)** — Gitignore-aware file walker: `walkDirectory()` via `fast-glob('**/*')` with `.git/**` exclusion, `discoverFiles()` composing four-stage filter chain (gitignore, vendor, binary, custom) executing in order with short-circuit rejection, `applyFilters()` using concurrency-bounded pool (30 workers) emitting `filter:applied` trace events, `FilterResult` with `included`/`excluded` arrays.\n\n**[generation/](./generation/)** — Phase orchestration for three-stage AI-driven documentation pipeline: concurrent `.sum` file analysis via worker pools, post-order directory `AGENTS.md` synthesis with import map injection, and platform-specific root document generation from aggregated corpus. `GenerationOrchestrator.createFileTasks()` calling `buildFilePrompt()` with import context, `buildExecutionPlan()` sorting directories by depth descending for post-order traversal, `buildDirectoryPrompt()` aggregating child `.sum` files with manifest detection (9 types: package.json, Cargo.toml, go.mod, etc.), `buildRootPrompt()` collecting all `AGENTS.md` via `collectAgentsDocs()`, `writeSumFile()` embedding SHA-256 `content_hash` in YAML frontmatter, `writeAgentsMd()` preserving user content via `AGENTS.local.md` prepending.\n\n**[imports/](./imports/)** — Static import analysis: `extractImports()` applying regex with five capture groups (type keyword, named symbols, namespace imports, default imports, module specifier), `extractDirectoryImports()` reading first 100 lines per file classifying relative imports into `internal` (`./`) and `external` (`../`) arrays, `formatImportMap()` serializing to human-readable text blocks consumed by directory aggregation prompts.\n\n**[installer/](./installer/)** — npx-driven installation: `runInstaller()` parsing flags via `parseInstallerArgs()`, routing to `installFiles()` writing templates from `getTemplatesForRuntime()` to `resolveInstallPath()` with hook registration mutating settings.json via `registerHooks()` (Claude nested format, Gemini flat format, OpenCode plugins), `uninstallFiles()` removing command templates and deregistering via `unregisterHooks()` filtering arrays by command pattern match, `selectRuntime()`/`selectLocation()` providing TTY-aware arrow key selection with `arrowKeySelect()` vs. `numberedSelect()` fallback.\n\n**[integration/](./integration/)** — Platform detection and template generation: `detectEnvironments()` scanning for `.claude/`, `CLAUDE.md`, `.opencode/`, `.aider.conf.yml` markers, `getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()` producing command files with frontmatter-wrapped templates (`.claude/skills/*/SKILL.md`, `.opencode/commands/*.md`, `.gemini/commands/*.toml`), `generateIntegrationFiles()` orchestrating write workflow with `ensureDir()` directory creation and `force`/`dryRun` handling.\n\n**[orchestration/](./orchestration/)** — Concurrency control and progress tracking: `runPool()` shared-iterator pattern executing `Array<() => Promise<T>>` task factories through concurrency-limited pool preventing batch-induced idling, `CommandRunner.executeGenerate()` sequencing Phase 1 concurrent file analysis, Phase 2 post-order directory aggregation grouped by depth, Phase 3 sequential root synthesis, `ProgressReporter` computing ETA via moving averages of last 10 durations, `PlanTracker`/`ProgressLog`/`TraceWriter` using promise-chain serialization (`writeQueue = writeQueue.then(...)`) preventing concurrent write corruption.\n\n**[output/](./output/)** — Terminal formatting: `createLogger()` factory using picocolors for ANSI coloring toggled via `LoggerOptions.colors`, `Logger` interface defining six output methods (`info`, `file`, `excluded`, `summary`, `warn`, `error`), `createSilentLogger()` returning no-op stubs for testing.\n\n**[quality/](./quality/)** — Post-generation validation: `checkCodeVsDoc()` extracting exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm` verifying presence in `.sum` summaries, `checkCodeVsCode()` aggregating exports into `Map<symbol, string[]>` detecting duplicates, `checkPhantomPaths()` applying three regex patterns (markdown links, backtick-quoted paths, prose-embedded paths) with six SKIP_PATTERNS, resolving candidates relative to AGENTS.md directory with `.js`→`.ts` fallback, `buildInconsistencyReport()` aggregating discriminated union issues with metadata.\n\n**[specify/](./specify/)** — Synthesizes project specifications from AGENTS.md corpus through prompt construction (`buildSpecPrompt()`), AI invocation by CLI orchestrator, and filesystem output via `writeSpec()` with single-file/multi-file modes. `buildSpecPrompt()` constructing system/user prompt pairs with `SPEC_SYSTEM_PROMPT` enforcing concern-based organization (nine mandatory sections: Project Overview, Architecture, Public API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts, Test Contracts, Build Plan), `writeSpec()` orchestrating single-file (`specs/SPEC.md`) vs. multi-file (`specs/<slug>.md`) output modes splitting on top-level `# ` headings via `/^(?=# )/m` regex, throwing `SpecExistsError` on overwrite protection failures.\n\n**[types/](./types/)** — Shared discovery result definitions: `ExcludedFile` (path + exclusion reason), `DiscoveryResult` (included files array + excluded file metadata), `DiscoveryStats` (metrics with `totalFiles`, `includedFiles`, `excludedFiles`, `exclusionReasons` histogram).\n\n**[update/](./update/)** — Incremental update system: `UpdateOrchestrator.preparePlan()` reading YAML `content_hash` from `.sum` frontmatter via `readSumFile()`, comparing against `computeContentHash()` SHA-256 output, classifying into `filesToAnalyze[]` (hash mismatch/missing) or `filesToSkip[]` (hash match), `cleanupOrphans()` deleting `.sum` files for deleted/renamed sources, `cleanupEmptyDirectoryDocs()` removing `AGENTS.md` from directories with no remaining source files, `getAffectedDirectories()` walking parent directory tree collecting paths requiring regeneration.\n\n## Architecture\n\n### Three-Phase Pipeline\n\n**Phase 1 (Concurrent File Analysis):** `GenerationOrchestrator.prepareFiles()` reads source content, `createFileTasks()` constructs prompts via `buildFilePrompt()` with import context from `extractDirectoryImports()`, `runPool()` executes file tasks through worker pool (default concurrency: 2 for WSL, 5 elsewhere), `writeSumFile()` persists `.sum` with YAML frontmatter containing `generated_at`, `content_hash` (SHA-256), `purpose`, optional `critical_todos`/`related_files`.\n\n**Phase 2 (Post-Order Directory Aggregation):** `buildExecutionPlan()` sorts directories by `getDirectoryDepth()` descending (deepest first), `isDirectoryComplete()` waits for all child `.sum` files via `sumFileExists()` predicate, `buildDirectoryPrompt()` reads child `.sum` files via `readSumFile()` and detects manifests (package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile), `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` if non-generated and prepends user content to LLM output.\n\n**Phase 3 (Root Document Synthesis):** `collectAgentsDocs()` recursively aggregates all `AGENTS.md` files, `buildRootPrompt()` reads root `package.json` for project metadata (`name`, `version`, `description`, `packageManager`, `scripts`), sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` with synthesis-only constraint (no invention/extrapolation, every claim traceable to `AGENTS.md`).\n\n### Iterator-Based Worker Pool\n\n`runPool()` shares single `tasks.entries()` iterator across N workers preventing batch anti-pattern. Workers execute tight loop: pickup task → execute → emit result → pickup next, maintaining full slot utilization. Iterator protocol atomicity ensures each `[index, task]` pair consumed by exactly one worker. Effective concurrency capped at `Math.min(options.concurrency, tasks.length)`.\n\n### Subprocess Resource Management\n\n`runSubprocess()` mitigates Claude CLI thread exhaustion (GitHub #5771: 200 NodeJS instances) via environment variables: `NODE_OPTIONS='--max-old-space-size=512'` limits heap to 512MB per subprocess, `UV_THREADPOOL_SIZE='4'` constrains libuv thread pool to 4 threads, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` prevents background task spawning, `--disallowedTools Task` blocks subagents. Process group killing via `kill(-pid)` terminates subprocess trees. SIGTERM sent at `timeoutMs`, SIGKILL escalation after 5s grace period.\n\n### Incremental Update Strategy\n\n`UpdateOrchestrator.preparePlan()` replaces git-based diffing with SHA-256 content hash comparison: reads `content_hash` from `.sum` YAML frontmatter, computes current hash via `computeContentHash()`, classifies files into `filesToAnalyze` (hash mismatch/missing) or `filesToSkip` (hash match). `cleanupOrphans()` deletes stale `.sum` files for deleted/renamed sources, `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with no remaining source files, `getAffectedDirectories()` walks parent directory tree collecting paths requiring regeneration.\n\n### Telemetry & Tracing\n\n`TelemetryLogger` accumulates `TelemetryEntry` instances with `addEntry()` per subprocess completion, `toRunLog()` assembles complete `RunLog` with shallow-copied entries and `getSummary()` aggregations (total tokens, error counts, unique files), `writeRunLog()` serializes to timestamped JSON (`.agents-reverse-engineer/logs/run-<timestamp>.json`), `cleanupOldLogs()` enforces retention limit (default 50) via lexicographic sort descending. `TraceWriter` emits NDJSON events (`phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`) to `.agents-reverse-engineer/traces/trace-<timestamp>.ndjson` with promise-chain serialization, auto-populated fields (`seq`, `ts`, `pid`, `elapsedMs`), `cleanupOldTraces()` enforcing 500-trace retention.",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 3464,
      "cacheReadTokens": 17087,
      "cacheCreationTokens": 15817,
      "latencyMs": 34276,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": []
    },
    {
      "timestamp": "2026-02-09T15:54:29.078Z",
      "prompt": "Generate AGENTS.md for directory: \".\" (agents-reverse-engineer)\n\n## File Summaries (5 files)\n\n### LANGUAGES-MANIFEST.md\n**Purpose:** LANGUAGES-MANIFEST.md catalogs package manifest file patterns across 25 programming languages with support status fla...\n\n**LANGUAGES-MANIFEST.md catalogs package manifest file patterns across 25 programming languages with support status flags for ARE's manifest detection system.**\n\n## Manifest Detection Support\n\n**Supported languages** (9 total): JavaScript/TypeScript (`package.json`), Python (`requirements.txt`, `pyproject.toml`, `setup.py`, `Pipfile`), Ruby (`Gemfile`), Go (`go.mod`), Rust (`Cargo.toml`), Java (`pom.xml`, `build.gradle`), PHP (`composer.json`), C/C++ (`CMakeLists.txt`, `conanfile.txt`, `vcpkg.json`).\n\n**Unsupported languages** (16 total): Kotlin, C#/.NET, Swift, Elixir, Erlang, Scala, Clojure, Haskell, Dart/Flutter, Lua, R, Julia, Zig, Nim, OCaml, and others without support flags.\n\n## Integration Points\n\nReferences `src/generation/prompts/builder.ts` function `buildDirectoryPrompt()` which includes manifest detection logic scanning for 9 manifest types. Column structure matches internal manifest filename arrays used during Phase 2 directory aggregation.\n\n## Manifest Categories\n\n**Single-file manifests**: `package.json` (npm/yarn/pnpm), `go.mod` (Go modules), `Cargo.toml` (Cargo), `Gemfile` (Bundler), `composer.json` (Composer), `pubspec.yaml` (Dart pub), `mix.exs` (Elixir Mix).\n\n**Multi-file manifests**: Python supports 4 alternatives (`requirements.txt`, `pyproject.toml`, `setup.py`, `Pipfile`), Java supports Maven (`pom.xml`) and Gradle (`build.gradle`), Haskell supports 3 formats (`package.yaml`, `*.cabal`, `stack.yaml`), C/C++ supports CMake/Conan/vcpkg variants.\n\n**Glob-based patterns**: Haskell `*.cabal`, C# `*.csproj`/`*.fsproj`, Lua `*.rockspec`, Nim `*.nimble`, OCaml `*.opam` require wildcard matching beyond exact filename checks.\n\n## Coverage Gaps\n\nARE currently implements exact filename matching for 9 manifest types. Unsupported languages with ✓ flags (Ruby, Java) indicate planned but unimplemented detection. Languages without flags represent documentation-only coverage without corresponding code paths in `buildDirectoryPrompt()`.\n### LICENSE\n**Purpose:** LICENSE grants MIT License permissions for agents-reverse-engineer package with copyright attribution to GeoloeG-IsT ...\n\n**LICENSE grants MIT License permissions for agents-reverse-engineer package with copyright attribution to GeoloeG-IsT (2026).**\n\n## License Terms\n\nMIT License permits unrestricted use, modification, distribution, sublicensing, and commercial sale of agents-reverse-engineer software and associated documentation files. Recipients must include copyright notice and permission text in all copies or substantial portions.\n\n## Copyright Holder\n\nCopyright holder: GeoloeG-IsT (2026).\n\n## Liability Disclaimer\n\nSoftware provided \"AS IS\" without warranties of MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, or NONINFRINGEMENT. Authors bear no liability for claims, damages, or liabilities arising from software use, whether in contract, tort, or other legal theory.\n\n## Distribution Requirements\n\nAll distributions (source or binary) must include copyright notice line `Copyright (c) 2026 GeoloeG-IsT` and full MIT License permission text. This requirement applies to copies and substantial portions of the software.\n\n## Integration Context\n\nReferenced by `package.json` \"license\" field (value: \"MIT\"). Included in npm tarball during publish workflow (`.github/workflows/publish.yml`). Copied to hooks/dist/ directory via `scripts/build-hooks.js` prepublish hook.\n### README.md\n**Purpose:** README.md serves as the primary user-facing documentation for agents-reverse-engineer, explaining installation, workf...\n\n**README.md serves as the primary user-facing documentation for agents-reverse-engineer, explaining installation, workflow, commands, and generated documentation formats with marketing-oriented positioning for AI assistant users.**\n\n## Installation Methods\n\nDescribes three installation approaches via `npx agents-reverse-engineer@latest`:\n- Interactive installer with runtime selection prompts (Claude Code, OpenCode, Gemini CLI, or all)\n- Non-interactive with `--runtime <rt>` flag and `-g` (global `~/.claude/`) or `-l` (local `./.claude/`) location flags\n- Uninstall via `npx agents-reverse-engineer@latest uninstall` removing command files, session hooks, ARE permissions from settings.json, and `.agents-reverse-engineer` folder (local only)\n\n## Core Workflow Steps\n\nDocuments six-step user workflow executed within AI assistant:\n1. `/are-init` — Creates `.agents-reverse-engineer/config.yaml` with exclusion patterns\n2. `/are-discover` — Scans codebase respecting `.gitignore`, generates `GENERATION-PLAN.md` via post-order traversal (deepest directories first)\n3. `/are-generate` — Three-phase execution: file analysis (`.sum` files) → directory docs (`AGENTS.md`) → root docs (`CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`)\n4. `/are-update` — Incremental regeneration for changed files only via hash-based change detection\n5. `/are-specify` — Synthesizes all `AGENTS.md` into `specs/SPEC.md` (supports `--multi-file` split and `--dry-run` preview)\n6. `/are-clean` — Removes all generated documentation artifacts\n\n## CLI Commands\n\nLists terminal commands with flags:\n- `are` or `are install` — Interactive installer (default)\n- `are install --runtime <rt> -g/-l` — Install to runtime globally/locally\n- `are install -u` — Uninstall (remove files/hooks)\n- `are init` — Create configuration file\n- `are discover` — List files for analysis (supports `--plan` for GENERATION-PLAN.md, `--show-excluded` for exclusion reasons)\n- `are generate` — Generate all documentation\n- `are update` — Update changed files only\n- `are specify` — Generate project specification\n- `are clean` — Remove all generated docs\n\nRuntime values: `claude`, `opencode`, `gemini`, `all`\n\n## AI Assistant Commands\n\nDocuments six slash commands available within IDE:\n- `/are-init` — Initialize config and commands\n- `/are-discover` — Rediscover and regenerate plan\n- `/are-generate` — Generate all documentation\n- `/are-update` — Update changed files only\n- `/are-specify` — Generate project specification\n- `/are-clean` — Remove all generated docs\n\nAll commands supported across Claude, OpenCode, Gemini runtimes.\n\n## Generated Documentation Formats\n\nDescribes three output artifact types:\n\n**`.sum` files** — Per-file summaries with YAML frontmatter containing `file_type`, `generated_at` timestamp, followed by Purpose, Public Interface, Dependencies, Implementation Notes sections. Example shows authentication service with `authenticate(token: string): User` and `generateToken(user: User): string` exports.\n\n**`AGENTS.md`** — Per-directory overviews containing directory role description, files grouped by purpose (Types, Services, Utils), subdirectory brief descriptions.\n\n**Root documents** — Platform-specific entry points:\n- `CLAUDE.md` — Auto-loaded by Claude Code\n- `GEMINI.md` — Entry point for Gemini CLI\n- `OPENCODE.md` — Entry point for OpenCode\n- `AGENTS.md` — Root directory overview (universal format)\n\n## Configuration Schema\n\nDocuments `.agents-reverse-engineer/config.yaml` structure with sections:\n\n**`exclude`** — File/directory exclusions:\n- `patterns: []` — Custom glob patterns (e.g., `[\"*.log\", \"temp/**\"]`)\n- `vendorDirs` — Directories to skip (node_modules, dist, .git)\n- `binaryExtensions` — File types to skip (.png, .jpg, .pdf)\n\n**`options`** — Discovery behavior:\n- `followSymlinks: false` — Follow symbolic links during traversal\n- `maxFileSize: 1048576` — Max file size in bytes (1MB default)\n\n**`output`** — Formatting:\n- `colors: true` — Use colors in terminal output\n- `verbose: true` — Show each file as processed\n\n**`ai`** — Service configuration:\n- `backend: auto` — Backend selection ('claude', 'gemini', 'opencode', 'auto')\n- `model: sonnet` — Model identifier (backend-specific)\n- `timeoutMs: 300000` — Subprocess timeout in ms (5 minutes)\n- `maxRetries: 3` — Max retries for transient errors\n- `concurrency: 5` — Parallel AI calls (1-10, lower for WSL/constrained environments)\n- `telemetry.keepRuns: 50` — Number of run logs to keep\n- `telemetry.costThresholdUsd: 10.0` — Optional warning threshold (USD)\n- `pricing` — Custom model pricing with `inputCostPerMTok` and `outputCostPerMTok` fields (USD per 1M tokens)\n\n## Key Configuration Options\n\n**Concurrency** (`ai.concurrency`):\n- Default: 5 (changed to 2 in WSL environments)\n- Range: 1-10\n- Lower values recommended for resource-constrained environments\n- Higher values speed up generation but increase memory usage\n\n**Timeout** (`ai.timeoutMs`):\n- Default: 300000 (5 minutes)\n- AI subprocess timeout for each file analysis\n- Increase for very large files or slow connections\n\n## Requirements\n\nLists runtime dependencies:\n- Node.js 18+\n- AI Coding Assistant supporting one of:\n  - Claude Code (full support + session hooks)\n  - Gemini CLI (full support + session hooks)\n  - OpenCode (AGENTS.md supported)\n  - Any assistant supporting `AGENTS.md` format\n\n## Positioning Strategy\n\nUses problem-solution narrative structure:\n- **Problem**: AI assistants don't persist codebase knowledge between sessions, requiring repeated architecture explanations\n- **Solution**: agents-reverse-engineer generates documentation formats AI assistants read (`.sum`, `AGENTS.md`, root docs)\n- **Target audience**: Developers using Claude Code, OpenCode, Gemini CLI, or tools supporting `AGENTS.md` format\n- **Value proposition**: \"Your AI assistant understands your codebase from the first message\"\n\n## Badge Display\n\nShows npm version badge linking to `https://www.npmjs.com/package/agents-reverse-engineer` and MIT license badge with for-the-badge styling.\n\n## License\n\nSpecifies MIT license.\n### package.json\n**Purpose:** package.json defines npm package metadata, build scripts, runtime dependencies, and distribution configuration for th...\n\n**package.json defines npm package metadata, build scripts, runtime dependencies, and distribution configuration for the agents-reverse-engineer CLI tool.**\n\n## Package Identity\n\n- `name`: \"agents-reverse-engineer\"\n- `version`: \"0.6.4\" (semantic versioning)\n- `description`: \"CLI tool for reverse-engineering codebase documentation for AI agents\"\n- `type`: \"module\" (ES module package)\n- `author`: \"GeoloeG-IsT\"\n- `license`: \"MIT\"\n\n## Binary Entry Points\n\n- `bin.agents-reverse-engineer`: \"dist/cli/index.js\" (full command name)\n- `bin.are`: \"dist/cli/index.js\" (shorthand alias)\n\nBoth binaries resolve to compiled TypeScript output at `dist/cli/index.js`.\n\n## Build Scripts\n\n- `build`: \"tsc\" (TypeScript compilation from src/ to dist/)\n- `build:hooks`: \"node scripts/build-hooks.js\" (copies hooks/ to hooks/dist/ for npm distribution)\n- `prepublishOnly`: \"npm run build && npm run build:hooks\" (pre-publish pipeline ensuring compiled artifacts exist)\n- `dev`: \"tsx watch src/cli/index.ts\" (hot-reload development mode via tsx watcher)\n\n## Runtime Dependencies\n\n- `fast-glob@^3.3.3`: File discovery with glob pattern matching\n- `ignore@^7.0.3`: Gitignore parsing for file filtering\n- `isbinaryfile@^5.0.4`: Binary file detection during discovery\n- `ora@^8.1.1`: Spinner UI for progress indication\n- `picocolors@^1.1.1`: ANSI color formatting for terminal output\n- `simple-git@^3.27.0`: Git integration for change detection (diff parsing, rename tracking)\n- `yaml@^2.7.0`: YAML parsing for config.yaml and .sum frontmatter\n- `zod@^3.24.1`: Schema validation for configuration and structured data\n\n## Development Dependencies\n\n- `@types/node@^22.10.7`: Node.js type definitions for TypeScript\n- `tsx@^4.19.2`: TypeScript execution and watch mode for development\n- `typescript@^5.7.3`: TypeScript compiler (targets ES2022, NodeNext module resolution)\n\n## Engine Requirements\n\n- `node`: \">=18.0.0\" (minimum Node.js version for ES module support and API compatibility)\n\n## Distribution Files\n\n`files` array specifies npm package contents:\n- `dist`: Compiled TypeScript output (CLI entry point, all modules)\n- `hooks/dist`: Compiled session lifecycle hooks for IDE integration\n- `README.md`: User documentation\n- `LICENSE`: MIT license text\n\nExcludes source TypeScript (`src/`), development scripts (`scripts/`), configuration (`tsconfig.json`), and documentation (`docs/`).\n\n## Repository Metadata\n\n- `repository.type`: \"git\"\n- `repository.url`: \"git+https://github.com/GeoloeG-IsT/agents-reverse-engineer.git\"\n- `bugs.url`: \"https://github.com/GeoloeG-IsT/agents-reverse-engineer/issues\"\n- `homepage`: \"https://github.com/GeoloeG-IsT/agents-reverse-engineer#readme\"\n\n## Keywords\n\n`keywords` array for npm search discoverability:\n- \"documentation\"\n- \"codebase\"\n- \"ai\"\n- \"agents\"\n- \"reverse-engineering\"\n\n## Main Entry Point\n\n- `main`: \"dist/cli/index.js\" (package entry for programmatic imports, though primarily consumed as CLI tool)\n### tsconfig.json\n**Purpose:** tsconfig.json configures TypeScript compiler for ES2022 Node.js module compilation with strict type-checking and sour...\n\n**tsconfig.json configures TypeScript compiler for ES2022 Node.js module compilation with strict type-checking and source map generation.**\n\n## Compiler Target Configuration\n\n`target: \"ES2022\"` specifies ECMAScript 2022 as compilation target, enabling top-level await, class fields, and private methods in emitted JavaScript.\n\n`lib: [\"ES2022\"]` restricts TypeScript to ES2022 standard library type definitions, preventing usage of newer APIs not available in Node.js ≥18.0.0.\n\n## Module System\n\n`module: \"NodeNext\"` and `moduleResolution: \"NodeNext\"` enable Node.js native ESM support with `.js` extension requirements in import statements and package.json `\"type\": \"module\"` detection.\n\n`esModuleInterop: true` enables CommonJS/ESM interop via synthetic default imports for libraries without default exports.\n\n`resolveJsonModule: true` allows importing `.json` files as modules (used for package.json metadata in `src/integration/generate.ts` and version detection).\n\n`isolatedModules: true` enforces single-file transpilation compatibility required by `tsx` dev runner and Vite-based build tools.\n\n## Build Paths\n\n`rootDir: \"src\"` designates `src/` as compilation root, preserving directory structure in output.\n\n`outDir: \"dist\"` emits compiled JavaScript to `dist/` directory (referenced by `package.json` bin entries `dist/cli/index.js`).\n\n`include: [\"src/**/*\"]` compiles all TypeScript files under `src/`.\n\n`exclude: [\"node_modules\", \"dist\"]` prevents compilation of dependencies and emitted output.\n\n## Type Declaration Generation\n\n`declaration: true` emits `.d.ts` type declaration files alongside compiled `.js` files for API consumers.\n\n`declarationMap: true` generates `.d.ts.map` files enabling IDE jump-to-source navigation from compiled declarations to original TypeScript source.\n\n`sourceMap: true` generates `.js.map` files for debugging compiled code with source-level stack traces.\n\n## Type Safety\n\n`strict: true` enables all strict type-checking options (strictNullChecks, strictFunctionTypes, strictBindCallApply, strictPropertyInitialization, noImplicitThis, alwaysStrict, noImplicitAny, noImplicitReturns, noFallthroughCasesInSwitch).\n\n`forceConsistentCasingInFileNames: true` prevents cross-platform issues from case-insensitive filesystems treating `Logger.ts` and `logger.ts` as identical.\n\n`skipLibCheck: true` skips type-checking of `.d.ts` files in `node_modules/` to reduce compilation time (necessary with 40+ dependencies including `@anthropic-ai/claude-code`, `fast-glob`, `zod`).\n\n## Integration with Build Pipeline\n\nReferenced by `npm run build` in package.json, which executes `tsc` without arguments (reads tsconfig.json by default).\n\nConsumed by `tsx watch src/cli/index.ts` dev mode (npm run dev) for hot-reload type-checking.\n\nUsed by npm prepublishOnly hook to compile src/ → dist/ before tarball creation for registry publishing.\n\n## Subdirectories\n\n### specs/\n<!-- Generated by agents-reverse-engineer -->\n\n# specs/\n\nPlanned location for synthesized project specifications extracted from AGENTS.md documentation corpus via `are specify` command. Contains high-level architectural overviews, API contracts, and feature requirements reconstructed from bottom-up directory documentation without access to source code.\n\n## Contents\n\n**This directory is currently empty.** When `npx agents-reverse-engineer specify` executes, it generates one of two output formats:\n\n- **Single-file mode** (default): Writes `SPEC.md` containing unified project specification aggregating all `AGENTS.md` files from repository root downward\n- **Multi-file mode** (`--multi-file` flag): Writes `<dirname>.md` for each top-level source directory (e.g., `src.md`, `cli.md`, `hooks.md`), splitting specification by architectural domain\n\n## Purpose\n\nSpecifications serve as AI-friendly reference documents for:\n\n- **Onboarding**: Provides entry-level architectural overview without requiring source code traversal\n- **Feature planning**: Identifies extension points, plugin systems, and integration boundaries documented in AGENTS.md\n- **Cross-project context**: Enables AI assistants to understand project capabilities when operating in adjacent codebases\n- **Requirement extraction**: Surfaces documented constraints, data flows, and dependency relationships for impact analysis\n\n## Generation Behavior\n\n`SpecificationSynthesizer` (invoked by `/are-specify` skill or `are specify` CLI):\n\n1. Calls `collectAgentsDocs()` to recursively gather all `AGENTS.md` files via `readDirectoryRecursive()`\n2. Parses root `package.json` for project metadata (name, version, description, scripts)\n3. Constructs prompt consuming aggregated AGENTS.md content with strict constraints:\n   - Synthesis-only: no invention of features/APIs/patterns absent from source documentation\n   - Preserve technical terminology and exported symbol names from AGENTS.md\n   - Document architectural patterns, data flows, extension mechanisms explicitly mentioned\n4. Invokes `AIService.call()` with `claude-code` backend (specification synthesis requires high-context model)\n5. Strips conversational preamble via `stripPreamble()` pattern matching\n6. Writes output to `specs/SPEC.md` or `specs/<dirname>.md` depending on mode\n\n## Relationship to AGENTS.md\n\n**AGENTS.md** documents individual directories from bottom-up via post-order traversal:\n- Per-file summaries in `.sum` frontmatter\n- Directory-level patterns, imports, file relationships\n- Navigational index optimized for AI file discovery\n\n**SPEC.md** synthesizes cross-cutting concerns from AGENTS.md corpus:\n- Project-wide architecture (three-phase pipeline, worker pool, subprocess management)\n- Public API surface (CLI commands, config schema, telemetry formats)\n- Integration contracts (session hooks, AI backend adapters, quality validators)\n- Development workflows (build, test, publish, IDE installation)\n\n## Usage\n\n**Generate unified specification:**\n```bash\nnpx agents-reverse-engineer specify\n# Writes specs/SPEC.md\n```\n\n**Generate split specifications by directory:**\n```bash\nnpx agents-reverse-engineer specify --multi-file\n# Writes specs/src.md, specs/hooks.md, specs/scripts.md\n```\n\n**Force overwrite existing specs:**\n```bash\nnpx agents-reverse-engineer specify --force\n# Overwrites specs/SPEC.md without prompt\n```\n\n## File Ownership\n\nGenerated specification files are **ephemeral artifacts** managed by ARE:\n- `are clean` does **not** remove specs (unlike AGENTS.md/CLAUDE.md)\n- `are specify` overwrites existing specs unless `--force` omitted and file exists (prompts for confirmation)\n- Manual edits to `SPEC.md` are preserved only if `are specify` not re-run or `--force` not used\n\nFor persistent specification amendments, create `SPEC.local.md` adjacent to generated files (ARE ignores `.local.md` suffix during specification generation).\n### src/\n<!-- Generated by agents-reverse-engineer -->\n\n# src\n\nRoot source directory implementing agents-reverse-engineer CLI: orchestrates three-phase AI-driven documentation pipeline (concurrent `.sum` file analysis, post-order `AGENTS.md` aggregation, platform-specific root synthesis) via worker pools with subprocess resource limits, gitignore-aware discovery, SHA-256 incremental updates, and NDJSON telemetry.\n\n## Contents\n\n**[version.ts](./version.ts)** — `getVersion()` retrieves package version from `package.json` via `import.meta.url` path resolution with `fileURLToPath()`, reads synchronously via `readFileSync()`, parses JSON extracting `version` field, fallback returns `'unknown'` on filesystem/parse errors.\n\n## Subdirectories\n\n**[ai/](./ai/)** — Backend-agnostic AI service layer: `AIService.call()` spawns AI CLI subprocesses (Claude Code, Gemini CLI, OpenCode) via `execFile()` with exponential backoff retry on rate limits, process group killing via `kill(-pid)`, resource limits (`NODE_OPTIONS='--max-old-space-size=512'`, `UV_THREADPOOL_SIZE='4'`, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'`), `BackendRegistry` for auto-detection via `isAvailable()`, `TelemetryLogger.writeRunLog()` serializing token costs to timestamped JSON, `TraceWriter` emitting subprocess lifecycle events (`subprocess:spawn/exit`, `retry`).\n\n**[change-detection/](./change-detection/)** — Git-based change detection: `getChangedFiles()` parses `git diff --name-status -M` with rename detection, merges uncommitted changes via `git.status()` when `includeUncommitted` enabled, `computeContentHash()` generates SHA-256 hex digests, `FileChange` discriminated union with `status: 'added'|'modified'|'deleted'|'renamed'` and conditional `oldPath` for renames.\n\n**[cli/](./cli/)** — Command entry points: `index.ts` routes to `init`/`discover`/`generate`/`update`/`specify`/`clean` via `parseArgs()` flag extraction, `generate.ts` orchestrates three-phase pipeline with `CommandRunner.executeGenerate()`, `update.ts` runs incremental workflow via hash comparison with `preparePlan()`, all commands thread `ITraceWriter` for NDJSON emission and `ProgressLog` for streaming `.agents-reverse-engineer/progress.log`.\n\n**[config/](./config/)** — Zod-validated YAML config: `ConfigSchema` with numeric constraints (concurrency ∈ [1,20], timeoutMs > 0), `loadConfig()` async reader emitting `config:loaded` trace events, `writeDefaultConfig()` generator with inline documentation, `getDefaultConcurrency()` computing worker pool size via CPU cores and memory capacity (`floor(totalMemGB * 0.5 / 0.512)` preventing OOM in WSL).\n\n**[discovery/](./discovery/)** — Gitignore-aware file walker: `walkDirectory()` via `fast-glob('**/*')` with `.git/**` exclusion, `discoverFiles()` composing four-stage filter chain (gitignore, vendor, binary, custom) executing in order with short-circuit rejection, `applyFilters()` using concurrency-bounded pool (30 workers) emitting `filter:applied` trace events, `FilterResult` with `included`/`excluded` arrays.\n\n**[generation/](./generation/)** — Phase orchestration for three-stage AI-driven documentation pipeline: concurrent `.sum` file analysis via worker pools, post-order directory `AGENTS.md` synthesis with import map injection, and platform-specific root document generation from aggregated corpus. `GenerationOrchestrator.createFileTasks()` calling `buildFilePrompt()` with import context, `buildExecutionPlan()` sorting directories by depth descending for post-order traversal, `buildDirectoryPrompt()` aggregating child `.sum` files with manifest detection (9 types: package.json, Cargo.toml, go.mod, etc.), `buildRootPrompt()` collecting all `AGENTS.md` via `collectAgentsDocs()`, `writeSumFile()` embedding SHA-256 `content_hash` in YAML frontmatter, `writeAgentsMd()` preserving user content via `AGENTS.local.md` prepending.\n\n**[imports/](./imports/)** — Static import analysis: `extractImports()` applying regex with five capture groups (type keyword, named symbols, namespace imports, default imports, module specifier), `extractDirectoryImports()` reading first 100 lines per file classifying relative imports into `internal` (`./`) and `external` (`../`) arrays, `formatImportMap()` serializing to human-readable text blocks consumed by directory aggregation prompts.\n\n**[installer/](./installer/)** — npx-driven installation: `runInstaller()` parsing flags via `parseInstallerArgs()`, routing to `installFiles()` writing templates from `getTemplatesForRuntime()` to `resolveInstallPath()` with hook registration mutating settings.json via `registerHooks()` (Claude nested format, Gemini flat format, OpenCode plugins), `uninstallFiles()` removing command templates and deregistering via `unregisterHooks()` filtering arrays by command pattern match, `selectRuntime()`/`selectLocation()` providing TTY-aware arrow key selection with `arrowKeySelect()` vs. `numberedSelect()` fallback.\n\n**[integration/](./integration/)** — Platform detection and template generation: `detectEnvironments()` scanning for `.claude/`, `CLAUDE.md`, `.opencode/`, `.aider.conf.yml` markers, `getClaudeTemplates()`/`getOpenCodeTemplates()`/`getGeminiTemplates()` producing command files with frontmatter-wrapped templates (`.claude/skills/*/SKILL.md`, `.opencode/commands/*.md`, `.gemini/commands/*.toml`), `generateIntegrationFiles()` orchestrating write workflow with `ensureDir()` directory creation and `force`/`dryRun` handling.\n\n**[orchestration/](./orchestration/)** — Concurrency control and progress tracking: `runPool()` shared-iterator pattern executing `Array<() => Promise<T>>` task factories through concurrency-limited pool preventing batch-induced idling, `CommandRunner.executeGenerate()` sequencing Phase 1 concurrent file analysis, Phase 2 post-order directory aggregation grouped by depth, Phase 3 sequential root synthesis, `ProgressReporter` computing ETA via moving averages of last 10 durations, `PlanTracker`/`ProgressLog`/`TraceWriter` using promise-chain serialization (`writeQueue = writeQueue.then(...)`) preventing concurrent write corruption.\n\n**[output/](./output/)** — Terminal formatting: `createLogger()` factory using picocolors for ANSI coloring toggled via `LoggerOptions.colors`, `Logger` interface defining six output methods (`info`, `file`, `excluded`, `summary`, `warn`, `error`), `createSilentLogger()` returning no-op stubs for testing.\n\n**[quality/](./quality/)** — Post-generation validation: `checkCodeVsDoc()` extracting exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm` verifying presence in `.sum` summaries, `checkCodeVsCode()` aggregating exports into `Map<symbol, string[]>` detecting duplicates, `checkPhantomPaths()` applying three regex patterns (markdown links, backtick-quoted paths, prose-embedded paths) with six SKIP_PATTERNS, resolving candidates relative to AGENTS.md directory with `.js`→`.ts` fallback, `buildInconsistencyReport()` aggregating discriminated union issues with metadata.\n\n**[specify/](./specify/)** — Synthesizes project specifications from AGENTS.md corpus through prompt construction (`buildSpecPrompt()`), AI invocation by CLI orchestrator, and filesystem output via `writeSpec()` with single-file/multi-file modes. `buildSpecPrompt()` constructing system/user prompt pairs with `SPEC_SYSTEM_PROMPT` enforcing concern-based organization (nine mandatory sections: Project Overview, Architecture, Public API Surface, Data Structures, Configuration, Dependencies, Behavioral Contracts, Test Contracts, Build Plan), `writeSpec()` orchestrating single-file (`specs/SPEC.md`) vs. multi-file (`specs/<slug>.md`) output modes splitting on top-level `# ` headings via `/^(?=# )/m` regex, throwing `SpecExistsError` on overwrite protection failures.\n\n**[types/](./types/)** — Shared discovery result definitions: `ExcludedFile` (path + exclusion reason), `DiscoveryResult` (included files array + excluded file metadata), `DiscoveryStats` (metrics with `totalFiles`, `includedFiles`, `excludedFiles`, `exclusionReasons` histogram).\n\n**[update/](./update/)** — Incremental update system: `UpdateOrchestrator.preparePlan()` reading YAML `content_hash` from `.sum` frontmatter via `readSumFile()`, comparing against `computeContentHash()` SHA-256 output, classifying into `filesToAnalyze[]` (hash mismatch/missing) or `filesToSkip[]` (hash match), `cleanupOrphans()` deleting `.sum` files for deleted/renamed sources, `cleanupEmptyDirectoryDocs()` removing `AGENTS.md` from directories with no remaining source files, `getAffectedDirectories()` walking parent directory tree collecting paths requiring regeneration.\n\n## Architecture\n\n### Three-Phase Pipeline\n\n**Phase 1 (Concurrent File Analysis):** `GenerationOrchestrator.prepareFiles()` reads source content, `createFileTasks()` constructs prompts via `buildFilePrompt()` with import context from `extractDirectoryImports()`, `runPool()` executes file tasks through worker pool (default concurrency: 2 for WSL, 5 elsewhere), `writeSumFile()` persists `.sum` with YAML frontmatter containing `generated_at`, `content_hash` (SHA-256), `purpose`, optional `critical_todos`/`related_files`.\n\n**Phase 2 (Post-Order Directory Aggregation):** `buildExecutionPlan()` sorts directories by `getDirectoryDepth()` descending (deepest first), `isDirectoryComplete()` waits for all child `.sum` files via `sumFileExists()` predicate, `buildDirectoryPrompt()` reads child `.sum` files via `readSumFile()` and detects manifests (package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile), `writeAgentsMd()` renames user `AGENTS.md` → `AGENTS.local.md` if non-generated and prepends user content to LLM output.\n\n**Phase 3 (Root Document Synthesis):** `collectAgentsDocs()` recursively aggregates all `AGENTS.md` files, `buildRootPrompt()` reads root `package.json` for project metadata (`name`, `version`, `description`, `packageManager`, `scripts`), sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` with synthesis-only constraint (no invention/extrapolation, every claim traceable to `AGENTS.md`).\n\n### Iterator-Based Worker Pool\n\n`runPool()` shares single `tasks.entries()` iterator across N workers preventing batch anti-pattern. Workers execute tight loop: pickup task → execute → emit result → pickup next, maintaining full slot utilization. Iterator protocol atomicity ensures each `[index, task]` pair consumed by exactly one worker. Effective concurrency capped at `Math.min(options.concurrency, tasks.length)`.\n\n### Subprocess Resource Management\n\n`runSubprocess()` mitigates Claude CLI thread exhaustion (GitHub #5771: 200 NodeJS instances) via environment variables: `NODE_OPTIONS='--max-old-space-size=512'` limits heap to 512MB per subprocess, `UV_THREADPOOL_SIZE='4'` constrains libuv thread pool to 4 threads, `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` prevents background task spawning, `--disallowedTools Task` blocks subagents. Process group killing via `kill(-pid)` terminates subprocess trees. SIGTERM sent at `timeoutMs`, SIGKILL escalation after 5s grace period.\n\n### Incremental Update Strategy\n\n`UpdateOrchestrator.preparePlan()` replaces git-based diffing with SHA-256 content hash comparison: reads `content_hash` from `.sum` YAML frontmatter, computes current hash via `computeContentHash()`, classifies files into `filesToAnalyze` (hash mismatch/missing) or `filesToSkip` (hash match). `cleanupOrphans()` deletes stale `.sum` files for deleted/renamed sources, `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with no remaining source files, `getAffectedDirectories()` walks parent directory tree collecting paths requiring regeneration.\n\n### Telemetry & Tracing\n\n`TelemetryLogger` accumulates `TelemetryEntry` instances with `addEntry()` per subprocess completion, `toRunLog()` assembles complete `RunLog` with shallow-copied entries and `getSummary()` aggregations (total tokens, error counts, unique files), `writeRunLog()` serializes to timestamped JSON (`.agents-reverse-engineer/logs/run-<timestamp>.json`), `cleanupOldLogs()` enforces retention limit (default 50) via lexicographic sort descending. `TraceWriter` emits NDJSON events (`phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`) to `.agents-reverse-engineer/traces/trace-<timestamp>.ndjson` with promise-chain serialization, auto-populated fields (`seq`, `ts`, `pid`, `elapsedMs`), `cleanupOldTraces()` enforcing 500-trace retention.\n\n## Directory Hints\n\nContains manifest file(s): package.json — likely a package or project root.\n\n## Existing AGENTS.md (update this — preserve stable content, modify only what changed)\n\n<!-- Generated by agents-reverse-engineer -->\n\n# agents-reverse-engineer\n\nAI-driven codebase documentation generator executing Recursive Language Model (RLM) algorithm: concurrent per-file `.sum` analysis via subprocess pools, post-order directory `AGENTS.md` aggregation, and platform-specific root synthesis (`CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`) with gitignore-aware discovery, SHA-256 incremental updates, and session lifecycle hooks.\n\n## Contents\n\n### Documentation\n\n**[README.md](./README.md)** — User-facing documentation describing installation methods (`npx agents-reverse-engineer@latest` with `--runtime` and `-g/-l` flags), six-step workflow (`/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`), generated artifact formats (`.sum` files with YAML frontmatter, per-directory `AGENTS.md`, platform-specific root documents), configuration schema (`.agents-reverse-engineer/config.yaml` sections for `exclude`, `options`, `output`, `ai` with `concurrency` 1-10, `timeoutMs` 300000ms, `backend` auto-detection), CLI commands (`are install/discover/generate/update/specify/clean`), and positioning narrative solving AI assistant session amnesia through persistent documentation.\n\n**[LANGUAGES-MANIFEST.md](./LANGUAGES-MANIFEST.md)** — Catalogs package manifest file patterns across 25 programming languages with support status flags. Supported languages (9 total): JavaScript/TypeScript (`package.json`), Python (`requirements.txt`, `pyproject.toml`, `setup.py`, `Pipfile`), Ruby (`Gemfile`), Go (`go.mod`), Rust (`Cargo.toml`), Java (`pom.xml`, `build.gradle`), PHP (`composer.json`), C/C++ (`CMakeLists.txt`, `conanfile.txt`, `vcpkg.json`). References `src/generation/prompts/builder.ts` function `buildDirectoryPrompt()` which implements manifest detection during Phase 2 directory aggregation.\n\n**[LICENSE](./LICENSE)** — MIT License granting unrestricted use, modification, distribution, and sublicensing with copyright attribution to GeoloeG-IsT (2026). Software provided \"AS IS\" without warranties. Referenced by `package.json` \"license\" field, included in npm tarball via publish workflow, copied to hooks/dist/ by prepublish hook.\n\n### Configuration\n\n**[package.json](./package.json)** — Defines npm package metadata (`name: \"agents-reverse-engineer\"`, `version: \"0.6.4\"`, `type: \"module\"`), binary entry points (`bin.agents-reverse-engineer` and `bin.are` resolving to `dist/cli/index.js`), build scripts (`build: \"tsc\"`, `build:hooks: \"node scripts/build-hooks.js\"`, `prepublishOnly: \"npm run build && npm run build:hooks\"`, `dev: \"tsx watch src/cli/index.ts\"`), runtime dependencies (`fast-glob`, `ignore`, `isbinaryfile`, `ora`, `picocolors`, `simple-git`, `yaml`, `zod`), development dependencies (`@types/node`, `tsx`, `typescript`), engine requirements (`node: \">=18.0.0\"`), distribution files (`dist`, `hooks/dist`, `README.md`, `LICENSE`), repository metadata (GitHub URLs for issues/homepage).\n\n**[tsconfig.json](./tsconfig.json)** — TypeScript compiler configuration with `target: \"ES2022\"`, `lib: [\"ES2022\"]`, `module: \"NodeNext\"`, `moduleResolution: \"NodeNext\"`, `rootDir: \"src\"`, `outDir: \"dist\"`, `strict: true`, `declaration: true`, `declarationMap: true`, `sourceMap: true`, `esModuleInterop: true`, `resolveJsonModule: true`, `isolatedModules: true`, `skipLibCheck: true`, `forceConsistentCasingInFileNames: true`. Enables Node.js native ESM support with `.js` extension requirements and strict type-checking for compilation from `src/` to `dist/`.\n\n## Subdirectories\n\n**[.github/workflows/](./workflows/)** — CI/CD automation containing `publish.yml` GitHub Actions workflow for npm publish with provenance attestation. Triggers on `v*` tags, runs `npm publish --provenance --access public` with `NPM_TOKEN` secret authentication.\n\n**[docs/](./docs/)** — Contains `INPUT.md` original vision document defining RLM bottom-up recursive execution pattern (leaf-to-root file analysis → directory aggregation → root synthesis), intended integration partners (SpecKit, BMAD, Get Shit Done), session hook requirements, and CLI command surface (`/are-generate`, `/are-update`). Serves as canonical requirements document referenced during feature development.\n\n**[hooks/](./hooks/)** — Session lifecycle hooks for AI IDE integration. Claude Code/Gemini CLI hooks: `are-check-update.js` (SessionStart version check querying `npm view agents-reverse-engineer version`, caching to `~/.claude/cache/are-update-check.json`), `are-session-end.js` (SessionEnd auto-update spawning detached `npx agents-reverse-engineer@latest update --quiet` when `git status --porcelain` detects uncommitted changes). OpenCode plugin hooks: `opencode-are-check-update.js` and `opencode-are-session-end.js` exporting async factories with `event['session.created']` and `event['session.deleted']` handlers. All hooks use detached spawn pattern (`spawn(process.execPath, ['-e', scriptString], {stdio:'ignore', detached:true, windowsHide:true})`) with silent failures (exit code 0) on errors.\n\n**[scripts/](./scripts/)** — Build automation containing `build-hooks.js` prepublish hook script copying `.js` files from `hooks/` to `hooks/dist/` via `copyFileSync()`. Invoked by `prepublishOnly` npm lifecycle script ensuring hooks included in npm tarball. Logs per-file operations, creates `hooks/dist/` via `mkdirSync({recursive:true})` if missing.\n\n**[src/](./src/)** — TypeScript source tree implementing CLI commands (`src/cli/`), AI service orchestration with subprocess resource limits (`src/ai/`), gitignore-aware file discovery (`src/discovery/`), three-phase generation pipeline (`src/generation/`), worker pool with iterator-based concurrency control (`src/orchestration/`), SHA-256 incremental update workflow (`src/update/`), static import analysis (`src/imports/`), NDJSON telemetry logging (`src/ai/telemetry/`), quality validation (`src/quality/`), and platform-specific template generation (`src/integration/`).\n\n## Architecture\n\n### Three-Phase RLM Pipeline\n\n**Phase 1 (Concurrent File Analysis):** `src/generation/orchestrator.ts` reads source content, constructs prompts via `buildFilePrompt()` with import context from `extractDirectoryImports()`, executes tasks through iterator-based worker pool (`src/orchestration/pool.ts` with default concurrency 2 for WSL, 5 elsewhere), writes `.sum` files with YAML frontmatter containing `generated_at`, `content_hash` (SHA-256), `purpose`, optional `critical_todos`/`related_files`.\n\n**Phase 2 (Post-Order Directory Aggregation):** Sorts directories by depth descending via `getDirectoryDepth()`, waits for child `.sum` files via `isDirectoryComplete()` predicate, aggregates child `.sum` content via `readSumFile()`, detects 9 manifest types (package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile) in `buildDirectoryPrompt()`, writes `AGENTS.md` preserving user content via `AGENTS.local.md` prepending.\n\n**Phase 3 (Root Document Synthesis):** Sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` consuming all `AGENTS.md` files via `collectAgentsDocs()`, enforces synthesis-only constraint (no invention/extrapolation, every claim traceable to source documents).\n\n### Subprocess Resource Management\n\n`src/ai/subprocess.ts` mitigates Claude CLI thread exhaustion (GitHub #5771) via environment variables: `NODE_OPTIONS='--max-old-space-size=512'` (512MB heap limit), `UV_THREADPOOL_SIZE='4'` (4-thread libuv pool), `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` (no background tasks), `--disallowedTools Task` (no subagents). Process group killing via `kill(-pid)` terminates subprocess trees. SIGTERM sent at `timeoutMs`, SIGKILL escalation after 5s grace period.\n\n### Incremental Update Strategy\n\n`src/update/orchestrator.ts` replaces git-based diffing with SHA-256 content hash comparison: reads `content_hash` from `.sum` YAML frontmatter, computes current hash via `computeContentHash()`, classifies files into `filesToAnalyze` (hash mismatch/missing) or `filesToSkip` (hash match). `cleanupOrphans()` deletes stale `.sum` files, `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with no remaining source files, `getAffectedDirectories()` walks parent directory tree collecting regeneration candidates.\n\n### Telemetry & Tracing\n\n`src/ai/telemetry/logger.ts` accumulates `TelemetryEntry` instances per subprocess completion, serializes to timestamped JSON (`run-<timestamp>.json`) with token counts, costs, durations, `filesRead[]` metadata, enforces 50-run retention via `cleanupOldLogs()`. `src/orchestration/trace.ts` emits NDJSON events (`phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`) to `trace-<timestamp>.ndjson` with promise-chain serialization, auto-populated fields (`seq`, `ts`, `pid`, `elapsedMs`), 500-trace retention.\n\n## CLI Commands\n\n| Command | Entry Point | Purpose |\n|---------|------------|---------|\n| `are init` | `src/cli/init.ts` | Create `.agents-reverse-engineer/config.yaml` |\n| `are discover` | `src/cli/discover.ts` | Preview generation plan, write `GENERATION-PLAN.md` |\n| `are generate` | `src/cli/generate.ts` | Execute three-phase pipeline |\n| `are update` | `src/cli/update.ts` | Incremental regeneration via hash comparison |\n| `are specify` | `src/cli/specify.ts` | Synthesize `AGENTS.md` corpus into `specs/SPEC.md` |\n| `are clean` | `src/cli/clean.ts` | Remove `.sum`, `AGENTS.md`, `CLAUDE.md` artifacts |\n\nAll commands routed via `src/cli/index.ts` with `parseArgs()` flag extraction, thread `ITraceWriter` for NDJSON emission and `ProgressLog` for streaming `.agents-reverse-engineer/progress.log`.\n\n## IDE Integration\n\n**Installation:** `npx agents-reverse-engineer --runtime <claude|opencode|gemini> -g` installs commands to `~/.claude/skills/`, `~/.config/opencode/commands/`, or `~/.gemini/commands/` with platform-specific templates. Session hooks installed to `~/.claude/hooks/` or `~/.config/opencode/plugins/` via `src/installer/operations.ts` with `registerHooks()` mutating settings.json.\n\n**Uninstallation:** `npx agents-reverse-engineer --runtime <rt> -u` removes command templates, deregisters hooks via `unregisterHooks()` filtering arrays by command pattern match, deletes `.agents-reverse-engineer/` config directory in local mode.\n\n## Quality Validation\n\n`src/quality/inconsistency/code-vs-doc.ts` extracts exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, verifies presence in `.sum` summaries via substring search. `src/quality/inconsistency/code-vs-code.ts` aggregates exports into `Map<symbol, string[]>` detecting duplicates. `src/quality/phantom-paths/validator.ts` applies three regex patterns (markdown links, backtick-quoted paths, prose-embedded paths), resolves candidates relative to `AGENTS.md` directory with `.js`→`.ts` fallback, reports unresolved references.\n\n## Key Technologies\n\n**Runtime:** Node.js ≥18.0.0 (ES modules), TypeScript 5.7.3 (ES2022 target, NodeNext module resolution, strict mode).\n\n**Core Dependencies:** `fast-glob` (file discovery), `ignore` (gitignore parsing), `isbinaryfile` (binary detection), `simple-git` (change detection), `yaml` (config parsing), `zod` (schema validation), `ora` (spinner UI), `picocolors` (terminal colors).\n\n**AI Backends:** `@anthropic-ai/claude-code` (Claude Code CLI adapter), Gemini CLI (stub implementation), OpenCode CLI (stub implementation).",
      "systemPrompt": "You are updating an existing AGENTS.md file — a directory-level overview for AI coding assistants. Some file summaries or subdirectory documents have changed, and AGENTS.md needs to reflect those changes.\n\nCRITICAL — INCREMENTAL UPDATE RULES:\n- You are given the EXISTING AGENTS.md and the CURRENT file summaries and subdirectory documents\n- Preserve the structure, section headings, and descriptions that are still accurate\n- Only modify entries for files or subdirectories whose summaries have changed\n- Add entries for new files, remove entries for deleted files\n- Do NOT reorganize, rephrase, or restructure sections that are unaffected by changes\n- Keep the same section ordering unless files were added/removed in a way that requires regrouping\n\nCRITICAL: Output ONLY the raw markdown content. No code fences, no preamble, no explanations, no conversational text. Your entire response IS the AGENTS.md file content.\n\nOUTPUT FORMAT:\n- First line MUST be exactly: <!-- Generated by agents-reverse-engineer -->\n- Use a # heading with the directory name\n- Preserve the existing purpose statement unless the directory's role has fundamentally changed\n\nSCOPE:\n- AGENTS.md is a NAVIGATIONAL INDEX — help an AI find the right file quickly\n- Focus on: what each file does, how files relate, directory-level patterns\n- Do NOT reproduce full architecture sections — those belong in the root CLAUDE.md\n\nPATH ACCURACY (MANDATORY):\n- When referencing files or modules outside this directory, use ONLY paths from the \"Import Map\" section\n- Do NOT invent, rename, or guess module paths — if a path isn't in the Import Map, don't reference it\n- Use the exact directory names from \"Project Directory Structure\" — do NOT rename directories\n- Cross-module references must use the specifier format from actual import statements\n- If you are unsure about a path, omit the cross-reference rather than guessing\n\nCONSISTENCY (MANDATORY):\n- Do not contradict yourself within the same document\n- If you describe a technique (e.g., \"regex-based\"), do not call it something else later (e.g., \"AST-based\")\n- When stating version numbers, engines, or config fields, use ONLY values present in the file summaries\n\nDENSITY RULES (MANDATORY):\n- Every sentence must reference at least one specific identifier (function name, class name, type name, or constant)\n- Never use filler phrases: \"this directory\", \"this module\", \"provides\", \"responsible for\", \"is used to\"\n- Use technical shorthand: \"exports X, Y, Z\" not \"this module exports a function called X...\"\n- Per-file descriptions: 1-2 sentences maximum. Reference key symbols but do not reproduce full summaries.\n- Subdirectory descriptions: 1-2 sentences maximum. Capture the directory's role, not its full contents.\n\nANCHOR TERM PRESERVATION (MANDATORY):\n- Key exported symbols from file summaries MUST appear in the directory overview\n- Preserve exact casing of identifiers\n\nUSER NOTES:\n- If \"User Notes\" are provided in the prompt, they contain user-defined instructions that will be automatically prepended to your output\n- Do NOT repeat or paraphrase user notes in your generated content — they are included separately\n- You may reference information from user notes for context",
      "response": "<!-- Generated by agents-reverse-engineer -->\n\n# agents-reverse-engineer\n\nAI-driven codebase documentation generator executing Recursive Language Model (RLM) algorithm: concurrent per-file `.sum` analysis via subprocess pools, post-order directory `AGENTS.md` aggregation, and platform-specific root synthesis (`CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`) with gitignore-aware discovery, SHA-256 incremental updates, and session lifecycle hooks.\n\n## Contents\n\n### Documentation\n\n**[README.md](./README.md)** — User-facing documentation describing installation methods (`npx agents-reverse-engineer@latest` with `--runtime` and `-g/-l` flags), six-step workflow (`/are-init`, `/are-discover`, `/are-generate`, `/are-update`, `/are-specify`, `/are-clean`), generated artifact formats (`.sum` files with YAML frontmatter, per-directory `AGENTS.md`, platform-specific root documents), configuration schema (`.agents-reverse-engineer/config.yaml` sections for `exclude`, `options`, `output`, `ai` with `concurrency` 1-10, `timeoutMs` 300000ms, `backend` auto-detection), CLI commands (`are install/discover/generate/update/specify/clean`), and positioning narrative solving AI assistant session amnesia through persistent documentation.\n\n**[LANGUAGES-MANIFEST.md](./LANGUAGES-MANIFEST.md)** — Catalogs package manifest file patterns across 25 programming languages with support status flags. Supported languages (9 total): JavaScript/TypeScript (`package.json`), Python (`requirements.txt`, `pyproject.toml`, `setup.py`, `Pipfile`), Ruby (`Gemfile`), Go (`go.mod`), Rust (`Cargo.toml`), Java (`pom.xml`, `build.gradle`), PHP (`composer.json`), C/C++ (`CMakeLists.txt`, `conanfile.txt`, `vcpkg.json`). References `src/generation/prompts/builder.ts` function `buildDirectoryPrompt()` which implements manifest detection during Phase 2 directory aggregation.\n\n**[LICENSE](./LICENSE)** — MIT License granting unrestricted use, modification, distribution, and sublicensing with copyright attribution to GeoloeG-IsT (2026). Software provided \"AS IS\" without warranties. Referenced by `package.json` \"license\" field, included in npm tarball via publish workflow, copied to hooks/dist/ by prepublish hook.\n\n### Configuration\n\n**[package.json](./package.json)** — Defines npm package metadata (`name: \"agents-reverse-engineer\"`, `version: \"0.6.4\"`, `type: \"module\"`), binary entry points (`bin.agents-reverse-engineer` and `bin.are` resolving to `dist/cli/index.js`), build scripts (`build: \"tsc\"`, `build:hooks: \"node scripts/build-hooks.js\"`, `prepublishOnly: \"npm run build && npm run build:hooks\"`, `dev: \"tsx watch src/cli/index.ts\"`), runtime dependencies (`fast-glob`, `ignore`, `isbinaryfile`, `ora`, `picocolors`, `simple-git`, `yaml`, `zod`), development dependencies (`@types/node`, `tsx`, `typescript`), engine requirements (`node: \">=18.0.0\"`), distribution files (`dist`, `hooks/dist`, `README.md`, `LICENSE`), repository metadata (GitHub URLs for issues/homepage).\n\n**[tsconfig.json](./tsconfig.json)** — TypeScript compiler configuration with `target: \"ES2022\"`, `lib: [\"ES2022\"]`, `module: \"NodeNext\"`, `moduleResolution: \"NodeNext\"`, `rootDir: \"src\"`, `outDir: \"dist\"`, `strict: true`, `declaration: true`, `declarationMap: true`, `sourceMap: true`, `esModuleInterop: true`, `resolveJsonModule: true`, `isolatedModules: true`, `skipLibCheck: true`, `forceConsistentCasingInFileNames: true`. Enables Node.js native ESM support with `.js` extension requirements and strict type-checking for compilation from `src/` to `dist/`.\n\n## Subdirectories\n\n**[.github/workflows/](./workflows/)** — CI/CD automation containing `publish.yml` GitHub Actions workflow for npm publish with provenance attestation. Triggers on `v*` tags, runs `npm publish --provenance --access public` with `NPM_TOKEN` secret authentication.\n\n**[docs/](./docs/)** — Contains `INPUT.md` original vision document defining RLM bottom-up recursive execution pattern (leaf-to-root file analysis → directory aggregation → root synthesis), intended integration partners (SpecKit, BMAD, Get Shit Done), session hook requirements, and CLI command surface (`/are-generate`, `/are-update`). Serves as canonical requirements document referenced during feature development.\n\n**[hooks/](./hooks/)** — Session lifecycle hooks for AI IDE integration. Claude Code/Gemini CLI hooks: `are-check-update.js` (SessionStart version check querying `npm view agents-reverse-engineer version`, caching to `~/.claude/cache/are-update-check.json`), `are-session-end.js` (SessionEnd auto-update spawning detached `npx agents-reverse-engineer@latest update --quiet` when `git status --porcelain` detects uncommitted changes). OpenCode plugin hooks: `opencode-are-check-update.js` and `opencode-are-session-end.js` exporting async factories with `event['session.created']` and `event['session.deleted']` handlers. All hooks use detached spawn pattern (`spawn(process.execPath, ['-e', scriptString], {stdio:'ignore', detached:true, windowsHide:true})`) with silent failures (exit code 0) on errors.\n\n**[scripts/](./scripts/)** — Build automation containing `build-hooks.js` prepublish hook script copying `.js` files from `hooks/` to `hooks/dist/` via `copyFileSync()`. Invoked by `prepublishOnly` npm lifecycle script ensuring hooks included in npm tarball. Logs per-file operations, creates `hooks/dist/` via `mkdirSync({recursive:true})` if missing.\n\n**[specs/](./specs/)** — Planned location for synthesized project specifications extracted from AGENTS.md documentation corpus via `are specify` command. Single-file mode (default) writes `SPEC.md`, multi-file mode (`--multi-file`) writes `<dirname>.md` per top-level source directory. `SpecificationSynthesizer` invokes `collectAgentsDocs()` to recursively gather all `AGENTS.md` files, parses root `package.json` for project metadata, constructs prompt with synthesis-only constraints (no invention of features/APIs/patterns absent from source documentation), invokes `AIService.call()` with `claude-code` backend, strips conversational preamble via `stripPreamble()`, writes output to `specs/SPEC.md` or `specs/<dirname>.md`. Directory currently empty.\n\n**[src/](./src/)** — TypeScript source tree implementing CLI commands (`src/cli/`), AI service orchestration with subprocess resource limits (`src/ai/`), gitignore-aware file discovery (`src/discovery/`), three-phase generation pipeline (`src/generation/`), worker pool with iterator-based concurrency control (`src/orchestration/`), SHA-256 incremental update workflow (`src/update/`), static import analysis (`src/imports/`), NDJSON telemetry logging (`src/ai/telemetry/`), quality validation (`src/quality/`), platform-specific template generation (`src/integration/`), and project specification synthesis (`src/specify/`).\n\n## Architecture\n\n### Three-Phase RLM Pipeline\n\n**Phase 1 (Concurrent File Analysis):** `src/generation/orchestrator.ts` reads source content, constructs prompts via `buildFilePrompt()` with import context from `extractDirectoryImports()`, executes tasks through iterator-based worker pool (`src/orchestration/pool.ts` with default concurrency 2 for WSL, 5 elsewhere), writes `.sum` files with YAML frontmatter containing `generated_at`, `content_hash` (SHA-256), `purpose`, optional `critical_todos`/`related_files`.\n\n**Phase 2 (Post-Order Directory Aggregation):** Sorts directories by depth descending via `getDirectoryDepth()`, waits for child `.sum` files via `isDirectoryComplete()` predicate, aggregates child `.sum` content via `readSumFile()`, detects 9 manifest types (package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile) in `buildDirectoryPrompt()`, writes `AGENTS.md` preserving user content via `AGENTS.local.md` prepending.\n\n**Phase 3 (Root Document Synthesis):** Sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md` consuming all `AGENTS.md` files via `collectAgentsDocs()`, enforces synthesis-only constraint (no invention/extrapolation, every claim traceable to source documents).\n\n### Subprocess Resource Management\n\n`src/ai/subprocess.ts` mitigates Claude CLI thread exhaustion (GitHub #5771) via environment variables: `NODE_OPTIONS='--max-old-space-size=512'` (512MB heap limit), `UV_THREADPOOL_SIZE='4'` (4-thread libuv pool), `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` (no background tasks), `--disallowedTools Task` (no subagents). Process group killing via `kill(-pid)` terminates subprocess trees. SIGTERM sent at `timeoutMs`, SIGKILL escalation after 5s grace period.\n\n### Incremental Update Strategy\n\n`src/update/orchestrator.ts` replaces git-based diffing with SHA-256 content hash comparison: reads `content_hash` from `.sum` YAML frontmatter, computes current hash via `computeContentHash()`, classifies files into `filesToAnalyze` (hash mismatch/missing) or `filesToSkip` (hash match). `cleanupOrphans()` deletes stale `.sum` files, `cleanupEmptyDirectoryDocs()` removes `AGENTS.md` from directories with no remaining source files, `getAffectedDirectories()` walks parent directory tree collecting regeneration candidates.\n\n### Telemetry & Tracing\n\n`src/ai/telemetry/logger.ts` accumulates `TelemetryEntry` instances per subprocess completion, serializes to timestamped JSON (`run-<timestamp>.json`) with token counts, costs, durations, `filesRead[]` metadata, enforces 50-run retention via `cleanupOldLogs()`. `src/orchestration/trace.ts` emits NDJSON events (`phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`) to `trace-<timestamp>.ndjson` with promise-chain serialization, auto-populated fields (`seq`, `ts`, `pid`, `elapsedMs`), 500-trace retention.\n\n## CLI Commands\n\n| Command | Entry Point | Purpose |\n|---------|------------|---------|\n| `are init` | `src/cli/init.ts` | Create `.agents-reverse-engineer/config.yaml` |\n| `are discover` | `src/cli/discover.ts` | Preview generation plan, write `GENERATION-PLAN.md` |\n| `are generate` | `src/cli/generate.ts` | Execute three-phase pipeline |\n| `are update` | `src/cli/update.ts` | Incremental regeneration via hash comparison |\n| `are specify` | `src/cli/specify.ts` | Synthesize `AGENTS.md` corpus into `specs/SPEC.md` |\n| `are clean` | `src/cli/clean.ts` | Remove `.sum`, `AGENTS.md`, `CLAUDE.md` artifacts |\n\nAll commands routed via `src/cli/index.ts` with `parseArgs()` flag extraction, thread `ITraceWriter` for NDJSON emission and `ProgressLog` for streaming `.agents-reverse-engineer/progress.log`.\n\n## IDE Integration\n\n**Installation:** `npx agents-reverse-engineer --runtime <claude|opencode|gemini> -g` installs commands to `~/.claude/skills/`, `~/.config/opencode/commands/`, or `~/.gemini/commands/` with platform-specific templates. Session hooks installed to `~/.claude/hooks/` or `~/.config/opencode/plugins/` via `src/installer/operations.ts` with `registerHooks()` mutating settings.json.\n\n**Uninstallation:** `npx agents-reverse-engineer --runtime <rt> -u` removes command templates, deregisters hooks via `unregisterHooks()` filtering arrays by command pattern match, deletes `.agents-reverse-engineer/` config directory in local mode.\n\n## Quality Validation\n\n`src/quality/inconsistency/code-vs-doc.ts` extracts exports via `/^[ \\t]*export\\s+(?:default\\s+)?(?:function|class|const|let|var|type|interface|enum)\\s+(\\w+)/gm`, verifies presence in `.sum` summaries via substring search. `src/quality/inconsistency/code-vs-code.ts` aggregates exports into `Map<symbol, string[]>` detecting duplicates. `src/quality/phantom-paths/validator.ts` applies three regex patterns (markdown links, backtick-quoted paths, prose-embedded paths), resolves candidates relative to `AGENTS.md` directory with `.js`→`.ts` fallback, reports unresolved references.\n\n## Key Technologies\n\n**Runtime:** Node.js ≥18.0.0 (ES modules), TypeScript 5.7.3 (ES2022 target, NodeNext module resolution, strict mode).\n\n**Core Dependencies:** `fast-glob` (file discovery), `ignore` (gitignore parsing), `isbinaryfile` (binary detection), `simple-git` (change detection), `yaml` (config parsing), `zod` (schema validation), `ora` (spinner UI), `picocolors` (terminal colors).\n\n**AI Backends:** `@anthropic-ai/claude-code` (Claude Code CLI adapter), Gemini CLI (stub implementation), OpenCode CLI (stub implementation).",
      "model": "claude-sonnet-4-5-20250929",
      "inputTokens": 3,
      "outputTokens": 3482,
      "cacheReadTokens": 17087,
      "cacheCreationTokens": 20301,
      "latencyMs": 77441,
      "exitCode": 0,
      "retryCount": 0,
      "thinking": "not supported",
      "filesRead": []
    }
  ],
  "summary": {
    "totalCalls": 10,
    "totalInputTokens": 29,
    "totalOutputTokens": 19732,
    "totalCacheReadTokens": 150904,
    "totalCacheCreationTokens": 178725,
    "totalDurationMs": 370908,
    "errorCount": 0,
    "totalFilesRead": 4,
    "uniqueFilesRead": 4
  }
}