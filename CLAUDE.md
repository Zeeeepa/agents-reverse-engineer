# agents-reverse-engineer

**AI-driven codebase documentation generator executing Recursive Language Model (RLM) algorithm: concurrent per-file `.sum` analysis via subprocess pools, post-order directory `AGENTS.md` aggregation, and platform-specific root synthesis (`CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`) with gitignore-aware discovery, SHA-256 incremental updates, and session lifecycle hooks.**

## Project Overview

agents-reverse-engineer (ARE) automates brownfield documentation for AI coding assistants by executing a three-phase pipeline that discovers source files, analyzes them concurrently via AI CLI subprocesses (Claude Code, Gemini, OpenCode), generates file summaries with YAML frontmatter containing SHA-256 content hashes, synthesizes directory-level documentation from bottom-up via post-order traversal, and produces root integration documents tailored to each AI platform.

**Version**: 0.6.5  
**License**: MIT (GeoloeG-IsT, 2026)  
**Runtime**: Node.js ≥18.0.0 (ES modules)

### Core Capabilities

- **Parallel file analysis** with configurable concurrency pools (default 2 workers for WSL, 5 elsewhere)
- **Incremental updates** via SHA-256 content hash comparison (skip unchanged files)
- **Multi-platform AI backend support** (Claude Code, Gemini CLI, OpenCode) with automatic detection
- **Gitignore-aware file discovery** with binary detection and vendor directory exclusion
- **Quality validation** detecting code-documentation inconsistencies and phantom path references
- **Session lifecycle hooks** for automatic documentation refresh on IDE session end
- **NDJSON telemetry logging** with token cost tracking and run retention management

## Architecture

### Three-Phase Generation Pipeline

**Phase 1: Concurrent File Analysis**

Iterator-based worker pool (`src/orchestration/pool.ts`) shares single task iterator across N workers to prevent over-allocation. Each worker invokes `AIService.call()` → `runSubprocess()` → `execFile()` spawning AI CLI subprocesses with resource limits:

- `NODE_OPTIONS='--max-old-space-size=512'` limits heap to 512MB per subprocess
- `UV_THREADPOOL_SIZE='4'` constrains libuv thread pool to 4 threads
- `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` prevents background task spawning
- `--disallowedTools Task` blocks subagents

Process group killing (`kill(-pid)`) terminates subprocess trees on timeout. SIGTERM sent at `timeoutMs`, SIGKILL escalation after 5s grace period. Exponential backoff retry on rate limits (stderr patterns: "rate limit", "429", "too many requests", "overloaded").

Writes `.sum` files with YAML frontmatter:

```yaml
---
generated_at: 2026-02-09T12:34:56.789Z
content_hash: a3f5d8e9... (SHA-256 hex)
purpose: One-line purpose statement
critical_todos:
  - Security issue
related_files: [path1, path2]
---

Markdown summary content...
```

**Phase 2: Post-Order Directory Aggregation**

Sorts directories by depth descending via `path.relative().split(path.sep).length` (deepest first). Waits for all child `.sum` files to exist via `isDirectoryComplete()` predicate before processing directory.

Prompts include:

- Aggregated child `.sum` content via `readSumFile()`
- Subdirectory `AGENTS.md` files via recursive traversal
- Import maps via `extractDirectoryImports()` with verified path constraints
- Manifest detection (9 types: package.json, Cargo.toml, go.mod, pyproject.toml, pom.xml, build.gradle, Gemfile, composer.json, CMakeLists.txt/Makefile)

User-authored `AGENTS.md` files renamed to `AGENTS.local.md` and prepended above generated content. Writes `AGENTS.md` with `<!-- Generated by agents-reverse-engineer -->` marker.

**Phase 3: Root Document Synthesis**

Sequential execution (concurrency=1) generates `CLAUDE.md`, `GEMINI.md`, `OPENCODE.md`. Prompts consume all `AGENTS.md` files via `collectAgentsDocs()` recursive tree traversal, parse root `package.json` for project metadata, enforce synthesis-only constraints (no invention of features/hooks/patterns not in source documents). Strips conversational preamble via pattern matching before writing output.

### Directory Structure

```
.
├── .github/workflows/    # CI/CD: npm publish workflow with provenance attestation
├── docs/                 # Original vision document (INPUT.md) defining RLM algorithm
├── hooks/                # Session lifecycle hooks for Claude/Gemini/OpenCode
│   ├── are-check-update.js              # SessionStart: npm version check
│   ├── are-session-end.js               # SessionEnd: auto-update on uncommitted changes
│   ├── opencode-are-check-update.js     # OpenCode plugin: version check
│   └── opencode-are-session-end.js      # OpenCode plugin: session end update
├── scripts/              # Build automation: hook file copying (build-hooks.js)
└── src/                  # TypeScript source tree
    ├── ai/               # AI service orchestration with backend abstraction
    ├── change-detection/ # Git-based delta computation and SHA-256 hashing
    ├── cli/              # Command entry points (init, discover, generate, update, clean, specify)
    ├── config/           # YAML config loading with Zod validation
    ├── discovery/        # File walking with composable filters (gitignore, binary, vendor, custom)
    ├── generation/       # Three-phase pipeline orchestration and prompt engineering
    ├── imports/          # Static import analysis for dependency graphs
    ├── installer/        # npx-based command/hook installation for IDE runtimes
    ├── integration/      # Platform-specific template generation (Claude/OpenCode/Gemini)
    ├── orchestration/    # Worker pool, progress reporting, trace emission, plan tracking
    ├── output/           # Terminal logging with picocolors formatting
    ├── quality/          # Code-doc consistency validation and phantom path detection
    ├── specify/          # Project specification synthesis from AGENTS.md corpus
    ├── types/            # Shared interfaces for discovery results
    └── update/           # Incremental update workflow with orphan cleanup
```

## Key Directories

| Directory | Purpose |
|-----------|---------|
| **src/ai/** | Backend-agnostic AI service layer with subprocess management, retry logic, telemetry logging, and trace emission. Contains adapters for Claude Code, Gemini CLI, OpenCode. |
| **src/generation/** | Orchestrates three-phase pipeline: file analysis prompt construction with import maps, directory aggregation with user content preservation, root document synthesis with stack detection. |
| **src/orchestration/** | Iterator-based worker pool with shared task queue, streaming progress reporter with ETA calculation, promise-chain serialization for concurrent writes (GENERATION-PLAN.md, progress.log, trace NDJSON). |
| **src/discovery/** | Directory walker with filter chain: gitignore parsing via `ignore` library, binary detection (extension + content analysis), vendor directory exclusion (node_modules/.git/dist), custom glob patterns. |
| **src/change-detection/** | Git diff parsing (`git diff --name-status -M`) with rename detection and SHA-256 content hashing for non-git workflows. Detects added/modified/deleted/renamed files, optionally merges uncommitted changes. |
| **src/quality/** | Post-generation validators: regex-based export extraction vs. substring search in summaries (code-vs-doc), duplicate symbol detection (code-vs-code), path resolution via `existsSync()` (phantom-paths). |
| **src/config/** | Zod schema validation for `.agents-reverse-engineer/config.yaml` with defaults for vendor directories (18 entries), exclude patterns (gitignore-style globs), binary extensions (26 types), AI backend config (concurrency/timeout/model/pricing). |
| **src/installer/** | npx install orchestrator supporting global (`~/.claude`) and local (`.claude`) installation modes with interactive prompts, platform-specific path resolution (environment overrides: `CLAUDE_CONFIG_DIR`, `OPENCODE_CONFIG_DIR`, `GEMINI_CONFIG_DIR`), hook registration, permission setup. |
| **hooks/** | Detached background processes for version checking (compares `npm view agents-reverse-engineer version` against `~/.claude/ARE-VERSION`) and session-end updates (spawns `npx agents-reverse-engineer@latest update --quiet` when `git status --porcelain` detects changes). |

## Getting Started

### Installation

**Global install:**
```bash
npm install -g agents-reverse-engineer
```

**Project-local install:**
```bash
npm install --save-dev agents-reverse-engineer
```

**npx usage (no install required):**
```bash
npx agents-reverse-engineer init
```

### Prerequisites

- Node.js ≥18.0.0
- At least one AI CLI installed:
  - Claude Code: `npm install -g @anthropic-ai/claude-code`
  - Gemini CLI: Installation instructions at https://gemini.google.com/cli
  - OpenCode: Installation instructions at https://opencode.dev

### Basic Workflow

**1. Initialize configuration:**
```bash
are init
# Creates .agents-reverse-engineer/config.yaml with defaults
```

**2. Discover files (optional preview):**
```bash
are discover
# Scans files, writes GENERATION-PLAN.md with phase breakdown
```

**3. Generate documentation:**
```bash
are generate
# Three-phase execution: .sum files → AGENTS.md → CLAUDE.md
# Progress logged to .agents-reverse-engineer/progress.log
# Monitor with: tail -f .agents-reverse-engineer/progress.log
```

**4. Incremental updates:**
```bash
are update
# Hash-based change detection, regenerates only modified files
# Use --uncommitted flag to include working tree changes
```

**5. Clean artifacts:**
```bash
are clean
# Removes .sum, AGENTS.md (generated only), CLAUDE.md, GENERATION-PLAN.md
# Restores AGENTS.local.md → AGENTS.md
```

**6. Generate project spec:**
```bash
are specify
# Synthesizes all AGENTS.md into specs/SPEC.md
# Use --multi-file for split specs (specs/<dirname>.md)
```

### CLI Options

**Global flags:**
- `--debug` — Enable verbose subprocess logging with heap/RSS metrics
- `--trace` — Emit NDJSON trace events to `.agents-reverse-engineer/traces/`
- `--concurrency N` — Override worker pool size (1-10, default from config)
- `--fail-fast` — Abort on first task failure
- `--dry-run` — Preview operations without writing files

**Generate/Update:**
- `--uncommitted` — Include working tree changes (update only)
- `--force` — Overwrite existing files (specify only)

**Trace output:**
```bash
are generate --trace
# Writes trace-<timestamp>.ndjson with events:
# phase:start/end, worker:start/end, task:pickup/done, subprocess:spawn/exit, retry
```

### IDE Integration

**Install commands/hooks for Claude Code:**
```bash
npx agents-reverse-engineer --runtime claude -g
# Installs to ~/.claude/commands/ and ~/.claude/hooks/
# Registers SessionStart hook: are-check-update.js
# Registers SessionEnd hook: are-session-end.js
```

**Install for OpenCode:**
```bash
npx agents-reverse-engineer --runtime opencode -g
# Installs to ~/.config/opencode/commands/ and ~/.config/opencode/plugins/
```

**Install for Gemini:**
```bash
npx agents-reverse-engineer --runtime gemini -g
# Installs to ~/.gemini/commands/ with TOML format
```

**Available IDE commands:**
- `/are-init` — Create configuration
- `/are-discover` — Preview generation plan
- `/are-generate` — Full documentation generation
- `/are-update` — Incremental update
- `/are-clean` — Remove generated artifacts
- `/are-specify` — Synthesize project specification
- `/are-help` — Show command list

## Key Technologies

**Runtime & Language:**
- Node.js ≥18.0.0 (ES modules)
- TypeScript 5.7.3 (ES2022 target, NodeNext module resolution, strict mode)

**Core Dependencies:**
- `fast-glob` — File discovery with glob patterns
- `ignore` — Gitignore parsing
- `isbinaryfile` — Binary file detection
- `simple-git` — Change detection via git diff
- `yaml` — Config parsing
- `zod` — Schema validation
- `ora` — Spinner UI
- `picocolors` — Terminal colors

**Build & Distribution:**
- TypeScript compiler (`tsc`) emits to `dist/`
- Binary entry points: `are` and `agents-reverse-engineer` → `dist/cli/index.js`
- Pre-publish hooks: `build` + `build:hooks` (copies hooks/ to hooks/dist/)

**AI Backends:**
- `@anthropic-ai/claude-code` (Claude Code CLI adapter)
- Gemini CLI (stub implementation pending JSON output stability)
- OpenCode CLI (stub implementation pending JSONL parsing)

## Configuration

**Config file:** `.agents-reverse-engineer/config.yaml`

**Schema sections:**

```yaml
exclude:
  patterns:              # Gitignore-style globs (e.g., "*.log", "**/*.test.ts")
  vendorDirs:           # Third-party directories to skip (default: node_modules, .git, dist, etc.)
  binaryExtensions:     # Non-text file extensions (default: .png, .jpg, .zip, .pdf, etc.)

options:
  followSymlinks: false # Follow symbolic links during discovery
  maxFileSize: 1048576  # Binary detection threshold (1MB default)

output:
  colors: true          # Enable ANSI color codes in CLI output

ai:
  backend: 'auto'       # 'claude' | 'gemini' | 'opencode' | 'auto' (detect first available)
  model: null           # Override backend default model
  timeoutMs: 120000     # Subprocess timeout (2 minutes)
  maxRetries: 3         # Exponential backoff retry attempts
  concurrency: 2        # Worker pool size (1-10, default 2 for WSL, 5 elsewhere)
  
  telemetry:
    enabled: true       # Write run logs to .agents-reverse-engineer/logs/
    keepRuns: 50        # Retention limit for historical logs
    costThresholdUsd: 10  # Warning threshold for cumulative costs
  
  pricing:              # Per-backend token cost configuration (input/output/cacheRead/cacheWrite)
    claude: { inputCostPer1kTokens: 0.003, outputCostPer1kTokens: 0.015, ... }
```

**Environment overrides:**
- `CLAUDE_CONFIG_DIR` — Override `~/.claude` path
- `OPENCODE_CONFIG_DIR` — Override `~/.config/opencode` path
- `GEMINI_CONFIG_DIR` — Override `~/.gemini` path
- `ARE_DISABLE_HOOK` — Disable session-end auto-update (set to `1`)

## Telemetry & Tracing

**Run logs:** `.agents-reverse-engineer/logs/run-<timestamp>.json`
- Aggregates per-call token counts, costs, durations, errors
- Tracks `filesRead[]` metadata with `path`, `sizeBytes`, `linesRead`
- Computes summary: `totalInputTokens`, `totalCacheReadTokens`, `errorCount`, `uniqueFilesRead`
- Enforces retention via `cleanupOldLogs(keepCount)` after each run

**Trace events:** `.agents-reverse-engineer/traces/trace-<timestamp>.ndjson`
- Enabled via `--trace` flag
- Events: `phase:start/end`, `worker:start/end`, `task:pickup/done`, `subprocess:spawn/exit`, `retry`
- Auto-populated fields: `seq` (monotonic), `ts` (ISO 8601), `pid`, `elapsedMs` (high-resolution delta)
- Promise-chain serialization ensures NDJSON line order matches emission order despite concurrent workers
- Retention: keeps 500 most recent traces via `cleanupOldTraces(keepCount)`

**Progress log:** `.agents-reverse-engineer/progress.log`
- Human-readable streaming output mirroring console
- ETA calculation via moving average of last 10 task durations
- Quality metrics: code-vs-doc/code-vs-code inconsistencies, phantom path counts
- Real-time monitoring: `tail -f .agents-reverse-engineer/progress.log`

## Quality Validation

**Code-vs-Doc Consistency:**
- Extracts exported symbols via regex: `/^[ \t]*export\s+(?:default\s+)?(?:function|class|const|let|var|type|interface|enum)\s+(\w+)/gm`
- Verifies all exports appear in `.sum` summary text via substring search
- Reports `CodeDocInconsistency` with `missingFromDoc` arrays

**Code-vs-Code Duplicate Detection:**
- Aggregates exports across per-directory file groups into `Map<symbol, string[]>`
- Reports `CodeCodeInconsistency` for symbols appearing in multiple files (pattern: `'duplicate-export'`)

**Phantom Path Resolution:**
- Extracts path-like strings from `AGENTS.md` via three regex patterns:
  - Markdown link targets: `/\[(?:[^\]]*)\]\((\.[^)]+)\)/g`
  - Backtick-quoted paths: `` /`((?:src\/|\.\.?\/)[^`]+\.[a-z]{1,4})`/g ``
  - Prose-embedded paths: `/(?:from|in|by|via|see)\s+`?(src\/[\w\-./]+)`?/gi`
- Resolves against AGENTS.md directory and project root with `.ts`/`.js` fallback
- Reports `PhantomPathInconsistency` for unresolved references

**Report format:** `InconsistencyReport` with `metadata` (timestamp, projectRoot, filesChecked, durationMs), `issues[]` (discriminated union), `summary` (counts by type/severity).

## Incremental Update Strategy

**Workflow:**
1. Read `content_hash` from each `.sum` file's YAML frontmatter via `readSumFile()`
2. Compute current file content hash via `computeContentHash()` (SHA-256)
3. Hash mismatch → add to `filesToAnalyze` as `FileChange` with `status: 'modified'` or `'added'`
4. Hash match → add to `filesToSkip`
5. Detect orphans: `.sum` files for deleted source files or renamed oldPaths
6. Call `cleanupOrphans()` to delete stale `.sum` files
7. Call `cleanupEmptyDirectoryDocs()` to remove `AGENTS.md` from directories with no remaining sources
8. Compute `affectedDirs` via `getAffectedDirectories()` by walking parent directories of changed files
9. Regenerate `.sum` for `filesToAnalyze` via Phase 1 pool execution
10. Regenerate `AGENTS.md` for `affectedDirs` sequentially (no Phase 2 post-order traversal required)

**Git integration:**
- Supports both committed changes (`git diff <baseCommit>..HEAD`) and uncommitted (`git status --porcelain` merge via `--uncommitted` flag)
- Rename detection via `git diff -M` (50% similarity threshold)
- Fallback to SHA-256 hashing for non-git workflows

## Subprocess Resource Management

**Problem:** Claude CLI spawns excessive Node.js threads (GitHub #5771: 200 instances reported). With concurrency=5, each subprocess spawns internal threads causing RAM exhaustion in WSL environments.

**Mitigations applied in `src/ai/subprocess.ts`:**
- `NODE_OPTIONS='--max-old-space-size=512'` limits heap to 512MB per subprocess
- `UV_THREADPOOL_SIZE='4'` constrains libuv thread pool to 4 threads
- `CLAUDE_CODE_DISABLE_BACKGROUND_TASKS='1'` prevents background task spawning
- `--disallowedTools Task` prevents subprocess from spawning subagents
- Process group killing: `kill(-pid)` terminates entire subprocess tree
- Default concurrency reduced from 5 → 2 for resource-constrained environments

**Timeout enforcement:**
- SIGTERM sent at `timeoutMs`
- SIGKILL escalation after 5s grace period
- Unref'd timeout handle allows Node.js exit without cleanup blocking

## Build & Development

**Install dependencies:**
```bash
npm install
```

**Development mode (hot reload):**
```bash
npm run dev
# Equivalent to: tsx watch src/cli/index.ts
```

**Build TypeScript:**
```bash
npm run build
# Compiles src/ → dist/ via tsc
```

**Prepare for publish:**
```bash
npm run prepublishOnly
# Executes: npm run build && npm run build:hooks
# Copies hooks/ → hooks/dist/ for npm tarball inclusion
```

**Run from source:**
```bash
node dist/cli/index.js generate
# Or via npm link:
npm link
are generate
```

## Session Hooks

**Claude/Gemini session lifecycle:**
- `are-check-update.js` (SessionStart): Spawns detached process querying `npm view agents-reverse-engineer version`, compares against `~/.claude/ARE-VERSION`, caches result to `~/.claude/cache/are-update-check.json`
- `are-session-end.js` (SessionEnd): Runs `git status --porcelain`, spawns `npx agents-reverse-engineer@latest update --quiet` as detached background process if changes detected

**OpenCode plugin system:**
- `opencode-are-check-update.js`: Exports `AreCheckUpdate()` async factory returning plugin with `event['session.created']` handler
- `opencode-are-session-end.js`: Exports `AreSessionEnd()` async factory returning plugin with `event['session.deleted']` handler

**Detached spawn pattern:**
```javascript
spawn(process.execPath, ['-e', scriptString], {
  stdio: 'ignore',
  detached: true,
  windowsHide: true
}).unref()
```

**Disable mechanisms:**
- Environment variable: `ARE_DISABLE_HOOK=1`
- Config flag: `hook_enabled: false` in `.agents-reverse-engineer.yaml` (substring search, no YAML parser)

## Integration with AI Assistants

**Platform-specific command formats:**

**Claude Code:**
- Location: `.claude/skills/are-generate/SKILL.md`
- Frontmatter: `name: /are-generate`
- Long-running pattern: Remove stale `progress.log`, run with `run_in_background: true`, poll via `tail -5` every 10-15s, check `TaskOutput` with `block: false`, summarize on completion

**OpenCode:**
- Location: `.opencode/commands/are-generate.md`
- Frontmatter: `agent: build`
- Identical progress monitoring pattern

**Gemini:**
- Location: `.gemini/commands/are-generate.toml`
- Format: `description = "..."` and `prompt = """..."""` triple-quoted multiline

**Aider:**
- Detection only via `.aider.conf.yml` or `.aider/` directory
- No template generation (manual integration required)

## CI/CD

**GitHub Actions workflow:** `.github/workflows/publish.yml`
- Triggers on `release[published]` events or manual `workflow_dispatch`
- Executes `ubuntu-latest` job with `id-token: write` permission enabling Sigstore-signed provenance
- Runs `actions/checkout@v4`, `actions/setup-node@v4` with registry-url `https://registry.npmjs.org`
- Executes `npm ci`, `npm run build` (invokes `tsc` + `build:hooks` from `prepublishOnly`)
- Publishes with `npm publish --provenance --access public` using `NPM_TOKEN` secret
- Cryptographic attestation links published artifact to source commit SHA

## Roadmap & Known Limitations

**Stub Backends:**
- Gemini CLI adapter throws `SUBPROCESS_ERROR` until JSON output format stabilizes
- OpenCode CLI adapter throws `SUBPROCESS_ERROR` until JSONL parsing implemented

**Quality Validator Limitations:**
- Regex-based export extraction misses complex patterns (destructured, namespace, dynamic exports)
- Substring matching in code-vs-doc yields false negatives for prose mentions unrelated to API surface
- Code-vs-code operates on symbol names only without AST analysis to distinguish intentional duplication

**Disabled Features:**
- Density validator (`validateFindability`) disabled after structured `publicInterface` removal from `SumFileContent` schema